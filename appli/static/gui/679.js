(self.webpackChunk=self.webpackChunk||[]).push([[679],{845:(t,e,s)=>{"use strict";s.r(e),s.d(e,{TableComponent:()=>b});var a=s(7856),i=s.n(a),l=s(8350),n=s(251),r=s.n(n),o=s(6466),d=s(9162),c=s(2817);let h=[];const p={prjlist:"/gui/prjlist/",prjsamplestats:"/gui/prjsamplestats",userslist:"/gui/admin/userslist"},u={showfull:"showfull",tipinline:"tip-inline",searchresults:"search-results",selectaction:"selectaction",absinput:"absinput",disabled:"datatable-disabled",ascending:"datable-ascending",descending:"datatable-descending",tipover:"tipover absolute z-10 text-stone-50 rounded bg-stone-600 px-2 py-0.5 -mt-5 ml-12 "},m={datatable:".datatable-table",datatable_wrapper:".datatable-wrapper",datatable_top:".datatable-top",datatable_search:".datatable-input",table_filters:"table-filters",datatable_sorter:".datatable-sorter",details:'details[data-what="about"]',tip:"."+c.iv.component.table.tip,tipover:".tipover",wait:"wait-please",sorton:".sorton"};Object.freeze(u),Object.freeze(m);const g={};class b{instanceid=null;columns={};headings=[];datas=[];grid=null;params=null;importfields=null;constructor(t,e={}){if(t&&(t=t instanceof HTMLElement?t:document.querySelector(t)))return this.instanceid=t.dataset.instanceid?t.dataset.instanceid:document.querySelectorAll("table").length,h[this.instanceid]&&r()(t.dataset,h[this.instanceid].params)?this.refresh():this.init(t),h[this.instanceid]}init(t){this.params=t.dataset,this.params.from=this.params.from?i().sanitize(this.params.from):null;const e=this.params.from&&Object.keys(p).indexOf(this.params.from)>=0?window.location.href.split("/gui/")[0]+p[this.params.from]:null;e?this.params.defer?this.deferLoad(t,e):this.fetchData(t,e):this.tableActivate(t).then((()=>{h[this.instanceid]=this}))}waitActivate(t){let e=t.querySelector("#"+m.wait);e||(e=document.createElement("div"),e.id=m.wait,t.append(e)),this.waitdiv=e,this.timer=new Date}waitDesactivate(t=null,e="info"){this.waitdiv&&(t?this.waitdiv.innerHTML=`<div class="${e}">${t}</div>`:this.waitdiv.classList.add(c.iv.hide))}deferLoad(t,e){const s=t.querySelector(this.params.defer);s&&s.addEventListener("click",(a=>{this.fetchData(t,e),s.remove()}))}fetchData(t,e,s=0){this.waitActivate(t);const a=this.params.pagesize?this.params.pagesize:0;let l=this.params.import?e+"?"+new URLSearchParams({typeimport:i().sanitize(this.params.import),window_start:s,window_size:a,gz:!0}):a?e+"?"+new URLSearchParams({window_start:s,window_size:a,listall:!!this.params.listall&&this.params.listall}):e+"?"+new URLSearchParams({listall:!!this.params.listall&&this.params.listall});this.params.fromid&&(l+="/"+this.params.fromid),fetch(l,(0,d.fetchSettings)()).then((t=>t.ok?t.json():Promise.reject(t))).then((async l=>{this.waitdiv&&(this.waitdiv.innerHTML=this.waitdiv.dataset.loaded?i().sanitize(this.waitdiv.dataset.loaded):default_messages.dataloaded),l.columns?this.columns=l.columns:this.params.columns&&(this.columns=JSON.parse(this.params.columns)),0===s?(t.addEventListener("dissmisstable",(t=>{console.log("destroy table"),this.destroy()})),this.tableActivate(t,l).then((()=>{h[this.instanceid]=this}))):l.length?this.tableInsertRows(l):a=0,a>0&&this.fetchData(t,e,s+a)})).catch((t=>this.waitDesactivate(`Status ${t.status} ${t.statusText}`,"error")))}async tableActivate(t,e=null){let s=t.querySelector("table");s||(s=document.createElement("table"),t.append(s)),s.id="table-"+t.id;let a={type:"main",searchable:!!this.params.searchable&&"true"===this.params.searchable,sortable:!!this.params.sortable&&"true"===this.params.sortable,paginate:!!this.params.paginate&&"true"===this.params.paginate,fixedHeight:!1,paging:!!this.params.paging&&"true"===this.params.paging,noPaging:!0,perPage:this.params.paging?this.params.perpage?"true"===this.params.perpage:100:1e6,perPageSelect:"true"===this.params.paging&&[10,50,100,500,1e3],scrollY:"",footer:this.params.footer?"true"===this.params.footer:!!t.querySelector("tfoot"),labels:this.params.labels?this.params.labels:{placeholder:"Search...",perPage:"{select} entries per page",noRows:"No entries found",info:"Showing {start} to {end} of {rows} entries",noResults:"No result match your search query"}};if(e){const t=(e=await this.convertDatas(e)).lastused?e.lastused:[],s=this.params.hasOwnProperty("cellid")?this.params.cellid:"id";a={...a,data:{headings:e.headings,data:e.data},columns:e.columns,rowRender:(e,a,l)=>{e.forEach((t=>i().sanitize(t)));const n=this.getCellData(l,s);a.attributes=a.hasOwnProperty("attributes")?a.attributes:{},a.attributes["data-id"]=n,t.indexOf(n)>=0&&(a.attributes.class=a.attributes.class?a.attributes.class+" last-used":"last-used")}}}else{const t=s.querySelectorAll("tfoot th");t.length&&(a.footer=!0),a.rowRender=function(t,e,s){t.forEach((t=>i().sanitize(t)))},a.tableRender=function(e,s){const a=s.childNodes.length-1;if("TFOOT"===s.childNodes[a].nodeName&&t.length){const e=Array.from(t).map((t=>(0,o.uN)(t)));s.childNodes[a].childNodes=[{nodeName:"TR",childnodes:e}]}}}this.grid=new l.DataTable(s,a),this.grid.on("datatable.init",(()=>{this.waitDesactivate(),t.style.top=t.offsetTop+"px",t.dataset.table=this.params.table=!0,this.grid.dom.classList.remove(c.iv.hide),this.datas=null;const e=this.grid.wrapperDOM.querySelector(m.datatable_search);e&&e.classList.add(c.iv.input),this.initPlugins(t)}))}tableAppendRows(t){console.log("rows")}destroy(){this.dataImport&&(this.dataImport=null),this.grid=null,delete h[this.instanceid]}refresh(t){this.dataImport&&this.dataImport.selectors&&this.dataImport.selectors.forEach((t=>{this.disabled&&(this.disabled=!1)}))}labelFormatter(t,e){let s="";return["number","progress","decimal"].find((t=>t===e.format))&&(s=c.iv.right),e.subfield?`${e.label} <span class="sublabel">${e.sublabel}</span>`:e.label?`<span class="col-${t} ${s}">${e.label}</span>`:""}getCellId(t,e=null){return this.headings.indexOf(t)}getCellData(t,e){const s=this.getCellId(e);return s<0?null:this.grid?this.grid.data.data[t]?this.grid.data.data[t][s].data:null:this.datas&&this.datas[t]?this.datas[t][s]:null}setTextNode(t){return{nodeName:"#text",data:t}}async convertDatas(t){const e=Object.entries(this.columns).map((([t,e],s)=>{const a={data:t,text:e.label?e.label:""};return e.hasOwnProperty("hidden")&&(a.hidden=!0),a})),a=Object.keys(this.columns);this.headings=a;const i=this.convertColumns();if(!t.hasOwnProperty("data")||t.hasOwnProperty("type")&&"json"===t.type)t=(t.hasOwnProperty("data")?t.data:t).map((t=>{let e=[];return a.forEach(((s,a)=>{let i=e;t.hasOwnProperty(s)?i.push(NaN===t[s]?null:t[s]):i.push(null)})),[...e]})),this.datas=t,t={data:t};else{const e=t.data.length;for(let s=0;s<e;s++){const e=t.data[s].length;for(let a=0;a<e;a++)t.data[s][a]=t.data[s][a]}}this.datas=t.data,t.columns=i,t.headings=e;let l={controls:(t,e,s,a)=>{const i=Object.values(this.columns)[a],l=this.getCellData(s,i.field),n=i.actions?i.actions:null;if(!n)return"";let r=[];Object.entries(n).forEach((([t,e])=>{r.push({nodeName:"A",attributes:{class:`btn is-${t} `,href:`${e.link}/${l}`},childNodes:[this.setTextNode(e.label)]})})),e.hasOwnProperty("attributes")||(e.attributes={}),e.attributes.class=c.iv.component.table.controls,e.childNodes=r},select:(t,e,s,a)=>{const i=Object.values(this.columns)[a];t=isNaN(t)?this.getCellData(s,i.field):t,e.childNodes=[{nodeName:"INPUT",attributes:{type:"radio",name:`${this.instanceid}select`,value:String(t)}}]},selectmultiple:(t,e,s,a)=>{const i=Object.values(this.columns)[a];t=isNaN(t)&&i.hasOwnProperty("field")?this.getCellData(s,i.field):t,e.childNodes=[{nodeName:"INPUT",attributes:{type:"checkbox",name:`${this.instanceid}select[]`,value:String(t)}}]},decimal:(t,e,s,a)=>{isNaN(t)&&(t=0),(t=parseFloat(t).toFixed(2))-parseInt(t)==0&&(t=parseInt(t)),e.hasOwnProperty("attributes")||(e.attributes={}),e.attributes.class=c.iv.number,e.childNodes[0].data=t},number:(t,e,s,a)=>{isNaN(t)&&(t=0),e.hasOwnProperty("attributes")||(e.attributes={}),e.attributes.class=c.iv.number,e.childNodes[0].data=t},check:(t,e,s,a)=>{switch(isNaN(t)&&(t=""),t){case!0:case"Y":case 1:t="";break;default:t="no-"}const i={nodeName:"I",attributes:{class:`icon-sm  icon-${t}check `},childNodes:[]},l=Object.values(this.columns)[a],n=this.getCellData(s,l.field);l.hasOwnProperty("toggle")?e.childNodes=[{nodeName:"A",attributes:{"data-request":"toggle","data-action":`${l.toggle.link}/${n}`,href:"javascript:void()"},childNodes:[i]}]:e.childNodes=[i]},text:(t,e,s,a)=>{null===t?e.childNodes=[]:(t=t.replaceAll("\r\n",", "),e.childNodes=""!==t?[{nodeName:"DIV",attributes:{class:c.iv.component.table.tip},childNodes:[this.setTextNode(t)]}]:[])},default:(t,e,s,a)=>{e.childNodes=null===t||""===t?[]:[this.setTextNode(t)]}},n=null;switch(this.params.from){case"prjlist":n=await s.e(114).then(s.bind(s,6114)),this.cellid=c.Cq.projid;break;case"prjsamplestats":n=await s.e(856).then(s.bind(s,4856)),this.cellid=c.Cq.sampleid;break;default:this.cellid="id"}return l=n?{...l,...n.default(this)}:l,Object.entries(this.columns).forEach((([e,s],a)=>{if(!s.hasOwnProperty("hidden")){const e=s.select&&s.select==c.Cq.controls?c.Cq.controls:s.selectcells?c.Cq.imports:s.select,i=s.format?s.format:s.subfield?s.subfield:e||"default";l&&l[i]&&(t.columns[a].render=l[i])}})),t}convertColumns(){const t=(t,e,s)=>{if(!e)return{select:s,name:t,hidden:!0};const a={select:s,name:this.labelFormatter(t,e)};return e.notsortable&&(a.sortable=!1),e.notsearchable||(a.searchable=!0),e.hidden&&(a.hidden=Boolean(e.hidden)),e.sort&&"desc"===e.sort&&(e.sortSequence=["desc","asc"]),["number","decimal"].find((t=>t===e.format))&&(a.type="number"),"select"===t&&(e.select&&"controls"==e.select||(e.selectcells||e.select))&&(this.importfields=e.selectcells?e.selectcells:null,a.sortable=!1,a.searchable=!1),a};return Object.entries(this.columns).map((([e,s],a)=>t(e,s,a)))}initEvents(){this.grid.on("datatable.update",(()=>{this.dom.classList.contains("hide")&&this.dom.classList.remove("hide")}))}initPlugins(t){if(this.params.import&&this.initImport&&this.initImport(),this.params.expand&&this.makeExpandable(t),this.params.export&&this.makeExportable(t),this.params.details||this.grid.dom.querySelector(m.details)?this.initDetails():this.initEvents(),this.params.onselect&&this.initSelect(t),this.grid.dom.querySelector(m.tip)&&this.initTips(),this.grid.dom.querySelectorAll("thead [data-altsort]").length&&this.initAlternateSort(this.grid.dom.querySelectorAll("thead [data-altsort]")),this.params.filters){const t=this.grid.wrapperDOM.querySelector(m.datatable_top);if(t&&t.children.length){const e=document.querySelector(m.table_filters);e&&t.prepend(e)}}}initSelect(t){const e=this.grid.dom.querySelectorAll('input[name^="'+this.instanceid+'"]');if(0===e.length)return;e[0].name;let s=t.querySelector("."+u.selectaction);if(!s)return;document.body.append(s),s.querySelector("a").addEventListener("click",(t=>{let s=[];e.forEach((t=>{t.checked&&s.push(t.value)})),t.currentTarget.href=this.params.onselect+encodeURI(s.join(","))}));const a=s.querySelector("[data-dismiss]");a&&a.addEventListener("click",(t=>{t.preventDefault(),t.stopImmediatePropagation(),i(null,null)}));const i=(t=null,e=null,i=!1)=>{s.dataset.close&&(document.body.append(s),a.classList.remove("hidden"),s.classList.add(u.absinput)),null!==t&&null!==e?(s.classList.remove(c.iv.hide),s.style.top=t+"px",s.style.left=e+"px"):!0===i?(s.classList.add(c.iv.hide),delete s.dataset.close):(s.dataset.close=!0,a.classList.add("hidden"),(this.grid.wrapperDOM.querySelector(m.datatable_top)?this.grid.wrapperDOM.querySelector(m.datatable_top):this.grid.wrapperDOM).prepend(s),s.classList.remove(u.absinput))};e.forEach((t=>{t.addEventListener("change",(e=>{t.checked?i(t.offsetTop,t.offsetLeft):0===this.grid.dom.querySelectorAll('input[name^="'+this.instanceid+'"]:checked').length&&i(null,null,!0)}))}))}async initDetails(){const t=this.grid.wrapperDOM,e=t.querySelector("#"+u.tipinline)?t.querySelector("#"+u.tipinline):u.tipinline;if(!g.JsDetail){const{JsDetail:t}=await s.e(941).then(s.bind(s,9941));g.JsDetail=t}const a=new g.JsDetail(e,t,{waitdiv:this.waitdiv}),i=(t,e=null)=>{a.activeDetail(!1),e&&e()},l=(t,e=null)=>{if(a.activeDetail(!0),a.current&&a.current===t)a.expandDetail(t),e&&e();else{a.current&&a.current.querySelector("summary").click();const s=this.params.detailsurl+t.dataset.id+"?"+new URLSearchParams({partial:!0});a.activeDetail(!0),fetch(s,(0,d.fetchSettings)()).then((t=>t.text())).then((s=>{a.expandDetail(t,s),e&&e()})).catch((t=>{console.log("request",t)}))}};if(!g.JsAccordion){const{JsAccordion:t}=await s.e(109).then(s.bind(s,109));g.JsAccordion=t}const n=()=>{this.grid.dom.classList.contains(c.iv.hide)&&this.grid.dom.classList.remove(c.iv.hide);const t=this.grid.dom.querySelectorAll(m.details);t&&t.forEach((t=>{t.dataset.id&&(t=new g.JsAccordion(t,l,i,a.detail))}))};this.grid.on("datatable.sort",(function(t,e){a.activeDetail(!1)}));let r=!1;this.grid.on("datatable.search",((t,e)=>{this.grid.dom.dataset.issearching||(a.activeDetail(!1),this.grid.dom.dataset.issearching=!0)})),this.grid.on("datatable.update",(()=>{!1===r&&(r=!0,setTimeout((()=>{n(),delete this.grid.dom.dataset.issearching,r=!1}),300))})),n()}initAlternateSort(t){const e=this.grid.data.headings;let s;const a=t=>{let a;a=t.dataset.sortactive===String(s)?t.classList.contains(u.ascending)?u.descending:u.ascending:t.classList.contains(u.descending)?u.descending:u.ascending,e.sort(s,a),this.grid.on("datatable.sort",((e,a)=>{s!==t.cellIndex&&(t.classList.remove(u.ascending),t.classList.remove(u.descending),this.grid.headings[s].classList.remove(a),t.classList.add(a)),t.dataset.sortactive=s}))};t.forEach((t=>{const e=t.dataset.altsort?t.dataset.altsort.split(","):null;if(!e)return;t.querySelector(u.datatable_sorter).classList.add(u.disabled);const i=t.querySelector(m.sorton);t.append(i);const l=t.querySelectorAll('[role="button"]');s=t.cellIndex,t.addEventListener("click",(e=>{a(t)}),!1);const n=(t,a)=>{s=0===a?t.cellIndex:this.grid.headings.findIndex((t=>t.dataset.name===e[a-1]))};t.dataset.sortactive=t.cellIndex,l.forEach(((e,s)=>{e.addEventListener("click",(e=>{e.preventDefault();const a=e.currentTarget.parentElement.querySelector(".active");a&&a.classList.remove("active"),e.currentTarget.classList.add("active"),n(t,s)}))})),t.dataset.tip&&Object.values(this.grid.dom.rows).forEach(((s,a)=>{if(0===a)return;const i=this.grid.headings.findIndex((s=>s.dataset.name===e[parseInt(t.dataset.tip)-1]));i!==t.cellIndex&&(s.cells[t.cellIndex].addEventListener("mouseenter",(t=>{const e=document.createElement("div");e.setAttribute("class",u.tipover),e.innerHTML=s.cells[i].innerHTML,t.currentTarget.append(e)})),s.cells[t.cellIndex].addEventListener("mouseout",(t=>{const e=t.currentTarget.querySelector(m.tipover);e&&e.remove()})))}))}))}closeShowfull(){const t=document.querySelector("."+c.iv.component.table.tip+"."+u.showfull);t&&t.click()}makeExpandable(t){if(t.querySelector("table").offsetHeight<t.offsetHeight+t.querySelector("table tbody tr").offsetHeight)return;const e=document.createElement("div");e.classList.add("button-expand"),e.classList.add("border-t"),e.title=this.params.expand,e.innerHTML=`<span class="small-caps block mx-auto p-0">${this.params.expand}</span><i class="clear-both p-0 mx-auto icon icon-chevron-down hover:fill-secondblue-500"></i><span class="small-caps block mx-auto p-0 hidden">${this.params.shrink}</span>`,t.parentElement.insertBefore(e,t.nextElementSibling),t.classList.add("overflow-y-hidden"),t.classList.remove("max-tabstat-h"),t.parentElement.style.height="auto";const s=parseInt(this.grid.wrapperDOM.querySelector("tbody tr").offsetHeight)*(this.params.maxrows?this.params.maxrows:20);t.classList.add("max-h-["+s+"px]"),t.style.height=s+"px",e.addEventListener("click",(a=>{this.closeShowfull(),e.classList.toggle("border-t"),e.classList.toggle("border-b");const i=e.querySelector("i");i.classList.toggle("icon-chevron-down"),i.classList.toggle("icon-chevron-up"),t.classList.toggle("overflow-y-hidden"),t.classList.toggle("max-h-["+s+"px]"),e.querySelectorAll("span").forEach((t=>{t.classList.toggle("hidden")})),t.classList.contains("overflow-y-hidden")?t.style.height=s+"px":t.style.height="auto"}))}makeExportable(t){const e=document.createElement("div");e.classList.add("button-export"),e.classList.add("is-pick"),e.innerHTML=`<i class="icon icon-arrow-down-on-square"></i><span>${this.params.exportlabel?this.params.exportlabel:"export to "+this.params.export}</span>`,t.prepend(e);const a=this.grid.columns;let i=[];Object.keys(this.columns).forEach(((t,e)=>{"select"===t&&i.push(e)})),e.addEventListener("click",(async e=>{if(e.preventDefault(),i.length&&a.hide(i),this.dynamics||(this.dynamics={}),!this.dynamics.exportCSV){const{exportCSV:t}=await Promise.resolve().then(s.bind(s,8350));this.dynamics.exportCSV=t}let l=this.dynamics.exportCSV(this.grid,{download:!1,lineDelimiter:"\n",columnDelimiter:"\t"});l=encodeURI(`data:text/tsv;charset=utf-8,${l}`),(0,d.download_url)(l,(t.id?t.id:"stats_proj")+".tsv"),i.length&&a.show(i)}))}initTips(){let t=null;this.grid.dom.querySelectorAll(m.tip).forEach((e=>{e.addEventListener("mouseenter",(t=>{(e.classList.contains(u.showfull)||e.scrollHeight>e.offsetHeight)&&(e.style.cursor="pointer")})),e.addEventListener("click",(s=>{const a=window.getComputedStyle(e.parentElement),i=window.getComputedStyle(e.parentElement);if(e.classList.contains(u.showfull))e.classList.remove(u.showfull),e.parentElement.style.minHeight="none",e.parentElement.style.height="auto",e.style.maxWidth=e.dataset.w+"px",e.style.padding=e.dataset.p+"px",t=null;else if(e.scrollHeight>e.offsetHeight){t&&t.classList.remove(u.showfull);const s=parseInt(e.clientHeight);e.parentElement.style.minHeight=e.parentElement.style.height=(s<parseInt(a.maxHeight)?s:parseInt(a.maxHeight))-2*parseInt(a.padding)+"px",e.dataset.w||(e.dataset.w=parseInt(e.clientWidth)),e.dataset.p||(e.dataset.p=parseInt(i.padding)),e.style.maxWidth=parseInt(e.clientWidth)+"px",e.classList.add(u.showfull),e.style.top=parseInt(e.offsetTop)-parseInt(a.padding)+"px",t=e}}))}))}}},4654:()=>{}}]);