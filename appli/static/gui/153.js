"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[153,52],{5941:(t,e,s)=>{s.r(e),s.d(e,{DataImport:()=>m});var i=s(7856),o=s.n(i),r=s(2627),a=s(5690),n=s(9162),l=s(2817);const c=Object.keys(l.HN).reduce((function(t,e){return t[e]=e,t}),{});let d;class m{content_selector=".modal-content";imports=[];taxos=["preset","extra"];importcontainer;importzoneid;importid="importzone";selectors;button;clearbutton;replacebutton;tabbutton;doc=null;constructor(t,e="",s=null){if(!t)return;const i="object"==typeof t?t.dom:document.querySelector(t);if(i){if(e=o().sanitize(e),!d||d.doc!==i){const o={importcontainer:"#data-import-"+e,btns:".btns-imports",button:"#add-import-"+e,replacebutton:"#replace-import-"+e,clearbutton:"#clear-import-"+e,tabbutton:"#tab-import-"+e,selector:"data-id"};this.doc=i,this.selector=s||o.selector,this.importcontainer=o.importcontainer instanceof HTMLElement?o.importcontainer:document.querySelector(o.importcontainer),this.form=o.form?o.form instanceof HTMLElement?o.form:document.querySelector(o.form):this.doc.closest("form"),this.button=o.button instanceof HTMLElement?o.button:document.querySelector(o.button),this.replacebutton=o.replacebutton instanceof HTMLElement?o.replacebutton:document.querySelector(o.replacebutton),this.clearbutton=o.clearbutton instanceof HTMLElement?o.clearbutton:document.querySelector(o.clearbutton),this.tabbutton=o.tabbutton instanceof HTMLElement?o.tabbutton:document.querySelector(o.tabbutton),this.init(t,o),d=this}return d}}init(t,e){this.showImport(!1);let s=this.form.querySelector("#"+l.EY.projid);s&&s.value&&(s=this.doc.querySelector("["+this.selector+'="'+s.value+'"]'),s&&s.classList.add(l.iv.hide));const i=this.indexToCheck(t);this.selectors=this.doc.querySelectorAll("["+this.selector+"] button, ["+this.selector+"] input"),this.selectors.forEach((e=>{const s=Array.from(e.parentElement.children).indexOf(e);if(i&&""===e.closest("tr").children[i[s]].innerHTML)e.disabled=!0;else{const i="input"===e.tagName.toLowerCase()?"change":"click",o=e=>{const i=e.currentTarget;i.disabled=!0,this.toImport(t,i.parentElement,s)};e.removeEventListener(i,o,!1),e.addEventListener(i,o,!1)}})),this.button&&(this.tabbutton.addEventListener("click",(t=>{this.resizeZone(t)})),this.showImport(!1))}toImport(t,e,s=0){const i=Array.from(this.doc.querySelectorAll("thead th")),o=Array.from(this.doc.querySelectorAll("tbody tr")),a=t.data.data;"td"!==e.tagName.toLowerCase()&&(e=e.closest("td"));const d=e.parentElement?e.parentElement.dataset.index:null;if(null===d)return;let m=!0;const p=e.cellIndex,h=i[p],u=(o[d],h.dataset.what);if(!u)return;h.dataset.parts&&h.dataset.parts.split(",");const f=h.dataset.selectcells?h.dataset.parts?[h.dataset.parts.split(",")[s]]:h.dataset.selectcells.split(","):null;if(!f)return;u===l.oL.settings&&(this.imports[l.Cq.contact]=this.findContact(i,a[d]));const b=u===l.oL.taxo||u===l.oL.privileges?this.createImportzone(u):null;f.forEach(((t,e)=>{if(e=null,i.every(((s,i)=>s.dataset.name!==t||(e=i,!1))),null!==e){const s=o[d].cells[e],p=a[d][e].data;s.classList.add(l.iv.selected);const h=i[e];switch(u){case l.oL.taxo:const e=b.tomselect;let s=p;s&&(e?(Object.values(e.options).forEach((t=>{let i={};i[t[e.settings.valueField]]=t[e.settings.labelField],s[t[e.settings.valueField]]||(s=Object.assign(s,i))})),s=Object.entries(s),s.sort(((t,e)=>{let s=t[1],i=e[1];return+(s>i)||-(i>s)})),e.clear(),e.clearOptions(),s.forEach((([t,s])=>{if(!e.getItem(t)){if(!e.getOption(t)){let i={};i[e.settings.valueField]=t,i[e.settings.labelField]=(0,n.unescape_html)(s.trim()),e.addOption(i)}e.addItem(t)}}))):(Object.values(b.options).forEach((t=>{let e={};e[t.value]=t.text,s[t.value]||(s=Object.assign(s,e))})),s=Object.entries(s),s.sort(((t,e)=>{let s=t[1],i=e[1];return+(s>i)||-(i>s)})),b.innerHTML="",s.forEach((([t,e])=>{b.querySelector('option[value="'+t+'"]')||b.insertAdjacentHTML("beforeend",'<option value="'+t+'" selected>'+e+"</option>")}))),m=s.length>0,s=null);break;case l.oL.privileges:const o=p,u=b.tomselect&&b.tomselect.items.length>0||b.selectedIndex>0;b.dataset.init||(Object.keys(o).forEach((t=>{b.insertAdjacentHTML("afterbegin",`<optgroup value="${t}" label="${t}"></optgroup>`)})),(new r.JsTomSelect).applyTo(b),b.dataset.init=!0),b.tomselect&&([...b.tomselect.items].forEach((t=>{if(t=b.tomselect.options[t]){const e=u?c.viewers:t.optgroup;o[e].push({id:t.id,name:t.name})}else this.messageZone(t)})),b.tomselect.clear(),b.tomselect.refreshOptions(),Object.entries(o).forEach((([t,e])=>{e.sort(((t,e)=>e.name>t.name)),e.forEach((e=>{const s=u?c.viewers:t,i=b.querySelector('[value="'+s+'"]');null===b.querySelector('option[value="'+e.id+'"]')&&(i.insertAdjacentHTML("afterbegin",`<option value="${e.id}" data-optgroup=${s} selected="selected">${e.name}</option>`),b.tomselect&&!b.tomselect.getOption(e.id)&&b.tomselect.addOption({id:e.id,name:(0,n.unescape_html)(e.name),optgroup:s})),b.tomselect.addItem(e.id)}))})),m=b.tomselect.items.length>0);break;default:if(h.dataset.autocomplete){this.imports[t]={value:p,key:null};let e=null;i.every(((t,s)=>t.dataset.name!=h.dataset.autocomplete||(e=s,!1))),null!==e&&(e=a[d][e],this.imports[t].key=e)}else h.dataset.value?this.imports[t]=h.dataset.value:this.imports[t]=p}}})),i.length&&(this.button?(this.showImport(m),this.button.dataset.activated||u!==l.oL.taxo&&u!==l.oL.privileges||this.activateButtons(u,f)):this.makeImport(null,f,u,!0))}messageZone(t){console.log("itemmessage",t)}activateButtons(t,e){this.button.addEventListener("click",(s=>{s.preventDefault(),this.makeImport(s.currentTarget,e,t,!0)})),this.replacebutton.addEventListener("click",(s=>{s.preventDefault(),this.makeImport(s.currentTarget,e,t,!0)})),this.clearbutton.addEventListener("click",(t=>{if(!this.importcontainer)return;const e=this.importcontainer.querySelector("#"+this.importid);e&&(e.tomselect?(e.tomselect.clear(),e.tomselect.refreshOptions()):e.value=""),this.selectors.forEach((t=>{t.disabled&&(t.disabled=!1,t.closest("tr").querySelectorAll(".selected").forEach((t=>{t.classList.remove(l.iv.selected)})))})),this.button.disabled=!1,this.replacebutton.disabled=!1})),this.button.dataset.activated=!0,this.replacebutton.dataset.activated=!0}findContact(t,e){let s=null;return t.every(((t,e)=>!t.dataset.name||t.dataset.name!==l.Cq.contact||(s=e,!1))),s&&(s=e[s]?e[s]:0),s}renderPrivileges(t,e=!1){let s={};const i=t.tomselect,o=(t,e)=>{const i={id:t.id,name:t.name,priv:e};s[e]?s[e].push(i):s[e]=[i]};if(i){const t=[...i.items],e=Object.assign({},i.options);t.forEach((t=>{(t=e[t])&&o(t,t.optgroup)}))}else t.options.forEach((t=>{t.selected&&o(t,t.dataset.optgroup)}));this.importPrivileges(s,e)&&(i?(i.clear(),i.clearOptions()):t.innerHTML="")}importPrivileges(t,e=!1){const s=new a.ProjectPrivileges,i=this.imports[l.Cq.contact]?this.imports[l.Cq.contact]:null;return s.importPrivileges(t,e,i,(t=>{this.setImportedTag(t,null)}),(()=>{this.dismiss()}))}createImportzone(t){this.showImport(!0);let e=this.importcontainer.querySelector("#"+this.importid);if(t===l.oL.privileges)e||(e=document.createElement("select"),this.importid=e.id=this.importid+"-"+t,e.dataset.type=l.Cq.user,e.multiple=!0,e.dataset.priv=!0,this.importcontainer.append(e));else{const s=this.form.querySelector('[name="'+t+'"]')?this.form.querySelector('[name="'+t+'"]'):this.form.querySelector('[data-importfield="'+t+'"]'),i=s.tomselect;if(!e){if(!s)return;this.importzoneid=s.id,e=s.cloneNode(),e.classList.remove("tomselected"),e.classList.remove("ts-hidden-accessible"),e.dataset.origin=e.id,e.id=this.importid,e.name=this.importid+"_"+e.name,this.importcontainer.insertAdjacentHTML("afterbegin",e.outerHTML),i&&(e=this.importcontainer.querySelector("#"+this.importid),(new r.JsTomSelect).applyTo(e))}}return e}makeImport(t,e,s,i=!1){let r=!1;const a=this.importcontainer?this.importcontainer.querySelector("#"+this.importid):null;switch(s){case l.oL.taxo:if(!a)return!1;const i=this.form.querySelector("#"+a.dataset.origin);if(!i)return!1;const c=i.tomselect;if(c){t.dataset.replace&&"replace"===t.dataset.replace&&(c.clear(),c.clearOptions());const e=a.tomselect,s=[...e.items],i=Object.assign({},e.options);s.forEach(((t,e)=>{let s={};s[c.settings.valueField]=t,s[c.settings.searchField]=(0,n.unescape_html)(i[t][c.settings.searchField]),c.getOption(t)||c.addOption(s),c.addItem(t)})),e.clear(),e.clearOptions()}else t.dataset.replace&&"replace"===t.dataset.replace&&(i.innerHTML=""),i.innerHTML=o().sanitize(a.innerHTML),a.innerHTML="";r=!0;break;case l.oL.privileges:if(!a)return!1;r=this.renderPrivileges(a,t.dataset.replace&&"replace"===t.dataset.replace);break;default:e.forEach(((t,e)=>{let i=this.form.querySelector('[data-importfield="'+t+'"]')?this.form.querySelector('[data-importfield="'+t+'"]'):this.form.querySelector('[name="'+t+'"]');if(i&&void 0!==this.imports[t]){const e=i.tomselect;if("init_classif_list"===t){let s=this.imports[t];if(s=Array.isArray(s)?s.join(","):s.replace("[","").replace("]","").replaceAll(" ",""),""!==s){e&&e.wrapper.classList.add("wait-for-results");const t=new FormData;t.append("idlist",s),fetch("/search/taxoresolve",(0,n.fetchSettings)({method:"POST",body:t})).then((t=>t.json())).then((t=>{if(e)Object.entries(t).forEach((([t,s])=>{let i={};t=o().sanitize(t),s=o().sanitize(s),i[e.settings.valueField]=t,i[e.settings.searchField]=(0,n.unescape_html)(s),e.addOption(i),e.addItem(i[e.settings.valueField])}));else{let e="";Object.entries(t).forEach((([t,s])=>{t=o().sanitize(t),s=o().sanitize(s),e+='<option value ="'+t+'" selected>'+s+"</option>"})),i.innerHTML=e,e=""}t=null,e&&e.wrapper.classList.remove("wait-for-results")}))}}else if(e){let s={};s[e.settings.valueField]=this.imports[t].key,s[e.settings.searchField]=(0,n.unescape_html)(this.imports[t].value),e.addOption(s),e.addItem(s[i.tomselect.settings.valueField]),e.refreshOptions()}else switch(i.type?i.type:i.tagName.toLowerCase(),i.type){case"radio":case"checkbox":i=this.form.querySelector('[name="'+t+'"][value="'+this.imports[t]+'"]'),i&&(i.checked=!0);break;case"select":let e;e=this.imports[t].key?'<option value="'+this.imports[t].key+'" selected >'+this.imports[t].value+"</option>":'<option value="'+this.imports[t]+'" selected >'+this.imports[t]+"</option>",i.insertAdjacentHTML("beforeend",e);break;default:i.value=this.imports[t]}s!==l.oL.settings&&i.focus(),r=!0,this.setImportedTag(i)}else"privileges"===t&&(r=this.importPrivileges(this.imports[t],!1))}))}!0===r&&1==i&&this.dismiss()}setImportedTag(t,e=".form-box"){let s=null===e?t:t.closest(e)?t.closest(e):t.closest("fieldset");if(!s)return;s.dataset.isimported=this.form.dataset.isimported,s.classList.add("imported");const i=e=>{s.removeAttribute("data-isimported"),s.classList.remove("imported"),t.removeEventListener("change keydown",i)};t.addEventListener("change keydown",i)}dismiss(t=!1){const e=this.doc.closest("details");e&&(e.open=!1,!0===t&&(e.querySelector(this.content_selector).innerHTML=""))}indexToCheck(t){if(t.headings&&t.headings[0].dataset.what===l.oL.taxo){const e=t.headings[0].dataset.parts?t.headings[0].dataset.parts.split(","):null;if(e)return t.headings.filter(((t,s)=>{if(e.indexOf(t.dataset.name)>=0)return s})).map((t=>t.cellIndex))}}showImport(t){if(this.button)if(!1===t)this.button.classList.add(l.iv.hide),this.replacebutton.classList.add(l.iv.hide),this.clearbutton.classList.add(l.iv.hide),this.importcontainer.classList.add(l.iv.hide),this.tabbutton.classList.add(l.iv.hide);else{this.button.classList.remove(l.iv.hide),this.replacebutton.classList.remove(l.iv.hide),this.clearbutton.classList.remove(l.iv.hide),this.importcontainer.classList.remove(l.iv.hide),this.button.disabled=this.clearbutton.disabled=!1;const t=this.importcontainer.querySelector("#"+this.importid);t&&(this.tabbutton.classList.remove(l.iv.hide),t.tomselect&&t.tomselect.control.offsetHeight<t.tomselect.control.scrollHeight?this.tabbutton.disabled=!1:this.tabbutton.disabled=!0)}}resizeZone(t){const e=this.importcontainer.closest(l.EY.component.import.zoneimport);if(!e)return;e.parentElement.classList.toggle(l.iv.showfull);const s=t.currentTarget.querySelector("i");s&&(s.classList.toggle("icon-arrow-pointing-out"),s.classList.toggle("icon-arrow-pointing-in"))}}}}]);