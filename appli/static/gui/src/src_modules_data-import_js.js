/*! For license information please see src_modules_data-import_js.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["src_modules_data-import_js"],{"./src/modules/data-import.js":(module,__webpack_exports__,__webpack_require__)=>{eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   DataImport: () => (/* binding */ DataImport)\n/* harmony export */ });\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! dompurify */ \"./node_modules/dompurify/dist/purify.js\");\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(dompurify__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../modules/js-tom-select.js */ \"./src/modules/js-tom-select.js\");\n/* harmony import */ var _modules_project_privileges_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../modules/project-privileges.js */ \"./src/modules/project-privileges.js\");\n/* harmony import */ var _modules_utils_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../modules/utils.js */ \"./src/modules/utils.js\");\n/* harmony import */ var _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../modules/modules-config.js */ \"./src/modules/modules-config.js\");\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([_modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__, _modules_project_privileges_js__WEBPACK_IMPORTED_MODULE_2__]);\n([_modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__, _modules_project_privileges_js__WEBPACK_IMPORTED_MODULE_2__] = __webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__);\n\n\n\n\n\n\nconst key_privileges = Object.keys(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.defined_privileges).reduce(function(result, key) {\n  result[key] = key;\n  return result;\n}, {});\nlet instance;\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported = 'imported';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.tomselected = 'tomselected';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hiddenaccessible = 'ts-hidden-accessible';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowout = 'icon-arrow-pointing-out';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowin = 'icon-arrow-pointing-in';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton = '.import-list-reset';\nclass DataImport {\n  content_selector = '.modal-content';\n  imports = [];\n  taxos = [\"preset\", \"extra\"];\n  importcontainer;\n  importzoneid;\n  importid = 'importzone';\n  selectors;\n  button;\n  clearbutton;\n  replacebutton;\n  tabbutton;\n  tbl = null;\n  constructor(tbl, what = null, selector = null) {\n    if (!tbl) return;\n    // tbl is a TableComponent  ?\n    this.tbl = (typeof(tbl) === 'object') ? tbl : null;\n    selector = (selector === null) ? ((this.tbl.cellidname) ? \"data-\" + this.tbl.cellidname : \"data-id\") : selector;\n    // get the table from table component or html table element id\n    this.dom = (this.tbl) ? this.tbl.dom : document.getElementById(tbl);\n    if (!this.dom) return;\n    what = (what) ? dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(what) : (tbl && tbl.params && tbl.params.import) ? tbl.params.import : (this.dom.dataset.import) ? dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(this.dom.dataset.import) : null;\n    if (!instance || instance.doc !== this.dom) {\n      // defaultoptions - keep like that\n\n      const options = {\n        importcontainer: '#data-import-' + what,\n        btns: '.btns-imports',\n        button: '#add-import-' + what,\n        replacebutton: '#replace-import-' + what,\n        tabbutton: '#tab-import-' + what,\n      };\n      this.selector = selector;\n\n      this.importcontainer = options.importcontainer instanceof HTMLElement ? options.importcontainer : document.querySelector(options.importcontainer);\n      this.form = (options.form) ? ((options.form) instanceof HTMLElement ? options.form : document.querySelector(options.form)) : this.dom.closest('form');\n      this.button = options.button instanceof HTMLElement ? options.button : document.querySelector(options.button);\n      this.replacebutton = options.replacebutton instanceof HTMLElement ? options.replacebutton : document.querySelector(options.replacebutton);\n      this.tabbutton = options.tabbutton instanceof HTMLElement ? options.tabbutton : document.querySelector(options.tabbutton);\n      this.importid = this.importid + '_' + what;\n      this.init(options);\n      instance = this;\n\n    }\n    return instance;\n  }\n\n  init(options) {\n    // hide importzone\n    this.showImport(false);\n    // remove line of target proj\n    let projid = this.form.querySelector('#' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.projid);\n    if (projid && projid.value) {\n      projid = this.dom.querySelector('[' + this.selector + '=\"' + projid.value + '\"]');\n      if (projid) projid.hidden = true;\n    }\n    const indextocheck = this.indexToCheck();\n    this.selectors = this.dom.querySelectorAll('[' + this.selector + '] button, [' + this.selector + '] input');\n    this.selectors.forEach(selector => {\n      // checkbox possible\n      const index = Array.from(selector.parentElement.children).indexOf((selector));\n      if (indextocheck && selector.closest('tr').children[indextocheck[index]].innerHTML === '') selector.disabled = true;\n      else {\n        const evt = (selector.tagName.toLowerCase() === 'input') ? 'change' : 'click';\n        const apply_selection = (e) => {\n          e.preventDefault();\n          e.stopImmediatePropagation();\n          const target = e.currentTarget;\n          target.disabled = true;\n          this.toImport(target.parentElement, index);\n        };\n        selector.removeEventListener(evt, apply_selection, false);\n        selector.addEventListener(evt, apply_selection, false);\n      };\n    });\n    if (this.tabbutton) {\n      this.tabbutton.addEventListener('click', (e) => {\n        e.stopImmediatePropagation();\n        e.preventDefault();\n        this.resizeZone(e);\n      });\n    }\n  }\n  columnProperty(name, index, th) {\n    if (this.tbl) return (this.tbl.grid.columns[index].hasOwnProperty(name)) ? this.tbl.grid.columns[index][name] : null;\n    else return (th.dataset[name]) ? th.dataset.name : null;\n  }\n  columnIndex(prop, value) {\n    return Array.from(this.dom.querySelectorAll('thead th')).findIndex(th => (th.dataset[prop] && th.dataset[prop] === value));\n  }\n  gridColumnIndex(prop, value) {\n    if (this.tbl) return this.tbl.grid.columns.findIndex(column => (column.hasOwnProperty(prop) && column[prop] === value));\n    else return this.columnIndex(prop, value);\n  }\n  rowIndex(td, trs) {\n    const ref = (td.parentElement) ? td.parentElement : null;\n    if (!ref) return null;\n    return trs.findIndex(tr => (tr === ref));\n  }\n  toImport(td, whatpart = 0) {\n    const grid = (this.tbl) ? this.tbl.grid : null;\n    const thcells = Array.from(this.dom.querySelectorAll('thead th'));\n    const trs = Array.from(this.dom.querySelectorAll('tbody tr'));\n    const datas = (grid) ? grid.data : trs.map(tr => {\n      return Array.from(tr.childNodes).forEach(cell => {\n        return cell.innerText;\n      });\n    }); // cell values in json  - no parse\n    if (td.tagName.toLowerCase() !== 'td') td = td.closest('td');\n    const rowindex = this.rowIndex(td, trs);\n    if (rowindex === null) return;\n    let showbtns = true;\n    const cellindex = td.cellIndex;\n    const th = thcells[cellindex];\n    const tds = trs[rowindex];\n    const what = this.columnProperty('what', cellindex, th);\n    if (!what) return;\n    const parts = this.columnProperty('parts', cellindex, th);\n    let contact = null;\n    let selectcells = this.columnProperty('selectcells', cellindex, th);\n    selectcells = (selectcells) ? ((parts) ? [parts[whatpart]] : selectcells) : null;\n    if (!selectcells) return;\n    if (what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.settings || what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact] = this.findContact(datas[rowindex]);\n    const importzone = (what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo || what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) ? this.createImportzone(what) : null;\n\n    this.addResetButton();\n    let ts = null;\n    selectcells.forEach((name, index) => {\n      index = this.gridColumnIndex('name', name);\n      if (index >= 0) {\n        const tdindex = this.columnIndex('name', name);\n        // show import buttons if importzone\n        const cell = (tdindex >= 0) ? trs[rowindex].cells[tdindex] : null;\n        if (cell) cell.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n        const celldata = datas[rowindex][index];\n        const thcell = (tdindex >= 0) ? thcells[tdindex] : null;\n        switch (what) {\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo:\n            if (!importzone) return;\n            // accumulate and show in import win - move the form field in modal win to view the changes and benefit of tom-select component functs...\n            ts = importzone.tomselect;\n            let taxons = celldata;\n            if (taxons) {\n              if (ts) {\n                // merge taxons and options - unique\n                Object.values(ts.options).forEach((opt) => {\n                  let obj = {};\n                  obj[opt[ts.settings.valueField]] = opt[ts.settings.labelField];\n                  if (!taxons[opt[ts.settings.valueField]]) taxons = Object.assign(taxons, obj);\n                });\n                taxons = Object.entries(taxons);\n                // sort taxons\n                taxons.sort((a, b) => {\n                  let x = a[1];\n                  let y = b[1];\n                  return +(x > y) || -(y > x);\n                });\n                ts.clear();\n                ts.clearOptions();\n                // add taxons items\n                taxons.forEach(([key, text]) => {\n                  if (!ts.getItem(key)) {\n                    if (!ts.getOption(key)) {\n                      let obj = {};\n                      obj[ts.settings.valueField] = key;\n                      obj[ts.settings.labelField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(text.trim());\n                      ts.addOption(obj);\n                    }\n                    ts.addItem(key);\n                  }\n                });\n              } else {\n                Object.values(importzone.options).forEach(opt => {\n                  let obj = {};\n                  obj[opt.value] = opt.text;\n                  if (!taxons[opt.value]) taxons = Object.assign(taxons, obj);\n                });\n                taxons = Object.entries(taxons);\n                taxons.sort((a, b) => {\n                  let x = a[1];\n                  let y = b[1];\n                  return +(x > y) || -(y > x);\n                });\n                importzone.innerHTML = ``;\n                taxons.forEach(([key, text]) => {\n                  if (!importzone.querySelector('option[value=\"' + key + '\"]')) {\n                    const o = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', {\n                      value: key,\n                      selected: 'selected',\n                      text: text\n                    }, importzone);\n                  }\n                });\n              }\n              showbtns = (taxons.length > 0);\n              taxons = null;\n            }\n\n            break;\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges:\n            const privs = celldata;\n            // set everybody to 'view' if more than one project imported\n            const resetpriv = ((ts && ts.items.length > 0) || (importzone.selectedIndex > 0));\n            if (!importzone.tomselect) {\n              importzone.currentlist = {};\n              _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__.JsTomSelect.applyTo(importzone);\n            }\n            ts = importzone.tomselect;\n            Object.entries(privs).forEach(([priv, members]) => {\n              members.sort((a, b) => {\n                return (b.name > a.name);\n              });\n              members.forEach(member => {\n                const newpriv = (resetpriv) ? key_privileges.viewers : priv; // viewer if more than one project imported\n                let opt;\n                if (!importzone.currentlist || !importzone.currentlist[member.id]) {\n                  if (ts) {\n                    opt = ts.items.indexOf(member.id);\n                    //TODO - test - opt should always be 0\n                    if (opt >= 0) {\n                      ts.removeItem(member.id);\n                      ts.removeOption(member.id);\n                    }\n                    // addoption && addItem\n                    opt = {\n                      optgroup: newpriv\n                    }\n                    opt[ts.settings.valueField] = member.id;\n                    opt[ts.settings.searchField] = member.name;\n                    opt[ts.settings.labelField] = member.name;\n                    ts.addOption(opt);\n                    ts.addItem(member.id);\n                  } else {\n                    opt = importzone.querySelector('option[value=\"' + member.id + '\"]');\n                    if (opt === null) {\n                      opt = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', {\n                        value: member.id,\n                        dataset: {\n                          optgroup: newpriv\n                        },\n                        selected: true,\n                        defaultSelected: true,\n                        text: member.name\n                      })\n                      /*  opt = document.createElement('option');\n                        opt.value = member.id;\n                        opt.dataset.optgroup = newpriv;\n                        opt.selected = opt.defaultSelected = true;\n                        opt.text = member.name;*/\n                      importzone.add(opt);\n                    } else opt.dataset.optgroup = newpriv;\n                  }\n                }\n              });\n              if (ts) ts.refreshOptions(true);\n            });\n\n            showbtns = (((ts) ? ts.items.length : importzone.selectedIndex + 1) > 0);\n\n\n            break;\n          default:\n            this.imports[name] = celldata;\n            if (cell !== null) {\n              if (cell.dataset.autocomplete) {\n                // select elements where key / value in different columns\n                this.imports[name] = {\n                  value: celldata,\n                  key: null\n                };\n                let el = null;\n                thcells.every((t, idx) => {\n                  if (t.dataset.name == thcell.dataset.autocomplete) {\n                    el = idx;\n                    return false;\n                  }\n                  return true;\n                });\n                if (el !== null) {\n                  el = datas[rowindex][el];\n\n                  this.imports[name].key = el;\n                }\n              } else if (cell.dataset.value) this.imports[name] = cell.dataset.value;\n\n            }\n\n            break;\n        }\n      };\n    });\n\n    if (thcells.length) {\n      if (this.button) {\n        const activate = (!this.button.dataset.activated && (what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo || what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges));\n        this.showImport(showbtns);\n        if (activate) this.activateButtons(what, selectcells);\n      } else this.makeImport(null, selectcells, what, true);\n    }\n    //\n\n  }\n  messageZone(item) {\n    console.log('itemmessage', item);\n  }\n  activateButtons(what, selectcells) {\n\n    this.button.addEventListener('click', (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      this.makeImport(e.currentTarget, selectcells, what, true);\n\n    });\n    this.replacebutton.addEventListener('click', (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      this.makeImport(e.currentTarget, selectcells, what, true);\n\n    });\n\n    this.button.dataset.activated = true;\n    this.replacebutton.dataset.activated = true;\n  }\n\n  findContact(tds, name = 'contact') {\n    const index = this.gridColumnIndex('name', name);\n    if (index >= 0) return tds[index] ? tds[index] : null;\n\n    return null;\n  }\n\n  renderPrivileges(importzone, replace = false) {\n    let privileges = {};\n    const tzone = importzone.tomselect;\n\n    const pushpriv = (member, priv) => {\n      const obj = {\n        id: member.id,\n        name: member.name,\n        priv: priv\n      }\n      if (privileges[priv]) privileges[priv].push(obj);\n      else privileges[priv] = [obj];\n    }\n\n    if (tzone) {\n      const members = [...tzone.items];\n      const options = Object.assign({}, tzone.options);\n      members.forEach(member => {\n        member = options[member];\n        if (member) pushpriv(member, member.optgroup);\n\n      })\n    } else {\n      importzone.options.forEach(member => {\n        if (member.selected) pushpriv(member, member.dataset.optgroup);\n      })\n    }\n\n    if (this.importPrivileges(privileges, replace)) {\n      if (tzone) {\n        tzone.clear();\n        tzone.clearOptions();\n      } else importzone.innerHTML = ``;\n\n    }\n\n  }\n\n  importPrivileges(privileges, clear = false) {\n    const projectPrivileges = this.form.querySelector('.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.privileges.ident);\n\n    if (projectPrivileges === null || !projectPrivileges.jsprivileges) return;\n    const importedtag = (input) => {\n      this.setImportedTag(input, null);\n    }\n    const dismiss = () => {\n      this.dismiss();\n    }\n    const contact = (clear === true && this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact]) ? this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact] : null;\n    return (projectPrivileges.jsprivileges.importPrivileges(privileges, clear, contact, importedtag, dismiss));\n  }\n\n  resetSelectors() {\n    this.selectors.forEach((selector, i) => {\n      if (selector.disabled) selector.disabled = false;\n    });\n    this.dom.querySelectorAll('td.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected).forEach(td => {\n      td.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n    });\n  }\n\n  activateClear() {\n    const clearbutton = document.getElementById('clear-' + this.importid);\n    if (!clearbutton) return;\n    clearbutton.addEventListener('click', (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      if (!this.importcontainer) return;\n      this.resetSelectors();\n      this.button.disabled = false;\n      this.replacebutton.disabled = false;\n      this.showImport(false);\n    });\n  }\n  createImportzone(name) {\n    let importzone = this.showImport(true),\n      ts = false;\n    if (!importzone) {\n      if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) {\n        importzone = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('select', {\n          id: this.importid,\n          dataset: {\n            type: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.user,\n            priv: true,\n          },\n          multiple: true\n        }, this.importcontainer);\n        importzone = document.getElementById(this.importid);\n        ts = true;\n      } else {\n        const import_target = (this.form.querySelector('[name=\"' + name + '\"]')) ? this.form.querySelector('[name=\"' + name + '\"]') : this.form.querySelector('[data-importfield=\"' + name + '\"]');\n        if (!import_target) return;\n        ts = import_target.tomselect;\n        this.importzoneid = import_target.id;\n        // tomselect ?\n        importzone = import_target.cloneNode();\n        importzone.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.tomselected);\n        importzone.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hiddenaccessible);\n        // keep original id to replace data on apply import\n        importzone.dataset.origin = importzone.id;\n        importzone.id = this.importid;\n        importzone.name = this.importid + '_' + importzone.name;\n        this.importcontainer.prepend(importzone);\n        if (ts) {\n          _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__.JsTomSelect.applyTo(importzone);\n        }\n        this.activateClear();\n      }\n\n    }\n    return importzone;\n\n  }\n\n  makeImport(btn, selectcells, what, close = false) {\n    let done = true,\n      ts = null;\n    const importzone = (this.importcontainer) ? this.importcontainer.querySelector('#' + this.importid) : null;\n\n    switch (what) {\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo:\n\n        if (!importzone) return false;\n        const import_target = this.form.querySelector('#' + importzone.dataset.origin);\n\n        if (!import_target) return false;\n        ts = import_target.tomselect;\n        if (ts) {\n          // only if replace specified\n          if (btn.dataset.replace && btn.dataset.replace === 'replace') {\n            ts.clear();\n            ts.clearOptions();\n          }\n          const tzone = importzone.tomselect;\n          const items = [...tzone.items];\n          const options = Object.assign({}, tzone.options);\n          items.forEach((e, i) => {\n            let el = {};\n            el[ts.settings.valueField] = e;\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(options[e][ts.settings.searchField]);\n            if (!ts.getOption(e)) ts.addOption(el);\n            ts.addItem(e);\n          });\n          tzone.clear();\n          tzone.clearOptions();\n        } else {\n          if (btn.dataset.replace && btn.dataset.replace === 'replace') import_target.innerHTML = ``;\n          import_target.innerHTML = dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(importzone.innerHTML);\n          importzone.innerHTML = ``;\n        }\n        done = true;\n        break;\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges:\n        if (!importzone) return false;\n        done = this.renderPrivileges(importzone, (btn.dataset.replace && btn.dataset.replace === 'replace'));\n        if (importzone.currentlist) importzone.currentlist = {};\n        break;\n      default:\n        const ts_add_select_item = function(ts, data) {\n          const el = {};\n          if (typeof(data) == 'string') {\n            el[ts.settings.labelField] = data;\n            el[ts.settings.valueField] = data;\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data);\n          } else {\n            el[ts.settings.labelField] = data.key;\n            el[ts.settings.valueField] = data.key;\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data.value);\n          }\n          if (!ts.getOption(el[ts.settings.valueField])) ts.addOption(el);\n          if (!ts.getItem(el[ts.settings.valueField])) ts.addItem(el[ts.settings.valueField]);\n        }\n        const add_select_option = function(input, data) {\n          let attr = {\n            selected: true\n          };\n          if (typeof(data) === 'string') attr.value = attr.text = data;\n          else {\n            attr.value = data.key;\n            attr.text = data.value;\n          }\n          const option = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', attr, input);\n\n        }\n        const add_input_option = function(input, data) {\n          if (input.multiple) {\n            let values = input.value.split(',');\n            values.push(data.key);\n            input.value = values.join(',');\n          } else input.value = data;\n\n        }\n        selectcells.forEach((name, index) => {\n          let input = ((this.form.querySelector('[data-importfield=\"' + name + '\"]')) ? this.form.querySelector('[data-importfield=\"' + name + '\"]') : this.form.querySelector('[name=\"' + name + '\"]'));\n          if (input && input.dataset.noimport) return;\n          if (input && this.imports[name] !== undefined) {\n            const type = (input.type) ? input.type : input.tagName.toLowerCase();\n            ts = input.tomselect;\n            if (name === 'init_classif_list') {\n              let ids = this.imports[name];\n              if (Array.isArray(ids)) ids = ids.join(',');\n              else ids = ids.replace('[', '').replace(']', '').replaceAll(' ', '');\n              if (ts) {\n                ts.wrapper.classList.add('wait-for-results');\n                ts.clear(false);\n                ts.clearOptions();\n              }\n              if (ids !== '') {\n                if (ts) ts.wrapper.classList.add('wait-for-results');\n                const formData = new FormData();\n                formData.append('idlist', ids);\n                const url = '/search/taxoresolve' //+ new URLSearchParams({'idlist': ids});\n                fetch(url, (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.fetchSettings)({\n                  'method': 'POST',\n                  'body': formData\n                })).then(response =>\n                  response.json()\n                ).then(results => {\n                  const ts = input.tomselect;\n                  if (ts) {\n\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      ts_add_select_item(ts, el);\n                    });\n                    ts.wrapper.classList.remove('wait-for-results');\n                  } else if (type.indexOf('select') === 0) {\n\n                    input.querySelectorAll('option').forEach(option => {\n                      option.remove();\n                    });\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      add_input_option(input, el);\n                    });\n\n                  } else {\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      add_select_option(input, el);\n                    });\n\n                  }\n\n                  results = null;\n                  this.setImportedTag(input);\n                });\n              }\n            } else if (ts) {\n              ts_add_select_item(ts, this.imports[name]);\n              this.setImportedTag(input);\n            } else {\n              switch (type) {\n                case 'radio':\n                case 'checkbox':\n                  input = this.form.querySelector('[name=\"' + name + '\"][value=\"' + this.imports[name] + '\"]');\n                  if (input) input.checked = true;\n                  break;\n                case 'select':\n                  if (input.multiple) this.imports[name].forEach(data => {\n                    add_select_option(input, data)\n                  });\n                  else add_select_option(input, this.imports[name]);\n\n                  break;\n                default:\n                  input.value = this.imports[name];\n                  break;\n              }\n              this.setImportedTag(input);\n            }\n            if (what !== _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.settings) input.focus();\n            done = done && true;\n            // set imported tag to fieldbox\n\n\n          } else if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) {\n            //const clearprivileges = (what === typeimport.settings);\n            const clearprivileges = false;\n            done = done && this.importPrivileges(this.imports[name], clearprivileges);\n          }\n        });\n        break;\n    }\n    if (done === true && close == true) {\n      this.dismiss();\n      if (this.form) this.form.dispatchEvent(new CustomEvent('validate'));\n    }\n  }\n\n  setImportedTag(input, selector = _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.form.formbox) {\n    let el = (selector === null) ? input : (input.closest(selector) ? input.closest(selector) : input.closest('fieldset'));\n    if (!el) return;\n    const removetag = (e) => {\n      delete el.dataset.isimported;\n      el.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported);\n      input.removeEventListener('change', removetag);\n    }\n    el.dataset.isimported = this.form.dataset.isimported;\n    el.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported);\n    if (input.dataset.unique !== undefined) {\n      input.dataset.unique = input.value;\n    }\n    setTimeout(function() {\n      input.addEventListener('change', removetag);\n    }, 500);\n  }\n\n  dismiss(clear = false) {\n    if (this.button) this.showImport(false);\n    const container = this.dom.closest('details');\n    if (container) {\n      container.open = false;\n      if (clear === true) container.querySelector(this.content_selector).innerHTML = ``;\n    }\n\n  }\n  indexToCheck() {\n    // index of cells to check if empty and disable row  import btn\n    const grid = (this.tbl) ? this.tbl.grid : null;\n    if (!grid) return [0];\n    let index = grid.columns.findIndex(column => (column.what && column.what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo));\n    if (index === -1) return [0];\n    const parts = (grid.columns[index].parts) ? grid.columns[index].parts : null;\n    if (parts) {\n      const indextocheck = grid.columns.filter((column, i) => {\n        if (parts.indexOf(column.name) >= 0) return i;\n      }).map(v => {\n        return v.index;\n      });\n      return indextocheck;\n    }\n\n  }\n  addResetButton() {\n    if (!this.tbl || !this.tbl.params.hasOwnProperty(\"reset\")) return;\n    let resetbtn = this.dom.parentElement.querySelector(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton);\n    if (resetbtn === null) {\n      resetbtn = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('a', {\n        class: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton.substr(1),\n        text: this.tbl.params.reset\n      }, this.dom.parentElement.firstChild);\n      /*  resetbtn = document.createElement('a');\n        resetbtn.classList.add(domselectors.resetbutton.substr(1));\n        resetbtn.textContent = this.tbl.params.reset;\n        this.dom.parentElement.firstChild.prepend(resetbtn);*/\n    }\n    resetbtn.addEventListener('click', (e) => {\n      e.preventDefault();\n      e.stopImmediatePropagation();\n      const selectors = this.selectors = this.dom.querySelectorAll('[' + this.selector + '] button:disabled, [' + this.selector + '] input:disabled');\n      selectors.forEach(selector => {\n        selector.disabled = false;\n        const sel = selector.closest('tr').querySelector('.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n        if (sel) sel.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n      });\n    });\n\n  }\n  // show / hide importzone and buttons\n  showImport(show) {\n    if (!this.button) return;\n    if (show === false) {\n      this.button.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.replacebutton.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.importcontainer.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      if (this.tabbutton) this.tabbutton.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n    } else {\n      const importzone = this.importcontainer.querySelector('#' + this.importid);\n      if (importzone) {\n        //  const offseth = importzone.tomselect.control.offsetHeight;\n        //  const scrollh = importzone.tomselect.control.scrollHeight;\n        this.button.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.replacebutton.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.importcontainer.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.button.disabled = false;\n        if (this.tabbutton) {\n          this.tabbutton.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n          if (importzone.tomselect) {\n            this.tabbutton.disabled = false;\n          } else this.tabbutton.disabled = true;\n        }\n      }\n      return importzone;\n    }\n    return null;\n  }\n  // resize importzone\n  resizeZone(e) {\n    const div = this.importcontainer.closest(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.import.zoneimport);\n    if (!div) return;\n    div.parentElement.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.showfull);\n    const icon = e.currentTarget.querySelector('i');\n    if (icon) {\n      icon.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowout);\n      icon.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowin);\n    }\n  }\n}\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LGVBQWUsb0VBQVk7QUFDM0I7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0EsNERBQTREO0FBQzVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0RBQStELDJEQUFHO0FBQ2xFLHNDQUFzQywyREFBRztBQUN6QyxPQUFPO0FBQ1AsS0FBSzs7QUFFTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0NBQWdDLDJEQUFHO0FBQ25DLHVDQUF1QywyREFBRztBQUMxQyx5Q0FBeUMsMkRBQUc7QUFDNUMsdURBQXVELDJEQUFHO0FBQzFELE1BQU07QUFDTjtBQUNBO0FBQ0E7QUFDQTtBQUNBLHFDQUFxQywyREFBRztBQUN4Qyw0Q0FBNEMsMkRBQUc7QUFDL0MsOENBQThDLDJEQUFHO0FBQ2pEO0FBQ0E7QUFDQSwwQ0FBMEMsMkRBQUc7QUFDN0M7QUFDQTtBQUNBLFlBQVk7QUFDWjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNkNBQTZDLG9FQUFZO0FBQ3pEO0FBQ0EsdUNBQXVDLDJEQUFHO0FBQzFDO0FBQ0E7QUFDQSw0QkFBNEIsMkRBQUc7QUFDL0IsNEJBQTRCLDJEQUFHO0FBQy9CO0FBQ0E7QUFDQSxDIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vLy4vc3JjL21vZHVsZXMvZGF0YS1pbXBvcnQuanM/ODBhMiJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRE9NUHVyaWZ5IGZyb20gJ2RvbXB1cmlmeSc7XG5pbXBvcnQge1xuICBKc1RvbVNlbGVjdFxufSBmcm9tIFwiLi4vbW9kdWxlcy9qcy10b20tc2VsZWN0LmpzXCI7XG5pbXBvcnQge1xuICBQcm9qZWN0UHJpdmlsZWdlc1xufSBmcm9tICcuLi9tb2R1bGVzL3Byb2plY3QtcHJpdmlsZWdlcy5qcyc7XG5pbXBvcnQge1xuICBmZXRjaFNldHRpbmdzLFxuICB1bmVzY2FwZV9odG1sLFxuICBjcmVhdGVfYm94XG59IGZyb20gJy4uL21vZHVsZXMvdXRpbHMuanMnO1xuXG5pbXBvcnQge1xuICBtb2RlbHMsXG4gIHR5cGVpbXBvcnQsXG4gIGNzcyxcbiAgZGVmaW5lZF9wcml2aWxlZ2VzLFxuICBkb21zZWxlY3RvcnNcbn0gZnJvbSAnLi4vbW9kdWxlcy9tb2R1bGVzLWNvbmZpZy5qcyc7XG5jb25zdCBrZXlfcHJpdmlsZWdlcyA9IE9iamVjdC5rZXlzKGRlZmluZWRfcHJpdmlsZWdlcykucmVkdWNlKGZ1bmN0aW9uKHJlc3VsdCwga2V5KSB7XG4gIHJlc3VsdFtrZXldID0ga2V5O1xuICByZXR1cm4gcmVzdWx0O1xufSwge30pO1xubGV0IGluc3RhbmNlO1xuY3NzLmltcG9ydGVkID0gJ2ltcG9ydGVkJztcbmNzcy50b21zZWxlY3RlZCA9ICd0b21zZWxlY3RlZCc7XG5jc3MuaGlkZGVuYWNjZXNzaWJsZSA9ICd0cy1oaWRkZW4tYWNjZXNzaWJsZSc7XG5jc3MuYXJyb3dvdXQgPSAnaWNvbi1hcnJvdy1wb2ludGluZy1vdXQnO1xuY3NzLmFycm93aW4gPSAnaWNvbi1hcnJvdy1wb2ludGluZy1pbic7XG5kb21zZWxlY3RvcnMucmVzZXRidXR0b24gPSAnLmltcG9ydC1saXN0LXJlc2V0JztcbmV4cG9ydCBjbGFzcyBEYXRhSW1wb3J0IHtcbiAgY29udGVudF9zZWxlY3RvciA9ICcubW9kYWwtY29udGVudCc7XG4gIGltcG9ydHMgPSBbXTtcbiAgdGF4b3MgPSBbXCJwcmVzZXRcIiwgXCJleHRyYVwiXTtcbiAgaW1wb3J0Y29udGFpbmVyO1xuICBpbXBvcnR6b25laWQ7XG4gIGltcG9ydGlkID0gJ2ltcG9ydHpvbmUnO1xuICBzZWxlY3RvcnM7XG4gIGJ1dHRvbjtcbiAgY2xlYXJidXR0b247XG4gIHJlcGxhY2VidXR0b247XG4gIHRhYmJ1dHRvbjtcbiAgdGJsID0gbnVsbDtcbiAgY29uc3RydWN0b3IodGJsLCB3aGF0ID0gbnVsbCwgc2VsZWN0b3IgPSBudWxsKSB7XG4gICAgaWYgKCF0YmwpIHJldHVybjtcbiAgICAvLyB0YmwgaXMgYSBUYWJsZUNvbXBvbmVudCAgP1xuICAgIHRoaXMudGJsID0gKHR5cGVvZih0YmwpID09PSAnb2JqZWN0JykgPyB0YmwgOiBudWxsO1xuICAgIHNlbGVjdG9yID0gKHNlbGVjdG9yID09PSBudWxsKSA/ICgodGhpcy50YmwuY2VsbGlkbmFtZSkgPyBcImRhdGEtXCIgKyB0aGlzLnRibC5jZWxsaWRuYW1lIDogXCJkYXRhLWlkXCIpIDogc2VsZWN0b3I7XG4gICAgLy8gZ2V0IHRoZSB0YWJsZSBmcm9tIHRhYmxlIGNvbXBvbmVudCBvciBodG1sIHRhYmxlIGVsZW1lbnQgaWRcbiAgICB0aGlzLmRvbSA9ICh0aGlzLnRibCkgPyB0aGlzLnRibC5kb20gOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0YmwpO1xuICAgIGlmICghdGhpcy5kb20pIHJldHVybjtcbiAgICB3aGF0ID0gKHdoYXQpID8gRE9NUHVyaWZ5LnNhbml0aXplKHdoYXQpIDogKHRibCAmJiB0YmwucGFyYW1zICYmIHRibC5wYXJhbXMuaW1wb3J0KSA/IHRibC5wYXJhbXMuaW1wb3J0IDogKHRoaXMuZG9tLmRhdGFzZXQuaW1wb3J0KSA/IERPTVB1cmlmeS5zYW5pdGl6ZSh0aGlzLmRvbS5kYXRhc2V0LmltcG9ydCkgOiBudWxsO1xuICAgIGlmICghaW5zdGFuY2UgfHwgaW5zdGFuY2UuZG9jICE9PSB0aGlzLmRvbSkge1xuICAgICAgLy8gZGVmYXVsdG9wdGlvbnMgLSBrZWVwIGxpa2UgdGhhdFxuXG4gICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICBpbXBvcnRjb250YWluZXI6ICcjZGF0YS1pbXBvcnQtJyArIHdoYXQsXG4gICAgICAgIGJ0bnM6ICcuYnRucy1pbXBvcnRzJyxcbiAgICAgICAgYnV0dG9uOiAnI2FkZC1pbXBvcnQtJyArIHdoYXQsXG4gICAgICAgIHJlcGxhY2VidXR0b246ICcjcmVwbGFjZS1pbXBvcnQtJyArIHdoYXQsXG4gICAgICAgIHRhYmJ1dHRvbjogJyN0YWItaW1wb3J0LScgKyB3aGF0LFxuICAgICAgfTtcbiAgICAgIHRoaXMuc2VsZWN0b3IgPSBzZWxlY3RvcjtcblxuICAgICAgdGhpcy5pbXBvcnRjb250YWluZXIgPSBvcHRpb25zLmltcG9ydGNvbnRhaW5lciBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ID8gb3B0aW9ucy5pbXBvcnRjb250YWluZXIgOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKG9wdGlvbnMuaW1wb3J0Y29udGFpbmVyKTtcbiAgICAgIHRoaXMuZm9ybSA9IChvcHRpb25zLmZvcm0pID8gKChvcHRpb25zLmZvcm0pIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgPyBvcHRpb25zLmZvcm0gOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKG9wdGlvbnMuZm9ybSkpIDogdGhpcy5kb20uY2xvc2VzdCgnZm9ybScpO1xuICAgICAgdGhpcy5idXR0b24gPSBvcHRpb25zLmJ1dHRvbiBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ID8gb3B0aW9ucy5idXR0b24gOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKG9wdGlvbnMuYnV0dG9uKTtcbiAgICAgIHRoaXMucmVwbGFjZWJ1dHRvbiA9IG9wdGlvbnMucmVwbGFjZWJ1dHRvbiBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ID8gb3B0aW9ucy5yZXBsYWNlYnV0dG9uIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLnJlcGxhY2VidXR0b24pO1xuICAgICAgdGhpcy50YWJidXR0b24gPSBvcHRpb25zLnRhYmJ1dHRvbiBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ID8gb3B0aW9ucy50YWJidXR0b24gOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKG9wdGlvbnMudGFiYnV0dG9uKTtcbiAgICAgIHRoaXMuaW1wb3J0aWQgPSB0aGlzLmltcG9ydGlkICsgJ18nICsgd2hhdDtcbiAgICAgIHRoaXMuaW5pdChvcHRpb25zKTtcbiAgICAgIGluc3RhbmNlID0gdGhpcztcblxuICAgIH1cbiAgICByZXR1cm4gaW5zdGFuY2U7XG4gIH1cblxuICBpbml0KG9wdGlvbnMpIHtcbiAgICAvLyBoaWRlIGltcG9ydHpvbmVcbiAgICB0aGlzLnNob3dJbXBvcnQoZmFsc2UpO1xuICAgIC8vIHJlbW92ZSBsaW5lIG9mIHRhcmdldCBwcm9qXG4gICAgbGV0IHByb2ppZCA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCcjJyArIGRvbXNlbGVjdG9ycy5wcm9qaWQpO1xuICAgIGlmIChwcm9qaWQgJiYgcHJvamlkLnZhbHVlKSB7XG4gICAgICBwcm9qaWQgPSB0aGlzLmRvbS5xdWVyeVNlbGVjdG9yKCdbJyArIHRoaXMuc2VsZWN0b3IgKyAnPVwiJyArIHByb2ppZC52YWx1ZSArICdcIl0nKTtcbiAgICAgIGlmIChwcm9qaWQpIHByb2ppZC5oaWRkZW4gPSB0cnVlO1xuICAgIH1cbiAgICBjb25zdCBpbmRleHRvY2hlY2sgPSB0aGlzLmluZGV4VG9DaGVjaygpO1xuICAgIHRoaXMuc2VsZWN0b3JzID0gdGhpcy5kb20ucXVlcnlTZWxlY3RvckFsbCgnWycgKyB0aGlzLnNlbGVjdG9yICsgJ10gYnV0dG9uLCBbJyArIHRoaXMuc2VsZWN0b3IgKyAnXSBpbnB1dCcpO1xuICAgIHRoaXMuc2VsZWN0b3JzLmZvckVhY2goc2VsZWN0b3IgPT4ge1xuICAgICAgLy8gY2hlY2tib3ggcG9zc2libGVcbiAgICAgIGNvbnN0IGluZGV4ID0gQXJyYXkuZnJvbShzZWxlY3Rvci5wYXJlbnRFbGVtZW50LmNoaWxkcmVuKS5pbmRleE9mKChzZWxlY3RvcikpO1xuICAgICAgaWYgKGluZGV4dG9jaGVjayAmJiBzZWxlY3Rvci5jbG9zZXN0KCd0cicpLmNoaWxkcmVuW2luZGV4dG9jaGVja1tpbmRleF1dLmlubmVySFRNTCA9PT0gJycpIHNlbGVjdG9yLmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgIGVsc2Uge1xuICAgICAgICBjb25zdCBldnQgPSAoc2VsZWN0b3IudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnaW5wdXQnKSA/ICdjaGFuZ2UnIDogJ2NsaWNrJztcbiAgICAgICAgY29uc3QgYXBwbHlfc2VsZWN0aW9uID0gKGUpID0+IHtcbiAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICBjb25zdCB0YXJnZXQgPSBlLmN1cnJlbnRUYXJnZXQ7XG4gICAgICAgICAgdGFyZ2V0LmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLnRvSW1wb3J0KHRhcmdldC5wYXJlbnRFbGVtZW50LCBpbmRleCk7XG4gICAgICAgIH07XG4gICAgICAgIHNlbGVjdG9yLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZ0LCBhcHBseV9zZWxlY3Rpb24sIGZhbHNlKTtcbiAgICAgICAgc2VsZWN0b3IuYWRkRXZlbnRMaXN0ZW5lcihldnQsIGFwcGx5X3NlbGVjdGlvbiwgZmFsc2UpO1xuICAgICAgfTtcbiAgICB9KTtcbiAgICBpZiAodGhpcy50YWJidXR0b24pIHtcbiAgICAgIHRoaXMudGFiYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB0aGlzLnJlc2l6ZVpvbmUoZSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgY29sdW1uUHJvcGVydHkobmFtZSwgaW5kZXgsIHRoKSB7XG4gICAgaWYgKHRoaXMudGJsKSByZXR1cm4gKHRoaXMudGJsLmdyaWQuY29sdW1uc1tpbmRleF0uaGFzT3duUHJvcGVydHkobmFtZSkpID8gdGhpcy50YmwuZ3JpZC5jb2x1bW5zW2luZGV4XVtuYW1lXSA6IG51bGw7XG4gICAgZWxzZSByZXR1cm4gKHRoLmRhdGFzZXRbbmFtZV0pID8gdGguZGF0YXNldC5uYW1lIDogbnVsbDtcbiAgfVxuICBjb2x1bW5JbmRleChwcm9wLCB2YWx1ZSkge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoJ3RoZWFkIHRoJykpLmZpbmRJbmRleCh0aCA9PiAodGguZGF0YXNldFtwcm9wXSAmJiB0aC5kYXRhc2V0W3Byb3BdID09PSB2YWx1ZSkpO1xuICB9XG4gIGdyaWRDb2x1bW5JbmRleChwcm9wLCB2YWx1ZSkge1xuICAgIGlmICh0aGlzLnRibCkgcmV0dXJuIHRoaXMudGJsLmdyaWQuY29sdW1ucy5maW5kSW5kZXgoY29sdW1uID0+IChjb2x1bW4uaGFzT3duUHJvcGVydHkocHJvcCkgJiYgY29sdW1uW3Byb3BdID09PSB2YWx1ZSkpO1xuICAgIGVsc2UgcmV0dXJuIHRoaXMuY29sdW1uSW5kZXgocHJvcCwgdmFsdWUpO1xuICB9XG4gIHJvd0luZGV4KHRkLCB0cnMpIHtcbiAgICBjb25zdCByZWYgPSAodGQucGFyZW50RWxlbWVudCkgPyB0ZC5wYXJlbnRFbGVtZW50IDogbnVsbDtcbiAgICBpZiAoIXJlZikgcmV0dXJuIG51bGw7XG4gICAgcmV0dXJuIHRycy5maW5kSW5kZXgodHIgPT4gKHRyID09PSByZWYpKTtcbiAgfVxuICB0b0ltcG9ydCh0ZCwgd2hhdHBhcnQgPSAwKSB7XG4gICAgY29uc3QgZ3JpZCA9ICh0aGlzLnRibCkgPyB0aGlzLnRibC5ncmlkIDogbnVsbDtcbiAgICBjb25zdCB0aGNlbGxzID0gQXJyYXkuZnJvbSh0aGlzLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCd0aGVhZCB0aCcpKTtcbiAgICBjb25zdCB0cnMgPSBBcnJheS5mcm9tKHRoaXMuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoJ3Rib2R5IHRyJykpO1xuICAgIGNvbnN0IGRhdGFzID0gKGdyaWQpID8gZ3JpZC5kYXRhIDogdHJzLm1hcCh0ciA9PiB7XG4gICAgICByZXR1cm4gQXJyYXkuZnJvbSh0ci5jaGlsZE5vZGVzKS5mb3JFYWNoKGNlbGwgPT4ge1xuICAgICAgICByZXR1cm4gY2VsbC5pbm5lclRleHQ7XG4gICAgICB9KTtcbiAgICB9KTsgLy8gY2VsbCB2YWx1ZXMgaW4ganNvbiAgLSBubyBwYXJzZVxuICAgIGlmICh0ZC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICd0ZCcpIHRkID0gdGQuY2xvc2VzdCgndGQnKTtcbiAgICBjb25zdCByb3dpbmRleCA9IHRoaXMucm93SW5kZXgodGQsIHRycyk7XG4gICAgaWYgKHJvd2luZGV4ID09PSBudWxsKSByZXR1cm47XG4gICAgbGV0IHNob3didG5zID0gdHJ1ZTtcbiAgICBjb25zdCBjZWxsaW5kZXggPSB0ZC5jZWxsSW5kZXg7XG4gICAgY29uc3QgdGggPSB0aGNlbGxzW2NlbGxpbmRleF07XG4gICAgY29uc3QgdGRzID0gdHJzW3Jvd2luZGV4XTtcbiAgICBjb25zdCB3aGF0ID0gdGhpcy5jb2x1bW5Qcm9wZXJ0eSgnd2hhdCcsIGNlbGxpbmRleCwgdGgpO1xuICAgIGlmICghd2hhdCkgcmV0dXJuO1xuICAgIGNvbnN0IHBhcnRzID0gdGhpcy5jb2x1bW5Qcm9wZXJ0eSgncGFydHMnLCBjZWxsaW5kZXgsIHRoKTtcbiAgICBsZXQgY29udGFjdCA9IG51bGw7XG4gICAgbGV0IHNlbGVjdGNlbGxzID0gdGhpcy5jb2x1bW5Qcm9wZXJ0eSgnc2VsZWN0Y2VsbHMnLCBjZWxsaW5kZXgsIHRoKTtcbiAgICBzZWxlY3RjZWxscyA9IChzZWxlY3RjZWxscykgPyAoKHBhcnRzKSA/IFtwYXJ0c1t3aGF0cGFydF1dIDogc2VsZWN0Y2VsbHMpIDogbnVsbDtcbiAgICBpZiAoIXNlbGVjdGNlbGxzKSByZXR1cm47XG4gICAgaWYgKHdoYXQgPT09IHR5cGVpbXBvcnQuc2V0dGluZ3MgfHwgd2hhdCA9PT0gdHlwZWltcG9ydC5wcml2aWxlZ2VzKSB0aGlzLmltcG9ydHNbbW9kZWxzLmNvbnRhY3RdID0gdGhpcy5maW5kQ29udGFjdChkYXRhc1tyb3dpbmRleF0pO1xuICAgIGNvbnN0IGltcG9ydHpvbmUgPSAod2hhdCA9PT0gdHlwZWltcG9ydC50YXhvIHx8IHdoYXQgPT09IHR5cGVpbXBvcnQucHJpdmlsZWdlcykgPyB0aGlzLmNyZWF0ZUltcG9ydHpvbmUod2hhdCkgOiBudWxsO1xuXG4gICAgdGhpcy5hZGRSZXNldEJ1dHRvbigpO1xuICAgIGxldCB0cyA9IG51bGw7XG4gICAgc2VsZWN0Y2VsbHMuZm9yRWFjaCgobmFtZSwgaW5kZXgpID0+IHtcbiAgICAgIGluZGV4ID0gdGhpcy5ncmlkQ29sdW1uSW5kZXgoJ25hbWUnLCBuYW1lKTtcbiAgICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICAgIGNvbnN0IHRkaW5kZXggPSB0aGlzLmNvbHVtbkluZGV4KCduYW1lJywgbmFtZSk7XG4gICAgICAgIC8vIHNob3cgaW1wb3J0IGJ1dHRvbnMgaWYgaW1wb3J0em9uZVxuICAgICAgICBjb25zdCBjZWxsID0gKHRkaW5kZXggPj0gMCkgPyB0cnNbcm93aW5kZXhdLmNlbGxzW3RkaW5kZXhdIDogbnVsbDtcbiAgICAgICAgaWYgKGNlbGwpIGNlbGwuY2xhc3NMaXN0LmFkZChjc3Muc2VsZWN0ZWQpO1xuICAgICAgICBjb25zdCBjZWxsZGF0YSA9IGRhdGFzW3Jvd2luZGV4XVtpbmRleF07XG4gICAgICAgIGNvbnN0IHRoY2VsbCA9ICh0ZGluZGV4ID49IDApID8gdGhjZWxsc1t0ZGluZGV4XSA6IG51bGw7XG4gICAgICAgIHN3aXRjaCAod2hhdCkge1xuICAgICAgICAgIGNhc2UgdHlwZWltcG9ydC50YXhvOlxuICAgICAgICAgICAgaWYgKCFpbXBvcnR6b25lKSByZXR1cm47XG4gICAgICAgICAgICAvLyBhY2N1bXVsYXRlIGFuZCBzaG93IGluIGltcG9ydCB3aW4gLSBtb3ZlIHRoZSBmb3JtIGZpZWxkIGluIG1vZGFsIHdpbiB0byB2aWV3IHRoZSBjaGFuZ2VzIGFuZCBiZW5lZml0IG9mIHRvbS1zZWxlY3QgY29tcG9uZW50IGZ1bmN0cy4uLlxuICAgICAgICAgICAgdHMgPSBpbXBvcnR6b25lLnRvbXNlbGVjdDtcbiAgICAgICAgICAgIGxldCB0YXhvbnMgPSBjZWxsZGF0YTtcbiAgICAgICAgICAgIGlmICh0YXhvbnMpIHtcbiAgICAgICAgICAgICAgaWYgKHRzKSB7XG4gICAgICAgICAgICAgICAgLy8gbWVyZ2UgdGF4b25zIGFuZCBvcHRpb25zIC0gdW5pcXVlXG4gICAgICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyh0cy5vcHRpb25zKS5mb3JFYWNoKChvcHQpID0+IHtcbiAgICAgICAgICAgICAgICAgIGxldCBvYmogPSB7fTtcbiAgICAgICAgICAgICAgICAgIG9ialtvcHRbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF1dID0gb3B0W3RzLnNldHRpbmdzLmxhYmVsRmllbGRdO1xuICAgICAgICAgICAgICAgICAgaWYgKCF0YXhvbnNbb3B0W3RzLnNldHRpbmdzLnZhbHVlRmllbGRdXSkgdGF4b25zID0gT2JqZWN0LmFzc2lnbih0YXhvbnMsIG9iaik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGF4b25zID0gT2JqZWN0LmVudHJpZXModGF4b25zKTtcbiAgICAgICAgICAgICAgICAvLyBzb3J0IHRheG9uc1xuICAgICAgICAgICAgICAgIHRheG9ucy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgICAgICAgICBsZXQgeCA9IGFbMV07XG4gICAgICAgICAgICAgICAgICBsZXQgeSA9IGJbMV07XG4gICAgICAgICAgICAgICAgICByZXR1cm4gKyh4ID4geSkgfHwgLSh5ID4geCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdHMuY2xlYXIoKTtcbiAgICAgICAgICAgICAgICB0cy5jbGVhck9wdGlvbnMoKTtcbiAgICAgICAgICAgICAgICAvLyBhZGQgdGF4b25zIGl0ZW1zXG4gICAgICAgICAgICAgICAgdGF4b25zLmZvckVhY2goKFtrZXksIHRleHRdKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoIXRzLmdldEl0ZW0oa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRzLmdldE9wdGlvbihrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgbGV0IG9iaiA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgIG9ialt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSA9IGtleTtcbiAgICAgICAgICAgICAgICAgICAgICBvYmpbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSB1bmVzY2FwZV9odG1sKHRleHQudHJpbSgpKTtcbiAgICAgICAgICAgICAgICAgICAgICB0cy5hZGRPcHRpb24ob2JqKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0cy5hZGRJdGVtKGtleSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyhpbXBvcnR6b25lLm9wdGlvbnMpLmZvckVhY2gob3B0ID0+IHtcbiAgICAgICAgICAgICAgICAgIGxldCBvYmogPSB7fTtcbiAgICAgICAgICAgICAgICAgIG9ialtvcHQudmFsdWVdID0gb3B0LnRleHQ7XG4gICAgICAgICAgICAgICAgICBpZiAoIXRheG9uc1tvcHQudmFsdWVdKSB0YXhvbnMgPSBPYmplY3QuYXNzaWduKHRheG9ucywgb2JqKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0YXhvbnMgPSBPYmplY3QuZW50cmllcyh0YXhvbnMpO1xuICAgICAgICAgICAgICAgIHRheG9ucy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgICAgICAgICBsZXQgeCA9IGFbMV07XG4gICAgICAgICAgICAgICAgICBsZXQgeSA9IGJbMV07XG4gICAgICAgICAgICAgICAgICByZXR1cm4gKyh4ID4geSkgfHwgLSh5ID4geCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaW1wb3J0em9uZS5pbm5lckhUTUwgPSBgYDtcbiAgICAgICAgICAgICAgICB0YXhvbnMuZm9yRWFjaCgoW2tleSwgdGV4dF0pID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmICghaW1wb3J0em9uZS5xdWVyeVNlbGVjdG9yKCdvcHRpb25bdmFsdWU9XCInICsga2V5ICsgJ1wiXScpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG8gPSBjcmVhdGVfYm94KCdvcHRpb24nLCB7XG4gICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGtleSxcbiAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogJ3NlbGVjdGVkJyxcbiAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0ZXh0XG4gICAgICAgICAgICAgICAgICAgIH0sIGltcG9ydHpvbmUpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHNob3didG5zID0gKHRheG9ucy5sZW5ndGggPiAwKTtcbiAgICAgICAgICAgICAgdGF4b25zID0gbnVsbDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSB0eXBlaW1wb3J0LnByaXZpbGVnZXM6XG4gICAgICAgICAgICBjb25zdCBwcml2cyA9IGNlbGxkYXRhO1xuICAgICAgICAgICAgLy8gc2V0IGV2ZXJ5Ym9keSB0byAndmlldycgaWYgbW9yZSB0aGFuIG9uZSBwcm9qZWN0IGltcG9ydGVkXG4gICAgICAgICAgICBjb25zdCByZXNldHByaXYgPSAoKHRzICYmIHRzLml0ZW1zLmxlbmd0aCA+IDApIHx8IChpbXBvcnR6b25lLnNlbGVjdGVkSW5kZXggPiAwKSk7XG4gICAgICAgICAgICBpZiAoIWltcG9ydHpvbmUudG9tc2VsZWN0KSB7XG4gICAgICAgICAgICAgIGltcG9ydHpvbmUuY3VycmVudGxpc3QgPSB7fTtcbiAgICAgICAgICAgICAgSnNUb21TZWxlY3QuYXBwbHlUbyhpbXBvcnR6b25lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRzID0gaW1wb3J0em9uZS50b21zZWxlY3Q7XG4gICAgICAgICAgICBPYmplY3QuZW50cmllcyhwcml2cykuZm9yRWFjaCgoW3ByaXYsIG1lbWJlcnNdKSA9PiB7XG4gICAgICAgICAgICAgIG1lbWJlcnMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAoYi5uYW1lID4gYS5uYW1lKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIG1lbWJlcnMuZm9yRWFjaChtZW1iZXIgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld3ByaXYgPSAocmVzZXRwcml2KSA/IGtleV9wcml2aWxlZ2VzLnZpZXdlcnMgOiBwcml2OyAvLyB2aWV3ZXIgaWYgbW9yZSB0aGFuIG9uZSBwcm9qZWN0IGltcG9ydGVkXG4gICAgICAgICAgICAgICAgbGV0IG9wdDtcbiAgICAgICAgICAgICAgICBpZiAoIWltcG9ydHpvbmUuY3VycmVudGxpc3QgfHwgIWltcG9ydHpvbmUuY3VycmVudGxpc3RbbWVtYmVyLmlkXSkge1xuICAgICAgICAgICAgICAgICAgaWYgKHRzKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdCA9IHRzLml0ZW1zLmluZGV4T2YobWVtYmVyLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgLy9UT0RPIC0gdGVzdCAtIG9wdCBzaG91bGQgYWx3YXlzIGJlIDBcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdCA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgdHMucmVtb3ZlSXRlbShtZW1iZXIuaWQpO1xuICAgICAgICAgICAgICAgICAgICAgIHRzLnJlbW92ZU9wdGlvbihtZW1iZXIuaWQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIGFkZG9wdGlvbiAmJiBhZGRJdGVtXG4gICAgICAgICAgICAgICAgICAgIG9wdCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICBvcHRncm91cDogbmV3cHJpdlxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG9wdFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSA9IG1lbWJlci5pZDtcbiAgICAgICAgICAgICAgICAgICAgb3B0W3RzLnNldHRpbmdzLnNlYXJjaEZpZWxkXSA9IG1lbWJlci5uYW1lO1xuICAgICAgICAgICAgICAgICAgICBvcHRbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSBtZW1iZXIubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgdHMuYWRkT3B0aW9uKG9wdCk7XG4gICAgICAgICAgICAgICAgICAgIHRzLmFkZEl0ZW0obWVtYmVyLmlkKTtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdCA9IGltcG9ydHpvbmUucXVlcnlTZWxlY3Rvcignb3B0aW9uW3ZhbHVlPVwiJyArIG1lbWJlci5pZCArICdcIl0nKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgIG9wdCA9IGNyZWF0ZV9ib3goJ29wdGlvbicsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBtZW1iZXIuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhc2V0OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGdyb3VwOiBuZXdwcml2XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0ZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBtZW1iZXIubmFtZVxuICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgLyogIG9wdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0LnZhbHVlID0gbWVtYmVyLmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0LmRhdGFzZXQub3B0Z3JvdXAgPSBuZXdwcml2O1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0LnNlbGVjdGVkID0gb3B0LmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHQudGV4dCA9IG1lbWJlci5uYW1lOyovXG4gICAgICAgICAgICAgICAgICAgICAgaW1wb3J0em9uZS5hZGQob3B0KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIG9wdC5kYXRhc2V0Lm9wdGdyb3VwID0gbmV3cHJpdjtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBpZiAodHMpIHRzLnJlZnJlc2hPcHRpb25zKHRydWUpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHNob3didG5zID0gKCgodHMpID8gdHMuaXRlbXMubGVuZ3RoIDogaW1wb3J0em9uZS5zZWxlY3RlZEluZGV4ICsgMSkgPiAwKTtcblxuXG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGhpcy5pbXBvcnRzW25hbWVdID0gY2VsbGRhdGE7XG4gICAgICAgICAgICBpZiAoY2VsbCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICBpZiAoY2VsbC5kYXRhc2V0LmF1dG9jb21wbGV0ZSkge1xuICAgICAgICAgICAgICAgIC8vIHNlbGVjdCBlbGVtZW50cyB3aGVyZSBrZXkgLyB2YWx1ZSBpbiBkaWZmZXJlbnQgY29sdW1uc1xuICAgICAgICAgICAgICAgIHRoaXMuaW1wb3J0c1tuYW1lXSA9IHtcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBjZWxsZGF0YSxcbiAgICAgICAgICAgICAgICAgIGtleTogbnVsbFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgbGV0IGVsID0gbnVsbDtcbiAgICAgICAgICAgICAgICB0aGNlbGxzLmV2ZXJ5KCh0LCBpZHgpID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmICh0LmRhdGFzZXQubmFtZSA9PSB0aGNlbGwuZGF0YXNldC5hdXRvY29tcGxldGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZWwgPSBpZHg7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmIChlbCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgZWwgPSBkYXRhc1tyb3dpbmRleF1bZWxdO1xuXG4gICAgICAgICAgICAgICAgICB0aGlzLmltcG9ydHNbbmFtZV0ua2V5ID0gZWw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNlbGwuZGF0YXNldC52YWx1ZSkgdGhpcy5pbXBvcnRzW25hbWVdID0gY2VsbC5kYXRhc2V0LnZhbHVlO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0pO1xuXG4gICAgaWYgKHRoY2VsbHMubGVuZ3RoKSB7XG4gICAgICBpZiAodGhpcy5idXR0b24pIHtcbiAgICAgICAgY29uc3QgYWN0aXZhdGUgPSAoIXRoaXMuYnV0dG9uLmRhdGFzZXQuYWN0aXZhdGVkICYmICh3aGF0ID09PSB0eXBlaW1wb3J0LnRheG8gfHwgd2hhdCA9PT0gdHlwZWltcG9ydC5wcml2aWxlZ2VzKSk7XG4gICAgICAgIHRoaXMuc2hvd0ltcG9ydChzaG93YnRucyk7XG4gICAgICAgIGlmIChhY3RpdmF0ZSkgdGhpcy5hY3RpdmF0ZUJ1dHRvbnMod2hhdCwgc2VsZWN0Y2VsbHMpO1xuICAgICAgfSBlbHNlIHRoaXMubWFrZUltcG9ydChudWxsLCBzZWxlY3RjZWxscywgd2hhdCwgdHJ1ZSk7XG4gICAgfVxuICAgIC8vXG5cbiAgfVxuICBtZXNzYWdlWm9uZShpdGVtKSB7XG4gICAgY29uc29sZS5sb2coJ2l0ZW1tZXNzYWdlJywgaXRlbSk7XG4gIH1cbiAgYWN0aXZhdGVCdXR0b25zKHdoYXQsIHNlbGVjdGNlbGxzKSB7XG5cbiAgICB0aGlzLmJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgdGhpcy5tYWtlSW1wb3J0KGUuY3VycmVudFRhcmdldCwgc2VsZWN0Y2VsbHMsIHdoYXQsIHRydWUpO1xuXG4gICAgfSk7XG4gICAgdGhpcy5yZXBsYWNlYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB0aGlzLm1ha2VJbXBvcnQoZS5jdXJyZW50VGFyZ2V0LCBzZWxlY3RjZWxscywgd2hhdCwgdHJ1ZSk7XG5cbiAgICB9KTtcblxuICAgIHRoaXMuYnV0dG9uLmRhdGFzZXQuYWN0aXZhdGVkID0gdHJ1ZTtcbiAgICB0aGlzLnJlcGxhY2VidXR0b24uZGF0YXNldC5hY3RpdmF0ZWQgPSB0cnVlO1xuICB9XG5cbiAgZmluZENvbnRhY3QodGRzLCBuYW1lID0gJ2NvbnRhY3QnKSB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmdyaWRDb2x1bW5JbmRleCgnbmFtZScsIG5hbWUpO1xuICAgIGlmIChpbmRleCA+PSAwKSByZXR1cm4gdGRzW2luZGV4XSA/IHRkc1tpbmRleF0gOiBudWxsO1xuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICByZW5kZXJQcml2aWxlZ2VzKGltcG9ydHpvbmUsIHJlcGxhY2UgPSBmYWxzZSkge1xuICAgIGxldCBwcml2aWxlZ2VzID0ge307XG4gICAgY29uc3QgdHpvbmUgPSBpbXBvcnR6b25lLnRvbXNlbGVjdDtcblxuICAgIGNvbnN0IHB1c2hwcml2ID0gKG1lbWJlciwgcHJpdikgPT4ge1xuICAgICAgY29uc3Qgb2JqID0ge1xuICAgICAgICBpZDogbWVtYmVyLmlkLFxuICAgICAgICBuYW1lOiBtZW1iZXIubmFtZSxcbiAgICAgICAgcHJpdjogcHJpdlxuICAgICAgfVxuICAgICAgaWYgKHByaXZpbGVnZXNbcHJpdl0pIHByaXZpbGVnZXNbcHJpdl0ucHVzaChvYmopO1xuICAgICAgZWxzZSBwcml2aWxlZ2VzW3ByaXZdID0gW29ial07XG4gICAgfVxuXG4gICAgaWYgKHR6b25lKSB7XG4gICAgICBjb25zdCBtZW1iZXJzID0gWy4uLnR6b25lLml0ZW1zXTtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCB0em9uZS5vcHRpb25zKTtcbiAgICAgIG1lbWJlcnMuZm9yRWFjaChtZW1iZXIgPT4ge1xuICAgICAgICBtZW1iZXIgPSBvcHRpb25zW21lbWJlcl07XG4gICAgICAgIGlmIChtZW1iZXIpIHB1c2hwcml2KG1lbWJlciwgbWVtYmVyLm9wdGdyb3VwKTtcblxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgaW1wb3J0em9uZS5vcHRpb25zLmZvckVhY2gobWVtYmVyID0+IHtcbiAgICAgICAgaWYgKG1lbWJlci5zZWxlY3RlZCkgcHVzaHByaXYobWVtYmVyLCBtZW1iZXIuZGF0YXNldC5vcHRncm91cCk7XG4gICAgICB9KVxuICAgIH1cblxuICAgIGlmICh0aGlzLmltcG9ydFByaXZpbGVnZXMocHJpdmlsZWdlcywgcmVwbGFjZSkpIHtcbiAgICAgIGlmICh0em9uZSkge1xuICAgICAgICB0em9uZS5jbGVhcigpO1xuICAgICAgICB0em9uZS5jbGVhck9wdGlvbnMoKTtcbiAgICAgIH0gZWxzZSBpbXBvcnR6b25lLmlubmVySFRNTCA9IGBgO1xuXG4gICAgfVxuXG4gIH1cblxuICBpbXBvcnRQcml2aWxlZ2VzKHByaXZpbGVnZXMsIGNsZWFyID0gZmFsc2UpIHtcbiAgICBjb25zdCBwcm9qZWN0UHJpdmlsZWdlcyA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCcuJyArIGRvbXNlbGVjdG9ycy5jb21wb25lbnQucHJpdmlsZWdlcy5pZGVudCk7XG5cbiAgICBpZiAocHJvamVjdFByaXZpbGVnZXMgPT09IG51bGwgfHwgIXByb2plY3RQcml2aWxlZ2VzLmpzcHJpdmlsZWdlcykgcmV0dXJuO1xuICAgIGNvbnN0IGltcG9ydGVkdGFnID0gKGlucHV0KSA9PiB7XG4gICAgICB0aGlzLnNldEltcG9ydGVkVGFnKGlucHV0LCBudWxsKTtcbiAgICB9XG4gICAgY29uc3QgZGlzbWlzcyA9ICgpID0+IHtcbiAgICAgIHRoaXMuZGlzbWlzcygpO1xuICAgIH1cbiAgICBjb25zdCBjb250YWN0ID0gKGNsZWFyID09PSB0cnVlICYmIHRoaXMuaW1wb3J0c1ttb2RlbHMuY29udGFjdF0pID8gdGhpcy5pbXBvcnRzW21vZGVscy5jb250YWN0XSA6IG51bGw7XG4gICAgcmV0dXJuIChwcm9qZWN0UHJpdmlsZWdlcy5qc3ByaXZpbGVnZXMuaW1wb3J0UHJpdmlsZWdlcyhwcml2aWxlZ2VzLCBjbGVhciwgY29udGFjdCwgaW1wb3J0ZWR0YWcsIGRpc21pc3MpKTtcbiAgfVxuXG4gIHJlc2V0U2VsZWN0b3JzKCkge1xuICAgIHRoaXMuc2VsZWN0b3JzLmZvckVhY2goKHNlbGVjdG9yLCBpKSA9PiB7XG4gICAgICBpZiAoc2VsZWN0b3IuZGlzYWJsZWQpIHNlbGVjdG9yLmRpc2FibGVkID0gZmFsc2U7XG4gICAgfSk7XG4gICAgdGhpcy5kb20ucXVlcnlTZWxlY3RvckFsbCgndGQuJyArIGNzcy5zZWxlY3RlZCkuZm9yRWFjaCh0ZCA9PiB7XG4gICAgICB0ZC5jbGFzc0xpc3QucmVtb3ZlKGNzcy5zZWxlY3RlZCk7XG4gICAgfSk7XG4gIH1cblxuICBhY3RpdmF0ZUNsZWFyKCkge1xuICAgIGNvbnN0IGNsZWFyYnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NsZWFyLScgKyB0aGlzLmltcG9ydGlkKTtcbiAgICBpZiAoIWNsZWFyYnV0dG9uKSByZXR1cm47XG4gICAgY2xlYXJidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xuICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGlmICghdGhpcy5pbXBvcnRjb250YWluZXIpIHJldHVybjtcbiAgICAgIHRoaXMucmVzZXRTZWxlY3RvcnMoKTtcbiAgICAgIHRoaXMuYnV0dG9uLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICB0aGlzLnJlcGxhY2VidXR0b24uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuc2hvd0ltcG9ydChmYWxzZSk7XG4gICAgfSk7XG4gIH1cbiAgY3JlYXRlSW1wb3J0em9uZShuYW1lKSB7XG4gICAgbGV0IGltcG9ydHpvbmUgPSB0aGlzLnNob3dJbXBvcnQodHJ1ZSksXG4gICAgICB0cyA9IGZhbHNlO1xuICAgIGlmICghaW1wb3J0em9uZSkge1xuICAgICAgaWYgKG5hbWUgPT09IHR5cGVpbXBvcnQucHJpdmlsZWdlcykge1xuICAgICAgICBpbXBvcnR6b25lID0gY3JlYXRlX2JveCgnc2VsZWN0Jywge1xuICAgICAgICAgIGlkOiB0aGlzLmltcG9ydGlkLFxuICAgICAgICAgIGRhdGFzZXQ6IHtcbiAgICAgICAgICAgIHR5cGU6IG1vZGVscy51c2VyLFxuICAgICAgICAgICAgcHJpdjogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG11bHRpcGxlOiB0cnVlXG4gICAgICAgIH0sIHRoaXMuaW1wb3J0Y29udGFpbmVyKTtcbiAgICAgICAgaW1wb3J0em9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuaW1wb3J0aWQpO1xuICAgICAgICB0cyA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBpbXBvcnRfdGFyZ2V0ID0gKHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbbmFtZT1cIicgKyBuYW1lICsgJ1wiXScpKSA/IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbbmFtZT1cIicgKyBuYW1lICsgJ1wiXScpIDogdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWltcG9ydGZpZWxkPVwiJyArIG5hbWUgKyAnXCJdJyk7XG4gICAgICAgIGlmICghaW1wb3J0X3RhcmdldCkgcmV0dXJuO1xuICAgICAgICB0cyA9IGltcG9ydF90YXJnZXQudG9tc2VsZWN0O1xuICAgICAgICB0aGlzLmltcG9ydHpvbmVpZCA9IGltcG9ydF90YXJnZXQuaWQ7XG4gICAgICAgIC8vIHRvbXNlbGVjdCA/XG4gICAgICAgIGltcG9ydHpvbmUgPSBpbXBvcnRfdGFyZ2V0LmNsb25lTm9kZSgpO1xuICAgICAgICBpbXBvcnR6b25lLmNsYXNzTGlzdC5yZW1vdmUoY3NzLnRvbXNlbGVjdGVkKTtcbiAgICAgICAgaW1wb3J0em9uZS5jbGFzc0xpc3QucmVtb3ZlKGNzcy5oaWRkZW5hY2Nlc3NpYmxlKTtcbiAgICAgICAgLy8ga2VlcCBvcmlnaW5hbCBpZCB0byByZXBsYWNlIGRhdGEgb24gYXBwbHkgaW1wb3J0XG4gICAgICAgIGltcG9ydHpvbmUuZGF0YXNldC5vcmlnaW4gPSBpbXBvcnR6b25lLmlkO1xuICAgICAgICBpbXBvcnR6b25lLmlkID0gdGhpcy5pbXBvcnRpZDtcbiAgICAgICAgaW1wb3J0em9uZS5uYW1lID0gdGhpcy5pbXBvcnRpZCArICdfJyArIGltcG9ydHpvbmUubmFtZTtcbiAgICAgICAgdGhpcy5pbXBvcnRjb250YWluZXIucHJlcGVuZChpbXBvcnR6b25lKTtcbiAgICAgICAgaWYgKHRzKSB7XG4gICAgICAgICAgSnNUb21TZWxlY3QuYXBwbHlUbyhpbXBvcnR6b25lKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmFjdGl2YXRlQ2xlYXIoKTtcbiAgICAgIH1cblxuICAgIH1cbiAgICByZXR1cm4gaW1wb3J0em9uZTtcblxuICB9XG5cbiAgbWFrZUltcG9ydChidG4sIHNlbGVjdGNlbGxzLCB3aGF0LCBjbG9zZSA9IGZhbHNlKSB7XG4gICAgbGV0IGRvbmUgPSB0cnVlLFxuICAgICAgdHMgPSBudWxsO1xuICAgIGNvbnN0IGltcG9ydHpvbmUgPSAodGhpcy5pbXBvcnRjb250YWluZXIpID8gdGhpcy5pbXBvcnRjb250YWluZXIucXVlcnlTZWxlY3RvcignIycgKyB0aGlzLmltcG9ydGlkKSA6IG51bGw7XG5cbiAgICBzd2l0Y2ggKHdoYXQpIHtcbiAgICAgIGNhc2UgdHlwZWltcG9ydC50YXhvOlxuXG4gICAgICAgIGlmICghaW1wb3J0em9uZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBjb25zdCBpbXBvcnRfdGFyZ2V0ID0gdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJyMnICsgaW1wb3J0em9uZS5kYXRhc2V0Lm9yaWdpbik7XG5cbiAgICAgICAgaWYgKCFpbXBvcnRfdGFyZ2V0KSByZXR1cm4gZmFsc2U7XG4gICAgICAgIHRzID0gaW1wb3J0X3RhcmdldC50b21zZWxlY3Q7XG4gICAgICAgIGlmICh0cykge1xuICAgICAgICAgIC8vIG9ubHkgaWYgcmVwbGFjZSBzcGVjaWZpZWRcbiAgICAgICAgICBpZiAoYnRuLmRhdGFzZXQucmVwbGFjZSAmJiBidG4uZGF0YXNldC5yZXBsYWNlID09PSAncmVwbGFjZScpIHtcbiAgICAgICAgICAgIHRzLmNsZWFyKCk7XG4gICAgICAgICAgICB0cy5jbGVhck9wdGlvbnMoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgdHpvbmUgPSBpbXBvcnR6b25lLnRvbXNlbGVjdDtcbiAgICAgICAgICBjb25zdCBpdGVtcyA9IFsuLi50em9uZS5pdGVtc107XG4gICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIHR6b25lLm9wdGlvbnMpO1xuICAgICAgICAgIGl0ZW1zLmZvckVhY2goKGUsIGkpID0+IHtcbiAgICAgICAgICAgIGxldCBlbCA9IHt9O1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0gPSBlO1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3Muc2VhcmNoRmllbGRdID0gdW5lc2NhcGVfaHRtbChvcHRpb25zW2VdW3RzLnNldHRpbmdzLnNlYXJjaEZpZWxkXSk7XG4gICAgICAgICAgICBpZiAoIXRzLmdldE9wdGlvbihlKSkgdHMuYWRkT3B0aW9uKGVsKTtcbiAgICAgICAgICAgIHRzLmFkZEl0ZW0oZSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgdHpvbmUuY2xlYXIoKTtcbiAgICAgICAgICB0em9uZS5jbGVhck9wdGlvbnMoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAoYnRuLmRhdGFzZXQucmVwbGFjZSAmJiBidG4uZGF0YXNldC5yZXBsYWNlID09PSAncmVwbGFjZScpIGltcG9ydF90YXJnZXQuaW5uZXJIVE1MID0gYGA7XG4gICAgICAgICAgaW1wb3J0X3RhcmdldC5pbm5lckhUTUwgPSBET01QdXJpZnkuc2FuaXRpemUoaW1wb3J0em9uZS5pbm5lckhUTUwpO1xuICAgICAgICAgIGltcG9ydHpvbmUuaW5uZXJIVE1MID0gYGA7XG4gICAgICAgIH1cbiAgICAgICAgZG9uZSA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSB0eXBlaW1wb3J0LnByaXZpbGVnZXM6XG4gICAgICAgIGlmICghaW1wb3J0em9uZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBkb25lID0gdGhpcy5yZW5kZXJQcml2aWxlZ2VzKGltcG9ydHpvbmUsIChidG4uZGF0YXNldC5yZXBsYWNlICYmIGJ0bi5kYXRhc2V0LnJlcGxhY2UgPT09ICdyZXBsYWNlJykpO1xuICAgICAgICBpZiAoaW1wb3J0em9uZS5jdXJyZW50bGlzdCkgaW1wb3J0em9uZS5jdXJyZW50bGlzdCA9IHt9O1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNvbnN0IHRzX2FkZF9zZWxlY3RfaXRlbSA9IGZ1bmN0aW9uKHRzLCBkYXRhKSB7XG4gICAgICAgICAgY29uc3QgZWwgPSB7fTtcbiAgICAgICAgICBpZiAodHlwZW9mKGRhdGEpID09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBlbFt0cy5zZXR0aW5ncy5sYWJlbEZpZWxkXSA9IGRhdGE7XG4gICAgICAgICAgICBlbFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSA9IGRhdGE7XG4gICAgICAgICAgICBlbFt0cy5zZXR0aW5ncy5zZWFyY2hGaWVsZF0gPSB1bmVzY2FwZV9odG1sKGRhdGEpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBlbFt0cy5zZXR0aW5ncy5sYWJlbEZpZWxkXSA9IGRhdGEua2V5O1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0gPSBkYXRhLmtleTtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLnNlYXJjaEZpZWxkXSA9IHVuZXNjYXBlX2h0bWwoZGF0YS52YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghdHMuZ2V0T3B0aW9uKGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdKSkgdHMuYWRkT3B0aW9uKGVsKTtcbiAgICAgICAgICBpZiAoIXRzLmdldEl0ZW0oZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0pKSB0cy5hZGRJdGVtKGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBhZGRfc2VsZWN0X29wdGlvbiA9IGZ1bmN0aW9uKGlucHV0LCBkYXRhKSB7XG4gICAgICAgICAgbGV0IGF0dHIgPSB7XG4gICAgICAgICAgICBzZWxlY3RlZDogdHJ1ZVxuICAgICAgICAgIH07XG4gICAgICAgICAgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIGF0dHIudmFsdWUgPSBhdHRyLnRleHQgPSBkYXRhO1xuICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgYXR0ci52YWx1ZSA9IGRhdGEua2V5O1xuICAgICAgICAgICAgYXR0ci50ZXh0ID0gZGF0YS52YWx1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3Qgb3B0aW9uID0gY3JlYXRlX2JveCgnb3B0aW9uJywgYXR0ciwgaW5wdXQpO1xuXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYWRkX2lucHV0X29wdGlvbiA9IGZ1bmN0aW9uKGlucHV0LCBkYXRhKSB7XG4gICAgICAgICAgaWYgKGlucHV0Lm11bHRpcGxlKSB7XG4gICAgICAgICAgICBsZXQgdmFsdWVzID0gaW5wdXQudmFsdWUuc3BsaXQoJywnKTtcbiAgICAgICAgICAgIHZhbHVlcy5wdXNoKGRhdGEua2V5KTtcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gdmFsdWVzLmpvaW4oJywnKTtcbiAgICAgICAgICB9IGVsc2UgaW5wdXQudmFsdWUgPSBkYXRhO1xuXG4gICAgICAgIH1cbiAgICAgICAgc2VsZWN0Y2VsbHMuZm9yRWFjaCgobmFtZSwgaW5kZXgpID0+IHtcbiAgICAgICAgICBsZXQgaW5wdXQgPSAoKHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbZGF0YS1pbXBvcnRmaWVsZD1cIicgKyBuYW1lICsgJ1wiXScpKSA/IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbZGF0YS1pbXBvcnRmaWVsZD1cIicgKyBuYW1lICsgJ1wiXScpIDogdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lPVwiJyArIG5hbWUgKyAnXCJdJykpO1xuICAgICAgICAgIGlmIChpbnB1dCAmJiBpbnB1dC5kYXRhc2V0Lm5vaW1wb3J0KSByZXR1cm47XG4gICAgICAgICAgaWYgKGlucHV0ICYmIHRoaXMuaW1wb3J0c1tuYW1lXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjb25zdCB0eXBlID0gKGlucHV0LnR5cGUpID8gaW5wdXQudHlwZSA6IGlucHV0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIHRzID0gaW5wdXQudG9tc2VsZWN0O1xuICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdpbml0X2NsYXNzaWZfbGlzdCcpIHtcbiAgICAgICAgICAgICAgbGV0IGlkcyA9IHRoaXMuaW1wb3J0c1tuYW1lXTtcbiAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaWRzKSkgaWRzID0gaWRzLmpvaW4oJywnKTtcbiAgICAgICAgICAgICAgZWxzZSBpZHMgPSBpZHMucmVwbGFjZSgnWycsICcnKS5yZXBsYWNlKCddJywgJycpLnJlcGxhY2VBbGwoJyAnLCAnJyk7XG4gICAgICAgICAgICAgIGlmICh0cykge1xuICAgICAgICAgICAgICAgIHRzLndyYXBwZXIuY2xhc3NMaXN0LmFkZCgnd2FpdC1mb3ItcmVzdWx0cycpO1xuICAgICAgICAgICAgICAgIHRzLmNsZWFyKGZhbHNlKTtcbiAgICAgICAgICAgICAgICB0cy5jbGVhck9wdGlvbnMoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAoaWRzICE9PSAnJykge1xuICAgICAgICAgICAgICAgIGlmICh0cykgdHMud3JhcHBlci5jbGFzc0xpc3QuYWRkKCd3YWl0LWZvci1yZXN1bHRzJyk7XG4gICAgICAgICAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2lkbGlzdCcsIGlkcyk7XG4gICAgICAgICAgICAgICAgY29uc3QgdXJsID0gJy9zZWFyY2gvdGF4b3Jlc29sdmUnIC8vKyBuZXcgVVJMU2VhcmNoUGFyYW1zKHsnaWRsaXN0JzogaWRzfSk7XG4gICAgICAgICAgICAgICAgZmV0Y2godXJsLCBmZXRjaFNldHRpbmdzKHtcbiAgICAgICAgICAgICAgICAgICdtZXRob2QnOiAnUE9TVCcsXG4gICAgICAgICAgICAgICAgICAnYm9keSc6IGZvcm1EYXRhXG4gICAgICAgICAgICAgICAgfSkpLnRoZW4ocmVzcG9uc2UgPT5cbiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmpzb24oKVxuICAgICAgICAgICAgICAgICkudGhlbihyZXN1bHRzID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHRzID0gaW5wdXQudG9tc2VsZWN0O1xuICAgICAgICAgICAgICAgICAgaWYgKHRzKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMocmVzdWx0cykuZm9yRWFjaCgoW2tleSwgdGV4dF0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogRE9NUHVyaWZ5LnNhbml0aXplKGtleSksXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogRE9NUHVyaWZ5LnNhbml0aXplKHRleHQpXG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIHRzX2FkZF9zZWxlY3RfaXRlbSh0cywgZWwpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgdHMud3JhcHBlci5jbGFzc0xpc3QucmVtb3ZlKCd3YWl0LWZvci1yZXN1bHRzJyk7XG4gICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUuaW5kZXhPZignc2VsZWN0JykgPT09IDApIHtcblxuICAgICAgICAgICAgICAgICAgICBpbnB1dC5xdWVyeVNlbGVjdG9yQWxsKCdvcHRpb24nKS5mb3JFYWNoKG9wdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgb3B0aW9uLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMocmVzdWx0cykuZm9yRWFjaCgoW2tleSwgdGV4dF0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogRE9NUHVyaWZ5LnNhbml0aXplKGtleSksXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogRE9NUHVyaWZ5LnNhbml0aXplKHRleHQpXG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIGFkZF9pbnB1dF9vcHRpb24oaW5wdXQsIGVsKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHJlc3VsdHMpLmZvckVhY2goKFtrZXksIHRleHRdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBrZXk6IERPTVB1cmlmeS5zYW5pdGl6ZShrZXkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IERPTVB1cmlmeS5zYW5pdGl6ZSh0ZXh0KVxuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICBhZGRfc2VsZWN0X29wdGlvbihpbnB1dCwgZWwpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICByZXN1bHRzID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW1wb3J0ZWRUYWcoaW5wdXQpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRzKSB7XG4gICAgICAgICAgICAgIHRzX2FkZF9zZWxlY3RfaXRlbSh0cywgdGhpcy5pbXBvcnRzW25hbWVdKTtcbiAgICAgICAgICAgICAgdGhpcy5zZXRJbXBvcnRlZFRhZyhpbnB1dCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdyYWRpbyc6XG4gICAgICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxuICAgICAgICAgICAgICAgICAgaW5wdXQgPSB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9XCInICsgbmFtZSArICdcIl1bdmFsdWU9XCInICsgdGhpcy5pbXBvcnRzW25hbWVdICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgICAgaWYgKGlucHV0KSBpbnB1dC5jaGVja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ3NlbGVjdCc6XG4gICAgICAgICAgICAgICAgICBpZiAoaW5wdXQubXVsdGlwbGUpIHRoaXMuaW1wb3J0c1tuYW1lXS5mb3JFYWNoKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhZGRfc2VsZWN0X29wdGlvbihpbnB1dCwgZGF0YSlcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgZWxzZSBhZGRfc2VsZWN0X29wdGlvbihpbnB1dCwgdGhpcy5pbXBvcnRzW25hbWVdKTtcblxuICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gdGhpcy5pbXBvcnRzW25hbWVdO1xuICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgdGhpcy5zZXRJbXBvcnRlZFRhZyhpbnB1dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAod2hhdCAhPT0gdHlwZWltcG9ydC5zZXR0aW5ncykgaW5wdXQuZm9jdXMoKTtcbiAgICAgICAgICAgIGRvbmUgPSBkb25lICYmIHRydWU7XG4gICAgICAgICAgICAvLyBzZXQgaW1wb3J0ZWQgdGFnIHRvIGZpZWxkYm94XG5cblxuICAgICAgICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gdHlwZWltcG9ydC5wcml2aWxlZ2VzKSB7XG4gICAgICAgICAgICAvL2NvbnN0IGNsZWFycHJpdmlsZWdlcyA9ICh3aGF0ID09PSB0eXBlaW1wb3J0LnNldHRpbmdzKTtcbiAgICAgICAgICAgIGNvbnN0IGNsZWFycHJpdmlsZWdlcyA9IGZhbHNlO1xuICAgICAgICAgICAgZG9uZSA9IGRvbmUgJiYgdGhpcy5pbXBvcnRQcml2aWxlZ2VzKHRoaXMuaW1wb3J0c1tuYW1lXSwgY2xlYXJwcml2aWxlZ2VzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gICAgaWYgKGRvbmUgPT09IHRydWUgJiYgY2xvc2UgPT0gdHJ1ZSkge1xuICAgICAgdGhpcy5kaXNtaXNzKCk7XG4gICAgICBpZiAodGhpcy5mb3JtKSB0aGlzLmZvcm0uZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3ZhbGlkYXRlJykpO1xuICAgIH1cbiAgfVxuXG4gIHNldEltcG9ydGVkVGFnKGlucHV0LCBzZWxlY3RvciA9IGRvbXNlbGVjdG9ycy5jb21wb25lbnQuZm9ybS5mb3JtYm94KSB7XG4gICAgbGV0IGVsID0gKHNlbGVjdG9yID09PSBudWxsKSA/IGlucHV0IDogKGlucHV0LmNsb3Nlc3Qoc2VsZWN0b3IpID8gaW5wdXQuY2xvc2VzdChzZWxlY3RvcikgOiBpbnB1dC5jbG9zZXN0KCdmaWVsZHNldCcpKTtcbiAgICBpZiAoIWVsKSByZXR1cm47XG4gICAgY29uc3QgcmVtb3ZldGFnID0gKGUpID0+IHtcbiAgICAgIGRlbGV0ZSBlbC5kYXRhc2V0LmlzaW1wb3J0ZWQ7XG4gICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKGNzcy5pbXBvcnRlZCk7XG4gICAgICBpbnB1dC5yZW1vdmVFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCByZW1vdmV0YWcpO1xuICAgIH1cbiAgICBlbC5kYXRhc2V0LmlzaW1wb3J0ZWQgPSB0aGlzLmZvcm0uZGF0YXNldC5pc2ltcG9ydGVkO1xuICAgIGVsLmNsYXNzTGlzdC5hZGQoY3NzLmltcG9ydGVkKTtcbiAgICBpZiAoaW5wdXQuZGF0YXNldC51bmlxdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaW5wdXQuZGF0YXNldC51bmlxdWUgPSBpbnB1dC52YWx1ZTtcbiAgICB9XG4gICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHJlbW92ZXRhZyk7XG4gICAgfSwgNTAwKTtcbiAgfVxuXG4gIGRpc21pc3MoY2xlYXIgPSBmYWxzZSkge1xuICAgIGlmICh0aGlzLmJ1dHRvbikgdGhpcy5zaG93SW1wb3J0KGZhbHNlKTtcbiAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmRvbS5jbG9zZXN0KCdkZXRhaWxzJyk7XG4gICAgaWYgKGNvbnRhaW5lcikge1xuICAgICAgY29udGFpbmVyLm9wZW4gPSBmYWxzZTtcbiAgICAgIGlmIChjbGVhciA9PT0gdHJ1ZSkgY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IodGhpcy5jb250ZW50X3NlbGVjdG9yKS5pbm5lckhUTUwgPSBgYDtcbiAgICB9XG5cbiAgfVxuICBpbmRleFRvQ2hlY2soKSB7XG4gICAgLy8gaW5kZXggb2YgY2VsbHMgdG8gY2hlY2sgaWYgZW1wdHkgYW5kIGRpc2FibGUgcm93ICBpbXBvcnQgYnRuXG4gICAgY29uc3QgZ3JpZCA9ICh0aGlzLnRibCkgPyB0aGlzLnRibC5ncmlkIDogbnVsbDtcbiAgICBpZiAoIWdyaWQpIHJldHVybiBbMF07XG4gICAgbGV0IGluZGV4ID0gZ3JpZC5jb2x1bW5zLmZpbmRJbmRleChjb2x1bW4gPT4gKGNvbHVtbi53aGF0ICYmIGNvbHVtbi53aGF0ID09PSB0eXBlaW1wb3J0LnRheG8pKTtcbiAgICBpZiAoaW5kZXggPT09IC0xKSByZXR1cm4gWzBdO1xuICAgIGNvbnN0IHBhcnRzID0gKGdyaWQuY29sdW1uc1tpbmRleF0ucGFydHMpID8gZ3JpZC5jb2x1bW5zW2luZGV4XS5wYXJ0cyA6IG51bGw7XG4gICAgaWYgKHBhcnRzKSB7XG4gICAgICBjb25zdCBpbmRleHRvY2hlY2sgPSBncmlkLmNvbHVtbnMuZmlsdGVyKChjb2x1bW4sIGkpID0+IHtcbiAgICAgICAgaWYgKHBhcnRzLmluZGV4T2YoY29sdW1uLm5hbWUpID49IDApIHJldHVybiBpO1xuICAgICAgfSkubWFwKHYgPT4ge1xuICAgICAgICByZXR1cm4gdi5pbmRleDtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGluZGV4dG9jaGVjaztcbiAgICB9XG5cbiAgfVxuICBhZGRSZXNldEJ1dHRvbigpIHtcbiAgICBpZiAoIXRoaXMudGJsIHx8ICF0aGlzLnRibC5wYXJhbXMuaGFzT3duUHJvcGVydHkoXCJyZXNldFwiKSkgcmV0dXJuO1xuICAgIGxldCByZXNldGJ0biA9IHRoaXMuZG9tLnBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3Rvcihkb21zZWxlY3RvcnMucmVzZXRidXR0b24pO1xuICAgIGlmIChyZXNldGJ0biA9PT0gbnVsbCkge1xuICAgICAgcmVzZXRidG4gPSBjcmVhdGVfYm94KCdhJywge1xuICAgICAgICBjbGFzczogZG9tc2VsZWN0b3JzLnJlc2V0YnV0dG9uLnN1YnN0cigxKSxcbiAgICAgICAgdGV4dDogdGhpcy50YmwucGFyYW1zLnJlc2V0XG4gICAgICB9LCB0aGlzLmRvbS5wYXJlbnRFbGVtZW50LmZpcnN0Q2hpbGQpO1xuICAgICAgLyogIHJlc2V0YnRuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xuICAgICAgICByZXNldGJ0bi5jbGFzc0xpc3QuYWRkKGRvbXNlbGVjdG9ycy5yZXNldGJ1dHRvbi5zdWJzdHIoMSkpO1xuICAgICAgICByZXNldGJ0bi50ZXh0Q29udGVudCA9IHRoaXMudGJsLnBhcmFtcy5yZXNldDtcbiAgICAgICAgdGhpcy5kb20ucGFyZW50RWxlbWVudC5maXJzdENoaWxkLnByZXBlbmQocmVzZXRidG4pOyovXG4gICAgfVxuICAgIHJlc2V0YnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICBjb25zdCBzZWxlY3RvcnMgPSB0aGlzLnNlbGVjdG9ycyA9IHRoaXMuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoJ1snICsgdGhpcy5zZWxlY3RvciArICddIGJ1dHRvbjpkaXNhYmxlZCwgWycgKyB0aGlzLnNlbGVjdG9yICsgJ10gaW5wdXQ6ZGlzYWJsZWQnKTtcbiAgICAgIHNlbGVjdG9ycy5mb3JFYWNoKHNlbGVjdG9yID0+IHtcbiAgICAgICAgc2VsZWN0b3IuZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgY29uc3Qgc2VsID0gc2VsZWN0b3IuY2xvc2VzdCgndHInKS5xdWVyeVNlbGVjdG9yKCcuJyArIGNzcy5zZWxlY3RlZCk7XG4gICAgICAgIGlmIChzZWwpIHNlbC5jbGFzc0xpc3QucmVtb3ZlKGNzcy5zZWxlY3RlZCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICB9XG4gIC8vIHNob3cgLyBoaWRlIGltcG9ydHpvbmUgYW5kIGJ1dHRvbnNcbiAgc2hvd0ltcG9ydChzaG93KSB7XG4gICAgaWYgKCF0aGlzLmJ1dHRvbikgcmV0dXJuO1xuICAgIGlmIChzaG93ID09PSBmYWxzZSkge1xuICAgICAgdGhpcy5idXR0b24uY2xhc3NMaXN0LmFkZChjc3MuaGlkZSk7XG4gICAgICB0aGlzLnJlcGxhY2VidXR0b24uY2xhc3NMaXN0LmFkZChjc3MuaGlkZSk7XG4gICAgICB0aGlzLmltcG9ydGNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKGNzcy5oaWRlKTtcbiAgICAgIGlmICh0aGlzLnRhYmJ1dHRvbikgdGhpcy50YWJidXR0b24uY2xhc3NMaXN0LmFkZChjc3MuaGlkZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGltcG9ydHpvbmUgPSB0aGlzLmltcG9ydGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKCcjJyArIHRoaXMuaW1wb3J0aWQpO1xuICAgICAgaWYgKGltcG9ydHpvbmUpIHtcbiAgICAgICAgLy8gIGNvbnN0IG9mZnNldGggPSBpbXBvcnR6b25lLnRvbXNlbGVjdC5jb250cm9sLm9mZnNldEhlaWdodDtcbiAgICAgICAgLy8gIGNvbnN0IHNjcm9sbGggPSBpbXBvcnR6b25lLnRvbXNlbGVjdC5jb250cm9sLnNjcm9sbEhlaWdodDtcbiAgICAgICAgdGhpcy5idXR0b24uY2xhc3NMaXN0LnJlbW92ZShjc3MuaGlkZSk7XG4gICAgICAgIHRoaXMucmVwbGFjZWJ1dHRvbi5jbGFzc0xpc3QucmVtb3ZlKGNzcy5oaWRlKTtcbiAgICAgICAgdGhpcy5pbXBvcnRjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShjc3MuaGlkZSk7XG4gICAgICAgIHRoaXMuYnV0dG9uLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLnRhYmJ1dHRvbikge1xuICAgICAgICAgIHRoaXMudGFiYnV0dG9uLmNsYXNzTGlzdC5yZW1vdmUoY3NzLmhpZGUpO1xuICAgICAgICAgIGlmIChpbXBvcnR6b25lLnRvbXNlbGVjdCkge1xuICAgICAgICAgICAgdGhpcy50YWJidXR0b24uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICB9IGVsc2UgdGhpcy50YWJidXR0b24uZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gaW1wb3J0em9uZTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgLy8gcmVzaXplIGltcG9ydHpvbmVcbiAgcmVzaXplWm9uZShlKSB7XG4gICAgY29uc3QgZGl2ID0gdGhpcy5pbXBvcnRjb250YWluZXIuY2xvc2VzdChkb21zZWxlY3RvcnMuY29tcG9uZW50LmltcG9ydC56b25laW1wb3J0KTtcbiAgICBpZiAoIWRpdikgcmV0dXJuO1xuICAgIGRpdi5wYXJlbnRFbGVtZW50LmNsYXNzTGlzdC50b2dnbGUoY3NzLnNob3dmdWxsKTtcbiAgICBjb25zdCBpY29uID0gZS5jdXJyZW50VGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJ2knKTtcbiAgICBpZiAoaWNvbikge1xuICAgICAgaWNvbi5jbGFzc0xpc3QudG9nZ2xlKGNzcy5hcnJvd291dCk7XG4gICAgICBpY29uLmNsYXNzTGlzdC50b2dnbGUoY3NzLmFycm93aW4pO1xuICAgIH1cbiAgfVxufSJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///./src/modules/data-import.js\n")}}]);