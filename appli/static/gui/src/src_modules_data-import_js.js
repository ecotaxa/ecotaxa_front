/*! For license information please see src_modules_data-import_js.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["src_modules_data-import_js"],{"./src/modules/data-import.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   DataImport: () => (/* binding */ DataImport)\n/* harmony export */ });\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! dompurify */ \"./node_modules/dompurify/dist/purify.js\");\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(dompurify__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../modules/js-tom-select.js */ \"./src/modules/js-tom-select.js\");\n/* harmony import */ var _modules_project_privileges_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../modules/project-privileges.js */ \"./src/modules/project-privileges.js\");\n/* harmony import */ var _modules_utils_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../modules/utils.js */ \"./src/modules/utils.js\");\n/* harmony import */ var _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../modules/modules-config.js */ \"./src/modules/modules-config.js\");\n\n\n\n\n\nconst key_privileges = Object.keys(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.defined_privileges).reduce(function(result, key) {\n  result[key] = key;\n  return result;\n}, {});\nlet instance;\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported = 'imported';\nclass DataImport {\n  content_selector = '.modal-content';\n  imports = [];\n  taxos = [\"preset\", \"extra\"];\n  importcontainer;\n  importzoneid;\n  importid = 'importzone';\n  selectors;\n  button;\n  clearbutton;\n  replacebutton;\n  tabbutton;\n  tbl = null;\n  constructor(tbl, what = null, selector = null) {\n    if (!tbl) return;\n    // tbl is a TableComponent  ?\n    this.tbl = (typeof(tbl) === 'object') ? tbl : null;\n    // get the table from table component or html table element id\n    this.dom = (this.tbl) ? this.tbl.dom : document.getElementById(tbl);\n    if (!this.dom) return;\n    what = (what) ? dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(what) : (tbl && tbl.params && tbl.params.import) ? tbl.params.import : (this.dom.dataset.import) ? dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(this.dom.dataset.import) : null;\n    if (!instance || instance.doc !== this.dom) {\n      // defaultoptions - keep like that\n      const options = {\n        importcontainer: '#data-import-' + what,\n        btns: '.btns-imports',\n        button: '#add-import-' + what,\n        replacebutton: '#replace-import-' + what,\n        tabbutton: '#tab-import-' + what,\n        selector: 'data-id',\n\n      };\n      this.selector = (selector) ? selector : options.selector;\n      this.importcontainer = options.importcontainer instanceof HTMLElement ? options.importcontainer : document.querySelector(options.importcontainer);\n      this.form = (options.form) ? ((options.form) instanceof HTMLElement ? options.form : document.querySelector(options.form)) : this.dom.closest('form');\n      this.button = options.button instanceof HTMLElement ? options.button : document.querySelector(options.button);\n      this.replacebutton = options.replacebutton instanceof HTMLElement ? options.replacebutton : document.querySelector(options.replacebutton);\n      this.tabbutton = options.tabbutton instanceof HTMLElement ? options.tabbutton : document.querySelector(options.tabbutton);\n      this.init(options);\n      instance = this;\n\n    }\n    return instance;\n  }\n\n  init(options) {\n    // hide importzone\n    this.showImport(false);\n    // remove line of target proj\n    let projid = this.form.querySelector('#' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.projid);\n    if (projid && projid.value) {\n      projid = this.dom.querySelector('[' + this.selector + '=\"' + projid.value + '\"]');\n      if (projid) projid.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n\n    }\n    const indextocheck = this.indexToCheck();\n    this.selectors = this.dom.querySelectorAll('[' + this.selector + '] button, [' + this.selector + '] input');\n    this.selectors.forEach(selector => {\n      // checkbox possible\n      const index = Array.from(selector.parentElement.children).indexOf((selector));\n\n      if (indextocheck && selector.closest('tr').children[indextocheck[index]].innerHTML === '') selector.disabled = true;\n      else {\n        const evt = (selector.tagName.toLowerCase() === 'input') ? 'change' : 'click';\n        const apply_selection = (e) => {\n          e.stopImmediatePropagation();\n          const target = e.currentTarget;\n          target.disabled = true;\n          this.toImport(target.parentElement, index);\n        };\n        selector.removeEventListener(evt, apply_selection, false);\n        selector.addEventListener(evt, apply_selection, false);\n      };\n    });\n    if (this.button) {\n      this.tabbutton.addEventListener('click', (e) => {\n        e.stopImmediatePropagation();\n        this.resizeZone(e);\n      });\n      this.showImport(false);\n    }\n  }\n  columnProperty(name, index, th) {\n    if (this.tbl) return (this.tbl.grid.columns[index].hasOwnProperty(name)) ? this.tbl.grid.columns[index][name] : null;\n    else return (th.dataset[name]) ? th.dataset.name : null;\n  }\n  columnIndex(prop, value) {\n    return Array.from(this.dom.querySelectorAll('thead th')).findIndex(th => (th.dataset[prop] && th.dataset[prop] === value));\n  }\n  gridColumnIndex(prop, value) {\n    if (this.tbl) return this.tbl.grid.columns.findIndex(column => (column.hasOwnProperty(prop) && column[prop] === value));\n    else return this.columnIndex(prop, value);\n  }\n  rowIndex(td, trs) {\n    const ref = (td.parentElement) ? td.parentElement : null;\n    if (!ref) return null;\n    return trs.findIndex(tr => (tr === ref));\n  }\n  toImport(td, whatpart = 0) {\n    const grid = (this.tbl) ? this.tbl.grid : null;\n    const thcells = Array.from(this.dom.querySelectorAll('thead th'));\n    const trs = Array.from(this.dom.querySelectorAll('tbody tr'));\n    const datas = (grid) ? grid.data : trs.map(tr => {\n      return Array.from(tr.childNodes).forEach(cell => {\n        return cell.innerText;\n      });\n    }); // cell values in json  - no parse\n    if (td.tagName.toLowerCase() !== 'td') td = td.closest('td');\n    const rowindex = this.rowIndex(td, trs);\n    if (rowindex === null) return;\n    let showbtns = true;\n    const cellindex = td.cellIndex;\n    const th = thcells[cellindex];\n    const tds = trs[rowindex];\n    const what = this.columnProperty('what', cellindex, th);\n    if (!what) return;\n    const parts = this.columnProperty('parts', cellindex, th);\n    let contact = null;\n    let selectcells = this.columnProperty('selectcells', cellindex, th);\n    selectcells = (selectcells) ? ((parts) ? [parts[whatpart]] : selectcells) : null;\n    if (!selectcells) return;\n    if (what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.settings || what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact] = this.findContact(datas[rowindex]);\n    const importzone = (what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo || what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) ? this.createImportzone(what) : null;\n\n    let ts = null;\n    selectcells.forEach((name, index) => {\n      index = this.gridColumnIndex('name', name);\n      if (index >= 0) {\n        const tdindex = this.columnIndex('name', name);\n        // show import buttons if importzone\n        const cell = (tdindex >= 0) ? trs[rowindex].cells[tdindex] : null;\n        if (cell) cell.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n        const celldata = datas[rowindex][index];\n        const thcell = (tdindex >= 0) ? thcells[tdindex] : null;\n        switch (what) {\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo:\n            // accumulate and show in import win - move the form field in modal win to view the changes and benefit of tom-select component functs...\n            ts = importzone.tomselect;\n            let taxons = celldata;\n            if (taxons) {\n              if (ts) {\n                // merge taxons and options - unique\n                Object.values(ts.options).forEach((opt) => {\n                  let obj = {};\n                  obj[opt[ts.settings.valueField]] = opt[ts.settings.labelField];\n                  if (!taxons[opt[ts.settings.valueField]]) taxons = Object.assign(taxons, obj);\n                });\n                taxons = Object.entries(taxons);\n                // sort taxons\n                taxons.sort((a, b) => {\n                  let x = a[1];\n                  let y = b[1];\n                  return +(x > y) || -(y > x);\n                });\n                ts.clear();\n                ts.clearOptions();\n                // add taxons items\n                taxons.forEach(([key, text]) => {\n                  if (!ts.getItem(key)) {\n                    if (!ts.getOption(key)) {\n                      let obj = {};\n                      obj[ts.settings.valueField] = key;\n                      obj[ts.settings.labelField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(text.trim());\n                      ts.addOption(obj);\n                    }\n                    ts.addItem(key);\n                  }\n                });\n              } else {\n                Object.values(importzone.options).forEach(opt => {\n                  let obj = {};\n                  obj[opt.value] = opt.text;\n                  if (!taxons[opt.value]) taxons = Object.assign(taxons, obj);\n                });\n                taxons = Object.entries(taxons);\n                taxons.sort((a, b) => {\n                  let x = a[1];\n                  let y = b[1];\n                  return +(x > y) || -(y > x);\n                });\n                importzone.innerHTML = ``;\n                taxons.forEach(([key, text]) => {\n                  if (!importzone.querySelector('option[value=\"' + key + '\"]')) importzone.insertAdjacentHTML('beforeend', '<option value=\"' + key + '\" selected>' + text + '</option>');\n                });\n              }\n              showbtns = (taxons.length > 0);\n              taxons = null;\n            }\n\n            break;\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges:\n            const privs = celldata;\n            // set everybody to 'view' if more than one project imported\n            const resetpriv = ((ts && ts.items.length > 0) || (importzone.selectedIndex > 0));\n            if (!importzone.dataset.init) {\n              /*    const optgroups = [];\n                  Object.keys(privs).forEach(priv => {\n                    //  importzone.insertAdjacentHTML('afterbegin', `<optgroup value=\"${priv}\" label=\"${priv}\"></optgroup>`);\n                    optgroups.push({\n                      value: priv,\n                      label: priv\n                    });\n                  });*/\n              const jsTomSelect = new _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__.JsTomSelect();\n              jsTomSelect.applyTo(importzone);\n              importzone.dataset.init = true;\n            }\n            ts = importzone.tomselect;\n\n            Object.entries(privs).forEach(([priv, members]) => {\n              members.sort((a, b) => {\n                return (b.name > a.name);\n              });\n              members.forEach(member => {\n                const newpriv = (resetpriv) ? key_privileges.viewers : priv; // viewer if more than one project imported\n                let opt;\n\n                if (ts) {\n                  opt = ts.items.indexOf(member.id);\n                  if (opt >= 0) {\n                    ts.removeItem(member.id);\n                    ts.removeOption(member.id);\n                  }\n\n                  // addoption && addItem\n                  opt = {\n                    optgroup: newpriv\n                  }\n                  opt[ts.settings.valueField] = member.id;\n                  opt[ts.settings.searchField] = member.name;\n                  opt[ts.settings.labelField] = member.name;\n                  ts.addOption(opt);\n                  ts.addItem(member.id);\n                } else {\n                  opt = importzone.querySelector('option[value=\"' + member.id + '\"]');\n                  if (opt === null) {\n                    opt = document.createElement('option');\n                    opt.value = member.id;\n                    opt.dataset.optgroup = newpriv;\n                    opt.selected = opt.defaultSelected = true;\n                    opt.text = member.name;\n                    importzone.add(opt);\n\n                  } else opt.dataset.optgroup = newpriv;\n                }\n              });\n              importzone.tomselect.refreshOptions(true);\n            });\n\n            showbtns = (((ts) ? ts.items.length : importzone.selectedIndex + 1) > 0);\n\n\n            break;\n          default:\n            this.imports[name] = celldata;\n            if (cell !== null) {\n              if (cell.dataset.autocomplete) {\n                // select elements where key / value in different columns\n                this.imports[name] = {\n                  value: celldata,\n                  key: null\n                };\n                let el = null;\n                thcells.every((t, idx) => {\n                  if (t.dataset.name == thcell.dataset.autocomplete) {\n                    el = idx;\n                    return false;\n                  }\n                  return true;\n                });\n                if (el !== null) {\n                  el = datas[rowindex][el];\n\n                  this.imports[name].key = el;\n                }\n              } else if (cell.dataset.value) this.imports[name] = cell.dataset.value;\n\n            }\n\n            break;\n        }\n      };\n    });\n\n    if (thcells.length) {\n      if (this.button) {\n        this.showImport(showbtns);\n        if (!this.button.dataset.activated && (what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo || what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges)) this.activateButtons(what, selectcells);\n      } else this.makeImport(null, selectcells, what, true);\n    }\n    //\n\n  }\n  messageZone(item) {\n    console.log('itemmessage', item);\n  }\n  activateButtons(what, selectcells) {\n\n    this.button.addEventListener('click', (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      this.makeImport(e.currentTarget, selectcells, what, true);\n\n    });\n    this.replacebutton.addEventListener('click', (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      this.makeImport(e.currentTarget, selectcells, what, true);\n\n    });\n\n    this.button.dataset.activated = true;\n    this.replacebutton.dataset.activated = true;\n  }\n\n  findContact(tds, name = 'contact') {\n    const index = this.gridColumnIndex('name', name);\n    if (index >= 0) return tds[index] ? tds[index] : null;\n\n    return null;\n  }\n\n  renderPrivileges(importzone, replace = false) {\n    let privileges = {};\n    const tzone = importzone.tomselect;\n\n    const pushpriv = (member, priv) => {\n      const obj = {\n        id: member.id,\n        name: member.name,\n        priv: priv\n      }\n      if (privileges[priv]) privileges[priv].push(obj);\n      else privileges[priv] = [obj];\n    }\n\n    if (tzone) {\n      const members = [...tzone.items];\n      const options = Object.assign({}, tzone.options);\n      members.forEach(member => {\n        member = options[member];\n        if (member) pushpriv(member, member.optgroup);\n\n      })\n    } else {\n      importzone.options.forEach(member => {\n        if (member.selected) pushpriv(member, member.dataset.optgroup);\n      })\n    }\n\n    if (this.importPrivileges(privileges, replace)) {\n      if (tzone) {\n        tzone.clear();\n        tzone.clearOptions();\n      } else importzone.innerHTML = ``;\n\n    }\n\n  }\n\n  importPrivileges(privileges, clear = false) {\n    const projectPrivileges = this.form.querySelector('.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.privileges.ident);\n\n    if (projectPrivileges === null || !projectPrivileges.jsprivileges) return;\n    const importedtag = (input) => {\n      this.setImportedTag(input, null);\n    }\n    const dismiss = () => {\n      this.dismiss();\n    }\n    const contact = (clear === true && this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact]) ? this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact] : null;\n    return (projectPrivileges.jsprivileges.importPrivileges(privileges, clear, contact, importedtag, dismiss));\n  }\n\n  resetSelectors() {\n    this.selectors.forEach((selector, i) => {\n      if (selector.disabled) selector.disabled = false;\n    });\n    this.dom.querySelectorAll('td.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected).forEach(td => {\n      td.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n    });\n  }\n\n  activateClear() {\n    const clearbutton = document.getElementById('clear-' + this.importid);\n    if (!clearbutton) return;\n    clearbutton.addEventListener('click', (e) => {\n      e.stopImmediatePropagation();\n      if (!this.importcontainer) return;\n      this.resetSelectors();\n      this.button.disabled = false;\n      this.replacebutton.disabled = false;\n      this.showImport(false);\n    });\n  }\n  createImportzone(name) {\n    this.showImport(true);\n    let importzone = this.importcontainer.querySelector('#' + this.importid);\n\n\n    if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) {\n      if (!importzone) {\n        importzone = document.createElement('select');\n        this.importid = importzone.id = this.importid + '-' + name;\n        importzone.dataset.type = _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.user;\n        importzone.multiple = true;\n        importzone.dataset.priv = true;\n        this.importcontainer.append(importzone);\n\n      }\n    } else {\n      const import_target = (this.form.querySelector('[name=\"' + name + '\"]')) ? this.form.querySelector('[name=\"' + name + '\"]') : this.form.querySelector('[data-importfield=\"' + name + '\"]');\n      const ts = import_target.tomselect;\n\n      if (!importzone) {\n        if (!import_target) return;\n        this.importzoneid = import_target.id;\n        // tomselect ?\n        importzone = import_target.cloneNode();\n        importzone.classList.remove('tomselected');\n        importzone.classList.remove('ts-hidden-accessible');\n        // keep original id to replace data on apply import\n        importzone.dataset.origin = importzone.id;\n        importzone.id = this.importid;\n        importzone.name = this.importid + '_' + importzone.name;\n        this.importcontainer.insertAdjacentHTML('afterbegin', importzone.outerHTML);\n        if (ts) {\n          importzone = this.importcontainer.querySelector('#' + this.importid);\n          const jsTomSelect = new _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__.JsTomSelect();\n          jsTomSelect.applyTo(importzone);\n\n        }\n        this.activateClear();\n\n      }\n    }\n\n    return importzone;\n\n  }\n\n  makeImport(btn, selectcells, what, close = false) {\n    let done = true,\n      ts = null;\n    const importzone = (this.importcontainer) ? this.importcontainer.querySelector('#' + this.importid) : null;\n\n    switch (what) {\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo:\n\n        if (!importzone) return false;\n        const import_target = this.form.querySelector('#' + importzone.dataset.origin);\n\n        if (!import_target) return false;\n        ts = import_target.tomselect;\n        if (ts) {\n          // only if replace specified\n          if (btn.dataset.replace && btn.dataset.replace === 'replace') {\n            ts.clear();\n            ts.clearOptions();\n          }\n\n          const tzone = importzone.tomselect;\n          const items = [...tzone.items];\n          const options = Object.assign({}, tzone.options);\n          items.forEach((e, i) => {\n            let el = {};\n            el[ts.settings.valueField] = e;\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(options[e][ts.settings.searchField]);\n            if (!ts.getOption(e)) ts.addOption(el);\n            ts.addItem(e);\n          });\n          tzone.clear();\n          tzone.clearOptions();\n        } else {\n          if (btn.dataset.replace && btn.dataset.replace === 'replace') import_target.innerHTML = ``;\n          import_target.innerHTML = dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(importzone.innerHTML);\n          importzone.innerHTML = ``;\n\n        }\n\n        done = true;\n        break;\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges:\n        if (!importzone) return false;\n        done = this.renderPrivileges(importzone, (btn.dataset.replace && btn.dataset.replace === 'replace'));\n\n        break;\n      default:\n        const ts_add_select_item = function(ts, data) {\n          const el = {};\n          if (typeof(data) == 'string') {\n            el[ts.settings.labelField] = data;\n            el[ts.settings.valueField] = data;\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data);\n          } else {\n            el[ts.settings.labelField] = data.key;\n            el[ts.settings.valueField] = data.key;\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data.value);\n          }\n          if (!ts.getOption(el[ts.settings.valueField])) ts.addOption(el);\n          if (!ts.getItem(el[ts.settings.valueField])) ts.addItem(el[ts.settings.valueField]);\n        }\n        const add_select_option = function(input, data) {\n          const option = document.createElement('option');\n          if (typeof(data) === 'string') option.value = option.text = data;\n          else {\n            option.value = data.key;\n            option.text = data.value;\n          }\n          option.selected = true;\n          input.append(option);\n        }\n        const add_input_option = function(input, data) {\n          if (input.multiple) {\n            let values = input.value.split(',');\n            values.push(data.key);\n            input.value = values.join(',');\n          } else input.value = data;\n\n        }\n        selectcells.forEach((name, index) => {\n          let input = ((this.form.querySelector('[data-importfield=\"' + name + '\"]')) ? this.form.querySelector('[data-importfield=\"' + name + '\"]') : this.form.querySelector('[name=\"' + name + '\"]'));\n          if (input && input.dataset.noimport) return;\n          if (input && this.imports[name] !== undefined) {\n            const type = (input.type) ? input.type : input.tagName.toLowerCase();\n            ts = input.tomselect;\n            if (name === 'init_classif_list') {\n              let ids = this.imports[name];\n              if (Array.isArray(ids)) ids = ids.join(',');\n              else ids = ids.replace('[', '').replace(']', '').replaceAll(' ', '');\n              if (ts) {\n                ts.wrapper.classList.add('wait-for-results');\n                ts.clear(false);\n                ts.clearOptions();\n              }\n              if (ids !== '') {\n                if (ts) ts.wrapper.classList.add('wait-for-results');\n                const formData = new FormData();\n                formData.append('idlist', ids);\n                const url = '/search/taxoresolve' //+ new URLSearchParams({'idlist': ids});\n                fetch(url, (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.fetchSettings)({\n                  'method': 'POST',\n                  'body': formData\n                })).then(response =>\n                  response.json()\n                ).then(results => {\n                  const ts = input.tomselect;\n                  if (ts) {\n\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      ts_add_select_item(ts, el);\n                    });\n                    ts.wrapper.classList.remove('wait-for-results');\n                  } else if (type.indexOf('select') === 0) {\n\n                    input.querySelectorAll('option').forEach(option => {\n                      option.remove();\n                    });\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      add_input_option(input, el);\n                    });\n\n                  } else {\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      add_select_option(input, el);\n                    });\n\n                  }\n\n                  results = null;\n                  this.setImportedTag(input);\n                });\n              }\n            } else if (ts) {\n              ts_add_select_item(ts, this.imports[name]);\n              this.setImportedTag(input);\n            } else {\n              switch (type) {\n                case 'radio':\n                case 'checkbox':\n                  input = this.form.querySelector('[name=\"' + name + '\"][value=\"' + this.imports[name] + '\"]');\n                  if (input) input.checked = true;\n                  break;\n                case 'select':\n                  if (input.multiple) this.imports[name].forEach(data => {\n                    add_select_option(input, data)\n                  });\n                  else add_select_option(input, this.imports[name]);\n\n                  break;\n                default:\n                  input.value = this.imports[name];\n                  break;\n              }\n              this.setImportedTag(input);\n            }\n            if (what !== _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.settings) input.focus();\n            done = done && true;\n            // set imported tag to fieldbox\n\n\n          } else if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) {\n            //const clearprivileges = (what === typeimport.settings);\n            const clearprivileges = false;\n            done = done && this.importPrivileges(this.imports[name], clearprivileges);\n          }\n        });\n        break;\n    }\n    if (done === true && close == true) {\n      this.dismiss();\n      if (this.form) this.form.dispatchEvent(new CustomEvent('validate'));\n    }\n  }\n\n  setImportedTag(input, selector = _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.form.formbox) {\n    let el = (selector === null) ? input : (input.closest(selector) ? input.closest(selector) : input.closest('fieldset'));\n    if (!el) return;\n    const removetag = (e) => {\n      delete el.dataset.isimported;\n      el.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported);\n      input.removeEventListener('change', removetag);\n    }\n    el.dataset.isimported = this.form.dataset.isimported;\n    el.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported);\n    if (input.dataset.unique !== undefined) {\n      input.dataset.unique = input.value;\n    }\n    setTimeout(function() {\n      input.addEventListener('change', removetag);\n    }, 500);\n  }\n\n  dismiss(clear = false) {\n    if (this.button) this.showImport(false);\n    const container = this.dom.closest('details');\n    if (container) {\n      container.open = false;\n      if (clear === true) container.querySelector(this.content_selector).innerHTML = ``;\n    }\n\n  }\n  indexToCheck() {\n    // index of cells to check if empty and disable row  import btn\n    const grid = (this.tbl) ? this.tbl.grid : null;\n    if (!grid) return [0];\n    let index = grid.columns.findIndex(column => (column.what && column.what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo));\n    if (index === -1) return [0];\n    const parts = (grid.columns[index].parts) ? grid.columns[index].parts : null;\n    if (parts) {\n      const indextocheck = grid.columns.filter((column, i) => {\n        if (parts.indexOf(column.name) >= 0) return i;\n      }).map(v => {\n        return v.index;\n      });\n      return indextocheck;\n    }\n\n  }\n  // show / hide importzone and buttons\n  showImport(show) {\n    if (!this.button) return;\n\n    if (show === false) {\n      this.button.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.replacebutton.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.importcontainer.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.tabbutton.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n\n    } else {\n      this.button.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.replacebutton.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n\n      this.importcontainer.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.button.disabled = false;\n      const importzone = this.importcontainer.querySelector('#' + this.importid);\n      if (importzone) {\n        this.tabbutton.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        if (importzone.tomselect && importzone.tomselect.control.offsetHeight < importzone.tomselect.control.scrollHeight) {\n          this.tabbutton.disabled = false;\n        } else this.tabbutton.disabled = true;\n      }\n    }\n  }\n  // resize importzone\n  resizeZone(e) {\n    const div = this.importcontainer.closest(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.import.zoneimport);\n    if (!div) return;\n    div.parentElement.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.showfull);\n    const icon = e.currentTarget.querySelector('i');\n    if (icon) {\n      icon.classList.toggle('icon-arrow-pointing-out');\n      icon.classList.toggle('icon-arrow-pointing-in');\n    }\n  }\n}//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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Q0FBNkMsb0VBQVk7QUFDekQ7QUFDQSx1Q0FBdUMsMkRBQUc7QUFDMUM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi9zcmMvbW9kdWxlcy9kYXRhLWltcG9ydC5qcz84MGEyIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBET01QdXJpZnkgZnJvbSAnZG9tcHVyaWZ5JztcbmltcG9ydCB7XG4gIEpzVG9tU2VsZWN0XG59IGZyb20gXCIuLi9tb2R1bGVzL2pzLXRvbS1zZWxlY3QuanNcIjtcbmltcG9ydCB7XG4gIFByb2plY3RQcml2aWxlZ2VzXG59IGZyb20gJy4uL21vZHVsZXMvcHJvamVjdC1wcml2aWxlZ2VzLmpzJztcbmltcG9ydCB7XG4gIGZldGNoU2V0dGluZ3MsXG4gIHVuZXNjYXBlX2h0bWxcbn0gZnJvbSAnLi4vbW9kdWxlcy91dGlscy5qcyc7XG5pbXBvcnQge1xuICBtb2RlbHMsXG4gIHR5cGVpbXBvcnQsXG4gIGNzcyxcbiAgZGVmaW5lZF9wcml2aWxlZ2VzLFxuICBkb21zZWxlY3RvcnNcbn0gZnJvbSAnLi4vbW9kdWxlcy9tb2R1bGVzLWNvbmZpZy5qcyc7XG5jb25zdCBrZXlfcHJpdmlsZWdlcyA9IE9iamVjdC5rZXlzKGRlZmluZWRfcHJpdmlsZWdlcykucmVkdWNlKGZ1bmN0aW9uKHJlc3VsdCwga2V5KSB7XG4gIHJlc3VsdFtrZXldID0ga2V5O1xuICByZXR1cm4gcmVzdWx0O1xufSwge30pO1xubGV0IGluc3RhbmNlO1xuY3NzLmltcG9ydGVkID0gJ2ltcG9ydGVkJztcbmV4cG9ydCBjbGFzcyBEYXRhSW1wb3J0IHtcbiAgY29udGVudF9zZWxlY3RvciA9ICcubW9kYWwtY29udGVudCc7XG4gIGltcG9ydHMgPSBbXTtcbiAgdGF4b3MgPSBbXCJwcmVzZXRcIiwgXCJleHRyYVwiXTtcbiAgaW1wb3J0Y29udGFpbmVyO1xuICBpbXBvcnR6b25laWQ7XG4gIGltcG9ydGlkID0gJ2ltcG9ydHpvbmUnO1xuICBzZWxlY3RvcnM7XG4gIGJ1dHRvbjtcbiAgY2xlYXJidXR0b247XG4gIHJlcGxhY2VidXR0b247XG4gIHRhYmJ1dHRvbjtcbiAgdGJsID0gbnVsbDtcbiAgY29uc3RydWN0b3IodGJsLCB3aGF0ID0gbnVsbCwgc2VsZWN0b3IgPSBudWxsKSB7XG4gICAgaWYgKCF0YmwpIHJldHVybjtcbiAgICAvLyB0YmwgaXMgYSBUYWJsZUNvbXBvbmVudCAgP1xuICAgIHRoaXMudGJsID0gKHR5cGVvZih0YmwpID09PSAnb2JqZWN0JykgPyB0YmwgOiBudWxsO1xuICAgIC8vIGdldCB0aGUgdGFibGUgZnJvbSB0YWJsZSBjb21wb25lbnQgb3IgaHRtbCB0YWJsZSBlbGVtZW50IGlkXG4gICAgdGhpcy5kb20gPSAodGhpcy50YmwpID8gdGhpcy50YmwuZG9tIDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGJsKTtcbiAgICBpZiAoIXRoaXMuZG9tKSByZXR1cm47XG4gICAgd2hhdCA9ICh3aGF0KSA/IERPTVB1cmlmeS5zYW5pdGl6ZSh3aGF0KSA6ICh0YmwgJiYgdGJsLnBhcmFtcyAmJiB0YmwucGFyYW1zLmltcG9ydCkgPyB0YmwucGFyYW1zLmltcG9ydCA6ICh0aGlzLmRvbS5kYXRhc2V0LmltcG9ydCkgPyBET01QdXJpZnkuc2FuaXRpemUodGhpcy5kb20uZGF0YXNldC5pbXBvcnQpIDogbnVsbDtcbiAgICBpZiAoIWluc3RhbmNlIHx8IGluc3RhbmNlLmRvYyAhPT0gdGhpcy5kb20pIHtcbiAgICAgIC8vIGRlZmF1bHRvcHRpb25zIC0ga2VlcCBsaWtlIHRoYXRcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgIGltcG9ydGNvbnRhaW5lcjogJyNkYXRhLWltcG9ydC0nICsgd2hhdCxcbiAgICAgICAgYnRuczogJy5idG5zLWltcG9ydHMnLFxuICAgICAgICBidXR0b246ICcjYWRkLWltcG9ydC0nICsgd2hhdCxcbiAgICAgICAgcmVwbGFjZWJ1dHRvbjogJyNyZXBsYWNlLWltcG9ydC0nICsgd2hhdCxcbiAgICAgICAgdGFiYnV0dG9uOiAnI3RhYi1pbXBvcnQtJyArIHdoYXQsXG4gICAgICAgIHNlbGVjdG9yOiAnZGF0YS1pZCcsXG5cbiAgICAgIH07XG4gICAgICB0aGlzLnNlbGVjdG9yID0gKHNlbGVjdG9yKSA/IHNlbGVjdG9yIDogb3B0aW9ucy5zZWxlY3RvcjtcbiAgICAgIHRoaXMuaW1wb3J0Y29udGFpbmVyID0gb3B0aW9ucy5pbXBvcnRjb250YWluZXIgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMuaW1wb3J0Y29udGFpbmVyIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLmltcG9ydGNvbnRhaW5lcik7XG4gICAgICB0aGlzLmZvcm0gPSAob3B0aW9ucy5mb3JtKSA/ICgob3B0aW9ucy5mb3JtKSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ID8gb3B0aW9ucy5mb3JtIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLmZvcm0pKSA6IHRoaXMuZG9tLmNsb3Nlc3QoJ2Zvcm0nKTtcbiAgICAgIHRoaXMuYnV0dG9uID0gb3B0aW9ucy5idXR0b24gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMuYnV0dG9uIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLmJ1dHRvbik7XG4gICAgICB0aGlzLnJlcGxhY2VidXR0b24gPSBvcHRpb25zLnJlcGxhY2VidXR0b24gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMucmVwbGFjZWJ1dHRvbiA6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iob3B0aW9ucy5yZXBsYWNlYnV0dG9uKTtcbiAgICAgIHRoaXMudGFiYnV0dG9uID0gb3B0aW9ucy50YWJidXR0b24gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMudGFiYnV0dG9uIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLnRhYmJ1dHRvbik7XG4gICAgICB0aGlzLmluaXQob3B0aW9ucyk7XG4gICAgICBpbnN0YW5jZSA9IHRoaXM7XG5cbiAgICB9XG4gICAgcmV0dXJuIGluc3RhbmNlO1xuICB9XG5cbiAgaW5pdChvcHRpb25zKSB7XG4gICAgLy8gaGlkZSBpbXBvcnR6b25lXG4gICAgdGhpcy5zaG93SW1wb3J0KGZhbHNlKTtcbiAgICAvLyByZW1vdmUgbGluZSBvZiB0YXJnZXQgcHJvalxuICAgIGxldCBwcm9qaWQgPSB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignIycgKyBkb21zZWxlY3RvcnMucHJvamlkKTtcbiAgICBpZiAocHJvamlkICYmIHByb2ppZC52YWx1ZSkge1xuICAgICAgcHJvamlkID0gdGhpcy5kb20ucXVlcnlTZWxlY3RvcignWycgKyB0aGlzLnNlbGVjdG9yICsgJz1cIicgKyBwcm9qaWQudmFsdWUgKyAnXCJdJyk7XG4gICAgICBpZiAocHJvamlkKSBwcm9qaWQuY2xhc3NMaXN0LmFkZChjc3MuaGlkZSk7XG5cbiAgICB9XG4gICAgY29uc3QgaW5kZXh0b2NoZWNrID0gdGhpcy5pbmRleFRvQ2hlY2soKTtcbiAgICB0aGlzLnNlbGVjdG9ycyA9IHRoaXMuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoJ1snICsgdGhpcy5zZWxlY3RvciArICddIGJ1dHRvbiwgWycgKyB0aGlzLnNlbGVjdG9yICsgJ10gaW5wdXQnKTtcbiAgICB0aGlzLnNlbGVjdG9ycy5mb3JFYWNoKHNlbGVjdG9yID0+IHtcbiAgICAgIC8vIGNoZWNrYm94IHBvc3NpYmxlXG4gICAgICBjb25zdCBpbmRleCA9IEFycmF5LmZyb20oc2VsZWN0b3IucGFyZW50RWxlbWVudC5jaGlsZHJlbikuaW5kZXhPZigoc2VsZWN0b3IpKTtcblxuICAgICAgaWYgKGluZGV4dG9jaGVjayAmJiBzZWxlY3Rvci5jbG9zZXN0KCd0cicpLmNoaWxkcmVuW2luZGV4dG9jaGVja1tpbmRleF1dLmlubmVySFRNTCA9PT0gJycpIHNlbGVjdG9yLmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgIGVsc2Uge1xuICAgICAgICBjb25zdCBldnQgPSAoc2VsZWN0b3IudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnaW5wdXQnKSA/ICdjaGFuZ2UnIDogJ2NsaWNrJztcbiAgICAgICAgY29uc3QgYXBwbHlfc2VsZWN0aW9uID0gKGUpID0+IHtcbiAgICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgICAgICAgIGNvbnN0IHRhcmdldCA9IGUuY3VycmVudFRhcmdldDtcbiAgICAgICAgICB0YXJnZXQuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICAgIHRoaXMudG9JbXBvcnQodGFyZ2V0LnBhcmVudEVsZW1lbnQsIGluZGV4KTtcbiAgICAgICAgfTtcbiAgICAgICAgc2VsZWN0b3IucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnQsIGFwcGx5X3NlbGVjdGlvbiwgZmFsc2UpO1xuICAgICAgICBzZWxlY3Rvci5hZGRFdmVudExpc3RlbmVyKGV2dCwgYXBwbHlfc2VsZWN0aW9uLCBmYWxzZSk7XG4gICAgICB9O1xuICAgIH0pO1xuICAgIGlmICh0aGlzLmJ1dHRvbikge1xuICAgICAgdGhpcy50YWJidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xuICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgICAgICB0aGlzLnJlc2l6ZVpvbmUoZSk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc2hvd0ltcG9ydChmYWxzZSk7XG4gICAgfVxuICB9XG4gIGNvbHVtblByb3BlcnR5KG5hbWUsIGluZGV4LCB0aCkge1xuICAgIGlmICh0aGlzLnRibCkgcmV0dXJuICh0aGlzLnRibC5ncmlkLmNvbHVtbnNbaW5kZXhdLmhhc093blByb3BlcnR5KG5hbWUpKSA/IHRoaXMudGJsLmdyaWQuY29sdW1uc1tpbmRleF1bbmFtZV0gOiBudWxsO1xuICAgIGVsc2UgcmV0dXJuICh0aC5kYXRhc2V0W25hbWVdKSA/IHRoLmRhdGFzZXQubmFtZSA6IG51bGw7XG4gIH1cbiAgY29sdW1uSW5kZXgocHJvcCwgdmFsdWUpIHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCd0aGVhZCB0aCcpKS5maW5kSW5kZXgodGggPT4gKHRoLmRhdGFzZXRbcHJvcF0gJiYgdGguZGF0YXNldFtwcm9wXSA9PT0gdmFsdWUpKTtcbiAgfVxuICBncmlkQ29sdW1uSW5kZXgocHJvcCwgdmFsdWUpIHtcbiAgICBpZiAodGhpcy50YmwpIHJldHVybiB0aGlzLnRibC5ncmlkLmNvbHVtbnMuZmluZEluZGV4KGNvbHVtbiA9PiAoY29sdW1uLmhhc093blByb3BlcnR5KHByb3ApICYmIGNvbHVtbltwcm9wXSA9PT0gdmFsdWUpKTtcbiAgICBlbHNlIHJldHVybiB0aGlzLmNvbHVtbkluZGV4KHByb3AsIHZhbHVlKTtcbiAgfVxuICByb3dJbmRleCh0ZCwgdHJzKSB7XG4gICAgY29uc3QgcmVmID0gKHRkLnBhcmVudEVsZW1lbnQpID8gdGQucGFyZW50RWxlbWVudCA6IG51bGw7XG4gICAgaWYgKCFyZWYpIHJldHVybiBudWxsO1xuICAgIHJldHVybiB0cnMuZmluZEluZGV4KHRyID0+ICh0ciA9PT0gcmVmKSk7XG4gIH1cbiAgdG9JbXBvcnQodGQsIHdoYXRwYXJ0ID0gMCkge1xuICAgIGNvbnN0IGdyaWQgPSAodGhpcy50YmwpID8gdGhpcy50YmwuZ3JpZCA6IG51bGw7XG4gICAgY29uc3QgdGhjZWxscyA9IEFycmF5LmZyb20odGhpcy5kb20ucXVlcnlTZWxlY3RvckFsbCgndGhlYWQgdGgnKSk7XG4gICAgY29uc3QgdHJzID0gQXJyYXkuZnJvbSh0aGlzLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCd0Ym9keSB0cicpKTtcbiAgICBjb25zdCBkYXRhcyA9IChncmlkKSA/IGdyaWQuZGF0YSA6IHRycy5tYXAodHIgPT4ge1xuICAgICAgcmV0dXJuIEFycmF5LmZyb20odHIuY2hpbGROb2RlcykuZm9yRWFjaChjZWxsID0+IHtcbiAgICAgICAgcmV0dXJuIGNlbGwuaW5uZXJUZXh0O1xuICAgICAgfSk7XG4gICAgfSk7IC8vIGNlbGwgdmFsdWVzIGluIGpzb24gIC0gbm8gcGFyc2VcbiAgICBpZiAodGQudGFnTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAndGQnKSB0ZCA9IHRkLmNsb3Nlc3QoJ3RkJyk7XG4gICAgY29uc3Qgcm93aW5kZXggPSB0aGlzLnJvd0luZGV4KHRkLCB0cnMpO1xuICAgIGlmIChyb3dpbmRleCA9PT0gbnVsbCkgcmV0dXJuO1xuICAgIGxldCBzaG93YnRucyA9IHRydWU7XG4gICAgY29uc3QgY2VsbGluZGV4ID0gdGQuY2VsbEluZGV4O1xuICAgIGNvbnN0IHRoID0gdGhjZWxsc1tjZWxsaW5kZXhdO1xuICAgIGNvbnN0IHRkcyA9IHRyc1tyb3dpbmRleF07XG4gICAgY29uc3Qgd2hhdCA9IHRoaXMuY29sdW1uUHJvcGVydHkoJ3doYXQnLCBjZWxsaW5kZXgsIHRoKTtcbiAgICBpZiAoIXdoYXQpIHJldHVybjtcbiAgICBjb25zdCBwYXJ0cyA9IHRoaXMuY29sdW1uUHJvcGVydHkoJ3BhcnRzJywgY2VsbGluZGV4LCB0aCk7XG4gICAgbGV0IGNvbnRhY3QgPSBudWxsO1xuICAgIGxldCBzZWxlY3RjZWxscyA9IHRoaXMuY29sdW1uUHJvcGVydHkoJ3NlbGVjdGNlbGxzJywgY2VsbGluZGV4LCB0aCk7XG4gICAgc2VsZWN0Y2VsbHMgPSAoc2VsZWN0Y2VsbHMpID8gKChwYXJ0cykgPyBbcGFydHNbd2hhdHBhcnRdXSA6IHNlbGVjdGNlbGxzKSA6IG51bGw7XG4gICAgaWYgKCFzZWxlY3RjZWxscykgcmV0dXJuO1xuICAgIGlmICh3aGF0ID09PSB0eXBlaW1wb3J0LnNldHRpbmdzIHx8IHdoYXQgPT09IHR5cGVpbXBvcnQucHJpdmlsZWdlcykgdGhpcy5pbXBvcnRzW21vZGVscy5jb250YWN0XSA9IHRoaXMuZmluZENvbnRhY3QoZGF0YXNbcm93aW5kZXhdKTtcbiAgICBjb25zdCBpbXBvcnR6b25lID0gKHdoYXQgPT09IHR5cGVpbXBvcnQudGF4byB8fCB3aGF0ID09PSB0eXBlaW1wb3J0LnByaXZpbGVnZXMpID8gdGhpcy5jcmVhdGVJbXBvcnR6b25lKHdoYXQpIDogbnVsbDtcblxuICAgIGxldCB0cyA9IG51bGw7XG4gICAgc2VsZWN0Y2VsbHMuZm9yRWFjaCgobmFtZSwgaW5kZXgpID0+IHtcbiAgICAgIGluZGV4ID0gdGhpcy5ncmlkQ29sdW1uSW5kZXgoJ25hbWUnLCBuYW1lKTtcbiAgICAgIGlmIChpbmRleCA+PSAwKSB7XG4gICAgICAgIGNvbnN0IHRkaW5kZXggPSB0aGlzLmNvbHVtbkluZGV4KCduYW1lJywgbmFtZSk7XG4gICAgICAgIC8vIHNob3cgaW1wb3J0IGJ1dHRvbnMgaWYgaW1wb3J0em9uZVxuICAgICAgICBjb25zdCBjZWxsID0gKHRkaW5kZXggPj0gMCkgPyB0cnNbcm93aW5kZXhdLmNlbGxzW3RkaW5kZXhdIDogbnVsbDtcbiAgICAgICAgaWYgKGNlbGwpIGNlbGwuY2xhc3NMaXN0LmFkZChjc3Muc2VsZWN0ZWQpO1xuICAgICAgICBjb25zdCBjZWxsZGF0YSA9IGRhdGFzW3Jvd2luZGV4XVtpbmRleF07XG4gICAgICAgIGNvbnN0IHRoY2VsbCA9ICh0ZGluZGV4ID49IDApID8gdGhjZWxsc1t0ZGluZGV4XSA6IG51bGw7XG4gICAgICAgIHN3aXRjaCAod2hhdCkge1xuICAgICAgICAgIGNhc2UgdHlwZWltcG9ydC50YXhvOlxuICAgICAgICAgICAgLy8gYWNjdW11bGF0ZSBhbmQgc2hvdyBpbiBpbXBvcnQgd2luIC0gbW92ZSB0aGUgZm9ybSBmaWVsZCBpbiBtb2RhbCB3aW4gdG8gdmlldyB0aGUgY2hhbmdlcyBhbmQgYmVuZWZpdCBvZiB0b20tc2VsZWN0IGNvbXBvbmVudCBmdW5jdHMuLi5cbiAgICAgICAgICAgIHRzID0gaW1wb3J0em9uZS50b21zZWxlY3Q7XG4gICAgICAgICAgICBsZXQgdGF4b25zID0gY2VsbGRhdGE7XG4gICAgICAgICAgICBpZiAodGF4b25zKSB7XG4gICAgICAgICAgICAgIGlmICh0cykge1xuICAgICAgICAgICAgICAgIC8vIG1lcmdlIHRheG9ucyBhbmQgb3B0aW9ucyAtIHVuaXF1ZVxuICAgICAgICAgICAgICAgIE9iamVjdC52YWx1ZXModHMub3B0aW9ucykuZm9yRWFjaCgob3B0KSA9PiB7XG4gICAgICAgICAgICAgICAgICBsZXQgb2JqID0ge307XG4gICAgICAgICAgICAgICAgICBvYmpbb3B0W3RzLnNldHRpbmdzLnZhbHVlRmllbGRdXSA9IG9wdFt0cy5zZXR0aW5ncy5sYWJlbEZpZWxkXTtcbiAgICAgICAgICAgICAgICAgIGlmICghdGF4b25zW29wdFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXV0pIHRheG9ucyA9IE9iamVjdC5hc3NpZ24odGF4b25zLCBvYmopO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRheG9ucyA9IE9iamVjdC5lbnRyaWVzKHRheG9ucyk7XG4gICAgICAgICAgICAgICAgLy8gc29ydCB0YXhvbnNcbiAgICAgICAgICAgICAgICB0YXhvbnMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgICAgICAgbGV0IHggPSBhWzFdO1xuICAgICAgICAgICAgICAgICAgbGV0IHkgPSBiWzFdO1xuICAgICAgICAgICAgICAgICAgcmV0dXJuICsoeCA+IHkpIHx8IC0oeSA+IHgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRzLmNsZWFyKCk7XG4gICAgICAgICAgICAgICAgdHMuY2xlYXJPcHRpb25zKCk7XG4gICAgICAgICAgICAgICAgLy8gYWRkIHRheG9ucyBpdGVtc1xuICAgICAgICAgICAgICAgIHRheG9ucy5mb3JFYWNoKChba2V5LCB0ZXh0XSkgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKCF0cy5nZXRJdGVtKGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0cy5nZXRPcHRpb24oa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICAgIGxldCBvYmogPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICBvYmpbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0gPSBrZXk7XG4gICAgICAgICAgICAgICAgICAgICAgb2JqW3RzLnNldHRpbmdzLmxhYmVsRmllbGRdID0gdW5lc2NhcGVfaHRtbCh0ZXh0LnRyaW0oKSk7XG4gICAgICAgICAgICAgICAgICAgICAgdHMuYWRkT3B0aW9uKG9iaik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdHMuYWRkSXRlbShrZXkpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIE9iamVjdC52YWx1ZXMoaW1wb3J0em9uZS5vcHRpb25zKS5mb3JFYWNoKG9wdCA9PiB7XG4gICAgICAgICAgICAgICAgICBsZXQgb2JqID0ge307XG4gICAgICAgICAgICAgICAgICBvYmpbb3B0LnZhbHVlXSA9IG9wdC50ZXh0O1xuICAgICAgICAgICAgICAgICAgaWYgKCF0YXhvbnNbb3B0LnZhbHVlXSkgdGF4b25zID0gT2JqZWN0LmFzc2lnbih0YXhvbnMsIG9iaik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGF4b25zID0gT2JqZWN0LmVudHJpZXModGF4b25zKTtcbiAgICAgICAgICAgICAgICB0YXhvbnMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgICAgICAgbGV0IHggPSBhWzFdO1xuICAgICAgICAgICAgICAgICAgbGV0IHkgPSBiWzFdO1xuICAgICAgICAgICAgICAgICAgcmV0dXJuICsoeCA+IHkpIHx8IC0oeSA+IHgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGltcG9ydHpvbmUuaW5uZXJIVE1MID0gYGA7XG4gICAgICAgICAgICAgICAgdGF4b25zLmZvckVhY2goKFtrZXksIHRleHRdKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoIWltcG9ydHpvbmUucXVlcnlTZWxlY3Rvcignb3B0aW9uW3ZhbHVlPVwiJyArIGtleSArICdcIl0nKSkgaW1wb3J0em9uZS5pbnNlcnRBZGphY2VudEhUTUwoJ2JlZm9yZWVuZCcsICc8b3B0aW9uIHZhbHVlPVwiJyArIGtleSArICdcIiBzZWxlY3RlZD4nICsgdGV4dCArICc8L29wdGlvbj4nKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBzaG93YnRucyA9ICh0YXhvbnMubGVuZ3RoID4gMCk7XG4gICAgICAgICAgICAgIHRheG9ucyA9IG51bGw7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgdHlwZWltcG9ydC5wcml2aWxlZ2VzOlxuICAgICAgICAgICAgY29uc3QgcHJpdnMgPSBjZWxsZGF0YTtcbiAgICAgICAgICAgIC8vIHNldCBldmVyeWJvZHkgdG8gJ3ZpZXcnIGlmIG1vcmUgdGhhbiBvbmUgcHJvamVjdCBpbXBvcnRlZFxuICAgICAgICAgICAgY29uc3QgcmVzZXRwcml2ID0gKCh0cyAmJiB0cy5pdGVtcy5sZW5ndGggPiAwKSB8fCAoaW1wb3J0em9uZS5zZWxlY3RlZEluZGV4ID4gMCkpO1xuICAgICAgICAgICAgaWYgKCFpbXBvcnR6b25lLmRhdGFzZXQuaW5pdCkge1xuICAgICAgICAgICAgICAvKiAgICBjb25zdCBvcHRncm91cHMgPSBbXTtcbiAgICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHByaXZzKS5mb3JFYWNoKHByaXYgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvLyAgaW1wb3J0em9uZS5pbnNlcnRBZGphY2VudEhUTUwoJ2FmdGVyYmVnaW4nLCBgPG9wdGdyb3VwIHZhbHVlPVwiJHtwcml2fVwiIGxhYmVsPVwiJHtwcml2fVwiPjwvb3B0Z3JvdXA+YCk7XG4gICAgICAgICAgICAgICAgICAgIG9wdGdyb3Vwcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcHJpdixcbiAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogcHJpdlxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgIH0pOyovXG4gICAgICAgICAgICAgIGNvbnN0IGpzVG9tU2VsZWN0ID0gbmV3IEpzVG9tU2VsZWN0KCk7XG4gICAgICAgICAgICAgIGpzVG9tU2VsZWN0LmFwcGx5VG8oaW1wb3J0em9uZSk7XG4gICAgICAgICAgICAgIGltcG9ydHpvbmUuZGF0YXNldC5pbml0ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRzID0gaW1wb3J0em9uZS50b21zZWxlY3Q7XG5cbiAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHByaXZzKS5mb3JFYWNoKChbcHJpdiwgbWVtYmVyc10pID0+IHtcbiAgICAgICAgICAgICAgbWVtYmVycy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChiLm5hbWUgPiBhLm5hbWUpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgbWVtYmVycy5mb3JFYWNoKG1lbWJlciA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgbmV3cHJpdiA9IChyZXNldHByaXYpID8ga2V5X3ByaXZpbGVnZXMudmlld2VycyA6IHByaXY7IC8vIHZpZXdlciBpZiBtb3JlIHRoYW4gb25lIHByb2plY3QgaW1wb3J0ZWRcbiAgICAgICAgICAgICAgICBsZXQgb3B0O1xuXG4gICAgICAgICAgICAgICAgaWYgKHRzKSB7XG4gICAgICAgICAgICAgICAgICBvcHQgPSB0cy5pdGVtcy5pbmRleE9mKG1lbWJlci5pZCk7XG4gICAgICAgICAgICAgICAgICBpZiAob3B0ID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdHMucmVtb3ZlSXRlbShtZW1iZXIuaWQpO1xuICAgICAgICAgICAgICAgICAgICB0cy5yZW1vdmVPcHRpb24obWVtYmVyLmlkKTtcbiAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgLy8gYWRkb3B0aW9uICYmIGFkZEl0ZW1cbiAgICAgICAgICAgICAgICAgIG9wdCA9IHtcbiAgICAgICAgICAgICAgICAgICAgb3B0Z3JvdXA6IG5ld3ByaXZcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIG9wdFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSA9IG1lbWJlci5pZDtcbiAgICAgICAgICAgICAgICAgIG9wdFt0cy5zZXR0aW5ncy5zZWFyY2hGaWVsZF0gPSBtZW1iZXIubmFtZTtcbiAgICAgICAgICAgICAgICAgIG9wdFt0cy5zZXR0aW5ncy5sYWJlbEZpZWxkXSA9IG1lbWJlci5uYW1lO1xuICAgICAgICAgICAgICAgICAgdHMuYWRkT3B0aW9uKG9wdCk7XG4gICAgICAgICAgICAgICAgICB0cy5hZGRJdGVtKG1lbWJlci5pZCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgIG9wdCA9IGltcG9ydHpvbmUucXVlcnlTZWxlY3Rvcignb3B0aW9uW3ZhbHVlPVwiJyArIG1lbWJlci5pZCArICdcIl0nKTtcbiAgICAgICAgICAgICAgICAgIGlmIChvcHQgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7XG4gICAgICAgICAgICAgICAgICAgIG9wdC52YWx1ZSA9IG1lbWJlci5pZDtcbiAgICAgICAgICAgICAgICAgICAgb3B0LmRhdGFzZXQub3B0Z3JvdXAgPSBuZXdwcml2O1xuICAgICAgICAgICAgICAgICAgICBvcHQuc2VsZWN0ZWQgPSBvcHQuZGVmYXVsdFNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgb3B0LnRleHQgPSBtZW1iZXIubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgaW1wb3J0em9uZS5hZGQob3B0KTtcblxuICAgICAgICAgICAgICAgICAgfSBlbHNlIG9wdC5kYXRhc2V0Lm9wdGdyb3VwID0gbmV3cHJpdjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBpbXBvcnR6b25lLnRvbXNlbGVjdC5yZWZyZXNoT3B0aW9ucyh0cnVlKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzaG93YnRucyA9ICgoKHRzKSA/IHRzLml0ZW1zLmxlbmd0aCA6IGltcG9ydHpvbmUuc2VsZWN0ZWRJbmRleCArIDEpID4gMCk7XG5cblxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHRoaXMuaW1wb3J0c1tuYW1lXSA9IGNlbGxkYXRhO1xuICAgICAgICAgICAgaWYgKGNlbGwgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgaWYgKGNlbGwuZGF0YXNldC5hdXRvY29tcGxldGUpIHtcbiAgICAgICAgICAgICAgICAvLyBzZWxlY3QgZWxlbWVudHMgd2hlcmUga2V5IC8gdmFsdWUgaW4gZGlmZmVyZW50IGNvbHVtbnNcbiAgICAgICAgICAgICAgICB0aGlzLmltcG9ydHNbbmFtZV0gPSB7XG4gICAgICAgICAgICAgICAgICB2YWx1ZTogY2VsbGRhdGEsXG4gICAgICAgICAgICAgICAgICBrZXk6IG51bGxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGxldCBlbCA9IG51bGw7XG4gICAgICAgICAgICAgICAgdGhjZWxscy5ldmVyeSgodCwgaWR4KSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAodC5kYXRhc2V0Lm5hbWUgPT0gdGhjZWxsLmRhdGFzZXQuYXV0b2NvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIGVsID0gaWR4O1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAoZWwgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgIGVsID0gZGF0YXNbcm93aW5kZXhdW2VsXTtcblxuICAgICAgICAgICAgICAgICAgdGhpcy5pbXBvcnRzW25hbWVdLmtleSA9IGVsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChjZWxsLmRhdGFzZXQudmFsdWUpIHRoaXMuaW1wb3J0c1tuYW1lXSA9IGNlbGwuZGF0YXNldC52YWx1ZTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9KTtcblxuICAgIGlmICh0aGNlbGxzLmxlbmd0aCkge1xuICAgICAgaWYgKHRoaXMuYnV0dG9uKSB7XG4gICAgICAgIHRoaXMuc2hvd0ltcG9ydChzaG93YnRucyk7XG4gICAgICAgIGlmICghdGhpcy5idXR0b24uZGF0YXNldC5hY3RpdmF0ZWQgJiYgKHdoYXQgPT09IHR5cGVpbXBvcnQudGF4byB8fCB3aGF0ID09PSB0eXBlaW1wb3J0LnByaXZpbGVnZXMpKSB0aGlzLmFjdGl2YXRlQnV0dG9ucyh3aGF0LCBzZWxlY3RjZWxscyk7XG4gICAgICB9IGVsc2UgdGhpcy5tYWtlSW1wb3J0KG51bGwsIHNlbGVjdGNlbGxzLCB3aGF0LCB0cnVlKTtcbiAgICB9XG4gICAgLy9cblxuICB9XG4gIG1lc3NhZ2Vab25lKGl0ZW0pIHtcbiAgICBjb25zb2xlLmxvZygnaXRlbW1lc3NhZ2UnLCBpdGVtKTtcbiAgfVxuICBhY3RpdmF0ZUJ1dHRvbnMod2hhdCwgc2VsZWN0Y2VsbHMpIHtcblxuICAgIHRoaXMuYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB0aGlzLm1ha2VJbXBvcnQoZS5jdXJyZW50VGFyZ2V0LCBzZWxlY3RjZWxscywgd2hhdCwgdHJ1ZSk7XG5cbiAgICB9KTtcbiAgICB0aGlzLnJlcGxhY2VidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xuICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIHRoaXMubWFrZUltcG9ydChlLmN1cnJlbnRUYXJnZXQsIHNlbGVjdGNlbGxzLCB3aGF0LCB0cnVlKTtcblxuICAgIH0pO1xuXG4gICAgdGhpcy5idXR0b24uZGF0YXNldC5hY3RpdmF0ZWQgPSB0cnVlO1xuICAgIHRoaXMucmVwbGFjZWJ1dHRvbi5kYXRhc2V0LmFjdGl2YXRlZCA9IHRydWU7XG4gIH1cblxuICBmaW5kQ29udGFjdCh0ZHMsIG5hbWUgPSAnY29udGFjdCcpIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZ3JpZENvbHVtbkluZGV4KCduYW1lJywgbmFtZSk7XG4gICAgaWYgKGluZGV4ID49IDApIHJldHVybiB0ZHNbaW5kZXhdID8gdGRzW2luZGV4XSA6IG51bGw7XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHJlbmRlclByaXZpbGVnZXMoaW1wb3J0em9uZSwgcmVwbGFjZSA9IGZhbHNlKSB7XG4gICAgbGV0IHByaXZpbGVnZXMgPSB7fTtcbiAgICBjb25zdCB0em9uZSA9IGltcG9ydHpvbmUudG9tc2VsZWN0O1xuXG4gICAgY29uc3QgcHVzaHByaXYgPSAobWVtYmVyLCBwcml2KSA9PiB7XG4gICAgICBjb25zdCBvYmogPSB7XG4gICAgICAgIGlkOiBtZW1iZXIuaWQsXG4gICAgICAgIG5hbWU6IG1lbWJlci5uYW1lLFxuICAgICAgICBwcml2OiBwcml2XG4gICAgICB9XG4gICAgICBpZiAocHJpdmlsZWdlc1twcml2XSkgcHJpdmlsZWdlc1twcml2XS5wdXNoKG9iaik7XG4gICAgICBlbHNlIHByaXZpbGVnZXNbcHJpdl0gPSBbb2JqXTtcbiAgICB9XG5cbiAgICBpZiAodHpvbmUpIHtcbiAgICAgIGNvbnN0IG1lbWJlcnMgPSBbLi4udHpvbmUuaXRlbXNdO1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIHR6b25lLm9wdGlvbnMpO1xuICAgICAgbWVtYmVycy5mb3JFYWNoKG1lbWJlciA9PiB7XG4gICAgICAgIG1lbWJlciA9IG9wdGlvbnNbbWVtYmVyXTtcbiAgICAgICAgaWYgKG1lbWJlcikgcHVzaHByaXYobWVtYmVyLCBtZW1iZXIub3B0Z3JvdXApO1xuXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBpbXBvcnR6b25lLm9wdGlvbnMuZm9yRWFjaChtZW1iZXIgPT4ge1xuICAgICAgICBpZiAobWVtYmVyLnNlbGVjdGVkKSBwdXNocHJpdihtZW1iZXIsIG1lbWJlci5kYXRhc2V0Lm9wdGdyb3VwKTtcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaW1wb3J0UHJpdmlsZWdlcyhwcml2aWxlZ2VzLCByZXBsYWNlKSkge1xuICAgICAgaWYgKHR6b25lKSB7XG4gICAgICAgIHR6b25lLmNsZWFyKCk7XG4gICAgICAgIHR6b25lLmNsZWFyT3B0aW9ucygpO1xuICAgICAgfSBlbHNlIGltcG9ydHpvbmUuaW5uZXJIVE1MID0gYGA7XG5cbiAgICB9XG5cbiAgfVxuXG4gIGltcG9ydFByaXZpbGVnZXMocHJpdmlsZWdlcywgY2xlYXIgPSBmYWxzZSkge1xuICAgIGNvbnN0IHByb2plY3RQcml2aWxlZ2VzID0gdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJy4nICsgZG9tc2VsZWN0b3JzLmNvbXBvbmVudC5wcml2aWxlZ2VzLmlkZW50KTtcblxuICAgIGlmIChwcm9qZWN0UHJpdmlsZWdlcyA9PT0gbnVsbCB8fCAhcHJvamVjdFByaXZpbGVnZXMuanNwcml2aWxlZ2VzKSByZXR1cm47XG4gICAgY29uc3QgaW1wb3J0ZWR0YWcgPSAoaW5wdXQpID0+IHtcbiAgICAgIHRoaXMuc2V0SW1wb3J0ZWRUYWcoaW5wdXQsIG51bGwpO1xuICAgIH1cbiAgICBjb25zdCBkaXNtaXNzID0gKCkgPT4ge1xuICAgICAgdGhpcy5kaXNtaXNzKCk7XG4gICAgfVxuICAgIGNvbnN0IGNvbnRhY3QgPSAoY2xlYXIgPT09IHRydWUgJiYgdGhpcy5pbXBvcnRzW21vZGVscy5jb250YWN0XSkgPyB0aGlzLmltcG9ydHNbbW9kZWxzLmNvbnRhY3RdIDogbnVsbDtcbiAgICByZXR1cm4gKHByb2plY3RQcml2aWxlZ2VzLmpzcHJpdmlsZWdlcy5pbXBvcnRQcml2aWxlZ2VzKHByaXZpbGVnZXMsIGNsZWFyLCBjb250YWN0LCBpbXBvcnRlZHRhZywgZGlzbWlzcykpO1xuICB9XG5cbiAgcmVzZXRTZWxlY3RvcnMoKSB7XG4gICAgdGhpcy5zZWxlY3RvcnMuZm9yRWFjaCgoc2VsZWN0b3IsIGkpID0+IHtcbiAgICAgIGlmIChzZWxlY3Rvci5kaXNhYmxlZCkgc2VsZWN0b3IuZGlzYWJsZWQgPSBmYWxzZTtcbiAgICB9KTtcbiAgICB0aGlzLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCd0ZC4nICsgY3NzLnNlbGVjdGVkKS5mb3JFYWNoKHRkID0+IHtcbiAgICAgIHRkLmNsYXNzTGlzdC5yZW1vdmUoY3NzLnNlbGVjdGVkKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFjdGl2YXRlQ2xlYXIoKSB7XG4gICAgY29uc3QgY2xlYXJidXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2xlYXItJyArIHRoaXMuaW1wb3J0aWQpO1xuICAgIGlmICghY2xlYXJidXR0b24pIHJldHVybjtcbiAgICBjbGVhcmJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgICAgaWYgKCF0aGlzLmltcG9ydGNvbnRhaW5lcikgcmV0dXJuO1xuICAgICAgdGhpcy5yZXNldFNlbGVjdG9ycygpO1xuICAgICAgdGhpcy5idXR0b24uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMucmVwbGFjZWJ1dHRvbi5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5zaG93SW1wb3J0KGZhbHNlKTtcbiAgICB9KTtcbiAgfVxuICBjcmVhdGVJbXBvcnR6b25lKG5hbWUpIHtcbiAgICB0aGlzLnNob3dJbXBvcnQodHJ1ZSk7XG4gICAgbGV0IGltcG9ydHpvbmUgPSB0aGlzLmltcG9ydGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKCcjJyArIHRoaXMuaW1wb3J0aWQpO1xuXG5cbiAgICBpZiAobmFtZSA9PT0gdHlwZWltcG9ydC5wcml2aWxlZ2VzKSB7XG4gICAgICBpZiAoIWltcG9ydHpvbmUpIHtcbiAgICAgICAgaW1wb3J0em9uZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NlbGVjdCcpO1xuICAgICAgICB0aGlzLmltcG9ydGlkID0gaW1wb3J0em9uZS5pZCA9IHRoaXMuaW1wb3J0aWQgKyAnLScgKyBuYW1lO1xuICAgICAgICBpbXBvcnR6b25lLmRhdGFzZXQudHlwZSA9IG1vZGVscy51c2VyO1xuICAgICAgICBpbXBvcnR6b25lLm11bHRpcGxlID0gdHJ1ZTtcbiAgICAgICAgaW1wb3J0em9uZS5kYXRhc2V0LnByaXYgPSB0cnVlO1xuICAgICAgICB0aGlzLmltcG9ydGNvbnRhaW5lci5hcHBlbmQoaW1wb3J0em9uZSk7XG5cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgaW1wb3J0X3RhcmdldCA9ICh0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9XCInICsgbmFtZSArICdcIl0nKSkgPyB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9XCInICsgbmFtZSArICdcIl0nKSA6IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbZGF0YS1pbXBvcnRmaWVsZD1cIicgKyBuYW1lICsgJ1wiXScpO1xuICAgICAgY29uc3QgdHMgPSBpbXBvcnRfdGFyZ2V0LnRvbXNlbGVjdDtcblxuICAgICAgaWYgKCFpbXBvcnR6b25lKSB7XG4gICAgICAgIGlmICghaW1wb3J0X3RhcmdldCkgcmV0dXJuO1xuICAgICAgICB0aGlzLmltcG9ydHpvbmVpZCA9IGltcG9ydF90YXJnZXQuaWQ7XG4gICAgICAgIC8vIHRvbXNlbGVjdCA/XG4gICAgICAgIGltcG9ydHpvbmUgPSBpbXBvcnRfdGFyZ2V0LmNsb25lTm9kZSgpO1xuICAgICAgICBpbXBvcnR6b25lLmNsYXNzTGlzdC5yZW1vdmUoJ3RvbXNlbGVjdGVkJyk7XG4gICAgICAgIGltcG9ydHpvbmUuY2xhc3NMaXN0LnJlbW92ZSgndHMtaGlkZGVuLWFjY2Vzc2libGUnKTtcbiAgICAgICAgLy8ga2VlcCBvcmlnaW5hbCBpZCB0byByZXBsYWNlIGRhdGEgb24gYXBwbHkgaW1wb3J0XG4gICAgICAgIGltcG9ydHpvbmUuZGF0YXNldC5vcmlnaW4gPSBpbXBvcnR6b25lLmlkO1xuICAgICAgICBpbXBvcnR6b25lLmlkID0gdGhpcy5pbXBvcnRpZDtcbiAgICAgICAgaW1wb3J0em9uZS5uYW1lID0gdGhpcy5pbXBvcnRpZCArICdfJyArIGltcG9ydHpvbmUubmFtZTtcbiAgICAgICAgdGhpcy5pbXBvcnRjb250YWluZXIuaW5zZXJ0QWRqYWNlbnRIVE1MKCdhZnRlcmJlZ2luJywgaW1wb3J0em9uZS5vdXRlckhUTUwpO1xuICAgICAgICBpZiAodHMpIHtcbiAgICAgICAgICBpbXBvcnR6b25lID0gdGhpcy5pbXBvcnRjb250YWluZXIucXVlcnlTZWxlY3RvcignIycgKyB0aGlzLmltcG9ydGlkKTtcbiAgICAgICAgICBjb25zdCBqc1RvbVNlbGVjdCA9IG5ldyBKc1RvbVNlbGVjdCgpO1xuICAgICAgICAgIGpzVG9tU2VsZWN0LmFwcGx5VG8oaW1wb3J0em9uZSk7XG5cbiAgICAgICAgfVxuICAgICAgICB0aGlzLmFjdGl2YXRlQ2xlYXIoKTtcblxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBpbXBvcnR6b25lO1xuXG4gIH1cblxuICBtYWtlSW1wb3J0KGJ0biwgc2VsZWN0Y2VsbHMsIHdoYXQsIGNsb3NlID0gZmFsc2UpIHtcbiAgICBsZXQgZG9uZSA9IHRydWUsXG4gICAgICB0cyA9IG51bGw7XG4gICAgY29uc3QgaW1wb3J0em9uZSA9ICh0aGlzLmltcG9ydGNvbnRhaW5lcikgPyB0aGlzLmltcG9ydGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKCcjJyArIHRoaXMuaW1wb3J0aWQpIDogbnVsbDtcblxuICAgIHN3aXRjaCAod2hhdCkge1xuICAgICAgY2FzZSB0eXBlaW1wb3J0LnRheG86XG5cbiAgICAgICAgaWYgKCFpbXBvcnR6b25lKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGNvbnN0IGltcG9ydF90YXJnZXQgPSB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignIycgKyBpbXBvcnR6b25lLmRhdGFzZXQub3JpZ2luKTtcblxuICAgICAgICBpZiAoIWltcG9ydF90YXJnZXQpIHJldHVybiBmYWxzZTtcbiAgICAgICAgdHMgPSBpbXBvcnRfdGFyZ2V0LnRvbXNlbGVjdDtcbiAgICAgICAgaWYgKHRzKSB7XG4gICAgICAgICAgLy8gb25seSBpZiByZXBsYWNlIHNwZWNpZmllZFxuICAgICAgICAgIGlmIChidG4uZGF0YXNldC5yZXBsYWNlICYmIGJ0bi5kYXRhc2V0LnJlcGxhY2UgPT09ICdyZXBsYWNlJykge1xuICAgICAgICAgICAgdHMuY2xlYXIoKTtcbiAgICAgICAgICAgIHRzLmNsZWFyT3B0aW9ucygpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IHR6b25lID0gaW1wb3J0em9uZS50b21zZWxlY3Q7XG4gICAgICAgICAgY29uc3QgaXRlbXMgPSBbLi4udHpvbmUuaXRlbXNdO1xuICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCB0em9uZS5vcHRpb25zKTtcbiAgICAgICAgICBpdGVtcy5mb3JFYWNoKChlLCBpKSA9PiB7XG4gICAgICAgICAgICBsZXQgZWwgPSB7fTtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdID0gZTtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLnNlYXJjaEZpZWxkXSA9IHVuZXNjYXBlX2h0bWwob3B0aW9uc1tlXVt0cy5zZXR0aW5ncy5zZWFyY2hGaWVsZF0pO1xuICAgICAgICAgICAgaWYgKCF0cy5nZXRPcHRpb24oZSkpIHRzLmFkZE9wdGlvbihlbCk7XG4gICAgICAgICAgICB0cy5hZGRJdGVtKGUpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHR6b25lLmNsZWFyKCk7XG4gICAgICAgICAgdHpvbmUuY2xlYXJPcHRpb25zKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGJ0bi5kYXRhc2V0LnJlcGxhY2UgJiYgYnRuLmRhdGFzZXQucmVwbGFjZSA9PT0gJ3JlcGxhY2UnKSBpbXBvcnRfdGFyZ2V0LmlubmVySFRNTCA9IGBgO1xuICAgICAgICAgIGltcG9ydF90YXJnZXQuaW5uZXJIVE1MID0gRE9NUHVyaWZ5LnNhbml0aXplKGltcG9ydHpvbmUuaW5uZXJIVE1MKTtcbiAgICAgICAgICBpbXBvcnR6b25lLmlubmVySFRNTCA9IGBgO1xuXG4gICAgICAgIH1cblxuICAgICAgICBkb25lID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHR5cGVpbXBvcnQucHJpdmlsZWdlczpcbiAgICAgICAgaWYgKCFpbXBvcnR6b25lKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGRvbmUgPSB0aGlzLnJlbmRlclByaXZpbGVnZXMoaW1wb3J0em9uZSwgKGJ0bi5kYXRhc2V0LnJlcGxhY2UgJiYgYnRuLmRhdGFzZXQucmVwbGFjZSA9PT0gJ3JlcGxhY2UnKSk7XG5cbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb25zdCB0c19hZGRfc2VsZWN0X2l0ZW0gPSBmdW5jdGlvbih0cywgZGF0YSkge1xuICAgICAgICAgIGNvbnN0IGVsID0ge307XG4gICAgICAgICAgaWYgKHR5cGVvZihkYXRhKSA9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSBkYXRhO1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0gPSBkYXRhO1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3Muc2VhcmNoRmllbGRdID0gdW5lc2NhcGVfaHRtbChkYXRhKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSBkYXRhLmtleTtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdID0gZGF0YS5rZXk7XG4gICAgICAgICAgICBlbFt0cy5zZXR0aW5ncy5zZWFyY2hGaWVsZF0gPSB1bmVzY2FwZV9odG1sKGRhdGEudmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoIXRzLmdldE9wdGlvbihlbFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSkpIHRzLmFkZE9wdGlvbihlbCk7XG4gICAgICAgICAgaWYgKCF0cy5nZXRJdGVtKGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdKSkgdHMuYWRkSXRlbShlbFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYWRkX3NlbGVjdF9vcHRpb24gPSBmdW5jdGlvbihpbnB1dCwgZGF0YSkge1xuICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xuICAgICAgICAgIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSBvcHRpb24udmFsdWUgPSBvcHRpb24udGV4dCA9IGRhdGE7XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBvcHRpb24udmFsdWUgPSBkYXRhLmtleTtcbiAgICAgICAgICAgIG9wdGlvbi50ZXh0ID0gZGF0YS52YWx1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICBpbnB1dC5hcHBlbmQob3B0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBhZGRfaW5wdXRfb3B0aW9uID0gZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHtcbiAgICAgICAgICBpZiAoaW5wdXQubXVsdGlwbGUpIHtcbiAgICAgICAgICAgIGxldCB2YWx1ZXMgPSBpbnB1dC52YWx1ZS5zcGxpdCgnLCcpO1xuICAgICAgICAgICAgdmFsdWVzLnB1c2goZGF0YS5rZXkpO1xuICAgICAgICAgICAgaW5wdXQudmFsdWUgPSB2YWx1ZXMuam9pbignLCcpO1xuICAgICAgICAgIH0gZWxzZSBpbnB1dC52YWx1ZSA9IGRhdGE7XG5cbiAgICAgICAgfVxuICAgICAgICBzZWxlY3RjZWxscy5mb3JFYWNoKChuYW1lLCBpbmRleCkgPT4ge1xuICAgICAgICAgIGxldCBpbnB1dCA9ICgodGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWltcG9ydGZpZWxkPVwiJyArIG5hbWUgKyAnXCJdJykpID8gdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWltcG9ydGZpZWxkPVwiJyArIG5hbWUgKyAnXCJdJykgOiB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9XCInICsgbmFtZSArICdcIl0nKSk7XG4gICAgICAgICAgaWYgKGlucHV0ICYmIGlucHV0LmRhdGFzZXQubm9pbXBvcnQpIHJldHVybjtcbiAgICAgICAgICBpZiAoaW5wdXQgJiYgdGhpcy5pbXBvcnRzW25hbWVdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSAoaW5wdXQudHlwZSkgPyBpbnB1dC50eXBlIDogaW5wdXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgdHMgPSBpbnB1dC50b21zZWxlY3Q7XG4gICAgICAgICAgICBpZiAobmFtZSA9PT0gJ2luaXRfY2xhc3NpZl9saXN0Jykge1xuICAgICAgICAgICAgICBsZXQgaWRzID0gdGhpcy5pbXBvcnRzW25hbWVdO1xuICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShpZHMpKSBpZHMgPSBpZHMuam9pbignLCcpO1xuICAgICAgICAgICAgICBlbHNlIGlkcyA9IGlkcy5yZXBsYWNlKCdbJywgJycpLnJlcGxhY2UoJ10nLCAnJykucmVwbGFjZUFsbCgnICcsICcnKTtcbiAgICAgICAgICAgICAgaWYgKHRzKSB7XG4gICAgICAgICAgICAgICAgdHMud3JhcHBlci5jbGFzc0xpc3QuYWRkKCd3YWl0LWZvci1yZXN1bHRzJyk7XG4gICAgICAgICAgICAgICAgdHMuY2xlYXIoZmFsc2UpO1xuICAgICAgICAgICAgICAgIHRzLmNsZWFyT3B0aW9ucygpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChpZHMgIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRzKSB0cy53cmFwcGVyLmNsYXNzTGlzdC5hZGQoJ3dhaXQtZm9yLXJlc3VsdHMnKTtcbiAgICAgICAgICAgICAgICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnaWRsaXN0JywgaWRzKTtcbiAgICAgICAgICAgICAgICBjb25zdCB1cmwgPSAnL3NlYXJjaC90YXhvcmVzb2x2ZScgLy8rIG5ldyBVUkxTZWFyY2hQYXJhbXMoeydpZGxpc3QnOiBpZHN9KTtcbiAgICAgICAgICAgICAgICBmZXRjaCh1cmwsIGZldGNoU2V0dGluZ3Moe1xuICAgICAgICAgICAgICAgICAgJ21ldGhvZCc6ICdQT1NUJyxcbiAgICAgICAgICAgICAgICAgICdib2R5JzogZm9ybURhdGFcbiAgICAgICAgICAgICAgICB9KSkudGhlbihyZXNwb25zZSA9PlxuICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuanNvbigpXG4gICAgICAgICAgICAgICAgKS50aGVuKHJlc3VsdHMgPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc3QgdHMgPSBpbnB1dC50b21zZWxlY3Q7XG4gICAgICAgICAgICAgICAgICBpZiAodHMpIHtcblxuICAgICAgICAgICAgICAgICAgICBPYmplY3QuZW50cmllcyhyZXN1bHRzKS5mb3JFYWNoKChba2V5LCB0ZXh0XSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBET01QdXJpZnkuc2FuaXRpemUoa2V5KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBET01QdXJpZnkuc2FuaXRpemUodGV4dClcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgdHNfYWRkX3NlbGVjdF9pdGVtKHRzLCBlbCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB0cy53cmFwcGVyLmNsYXNzTGlzdC5yZW1vdmUoJ3dhaXQtZm9yLXJlc3VsdHMnKTtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS5pbmRleE9mKCdzZWxlY3QnKSA9PT0gMCkge1xuXG4gICAgICAgICAgICAgICAgICAgIGlucHV0LnF1ZXJ5U2VsZWN0b3JBbGwoJ29wdGlvbicpLmZvckVhY2gob3B0aW9uID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICBvcHRpb24ucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBPYmplY3QuZW50cmllcyhyZXN1bHRzKS5mb3JFYWNoKChba2V5LCB0ZXh0XSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBET01QdXJpZnkuc2FuaXRpemUoa2V5KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBET01QdXJpZnkuc2FuaXRpemUodGV4dClcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgYWRkX2lucHV0X29wdGlvbihpbnB1dCwgZWwpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMocmVzdWx0cykuZm9yRWFjaCgoW2tleSwgdGV4dF0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogRE9NUHVyaWZ5LnNhbml0aXplKGtleSksXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogRE9NUHVyaWZ5LnNhbml0aXplKHRleHQpXG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIGFkZF9zZWxlY3Rfb3B0aW9uKGlucHV0LCBlbCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgIHJlc3VsdHMgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbXBvcnRlZFRhZyhpbnB1dCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHMpIHtcbiAgICAgICAgICAgICAgdHNfYWRkX3NlbGVjdF9pdGVtKHRzLCB0aGlzLmltcG9ydHNbbmFtZV0pO1xuICAgICAgICAgICAgICB0aGlzLnNldEltcG9ydGVkVGFnKGlucHV0KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ3JhZGlvJzpcbiAgICAgICAgICAgICAgICBjYXNlICdjaGVja2JveCc6XG4gICAgICAgICAgICAgICAgICBpbnB1dCA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbbmFtZT1cIicgKyBuYW1lICsgJ1wiXVt2YWx1ZT1cIicgKyB0aGlzLmltcG9ydHNbbmFtZV0gKyAnXCJdJyk7XG4gICAgICAgICAgICAgICAgICBpZiAoaW5wdXQpIGlucHV0LmNoZWNrZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzpcbiAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC5tdWx0aXBsZSkgdGhpcy5pbXBvcnRzW25hbWVdLmZvckVhY2goZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFkZF9zZWxlY3Rfb3B0aW9uKGlucHV0LCBkYXRhKVxuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICBlbHNlIGFkZF9zZWxlY3Rfb3B0aW9uKGlucHV0LCB0aGlzLmltcG9ydHNbbmFtZV0pO1xuXG4gICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSB0aGlzLmltcG9ydHNbbmFtZV07XG4gICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB0aGlzLnNldEltcG9ydGVkVGFnKGlucHV0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh3aGF0ICE9PSB0eXBlaW1wb3J0LnNldHRpbmdzKSBpbnB1dC5mb2N1cygpO1xuICAgICAgICAgICAgZG9uZSA9IGRvbmUgJiYgdHJ1ZTtcbiAgICAgICAgICAgIC8vIHNldCBpbXBvcnRlZCB0YWcgdG8gZmllbGRib3hcblxuXG4gICAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSB0eXBlaW1wb3J0LnByaXZpbGVnZXMpIHtcbiAgICAgICAgICAgIC8vY29uc3QgY2xlYXJwcml2aWxlZ2VzID0gKHdoYXQgPT09IHR5cGVpbXBvcnQuc2V0dGluZ3MpO1xuICAgICAgICAgICAgY29uc3QgY2xlYXJwcml2aWxlZ2VzID0gZmFsc2U7XG4gICAgICAgICAgICBkb25lID0gZG9uZSAmJiB0aGlzLmltcG9ydFByaXZpbGVnZXModGhpcy5pbXBvcnRzW25hbWVdLCBjbGVhcnByaXZpbGVnZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpZiAoZG9uZSA9PT0gdHJ1ZSAmJiBjbG9zZSA9PSB0cnVlKSB7XG4gICAgICB0aGlzLmRpc21pc3MoKTtcbiAgICAgIGlmICh0aGlzLmZvcm0pIHRoaXMuZm9ybS5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgndmFsaWRhdGUnKSk7XG4gICAgfVxuICB9XG5cbiAgc2V0SW1wb3J0ZWRUYWcoaW5wdXQsIHNlbGVjdG9yID0gZG9tc2VsZWN0b3JzLmNvbXBvbmVudC5mb3JtLmZvcm1ib3gpIHtcbiAgICBsZXQgZWwgPSAoc2VsZWN0b3IgPT09IG51bGwpID8gaW5wdXQgOiAoaW5wdXQuY2xvc2VzdChzZWxlY3RvcikgPyBpbnB1dC5jbG9zZXN0KHNlbGVjdG9yKSA6IGlucHV0LmNsb3Nlc3QoJ2ZpZWxkc2V0JykpO1xuICAgIGlmICghZWwpIHJldHVybjtcbiAgICBjb25zdCByZW1vdmV0YWcgPSAoZSkgPT4ge1xuICAgICAgZGVsZXRlIGVsLmRhdGFzZXQuaXNpbXBvcnRlZDtcbiAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoY3NzLmltcG9ydGVkKTtcbiAgICAgIGlucHV0LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHJlbW92ZXRhZyk7XG4gICAgfVxuICAgIGVsLmRhdGFzZXQuaXNpbXBvcnRlZCA9IHRoaXMuZm9ybS5kYXRhc2V0LmlzaW1wb3J0ZWQ7XG4gICAgZWwuY2xhc3NMaXN0LmFkZChjc3MuaW1wb3J0ZWQpO1xuICAgIGlmIChpbnB1dC5kYXRhc2V0LnVuaXF1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpbnB1dC5kYXRhc2V0LnVuaXF1ZSA9IGlucHV0LnZhbHVlO1xuICAgIH1cbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgcmVtb3ZldGFnKTtcbiAgICB9LCA1MDApO1xuICB9XG5cbiAgZGlzbWlzcyhjbGVhciA9IGZhbHNlKSB7XG4gICAgaWYgKHRoaXMuYnV0dG9uKSB0aGlzLnNob3dJbXBvcnQoZmFsc2UpO1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuZG9tLmNsb3Nlc3QoJ2RldGFpbHMnKTtcbiAgICBpZiAoY29udGFpbmVyKSB7XG4gICAgICBjb250YWluZXIub3BlbiA9IGZhbHNlO1xuICAgICAgaWYgKGNsZWFyID09PSB0cnVlKSBjb250YWluZXIucXVlcnlTZWxlY3Rvcih0aGlzLmNvbnRlbnRfc2VsZWN0b3IpLmlubmVySFRNTCA9IGBgO1xuICAgIH1cblxuICB9XG4gIGluZGV4VG9DaGVjaygpIHtcbiAgICAvLyBpbmRleCBvZiBjZWxscyB0byBjaGVjayBpZiBlbXB0eSBhbmQgZGlzYWJsZSByb3cgIGltcG9ydCBidG5cbiAgICBjb25zdCBncmlkID0gKHRoaXMudGJsKSA/IHRoaXMudGJsLmdyaWQgOiBudWxsO1xuICAgIGlmICghZ3JpZCkgcmV0dXJuIFswXTtcbiAgICBsZXQgaW5kZXggPSBncmlkLmNvbHVtbnMuZmluZEluZGV4KGNvbHVtbiA9PiAoY29sdW1uLndoYXQgJiYgY29sdW1uLndoYXQgPT09IHR5cGVpbXBvcnQudGF4bykpO1xuICAgIGlmIChpbmRleCA9PT0gLTEpIHJldHVybiBbMF07XG4gICAgY29uc3QgcGFydHMgPSAoZ3JpZC5jb2x1bW5zW2luZGV4XS5wYXJ0cykgPyBncmlkLmNvbHVtbnNbaW5kZXhdLnBhcnRzIDogbnVsbDtcbiAgICBpZiAocGFydHMpIHtcbiAgICAgIGNvbnN0IGluZGV4dG9jaGVjayA9IGdyaWQuY29sdW1ucy5maWx0ZXIoKGNvbHVtbiwgaSkgPT4ge1xuICAgICAgICBpZiAocGFydHMuaW5kZXhPZihjb2x1bW4ubmFtZSkgPj0gMCkgcmV0dXJuIGk7XG4gICAgICB9KS5tYXAodiA9PiB7XG4gICAgICAgIHJldHVybiB2LmluZGV4O1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gaW5kZXh0b2NoZWNrO1xuICAgIH1cblxuICB9XG4gIC8vIHNob3cgLyBoaWRlIGltcG9ydHpvbmUgYW5kIGJ1dHRvbnNcbiAgc2hvd0ltcG9ydChzaG93KSB7XG4gICAgaWYgKCF0aGlzLmJ1dHRvbikgcmV0dXJuO1xuXG4gICAgaWYgKHNob3cgPT09IGZhbHNlKSB7XG4gICAgICB0aGlzLmJ1dHRvbi5jbGFzc0xpc3QuYWRkKGNzcy5oaWRlKTtcbiAgICAgIHRoaXMucmVwbGFjZWJ1dHRvbi5jbGFzc0xpc3QuYWRkKGNzcy5oaWRlKTtcbiAgICAgIHRoaXMuaW1wb3J0Y29udGFpbmVyLmNsYXNzTGlzdC5hZGQoY3NzLmhpZGUpO1xuICAgICAgdGhpcy50YWJidXR0b24uY2xhc3NMaXN0LmFkZChjc3MuaGlkZSk7XG5cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5idXR0b24uY2xhc3NMaXN0LnJlbW92ZShjc3MuaGlkZSk7XG4gICAgICB0aGlzLnJlcGxhY2VidXR0b24uY2xhc3NMaXN0LnJlbW92ZShjc3MuaGlkZSk7XG5cbiAgICAgIHRoaXMuaW1wb3J0Y29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoY3NzLmhpZGUpO1xuICAgICAgdGhpcy5idXR0b24uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgIGNvbnN0IGltcG9ydHpvbmUgPSB0aGlzLmltcG9ydGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKCcjJyArIHRoaXMuaW1wb3J0aWQpO1xuICAgICAgaWYgKGltcG9ydHpvbmUpIHtcbiAgICAgICAgdGhpcy50YWJidXR0b24uY2xhc3NMaXN0LnJlbW92ZShjc3MuaGlkZSk7XG4gICAgICAgIGlmIChpbXBvcnR6b25lLnRvbXNlbGVjdCAmJiBpbXBvcnR6b25lLnRvbXNlbGVjdC5jb250cm9sLm9mZnNldEhlaWdodCA8IGltcG9ydHpvbmUudG9tc2VsZWN0LmNvbnRyb2wuc2Nyb2xsSGVpZ2h0KSB7XG4gICAgICAgICAgdGhpcy50YWJidXR0b24uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHRoaXMudGFiYnV0dG9uLmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLy8gcmVzaXplIGltcG9ydHpvbmVcbiAgcmVzaXplWm9uZShlKSB7XG4gICAgY29uc3QgZGl2ID0gdGhpcy5pbXBvcnRjb250YWluZXIuY2xvc2VzdChkb21zZWxlY3RvcnMuY29tcG9uZW50LmltcG9ydC56b25laW1wb3J0KTtcbiAgICBpZiAoIWRpdikgcmV0dXJuO1xuICAgIGRpdi5wYXJlbnRFbGVtZW50LmNsYXNzTGlzdC50b2dnbGUoY3NzLnNob3dmdWxsKTtcbiAgICBjb25zdCBpY29uID0gZS5jdXJyZW50VGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJ2knKTtcbiAgICBpZiAoaWNvbikge1xuICAgICAgaWNvbi5jbGFzc0xpc3QudG9nZ2xlKCdpY29uLWFycm93LXBvaW50aW5nLW91dCcpO1xuICAgICAgaWNvbi5jbGFzc0xpc3QudG9nZ2xlKCdpY29uLWFycm93LXBvaW50aW5nLWluJyk7XG4gICAgfVxuICB9XG59Il0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///./src/modules/data-import.js\n")}}]);