/*! For license information please see src_modules_data-import_js.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["src_modules_data-import_js"],{"./src/modules/data-import.js":(module,__webpack_exports__,__webpack_require__)=>{eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   DataImport: () => (/* binding */ DataImport)\n/* harmony export */ });\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! dompurify */ \"./node_modules/dompurify/dist/purify.js\");\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(dompurify__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../modules/js-tom-select.js */ \"./src/modules/js-tom-select.js\");\n/* harmony import */ var _modules_project_privileges_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../modules/project-privileges.js */ \"./src/modules/project-privileges.js\");\n/* harmony import */ var _modules_utils_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../modules/utils.js */ \"./src/modules/utils.js\");\n/* harmony import */ var _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../modules/modules-config.js */ \"./src/modules/modules-config.js\");\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([_modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__, _modules_project_privileges_js__WEBPACK_IMPORTED_MODULE_2__]);\n([_modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__, _modules_project_privileges_js__WEBPACK_IMPORTED_MODULE_2__] = __webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__);\n\n\n\n\n\n\nconst key_privileges = Object.keys(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.defined_privileges).reduce(function(result, key) {\n  result[key] = key;\n  return result;\n}, {});\nlet instance;\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported = 'imported';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.tomselected = 'tomselected';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hiddenaccessible = 'ts-hidden-accessible';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowout = 'icon-arrow-pointing-out';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowin = 'icon-arrow-pointing-in';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton = '.import-list-reset';\nclass DataImport {\n  content_selector = '.modal-content';\n  imports = [];\n  taxos = [\"preset\", \"extra\"];\n  importcontainer;\n  importzoneid; // target element to add/replace datasto import\n  importid = 'importzone'; // importzone built to display data to import\n  importzone = null;\n  selectors;\n  button;\n  clearbutton;\n  replacebutton;\n  tabbutton;\n  dom;\n  tbl = null;\n  thcells = [];\n  trs = [];\n  datas;\n  constructor(tbl, what = null, selector = null) {\n    if (!tbl) return;\n    // tbl is a TableComponent  ?\n    this.tbl = (typeof(tbl) === 'object') ? tbl : null;\n    selector = (selector === null) ? ((this.tbl.cellidname) ? \"data-\" + this.tbl.cellidname : \"data-id\") : selector;\n    // get the table from table component or html table element id\n    this.dom = (this.tbl) ? this.tbl.dom : document.getElementById(tbl);\n    if (!this.dom) return;\n    this.thcells = Array.from(this.dom.querySelectorAll('thead th'));\n    this.trs = Array.from(this.dom.querySelectorAll('tbody tr'));\n    const grid = (this.tbl) ? this.tbl.grid : null;\n    this.datas = (grid) ? grid.data : this.trs.map(tr => {\n      return Array.from(tr.childNodes).forEach(cell => {\n        return cell.innerText;\n      });\n    });\n    what = (what) ? dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(what) : (tbl && tbl.params && tbl.params.import) ? tbl.params.import : (this.dom.dataset.import) ? dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(this.dom.dataset.import) : null;\n    if (!instance || instance.doc !== this.dom) {\n      // defaultoptions - keep like that\n\n      const options = {\n        importcontainer: '#data-import-' + what,\n        btns: '.btns-imports',\n        button: '#add-import-' + what,\n        replacebutton: '#replace-import-' + what,\n        tabbutton: '#tab-import-' + what,\n      };\n      this.selector = selector;\n\n      this.importcontainer = options.importcontainer instanceof HTMLElement ? options.importcontainer : document.querySelector(options.importcontainer);\n      this.form = (options.form) ? ((options.form) instanceof HTMLElement ? options.form : document.querySelector(options.form)) : this.dom.closest('form');\n      this.button = options.button instanceof HTMLElement ? options.button : document.querySelector(options.button);\n      this.replacebutton = options.replacebutton instanceof HTMLElement ? options.replacebutton : document.querySelector(options.replacebutton);\n      this.tabbutton = options.tabbutton instanceof HTMLElement ? options.tabbutton : document.querySelector(options.tabbutton);\n      this.importid = this.importid + '_' + what;\n      this.targetimport = (this.form.querySelector('[name=\"' + what + '\"]')) ? this.form.querySelector('[name=\"' + what + '\"]') : this.form.querySelector('[data-type=\"' + what + '\"]');\n      this.init(options);\n      instance = this;\n    }\n    return instance;\n  }\n\n  init(options) {\n    // hide importzone\n    this.showImport(false);\n    // remove line of target proj\n    let projid = this.form.querySelector('#' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.projid);\n    if (projid && projid.value) {\n      projid = this.dom.querySelector('[' + this.selector + '=\"' + projid.value + '\"]');\n      if (projid) projid.hidden = true;\n    }\n    const indextocheck = this.indexToCheck();\n    this.selectors = this.dom.querySelectorAll('[' + this.selector + '] button, [' + this.selector + '] input');\n    this.selectors.forEach(selector => {\n      // checkbox possible\n      const index = Array.from(selector.parentElement.children).indexOf((selector));\n      if (indextocheck && selector.closest('tr').children[indextocheck[index]].innerHTML === '') this.disableSelector(selector, false);\n      else {\n        const evt = (selector.tagName.toLowerCase() === 'input') ? 'change' : 'click';\n        const apply_selection = (e) => {\n          e.preventDefault();\n          e.stopImmediatePropagation();\n          const target = e.currentTarget;\n          const add = (evt === 'click' || target.checked === true);\n          this.disableSelector(target, add);\n          this.toImport(target.parentElement, index, add);\n        };\n        selector.removeEventListener(evt, apply_selection, false);\n        selector.addEventListener(evt, apply_selection, false);\n      };\n    });\n    if (this.tabbutton) {\n      this.tabbutton.addEventListener('click', (e) => {\n        e.stopImmediatePropagation();\n        e.preventDefault();\n        this.resizeZone(e);\n      });\n    }\n\n  }\n\n  columnProperty(name, index) {\n    const th = this.thcells[index];\n    if (this.tbl) return (this.tbl.grid.columns[index].hasOwnProperty(name)) ? this.tbl.grid.columns[index][name] : null;\n    else return (th.dataset[name]) ? th.dataset.name : null;\n  }\n  columnIndex(prop, value) {\n    return Array.from(this.dom.querySelectorAll('thead th')).findIndex(th => (th.dataset[prop] && th.dataset[prop] === value));\n  }\n  gridColumnIndex(prop, value) {\n    if (this.tbl) return this.tbl.grid.columns.findIndex(column => (column.hasOwnProperty(prop) && column[prop] === value));\n    else return this.columnIndex(prop, value);\n  }\n  rowIndex(td) {\n    const ref = (td.parentElement) ? td.parentElement : null;\n    if (!ref) return null;\n    return this.trs.findIndex(tr => (tr === ref));\n  }\n  disableSelector(selector, disable = true) {\n    const type = selector.tagName.toLowerCase();\n    if (type === \"input\") {\n      if (selector.checked !== disable) selector.checked = disable;\n    } // disable button but toggle checkbox\n    else selector.disabled = disable;\n  }\n\n  getDataToImport(cell, celldata) {\n    let toimport = celldata;\n    if (cell !== null) {\n      if (cell.dataset.autocomplete) {\n        // select elements where key / value in different columns\n        toimport = {\n          value: celldata,\n          key: null\n        };\n        let el = null;\n        this.thcells.every((t, idx) => {\n          if (t.dataset.name == thcell.dataset.autocomplete) {\n            el = idx;\n            return false;\n          }\n          return true;\n        });\n        if (el !== null) {\n          el = this.datas[rowindex][el];\n\n          toimport.key = el;\n        }\n      } else if (cell.dataset.value) toimport = cell.dataset.value;\n\n    }\n    return toimport;\n  }\n  getSelectCells(cellindex, whatpart) {\n    const parts = this.columnProperty('parts', cellindex);\n    let selectcells = this.columnProperty('selectcells', cellindex);\n    selectcells = (selectcells) ? ((parts) ? [parts[whatpart]] : selectcells) : null;\n    return selectcells;\n  }\n\n  populateImportZone(add, items) {\n    if (!this.importzone) return;\n    const ts = this.importzone.tomselect;\n    if (ts) {\n      Object.values(ts.options).forEach((opt) => {\n        let obj = {};\n        obj[opt[ts.settings.valueField]] = opt[ts.settings.labelField];\n        if (!items[opt[ts.settings.valueField]]) items = Object.assign(items, obj);\n      });\n      items = Object.entries(items);\n      // sort items\n      items.sort((a, b) => {\n        let x = a[1];\n        let y = b[1];\n        return +(x > y) || -(y > x);\n      });\n      //  ts.clear();\n      //ts.clearOptions();\n      // add ts items\n      if (add) items.forEach(([key, text]) => {\n        if (ts.getItem(key) === null) {\n          if (ts.getOption(key) === null) {\n            let obj = {};\n            obj[ts.settings.valueField] = key;\n            obj[ts.settings.labelField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(text.trim());\n            ts.addOption(obj);\n          }\n          ts.addItem(key);\n        }\n      });\n      else items.forEach(([key, text]) => {\n        ts.removeItem(key);\n      });\n    } else {\n      Object.values(this.importzone.options).forEach(opt => {\n        let obj = {};\n        obj[opt.value] = opt.text;\n        if (!items[opt.value]) items = Object.assign(items, obj);\n      });\n      items = Object.entries(items);\n      items.sort((a, b) => {\n        let x = a[1];\n        let y = b[1];\n        return +(x > y) || -(y > x);\n      });\n      this.importzone.innerHTML = ``;\n      if (add) items.forEach(([key, text]) => {\n        const opt = this.importzone.querySelector('option[value=\"' + key + '\"]');\n        if (!opt) {\n          const o = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', {\n            value: key,\n            selected: 'selected',\n            text: text\n          }, this.importzone);\n        } else opt.selected = true;\n      });\n      else items.forEach(([key, text]) => {\n        const opt = this.importzone.querySelector('option[value=\"' + key + '\"]');\n        if (opt) opt.remove(); // or opt.selected=false;\n      });\n    }\n  }\n\n  toImport(td, whatpart = 0, add = true) {\n    // cell values in json  - no parse\n    if (td.tagName.toLowerCase() !== 'td') td = td.closest('td');\n    const rowindex = this.rowIndex(td);\n    if (rowindex === null) return;\n    let showbtns = true;\n    let contact = null;\n    const cellindex = td.cellIndex;\n    const what = this.columnProperty('what', cellindex);\n    if (!what) return;\n    const parts = this.columnProperty('parts', cellindex);\n    const selectcells = this.getSelectCells(cellindex, whatpart);\n    if (!selectcells) return;\n    if ([_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.settings, _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges].indexOf(what) >= 0) this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact] = this.findContact(this.datas[rowindex]);\n    if ([_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.project, _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo, _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges].indexOf(what) >= 0) this.createImportzone(what);\n    this.addResetButton();\n    let ts = null;\n    selectcells.forEach((name, index) => {\n      index = this.gridColumnIndex('name', name);\n      if (index >= 0) {\n        const tdindex = this.columnIndex('name', name);\n        // show import buttons if importzone\n        const cell = (tdindex >= 0) ? this.trs[rowindex].cells[tdindex] : null;\n        if (cell) cell.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n        const rowdata = this.datas[rowindex];\n        const celldata = rowdata[index];\n        const thcell = (tdindex >= 0) ? this.thcells[tdindex] : null;\n        switch (what) {\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo:\n            if (!this.importzone) return;\n            // accumulate and show in import win - move the form field in modal win to view the changes and benefit of tom-select component functs...\n            ts = this.importzone.tomselect;\n            let taxons = celldata;\n            if (taxons) {\n              this.populateImportZone(add, taxons);\n              showbtns = (Object.keys(taxons).length > 0);\n              taxons = null;\n            }\n            break;\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges:\n            const privs = celldata;\n            // set everybody to 'view' if more than one project imported\n            const resetpriv = ((ts && ts.items.length > 0) || (this.importzone.selectedIndex > 0));\n            if (!this.importzone.tomselect) {\n              this.importzone.currentlist = {};\n              _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__.JsTomSelect.applyTo(this.importzone);\n            }\n            ts = this.importzone.tomselect;\n            Object.entries(privs).forEach(([priv, members]) => {\n              members.sort((a, b) => {\n                return (b.name > a.name);\n              });\n              members.forEach(member => {\n                const newpriv = (resetpriv) ? key_privileges.viewers : priv; // viewer if more than one project imported\n                let opt;\n                if (!this.importzone.currentlist || !this.importzone.currentlist[member.id]) {\n                  if (ts) {\n                    opt = ts.items.indexOf(member.id);\n                    //TODO - test - opt should always be 0\n                    if (opt >= 0) {\n                      ts.removeItem(member.id);\n                      ts.removeOption(member.id);\n                    }\n                    // addoption && addItem\n                    opt = {\n                      optgroup: newpriv\n                    }\n                    opt[ts.settings.valueField] = member.id;\n                    opt[ts.settings.searchField] = member.name;\n                    opt[ts.settings.labelField] = member.name;\n                    ts.addOption(opt);\n                    ts.addItem(member.id);\n                  } else {\n                    opt = this.importzone.querySelector('option[value=\"' + member.id + '\"]');\n                    if (opt === null) {\n                      opt = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', {\n                        value: member.id,\n                        dataset: {\n                          optgroup: newpriv\n                        },\n                        selected: true,\n                        defaultSelected: true,\n                        text: member.name\n                      })\n                      this.importzone.add(opt);\n                    } else opt.dataset.optgroup = newpriv;\n                  }\n                }\n              });\n              if (ts) ts.refreshOptions(true);\n            });\n            showbtns = (((ts) ? ts.items.length : this.importzone.selectedIndex + 1) > 0);\n            break;\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.project:\n            const ln = Object.keys(this.imports).length;\n\n            if (!this.imports[name]) this.imports[name] = [];\n            const data = this.getDataToImport(cell, celldata);\n            if (add) this.imports[name].push(data);\n            else {\n              const idx = this.imports[name].indexOf(data);\n              if (idx > -1) this.imports[name].splice(idx, 1);\n            }\n            if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.projid) {\n              const idx = this.columnIndex('name', 'title');\n              // show import buttons if importzone\n              const celllabel = (idx >= 0) ? this.trs[rowindex].cells[idx] : null;\n              const datalabel = rowdata[idx];\n              const label = (celllabel) ? this.getDataToImport(celllabel, datalabel) : data;\n              const items = {};\n              items[rowdata[this.tbl.getCellId(this.tbl.cellidname)]] = label;\n              this.populateImportZone(add, items);\n            }\n            if (ln === 0) {\n              if (add) this.filterByRecord(rowdata, rowindex);\n              else this.resetFilter();\n            }\n            break;\n          default:\n            if (add) this.imports[name] = this.getDataToImport(cell, celldata);\n            else {\n              const idx = this.imports.indexOf(name);\n              if (idx > -1) this.imports.splice(idx, 1);\n            }\n            break;\n        }\n      };\n    });\n    if (this.thcells.length) {\n      if (this.button) {\n        const activate = (!this.button.dataset.activated && ([_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo, _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges, _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.project].indexOf(what) >= 0));\n        this.showImport(showbtns);\n        if (activate) this.activateButtons(what, selectcells);\n      } else this.makeImport(null, selectcells, what, true);\n    }\n  }\n  messageZone(item) {\n    console.log('itemmessage', item);\n  }\n  activateButtons(what, selectcells) {\n    this.button.addEventListener('click', async (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      await this.makeImport(e.currentTarget, selectcells, what, true);\n    });\n    this.replacebutton.addEventListener('click', async (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      await this.makeImport(e.currentTarget, selectcells, what, true);\n    });\n    this.button.dataset.activated = true;\n    this.replacebutton.dataset.activated = true;\n  }\n\n  findContact(tds, name = 'contact') {\n    const index = this.gridColumnIndex('name', name);\n    if (index >= 0) return tds[index] ? tds[index] : null;\n\n    return null;\n  }\n\n  renderPrivileges(replace = false) {\n    let privileges = {};\n    const tzone = this.importzone.tomselect;\n    const pushpriv = (member, priv) => {\n      const obj = {\n        id: member.id,\n        name: member.name,\n        priv: priv\n      }\n      if (privileges[priv]) privileges[priv].push(obj);\n      else privileges[priv] = [obj];\n    }\n\n    if (tzone) {\n      const members = [...tzone.items];\n      const options = Object.assign({}, tzone.options);\n      members.forEach(member => {\n        member = options[member];\n        if (member) pushpriv(member, member.optgroup);\n\n      })\n    } else {\n      this.importzone.options.forEach(member => {\n        if (member.selected) pushpriv(member, member.dataset.optgroup);\n      })\n    }\n\n    if (this.importPrivileges(privileges, replace)) {\n      if (tzone) {\n        tzone.clear();\n        tzone.clearOptions();\n      } else this.importzone.innerHTML = ``;\n\n    }\n\n  }\n\n  importPrivileges(privileges, clear = false) {\n    const projectPrivileges = this.form.querySelector('.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.privileges.ident);\n    if (projectPrivileges === null || !projectPrivileges.jsprivileges) return;\n    const importedtag = (input) => {\n      this.setImportedTag(input, null);\n    }\n    const dismiss = () => {\n      this.dismiss();\n    }\n    const contact = (clear === true && this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact]) ? this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact] : null;\n    return (projectPrivileges.jsprivileges.importPrivileges(privileges, clear, contact, importedtag, dismiss));\n  }\n\n  resetSelector(tr) {\n    const resets = {};\n    const append_resets = (name, td, i) => {\n      const rowindex = this.rowIndex(td);\n      const celldata = this.datas[rowindex][i];\n      const cell = this.trs[rowindex].cells[i];\n      const data = this.getDataToImport(cell, celldata);\n      if (!resets[name]) resets[name] = [data];\n      else if (resets[name].indexOf(data) < 0) resets[name].push(data);\n    }\n    const selectors = tr.querySelectorAll('[' + this.selector + '] button, [' + this.selector + '] input');\n    selectors.forEach((selector, i) => {\n      if (selector.disabled) this.disableSelector(selector, false);\n      const name = (selector.parentElement.dataset.name) ? selector.parentElement.dataset.name : null;\n      append_resets(name, selector.parentElement, i);\n    });\n    tr.querySelectorAll('td.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected).forEach((td, i) => {\n      td.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n      append_resets(name, td, i);\n    });\n    return resets;\n  }\n\n  resetSelectors() {\n    this.selectors.forEach((selector, i) => {\n      if (selector.disabled) this.disableSelector(selector, false);\n    });\n    this.dom.querySelectorAll('td.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected).forEach(td => {\n      td.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n    });\n  }\n  resetImports() {\n    this.imports = [];\n    if (this.importzone) {\n      if (this.importzone.currentlist) this.importzone.currentlist = {};\n      if (this.importzone.tomselect) this.importzone.tomselect.clear();\n      else switch (this.importzone.tagName.toLowerCase()) {\n        case 'input':\n          this.importzone.value = '';\n          break;\n        case 'select':\n          this.importzone.selectedIndex = -1;\n          break;\n      }\n    }\n  }\n\n  activateClear() {\n    const clearbutton = document.getElementById('clear-' + this.importid);\n    if (!clearbutton) return;\n    clearbutton.addEventListener('click', (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      if (!this.importcontainer) return;\n      this.resetSelectors();\n      this.resetImports();\n      this.button.disabled = false;\n      this.replacebutton.disabled = false;\n      this.showImport(false);\n    });\n  }\n\n  createImportzone(name) {\n    this.showImport(true);\n    let ts = false;\n    if (!this.importzone) {\n      if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) {\n        this.importzone = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('select', {\n          id: this.importid,\n          dataset: {\n            type: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.user,\n            priv: true,\n          },\n          multiple: true\n        }, this.importcontainer);\n        ts = true;\n      } else {\n\n        if (!this.targetimport) return;\n        this.importzoneid = this.targetimport.id;\n        ts = this.targetimport.tomselect;\n        // tomselect ?\n        const importzone = this.targetimport.cloneNode();\n        importzone.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.tomselected);\n        importzone.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hiddenaccessible);\n        // keep original id to replace data on apply import\n        importzone.dataset.origin = importzone.id;\n        importzone.id = this.importid;\n        importzone.name = this.importid + '_' + importzone.name;\n        this.importcontainer.prepend(importzone);\n        this.importzone = importzone;\n        if (ts) {\n          _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__.JsTomSelect.applyTo(this.importzone);\n          ts = this.importzone.tomselect;\n        }\n        if (ts) {\n          ts.on(\"item_remove\", (value, item) => {\n            this.itemRemove(value, item);\n          });\n        }\n        this.activateClear();\n      }\n\n    }\n\n  }\n  cloneImport(btn) {\n    const import_target = this.form.querySelector('#' + this.importzone.dataset.origin);\n    if (!import_target) return false;\n    const ts = import_target.tomselect;\n    if (ts) {\n\n      // only if replace specified\n      if (btn.dataset.replace && btn.dataset.replace === 'replace') {\n        ts.clear();\n        ts.clearOptions();\n      }\n      const tzone = this.importzone.tomselect;\n      const items = [...tzone.items];\n      const options = Object.assign({}, tzone.options);\n      items.forEach((e) => {\n        let el = {};\n        el[ts.settings.valueField] = e;\n        el[ts.settings.labelField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(options[e][ts.settings.labelField]);\n        el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(options[e][ts.settings.labelField]);\n        if (ts.getOption(el[ts.settings.valueField]) === null) ts.addOption(el);\n        if (ts.getItem(el[ts.settings.valueField]) === null) ts.addItem(el[ts.settings.valueField]);\n      });\n      //  tzone.clearOptions();\n    } else {\n      if (btn.dataset.replace && btn.dataset.replace === 'replace') import_target.innerHTML = ``;\n      import_target.innerHTML = dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(this.importzone.innerHTML);\n      this.importzone.innerHTML = ``;\n    }\n    return true;\n  }\n\n  async makeImport(btn, selectcells, what, close = false) {\n    let done = true,\n      ts = null;\n\n    switch (what) {\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo:\n        if (!this.importzone) return false;\n        done = this.cloneImport(btn);\n        break;\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges:\n        if (!this.importzone) return false;\n        done = this.renderPrivileges((btn.dataset.replace && btn.dataset.replace === 'replace'));\n        if (this.importzone.currentlist) this.importzone.currentlist = {};\n        break;\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.project:\n        if (!this.importzone) return false;\n        const newone = (this.form.dataset.id) ? parseInt(this.form.dataset.id) : 0;\n        const results = await this.compileProjectRecords(newone);\n        done = this.cloneImport(btn);\n        const idx = selectcells.indexOf(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.projid);\n        if (idx >= 0) selectcells.splice(idx, 1);\n        [\"creator_users\", \"creator_organisations\", \"classiffieldlist\", \"privileges\", \"access\", \"status\", \"cnn_network_id\"].forEach(result => {\n          this.imports[result] = results[result];\n        });\n        this.imports[\"init_classif_list\"] = results.initclassiflist;\n      default:\n        const ts_add_select_item = function(ts, data) {\n          const el = {};\n          if (typeof(data) == 'string') {\n            el[ts.settings.labelField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data);\n            el[ts.settings.valueField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data);\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data);\n          } else {\n            el[ts.settings.labelField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data.value);\n            el[ts.settings.valueField] = data.key;\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data.value);\n          }\n          if (ts.getOption(el[ts.settings.valueField]) === null) ts.addOption(el);\n          if (ts.getItem(el[ts.settings.valueField]) === null) ts.addItem(el[ts.settings.valueField]);\n        }\n        const add_select_option = function(input, data) {\n          let attr = {\n            selected: true\n          };\n          if (typeof(data) === 'string') attr.value = attr.text = data;\n          else {\n            attr.value = data.key;\n            attr.text = data.value;\n          }\n          const option = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', attr, input);\n        }\n        const add_input_option = function(input, data) {\n          if (input.multiple) {\n            let values = input.value.split(',');\n            values.push(data.key);\n            input.value = values.join(',');\n          } else input.value = data;\n\n        }\n        selectcells.forEach((name, index) => {\n          let input = ((this.form.querySelector('[data-importfield=\"' + name + '\"]')) ? this.form.querySelector('[data-importfield=\"' + name + '\"]') : this.form.querySelector('[name=\"' + name + '\"]'));\n          if (input && input.dataset.noimport) return;\n          if (input && this.imports[name] !== undefined) {\n            const type = (input.type) ? input.type : input.tagName.toLowerCase();\n            ts = input.tomselect;\n            if (['init_classif_list'].indexOf(name) >= 0) {\n              let ids = this.imports[name];\n              if (Array.isArray(ids)) ids = ids.join(',');\n              else ids = ids.replace('[', '').replace(']', '').replaceAll(' ', '');\n              if (ids !== '') {\n                if (ts) ts.wrapper.classList.add('wait-for-results');\n                let opts = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.fetchSettings)(),\n                  url = '';\n                const formData = new FormData();\n                formData.append('idlist', ids);\n                url = '/search/taxoresolve' //+ new URLSearchParams({'idlist': ids});\n                opts = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.fetchSettings)({\n                  'method': 'POST',\n                  'body': formData\n                });\n                fetch(url, opts).then(response =>\n                  response.json()\n                ).then(results => {\n                  const ts = input.tomselect;\n                  if (ts) {\n                    results = Object.entries(results);\n                    results.forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      ts_add_select_item(ts, el);\n                    });\n                    ts.wrapper.classList.remove('wait-for-results');\n                  } else if (type.indexOf('select') === 0) {\n                    input.querySelectorAll('option').forEach(option => {\n                      option.remove();\n                    });\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      add_input_option(input, el);\n                    });\n\n                  } else {\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      add_select_option(input, el);\n                    });\n                  }\n                  results = null;\n                  this.setImportedTag(input);\n                });\n              }\n            } else if (ts) {\n              if (input.multiple) this.imports[name].forEach(data => {\n                ts_add_select_item(ts, data)\n              });\n              else ts_add_select_item(ts, this.imports[name]);\n              this.setImportedTag(input);\n            } else {\n              switch (type) {\n                case 'radio':\n                case 'checkbox':\n                  const tocheck = this.form.querySelector('[name=\"' + name + '\"][value=\"' + this.imports[name] + '\"]');\n                  if (tocheck) tocheck.checked = true;\n                  break;\n                case 'select-multiple':\n                case 'select':\n                  if (input.multiple) this.imports[name].forEach(data => {\n                    add_select_option(input, data);\n                  });\n                  else add_select_option(input, this.imports[name]);\n                  break;\n                default:\n                  input.value = this.imports[name];\n                  break;\n              }\n              this.setImportedTag(input);\n            }\n            if (what !== _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.settings) input.focus();\n            done = done && true;\n\n\n          } else if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) {\n            //const clearprivileges = (what === typeimport.settings);\n            const clearprivileges = false;\n            done = done && this.importPrivileges(this.imports[name], clearprivileges);\n          }\n        });\n        break;\n    }\n    if (done === true && close == true) {\n      this.dismiss();\n      if (this.form) this.form.dispatchEvent(new CustomEvent('validate'));\n    }\n  }\n\n  setImportedTag(input, selector = _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.form.formbox) {\n    if (input === null) return;\n    let el = (selector === null) ? input : ((input.closest(selector)) ? input.closest(selector) : input.closest('fieldset'));\n    if (!el) return;\n    const removetag = (e) => {\n      delete el.dataset.isimported;\n      el.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported);\n      input.removeEventListener('change', removetag);\n    }\n    el.dataset.isimported = this.form.dataset.isimported;\n    el.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported);\n    if (input.dataset.unique !== undefined) {\n      input.dataset.unique = input.value;\n    }\n    setTimeout(function() {\n      input.addEventListener('change', removetag);\n    }, 500);\n  }\n\n  dismiss(clear = false) {\n    if (this.button) this.showImport(false);\n    const container = this.dom.closest('details');\n    if (container) {\n      container.open = false;\n      if (clear === true) container.querySelector(this.content_selector).innerHTML = ``;\n    }\n\n  }\n  indexToCheck() {\n    // index of cells to check if empty and disable row  import btn\n    const grid = (this.tbl) ? this.tbl.grid : null;\n    if (!grid) return [0];\n    let index = grid.columns.findIndex(column => (column.what && column.what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo));\n    if (index === -1) return [0];\n    const parts = (grid.columns[index].parts) ? grid.columns[index].parts : null;\n    if (parts) {\n      const indextocheck = grid.columns.filter((column, i) => {\n        if (parts.indexOf(column.name) >= 0) return i;\n      }).map(v => {\n        return v.index;\n      });\n      return indextocheck;\n    }\n\n  }\n  addResetButton() {\n    if (!this.tbl || !this.tbl.params.hasOwnProperty(\"reset\")) return;\n    let resetbtn = this.dom.parentElement.querySelector(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton);\n    if (resetbtn === null) {\n      resetbtn = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('a', {\n        class: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton.substr(1),\n        text: this.tbl.params.reset\n      }, this.dom.parentElement.firstChild);\n    }\n    resetbtn.addEventListener('click', (e) => {\n      e.preventDefault();\n      e.stopImmediatePropagation();\n      this.resetSelectors();\n      this.resetImports();\n    });\n\n  }\n  // show / hide importzone and buttons\n  showImport(show) {\n    if (!this.button) return;\n    if (show === false) {\n      this.button.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.replacebutton.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.importcontainer.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      if (this.tabbutton) this.tabbutton.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n    } else {\n      if (this.importzone) {\n        this.button.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.replacebutton.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.importcontainer.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.button.disabled = false;\n        if (this.tabbutton) {\n          this.tabbutton.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n          if (this.importzone.tomselect) {\n            this.tabbutton.disabled = false;\n          } else this.tabbutton.disabled = true;\n        }\n      }\n    }\n\n  }\n  // resize importzone\n  resizeZone(e) {\n    const div = this.importcontainer.closest(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.import.zoneimport);\n    if (!div) return;\n    div.parentElement.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.showfull);\n    const icon = e.currentTarget.querySelector('i');\n    if (icon) {\n      icon.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowout);\n      icon.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowin);\n    }\n  }\n}\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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REFBRztBQUM1Qyx1REFBdUQsMkRBQUc7QUFDMUQsTUFBTTtBQUNOO0FBQ0EscUNBQXFDLDJEQUFHO0FBQ3hDLDRDQUE0QywyREFBRztBQUMvQyw4Q0FBOEMsMkRBQUc7QUFDakQ7QUFDQTtBQUNBLDBDQUEwQywyREFBRztBQUM3QztBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSw2Q0FBNkMsb0VBQVk7QUFDekQ7QUFDQSx1Q0FBdUMsMkRBQUc7QUFDMUM7QUFDQTtBQUNBLDRCQUE0QiwyREFBRztBQUMvQiw0QkFBNEIsMkRBQUc7QUFDL0I7QUFDQTtBQUNBLEMiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi9zcmMvbW9kdWxlcy9kYXRhLWltcG9ydC5qcz84MGEyIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBET01QdXJpZnkgZnJvbSAnZG9tcHVyaWZ5JztcbmltcG9ydCB7XG4gIEpzVG9tU2VsZWN0XG59IGZyb20gXCIuLi9tb2R1bGVzL2pzLXRvbS1zZWxlY3QuanNcIjtcbmltcG9ydCB7XG4gIFByb2plY3RQcml2aWxlZ2VzXG59IGZyb20gJy4uL21vZHVsZXMvcHJvamVjdC1wcml2aWxlZ2VzLmpzJztcbmltcG9ydCB7XG4gIGZldGNoU2V0dGluZ3MsXG4gIHVuZXNjYXBlX2h0bWwsXG4gIGNyZWF0ZV9ib3hcbn0gZnJvbSAnLi4vbW9kdWxlcy91dGlscy5qcyc7XG5cbmltcG9ydCB7XG4gIG1vZGVscyxcbiAgdHlwZWltcG9ydCxcbiAgY3NzLFxuICBkZWZpbmVkX3ByaXZpbGVnZXMsXG4gIGRvbXNlbGVjdG9yc1xufSBmcm9tICcuLi9tb2R1bGVzL21vZHVsZXMtY29uZmlnLmpzJztcbmNvbnN0IGtleV9wcml2aWxlZ2VzID0gT2JqZWN0LmtleXMoZGVmaW5lZF9wcml2aWxlZ2VzKS5yZWR1Y2UoZnVuY3Rpb24ocmVzdWx0LCBrZXkpIHtcbiAgcmVzdWx0W2tleV0gPSBrZXk7XG4gIHJldHVybiByZXN1bHQ7XG59LCB7fSk7XG5sZXQgaW5zdGFuY2U7XG5jc3MuaW1wb3J0ZWQgPSAnaW1wb3J0ZWQnO1xuY3NzLnRvbXNlbGVjdGVkID0gJ3RvbXNlbGVjdGVkJztcbmNzcy5oaWRkZW5hY2Nlc3NpYmxlID0gJ3RzLWhpZGRlbi1hY2Nlc3NpYmxlJztcbmNzcy5hcnJvd291dCA9ICdpY29uLWFycm93LXBvaW50aW5nLW91dCc7XG5jc3MuYXJyb3dpbiA9ICdpY29uLWFycm93LXBvaW50aW5nLWluJztcbmRvbXNlbGVjdG9ycy5yZXNldGJ1dHRvbiA9ICcuaW1wb3J0LWxpc3QtcmVzZXQnO1xuZXhwb3J0IGNsYXNzIERhdGFJbXBvcnQge1xuICBjb250ZW50X3NlbGVjdG9yID0gJy5tb2RhbC1jb250ZW50JztcbiAgaW1wb3J0cyA9IFtdO1xuICB0YXhvcyA9IFtcInByZXNldFwiLCBcImV4dHJhXCJdO1xuICBpbXBvcnRjb250YWluZXI7XG4gIGltcG9ydHpvbmVpZDsgLy8gdGFyZ2V0IGVsZW1lbnQgdG8gYWRkL3JlcGxhY2UgZGF0YXN0byBpbXBvcnRcbiAgaW1wb3J0aWQgPSAnaW1wb3J0em9uZSc7IC8vIGltcG9ydHpvbmUgYnVpbHQgdG8gZGlzcGxheSBkYXRhIHRvIGltcG9ydFxuICBpbXBvcnR6b25lID0gbnVsbDtcbiAgc2VsZWN0b3JzO1xuICBidXR0b247XG4gIGNsZWFyYnV0dG9uO1xuICByZXBsYWNlYnV0dG9uO1xuICB0YWJidXR0b247XG4gIGRvbTtcbiAgdGJsID0gbnVsbDtcbiAgdGhjZWxscyA9IFtdO1xuICB0cnMgPSBbXTtcbiAgZGF0YXM7XG4gIGNvbnN0cnVjdG9yKHRibCwgd2hhdCA9IG51bGwsIHNlbGVjdG9yID0gbnVsbCkge1xuICAgIGlmICghdGJsKSByZXR1cm47XG4gICAgLy8gdGJsIGlzIGEgVGFibGVDb21wb25lbnQgID9cbiAgICB0aGlzLnRibCA9ICh0eXBlb2YodGJsKSA9PT0gJ29iamVjdCcpID8gdGJsIDogbnVsbDtcbiAgICBzZWxlY3RvciA9IChzZWxlY3RvciA9PT0gbnVsbCkgPyAoKHRoaXMudGJsLmNlbGxpZG5hbWUpID8gXCJkYXRhLVwiICsgdGhpcy50YmwuY2VsbGlkbmFtZSA6IFwiZGF0YS1pZFwiKSA6IHNlbGVjdG9yO1xuICAgIC8vIGdldCB0aGUgdGFibGUgZnJvbSB0YWJsZSBjb21wb25lbnQgb3IgaHRtbCB0YWJsZSBlbGVtZW50IGlkXG4gICAgdGhpcy5kb20gPSAodGhpcy50YmwpID8gdGhpcy50YmwuZG9tIDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGJsKTtcbiAgICBpZiAoIXRoaXMuZG9tKSByZXR1cm47XG4gICAgdGhpcy50aGNlbGxzID0gQXJyYXkuZnJvbSh0aGlzLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCd0aGVhZCB0aCcpKTtcbiAgICB0aGlzLnRycyA9IEFycmF5LmZyb20odGhpcy5kb20ucXVlcnlTZWxlY3RvckFsbCgndGJvZHkgdHInKSk7XG4gICAgY29uc3QgZ3JpZCA9ICh0aGlzLnRibCkgPyB0aGlzLnRibC5ncmlkIDogbnVsbDtcbiAgICB0aGlzLmRhdGFzID0gKGdyaWQpID8gZ3JpZC5kYXRhIDogdGhpcy50cnMubWFwKHRyID0+IHtcbiAgICAgIHJldHVybiBBcnJheS5mcm9tKHRyLmNoaWxkTm9kZXMpLmZvckVhY2goY2VsbCA9PiB7XG4gICAgICAgIHJldHVybiBjZWxsLmlubmVyVGV4dDtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHdoYXQgPSAod2hhdCkgPyBET01QdXJpZnkuc2FuaXRpemUod2hhdCkgOiAodGJsICYmIHRibC5wYXJhbXMgJiYgdGJsLnBhcmFtcy5pbXBvcnQpID8gdGJsLnBhcmFtcy5pbXBvcnQgOiAodGhpcy5kb20uZGF0YXNldC5pbXBvcnQpID8gRE9NUHVyaWZ5LnNhbml0aXplKHRoaXMuZG9tLmRhdGFzZXQuaW1wb3J0KSA6IG51bGw7XG4gICAgaWYgKCFpbnN0YW5jZSB8fCBpbnN0YW5jZS5kb2MgIT09IHRoaXMuZG9tKSB7XG4gICAgICAvLyBkZWZhdWx0b3B0aW9ucyAtIGtlZXAgbGlrZSB0aGF0XG5cbiAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgIGltcG9ydGNvbnRhaW5lcjogJyNkYXRhLWltcG9ydC0nICsgd2hhdCxcbiAgICAgICAgYnRuczogJy5idG5zLWltcG9ydHMnLFxuICAgICAgICBidXR0b246ICcjYWRkLWltcG9ydC0nICsgd2hhdCxcbiAgICAgICAgcmVwbGFjZWJ1dHRvbjogJyNyZXBsYWNlLWltcG9ydC0nICsgd2hhdCxcbiAgICAgICAgdGFiYnV0dG9uOiAnI3RhYi1pbXBvcnQtJyArIHdoYXQsXG4gICAgICB9O1xuICAgICAgdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yO1xuXG4gICAgICB0aGlzLmltcG9ydGNvbnRhaW5lciA9IG9wdGlvbnMuaW1wb3J0Y29udGFpbmVyIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgPyBvcHRpb25zLmltcG9ydGNvbnRhaW5lciA6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iob3B0aW9ucy5pbXBvcnRjb250YWluZXIpO1xuICAgICAgdGhpcy5mb3JtID0gKG9wdGlvbnMuZm9ybSkgPyAoKG9wdGlvbnMuZm9ybSkgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMuZm9ybSA6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iob3B0aW9ucy5mb3JtKSkgOiB0aGlzLmRvbS5jbG9zZXN0KCdmb3JtJyk7XG4gICAgICB0aGlzLmJ1dHRvbiA9IG9wdGlvbnMuYnV0dG9uIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgPyBvcHRpb25zLmJ1dHRvbiA6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iob3B0aW9ucy5idXR0b24pO1xuICAgICAgdGhpcy5yZXBsYWNlYnV0dG9uID0gb3B0aW9ucy5yZXBsYWNlYnV0dG9uIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgPyBvcHRpb25zLnJlcGxhY2VidXR0b24gOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKG9wdGlvbnMucmVwbGFjZWJ1dHRvbik7XG4gICAgICB0aGlzLnRhYmJ1dHRvbiA9IG9wdGlvbnMudGFiYnV0dG9uIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgPyBvcHRpb25zLnRhYmJ1dHRvbiA6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iob3B0aW9ucy50YWJidXR0b24pO1xuICAgICAgdGhpcy5pbXBvcnRpZCA9IHRoaXMuaW1wb3J0aWQgKyAnXycgKyB3aGF0O1xuICAgICAgdGhpcy50YXJnZXRpbXBvcnQgPSAodGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lPVwiJyArIHdoYXQgKyAnXCJdJykpID8gdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lPVwiJyArIHdoYXQgKyAnXCJdJykgOiB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignW2RhdGEtdHlwZT1cIicgKyB3aGF0ICsgJ1wiXScpO1xuICAgICAgdGhpcy5pbml0KG9wdGlvbnMpO1xuICAgICAgaW5zdGFuY2UgPSB0aGlzO1xuICAgIH1cbiAgICByZXR1cm4gaW5zdGFuY2U7XG4gIH1cblxuICBpbml0KG9wdGlvbnMpIHtcbiAgICAvLyBoaWRlIGltcG9ydHpvbmVcbiAgICB0aGlzLnNob3dJbXBvcnQoZmFsc2UpO1xuICAgIC8vIHJlbW92ZSBsaW5lIG9mIHRhcmdldCBwcm9qXG4gICAgbGV0IHByb2ppZCA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCcjJyArIGRvbXNlbGVjdG9ycy5wcm9qaWQpO1xuICAgIGlmIChwcm9qaWQgJiYgcHJvamlkLnZhbHVlKSB7XG4gICAgICBwcm9qaWQgPSB0aGlzLmRvbS5xdWVyeVNlbGVjdG9yKCdbJyArIHRoaXMuc2VsZWN0b3IgKyAnPVwiJyArIHByb2ppZC52YWx1ZSArICdcIl0nKTtcbiAgICAgIGlmIChwcm9qaWQpIHByb2ppZC5oaWRkZW4gPSB0cnVlO1xuICAgIH1cbiAgICBjb25zdCBpbmRleHRvY2hlY2sgPSB0aGlzLmluZGV4VG9DaGVjaygpO1xuICAgIHRoaXMuc2VsZWN0b3JzID0gdGhpcy5kb20ucXVlcnlTZWxlY3RvckFsbCgnWycgKyB0aGlzLnNlbGVjdG9yICsgJ10gYnV0dG9uLCBbJyArIHRoaXMuc2VsZWN0b3IgKyAnXSBpbnB1dCcpO1xuICAgIHRoaXMuc2VsZWN0b3JzLmZvckVhY2goc2VsZWN0b3IgPT4ge1xuICAgICAgLy8gY2hlY2tib3ggcG9zc2libGVcbiAgICAgIGNvbnN0IGluZGV4ID0gQXJyYXkuZnJvbShzZWxlY3Rvci5wYXJlbnRFbGVtZW50LmNoaWxkcmVuKS5pbmRleE9mKChzZWxlY3RvcikpO1xuICAgICAgaWYgKGluZGV4dG9jaGVjayAmJiBzZWxlY3Rvci5jbG9zZXN0KCd0cicpLmNoaWxkcmVuW2luZGV4dG9jaGVja1tpbmRleF1dLmlubmVySFRNTCA9PT0gJycpIHRoaXMuZGlzYWJsZVNlbGVjdG9yKHNlbGVjdG9yLCBmYWxzZSk7XG4gICAgICBlbHNlIHtcbiAgICAgICAgY29uc3QgZXZ0ID0gKHNlbGVjdG9yLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lucHV0JykgPyAnY2hhbmdlJyA6ICdjbGljayc7XG4gICAgICAgIGNvbnN0IGFwcGx5X3NlbGVjdGlvbiA9IChlKSA9PiB7XG4gICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgY29uc3QgdGFyZ2V0ID0gZS5jdXJyZW50VGFyZ2V0O1xuICAgICAgICAgIGNvbnN0IGFkZCA9IChldnQgPT09ICdjbGljaycgfHwgdGFyZ2V0LmNoZWNrZWQgPT09IHRydWUpO1xuICAgICAgICAgIHRoaXMuZGlzYWJsZVNlbGVjdG9yKHRhcmdldCwgYWRkKTtcbiAgICAgICAgICB0aGlzLnRvSW1wb3J0KHRhcmdldC5wYXJlbnRFbGVtZW50LCBpbmRleCwgYWRkKTtcbiAgICAgICAgfTtcbiAgICAgICAgc2VsZWN0b3IucmVtb3ZlRXZlbnRMaXN0ZW5lcihldnQsIGFwcGx5X3NlbGVjdGlvbiwgZmFsc2UpO1xuICAgICAgICBzZWxlY3Rvci5hZGRFdmVudExpc3RlbmVyKGV2dCwgYXBwbHlfc2VsZWN0aW9uLCBmYWxzZSk7XG4gICAgICB9O1xuICAgIH0pO1xuICAgIGlmICh0aGlzLnRhYmJ1dHRvbikge1xuICAgICAgdGhpcy50YWJidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xuICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHRoaXMucmVzaXplWm9uZShlKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICB9XG5cbiAgY29sdW1uUHJvcGVydHkobmFtZSwgaW5kZXgpIHtcbiAgICBjb25zdCB0aCA9IHRoaXMudGhjZWxsc1tpbmRleF07XG4gICAgaWYgKHRoaXMudGJsKSByZXR1cm4gKHRoaXMudGJsLmdyaWQuY29sdW1uc1tpbmRleF0uaGFzT3duUHJvcGVydHkobmFtZSkpID8gdGhpcy50YmwuZ3JpZC5jb2x1bW5zW2luZGV4XVtuYW1lXSA6IG51bGw7XG4gICAgZWxzZSByZXR1cm4gKHRoLmRhdGFzZXRbbmFtZV0pID8gdGguZGF0YXNldC5uYW1lIDogbnVsbDtcbiAgfVxuICBjb2x1bW5JbmRleChwcm9wLCB2YWx1ZSkge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoJ3RoZWFkIHRoJykpLmZpbmRJbmRleCh0aCA9PiAodGguZGF0YXNldFtwcm9wXSAmJiB0aC5kYXRhc2V0W3Byb3BdID09PSB2YWx1ZSkpO1xuICB9XG4gIGdyaWRDb2x1bW5JbmRleChwcm9wLCB2YWx1ZSkge1xuICAgIGlmICh0aGlzLnRibCkgcmV0dXJuIHRoaXMudGJsLmdyaWQuY29sdW1ucy5maW5kSW5kZXgoY29sdW1uID0+IChjb2x1bW4uaGFzT3duUHJvcGVydHkocHJvcCkgJiYgY29sdW1uW3Byb3BdID09PSB2YWx1ZSkpO1xuICAgIGVsc2UgcmV0dXJuIHRoaXMuY29sdW1uSW5kZXgocHJvcCwgdmFsdWUpO1xuICB9XG4gIHJvd0luZGV4KHRkKSB7XG4gICAgY29uc3QgcmVmID0gKHRkLnBhcmVudEVsZW1lbnQpID8gdGQucGFyZW50RWxlbWVudCA6IG51bGw7XG4gICAgaWYgKCFyZWYpIHJldHVybiBudWxsO1xuICAgIHJldHVybiB0aGlzLnRycy5maW5kSW5kZXgodHIgPT4gKHRyID09PSByZWYpKTtcbiAgfVxuICBkaXNhYmxlU2VsZWN0b3Ioc2VsZWN0b3IsIGRpc2FibGUgPSB0cnVlKSB7XG4gICAgY29uc3QgdHlwZSA9IHNlbGVjdG9yLnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcbiAgICBpZiAodHlwZSA9PT0gXCJpbnB1dFwiKSB7XG4gICAgICBpZiAoc2VsZWN0b3IuY2hlY2tlZCAhPT0gZGlzYWJsZSkgc2VsZWN0b3IuY2hlY2tlZCA9IGRpc2FibGU7XG4gICAgfSAvLyBkaXNhYmxlIGJ1dHRvbiBidXQgdG9nZ2xlIGNoZWNrYm94XG4gICAgZWxzZSBzZWxlY3Rvci5kaXNhYmxlZCA9IGRpc2FibGU7XG4gIH1cblxuICBnZXREYXRhVG9JbXBvcnQoY2VsbCwgY2VsbGRhdGEpIHtcbiAgICBsZXQgdG9pbXBvcnQgPSBjZWxsZGF0YTtcbiAgICBpZiAoY2VsbCAhPT0gbnVsbCkge1xuICAgICAgaWYgKGNlbGwuZGF0YXNldC5hdXRvY29tcGxldGUpIHtcbiAgICAgICAgLy8gc2VsZWN0IGVsZW1lbnRzIHdoZXJlIGtleSAvIHZhbHVlIGluIGRpZmZlcmVudCBjb2x1bW5zXG4gICAgICAgIHRvaW1wb3J0ID0ge1xuICAgICAgICAgIHZhbHVlOiBjZWxsZGF0YSxcbiAgICAgICAgICBrZXk6IG51bGxcbiAgICAgICAgfTtcbiAgICAgICAgbGV0IGVsID0gbnVsbDtcbiAgICAgICAgdGhpcy50aGNlbGxzLmV2ZXJ5KCh0LCBpZHgpID0+IHtcbiAgICAgICAgICBpZiAodC5kYXRhc2V0Lm5hbWUgPT0gdGhjZWxsLmRhdGFzZXQuYXV0b2NvbXBsZXRlKSB7XG4gICAgICAgICAgICBlbCA9IGlkeDtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoZWwgIT09IG51bGwpIHtcbiAgICAgICAgICBlbCA9IHRoaXMuZGF0YXNbcm93aW5kZXhdW2VsXTtcblxuICAgICAgICAgIHRvaW1wb3J0LmtleSA9IGVsO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGNlbGwuZGF0YXNldC52YWx1ZSkgdG9pbXBvcnQgPSBjZWxsLmRhdGFzZXQudmFsdWU7XG5cbiAgICB9XG4gICAgcmV0dXJuIHRvaW1wb3J0O1xuICB9XG4gIGdldFNlbGVjdENlbGxzKGNlbGxpbmRleCwgd2hhdHBhcnQpIHtcbiAgICBjb25zdCBwYXJ0cyA9IHRoaXMuY29sdW1uUHJvcGVydHkoJ3BhcnRzJywgY2VsbGluZGV4KTtcbiAgICBsZXQgc2VsZWN0Y2VsbHMgPSB0aGlzLmNvbHVtblByb3BlcnR5KCdzZWxlY3RjZWxscycsIGNlbGxpbmRleCk7XG4gICAgc2VsZWN0Y2VsbHMgPSAoc2VsZWN0Y2VsbHMpID8gKChwYXJ0cykgPyBbcGFydHNbd2hhdHBhcnRdXSA6IHNlbGVjdGNlbGxzKSA6IG51bGw7XG4gICAgcmV0dXJuIHNlbGVjdGNlbGxzO1xuICB9XG5cbiAgcG9wdWxhdGVJbXBvcnRab25lKGFkZCwgaXRlbXMpIHtcbiAgICBpZiAoIXRoaXMuaW1wb3J0em9uZSkgcmV0dXJuO1xuICAgIGNvbnN0IHRzID0gdGhpcy5pbXBvcnR6b25lLnRvbXNlbGVjdDtcbiAgICBpZiAodHMpIHtcbiAgICAgIE9iamVjdC52YWx1ZXModHMub3B0aW9ucykuZm9yRWFjaCgob3B0KSA9PiB7XG4gICAgICAgIGxldCBvYmogPSB7fTtcbiAgICAgICAgb2JqW29wdFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXV0gPSBvcHRbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF07XG4gICAgICAgIGlmICghaXRlbXNbb3B0W3RzLnNldHRpbmdzLnZhbHVlRmllbGRdXSkgaXRlbXMgPSBPYmplY3QuYXNzaWduKGl0ZW1zLCBvYmopO1xuICAgICAgfSk7XG4gICAgICBpdGVtcyA9IE9iamVjdC5lbnRyaWVzKGl0ZW1zKTtcbiAgICAgIC8vIHNvcnQgaXRlbXNcbiAgICAgIGl0ZW1zLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgbGV0IHggPSBhWzFdO1xuICAgICAgICBsZXQgeSA9IGJbMV07XG4gICAgICAgIHJldHVybiArKHggPiB5KSB8fCAtKHkgPiB4KTtcbiAgICAgIH0pO1xuICAgICAgLy8gIHRzLmNsZWFyKCk7XG4gICAgICAvL3RzLmNsZWFyT3B0aW9ucygpO1xuICAgICAgLy8gYWRkIHRzIGl0ZW1zXG4gICAgICBpZiAoYWRkKSBpdGVtcy5mb3JFYWNoKChba2V5LCB0ZXh0XSkgPT4ge1xuICAgICAgICBpZiAodHMuZ2V0SXRlbShrZXkpID09PSBudWxsKSB7XG4gICAgICAgICAgaWYgKHRzLmdldE9wdGlvbihrZXkpID09PSBudWxsKSB7XG4gICAgICAgICAgICBsZXQgb2JqID0ge307XG4gICAgICAgICAgICBvYmpbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0gPSBrZXk7XG4gICAgICAgICAgICBvYmpbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSB1bmVzY2FwZV9odG1sKHRleHQudHJpbSgpKTtcbiAgICAgICAgICAgIHRzLmFkZE9wdGlvbihvYmopO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0cy5hZGRJdGVtKGtleSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgZWxzZSBpdGVtcy5mb3JFYWNoKChba2V5LCB0ZXh0XSkgPT4ge1xuICAgICAgICB0cy5yZW1vdmVJdGVtKGtleSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgT2JqZWN0LnZhbHVlcyh0aGlzLmltcG9ydHpvbmUub3B0aW9ucykuZm9yRWFjaChvcHQgPT4ge1xuICAgICAgICBsZXQgb2JqID0ge307XG4gICAgICAgIG9ialtvcHQudmFsdWVdID0gb3B0LnRleHQ7XG4gICAgICAgIGlmICghaXRlbXNbb3B0LnZhbHVlXSkgaXRlbXMgPSBPYmplY3QuYXNzaWduKGl0ZW1zLCBvYmopO1xuICAgICAgfSk7XG4gICAgICBpdGVtcyA9IE9iamVjdC5lbnRyaWVzKGl0ZW1zKTtcbiAgICAgIGl0ZW1zLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgbGV0IHggPSBhWzFdO1xuICAgICAgICBsZXQgeSA9IGJbMV07XG4gICAgICAgIHJldHVybiArKHggPiB5KSB8fCAtKHkgPiB4KTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5pbXBvcnR6b25lLmlubmVySFRNTCA9IGBgO1xuICAgICAgaWYgKGFkZCkgaXRlbXMuZm9yRWFjaCgoW2tleSwgdGV4dF0pID0+IHtcbiAgICAgICAgY29uc3Qgb3B0ID0gdGhpcy5pbXBvcnR6b25lLnF1ZXJ5U2VsZWN0b3IoJ29wdGlvblt2YWx1ZT1cIicgKyBrZXkgKyAnXCJdJyk7XG4gICAgICAgIGlmICghb3B0KSB7XG4gICAgICAgICAgY29uc3QgbyA9IGNyZWF0ZV9ib3goJ29wdGlvbicsIHtcbiAgICAgICAgICAgIHZhbHVlOiBrZXksXG4gICAgICAgICAgICBzZWxlY3RlZDogJ3NlbGVjdGVkJyxcbiAgICAgICAgICAgIHRleHQ6IHRleHRcbiAgICAgICAgICB9LCB0aGlzLmltcG9ydHpvbmUpO1xuICAgICAgICB9IGVsc2Ugb3B0LnNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgIH0pO1xuICAgICAgZWxzZSBpdGVtcy5mb3JFYWNoKChba2V5LCB0ZXh0XSkgPT4ge1xuICAgICAgICBjb25zdCBvcHQgPSB0aGlzLmltcG9ydHpvbmUucXVlcnlTZWxlY3Rvcignb3B0aW9uW3ZhbHVlPVwiJyArIGtleSArICdcIl0nKTtcbiAgICAgICAgaWYgKG9wdCkgb3B0LnJlbW92ZSgpOyAvLyBvciBvcHQuc2VsZWN0ZWQ9ZmFsc2U7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICB0b0ltcG9ydCh0ZCwgd2hhdHBhcnQgPSAwLCBhZGQgPSB0cnVlKSB7XG4gICAgLy8gY2VsbCB2YWx1ZXMgaW4ganNvbiAgLSBubyBwYXJzZVxuICAgIGlmICh0ZC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICd0ZCcpIHRkID0gdGQuY2xvc2VzdCgndGQnKTtcbiAgICBjb25zdCByb3dpbmRleCA9IHRoaXMucm93SW5kZXgodGQpO1xuICAgIGlmIChyb3dpbmRleCA9PT0gbnVsbCkgcmV0dXJuO1xuICAgIGxldCBzaG93YnRucyA9IHRydWU7XG4gICAgbGV0IGNvbnRhY3QgPSBudWxsO1xuICAgIGNvbnN0IGNlbGxpbmRleCA9IHRkLmNlbGxJbmRleDtcbiAgICBjb25zdCB3aGF0ID0gdGhpcy5jb2x1bW5Qcm9wZXJ0eSgnd2hhdCcsIGNlbGxpbmRleCk7XG4gICAgaWYgKCF3aGF0KSByZXR1cm47XG4gICAgY29uc3QgcGFydHMgPSB0aGlzLmNvbHVtblByb3BlcnR5KCdwYXJ0cycsIGNlbGxpbmRleCk7XG4gICAgY29uc3Qgc2VsZWN0Y2VsbHMgPSB0aGlzLmdldFNlbGVjdENlbGxzKGNlbGxpbmRleCwgd2hhdHBhcnQpO1xuICAgIGlmICghc2VsZWN0Y2VsbHMpIHJldHVybjtcbiAgICBpZiAoW3R5cGVpbXBvcnQuc2V0dGluZ3MsIHR5cGVpbXBvcnQucHJpdmlsZWdlc10uaW5kZXhPZih3aGF0KSA+PSAwKSB0aGlzLmltcG9ydHNbbW9kZWxzLmNvbnRhY3RdID0gdGhpcy5maW5kQ29udGFjdCh0aGlzLmRhdGFzW3Jvd2luZGV4XSk7XG4gICAgaWYgKFt0eXBlaW1wb3J0LnByb2plY3QsIHR5cGVpbXBvcnQudGF4bywgdHlwZWltcG9ydC5wcml2aWxlZ2VzXS5pbmRleE9mKHdoYXQpID49IDApIHRoaXMuY3JlYXRlSW1wb3J0em9uZSh3aGF0KTtcbiAgICB0aGlzLmFkZFJlc2V0QnV0dG9uKCk7XG4gICAgbGV0IHRzID0gbnVsbDtcbiAgICBzZWxlY3RjZWxscy5mb3JFYWNoKChuYW1lLCBpbmRleCkgPT4ge1xuICAgICAgaW5kZXggPSB0aGlzLmdyaWRDb2x1bW5JbmRleCgnbmFtZScsIG5hbWUpO1xuICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgY29uc3QgdGRpbmRleCA9IHRoaXMuY29sdW1uSW5kZXgoJ25hbWUnLCBuYW1lKTtcbiAgICAgICAgLy8gc2hvdyBpbXBvcnQgYnV0dG9ucyBpZiBpbXBvcnR6b25lXG4gICAgICAgIGNvbnN0IGNlbGwgPSAodGRpbmRleCA+PSAwKSA/IHRoaXMudHJzW3Jvd2luZGV4XS5jZWxsc1t0ZGluZGV4XSA6IG51bGw7XG4gICAgICAgIGlmIChjZWxsKSBjZWxsLmNsYXNzTGlzdC5hZGQoY3NzLnNlbGVjdGVkKTtcbiAgICAgICAgY29uc3Qgcm93ZGF0YSA9IHRoaXMuZGF0YXNbcm93aW5kZXhdO1xuICAgICAgICBjb25zdCBjZWxsZGF0YSA9IHJvd2RhdGFbaW5kZXhdO1xuICAgICAgICBjb25zdCB0aGNlbGwgPSAodGRpbmRleCA+PSAwKSA/IHRoaXMudGhjZWxsc1t0ZGluZGV4XSA6IG51bGw7XG4gICAgICAgIHN3aXRjaCAod2hhdCkge1xuICAgICAgICAgIGNhc2UgdHlwZWltcG9ydC50YXhvOlxuICAgICAgICAgICAgaWYgKCF0aGlzLmltcG9ydHpvbmUpIHJldHVybjtcbiAgICAgICAgICAgIC8vIGFjY3VtdWxhdGUgYW5kIHNob3cgaW4gaW1wb3J0IHdpbiAtIG1vdmUgdGhlIGZvcm0gZmllbGQgaW4gbW9kYWwgd2luIHRvIHZpZXcgdGhlIGNoYW5nZXMgYW5kIGJlbmVmaXQgb2YgdG9tLXNlbGVjdCBjb21wb25lbnQgZnVuY3RzLi4uXG4gICAgICAgICAgICB0cyA9IHRoaXMuaW1wb3J0em9uZS50b21zZWxlY3Q7XG4gICAgICAgICAgICBsZXQgdGF4b25zID0gY2VsbGRhdGE7XG4gICAgICAgICAgICBpZiAodGF4b25zKSB7XG4gICAgICAgICAgICAgIHRoaXMucG9wdWxhdGVJbXBvcnRab25lKGFkZCwgdGF4b25zKTtcbiAgICAgICAgICAgICAgc2hvd2J0bnMgPSAoT2JqZWN0LmtleXModGF4b25zKS5sZW5ndGggPiAwKTtcbiAgICAgICAgICAgICAgdGF4b25zID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgdHlwZWltcG9ydC5wcml2aWxlZ2VzOlxuICAgICAgICAgICAgY29uc3QgcHJpdnMgPSBjZWxsZGF0YTtcbiAgICAgICAgICAgIC8vIHNldCBldmVyeWJvZHkgdG8gJ3ZpZXcnIGlmIG1vcmUgdGhhbiBvbmUgcHJvamVjdCBpbXBvcnRlZFxuICAgICAgICAgICAgY29uc3QgcmVzZXRwcml2ID0gKCh0cyAmJiB0cy5pdGVtcy5sZW5ndGggPiAwKSB8fCAodGhpcy5pbXBvcnR6b25lLnNlbGVjdGVkSW5kZXggPiAwKSk7XG4gICAgICAgICAgICBpZiAoIXRoaXMuaW1wb3J0em9uZS50b21zZWxlY3QpIHtcbiAgICAgICAgICAgICAgdGhpcy5pbXBvcnR6b25lLmN1cnJlbnRsaXN0ID0ge307XG4gICAgICAgICAgICAgIEpzVG9tU2VsZWN0LmFwcGx5VG8odGhpcy5pbXBvcnR6b25lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRzID0gdGhpcy5pbXBvcnR6b25lLnRvbXNlbGVjdDtcbiAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHByaXZzKS5mb3JFYWNoKChbcHJpdiwgbWVtYmVyc10pID0+IHtcbiAgICAgICAgICAgICAgbWVtYmVycy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChiLm5hbWUgPiBhLm5hbWUpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgbWVtYmVycy5mb3JFYWNoKG1lbWJlciA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgbmV3cHJpdiA9IChyZXNldHByaXYpID8ga2V5X3ByaXZpbGVnZXMudmlld2VycyA6IHByaXY7IC8vIHZpZXdlciBpZiBtb3JlIHRoYW4gb25lIHByb2plY3QgaW1wb3J0ZWRcbiAgICAgICAgICAgICAgICBsZXQgb3B0O1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbXBvcnR6b25lLmN1cnJlbnRsaXN0IHx8ICF0aGlzLmltcG9ydHpvbmUuY3VycmVudGxpc3RbbWVtYmVyLmlkXSkge1xuICAgICAgICAgICAgICAgICAgaWYgKHRzKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdCA9IHRzLml0ZW1zLmluZGV4T2YobWVtYmVyLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgLy9UT0RPIC0gdGVzdCAtIG9wdCBzaG91bGQgYWx3YXlzIGJlIDBcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdCA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgdHMucmVtb3ZlSXRlbShtZW1iZXIuaWQpO1xuICAgICAgICAgICAgICAgICAgICAgIHRzLnJlbW92ZU9wdGlvbihtZW1iZXIuaWQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIGFkZG9wdGlvbiAmJiBhZGRJdGVtXG4gICAgICAgICAgICAgICAgICAgIG9wdCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICBvcHRncm91cDogbmV3cHJpdlxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG9wdFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSA9IG1lbWJlci5pZDtcbiAgICAgICAgICAgICAgICAgICAgb3B0W3RzLnNldHRpbmdzLnNlYXJjaEZpZWxkXSA9IG1lbWJlci5uYW1lO1xuICAgICAgICAgICAgICAgICAgICBvcHRbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSBtZW1iZXIubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgdHMuYWRkT3B0aW9uKG9wdCk7XG4gICAgICAgICAgICAgICAgICAgIHRzLmFkZEl0ZW0obWVtYmVyLmlkKTtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdCA9IHRoaXMuaW1wb3J0em9uZS5xdWVyeVNlbGVjdG9yKCdvcHRpb25bdmFsdWU9XCInICsgbWVtYmVyLmlkICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgICAgICBpZiAob3B0ID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgb3B0ID0gY3JlYXRlX2JveCgnb3B0aW9uJywge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG1lbWJlci5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFzZXQ6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0Z3JvdXA6IG5ld3ByaXZcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRTZWxlY3RlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IG1lbWJlci5uYW1lXG4gICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmltcG9ydHpvbmUuYWRkKG9wdCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBvcHQuZGF0YXNldC5vcHRncm91cCA9IG5ld3ByaXY7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgaWYgKHRzKSB0cy5yZWZyZXNoT3B0aW9ucyh0cnVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgc2hvd2J0bnMgPSAoKCh0cykgPyB0cy5pdGVtcy5sZW5ndGggOiB0aGlzLmltcG9ydHpvbmUuc2VsZWN0ZWRJbmRleCArIDEpID4gMCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIHR5cGVpbXBvcnQucHJvamVjdDpcbiAgICAgICAgICAgIGNvbnN0IGxuID0gT2JqZWN0LmtleXModGhpcy5pbXBvcnRzKS5sZW5ndGg7XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5pbXBvcnRzW25hbWVdKSB0aGlzLmltcG9ydHNbbmFtZV0gPSBbXTtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB0aGlzLmdldERhdGFUb0ltcG9ydChjZWxsLCBjZWxsZGF0YSk7XG4gICAgICAgICAgICBpZiAoYWRkKSB0aGlzLmltcG9ydHNbbmFtZV0ucHVzaChkYXRhKTtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICBjb25zdCBpZHggPSB0aGlzLmltcG9ydHNbbmFtZV0uaW5kZXhPZihkYXRhKTtcbiAgICAgICAgICAgICAgaWYgKGlkeCA+IC0xKSB0aGlzLmltcG9ydHNbbmFtZV0uc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobmFtZSA9PT0gbW9kZWxzLnByb2ppZCkge1xuICAgICAgICAgICAgICBjb25zdCBpZHggPSB0aGlzLmNvbHVtbkluZGV4KCduYW1lJywgJ3RpdGxlJyk7XG4gICAgICAgICAgICAgIC8vIHNob3cgaW1wb3J0IGJ1dHRvbnMgaWYgaW1wb3J0em9uZVxuICAgICAgICAgICAgICBjb25zdCBjZWxsbGFiZWwgPSAoaWR4ID49IDApID8gdGhpcy50cnNbcm93aW5kZXhdLmNlbGxzW2lkeF0gOiBudWxsO1xuICAgICAgICAgICAgICBjb25zdCBkYXRhbGFiZWwgPSByb3dkYXRhW2lkeF07XG4gICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gKGNlbGxsYWJlbCkgPyB0aGlzLmdldERhdGFUb0ltcG9ydChjZWxsbGFiZWwsIGRhdGFsYWJlbCkgOiBkYXRhO1xuICAgICAgICAgICAgICBjb25zdCBpdGVtcyA9IHt9O1xuICAgICAgICAgICAgICBpdGVtc1tyb3dkYXRhW3RoaXMudGJsLmdldENlbGxJZCh0aGlzLnRibC5jZWxsaWRuYW1lKV1dID0gbGFiZWw7XG4gICAgICAgICAgICAgIHRoaXMucG9wdWxhdGVJbXBvcnRab25lKGFkZCwgaXRlbXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGxuID09PSAwKSB7XG4gICAgICAgICAgICAgIGlmIChhZGQpIHRoaXMuZmlsdGVyQnlSZWNvcmQocm93ZGF0YSwgcm93aW5kZXgpO1xuICAgICAgICAgICAgICBlbHNlIHRoaXMucmVzZXRGaWx0ZXIoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICBpZiAoYWRkKSB0aGlzLmltcG9ydHNbbmFtZV0gPSB0aGlzLmdldERhdGFUb0ltcG9ydChjZWxsLCBjZWxsZGF0YSk7XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc3QgaWR4ID0gdGhpcy5pbXBvcnRzLmluZGV4T2YobmFtZSk7XG4gICAgICAgICAgICAgIGlmIChpZHggPiAtMSkgdGhpcy5pbXBvcnRzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfSk7XG4gICAgaWYgKHRoaXMudGhjZWxscy5sZW5ndGgpIHtcbiAgICAgIGlmICh0aGlzLmJ1dHRvbikge1xuICAgICAgICBjb25zdCBhY3RpdmF0ZSA9ICghdGhpcy5idXR0b24uZGF0YXNldC5hY3RpdmF0ZWQgJiYgKFt0eXBlaW1wb3J0LnRheG8sIHR5cGVpbXBvcnQucHJpdmlsZWdlcywgdHlwZWltcG9ydC5wcm9qZWN0XS5pbmRleE9mKHdoYXQpID49IDApKTtcbiAgICAgICAgdGhpcy5zaG93SW1wb3J0KHNob3didG5zKTtcbiAgICAgICAgaWYgKGFjdGl2YXRlKSB0aGlzLmFjdGl2YXRlQnV0dG9ucyh3aGF0LCBzZWxlY3RjZWxscyk7XG4gICAgICB9IGVsc2UgdGhpcy5tYWtlSW1wb3J0KG51bGwsIHNlbGVjdGNlbGxzLCB3aGF0LCB0cnVlKTtcbiAgICB9XG4gIH1cbiAgbWVzc2FnZVpvbmUoaXRlbSkge1xuICAgIGNvbnNvbGUubG9nKCdpdGVtbWVzc2FnZScsIGl0ZW0pO1xuICB9XG4gIGFjdGl2YXRlQnV0dG9ucyh3aGF0LCBzZWxlY3RjZWxscykge1xuICAgIHRoaXMuYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKGUpID0+IHtcbiAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBhd2FpdCB0aGlzLm1ha2VJbXBvcnQoZS5jdXJyZW50VGFyZ2V0LCBzZWxlY3RjZWxscywgd2hhdCwgdHJ1ZSk7XG4gICAgfSk7XG4gICAgdGhpcy5yZXBsYWNlYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKGUpID0+IHtcbiAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBhd2FpdCB0aGlzLm1ha2VJbXBvcnQoZS5jdXJyZW50VGFyZ2V0LCBzZWxlY3RjZWxscywgd2hhdCwgdHJ1ZSk7XG4gICAgfSk7XG4gICAgdGhpcy5idXR0b24uZGF0YXNldC5hY3RpdmF0ZWQgPSB0cnVlO1xuICAgIHRoaXMucmVwbGFjZWJ1dHRvbi5kYXRhc2V0LmFjdGl2YXRlZCA9IHRydWU7XG4gIH1cblxuICBmaW5kQ29udGFjdCh0ZHMsIG5hbWUgPSAnY29udGFjdCcpIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZ3JpZENvbHVtbkluZGV4KCduYW1lJywgbmFtZSk7XG4gICAgaWYgKGluZGV4ID49IDApIHJldHVybiB0ZHNbaW5kZXhdID8gdGRzW2luZGV4XSA6IG51bGw7XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHJlbmRlclByaXZpbGVnZXMocmVwbGFjZSA9IGZhbHNlKSB7XG4gICAgbGV0IHByaXZpbGVnZXMgPSB7fTtcbiAgICBjb25zdCB0em9uZSA9IHRoaXMuaW1wb3J0em9uZS50b21zZWxlY3Q7XG4gICAgY29uc3QgcHVzaHByaXYgPSAobWVtYmVyLCBwcml2KSA9PiB7XG4gICAgICBjb25zdCBvYmogPSB7XG4gICAgICAgIGlkOiBtZW1iZXIuaWQsXG4gICAgICAgIG5hbWU6IG1lbWJlci5uYW1lLFxuICAgICAgICBwcml2OiBwcml2XG4gICAgICB9XG4gICAgICBpZiAocHJpdmlsZWdlc1twcml2XSkgcHJpdmlsZWdlc1twcml2XS5wdXNoKG9iaik7XG4gICAgICBlbHNlIHByaXZpbGVnZXNbcHJpdl0gPSBbb2JqXTtcbiAgICB9XG5cbiAgICBpZiAodHpvbmUpIHtcbiAgICAgIGNvbnN0IG1lbWJlcnMgPSBbLi4udHpvbmUuaXRlbXNdO1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIHR6b25lLm9wdGlvbnMpO1xuICAgICAgbWVtYmVycy5mb3JFYWNoKG1lbWJlciA9PiB7XG4gICAgICAgIG1lbWJlciA9IG9wdGlvbnNbbWVtYmVyXTtcbiAgICAgICAgaWYgKG1lbWJlcikgcHVzaHByaXYobWVtYmVyLCBtZW1iZXIub3B0Z3JvdXApO1xuXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmltcG9ydHpvbmUub3B0aW9ucy5mb3JFYWNoKG1lbWJlciA9PiB7XG4gICAgICAgIGlmIChtZW1iZXIuc2VsZWN0ZWQpIHB1c2hwcml2KG1lbWJlciwgbWVtYmVyLmRhdGFzZXQub3B0Z3JvdXApO1xuICAgICAgfSlcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pbXBvcnRQcml2aWxlZ2VzKHByaXZpbGVnZXMsIHJlcGxhY2UpKSB7XG4gICAgICBpZiAodHpvbmUpIHtcbiAgICAgICAgdHpvbmUuY2xlYXIoKTtcbiAgICAgICAgdHpvbmUuY2xlYXJPcHRpb25zKCk7XG4gICAgICB9IGVsc2UgdGhpcy5pbXBvcnR6b25lLmlubmVySFRNTCA9IGBgO1xuXG4gICAgfVxuXG4gIH1cblxuICBpbXBvcnRQcml2aWxlZ2VzKHByaXZpbGVnZXMsIGNsZWFyID0gZmFsc2UpIHtcbiAgICBjb25zdCBwcm9qZWN0UHJpdmlsZWdlcyA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCcuJyArIGRvbXNlbGVjdG9ycy5jb21wb25lbnQucHJpdmlsZWdlcy5pZGVudCk7XG4gICAgaWYgKHByb2plY3RQcml2aWxlZ2VzID09PSBudWxsIHx8ICFwcm9qZWN0UHJpdmlsZWdlcy5qc3ByaXZpbGVnZXMpIHJldHVybjtcbiAgICBjb25zdCBpbXBvcnRlZHRhZyA9IChpbnB1dCkgPT4ge1xuICAgICAgdGhpcy5zZXRJbXBvcnRlZFRhZyhpbnB1dCwgbnVsbCk7XG4gICAgfVxuICAgIGNvbnN0IGRpc21pc3MgPSAoKSA9PiB7XG4gICAgICB0aGlzLmRpc21pc3MoKTtcbiAgICB9XG4gICAgY29uc3QgY29udGFjdCA9IChjbGVhciA9PT0gdHJ1ZSAmJiB0aGlzLmltcG9ydHNbbW9kZWxzLmNvbnRhY3RdKSA/IHRoaXMuaW1wb3J0c1ttb2RlbHMuY29udGFjdF0gOiBudWxsO1xuICAgIHJldHVybiAocHJvamVjdFByaXZpbGVnZXMuanNwcml2aWxlZ2VzLmltcG9ydFByaXZpbGVnZXMocHJpdmlsZWdlcywgY2xlYXIsIGNvbnRhY3QsIGltcG9ydGVkdGFnLCBkaXNtaXNzKSk7XG4gIH1cblxuICByZXNldFNlbGVjdG9yKHRyKSB7XG4gICAgY29uc3QgcmVzZXRzID0ge307XG4gICAgY29uc3QgYXBwZW5kX3Jlc2V0cyA9IChuYW1lLCB0ZCwgaSkgPT4ge1xuICAgICAgY29uc3Qgcm93aW5kZXggPSB0aGlzLnJvd0luZGV4KHRkKTtcbiAgICAgIGNvbnN0IGNlbGxkYXRhID0gdGhpcy5kYXRhc1tyb3dpbmRleF1baV07XG4gICAgICBjb25zdCBjZWxsID0gdGhpcy50cnNbcm93aW5kZXhdLmNlbGxzW2ldO1xuICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZ2V0RGF0YVRvSW1wb3J0KGNlbGwsIGNlbGxkYXRhKTtcbiAgICAgIGlmICghcmVzZXRzW25hbWVdKSByZXNldHNbbmFtZV0gPSBbZGF0YV07XG4gICAgICBlbHNlIGlmIChyZXNldHNbbmFtZV0uaW5kZXhPZihkYXRhKSA8IDApIHJlc2V0c1tuYW1lXS5wdXNoKGRhdGEpO1xuICAgIH1cbiAgICBjb25zdCBzZWxlY3RvcnMgPSB0ci5xdWVyeVNlbGVjdG9yQWxsKCdbJyArIHRoaXMuc2VsZWN0b3IgKyAnXSBidXR0b24sIFsnICsgdGhpcy5zZWxlY3RvciArICddIGlucHV0Jyk7XG4gICAgc2VsZWN0b3JzLmZvckVhY2goKHNlbGVjdG9yLCBpKSA9PiB7XG4gICAgICBpZiAoc2VsZWN0b3IuZGlzYWJsZWQpIHRoaXMuZGlzYWJsZVNlbGVjdG9yKHNlbGVjdG9yLCBmYWxzZSk7XG4gICAgICBjb25zdCBuYW1lID0gKHNlbGVjdG9yLnBhcmVudEVsZW1lbnQuZGF0YXNldC5uYW1lKSA/IHNlbGVjdG9yLnBhcmVudEVsZW1lbnQuZGF0YXNldC5uYW1lIDogbnVsbDtcbiAgICAgIGFwcGVuZF9yZXNldHMobmFtZSwgc2VsZWN0b3IucGFyZW50RWxlbWVudCwgaSk7XG4gICAgfSk7XG4gICAgdHIucXVlcnlTZWxlY3RvckFsbCgndGQuJyArIGNzcy5zZWxlY3RlZCkuZm9yRWFjaCgodGQsIGkpID0+IHtcbiAgICAgIHRkLmNsYXNzTGlzdC5yZW1vdmUoY3NzLnNlbGVjdGVkKTtcbiAgICAgIGFwcGVuZF9yZXNldHMobmFtZSwgdGQsIGkpO1xuICAgIH0pO1xuICAgIHJldHVybiByZXNldHM7XG4gIH1cblxuICByZXNldFNlbGVjdG9ycygpIHtcbiAgICB0aGlzLnNlbGVjdG9ycy5mb3JFYWNoKChzZWxlY3RvciwgaSkgPT4ge1xuICAgICAgaWYgKHNlbGVjdG9yLmRpc2FibGVkKSB0aGlzLmRpc2FibGVTZWxlY3RvcihzZWxlY3RvciwgZmFsc2UpO1xuICAgIH0pO1xuICAgIHRoaXMuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoJ3RkLicgKyBjc3Muc2VsZWN0ZWQpLmZvckVhY2godGQgPT4ge1xuICAgICAgdGQuY2xhc3NMaXN0LnJlbW92ZShjc3Muc2VsZWN0ZWQpO1xuICAgIH0pO1xuICB9XG4gIHJlc2V0SW1wb3J0cygpIHtcbiAgICB0aGlzLmltcG9ydHMgPSBbXTtcbiAgICBpZiAodGhpcy5pbXBvcnR6b25lKSB7XG4gICAgICBpZiAodGhpcy5pbXBvcnR6b25lLmN1cnJlbnRsaXN0KSB0aGlzLmltcG9ydHpvbmUuY3VycmVudGxpc3QgPSB7fTtcbiAgICAgIGlmICh0aGlzLmltcG9ydHpvbmUudG9tc2VsZWN0KSB0aGlzLmltcG9ydHpvbmUudG9tc2VsZWN0LmNsZWFyKCk7XG4gICAgICBlbHNlIHN3aXRjaCAodGhpcy5pbXBvcnR6b25lLnRhZ05hbWUudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICBjYXNlICdpbnB1dCc6XG4gICAgICAgICAgdGhpcy5pbXBvcnR6b25lLnZhbHVlID0gJyc7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ3NlbGVjdCc6XG4gICAgICAgICAgdGhpcy5pbXBvcnR6b25lLnNlbGVjdGVkSW5kZXggPSAtMTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhY3RpdmF0ZUNsZWFyKCkge1xuICAgIGNvbnN0IGNsZWFyYnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NsZWFyLScgKyB0aGlzLmltcG9ydGlkKTtcbiAgICBpZiAoIWNsZWFyYnV0dG9uKSByZXR1cm47XG4gICAgY2xlYXJidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xuICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGlmICghdGhpcy5pbXBvcnRjb250YWluZXIpIHJldHVybjtcbiAgICAgIHRoaXMucmVzZXRTZWxlY3RvcnMoKTtcbiAgICAgIHRoaXMucmVzZXRJbXBvcnRzKCk7XG4gICAgICB0aGlzLmJ1dHRvbi5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5yZXBsYWNlYnV0dG9uLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICB0aGlzLnNob3dJbXBvcnQoZmFsc2UpO1xuICAgIH0pO1xuICB9XG5cbiAgY3JlYXRlSW1wb3J0em9uZShuYW1lKSB7XG4gICAgdGhpcy5zaG93SW1wb3J0KHRydWUpO1xuICAgIGxldCB0cyA9IGZhbHNlO1xuICAgIGlmICghdGhpcy5pbXBvcnR6b25lKSB7XG4gICAgICBpZiAobmFtZSA9PT0gdHlwZWltcG9ydC5wcml2aWxlZ2VzKSB7XG4gICAgICAgIHRoaXMuaW1wb3J0em9uZSA9IGNyZWF0ZV9ib3goJ3NlbGVjdCcsIHtcbiAgICAgICAgICBpZDogdGhpcy5pbXBvcnRpZCxcbiAgICAgICAgICBkYXRhc2V0OiB7XG4gICAgICAgICAgICB0eXBlOiBtb2RlbHMudXNlcixcbiAgICAgICAgICAgIHByaXY6IHRydWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBtdWx0aXBsZTogdHJ1ZVxuICAgICAgICB9LCB0aGlzLmltcG9ydGNvbnRhaW5lcik7XG4gICAgICAgIHRzID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgaWYgKCF0aGlzLnRhcmdldGltcG9ydCkgcmV0dXJuO1xuICAgICAgICB0aGlzLmltcG9ydHpvbmVpZCA9IHRoaXMudGFyZ2V0aW1wb3J0LmlkO1xuICAgICAgICB0cyA9IHRoaXMudGFyZ2V0aW1wb3J0LnRvbXNlbGVjdDtcbiAgICAgICAgLy8gdG9tc2VsZWN0ID9cbiAgICAgICAgY29uc3QgaW1wb3J0em9uZSA9IHRoaXMudGFyZ2V0aW1wb3J0LmNsb25lTm9kZSgpO1xuICAgICAgICBpbXBvcnR6b25lLmNsYXNzTGlzdC5yZW1vdmUoY3NzLnRvbXNlbGVjdGVkKTtcbiAgICAgICAgaW1wb3J0em9uZS5jbGFzc0xpc3QucmVtb3ZlKGNzcy5oaWRkZW5hY2Nlc3NpYmxlKTtcbiAgICAgICAgLy8ga2VlcCBvcmlnaW5hbCBpZCB0byByZXBsYWNlIGRhdGEgb24gYXBwbHkgaW1wb3J0XG4gICAgICAgIGltcG9ydHpvbmUuZGF0YXNldC5vcmlnaW4gPSBpbXBvcnR6b25lLmlkO1xuICAgICAgICBpbXBvcnR6b25lLmlkID0gdGhpcy5pbXBvcnRpZDtcbiAgICAgICAgaW1wb3J0em9uZS5uYW1lID0gdGhpcy5pbXBvcnRpZCArICdfJyArIGltcG9ydHpvbmUubmFtZTtcbiAgICAgICAgdGhpcy5pbXBvcnRjb250YWluZXIucHJlcGVuZChpbXBvcnR6b25lKTtcbiAgICAgICAgdGhpcy5pbXBvcnR6b25lID0gaW1wb3J0em9uZTtcbiAgICAgICAgaWYgKHRzKSB7XG4gICAgICAgICAgSnNUb21TZWxlY3QuYXBwbHlUbyh0aGlzLmltcG9ydHpvbmUpO1xuICAgICAgICAgIHRzID0gdGhpcy5pbXBvcnR6b25lLnRvbXNlbGVjdDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHMpIHtcbiAgICAgICAgICB0cy5vbihcIml0ZW1fcmVtb3ZlXCIsICh2YWx1ZSwgaXRlbSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5pdGVtUmVtb3ZlKHZhbHVlLCBpdGVtKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmFjdGl2YXRlQ2xlYXIoKTtcbiAgICAgIH1cblxuICAgIH1cblxuICB9XG4gIGNsb25lSW1wb3J0KGJ0bikge1xuICAgIGNvbnN0IGltcG9ydF90YXJnZXQgPSB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignIycgKyB0aGlzLmltcG9ydHpvbmUuZGF0YXNldC5vcmlnaW4pO1xuICAgIGlmICghaW1wb3J0X3RhcmdldCkgcmV0dXJuIGZhbHNlO1xuICAgIGNvbnN0IHRzID0gaW1wb3J0X3RhcmdldC50b21zZWxlY3Q7XG4gICAgaWYgKHRzKSB7XG5cbiAgICAgIC8vIG9ubHkgaWYgcmVwbGFjZSBzcGVjaWZpZWRcbiAgICAgIGlmIChidG4uZGF0YXNldC5yZXBsYWNlICYmIGJ0bi5kYXRhc2V0LnJlcGxhY2UgPT09ICdyZXBsYWNlJykge1xuICAgICAgICB0cy5jbGVhcigpO1xuICAgICAgICB0cy5jbGVhck9wdGlvbnMoKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHR6b25lID0gdGhpcy5pbXBvcnR6b25lLnRvbXNlbGVjdDtcbiAgICAgIGNvbnN0IGl0ZW1zID0gWy4uLnR6b25lLml0ZW1zXTtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCB0em9uZS5vcHRpb25zKTtcbiAgICAgIGl0ZW1zLmZvckVhY2goKGUpID0+IHtcbiAgICAgICAgbGV0IGVsID0ge307XG4gICAgICAgIGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdID0gZTtcbiAgICAgICAgZWxbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSB1bmVzY2FwZV9odG1sKG9wdGlvbnNbZV1bdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0pO1xuICAgICAgICBlbFt0cy5zZXR0aW5ncy5zZWFyY2hGaWVsZF0gPSB1bmVzY2FwZV9odG1sKG9wdGlvbnNbZV1bdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0pO1xuICAgICAgICBpZiAodHMuZ2V0T3B0aW9uKGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdKSA9PT0gbnVsbCkgdHMuYWRkT3B0aW9uKGVsKTtcbiAgICAgICAgaWYgKHRzLmdldEl0ZW0oZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0pID09PSBudWxsKSB0cy5hZGRJdGVtKGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdKTtcbiAgICAgIH0pO1xuICAgICAgLy8gIHR6b25lLmNsZWFyT3B0aW9ucygpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoYnRuLmRhdGFzZXQucmVwbGFjZSAmJiBidG4uZGF0YXNldC5yZXBsYWNlID09PSAncmVwbGFjZScpIGltcG9ydF90YXJnZXQuaW5uZXJIVE1MID0gYGA7XG4gICAgICBpbXBvcnRfdGFyZ2V0LmlubmVySFRNTCA9IERPTVB1cmlmeS5zYW5pdGl6ZSh0aGlzLmltcG9ydHpvbmUuaW5uZXJIVE1MKTtcbiAgICAgIHRoaXMuaW1wb3J0em9uZS5pbm5lckhUTUwgPSBgYDtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBhc3luYyBtYWtlSW1wb3J0KGJ0biwgc2VsZWN0Y2VsbHMsIHdoYXQsIGNsb3NlID0gZmFsc2UpIHtcbiAgICBsZXQgZG9uZSA9IHRydWUsXG4gICAgICB0cyA9IG51bGw7XG5cbiAgICBzd2l0Y2ggKHdoYXQpIHtcbiAgICAgIGNhc2UgdHlwZWltcG9ydC50YXhvOlxuICAgICAgICBpZiAoIXRoaXMuaW1wb3J0em9uZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBkb25lID0gdGhpcy5jbG9uZUltcG9ydChidG4pO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgdHlwZWltcG9ydC5wcml2aWxlZ2VzOlxuICAgICAgICBpZiAoIXRoaXMuaW1wb3J0em9uZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBkb25lID0gdGhpcy5yZW5kZXJQcml2aWxlZ2VzKChidG4uZGF0YXNldC5yZXBsYWNlICYmIGJ0bi5kYXRhc2V0LnJlcGxhY2UgPT09ICdyZXBsYWNlJykpO1xuICAgICAgICBpZiAodGhpcy5pbXBvcnR6b25lLmN1cnJlbnRsaXN0KSB0aGlzLmltcG9ydHpvbmUuY3VycmVudGxpc3QgPSB7fTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIHR5cGVpbXBvcnQucHJvamVjdDpcbiAgICAgICAgaWYgKCF0aGlzLmltcG9ydHpvbmUpIHJldHVybiBmYWxzZTtcbiAgICAgICAgY29uc3QgbmV3b25lID0gKHRoaXMuZm9ybS5kYXRhc2V0LmlkKSA/IHBhcnNlSW50KHRoaXMuZm9ybS5kYXRhc2V0LmlkKSA6IDA7XG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLmNvbXBpbGVQcm9qZWN0UmVjb3JkcyhuZXdvbmUpO1xuICAgICAgICBkb25lID0gdGhpcy5jbG9uZUltcG9ydChidG4pO1xuICAgICAgICBjb25zdCBpZHggPSBzZWxlY3RjZWxscy5pbmRleE9mKG1vZGVscy5wcm9qaWQpO1xuICAgICAgICBpZiAoaWR4ID49IDApIHNlbGVjdGNlbGxzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICBbXCJjcmVhdG9yX3VzZXJzXCIsIFwiY3JlYXRvcl9vcmdhbmlzYXRpb25zXCIsIFwiY2xhc3NpZmZpZWxkbGlzdFwiLCBcInByaXZpbGVnZXNcIiwgXCJhY2Nlc3NcIiwgXCJzdGF0dXNcIiwgXCJjbm5fbmV0d29ya19pZFwiXS5mb3JFYWNoKHJlc3VsdCA9PiB7XG4gICAgICAgICAgdGhpcy5pbXBvcnRzW3Jlc3VsdF0gPSByZXN1bHRzW3Jlc3VsdF07XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmltcG9ydHNbXCJpbml0X2NsYXNzaWZfbGlzdFwiXSA9IHJlc3VsdHMuaW5pdGNsYXNzaWZsaXN0O1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgY29uc3QgdHNfYWRkX3NlbGVjdF9pdGVtID0gZnVuY3Rpb24odHMsIGRhdGEpIHtcbiAgICAgICAgICBjb25zdCBlbCA9IHt9O1xuICAgICAgICAgIGlmICh0eXBlb2YoZGF0YSkgPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLmxhYmVsRmllbGRdID0gdW5lc2NhcGVfaHRtbChkYXRhKTtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdID0gdW5lc2NhcGVfaHRtbChkYXRhKTtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLnNlYXJjaEZpZWxkXSA9IHVuZXNjYXBlX2h0bWwoZGF0YSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLmxhYmVsRmllbGRdID0gdW5lc2NhcGVfaHRtbChkYXRhLnZhbHVlKTtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdID0gZGF0YS5rZXk7XG4gICAgICAgICAgICBlbFt0cy5zZXR0aW5ncy5zZWFyY2hGaWVsZF0gPSB1bmVzY2FwZV9odG1sKGRhdGEudmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodHMuZ2V0T3B0aW9uKGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdKSA9PT0gbnVsbCkgdHMuYWRkT3B0aW9uKGVsKTtcbiAgICAgICAgICBpZiAodHMuZ2V0SXRlbShlbFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSkgPT09IG51bGwpIHRzLmFkZEl0ZW0oZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGFkZF9zZWxlY3Rfb3B0aW9uID0gZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHtcbiAgICAgICAgICBsZXQgYXR0ciA9IHtcbiAgICAgICAgICAgIHNlbGVjdGVkOiB0cnVlXG4gICAgICAgICAgfTtcbiAgICAgICAgICBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgYXR0ci52YWx1ZSA9IGF0dHIudGV4dCA9IGRhdGE7XG4gICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBhdHRyLnZhbHVlID0gZGF0YS5rZXk7XG4gICAgICAgICAgICBhdHRyLnRleHQgPSBkYXRhLnZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBvcHRpb24gPSBjcmVhdGVfYm94KCdvcHRpb24nLCBhdHRyLCBpbnB1dCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYWRkX2lucHV0X29wdGlvbiA9IGZ1bmN0aW9uKGlucHV0LCBkYXRhKSB7XG4gICAgICAgICAgaWYgKGlucHV0Lm11bHRpcGxlKSB7XG4gICAgICAgICAgICBsZXQgdmFsdWVzID0gaW5wdXQudmFsdWUuc3BsaXQoJywnKTtcbiAgICAgICAgICAgIHZhbHVlcy5wdXNoKGRhdGEua2V5KTtcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gdmFsdWVzLmpvaW4oJywnKTtcbiAgICAgICAgICB9IGVsc2UgaW5wdXQudmFsdWUgPSBkYXRhO1xuXG4gICAgICAgIH1cbiAgICAgICAgc2VsZWN0Y2VsbHMuZm9yRWFjaCgobmFtZSwgaW5kZXgpID0+IHtcbiAgICAgICAgICBsZXQgaW5wdXQgPSAoKHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbZGF0YS1pbXBvcnRmaWVsZD1cIicgKyBuYW1lICsgJ1wiXScpKSA/IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbZGF0YS1pbXBvcnRmaWVsZD1cIicgKyBuYW1lICsgJ1wiXScpIDogdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lPVwiJyArIG5hbWUgKyAnXCJdJykpO1xuICAgICAgICAgIGlmIChpbnB1dCAmJiBpbnB1dC5kYXRhc2V0Lm5vaW1wb3J0KSByZXR1cm47XG4gICAgICAgICAgaWYgKGlucHV0ICYmIHRoaXMuaW1wb3J0c1tuYW1lXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjb25zdCB0eXBlID0gKGlucHV0LnR5cGUpID8gaW5wdXQudHlwZSA6IGlucHV0LnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIHRzID0gaW5wdXQudG9tc2VsZWN0O1xuICAgICAgICAgICAgaWYgKFsnaW5pdF9jbGFzc2lmX2xpc3QnXS5pbmRleE9mKG5hbWUpID49IDApIHtcbiAgICAgICAgICAgICAgbGV0IGlkcyA9IHRoaXMuaW1wb3J0c1tuYW1lXTtcbiAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaWRzKSkgaWRzID0gaWRzLmpvaW4oJywnKTtcbiAgICAgICAgICAgICAgZWxzZSBpZHMgPSBpZHMucmVwbGFjZSgnWycsICcnKS5yZXBsYWNlKCddJywgJycpLnJlcGxhY2VBbGwoJyAnLCAnJyk7XG4gICAgICAgICAgICAgIGlmIChpZHMgIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRzKSB0cy53cmFwcGVyLmNsYXNzTGlzdC5hZGQoJ3dhaXQtZm9yLXJlc3VsdHMnKTtcbiAgICAgICAgICAgICAgICBsZXQgb3B0cyA9IGZldGNoU2V0dGluZ3MoKSxcbiAgICAgICAgICAgICAgICAgIHVybCA9ICcnO1xuICAgICAgICAgICAgICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdpZGxpc3QnLCBpZHMpO1xuICAgICAgICAgICAgICAgIHVybCA9ICcvc2VhcmNoL3RheG9yZXNvbHZlJyAvLysgbmV3IFVSTFNlYXJjaFBhcmFtcyh7J2lkbGlzdCc6IGlkc30pO1xuICAgICAgICAgICAgICAgIG9wdHMgPSBmZXRjaFNldHRpbmdzKHtcbiAgICAgICAgICAgICAgICAgICdtZXRob2QnOiAnUE9TVCcsXG4gICAgICAgICAgICAgICAgICAnYm9keSc6IGZvcm1EYXRhXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgZmV0Y2godXJsLCBvcHRzKS50aGVuKHJlc3BvbnNlID0+XG4gICAgICAgICAgICAgICAgICByZXNwb25zZS5qc29uKClcbiAgICAgICAgICAgICAgICApLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zdCB0cyA9IGlucHV0LnRvbXNlbGVjdDtcbiAgICAgICAgICAgICAgICAgIGlmICh0cykge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRzID0gT2JqZWN0LmVudHJpZXMocmVzdWx0cyk7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdHMuZm9yRWFjaCgoW2tleSwgdGV4dF0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogRE9NUHVyaWZ5LnNhbml0aXplKGtleSksXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogRE9NUHVyaWZ5LnNhbml0aXplKHRleHQpXG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIHRzX2FkZF9zZWxlY3RfaXRlbSh0cywgZWwpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgdHMud3JhcHBlci5jbGFzc0xpc3QucmVtb3ZlKCd3YWl0LWZvci1yZXN1bHRzJyk7XG4gICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUuaW5kZXhPZignc2VsZWN0JykgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaW5wdXQucXVlcnlTZWxlY3RvckFsbCgnb3B0aW9uJykuZm9yRWFjaChvcHRpb24gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbi5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHJlc3VsdHMpLmZvckVhY2goKFtrZXksIHRleHRdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBrZXk6IERPTVB1cmlmeS5zYW5pdGl6ZShrZXkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IERPTVB1cmlmeS5zYW5pdGl6ZSh0ZXh0KVxuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICBhZGRfaW5wdXRfb3B0aW9uKGlucHV0LCBlbCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBPYmplY3QuZW50cmllcyhyZXN1bHRzKS5mb3JFYWNoKChba2V5LCB0ZXh0XSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBET01QdXJpZnkuc2FuaXRpemUoa2V5KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBET01QdXJpZnkuc2FuaXRpemUodGV4dClcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgYWRkX3NlbGVjdF9vcHRpb24oaW5wdXQsIGVsKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICByZXN1bHRzID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgIHRoaXMuc2V0SW1wb3J0ZWRUYWcoaW5wdXQpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRzKSB7XG4gICAgICAgICAgICAgIGlmIChpbnB1dC5tdWx0aXBsZSkgdGhpcy5pbXBvcnRzW25hbWVdLmZvckVhY2goZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgdHNfYWRkX3NlbGVjdF9pdGVtKHRzLCBkYXRhKVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgZWxzZSB0c19hZGRfc2VsZWN0X2l0ZW0odHMsIHRoaXMuaW1wb3J0c1tuYW1lXSk7XG4gICAgICAgICAgICAgIHRoaXMuc2V0SW1wb3J0ZWRUYWcoaW5wdXQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICAgICAgICAgICAgY2FzZSAncmFkaW8nOlxuICAgICAgICAgICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHRvY2hlY2sgPSB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9XCInICsgbmFtZSArICdcIl1bdmFsdWU9XCInICsgdGhpcy5pbXBvcnRzW25hbWVdICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgICAgaWYgKHRvY2hlY2spIHRvY2hlY2suY2hlY2tlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QtbXVsdGlwbGUnOlxuICAgICAgICAgICAgICAgIGNhc2UgJ3NlbGVjdCc6XG4gICAgICAgICAgICAgICAgICBpZiAoaW5wdXQubXVsdGlwbGUpIHRoaXMuaW1wb3J0c1tuYW1lXS5mb3JFYWNoKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhZGRfc2VsZWN0X29wdGlvbihpbnB1dCwgZGF0YSk7XG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgIGVsc2UgYWRkX3NlbGVjdF9vcHRpb24oaW5wdXQsIHRoaXMuaW1wb3J0c1tuYW1lXSk7XG4gICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSB0aGlzLmltcG9ydHNbbmFtZV07XG4gICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB0aGlzLnNldEltcG9ydGVkVGFnKGlucHV0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh3aGF0ICE9PSB0eXBlaW1wb3J0LnNldHRpbmdzKSBpbnB1dC5mb2N1cygpO1xuICAgICAgICAgICAgZG9uZSA9IGRvbmUgJiYgdHJ1ZTtcblxuXG4gICAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSB0eXBlaW1wb3J0LnByaXZpbGVnZXMpIHtcbiAgICAgICAgICAgIC8vY29uc3QgY2xlYXJwcml2aWxlZ2VzID0gKHdoYXQgPT09IHR5cGVpbXBvcnQuc2V0dGluZ3MpO1xuICAgICAgICAgICAgY29uc3QgY2xlYXJwcml2aWxlZ2VzID0gZmFsc2U7XG4gICAgICAgICAgICBkb25lID0gZG9uZSAmJiB0aGlzLmltcG9ydFByaXZpbGVnZXModGhpcy5pbXBvcnRzW25hbWVdLCBjbGVhcnByaXZpbGVnZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBpZiAoZG9uZSA9PT0gdHJ1ZSAmJiBjbG9zZSA9PSB0cnVlKSB7XG4gICAgICB0aGlzLmRpc21pc3MoKTtcbiAgICAgIGlmICh0aGlzLmZvcm0pIHRoaXMuZm9ybS5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgndmFsaWRhdGUnKSk7XG4gICAgfVxuICB9XG5cbiAgc2V0SW1wb3J0ZWRUYWcoaW5wdXQsIHNlbGVjdG9yID0gZG9tc2VsZWN0b3JzLmNvbXBvbmVudC5mb3JtLmZvcm1ib3gpIHtcbiAgICBpZiAoaW5wdXQgPT09IG51bGwpIHJldHVybjtcbiAgICBsZXQgZWwgPSAoc2VsZWN0b3IgPT09IG51bGwpID8gaW5wdXQgOiAoKGlucHV0LmNsb3Nlc3Qoc2VsZWN0b3IpKSA/IGlucHV0LmNsb3Nlc3Qoc2VsZWN0b3IpIDogaW5wdXQuY2xvc2VzdCgnZmllbGRzZXQnKSk7XG4gICAgaWYgKCFlbCkgcmV0dXJuO1xuICAgIGNvbnN0IHJlbW92ZXRhZyA9IChlKSA9PiB7XG4gICAgICBkZWxldGUgZWwuZGF0YXNldC5pc2ltcG9ydGVkO1xuICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjc3MuaW1wb3J0ZWQpO1xuICAgICAgaW5wdXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgcmVtb3ZldGFnKTtcbiAgICB9XG4gICAgZWwuZGF0YXNldC5pc2ltcG9ydGVkID0gdGhpcy5mb3JtLmRhdGFzZXQuaXNpbXBvcnRlZDtcbiAgICBlbC5jbGFzc0xpc3QuYWRkKGNzcy5pbXBvcnRlZCk7XG4gICAgaWYgKGlucHV0LmRhdGFzZXQudW5pcXVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGlucHV0LmRhdGFzZXQudW5pcXVlID0gaW5wdXQudmFsdWU7XG4gICAgfVxuICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCByZW1vdmV0YWcpO1xuICAgIH0sIDUwMCk7XG4gIH1cblxuICBkaXNtaXNzKGNsZWFyID0gZmFsc2UpIHtcbiAgICBpZiAodGhpcy5idXR0b24pIHRoaXMuc2hvd0ltcG9ydChmYWxzZSk7XG4gICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5kb20uY2xvc2VzdCgnZGV0YWlscycpO1xuICAgIGlmIChjb250YWluZXIpIHtcbiAgICAgIGNvbnRhaW5lci5vcGVuID0gZmFsc2U7XG4gICAgICBpZiAoY2xlYXIgPT09IHRydWUpIGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKHRoaXMuY29udGVudF9zZWxlY3RvcikuaW5uZXJIVE1MID0gYGA7XG4gICAgfVxuXG4gIH1cbiAgaW5kZXhUb0NoZWNrKCkge1xuICAgIC8vIGluZGV4IG9mIGNlbGxzIHRvIGNoZWNrIGlmIGVtcHR5IGFuZCBkaXNhYmxlIHJvdyAgaW1wb3J0IGJ0blxuICAgIGNvbnN0IGdyaWQgPSAodGhpcy50YmwpID8gdGhpcy50YmwuZ3JpZCA6IG51bGw7XG4gICAgaWYgKCFncmlkKSByZXR1cm4gWzBdO1xuICAgIGxldCBpbmRleCA9IGdyaWQuY29sdW1ucy5maW5kSW5kZXgoY29sdW1uID0+IChjb2x1bW4ud2hhdCAmJiBjb2x1bW4ud2hhdCA9PT0gdHlwZWltcG9ydC50YXhvKSk7XG4gICAgaWYgKGluZGV4ID09PSAtMSkgcmV0dXJuIFswXTtcbiAgICBjb25zdCBwYXJ0cyA9IChncmlkLmNvbHVtbnNbaW5kZXhdLnBhcnRzKSA/IGdyaWQuY29sdW1uc1tpbmRleF0ucGFydHMgOiBudWxsO1xuICAgIGlmIChwYXJ0cykge1xuICAgICAgY29uc3QgaW5kZXh0b2NoZWNrID0gZ3JpZC5jb2x1bW5zLmZpbHRlcigoY29sdW1uLCBpKSA9PiB7XG4gICAgICAgIGlmIChwYXJ0cy5pbmRleE9mKGNvbHVtbi5uYW1lKSA+PSAwKSByZXR1cm4gaTtcbiAgICAgIH0pLm1hcCh2ID0+IHtcbiAgICAgICAgcmV0dXJuIHYuaW5kZXg7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBpbmRleHRvY2hlY2s7XG4gICAgfVxuXG4gIH1cbiAgYWRkUmVzZXRCdXR0b24oKSB7XG4gICAgaWYgKCF0aGlzLnRibCB8fCAhdGhpcy50YmwucGFyYW1zLmhhc093blByb3BlcnR5KFwicmVzZXRcIikpIHJldHVybjtcbiAgICBsZXQgcmVzZXRidG4gPSB0aGlzLmRvbS5wYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoZG9tc2VsZWN0b3JzLnJlc2V0YnV0dG9uKTtcbiAgICBpZiAocmVzZXRidG4gPT09IG51bGwpIHtcbiAgICAgIHJlc2V0YnRuID0gY3JlYXRlX2JveCgnYScsIHtcbiAgICAgICAgY2xhc3M6IGRvbXNlbGVjdG9ycy5yZXNldGJ1dHRvbi5zdWJzdHIoMSksXG4gICAgICAgIHRleHQ6IHRoaXMudGJsLnBhcmFtcy5yZXNldFxuICAgICAgfSwgdGhpcy5kb20ucGFyZW50RWxlbWVudC5maXJzdENoaWxkKTtcbiAgICB9XG4gICAgcmVzZXRidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgIHRoaXMucmVzZXRTZWxlY3RvcnMoKTtcbiAgICAgIHRoaXMucmVzZXRJbXBvcnRzKCk7XG4gICAgfSk7XG5cbiAgfVxuICAvLyBzaG93IC8gaGlkZSBpbXBvcnR6b25lIGFuZCBidXR0b25zXG4gIHNob3dJbXBvcnQoc2hvdykge1xuICAgIGlmICghdGhpcy5idXR0b24pIHJldHVybjtcbiAgICBpZiAoc2hvdyA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMuYnV0dG9uLmNsYXNzTGlzdC5hZGQoY3NzLmhpZGUpO1xuICAgICAgdGhpcy5yZXBsYWNlYnV0dG9uLmNsYXNzTGlzdC5hZGQoY3NzLmhpZGUpO1xuICAgICAgdGhpcy5pbXBvcnRjb250YWluZXIuY2xhc3NMaXN0LmFkZChjc3MuaGlkZSk7XG4gICAgICBpZiAodGhpcy50YWJidXR0b24pIHRoaXMudGFiYnV0dG9uLmNsYXNzTGlzdC5hZGQoY3NzLmhpZGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5pbXBvcnR6b25lKSB7XG4gICAgICAgIHRoaXMuYnV0dG9uLmNsYXNzTGlzdC5yZW1vdmUoY3NzLmhpZGUpO1xuICAgICAgICB0aGlzLnJlcGxhY2VidXR0b24uY2xhc3NMaXN0LnJlbW92ZShjc3MuaGlkZSk7XG4gICAgICAgIHRoaXMuaW1wb3J0Y29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoY3NzLmhpZGUpO1xuICAgICAgICB0aGlzLmJ1dHRvbi5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICBpZiAodGhpcy50YWJidXR0b24pIHtcbiAgICAgICAgICB0aGlzLnRhYmJ1dHRvbi5jbGFzc0xpc3QucmVtb3ZlKGNzcy5oaWRlKTtcbiAgICAgICAgICBpZiAodGhpcy5pbXBvcnR6b25lLnRvbXNlbGVjdCkge1xuICAgICAgICAgICAgdGhpcy50YWJidXR0b24uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICB9IGVsc2UgdGhpcy50YWJidXR0b24uZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gIH1cbiAgLy8gcmVzaXplIGltcG9ydHpvbmVcbiAgcmVzaXplWm9uZShlKSB7XG4gICAgY29uc3QgZGl2ID0gdGhpcy5pbXBvcnRjb250YWluZXIuY2xvc2VzdChkb21zZWxlY3RvcnMuY29tcG9uZW50LmltcG9ydC56b25laW1wb3J0KTtcbiAgICBpZiAoIWRpdikgcmV0dXJuO1xuICAgIGRpdi5wYXJlbnRFbGVtZW50LmNsYXNzTGlzdC50b2dnbGUoY3NzLnNob3dmdWxsKTtcbiAgICBjb25zdCBpY29uID0gZS5jdXJyZW50VGFyZ2V0LnF1ZXJ5U2VsZWN0b3IoJ2knKTtcbiAgICBpZiAoaWNvbikge1xuICAgICAgaWNvbi5jbGFzc0xpc3QudG9nZ2xlKGNzcy5hcnJvd291dCk7XG4gICAgICBpY29uLmNsYXNzTGlzdC50b2dnbGUoY3NzLmFycm93aW4pO1xuICAgIH1cbiAgfVxufSJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///./src/modules/data-import.js\n")}}]);