/*! For license information please see src_modules_data-import_js.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["src_modules_data-import_js"],{"./src/modules/data-import.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   DataImport: () => (/* binding */ DataImport)\n/* harmony export */ });\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! dompurify */ \"./node_modules/dompurify/dist/purify.js\");\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(dompurify__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _modules_module_tom_select_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../modules/module-tom-select.js */ \"./src/modules/module-tom-select.js\");\n/* harmony import */ var _modules_project_privileges_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../modules/project-privileges.js */ \"./src/modules/project-privileges.js\");\n/* harmony import */ var _modules_utils_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../modules/utils.js */ \"./src/modules/utils.js\");\n/* harmony import */ var _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../modules/modules-config.js */ \"./src/modules/modules-config.js\");\n\n\n\n\n\n\nconst key_privileges = Object.keys(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.defined_privileges).reduce(function(result, key) {\n  result[key] = key;\n  return result;\n}, {});\nlet instance;\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported = 'imported';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.tomselected = 'tomselected';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hiddenaccessible = 'ts-hidden-accessible';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowout = 'icon-arrow-pointing-out';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowin = 'icon-arrow-pointing-in';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton = '.import-list-reset';\nclass DataImport {\n  content_selector = '.modal-content';\n  imports = [];\n  taxos = [\"preset\", \"extra\"];\n  importcontainer;\n  importzoneid;\n  importid = 'importzone';\n  selectors;\n  button;\n  clearbutton;\n  replacebutton;\n  tabbutton;\n  tbl = null;\n  constructor(tbl, what = null, selector = null) {\n    if (!tbl) return;\n    // tbl is a TableComponent  ?\n    this.tbl = (typeof(tbl) === 'object') ? tbl : null;\n    selector = (selector === null) ? ((this.tbl.cellidname) ? \"data-\" + this.tbl.cellidname : \"data-id\") : selector;\n    // get the table from table component or html table element id\n    this.dom = (this.tbl) ? this.tbl.dom : document.getElementById(tbl);\n    if (!this.dom) return;\n    what = (what) ? dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(what) : (tbl && tbl.params && tbl.params.import) ? tbl.params.import : (this.dom.dataset.import) ? dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(this.dom.dataset.import) : null;\n    if (!instance || instance.doc !== this.dom) {\n      // defaultoptions - keep like that\n\n      const options = {\n        importcontainer: '#data-import-' + what,\n        btns: '.btns-imports',\n        button: '#add-import-' + what,\n        replacebutton: '#replace-import-' + what,\n        tabbutton: '#tab-import-' + what,\n      };\n      this.selector = selector;\n\n      this.importcontainer = options.importcontainer instanceof HTMLElement ? options.importcontainer : document.querySelector(options.importcontainer);\n      this.form = (options.form) ? ((options.form) instanceof HTMLElement ? options.form : document.querySelector(options.form)) : this.dom.closest('form');\n      this.button = options.button instanceof HTMLElement ? options.button : document.querySelector(options.button);\n      this.replacebutton = options.replacebutton instanceof HTMLElement ? options.replacebutton : document.querySelector(options.replacebutton);\n      this.tabbutton = options.tabbutton instanceof HTMLElement ? options.tabbutton : document.querySelector(options.tabbutton);\n      this.importid = this.importid + '_' + what;\n      this.init(options);\n      instance = this;\n\n    }\n    return instance;\n  }\n\n  init(options) {\n    // hide importzone\n    this.showImport(false);\n    // remove line of target proj\n    let projid = this.form.querySelector('#' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.projid);\n    if (projid && projid.value) {\n      projid = this.dom.querySelector('[' + this.selector + '=\"' + projid.value + '\"]');\n      if (projid) projid.hidden = true;\n    }\n    const indextocheck = this.indexToCheck();\n    this.selectors = this.dom.querySelectorAll('[' + this.selector + '] button, [' + this.selector + '] input');\n    this.selectors.forEach(selector => {\n      // checkbox possible\n      const index = Array.from(selector.parentElement.children).indexOf((selector));\n      if (indextocheck && selector.closest('tr').children[indextocheck[index]].innerHTML === '') selector.disabled = true;\n      else {\n        const evt = (selector.tagName.toLowerCase() === 'input') ? 'change' : 'click';\n        const apply_selection = (e) => {\n          e.preventDefault();\n          e.stopImmediatePropagation();\n          const target = e.currentTarget;\n          target.disabled = true;\n          this.toImport(target.parentElement, index);\n        };\n        selector.removeEventListener(evt, apply_selection, false);\n        selector.addEventListener(evt, apply_selection, false);\n      };\n    });\n    if (this.tabbutton) {\n      this.tabbutton.addEventListener('click', (e) => {\n        e.stopImmediatePropagation();\n        e.preventDefault();\n        this.resizeZone(e);\n      });\n    }\n  }\n  columnProperty(name, index, th) {\n    if (this.tbl) return (this.tbl.grid.columns[index].hasOwnProperty(name)) ? this.tbl.grid.columns[index][name] : null;\n    else return (th.dataset[name]) ? th.dataset.name : null;\n  }\n  columnIndex(prop, value) {\n    return Array.from(this.dom.querySelectorAll('thead th')).findIndex(th => (th.dataset[prop] && th.dataset[prop] === value));\n  }\n  gridColumnIndex(prop, value) {\n    if (this.tbl) return this.tbl.grid.columns.findIndex(column => (column.hasOwnProperty(prop) && column[prop] === value));\n    else return this.columnIndex(prop, value);\n  }\n  rowIndex(td, trs) {\n    const ref = (td.parentElement) ? td.parentElement : null;\n    if (!ref) return null;\n    return trs.findIndex(tr => (tr === ref));\n  }\n  toImport(td, whatpart = 0) {\n    const grid = (this.tbl) ? this.tbl.grid : null;\n    const thcells = Array.from(this.dom.querySelectorAll('thead th'));\n    const trs = Array.from(this.dom.querySelectorAll('tbody tr'));\n    const datas = (grid) ? grid.data : trs.map(tr => {\n      return Array.from(tr.childNodes).forEach(cell => {\n        return cell.innerText;\n      });\n    }); // cell values in json  - no parse\n    if (td.tagName.toLowerCase() !== 'td') td = td.closest('td');\n    const rowindex = this.rowIndex(td, trs);\n    if (rowindex === null) return;\n    let showbtns = true;\n    const cellindex = td.cellIndex;\n    const th = thcells[cellindex];\n    const tds = trs[rowindex];\n    const what = this.columnProperty('what', cellindex, th);\n    if (!what) return;\n    const parts = this.columnProperty('parts', cellindex, th);\n    let contact = null;\n    let selectcells = this.columnProperty('selectcells', cellindex, th);\n    selectcells = (selectcells) ? ((parts) ? [parts[whatpart]] : selectcells) : null;\n    if (!selectcells) return;\n    if (what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.settings || what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact] = this.findContact(datas[rowindex]);\n    const importzone = (what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo || what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) ? this.createImportzone(what) : null;\n\n    this.addResetButton();\n    let ts = null;\n    selectcells.forEach((name, index) => {\n      index = this.gridColumnIndex('name', name);\n      if (index >= 0) {\n        const tdindex = this.columnIndex('name', name);\n        // show import buttons if importzone\n        const cell = (tdindex >= 0) ? trs[rowindex].cells[tdindex] : null;\n        if (cell) cell.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n        const celldata = datas[rowindex][index];\n        const thcell = (tdindex >= 0) ? thcells[tdindex] : null;\n        switch (what) {\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo:\n            if (!importzone) return;\n            // accumulate and show in import win - move the form field in modal win to view the changes and benefit of tom-select component functs...\n            ts = importzone.tomselect;\n            let taxons = celldata;\n            if (taxons) {\n              if (ts) {\n                // merge taxons and options - unique\n                Object.values(ts.options).forEach((opt) => {\n                  let obj = {};\n                  obj[opt[ts.settings.valueField]] = opt[ts.settings.labelField];\n                  if (!taxons[opt[ts.settings.valueField]]) taxons = Object.assign(taxons, obj);\n                });\n                taxons = Object.entries(taxons);\n                // sort taxons\n                taxons.sort((a, b) => {\n                  let x = a[1];\n                  let y = b[1];\n                  return +(x > y) || -(y > x);\n                });\n                ts.clear();\n                ts.clearOptions();\n                // add taxons items\n                taxons.forEach(([key, text]) => {\n                  if (!ts.getItem(key)) {\n                    if (!ts.getOption(key)) {\n                      let obj = {};\n                      obj[ts.settings.valueField] = key;\n                      obj[ts.settings.labelField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(text.trim());\n                      ts.addOption(obj);\n                    }\n                    ts.addItem(key);\n                  }\n                });\n              } else {\n                Object.values(importzone.options).forEach(opt => {\n                  let obj = {};\n                  obj[opt.value] = opt.text;\n                  if (!taxons[opt.value]) taxons = Object.assign(taxons, obj);\n                });\n                taxons = Object.entries(taxons);\n                taxons.sort((a, b) => {\n                  let x = a[1];\n                  let y = b[1];\n                  return +(x > y) || -(y > x);\n                });\n                importzone.innerHTML = ``;\n                taxons.forEach(([key, text]) => {\n                  if (!importzone.querySelector('option[value=\"' + key + '\"]')) {\n                    const o = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', {\n                      value: key,\n                      selected: 'selected',\n                      text: text\n                    }, importzone);\n                  }\n                });\n              }\n              showbtns = (taxons.length > 0);\n              taxons = null;\n            }\n\n            break;\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges:\n            const privs = celldata;\n            // set everybody to 'view' if more than one project imported\n            const resetpriv = ((ts && ts.items.length > 0) || (importzone.selectedIndex > 0));\n            if (!importzone.tomselect) {\n              importzone.currentlist = {};\n              const jsTomSelect = (0,_modules_module_tom_select_js__WEBPACK_IMPORTED_MODULE_1__.JsTomSelect)();\n              jsTomSelect.applyTo(importzone);\n            }\n            ts = importzone.tomselect;\n            Object.entries(privs).forEach(([priv, members]) => {\n              members.sort((a, b) => {\n                return (b.name > a.name);\n              });\n              members.forEach(member => {\n                const newpriv = (resetpriv) ? key_privileges.viewers : priv; // viewer if more than one project imported\n                let opt;\n                if (!importzone.currentlist || !importzone.currentlist[member.id]) {\n                  if (ts) {\n                    opt = ts.items.indexOf(member.id);\n                    //TODO - test - opt should always be 0\n                    if (opt >= 0) {\n                      ts.removeItem(member.id);\n                      ts.removeOption(member.id);\n                    }\n                    // addoption && addItem\n                    opt = {\n                      optgroup: newpriv\n                    }\n                    opt[ts.settings.valueField] = member.id;\n                    opt[ts.settings.searchField] = member.name;\n                    opt[ts.settings.labelField] = member.name;\n                    ts.addOption(opt);\n                    ts.addItem(member.id);\n                  } else {\n                    opt = importzone.querySelector('option[value=\"' + member.id + '\"]');\n                    if (opt === null) {\n                      opt = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', {\n                        value: member.id,\n                        dataset: {\n                          optgroup: newpriv\n                        },\n                        selected: true,\n                        defaultSelected: true,\n                        text: member.name\n                      })\n                      /*  opt = document.createElement('option');\n                        opt.value = member.id;\n                        opt.dataset.optgroup = newpriv;\n                        opt.selected = opt.defaultSelected = true;\n                        opt.text = member.name;*/\n                      importzone.add(opt);\n                    } else opt.dataset.optgroup = newpriv;\n                  }\n                }\n              });\n              if (ts) ts.refreshOptions(true);\n            });\n\n            showbtns = (((ts) ? ts.items.length : importzone.selectedIndex + 1) > 0);\n\n\n            break;\n          default:\n            this.imports[name] = celldata;\n            if (cell !== null) {\n              if (cell.dataset.autocomplete) {\n                // select elements where key / value in different columns\n                this.imports[name] = {\n                  value: celldata,\n                  key: null\n                };\n                let el = null;\n                thcells.every((t, idx) => {\n                  if (t.dataset.name == thcell.dataset.autocomplete) {\n                    el = idx;\n                    return false;\n                  }\n                  return true;\n                });\n                if (el !== null) {\n                  el = datas[rowindex][el];\n\n                  this.imports[name].key = el;\n                }\n              } else if (cell.dataset.value) this.imports[name] = cell.dataset.value;\n\n            }\n\n            break;\n        }\n      };\n    });\n\n    if (thcells.length) {\n      if (this.button) {\n        const activate = (!this.button.dataset.activated && (what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo || what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges));\n        this.showImport(showbtns);\n        if (activate) this.activateButtons(what, selectcells);\n      } else this.makeImport(null, selectcells, what, true);\n    }\n    //\n\n  }\n  messageZone(item) {\n    console.log('itemmessage', item);\n  }\n  activateButtons(what, selectcells) {\n\n    this.button.addEventListener('click', (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      this.makeImport(e.currentTarget, selectcells, what, true);\n\n    });\n    this.replacebutton.addEventListener('click', (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      this.makeImport(e.currentTarget, selectcells, what, true);\n\n    });\n\n    this.button.dataset.activated = true;\n    this.replacebutton.dataset.activated = true;\n  }\n\n  findContact(tds, name = 'contact') {\n    const index = this.gridColumnIndex('name', name);\n    if (index >= 0) return tds[index] ? tds[index] : null;\n\n    return null;\n  }\n\n  renderPrivileges(importzone, replace = false) {\n    let privileges = {};\n    const tzone = importzone.tomselect;\n\n    const pushpriv = (member, priv) => {\n      const obj = {\n        id: member.id,\n        name: member.name,\n        priv: priv\n      }\n      if (privileges[priv]) privileges[priv].push(obj);\n      else privileges[priv] = [obj];\n    }\n\n    if (tzone) {\n      const members = [...tzone.items];\n      const options = Object.assign({}, tzone.options);\n      members.forEach(member => {\n        member = options[member];\n        if (member) pushpriv(member, member.optgroup);\n\n      })\n    } else {\n      importzone.options.forEach(member => {\n        if (member.selected) pushpriv(member, member.dataset.optgroup);\n      })\n    }\n\n    if (this.importPrivileges(privileges, replace)) {\n      if (tzone) {\n        tzone.clear();\n        tzone.clearOptions();\n      } else importzone.innerHTML = ``;\n\n    }\n\n  }\n\n  importPrivileges(privileges, clear = false) {\n    const projectPrivileges = this.form.querySelector('.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.privileges.ident);\n\n    if (projectPrivileges === null || !projectPrivileges.jsprivileges) return;\n    const importedtag = (input) => {\n      this.setImportedTag(input, null);\n    }\n    const dismiss = () => {\n      this.dismiss();\n    }\n    const contact = (clear === true && this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact]) ? this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact] : null;\n    return (projectPrivileges.jsprivileges.importPrivileges(privileges, clear, contact, importedtag, dismiss));\n  }\n\n  resetSelectors() {\n    this.selectors.forEach((selector, i) => {\n      if (selector.disabled) selector.disabled = false;\n    });\n    this.dom.querySelectorAll('td.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected).forEach(td => {\n      td.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n    });\n  }\n\n  activateClear() {\n    const clearbutton = document.getElementById('clear-' + this.importid);\n    if (!clearbutton) return;\n    clearbutton.addEventListener('click', (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      if (!this.importcontainer) return;\n      this.resetSelectors();\n      this.button.disabled = false;\n      this.replacebutton.disabled = false;\n      this.showImport(false);\n    });\n  }\n  createImportzone(name) {\n    let importzone = this.showImport(true),\n      ts = false;\n    if (!importzone) {\n      if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) {\n        importzone = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('select', {\n          id: this.importid,\n          dataset: {\n            type: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.user,\n            priv: true,\n          },\n          multiple: true\n        }, this.importcontainer);\n        importzone = document.getElementById(this.importid);\n        ts = true;\n      } else {\n        const import_target = (this.form.querySelector('[name=\"' + name + '\"]')) ? this.form.querySelector('[name=\"' + name + '\"]') : this.form.querySelector('[data-importfield=\"' + name + '\"]');\n        if (!import_target) return;\n        ts = import_target.tomselect;\n        this.importzoneid = import_target.id;\n        // tomselect ?\n        importzone = import_target.cloneNode();\n        importzone.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.tomselected);\n        importzone.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hiddenaccessible);\n        // keep original id to replace data on apply import\n        importzone.dataset.origin = importzone.id;\n        importzone.id = this.importid;\n        importzone.name = this.importid + '_' + importzone.name;\n        this.importcontainer.prepend(importzone);\n        if (ts) {\n          const jsTomSelect = (0,_modules_module_tom_select_js__WEBPACK_IMPORTED_MODULE_1__.JsTomSelect)();\n          jsTomSelect.applyTo(importzone);\n        }\n        this.activateClear();\n      }\n\n    }\n    return importzone;\n\n  }\n\n  makeImport(btn, selectcells, what, close = false) {\n    let done = true,\n      ts = null;\n    const importzone = (this.importcontainer) ? this.importcontainer.querySelector('#' + this.importid) : null;\n\n    switch (what) {\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo:\n\n        if (!importzone) return false;\n        const import_target = this.form.querySelector('#' + importzone.dataset.origin);\n\n        if (!import_target) return false;\n        ts = import_target.tomselect;\n        if (ts) {\n          // only if replace specified\n          if (btn.dataset.replace && btn.dataset.replace === 'replace') {\n            ts.clear();\n            ts.clearOptions();\n          }\n          const tzone = importzone.tomselect;\n          const items = [...tzone.items];\n          const options = Object.assign({}, tzone.options);\n          items.forEach((e, i) => {\n            let el = {};\n            el[ts.settings.valueField] = e;\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(options[e][ts.settings.searchField]);\n            if (!ts.getOption(e)) ts.addOption(el);\n            ts.addItem(e);\n          });\n          tzone.clear();\n          tzone.clearOptions();\n        } else {\n          if (btn.dataset.replace && btn.dataset.replace === 'replace') import_target.innerHTML = ``;\n          import_target.innerHTML = dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(importzone.innerHTML);\n          importzone.innerHTML = ``;\n        }\n        done = true;\n        break;\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges:\n        if (!importzone) return false;\n        done = this.renderPrivileges(importzone, (btn.dataset.replace && btn.dataset.replace === 'replace'));\n        if (importzone.currentlist) importzone.currentlist = {};\n        break;\n      default:\n        const ts_add_select_item = function(ts, data) {\n          const el = {};\n          if (typeof(data) == 'string') {\n            el[ts.settings.labelField] = data;\n            el[ts.settings.valueField] = data;\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data);\n          } else {\n            el[ts.settings.labelField] = data.key;\n            el[ts.settings.valueField] = data.key;\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data.value);\n          }\n          if (!ts.getOption(el[ts.settings.valueField])) ts.addOption(el);\n          if (!ts.getItem(el[ts.settings.valueField])) ts.addItem(el[ts.settings.valueField]);\n        }\n        const add_select_option = function(input, data) {\n          let attr = {\n            selected: true\n          };\n          if (typeof(data) === 'string') attr.value = attr.text = data;\n          else {\n            attr.value = data.key;\n            attr.text = data.value;\n          }\n          const option = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', attr, input);\n\n        }\n        const add_input_option = function(input, data) {\n          if (input.multiple) {\n            let values = input.value.split(',');\n            values.push(data.key);\n            input.value = values.join(',');\n          } else input.value = data;\n\n        }\n        selectcells.forEach((name, index) => {\n          let input = ((this.form.querySelector('[data-importfield=\"' + name + '\"]')) ? this.form.querySelector('[data-importfield=\"' + name + '\"]') : this.form.querySelector('[name=\"' + name + '\"]'));\n          if (input && input.dataset.noimport) return;\n          if (input && this.imports[name] !== undefined) {\n            const type = (input.type) ? input.type : input.tagName.toLowerCase();\n            ts = input.tomselect;\n            if (name === 'init_classif_list') {\n              let ids = this.imports[name];\n              if (Array.isArray(ids)) ids = ids.join(',');\n              else ids = ids.replace('[', '').replace(']', '').replaceAll(' ', '');\n              if (ts) {\n                ts.wrapper.classList.add('wait-for-results');\n                ts.clear(false);\n                ts.clearOptions();\n              }\n              if (ids !== '') {\n                if (ts) ts.wrapper.classList.add('wait-for-results');\n                const formData = new FormData();\n                formData.append('idlist', ids);\n                const url = '/search/taxoresolve' //+ new URLSearchParams({'idlist': ids});\n                fetch(url, (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.fetchSettings)({\n                  'method': 'POST',\n                  'body': formData\n                })).then(response =>\n                  response.json()\n                ).then(results => {\n                  const ts = input.tomselect;\n                  if (ts) {\n\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      ts_add_select_item(ts, el);\n                    });\n                    ts.wrapper.classList.remove('wait-for-results');\n                  } else if (type.indexOf('select') === 0) {\n\n                    input.querySelectorAll('option').forEach(option => {\n                      option.remove();\n                    });\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      add_input_option(input, el);\n                    });\n\n                  } else {\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(text)\n                      }\n                      add_select_option(input, el);\n                    });\n\n                  }\n\n                  results = null;\n                  this.setImportedTag(input);\n                });\n              }\n            } else if (ts) {\n              ts_add_select_item(ts, this.imports[name]);\n              this.setImportedTag(input);\n            } else {\n              switch (type) {\n                case 'radio':\n                case 'checkbox':\n                  input = this.form.querySelector('[name=\"' + name + '\"][value=\"' + this.imports[name] + '\"]');\n                  if (input) input.checked = true;\n                  break;\n                case 'select':\n                  if (input.multiple) this.imports[name].forEach(data => {\n                    add_select_option(input, data)\n                  });\n                  else add_select_option(input, this.imports[name]);\n\n                  break;\n                default:\n                  input.value = this.imports[name];\n                  break;\n              }\n              this.setImportedTag(input);\n            }\n            if (what !== _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.settings) input.focus();\n            done = done && true;\n            // set imported tag to fieldbox\n\n\n          } else if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) {\n            //const clearprivileges = (what === typeimport.settings);\n            const clearprivileges = false;\n            done = done && this.importPrivileges(this.imports[name], clearprivileges);\n          }\n        });\n        break;\n    }\n    if (done === true && close == true) {\n      this.dismiss();\n      if (this.form) this.form.dispatchEvent(new CustomEvent('validate'));\n    }\n  }\n\n  setImportedTag(input, selector = _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.form.formbox) {\n    let el = (selector === null) ? input : (input.closest(selector) ? input.closest(selector) : input.closest('fieldset'));\n    if (!el) return;\n    const removetag = (e) => {\n      delete el.dataset.isimported;\n      el.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported);\n      input.removeEventListener('change', removetag);\n    }\n    el.dataset.isimported = this.form.dataset.isimported;\n    el.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported);\n    if (input.dataset.unique !== undefined) {\n      input.dataset.unique = input.value;\n    }\n    setTimeout(function() {\n      input.addEventListener('change', removetag);\n    }, 500);\n  }\n\n  dismiss(clear = false) {\n    if (this.button) this.showImport(false);\n    const container = this.dom.closest('details');\n    if (container) {\n      container.open = false;\n      if (clear === true) container.querySelector(this.content_selector).innerHTML = ``;\n    }\n\n  }\n  indexToCheck() {\n    // index of cells to check if empty and disable row  import btn\n    const grid = (this.tbl) ? this.tbl.grid : null;\n    if (!grid) return [0];\n    let index = grid.columns.findIndex(column => (column.what && column.what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo));\n    if (index === -1) return [0];\n    const parts = (grid.columns[index].parts) ? grid.columns[index].parts : null;\n    if (parts) {\n      const indextocheck = grid.columns.filter((column, i) => {\n        if (parts.indexOf(column.name) >= 0) return i;\n      }).map(v => {\n        return v.index;\n      });\n      return indextocheck;\n    }\n\n  }\n  addResetButton() {\n    if (!this.tbl || !this.tbl.params.hasOwnProperty(\"reset\")) return;\n    let resetbtn = this.dom.parentElement.querySelector(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton);\n    if (resetbtn === null) {\n      resetbtn = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('a', {\n        class: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton.substr(1),\n        text: this.tbl.params.reset\n      }, this.dom.parentElement.firstChild);\n      /*  resetbtn = document.createElement('a');\n        resetbtn.classList.add(domselectors.resetbutton.substr(1));\n        resetbtn.textContent = this.tbl.params.reset;\n        this.dom.parentElement.firstChild.prepend(resetbtn);*/\n    }\n    resetbtn.addEventListener('click', (e) => {\n      e.preventDefault();\n      e.stopImmediatePropagation();\n      const selectors = this.selectors = this.dom.querySelectorAll('[' + this.selector + '] button:disabled, [' + this.selector + '] input:disabled');\n      selectors.forEach(selector => {\n        selector.disabled = false;\n        const sel = selector.closest('tr').querySelector('.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n        if (sel) sel.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n      });\n    });\n\n  }\n  // show / hide importzone and buttons\n  showImport(show) {\n    if (!this.button) return;\n    if (show === false) {\n      this.button.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.replacebutton.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.importcontainer.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      if (this.tabbutton) this.tabbutton.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n    } else {\n      const importzone = this.importcontainer.querySelector('#' + this.importid);\n      if (importzone) {\n        //  const offseth = importzone.tomselect.control.offsetHeight;\n        //  const scrollh = importzone.tomselect.control.scrollHeight;\n        this.button.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.replacebutton.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.importcontainer.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.button.disabled = false;\n        if (this.tabbutton) {\n          this.tabbutton.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n          if (importzone.tomselect) {\n            this.tabbutton.disabled = false;\n          } else this.tabbutton.disabled = true;\n        }\n      }\n      return importzone;\n    }\n    return null;\n  }\n  // resize importzone\n  resizeZone(e) {\n    const div = this.importcontainer.closest(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.import.zoneimport);\n    if (!div) return;\n    div.parentElement.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.showfull);\n    const icon = e.currentTarget.querySelector('i');\n    if (icon) {\n      icon.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowout);\n      icon.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowin);\n    }\n  }\n}//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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NkRBQVU7QUFDM0IsZUFBZSxvRUFBWTtBQUMzQjtBQUNBLE9BQU87QUFDUDtBQUNBO0FBQ0E7QUFDQSw0REFBNEQ7QUFDNUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwrREFBK0QsMkRBQUc7QUFDbEUsc0NBQXNDLDJEQUFHO0FBQ3pDLE9BQU87QUFDUCxLQUFLOztBQUVMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnQ0FBZ0MsMkRBQUc7QUFDbkMsdUNBQXVDLDJEQUFHO0FBQzFDLHlDQUF5QywyREFBRztBQUM1Qyx1REFBdUQsMkRBQUc7QUFDMUQsTUFBTTtBQUNOO0FBQ0E7QUFDQTtBQUNBO0FBQ0EscUNBQXFDLDJEQUFHO0FBQ3hDLDRDQUE0QywyREFBRztBQUMvQyw4Q0FBOEMsMkRBQUc7QUFDakQ7QUFDQTtBQUNBLDBDQUEwQywyREFBRztBQUM3QztBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2Q0FBNkMsb0VBQVk7QUFDekQ7QUFDQSx1Q0FBdUMsMkRBQUc7QUFDMUM7QUFDQTtBQUNBLDRCQUE0QiwyREFBRztBQUMvQiw0QkFBNEIsMkRBQUc7QUFDL0I7QUFDQTtBQUNBIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vLy4vc3JjL21vZHVsZXMvZGF0YS1pbXBvcnQuanM/ODBhMiJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRE9NUHVyaWZ5IGZyb20gJ2RvbXB1cmlmeSc7XG5pbXBvcnQge1xuICBKc1RvbVNlbGVjdFxufSBmcm9tIFwiLi4vbW9kdWxlcy9tb2R1bGUtdG9tLXNlbGVjdC5qc1wiO1xuaW1wb3J0IHtcbiAgUHJvamVjdFByaXZpbGVnZXNcbn0gZnJvbSAnLi4vbW9kdWxlcy9wcm9qZWN0LXByaXZpbGVnZXMuanMnO1xuaW1wb3J0IHtcbiAgZmV0Y2hTZXR0aW5ncyxcbiAgdW5lc2NhcGVfaHRtbCxcbiAgY3JlYXRlX2JveFxufSBmcm9tICcuLi9tb2R1bGVzL3V0aWxzLmpzJztcblxuaW1wb3J0IHtcbiAgbW9kZWxzLFxuICB0eXBlaW1wb3J0LFxuICBjc3MsXG4gIGRlZmluZWRfcHJpdmlsZWdlcyxcbiAgZG9tc2VsZWN0b3JzXG59IGZyb20gJy4uL21vZHVsZXMvbW9kdWxlcy1jb25maWcuanMnO1xuY29uc3Qga2V5X3ByaXZpbGVnZXMgPSBPYmplY3Qua2V5cyhkZWZpbmVkX3ByaXZpbGVnZXMpLnJlZHVjZShmdW5jdGlvbihyZXN1bHQsIGtleSkge1xuICByZXN1bHRba2V5XSA9IGtleTtcbiAgcmV0dXJuIHJlc3VsdDtcbn0sIHt9KTtcbmxldCBpbnN0YW5jZTtcbmNzcy5pbXBvcnRlZCA9ICdpbXBvcnRlZCc7XG5jc3MudG9tc2VsZWN0ZWQgPSAndG9tc2VsZWN0ZWQnO1xuY3NzLmhpZGRlbmFjY2Vzc2libGUgPSAndHMtaGlkZGVuLWFjY2Vzc2libGUnO1xuY3NzLmFycm93b3V0ID0gJ2ljb24tYXJyb3ctcG9pbnRpbmctb3V0JztcbmNzcy5hcnJvd2luID0gJ2ljb24tYXJyb3ctcG9pbnRpbmctaW4nO1xuZG9tc2VsZWN0b3JzLnJlc2V0YnV0dG9uID0gJy5pbXBvcnQtbGlzdC1yZXNldCc7XG5leHBvcnQgY2xhc3MgRGF0YUltcG9ydCB7XG4gIGNvbnRlbnRfc2VsZWN0b3IgPSAnLm1vZGFsLWNvbnRlbnQnO1xuICBpbXBvcnRzID0gW107XG4gIHRheG9zID0gW1wicHJlc2V0XCIsIFwiZXh0cmFcIl07XG4gIGltcG9ydGNvbnRhaW5lcjtcbiAgaW1wb3J0em9uZWlkO1xuICBpbXBvcnRpZCA9ICdpbXBvcnR6b25lJztcbiAgc2VsZWN0b3JzO1xuICBidXR0b247XG4gIGNsZWFyYnV0dG9uO1xuICByZXBsYWNlYnV0dG9uO1xuICB0YWJidXR0b247XG4gIHRibCA9IG51bGw7XG4gIGNvbnN0cnVjdG9yKHRibCwgd2hhdCA9IG51bGwsIHNlbGVjdG9yID0gbnVsbCkge1xuICAgIGlmICghdGJsKSByZXR1cm47XG4gICAgLy8gdGJsIGlzIGEgVGFibGVDb21wb25lbnQgID9cbiAgICB0aGlzLnRibCA9ICh0eXBlb2YodGJsKSA9PT0gJ29iamVjdCcpID8gdGJsIDogbnVsbDtcbiAgICBzZWxlY3RvciA9IChzZWxlY3RvciA9PT0gbnVsbCkgPyAoKHRoaXMudGJsLmNlbGxpZG5hbWUpID8gXCJkYXRhLVwiICsgdGhpcy50YmwuY2VsbGlkbmFtZSA6IFwiZGF0YS1pZFwiKSA6IHNlbGVjdG9yO1xuICAgIC8vIGdldCB0aGUgdGFibGUgZnJvbSB0YWJsZSBjb21wb25lbnQgb3IgaHRtbCB0YWJsZSBlbGVtZW50IGlkXG4gICAgdGhpcy5kb20gPSAodGhpcy50YmwpID8gdGhpcy50YmwuZG9tIDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGJsKTtcbiAgICBpZiAoIXRoaXMuZG9tKSByZXR1cm47XG4gICAgd2hhdCA9ICh3aGF0KSA/IERPTVB1cmlmeS5zYW5pdGl6ZSh3aGF0KSA6ICh0YmwgJiYgdGJsLnBhcmFtcyAmJiB0YmwucGFyYW1zLmltcG9ydCkgPyB0YmwucGFyYW1zLmltcG9ydCA6ICh0aGlzLmRvbS5kYXRhc2V0LmltcG9ydCkgPyBET01QdXJpZnkuc2FuaXRpemUodGhpcy5kb20uZGF0YXNldC5pbXBvcnQpIDogbnVsbDtcbiAgICBpZiAoIWluc3RhbmNlIHx8IGluc3RhbmNlLmRvYyAhPT0gdGhpcy5kb20pIHtcbiAgICAgIC8vIGRlZmF1bHRvcHRpb25zIC0ga2VlcCBsaWtlIHRoYXRcblxuICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgaW1wb3J0Y29udGFpbmVyOiAnI2RhdGEtaW1wb3J0LScgKyB3aGF0LFxuICAgICAgICBidG5zOiAnLmJ0bnMtaW1wb3J0cycsXG4gICAgICAgIGJ1dHRvbjogJyNhZGQtaW1wb3J0LScgKyB3aGF0LFxuICAgICAgICByZXBsYWNlYnV0dG9uOiAnI3JlcGxhY2UtaW1wb3J0LScgKyB3aGF0LFxuICAgICAgICB0YWJidXR0b246ICcjdGFiLWltcG9ydC0nICsgd2hhdCxcbiAgICAgIH07XG4gICAgICB0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7XG5cbiAgICAgIHRoaXMuaW1wb3J0Y29udGFpbmVyID0gb3B0aW9ucy5pbXBvcnRjb250YWluZXIgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMuaW1wb3J0Y29udGFpbmVyIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLmltcG9ydGNvbnRhaW5lcik7XG4gICAgICB0aGlzLmZvcm0gPSAob3B0aW9ucy5mb3JtKSA/ICgob3B0aW9ucy5mb3JtKSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ID8gb3B0aW9ucy5mb3JtIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLmZvcm0pKSA6IHRoaXMuZG9tLmNsb3Nlc3QoJ2Zvcm0nKTtcbiAgICAgIHRoaXMuYnV0dG9uID0gb3B0aW9ucy5idXR0b24gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMuYnV0dG9uIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLmJ1dHRvbik7XG4gICAgICB0aGlzLnJlcGxhY2VidXR0b24gPSBvcHRpb25zLnJlcGxhY2VidXR0b24gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMucmVwbGFjZWJ1dHRvbiA6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iob3B0aW9ucy5yZXBsYWNlYnV0dG9uKTtcbiAgICAgIHRoaXMudGFiYnV0dG9uID0gb3B0aW9ucy50YWJidXR0b24gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMudGFiYnV0dG9uIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLnRhYmJ1dHRvbik7XG4gICAgICB0aGlzLmltcG9ydGlkID0gdGhpcy5pbXBvcnRpZCArICdfJyArIHdoYXQ7XG4gICAgICB0aGlzLmluaXQob3B0aW9ucyk7XG4gICAgICBpbnN0YW5jZSA9IHRoaXM7XG5cbiAgICB9XG4gICAgcmV0dXJuIGluc3RhbmNlO1xuICB9XG5cbiAgaW5pdChvcHRpb25zKSB7XG4gICAgLy8gaGlkZSBpbXBvcnR6b25lXG4gICAgdGhpcy5zaG93SW1wb3J0KGZhbHNlKTtcbiAgICAvLyByZW1vdmUgbGluZSBvZiB0YXJnZXQgcHJvalxuICAgIGxldCBwcm9qaWQgPSB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignIycgKyBkb21zZWxlY3RvcnMucHJvamlkKTtcbiAgICBpZiAocHJvamlkICYmIHByb2ppZC52YWx1ZSkge1xuICAgICAgcHJvamlkID0gdGhpcy5kb20ucXVlcnlTZWxlY3RvcignWycgKyB0aGlzLnNlbGVjdG9yICsgJz1cIicgKyBwcm9qaWQudmFsdWUgKyAnXCJdJyk7XG4gICAgICBpZiAocHJvamlkKSBwcm9qaWQuaGlkZGVuID0gdHJ1ZTtcbiAgICB9XG4gICAgY29uc3QgaW5kZXh0b2NoZWNrID0gdGhpcy5pbmRleFRvQ2hlY2soKTtcbiAgICB0aGlzLnNlbGVjdG9ycyA9IHRoaXMuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoJ1snICsgdGhpcy5zZWxlY3RvciArICddIGJ1dHRvbiwgWycgKyB0aGlzLnNlbGVjdG9yICsgJ10gaW5wdXQnKTtcbiAgICB0aGlzLnNlbGVjdG9ycy5mb3JFYWNoKHNlbGVjdG9yID0+IHtcbiAgICAgIC8vIGNoZWNrYm94IHBvc3NpYmxlXG4gICAgICBjb25zdCBpbmRleCA9IEFycmF5LmZyb20oc2VsZWN0b3IucGFyZW50RWxlbWVudC5jaGlsZHJlbikuaW5kZXhPZigoc2VsZWN0b3IpKTtcbiAgICAgIGlmIChpbmRleHRvY2hlY2sgJiYgc2VsZWN0b3IuY2xvc2VzdCgndHInKS5jaGlsZHJlbltpbmRleHRvY2hlY2tbaW5kZXhdXS5pbm5lckhUTUwgPT09ICcnKSBzZWxlY3Rvci5kaXNhYmxlZCA9IHRydWU7XG4gICAgICBlbHNlIHtcbiAgICAgICAgY29uc3QgZXZ0ID0gKHNlbGVjdG9yLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lucHV0JykgPyAnY2hhbmdlJyA6ICdjbGljayc7XG4gICAgICAgIGNvbnN0IGFwcGx5X3NlbGVjdGlvbiA9IChlKSA9PiB7XG4gICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgY29uc3QgdGFyZ2V0ID0gZS5jdXJyZW50VGFyZ2V0O1xuICAgICAgICAgIHRhcmdldC5kaXNhYmxlZCA9IHRydWU7XG4gICAgICAgICAgdGhpcy50b0ltcG9ydCh0YXJnZXQucGFyZW50RWxlbWVudCwgaW5kZXgpO1xuICAgICAgICB9O1xuICAgICAgICBzZWxlY3Rvci5yZW1vdmVFdmVudExpc3RlbmVyKGV2dCwgYXBwbHlfc2VsZWN0aW9uLCBmYWxzZSk7XG4gICAgICAgIHNlbGVjdG9yLmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCBhcHBseV9zZWxlY3Rpb24sIGZhbHNlKTtcbiAgICAgIH07XG4gICAgfSk7XG4gICAgaWYgKHRoaXMudGFiYnV0dG9uKSB7XG4gICAgICB0aGlzLnRhYmJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5yZXNpemVab25lKGUpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIGNvbHVtblByb3BlcnR5KG5hbWUsIGluZGV4LCB0aCkge1xuICAgIGlmICh0aGlzLnRibCkgcmV0dXJuICh0aGlzLnRibC5ncmlkLmNvbHVtbnNbaW5kZXhdLmhhc093blByb3BlcnR5KG5hbWUpKSA/IHRoaXMudGJsLmdyaWQuY29sdW1uc1tpbmRleF1bbmFtZV0gOiBudWxsO1xuICAgIGVsc2UgcmV0dXJuICh0aC5kYXRhc2V0W25hbWVdKSA/IHRoLmRhdGFzZXQubmFtZSA6IG51bGw7XG4gIH1cbiAgY29sdW1uSW5kZXgocHJvcCwgdmFsdWUpIHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCd0aGVhZCB0aCcpKS5maW5kSW5kZXgodGggPT4gKHRoLmRhdGFzZXRbcHJvcF0gJiYgdGguZGF0YXNldFtwcm9wXSA9PT0gdmFsdWUpKTtcbiAgfVxuICBncmlkQ29sdW1uSW5kZXgocHJvcCwgdmFsdWUpIHtcbiAgICBpZiAodGhpcy50YmwpIHJldHVybiB0aGlzLnRibC5ncmlkLmNvbHVtbnMuZmluZEluZGV4KGNvbHVtbiA9PiAoY29sdW1uLmhhc093blByb3BlcnR5KHByb3ApICYmIGNvbHVtbltwcm9wXSA9PT0gdmFsdWUpKTtcbiAgICBlbHNlIHJldHVybiB0aGlzLmNvbHVtbkluZGV4KHByb3AsIHZhbHVlKTtcbiAgfVxuICByb3dJbmRleCh0ZCwgdHJzKSB7XG4gICAgY29uc3QgcmVmID0gKHRkLnBhcmVudEVsZW1lbnQpID8gdGQucGFyZW50RWxlbWVudCA6IG51bGw7XG4gICAgaWYgKCFyZWYpIHJldHVybiBudWxsO1xuICAgIHJldHVybiB0cnMuZmluZEluZGV4KHRyID0+ICh0ciA9PT0gcmVmKSk7XG4gIH1cbiAgdG9JbXBvcnQodGQsIHdoYXRwYXJ0ID0gMCkge1xuICAgIGNvbnN0IGdyaWQgPSAodGhpcy50YmwpID8gdGhpcy50YmwuZ3JpZCA6IG51bGw7XG4gICAgY29uc3QgdGhjZWxscyA9IEFycmF5LmZyb20odGhpcy5kb20ucXVlcnlTZWxlY3RvckFsbCgndGhlYWQgdGgnKSk7XG4gICAgY29uc3QgdHJzID0gQXJyYXkuZnJvbSh0aGlzLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCd0Ym9keSB0cicpKTtcbiAgICBjb25zdCBkYXRhcyA9IChncmlkKSA/IGdyaWQuZGF0YSA6IHRycy5tYXAodHIgPT4ge1xuICAgICAgcmV0dXJuIEFycmF5LmZyb20odHIuY2hpbGROb2RlcykuZm9yRWFjaChjZWxsID0+IHtcbiAgICAgICAgcmV0dXJuIGNlbGwuaW5uZXJUZXh0O1xuICAgICAgfSk7XG4gICAgfSk7IC8vIGNlbGwgdmFsdWVzIGluIGpzb24gIC0gbm8gcGFyc2VcbiAgICBpZiAodGQudGFnTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAndGQnKSB0ZCA9IHRkLmNsb3Nlc3QoJ3RkJyk7XG4gICAgY29uc3Qgcm93aW5kZXggPSB0aGlzLnJvd0luZGV4KHRkLCB0cnMpO1xuICAgIGlmIChyb3dpbmRleCA9PT0gbnVsbCkgcmV0dXJuO1xuICAgIGxldCBzaG93YnRucyA9IHRydWU7XG4gICAgY29uc3QgY2VsbGluZGV4ID0gdGQuY2VsbEluZGV4O1xuICAgIGNvbnN0IHRoID0gdGhjZWxsc1tjZWxsaW5kZXhdO1xuICAgIGNvbnN0IHRkcyA9IHRyc1tyb3dpbmRleF07XG4gICAgY29uc3Qgd2hhdCA9IHRoaXMuY29sdW1uUHJvcGVydHkoJ3doYXQnLCBjZWxsaW5kZXgsIHRoKTtcbiAgICBpZiAoIXdoYXQpIHJldHVybjtcbiAgICBjb25zdCBwYXJ0cyA9IHRoaXMuY29sdW1uUHJvcGVydHkoJ3BhcnRzJywgY2VsbGluZGV4LCB0aCk7XG4gICAgbGV0IGNvbnRhY3QgPSBudWxsO1xuICAgIGxldCBzZWxlY3RjZWxscyA9IHRoaXMuY29sdW1uUHJvcGVydHkoJ3NlbGVjdGNlbGxzJywgY2VsbGluZGV4LCB0aCk7XG4gICAgc2VsZWN0Y2VsbHMgPSAoc2VsZWN0Y2VsbHMpID8gKChwYXJ0cykgPyBbcGFydHNbd2hhdHBhcnRdXSA6IHNlbGVjdGNlbGxzKSA6IG51bGw7XG4gICAgaWYgKCFzZWxlY3RjZWxscykgcmV0dXJuO1xuICAgIGlmICh3aGF0ID09PSB0eXBlaW1wb3J0LnNldHRpbmdzIHx8IHdoYXQgPT09IHR5cGVpbXBvcnQucHJpdmlsZWdlcykgdGhpcy5pbXBvcnRzW21vZGVscy5jb250YWN0XSA9IHRoaXMuZmluZENvbnRhY3QoZGF0YXNbcm93aW5kZXhdKTtcbiAgICBjb25zdCBpbXBvcnR6b25lID0gKHdoYXQgPT09IHR5cGVpbXBvcnQudGF4byB8fCB3aGF0ID09PSB0eXBlaW1wb3J0LnByaXZpbGVnZXMpID8gdGhpcy5jcmVhdGVJbXBvcnR6b25lKHdoYXQpIDogbnVsbDtcblxuICAgIHRoaXMuYWRkUmVzZXRCdXR0b24oKTtcbiAgICBsZXQgdHMgPSBudWxsO1xuICAgIHNlbGVjdGNlbGxzLmZvckVhY2goKG5hbWUsIGluZGV4KSA9PiB7XG4gICAgICBpbmRleCA9IHRoaXMuZ3JpZENvbHVtbkluZGV4KCduYW1lJywgbmFtZSk7XG4gICAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgICBjb25zdCB0ZGluZGV4ID0gdGhpcy5jb2x1bW5JbmRleCgnbmFtZScsIG5hbWUpO1xuICAgICAgICAvLyBzaG93IGltcG9ydCBidXR0b25zIGlmIGltcG9ydHpvbmVcbiAgICAgICAgY29uc3QgY2VsbCA9ICh0ZGluZGV4ID49IDApID8gdHJzW3Jvd2luZGV4XS5jZWxsc1t0ZGluZGV4XSA6IG51bGw7XG4gICAgICAgIGlmIChjZWxsKSBjZWxsLmNsYXNzTGlzdC5hZGQoY3NzLnNlbGVjdGVkKTtcbiAgICAgICAgY29uc3QgY2VsbGRhdGEgPSBkYXRhc1tyb3dpbmRleF1baW5kZXhdO1xuICAgICAgICBjb25zdCB0aGNlbGwgPSAodGRpbmRleCA+PSAwKSA/IHRoY2VsbHNbdGRpbmRleF0gOiBudWxsO1xuICAgICAgICBzd2l0Y2ggKHdoYXQpIHtcbiAgICAgICAgICBjYXNlIHR5cGVpbXBvcnQudGF4bzpcbiAgICAgICAgICAgIGlmICghaW1wb3J0em9uZSkgcmV0dXJuO1xuICAgICAgICAgICAgLy8gYWNjdW11bGF0ZSBhbmQgc2hvdyBpbiBpbXBvcnQgd2luIC0gbW92ZSB0aGUgZm9ybSBmaWVsZCBpbiBtb2RhbCB3aW4gdG8gdmlldyB0aGUgY2hhbmdlcyBhbmQgYmVuZWZpdCBvZiB0b20tc2VsZWN0IGNvbXBvbmVudCBmdW5jdHMuLi5cbiAgICAgICAgICAgIHRzID0gaW1wb3J0em9uZS50b21zZWxlY3Q7XG4gICAgICAgICAgICBsZXQgdGF4b25zID0gY2VsbGRhdGE7XG4gICAgICAgICAgICBpZiAodGF4b25zKSB7XG4gICAgICAgICAgICAgIGlmICh0cykge1xuICAgICAgICAgICAgICAgIC8vIG1lcmdlIHRheG9ucyBhbmQgb3B0aW9ucyAtIHVuaXF1ZVxuICAgICAgICAgICAgICAgIE9iamVjdC52YWx1ZXModHMub3B0aW9ucykuZm9yRWFjaCgob3B0KSA9PiB7XG4gICAgICAgICAgICAgICAgICBsZXQgb2JqID0ge307XG4gICAgICAgICAgICAgICAgICBvYmpbb3B0W3RzLnNldHRpbmdzLnZhbHVlRmllbGRdXSA9IG9wdFt0cy5zZXR0aW5ncy5sYWJlbEZpZWxkXTtcbiAgICAgICAgICAgICAgICAgIGlmICghdGF4b25zW29wdFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXV0pIHRheG9ucyA9IE9iamVjdC5hc3NpZ24odGF4b25zLCBvYmopO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRheG9ucyA9IE9iamVjdC5lbnRyaWVzKHRheG9ucyk7XG4gICAgICAgICAgICAgICAgLy8gc29ydCB0YXhvbnNcbiAgICAgICAgICAgICAgICB0YXhvbnMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgICAgICAgbGV0IHggPSBhWzFdO1xuICAgICAgICAgICAgICAgICAgbGV0IHkgPSBiWzFdO1xuICAgICAgICAgICAgICAgICAgcmV0dXJuICsoeCA+IHkpIHx8IC0oeSA+IHgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRzLmNsZWFyKCk7XG4gICAgICAgICAgICAgICAgdHMuY2xlYXJPcHRpb25zKCk7XG4gICAgICAgICAgICAgICAgLy8gYWRkIHRheG9ucyBpdGVtc1xuICAgICAgICAgICAgICAgIHRheG9ucy5mb3JFYWNoKChba2V5LCB0ZXh0XSkgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKCF0cy5nZXRJdGVtKGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0cy5nZXRPcHRpb24oa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICAgIGxldCBvYmogPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICBvYmpbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0gPSBrZXk7XG4gICAgICAgICAgICAgICAgICAgICAgb2JqW3RzLnNldHRpbmdzLmxhYmVsRmllbGRdID0gdW5lc2NhcGVfaHRtbCh0ZXh0LnRyaW0oKSk7XG4gICAgICAgICAgICAgICAgICAgICAgdHMuYWRkT3B0aW9uKG9iaik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdHMuYWRkSXRlbShrZXkpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIE9iamVjdC52YWx1ZXMoaW1wb3J0em9uZS5vcHRpb25zKS5mb3JFYWNoKG9wdCA9PiB7XG4gICAgICAgICAgICAgICAgICBsZXQgb2JqID0ge307XG4gICAgICAgICAgICAgICAgICBvYmpbb3B0LnZhbHVlXSA9IG9wdC50ZXh0O1xuICAgICAgICAgICAgICAgICAgaWYgKCF0YXhvbnNbb3B0LnZhbHVlXSkgdGF4b25zID0gT2JqZWN0LmFzc2lnbih0YXhvbnMsIG9iaik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGF4b25zID0gT2JqZWN0LmVudHJpZXModGF4b25zKTtcbiAgICAgICAgICAgICAgICB0YXhvbnMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgICAgICAgbGV0IHggPSBhWzFdO1xuICAgICAgICAgICAgICAgICAgbGV0IHkgPSBiWzFdO1xuICAgICAgICAgICAgICAgICAgcmV0dXJuICsoeCA+IHkpIHx8IC0oeSA+IHgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGltcG9ydHpvbmUuaW5uZXJIVE1MID0gYGA7XG4gICAgICAgICAgICAgICAgdGF4b25zLmZvckVhY2goKFtrZXksIHRleHRdKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoIWltcG9ydHpvbmUucXVlcnlTZWxlY3Rvcignb3B0aW9uW3ZhbHVlPVwiJyArIGtleSArICdcIl0nKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvID0gY3JlYXRlX2JveCgnb3B0aW9uJywge1xuICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBrZXksXG4gICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6ICdzZWxlY3RlZCcsXG4gICAgICAgICAgICAgICAgICAgICAgdGV4dDogdGV4dFxuICAgICAgICAgICAgICAgICAgICB9LCBpbXBvcnR6b25lKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBzaG93YnRucyA9ICh0YXhvbnMubGVuZ3RoID4gMCk7XG4gICAgICAgICAgICAgIHRheG9ucyA9IG51bGw7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgdHlwZWltcG9ydC5wcml2aWxlZ2VzOlxuICAgICAgICAgICAgY29uc3QgcHJpdnMgPSBjZWxsZGF0YTtcbiAgICAgICAgICAgIC8vIHNldCBldmVyeWJvZHkgdG8gJ3ZpZXcnIGlmIG1vcmUgdGhhbiBvbmUgcHJvamVjdCBpbXBvcnRlZFxuICAgICAgICAgICAgY29uc3QgcmVzZXRwcml2ID0gKCh0cyAmJiB0cy5pdGVtcy5sZW5ndGggPiAwKSB8fCAoaW1wb3J0em9uZS5zZWxlY3RlZEluZGV4ID4gMCkpO1xuICAgICAgICAgICAgaWYgKCFpbXBvcnR6b25lLnRvbXNlbGVjdCkge1xuICAgICAgICAgICAgICBpbXBvcnR6b25lLmN1cnJlbnRsaXN0ID0ge307XG4gICAgICAgICAgICAgIGNvbnN0IGpzVG9tU2VsZWN0ID0gSnNUb21TZWxlY3QoKTtcbiAgICAgICAgICAgICAganNUb21TZWxlY3QuYXBwbHlUbyhpbXBvcnR6b25lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRzID0gaW1wb3J0em9uZS50b21zZWxlY3Q7XG4gICAgICAgICAgICBPYmplY3QuZW50cmllcyhwcml2cykuZm9yRWFjaCgoW3ByaXYsIG1lbWJlcnNdKSA9PiB7XG4gICAgICAgICAgICAgIG1lbWJlcnMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiAoYi5uYW1lID4gYS5uYW1lKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIG1lbWJlcnMuZm9yRWFjaChtZW1iZXIgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld3ByaXYgPSAocmVzZXRwcml2KSA/IGtleV9wcml2aWxlZ2VzLnZpZXdlcnMgOiBwcml2OyAvLyB2aWV3ZXIgaWYgbW9yZSB0aGFuIG9uZSBwcm9qZWN0IGltcG9ydGVkXG4gICAgICAgICAgICAgICAgbGV0IG9wdDtcbiAgICAgICAgICAgICAgICBpZiAoIWltcG9ydHpvbmUuY3VycmVudGxpc3QgfHwgIWltcG9ydHpvbmUuY3VycmVudGxpc3RbbWVtYmVyLmlkXSkge1xuICAgICAgICAgICAgICAgICAgaWYgKHRzKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdCA9IHRzLml0ZW1zLmluZGV4T2YobWVtYmVyLmlkKTtcbiAgICAgICAgICAgICAgICAgICAgLy9UT0RPIC0gdGVzdCAtIG9wdCBzaG91bGQgYWx3YXlzIGJlIDBcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdCA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgdHMucmVtb3ZlSXRlbShtZW1iZXIuaWQpO1xuICAgICAgICAgICAgICAgICAgICAgIHRzLnJlbW92ZU9wdGlvbihtZW1iZXIuaWQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIGFkZG9wdGlvbiAmJiBhZGRJdGVtXG4gICAgICAgICAgICAgICAgICAgIG9wdCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICBvcHRncm91cDogbmV3cHJpdlxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG9wdFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSA9IG1lbWJlci5pZDtcbiAgICAgICAgICAgICAgICAgICAgb3B0W3RzLnNldHRpbmdzLnNlYXJjaEZpZWxkXSA9IG1lbWJlci5uYW1lO1xuICAgICAgICAgICAgICAgICAgICBvcHRbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSBtZW1iZXIubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgdHMuYWRkT3B0aW9uKG9wdCk7XG4gICAgICAgICAgICAgICAgICAgIHRzLmFkZEl0ZW0obWVtYmVyLmlkKTtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdCA9IGltcG9ydHpvbmUucXVlcnlTZWxlY3Rvcignb3B0aW9uW3ZhbHVlPVwiJyArIG1lbWJlci5pZCArICdcIl0nKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgIG9wdCA9IGNyZWF0ZV9ib3goJ29wdGlvbicsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBtZW1iZXIuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhc2V0OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGdyb3VwOiBuZXdwcml2XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0ZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBtZW1iZXIubmFtZVxuICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgLyogIG9wdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0LnZhbHVlID0gbWVtYmVyLmlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0LmRhdGFzZXQub3B0Z3JvdXAgPSBuZXdwcml2O1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0LnNlbGVjdGVkID0gb3B0LmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHQudGV4dCA9IG1lbWJlci5uYW1lOyovXG4gICAgICAgICAgICAgICAgICAgICAgaW1wb3J0em9uZS5hZGQob3B0KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIG9wdC5kYXRhc2V0Lm9wdGdyb3VwID0gbmV3cHJpdjtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBpZiAodHMpIHRzLnJlZnJlc2hPcHRpb25zKHRydWUpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHNob3didG5zID0gKCgodHMpID8gdHMuaXRlbXMubGVuZ3RoIDogaW1wb3J0em9uZS5zZWxlY3RlZEluZGV4ICsgMSkgPiAwKTtcblxuXG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGhpcy5pbXBvcnRzW25hbWVdID0gY2VsbGRhdGE7XG4gICAgICAgICAgICBpZiAoY2VsbCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICBpZiAoY2VsbC5kYXRhc2V0LmF1dG9jb21wbGV0ZSkge1xuICAgICAgICAgICAgICAgIC8vIHNlbGVjdCBlbGVtZW50cyB3aGVyZSBrZXkgLyB2YWx1ZSBpbiBkaWZmZXJlbnQgY29sdW1uc1xuICAgICAgICAgICAgICAgIHRoaXMuaW1wb3J0c1tuYW1lXSA9IHtcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBjZWxsZGF0YSxcbiAgICAgICAgICAgICAgICAgIGtleTogbnVsbFxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgbGV0IGVsID0gbnVsbDtcbiAgICAgICAgICAgICAgICB0aGNlbGxzLmV2ZXJ5KCh0LCBpZHgpID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmICh0LmRhdGFzZXQubmFtZSA9PSB0aGNlbGwuZGF0YXNldC5hdXRvY29tcGxldGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZWwgPSBpZHg7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmIChlbCAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgZWwgPSBkYXRhc1tyb3dpbmRleF1bZWxdO1xuXG4gICAgICAgICAgICAgICAgICB0aGlzLmltcG9ydHNbbmFtZV0ua2V5ID0gZWw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNlbGwuZGF0YXNldC52YWx1ZSkgdGhpcy5pbXBvcnRzW25hbWVdID0gY2VsbC5kYXRhc2V0LnZhbHVlO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0pO1xuXG4gICAgaWYgKHRoY2VsbHMubGVuZ3RoKSB7XG4gICAgICBpZiAodGhpcy5idXR0b24pIHtcbiAgICAgICAgY29uc3QgYWN0aXZhdGUgPSAoIXRoaXMuYnV0dG9uLmRhdGFzZXQuYWN0aXZhdGVkICYmICh3aGF0ID09PSB0eXBlaW1wb3J0LnRheG8gfHwgd2hhdCA9PT0gdHlwZWltcG9ydC5wcml2aWxlZ2VzKSk7XG4gICAgICAgIHRoaXMuc2hvd0ltcG9ydChzaG93YnRucyk7XG4gICAgICAgIGlmIChhY3RpdmF0ZSkgdGhpcy5hY3RpdmF0ZUJ1dHRvbnMod2hhdCwgc2VsZWN0Y2VsbHMpO1xuICAgICAgfSBlbHNlIHRoaXMubWFrZUltcG9ydChudWxsLCBzZWxlY3RjZWxscywgd2hhdCwgdHJ1ZSk7XG4gICAgfVxuICAgIC8vXG5cbiAgfVxuICBtZXNzYWdlWm9uZShpdGVtKSB7XG4gICAgY29uc29sZS5sb2coJ2l0ZW1tZXNzYWdlJywgaXRlbSk7XG4gIH1cbiAgYWN0aXZhdGVCdXR0b25zKHdoYXQsIHNlbGVjdGNlbGxzKSB7XG5cbiAgICB0aGlzLmJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgdGhpcy5tYWtlSW1wb3J0KGUuY3VycmVudFRhcmdldCwgc2VsZWN0Y2VsbHMsIHdoYXQsIHRydWUpO1xuXG4gICAgfSk7XG4gICAgdGhpcy5yZXBsYWNlYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB0aGlzLm1ha2VJbXBvcnQoZS5jdXJyZW50VGFyZ2V0LCBzZWxlY3RjZWxscywgd2hhdCwgdHJ1ZSk7XG5cbiAgICB9KTtcblxuICAgIHRoaXMuYnV0dG9uLmRhdGFzZXQuYWN0aXZhdGVkID0gdHJ1ZTtcbiAgICB0aGlzLnJlcGxhY2VidXR0b24uZGF0YXNldC5hY3RpdmF0ZWQgPSB0cnVlO1xuICB9XG5cbiAgZmluZENvbnRhY3QodGRzLCBuYW1lID0gJ2NvbnRhY3QnKSB7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmdyaWRDb2x1bW5JbmRleCgnbmFtZScsIG5hbWUpO1xuICAgIGlmIChpbmRleCA+PSAwKSByZXR1cm4gdGRzW2luZGV4XSA/IHRkc1tpbmRleF0gOiBudWxsO1xuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICByZW5kZXJQcml2aWxlZ2VzKGltcG9ydHpvbmUsIHJlcGxhY2UgPSBmYWxzZSkge1xuICAgIGxldCBwcml2aWxlZ2VzID0ge307XG4gICAgY29uc3QgdHpvbmUgPSBpbXBvcnR6b25lLnRvbXNlbGVjdDtcblxuICAgIGNvbnN0IHB1c2hwcml2ID0gKG1lbWJlciwgcHJpdikgPT4ge1xuICAgICAgY29uc3Qgb2JqID0ge1xuICAgICAgICBpZDogbWVtYmVyLmlkLFxuICAgICAgICBuYW1lOiBtZW1iZXIubmFtZSxcbiAgICAgICAgcHJpdjogcHJpdlxuICAgICAgfVxuICAgICAgaWYgKHByaXZpbGVnZXNbcHJpdl0pIHByaXZpbGVnZXNbcHJpdl0ucHVzaChvYmopO1xuICAgICAgZWxzZSBwcml2aWxlZ2VzW3ByaXZdID0gW29ial07XG4gICAgfVxuXG4gICAgaWYgKHR6b25lKSB7XG4gICAgICBjb25zdCBtZW1iZXJzID0gWy4uLnR6b25lLml0ZW1zXTtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCB0em9uZS5vcHRpb25zKTtcbiAgICAgIG1lbWJlcnMuZm9yRWFjaChtZW1iZXIgPT4ge1xuICAgICAgICBtZW1iZXIgPSBvcHRpb25zW21lbWJlcl07XG4gICAgICAgIGlmIChtZW1iZXIpIHB1c2hwcml2KG1lbWJlciwgbWVtYmVyLm9wdGdyb3VwKTtcblxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgaW1wb3J0em9uZS5vcHRpb25zLmZvckVhY2gobWVtYmVyID0+IHtcbiAgICAgICAgaWYgKG1lbWJlci5zZWxlY3RlZCkgcHVzaHByaXYobWVtYmVyLCBtZW1iZXIuZGF0YXNldC5vcHRncm91cCk7XG4gICAgICB9KVxuICAgIH1cblxuICAgIGlmICh0aGlzLmltcG9ydFByaXZpbGVnZXMocHJpdmlsZWdlcywgcmVwbGFjZSkpIHtcbiAgICAgIGlmICh0em9uZSkge1xuICAgICAgICB0em9uZS5jbGVhcigpO1xuICAgICAgICB0em9uZS5jbGVhck9wdGlvbnMoKTtcbiAgICAgIH0gZWxzZSBpbXBvcnR6b25lLmlubmVySFRNTCA9IGBgO1xuXG4gICAgfVxuXG4gIH1cblxuICBpbXBvcnRQcml2aWxlZ2VzKHByaXZpbGVnZXMsIGNsZWFyID0gZmFsc2UpIHtcbiAgICBjb25zdCBwcm9qZWN0UHJpdmlsZWdlcyA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCcuJyArIGRvbXNlbGVjdG9ycy5jb21wb25lbnQucHJpdmlsZWdlcy5pZGVudCk7XG5cbiAgICBpZiAocHJvamVjdFByaXZpbGVnZXMgPT09IG51bGwgfHwgIXByb2plY3RQcml2aWxlZ2VzLmpzcHJpdmlsZWdlcykgcmV0dXJuO1xuICAgIGNvbnN0IGltcG9ydGVkdGFnID0gKGlucHV0KSA9PiB7XG4gICAgICB0aGlzLnNldEltcG9ydGVkVGFnKGlucHV0LCBudWxsKTtcbiAgICB9XG4gICAgY29uc3QgZGlzbWlzcyA9ICgpID0+IHtcbiAgICAgIHRoaXMuZGlzbWlzcygpO1xuICAgIH1cbiAgICBjb25zdCBjb250YWN0ID0gKGNsZWFyID09PSB0cnVlICYmIHRoaXMuaW1wb3J0c1ttb2RlbHMuY29udGFjdF0pID8gdGhpcy5pbXBvcnRzW21vZGVscy5jb250YWN0XSA6IG51bGw7XG4gICAgcmV0dXJuIChwcm9qZWN0UHJpdmlsZWdlcy5qc3ByaXZpbGVnZXMuaW1wb3J0UHJpdmlsZWdlcyhwcml2aWxlZ2VzLCBjbGVhciwgY29udGFjdCwgaW1wb3J0ZWR0YWcsIGRpc21pc3MpKTtcbiAgfVxuXG4gIHJlc2V0U2VsZWN0b3JzKCkge1xuICAgIHRoaXMuc2VsZWN0b3JzLmZvckVhY2goKHNlbGVjdG9yLCBpKSA9PiB7XG4gICAgICBpZiAoc2VsZWN0b3IuZGlzYWJsZWQpIHNlbGVjdG9yLmRpc2FibGVkID0gZmFsc2U7XG4gICAgfSk7XG4gICAgdGhpcy5kb20ucXVlcnlTZWxlY3RvckFsbCgndGQuJyArIGNzcy5zZWxlY3RlZCkuZm9yRWFjaCh0ZCA9PiB7XG4gICAgICB0ZC5jbGFzc0xpc3QucmVtb3ZlKGNzcy5zZWxlY3RlZCk7XG4gICAgfSk7XG4gIH1cblxuICBhY3RpdmF0ZUNsZWFyKCkge1xuICAgIGNvbnN0IGNsZWFyYnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NsZWFyLScgKyB0aGlzLmltcG9ydGlkKTtcbiAgICBpZiAoIWNsZWFyYnV0dG9uKSByZXR1cm47XG4gICAgY2xlYXJidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4ge1xuICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGlmICghdGhpcy5pbXBvcnRjb250YWluZXIpIHJldHVybjtcbiAgICAgIHRoaXMucmVzZXRTZWxlY3RvcnMoKTtcbiAgICAgIHRoaXMuYnV0dG9uLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICB0aGlzLnJlcGxhY2VidXR0b24uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuc2hvd0ltcG9ydChmYWxzZSk7XG4gICAgfSk7XG4gIH1cbiAgY3JlYXRlSW1wb3J0em9uZShuYW1lKSB7XG4gICAgbGV0IGltcG9ydHpvbmUgPSB0aGlzLnNob3dJbXBvcnQodHJ1ZSksXG4gICAgICB0cyA9IGZhbHNlO1xuICAgIGlmICghaW1wb3J0em9uZSkge1xuICAgICAgaWYgKG5hbWUgPT09IHR5cGVpbXBvcnQucHJpdmlsZWdlcykge1xuICAgICAgICBpbXBvcnR6b25lID0gY3JlYXRlX2JveCgnc2VsZWN0Jywge1xuICAgICAgICAgIGlkOiB0aGlzLmltcG9ydGlkLFxuICAgICAgICAgIGRhdGFzZXQ6IHtcbiAgICAgICAgICAgIHR5cGU6IG1vZGVscy51c2VyLFxuICAgICAgICAgICAgcHJpdjogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG11bHRpcGxlOiB0cnVlXG4gICAgICAgIH0sIHRoaXMuaW1wb3J0Y29udGFpbmVyKTtcbiAgICAgICAgaW1wb3J0em9uZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMuaW1wb3J0aWQpO1xuICAgICAgICB0cyA9IHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBpbXBvcnRfdGFyZ2V0ID0gKHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbbmFtZT1cIicgKyBuYW1lICsgJ1wiXScpKSA/IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbbmFtZT1cIicgKyBuYW1lICsgJ1wiXScpIDogdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWltcG9ydGZpZWxkPVwiJyArIG5hbWUgKyAnXCJdJyk7XG4gICAgICAgIGlmICghaW1wb3J0X3RhcmdldCkgcmV0dXJuO1xuICAgICAgICB0cyA9IGltcG9ydF90YXJnZXQudG9tc2VsZWN0O1xuICAgICAgICB0aGlzLmltcG9ydHpvbmVpZCA9IGltcG9ydF90YXJnZXQuaWQ7XG4gICAgICAgIC8vIHRvbXNlbGVjdCA/XG4gICAgICAgIGltcG9ydHpvbmUgPSBpbXBvcnRfdGFyZ2V0LmNsb25lTm9kZSgpO1xuICAgICAgICBpbXBvcnR6b25lLmNsYXNzTGlzdC5yZW1vdmUoY3NzLnRvbXNlbGVjdGVkKTtcbiAgICAgICAgaW1wb3J0em9uZS5jbGFzc0xpc3QucmVtb3ZlKGNzcy5oaWRkZW5hY2Nlc3NpYmxlKTtcbiAgICAgICAgLy8ga2VlcCBvcmlnaW5hbCBpZCB0byByZXBsYWNlIGRhdGEgb24gYXBwbHkgaW1wb3J0XG4gICAgICAgIGltcG9ydHpvbmUuZGF0YXNldC5vcmlnaW4gPSBpbXBvcnR6b25lLmlkO1xuICAgICAgICBpbXBvcnR6b25lLmlkID0gdGhpcy5pbXBvcnRpZDtcbiAgICAgICAgaW1wb3J0em9uZS5uYW1lID0gdGhpcy5pbXBvcnRpZCArICdfJyArIGltcG9ydHpvbmUubmFtZTtcbiAgICAgICAgdGhpcy5pbXBvcnRjb250YWluZXIucHJlcGVuZChpbXBvcnR6b25lKTtcbiAgICAgICAgaWYgKHRzKSB7XG4gICAgICAgICAgY29uc3QganNUb21TZWxlY3QgPSBKc1RvbVNlbGVjdCgpO1xuICAgICAgICAgIGpzVG9tU2VsZWN0LmFwcGx5VG8oaW1wb3J0em9uZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5hY3RpdmF0ZUNsZWFyKCk7XG4gICAgICB9XG5cbiAgICB9XG4gICAgcmV0dXJuIGltcG9ydHpvbmU7XG5cbiAgfVxuXG4gIG1ha2VJbXBvcnQoYnRuLCBzZWxlY3RjZWxscywgd2hhdCwgY2xvc2UgPSBmYWxzZSkge1xuICAgIGxldCBkb25lID0gdHJ1ZSxcbiAgICAgIHRzID0gbnVsbDtcbiAgICBjb25zdCBpbXBvcnR6b25lID0gKHRoaXMuaW1wb3J0Y29udGFpbmVyKSA/IHRoaXMuaW1wb3J0Y29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoJyMnICsgdGhpcy5pbXBvcnRpZCkgOiBudWxsO1xuXG4gICAgc3dpdGNoICh3aGF0KSB7XG4gICAgICBjYXNlIHR5cGVpbXBvcnQudGF4bzpcblxuICAgICAgICBpZiAoIWltcG9ydHpvbmUpIHJldHVybiBmYWxzZTtcbiAgICAgICAgY29uc3QgaW1wb3J0X3RhcmdldCA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCcjJyArIGltcG9ydHpvbmUuZGF0YXNldC5vcmlnaW4pO1xuXG4gICAgICAgIGlmICghaW1wb3J0X3RhcmdldCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICB0cyA9IGltcG9ydF90YXJnZXQudG9tc2VsZWN0O1xuICAgICAgICBpZiAodHMpIHtcbiAgICAgICAgICAvLyBvbmx5IGlmIHJlcGxhY2Ugc3BlY2lmaWVkXG4gICAgICAgICAgaWYgKGJ0bi5kYXRhc2V0LnJlcGxhY2UgJiYgYnRuLmRhdGFzZXQucmVwbGFjZSA9PT0gJ3JlcGxhY2UnKSB7XG4gICAgICAgICAgICB0cy5jbGVhcigpO1xuICAgICAgICAgICAgdHMuY2xlYXJPcHRpb25zKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHR6b25lID0gaW1wb3J0em9uZS50b21zZWxlY3Q7XG4gICAgICAgICAgY29uc3QgaXRlbXMgPSBbLi4udHpvbmUuaXRlbXNdO1xuICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCB0em9uZS5vcHRpb25zKTtcbiAgICAgICAgICBpdGVtcy5mb3JFYWNoKChlLCBpKSA9PiB7XG4gICAgICAgICAgICBsZXQgZWwgPSB7fTtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdID0gZTtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLnNlYXJjaEZpZWxkXSA9IHVuZXNjYXBlX2h0bWwob3B0aW9uc1tlXVt0cy5zZXR0aW5ncy5zZWFyY2hGaWVsZF0pO1xuICAgICAgICAgICAgaWYgKCF0cy5nZXRPcHRpb24oZSkpIHRzLmFkZE9wdGlvbihlbCk7XG4gICAgICAgICAgICB0cy5hZGRJdGVtKGUpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHR6b25lLmNsZWFyKCk7XG4gICAgICAgICAgdHpvbmUuY2xlYXJPcHRpb25zKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGJ0bi5kYXRhc2V0LnJlcGxhY2UgJiYgYnRuLmRhdGFzZXQucmVwbGFjZSA9PT0gJ3JlcGxhY2UnKSBpbXBvcnRfdGFyZ2V0LmlubmVySFRNTCA9IGBgO1xuICAgICAgICAgIGltcG9ydF90YXJnZXQuaW5uZXJIVE1MID0gRE9NUHVyaWZ5LnNhbml0aXplKGltcG9ydHpvbmUuaW5uZXJIVE1MKTtcbiAgICAgICAgICBpbXBvcnR6b25lLmlubmVySFRNTCA9IGBgO1xuICAgICAgICB9XG4gICAgICAgIGRvbmUgPSB0cnVlO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgdHlwZWltcG9ydC5wcml2aWxlZ2VzOlxuICAgICAgICBpZiAoIWltcG9ydHpvbmUpIHJldHVybiBmYWxzZTtcbiAgICAgICAgZG9uZSA9IHRoaXMucmVuZGVyUHJpdmlsZWdlcyhpbXBvcnR6b25lLCAoYnRuLmRhdGFzZXQucmVwbGFjZSAmJiBidG4uZGF0YXNldC5yZXBsYWNlID09PSAncmVwbGFjZScpKTtcbiAgICAgICAgaWYgKGltcG9ydHpvbmUuY3VycmVudGxpc3QpIGltcG9ydHpvbmUuY3VycmVudGxpc3QgPSB7fTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb25zdCB0c19hZGRfc2VsZWN0X2l0ZW0gPSBmdW5jdGlvbih0cywgZGF0YSkge1xuICAgICAgICAgIGNvbnN0IGVsID0ge307XG4gICAgICAgICAgaWYgKHR5cGVvZihkYXRhKSA9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSBkYXRhO1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0gPSBkYXRhO1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3Muc2VhcmNoRmllbGRdID0gdW5lc2NhcGVfaHRtbChkYXRhKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSBkYXRhLmtleTtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdID0gZGF0YS5rZXk7XG4gICAgICAgICAgICBlbFt0cy5zZXR0aW5ncy5zZWFyY2hGaWVsZF0gPSB1bmVzY2FwZV9odG1sKGRhdGEudmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoIXRzLmdldE9wdGlvbihlbFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSkpIHRzLmFkZE9wdGlvbihlbCk7XG4gICAgICAgICAgaWYgKCF0cy5nZXRJdGVtKGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdKSkgdHMuYWRkSXRlbShlbFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYWRkX3NlbGVjdF9vcHRpb24gPSBmdW5jdGlvbihpbnB1dCwgZGF0YSkge1xuICAgICAgICAgIGxldCBhdHRyID0ge1xuICAgICAgICAgICAgc2VsZWN0ZWQ6IHRydWVcbiAgICAgICAgICB9O1xuICAgICAgICAgIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSBhdHRyLnZhbHVlID0gYXR0ci50ZXh0ID0gZGF0YTtcbiAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGF0dHIudmFsdWUgPSBkYXRhLmtleTtcbiAgICAgICAgICAgIGF0dHIudGV4dCA9IGRhdGEudmFsdWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IGNyZWF0ZV9ib3goJ29wdGlvbicsIGF0dHIsIGlucHV0KTtcblxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGFkZF9pbnB1dF9vcHRpb24gPSBmdW5jdGlvbihpbnB1dCwgZGF0YSkge1xuICAgICAgICAgIGlmIChpbnB1dC5tdWx0aXBsZSkge1xuICAgICAgICAgICAgbGV0IHZhbHVlcyA9IGlucHV0LnZhbHVlLnNwbGl0KCcsJyk7XG4gICAgICAgICAgICB2YWx1ZXMucHVzaChkYXRhLmtleSk7XG4gICAgICAgICAgICBpbnB1dC52YWx1ZSA9IHZhbHVlcy5qb2luKCcsJyk7XG4gICAgICAgICAgfSBlbHNlIGlucHV0LnZhbHVlID0gZGF0YTtcblxuICAgICAgICB9XG4gICAgICAgIHNlbGVjdGNlbGxzLmZvckVhY2goKG5hbWUsIGluZGV4KSA9PiB7XG4gICAgICAgICAgbGV0IGlucHV0ID0gKCh0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignW2RhdGEtaW1wb3J0ZmllbGQ9XCInICsgbmFtZSArICdcIl0nKSkgPyB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignW2RhdGEtaW1wb3J0ZmllbGQ9XCInICsgbmFtZSArICdcIl0nKSA6IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbbmFtZT1cIicgKyBuYW1lICsgJ1wiXScpKTtcbiAgICAgICAgICBpZiAoaW5wdXQgJiYgaW5wdXQuZGF0YXNldC5ub2ltcG9ydCkgcmV0dXJuO1xuICAgICAgICAgIGlmIChpbnB1dCAmJiB0aGlzLmltcG9ydHNbbmFtZV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgY29uc3QgdHlwZSA9IChpbnB1dC50eXBlKSA/IGlucHV0LnR5cGUgOiBpbnB1dC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICB0cyA9IGlucHV0LnRvbXNlbGVjdDtcbiAgICAgICAgICAgIGlmIChuYW1lID09PSAnaW5pdF9jbGFzc2lmX2xpc3QnKSB7XG4gICAgICAgICAgICAgIGxldCBpZHMgPSB0aGlzLmltcG9ydHNbbmFtZV07XG4gICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGlkcykpIGlkcyA9IGlkcy5qb2luKCcsJyk7XG4gICAgICAgICAgICAgIGVsc2UgaWRzID0gaWRzLnJlcGxhY2UoJ1snLCAnJykucmVwbGFjZSgnXScsICcnKS5yZXBsYWNlQWxsKCcgJywgJycpO1xuICAgICAgICAgICAgICBpZiAodHMpIHtcbiAgICAgICAgICAgICAgICB0cy53cmFwcGVyLmNsYXNzTGlzdC5hZGQoJ3dhaXQtZm9yLXJlc3VsdHMnKTtcbiAgICAgICAgICAgICAgICB0cy5jbGVhcihmYWxzZSk7XG4gICAgICAgICAgICAgICAgdHMuY2xlYXJPcHRpb25zKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKGlkcyAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICBpZiAodHMpIHRzLndyYXBwZXIuY2xhc3NMaXN0LmFkZCgnd2FpdC1mb3ItcmVzdWx0cycpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdpZGxpc3QnLCBpZHMpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9ICcvc2VhcmNoL3RheG9yZXNvbHZlJyAvLysgbmV3IFVSTFNlYXJjaFBhcmFtcyh7J2lkbGlzdCc6IGlkc30pO1xuICAgICAgICAgICAgICAgIGZldGNoKHVybCwgZmV0Y2hTZXR0aW5ncyh7XG4gICAgICAgICAgICAgICAgICAnbWV0aG9kJzogJ1BPU1QnLFxuICAgICAgICAgICAgICAgICAgJ2JvZHknOiBmb3JtRGF0YVxuICAgICAgICAgICAgICAgIH0pKS50aGVuKHJlc3BvbnNlID0+XG4gICAgICAgICAgICAgICAgICByZXNwb25zZS5qc29uKClcbiAgICAgICAgICAgICAgICApLnRoZW4ocmVzdWx0cyA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zdCB0cyA9IGlucHV0LnRvbXNlbGVjdDtcbiAgICAgICAgICAgICAgICAgIGlmICh0cykge1xuXG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHJlc3VsdHMpLmZvckVhY2goKFtrZXksIHRleHRdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBrZXk6IERPTVB1cmlmeS5zYW5pdGl6ZShrZXkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IERPTVB1cmlmeS5zYW5pdGl6ZSh0ZXh0KVxuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICB0c19hZGRfc2VsZWN0X2l0ZW0odHMsIGVsKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHRzLndyYXBwZXIuY2xhc3NMaXN0LnJlbW92ZSgnd2FpdC1mb3ItcmVzdWx0cycpO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlLmluZGV4T2YoJ3NlbGVjdCcpID09PSAwKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgaW5wdXQucXVlcnlTZWxlY3RvckFsbCgnb3B0aW9uJykuZm9yRWFjaChvcHRpb24gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbi5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHJlc3VsdHMpLmZvckVhY2goKFtrZXksIHRleHRdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBrZXk6IERPTVB1cmlmeS5zYW5pdGl6ZShrZXkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IERPTVB1cmlmeS5zYW5pdGl6ZSh0ZXh0KVxuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICBhZGRfaW5wdXRfb3B0aW9uKGlucHV0LCBlbCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBPYmplY3QuZW50cmllcyhyZXN1bHRzKS5mb3JFYWNoKChba2V5LCB0ZXh0XSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBET01QdXJpZnkuc2FuaXRpemUoa2V5KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBET01QdXJpZnkuc2FuaXRpemUodGV4dClcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgYWRkX3NlbGVjdF9vcHRpb24oaW5wdXQsIGVsKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgcmVzdWx0cyA9IG51bGw7XG4gICAgICAgICAgICAgICAgICB0aGlzLnNldEltcG9ydGVkVGFnKGlucHV0KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmICh0cykge1xuICAgICAgICAgICAgICB0c19hZGRfc2VsZWN0X2l0ZW0odHMsIHRoaXMuaW1wb3J0c1tuYW1lXSk7XG4gICAgICAgICAgICAgIHRoaXMuc2V0SW1wb3J0ZWRUYWcoaW5wdXQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICAgICAgICAgICAgY2FzZSAncmFkaW8nOlxuICAgICAgICAgICAgICAgIGNhc2UgJ2NoZWNrYm94JzpcbiAgICAgICAgICAgICAgICAgIGlucHV0ID0gdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lPVwiJyArIG5hbWUgKyAnXCJdW3ZhbHVlPVwiJyArIHRoaXMuaW1wb3J0c1tuYW1lXSArICdcIl0nKTtcbiAgICAgICAgICAgICAgICAgIGlmIChpbnB1dCkgaW5wdXQuY2hlY2tlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlICdzZWxlY3QnOlxuICAgICAgICAgICAgICAgICAgaWYgKGlucHV0Lm11bHRpcGxlKSB0aGlzLmltcG9ydHNbbmFtZV0uZm9yRWFjaChkYXRhID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYWRkX3NlbGVjdF9vcHRpb24oaW5wdXQsIGRhdGEpXG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgIGVsc2UgYWRkX3NlbGVjdF9vcHRpb24oaW5wdXQsIHRoaXMuaW1wb3J0c1tuYW1lXSk7XG5cbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IHRoaXMuaW1wb3J0c1tuYW1lXTtcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHRoaXMuc2V0SW1wb3J0ZWRUYWcoaW5wdXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHdoYXQgIT09IHR5cGVpbXBvcnQuc2V0dGluZ3MpIGlucHV0LmZvY3VzKCk7XG4gICAgICAgICAgICBkb25lID0gZG9uZSAmJiB0cnVlO1xuICAgICAgICAgICAgLy8gc2V0IGltcG9ydGVkIHRhZyB0byBmaWVsZGJveFxuXG5cbiAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUgPT09IHR5cGVpbXBvcnQucHJpdmlsZWdlcykge1xuICAgICAgICAgICAgLy9jb25zdCBjbGVhcnByaXZpbGVnZXMgPSAod2hhdCA9PT0gdHlwZWltcG9ydC5zZXR0aW5ncyk7XG4gICAgICAgICAgICBjb25zdCBjbGVhcnByaXZpbGVnZXMgPSBmYWxzZTtcbiAgICAgICAgICAgIGRvbmUgPSBkb25lICYmIHRoaXMuaW1wb3J0UHJpdmlsZWdlcyh0aGlzLmltcG9ydHNbbmFtZV0sIGNsZWFycHJpdmlsZWdlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGlmIChkb25lID09PSB0cnVlICYmIGNsb3NlID09IHRydWUpIHtcbiAgICAgIHRoaXMuZGlzbWlzcygpO1xuICAgICAgaWYgKHRoaXMuZm9ybSkgdGhpcy5mb3JtLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCd2YWxpZGF0ZScpKTtcbiAgICB9XG4gIH1cblxuICBzZXRJbXBvcnRlZFRhZyhpbnB1dCwgc2VsZWN0b3IgPSBkb21zZWxlY3RvcnMuY29tcG9uZW50LmZvcm0uZm9ybWJveCkge1xuICAgIGxldCBlbCA9IChzZWxlY3RvciA9PT0gbnVsbCkgPyBpbnB1dCA6IChpbnB1dC5jbG9zZXN0KHNlbGVjdG9yKSA/IGlucHV0LmNsb3Nlc3Qoc2VsZWN0b3IpIDogaW5wdXQuY2xvc2VzdCgnZmllbGRzZXQnKSk7XG4gICAgaWYgKCFlbCkgcmV0dXJuO1xuICAgIGNvbnN0IHJlbW92ZXRhZyA9IChlKSA9PiB7XG4gICAgICBkZWxldGUgZWwuZGF0YXNldC5pc2ltcG9ydGVkO1xuICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjc3MuaW1wb3J0ZWQpO1xuICAgICAgaW5wdXQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgcmVtb3ZldGFnKTtcbiAgICB9XG4gICAgZWwuZGF0YXNldC5pc2ltcG9ydGVkID0gdGhpcy5mb3JtLmRhdGFzZXQuaXNpbXBvcnRlZDtcbiAgICBlbC5jbGFzc0xpc3QuYWRkKGNzcy5pbXBvcnRlZCk7XG4gICAgaWYgKGlucHV0LmRhdGFzZXQudW5pcXVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGlucHV0LmRhdGFzZXQudW5pcXVlID0gaW5wdXQudmFsdWU7XG4gICAgfVxuICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCByZW1vdmV0YWcpO1xuICAgIH0sIDUwMCk7XG4gIH1cblxuICBkaXNtaXNzKGNsZWFyID0gZmFsc2UpIHtcbiAgICBpZiAodGhpcy5idXR0b24pIHRoaXMuc2hvd0ltcG9ydChmYWxzZSk7XG4gICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5kb20uY2xvc2VzdCgnZGV0YWlscycpO1xuICAgIGlmIChjb250YWluZXIpIHtcbiAgICAgIGNvbnRhaW5lci5vcGVuID0gZmFsc2U7XG4gICAgICBpZiAoY2xlYXIgPT09IHRydWUpIGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKHRoaXMuY29udGVudF9zZWxlY3RvcikuaW5uZXJIVE1MID0gYGA7XG4gICAgfVxuXG4gIH1cbiAgaW5kZXhUb0NoZWNrKCkge1xuICAgIC8vIGluZGV4IG9mIGNlbGxzIHRvIGNoZWNrIGlmIGVtcHR5IGFuZCBkaXNhYmxlIHJvdyAgaW1wb3J0IGJ0blxuICAgIGNvbnN0IGdyaWQgPSAodGhpcy50YmwpID8gdGhpcy50YmwuZ3JpZCA6IG51bGw7XG4gICAgaWYgKCFncmlkKSByZXR1cm4gWzBdO1xuICAgIGxldCBpbmRleCA9IGdyaWQuY29sdW1ucy5maW5kSW5kZXgoY29sdW1uID0+IChjb2x1bW4ud2hhdCAmJiBjb2x1bW4ud2hhdCA9PT0gdHlwZWltcG9ydC50YXhvKSk7XG4gICAgaWYgKGluZGV4ID09PSAtMSkgcmV0dXJuIFswXTtcbiAgICBjb25zdCBwYXJ0cyA9IChncmlkLmNvbHVtbnNbaW5kZXhdLnBhcnRzKSA/IGdyaWQuY29sdW1uc1tpbmRleF0ucGFydHMgOiBudWxsO1xuICAgIGlmIChwYXJ0cykge1xuICAgICAgY29uc3QgaW5kZXh0b2NoZWNrID0gZ3JpZC5jb2x1bW5zLmZpbHRlcigoY29sdW1uLCBpKSA9PiB7XG4gICAgICAgIGlmIChwYXJ0cy5pbmRleE9mKGNvbHVtbi5uYW1lKSA+PSAwKSByZXR1cm4gaTtcbiAgICAgIH0pLm1hcCh2ID0+IHtcbiAgICAgICAgcmV0dXJuIHYuaW5kZXg7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBpbmRleHRvY2hlY2s7XG4gICAgfVxuXG4gIH1cbiAgYWRkUmVzZXRCdXR0b24oKSB7XG4gICAgaWYgKCF0aGlzLnRibCB8fCAhdGhpcy50YmwucGFyYW1zLmhhc093blByb3BlcnR5KFwicmVzZXRcIikpIHJldHVybjtcbiAgICBsZXQgcmVzZXRidG4gPSB0aGlzLmRvbS5wYXJlbnRFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoZG9tc2VsZWN0b3JzLnJlc2V0YnV0dG9uKTtcbiAgICBpZiAocmVzZXRidG4gPT09IG51bGwpIHtcbiAgICAgIHJlc2V0YnRuID0gY3JlYXRlX2JveCgnYScsIHtcbiAgICAgICAgY2xhc3M6IGRvbXNlbGVjdG9ycy5yZXNldGJ1dHRvbi5zdWJzdHIoMSksXG4gICAgICAgIHRleHQ6IHRoaXMudGJsLnBhcmFtcy5yZXNldFxuICAgICAgfSwgdGhpcy5kb20ucGFyZW50RWxlbWVudC5maXJzdENoaWxkKTtcbiAgICAgIC8qICByZXNldGJ0biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcbiAgICAgICAgcmVzZXRidG4uY2xhc3NMaXN0LmFkZChkb21zZWxlY3RvcnMucmVzZXRidXR0b24uc3Vic3RyKDEpKTtcbiAgICAgICAgcmVzZXRidG4udGV4dENvbnRlbnQgPSB0aGlzLnRibC5wYXJhbXMucmVzZXQ7XG4gICAgICAgIHRoaXMuZG9tLnBhcmVudEVsZW1lbnQuZmlyc3RDaGlsZC5wcmVwZW5kKHJlc2V0YnRuKTsqL1xuICAgIH1cbiAgICByZXNldGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgICAgY29uc3Qgc2VsZWN0b3JzID0gdGhpcy5zZWxlY3RvcnMgPSB0aGlzLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCdbJyArIHRoaXMuc2VsZWN0b3IgKyAnXSBidXR0b246ZGlzYWJsZWQsIFsnICsgdGhpcy5zZWxlY3RvciArICddIGlucHV0OmRpc2FibGVkJyk7XG4gICAgICBzZWxlY3RvcnMuZm9yRWFjaChzZWxlY3RvciA9PiB7XG4gICAgICAgIHNlbGVjdG9yLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgIGNvbnN0IHNlbCA9IHNlbGVjdG9yLmNsb3Nlc3QoJ3RyJykucXVlcnlTZWxlY3RvcignLicgKyBjc3Muc2VsZWN0ZWQpO1xuICAgICAgICBpZiAoc2VsKSBzZWwuY2xhc3NMaXN0LnJlbW92ZShjc3Muc2VsZWN0ZWQpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgfVxuICAvLyBzaG93IC8gaGlkZSBpbXBvcnR6b25lIGFuZCBidXR0b25zXG4gIHNob3dJbXBvcnQoc2hvdykge1xuICAgIGlmICghdGhpcy5idXR0b24pIHJldHVybjtcbiAgICBpZiAoc2hvdyA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMuYnV0dG9uLmNsYXNzTGlzdC5hZGQoY3NzLmhpZGUpO1xuICAgICAgdGhpcy5yZXBsYWNlYnV0dG9uLmNsYXNzTGlzdC5hZGQoY3NzLmhpZGUpO1xuICAgICAgdGhpcy5pbXBvcnRjb250YWluZXIuY2xhc3NMaXN0LmFkZChjc3MuaGlkZSk7XG4gICAgICBpZiAodGhpcy50YWJidXR0b24pIHRoaXMudGFiYnV0dG9uLmNsYXNzTGlzdC5hZGQoY3NzLmhpZGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBpbXBvcnR6b25lID0gdGhpcy5pbXBvcnRjb250YWluZXIucXVlcnlTZWxlY3RvcignIycgKyB0aGlzLmltcG9ydGlkKTtcbiAgICAgIGlmIChpbXBvcnR6b25lKSB7XG4gICAgICAgIC8vICBjb25zdCBvZmZzZXRoID0gaW1wb3J0em9uZS50b21zZWxlY3QuY29udHJvbC5vZmZzZXRIZWlnaHQ7XG4gICAgICAgIC8vICBjb25zdCBzY3JvbGxoID0gaW1wb3J0em9uZS50b21zZWxlY3QuY29udHJvbC5zY3JvbGxIZWlnaHQ7XG4gICAgICAgIHRoaXMuYnV0dG9uLmNsYXNzTGlzdC5yZW1vdmUoY3NzLmhpZGUpO1xuICAgICAgICB0aGlzLnJlcGxhY2VidXR0b24uY2xhc3NMaXN0LnJlbW92ZShjc3MuaGlkZSk7XG4gICAgICAgIHRoaXMuaW1wb3J0Y29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoY3NzLmhpZGUpO1xuICAgICAgICB0aGlzLmJ1dHRvbi5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICBpZiAodGhpcy50YWJidXR0b24pIHtcbiAgICAgICAgICB0aGlzLnRhYmJ1dHRvbi5jbGFzc0xpc3QucmVtb3ZlKGNzcy5oaWRlKTtcbiAgICAgICAgICBpZiAoaW1wb3J0em9uZS50b21zZWxlY3QpIHtcbiAgICAgICAgICAgIHRoaXMudGFiYnV0dG9uLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgICAgfSBlbHNlIHRoaXMudGFiYnV0dG9uLmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGltcG9ydHpvbmU7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG4gIC8vIHJlc2l6ZSBpbXBvcnR6b25lXG4gIHJlc2l6ZVpvbmUoZSkge1xuICAgIGNvbnN0IGRpdiA9IHRoaXMuaW1wb3J0Y29udGFpbmVyLmNsb3Nlc3QoZG9tc2VsZWN0b3JzLmNvbXBvbmVudC5pbXBvcnQuem9uZWltcG9ydCk7XG4gICAgaWYgKCFkaXYpIHJldHVybjtcbiAgICBkaXYucGFyZW50RWxlbWVudC5jbGFzc0xpc3QudG9nZ2xlKGNzcy5zaG93ZnVsbCk7XG4gICAgY29uc3QgaWNvbiA9IGUuY3VycmVudFRhcmdldC5xdWVyeVNlbGVjdG9yKCdpJyk7XG4gICAgaWYgKGljb24pIHtcbiAgICAgIGljb24uY2xhc3NMaXN0LnRvZ2dsZShjc3MuYXJyb3dvdXQpO1xuICAgICAgaWNvbi5jbGFzc0xpc3QudG9nZ2xlKGNzcy5hcnJvd2luKTtcbiAgICB9XG4gIH1cbn0iXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///./src/modules/data-import.js\n")},"./src/modules/module-tom-select.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   JsTomSelect: () => (/* binding */ JsTomSelect)\n/* harmony export */ });\n/* harmony import */ var _css_tom_select_css__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../css/tom-select.css */ \"./src/css/tom-select.css\");\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! dompurify */ \"./node_modules/dompurify/dist/purify.js\");\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(dompurify__WEBPACK_IMPORTED_MODULE_1__);\n/* harmony import */ var tom_select_dist_js_tom_select_base_min_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! tom-select/dist/js/tom-select.base.min.js */ \"./node_modules/tom-select/dist/js/tom-select.base.min.js\");\n/* harmony import */ var tom_select_dist_js_tom_select_base_min_js__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(tom_select_dist_js_tom_select_base_min_js__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var tom_select_dist_js_plugins_remove_button_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! tom-select/dist/js/plugins/remove_button.js */ \"./node_modules/tom-select/dist/js/plugins/remove_button.js\");\n/* harmony import */ var tom_select_dist_js_plugins_remove_button_js__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(tom_select_dist_js_plugins_remove_button_js__WEBPACK_IMPORTED_MODULE_3__);\n/* harmony import */ var tom_select_dist_js_plugins_clear_button_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! tom-select/dist/js/plugins/clear_button.js */ \"./node_modules/tom-select/dist/js/plugins/clear_button.js\");\n/* harmony import */ var tom_select_dist_js_plugins_clear_button_js__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(tom_select_dist_js_plugins_clear_button_js__WEBPACK_IMPORTED_MODULE_4__);\n/* harmony import */ var tom_select_dist_js_plugins_caret_position_js__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! tom-select/dist/js/plugins/caret_position.js */ \"./node_modules/tom-select/dist/js/plugins/caret_position.js\");\n/* harmony import */ var tom_select_dist_js_plugins_caret_position_js__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(tom_select_dist_js_plugins_caret_position_js__WEBPACK_IMPORTED_MODULE_5__);\n/* harmony import */ var _modules_utils_js__WEBPACK_IMPORTED_MODULE_6__ = __webpack_require__(/*! ../modules/utils.js */ \"./src/modules/utils.js\");\n/* harmony import */ var _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__ = __webpack_require__(/*! ../modules/modules-config.js */ \"./src/modules/modules-config.js\");\n\n\n\n\n\n\n\ntom_select_dist_js_tom_select_base_min_js__WEBPACK_IMPORTED_MODULE_2___default().define('remove_button', (tom_select_dist_js_plugins_remove_button_js__WEBPACK_IMPORTED_MODULE_3___default()));\ntom_select_dist_js_tom_select_base_min_js__WEBPACK_IMPORTED_MODULE_2___default().define('clear_button', (tom_select_dist_js_plugins_clear_button_js__WEBPACK_IMPORTED_MODULE_4___default()));\ntom_select_dist_js_tom_select_base_min_js__WEBPACK_IMPORTED_MODULE_2___default().define('caret_position', (tom_select_dist_js_plugins_caret_position_js__WEBPACK_IMPORTED_MODULE_5___default()));\n\n\nlet users_list = {};\n\nfunction _get_label(el, labelfield, item = false) {\n  if (!labelfield) return el.text;\n  let label = [];\n  if (Object.keys(el).indexOf(labelfield) >= 0) label.push(el[labelfield]);\n  else if (labelfield.indexOf('+') > 0) {\n    if (item === true) label.push(el[labelfield.split('+')[0]]);\n    else labelfield.split('+').forEach(l => {\n      if (l in el) label.push(el[l]);\n    });\n  }\n  return label.join(` `);\n}\n// settings for autocomplete select component - users , instruments , taxons\nfunction JsTomSelect() {\n  function applyTo(item, settings = {}, siblings = null) {\n    const id = item.getAttribute('id');\n    const multiple = item.hasAttribute('multiple');\n    const type = item.dataset.type;\n    let option = {\n        url: '',\n        settings: settings\n      },\n      init_canceltag = (tag) => {\n        tag.addEventListener('click', (e) => {\n          const v = e.currentTarget.closest(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.domselectors.component.tomselect.item).dataset.value;\n          if (v) {\n            e.stopImmediatePropagation();\n            item.tomselect.removeItem(v);\n          }\n        })\n      }\n    if (item.dataset.create && item.dataset.create === 'true') {\n      //  option.settings.create = true;\n      //  option.settings.createOnBlur = true;\n      option.settings.create = true;\n      option.settings.addPrecedence = true;\n    }\n    if (item.dataset.empty && item.dataset.empty === 'true') {\n      option.settings.allowEmptyOption = true;\n    }\n    if (item.dataset.maxitems) {\n      option.settings.maxItems = parseInt(item.dataset.maxitems);\n    }\n    if (item.dataset.addoption) {\n      option.settings.addoption = item.dataset.addoption.split(',');\n    }\n    /*,\n          on_clear = function() {\n\n            if (item.tagName.toLowerCase() === 'select')\n              item.querySelectorAll('option:checked').forEach(option => {\n                option.removeAttribute('selected');\n              });\n            item.selectedIndex = -1;\n            return true;\n          }*/\n    ;\n\n    switch (type) {\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.project:\n        // for top navigation search and collections\n        const maxitems = (multiple) ? null : 1;\n        option.url = \"/gui/prjlist/\";\n        option.settings = { ...option.settings,\n          ...{\n            valueField: 'id',\n            searchField: 'text',\n            labelField: 'text',\n            openOnFocus: false,\n            maxItems: maxitems,\n            allowEmptyOption: false,\n          }\n        };\n\n        break;\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.user:\n        option.url = \"/api/users/search?by_name=\";\n        option.settings = { ...option.settings,\n          ...{\n            valueField: 'id',\n            searchField: 'name',\n            labelField: 'name+email',\n            onInitialize: function() {\n              if (item.currentlist) users_list = item.currentlist;\n              else item.tomselect.items.forEach(e => {\n                if (e !== '' && parseInt(e) > 0) users_list[e] = true;\n              });\n            },\n            onItemAdd: function(e) {\n              if (e === \"\") return;\n              if (users_list[e]) {\n                //  if (multiple || !this.revertSettings || this.revertSettings.tabIndex < 0 || !item.options.length) return;\n                if (window.alertbox) {\n                  console.log('itemtoms', item)\n                  window.alertbox.addItemMessage({\n                    type: window.alertbox.alertconfig.types.danger,\n                    parent: item,\n                    content: window.alertbox.i18nmessages.exists\n                  });\n                } else {\n                  item.dataset.invalid = window.alertbox.i18nmessages.exists;\n                  item.dispatchEvent(new Event('invalid'));\n                }\n                setTimeout(() => {\n                  this.removeOption(e);\n                  if (this.revertSettings.tabIndex < 0 || !item.options.length || !this.revertSettings) {\n                    this.removeItem(e);\n                    users_list[e] = true;\n                  } else {\n                    const revert = item.options[this.revertSettings.tabIndex].value;\n                    this.addItem(revert);\n                  }\n                  if (window.alertbox) {\n                    window.alertbox.removeItemMessage({\n                      type: window.alertbox.alertconfig.types.danger,\n                      parent: item,\n                      content: window.alertbox.i18nmessages.exists\n                    });\n                  } else {\n                    delete item.dataset.invalid;\n                    item.dispatchEvent(new Event('undeterminate'));\n                  }\n                }, 2000);\n              } else users_list[e] = true;\n            },\n            onItemRemove: function(e) {\n              if (users_list[e]) delete users_list[e];\n              if (multiple || !this.revertSettings || (this.revertSettings.innerHTML === '' && this.revertSettings.tabIndex === 0) || this.revertSettings.tabIndex < 0) return;\n              const revert = item.options[this.revertSettings.tabIndex].value;\n              if (users_list[revert] !== undefined) delete users_list[revert];\n\n            }\n          }\n        };\n        break;\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.instr:\n        option.url = \"/search/instruments\";\n        option.settings = {\n          valueField: 'id',\n          labelField: 'text',\n          searchField: 'id',\n          maxItems: 1,\n          preload: true\n        };\n        break;\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.taxo:\n        tom_select_dist_js_tom_select_base_min_js__WEBPACK_IMPORTED_MODULE_2___default().define('no_close', () => {\n          this.close = () => {};\n        });\n\n        option.url = \"/search/taxo\";\n        option.settings = { ...option.settings,\n          ...{\n            valueField: 'id',\n            labelField: 'text',\n            searchField: 'text',\n            closeAfterSelect: true,\n            onInitialize: () => {\n              const wrapper = document.getElementById(id).nextElementSibling;\n              if (!wrapper.classList.contains('ts-wrapper')) return;\n              const tags = wrapper.querySelectorAll(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.domselectors.component.tomselect.tsdelet);\n              tags.forEach(tag => {\n                init_canceltag(tag);\n              })\n            }\n\n          }\n        }\n\n        break;\n    }\n    const default_settings = {\n      create: false,\n      minOptions: 0,\n      maxOptions: null,\n      preload: false,\n      hideSelected: true,\n      duplicates: false,\n      allowEmptyOption: true,\n      closeAfterSelect: true,\n      placeholder: (item.placeholder) ? item.placeholder : ((item.dataset.placeholder) ? item.dataset.placeholder : ''),\n      onDropdownClose: function() {\n\n      },\n      shouldLoad: function(query) {\n        return query.length > 2\n      },\n      onItemRemove: function() {\n        return true;\n      },\n      load: function(query, callback) {\n        query = dompurify__WEBPACK_IMPORTED_MODULE_1___default().sanitize(query);\n\n        const self = this;\n        if (self.loading > 10) {\n\n          callback();\n          return;\n        }\n        let url = '';\n        switch (type) {\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.user:\n            url = option.url + encodeURIComponent('%' + query + '%');\n            break;\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.instr:\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.taxo:\n            url = option.url;\n            //\n\n            if (query.indexOf('_') == 0 && option.settings.addoption && query == option.settings.addoption[0]) {\n              url = null;\n              return callback(Object.entries([{\n                text: option.settings.addoption[0],\n                id: option.settings.addoption[1]\n              }]));\n            }\n            //\n            if (query) url += '?q=' + encodeURIComponent(query);\n\n            break;\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.project:\n            url = option.url;\n\n            if (query) url += '?filt_title=' + encodeURIComponent(query); //+ '&filt_instrum=' + encodeURIComponent(query);\n            break;\n        }\n        if (url !== null) fetch(url, (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_6__.fetchSettings)()).then(response => response.json()).then(json => {\n          if (type === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.project) {\n\n            if (json.data && json.data.length) json = json.data.map(row => {\n              return {\n                id: row[1],\n                text: row[3][0],\n                rights: row[0]\n              }\n\n            });\n          }\n          if (type === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.instr && json.length) json = json.reduce((result, a, v) => {\n            a = dompurify__WEBPACK_IMPORTED_MODULE_1___default().sanitize(a);\n            let obj = {\n              id: a,\n              text: a\n            }\n            result.push(obj);\n\n            return result;\n          }, []);\n\n          if (json.length && typeof json == 'object') json = Object.entries(json);\n          return callback(json);\n\n        }).catch(err => {\n          console.log('tomselect-err', err);\n        });\n      },\n\n      render: {\n        option: function(el, escape) {\n          if (el === undefined || el === null) return ``;\n          // add optgroup\n          const optgroup = (el.hasOwnProperty('optgroup')) ? `data-optgroup=${el.optgroup}` : ``;\n          const label = _get_label(el, option.settings.labelField);\n          return `<div class=\"py-2 flex  ${ ((multiple)?'inline-flex':'') } \" ${optgroup} data-value=\"${el[option.settings.valueField]}\">${ escape(label) }</div>`;\n        },\n        item: function(el, escape) {\n          if (el === undefined || el === null) return ``; // add optgroup\n          const optgroup = (el.optgroup) ? `item-${el.optgroup}` : ``;\n          const inlist = (users_list[el[this.settings.valueField]]) ? `data-inlist` : ``;\n          // add cancel icon for multiple selections\n          //  const cancel = ((multiple) ? `<i class=\"${domselectors.component.tomselect.tsdelet.substr(1)}\"></i>` : ``);\n          // use ts plugin remove_button\n          const cancel = ``;\n          const label = _get_label(el, option.settings.labelField, true);\n          return dompurify__WEBPACK_IMPORTED_MODULE_1___default().sanitize(`<div class=\"${((multiple) ? `flex inline-flex ` : ``) } ${optgroup}\"  data-value=\"${el[this.settings.valueField]}\"  ${inlist}>${ escape(label) } ${ cancel }</div>`);\n        },\n        no_results: function(data, escape) {\n          return dompurify__WEBPACK_IMPORTED_MODULE_1___default().sanitize('<div class=\"no-results\">' + ((item.dataset.noresults) ? item.dataset.noresults : 'No result found for ') + escape(data.input) + '</div>');\n        },\n\n      }\n    }\n\n    option.settings.plugins = {\n      'clear_button': {\n        title: (item.dataset.clear) ? item.dataset.clear : 'Clear all',\n        html: (data) => {\n          return `<div class=\"${data.className}\" id=\"clear-${id}\" title=\"${data.title}\"><i class=\"icon ${(multiple)?``:'p-[0.125rem]'} icon-x-circle-sm ${(multiple)?``:` opacity-50`}\"></i></div>`;\n        }\n      }\n    }\n    option.settings.onClear = function() {\n      item.tomselect.clear();\n      return true;\n    }\n    if (multiple) {\n      option.settings.plugins = { ...option.settings.plugins,\n        ...{\n          'remove_button': {}\n        }\n\n      };\n      option.settings.plugins = { ...option.settings.plugins,\n        ...{\n          'caret_position': {}\n        }\n\n      };\n    }\n    option.settings = Object.assign(default_settings, option.settings)\n    if (id !== null) {\n      const ts = new (tom_select_dist_js_tom_select_base_min_js__WEBPACK_IMPORTED_MODULE_2___default())('#' + id, option.settings);\n      ts.wrapper.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.domselectors.component.tomselect.ident);\n      ts.wrapper.classList.remove('js');\n      // add\n      ts.wrapper.setAttribute('data-component', 'tom-select');\n      switch (type) {\n        case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.taxo:\n          ts.on('item_add', (v, el) => {\n            if (el !== null) el.classList.add('new');\n            //  el = el.querySelector('.ts-delet');\n            //  if (el !== null) init_canceltag(el);\n          });\n          //\n          break;\n        case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_7__.models.project:\n          // add data-noaction just to select a project\n          if (item.dataset.dest) {\n\n            ts.on('item_add', (v, el) => {\n              if (v != item.dataset.value && ts.options[v] && !el.querySelector('a')) {\n                const links = {\n                  \"A\": \"/prj/\",\n                  \"V\": \"/prj/\",\n                  \"M\": \"/gui/prj/edit/\"\n                };\n                const rights = ts.options[v].rights;\n                const keys = Object.keys(rights);\n                if (keys) {\n                  if (keys.length > 1) {\n                    Object.entries(rights).forEach(([k, r]) => {\n                      el.insertAdjacentHTML('beforeend', ` <a data-k=\"${k}\" class=\"small-caps font-normal ml-2\">${r}</a>`);\n                    });\n                    el.querySelectorAll('a').forEach(lk => {\n                      lk.addEventListener('click', (e) => {\n                        e.preventDefault();\n                        e.stopPropagation();\n                        window.open(links[e.target.dataset.k] + v, `_proj${v}`).focus();\n                        ts.removeItem(v);\n                      });\n                    })\n                  } else {\n                    window.open(links[keys[0]] + v, `_proj${v}`).focus();\n                    ts.removeItem(v);\n                  }\n                }\n              }\n            });\n          }\n          break;\n          /*  case 'user':\n              if (item.dataset.priv) ts.on(\"item_add\", function(v, el) {\n                el = el.querySelector(domselectors.component.tomselect.tsdelet);\n                if (el !== null) init_canceltag(el);\n              });\n              break;*/\n      }\n      return ts;\n    } else console.log('noid');\n\n  }\n\n  function getUserList() {\n    return users_list;\n  }\n  return {\n    applyTo\n  }\n}//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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O0FBQ3BCLDREQUE0RCxFQUFFO0FBQzlEO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGVBQWU7QUFDZixvQkFBb0I7QUFDcEI7QUFDQTtBQUNBLE1BQU07O0FBRU47O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi9zcmMvbW9kdWxlcy9tb2R1bGUtdG9tLXNlbGVjdC5qcz9hMWQ5Il0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcbmltcG9ydCB0b21TZWxlY3Rjc3MgZnJvbSBcIi4uL2Nzcy90b20tc2VsZWN0LmNzc1wiO1xuaW1wb3J0IERPTVB1cmlmeSBmcm9tICdkb21wdXJpZnknO1xuaW1wb3J0IFRvbVNlbGVjdCBmcm9tICd0b20tc2VsZWN0L2Rpc3QvanMvdG9tLXNlbGVjdC5iYXNlLm1pbi5qcyc7XG5pbXBvcnQgVG9tU2VsZWN0X3JlbW92ZV9idXR0b24gZnJvbSAndG9tLXNlbGVjdC9kaXN0L2pzL3BsdWdpbnMvcmVtb3ZlX2J1dHRvbi5qcyc7XG5pbXBvcnQgVG9tU2VsZWN0X2NsZWFyX2J1dHRvbiBmcm9tICd0b20tc2VsZWN0L2Rpc3QvanMvcGx1Z2lucy9jbGVhcl9idXR0b24uanMnO1xuaW1wb3J0IFRvbVNlbGVjdF9jYXJldF9wb3NpdGlvbiBmcm9tICd0b20tc2VsZWN0L2Rpc3QvanMvcGx1Z2lucy9jYXJldF9wb3NpdGlvbi5qcyc7XG5Ub21TZWxlY3QuZGVmaW5lKCdyZW1vdmVfYnV0dG9uJywgVG9tU2VsZWN0X3JlbW92ZV9idXR0b24pO1xuVG9tU2VsZWN0LmRlZmluZSgnY2xlYXJfYnV0dG9uJywgVG9tU2VsZWN0X2NsZWFyX2J1dHRvbik7XG5Ub21TZWxlY3QuZGVmaW5lKCdjYXJldF9wb3NpdGlvbicsIFRvbVNlbGVjdF9jYXJldF9wb3NpdGlvbik7XG5pbXBvcnQge1xuICBmZXRjaFNldHRpbmdzXG59IGZyb20gJy4uL21vZHVsZXMvdXRpbHMuanMnO1xuaW1wb3J0IHtcbiAgbW9kZWxzLFxuICBkb21zZWxlY3RvcnMsXG4gIGNzcyxcbn0gZnJvbSAnLi4vbW9kdWxlcy9tb2R1bGVzLWNvbmZpZy5qcyc7XG5sZXQgdXNlcnNfbGlzdCA9IHt9O1xuXG5mdW5jdGlvbiBfZ2V0X2xhYmVsKGVsLCBsYWJlbGZpZWxkLCBpdGVtID0gZmFsc2UpIHtcbiAgaWYgKCFsYWJlbGZpZWxkKSByZXR1cm4gZWwudGV4dDtcbiAgbGV0IGxhYmVsID0gW107XG4gIGlmIChPYmplY3Qua2V5cyhlbCkuaW5kZXhPZihsYWJlbGZpZWxkKSA+PSAwKSBsYWJlbC5wdXNoKGVsW2xhYmVsZmllbGRdKTtcbiAgZWxzZSBpZiAobGFiZWxmaWVsZC5pbmRleE9mKCcrJykgPiAwKSB7XG4gICAgaWYgKGl0ZW0gPT09IHRydWUpIGxhYmVsLnB1c2goZWxbbGFiZWxmaWVsZC5zcGxpdCgnKycpWzBdXSk7XG4gICAgZWxzZSBsYWJlbGZpZWxkLnNwbGl0KCcrJykuZm9yRWFjaChsID0+IHtcbiAgICAgIGlmIChsIGluIGVsKSBsYWJlbC5wdXNoKGVsW2xdKTtcbiAgICB9KTtcbiAgfVxuICByZXR1cm4gbGFiZWwuam9pbihgIGApO1xufVxuLy8gc2V0dGluZ3MgZm9yIGF1dG9jb21wbGV0ZSBzZWxlY3QgY29tcG9uZW50IC0gdXNlcnMgLCBpbnN0cnVtZW50cyAsIHRheG9uc1xuZXhwb3J0IGZ1bmN0aW9uIEpzVG9tU2VsZWN0KCkge1xuICBmdW5jdGlvbiBhcHBseVRvKGl0ZW0sIHNldHRpbmdzID0ge30sIHNpYmxpbmdzID0gbnVsbCkge1xuICAgIGNvbnN0IGlkID0gaXRlbS5nZXRBdHRyaWJ1dGUoJ2lkJyk7XG4gICAgY29uc3QgbXVsdGlwbGUgPSBpdGVtLmhhc0F0dHJpYnV0ZSgnbXVsdGlwbGUnKTtcbiAgICBjb25zdCB0eXBlID0gaXRlbS5kYXRhc2V0LnR5cGU7XG4gICAgbGV0IG9wdGlvbiA9IHtcbiAgICAgICAgdXJsOiAnJyxcbiAgICAgICAgc2V0dGluZ3M6IHNldHRpbmdzXG4gICAgICB9LFxuICAgICAgaW5pdF9jYW5jZWx0YWcgPSAodGFnKSA9PiB7XG4gICAgICAgIHRhZy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICAgICAgY29uc3QgdiA9IGUuY3VycmVudFRhcmdldC5jbG9zZXN0KGRvbXNlbGVjdG9ycy5jb21wb25lbnQudG9tc2VsZWN0Lml0ZW0pLmRhdGFzZXQudmFsdWU7XG4gICAgICAgICAgaWYgKHYpIHtcbiAgICAgICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICBpdGVtLnRvbXNlbGVjdC5yZW1vdmVJdGVtKHYpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICBpZiAoaXRlbS5kYXRhc2V0LmNyZWF0ZSAmJiBpdGVtLmRhdGFzZXQuY3JlYXRlID09PSAndHJ1ZScpIHtcbiAgICAgIC8vICBvcHRpb24uc2V0dGluZ3MuY3JlYXRlID0gdHJ1ZTtcbiAgICAgIC8vICBvcHRpb24uc2V0dGluZ3MuY3JlYXRlT25CbHVyID0gdHJ1ZTtcbiAgICAgIG9wdGlvbi5zZXR0aW5ncy5jcmVhdGUgPSB0cnVlO1xuICAgICAgb3B0aW9uLnNldHRpbmdzLmFkZFByZWNlZGVuY2UgPSB0cnVlO1xuICAgIH1cbiAgICBpZiAoaXRlbS5kYXRhc2V0LmVtcHR5ICYmIGl0ZW0uZGF0YXNldC5lbXB0eSA9PT0gJ3RydWUnKSB7XG4gICAgICBvcHRpb24uc2V0dGluZ3MuYWxsb3dFbXB0eU9wdGlvbiA9IHRydWU7XG4gICAgfVxuICAgIGlmIChpdGVtLmRhdGFzZXQubWF4aXRlbXMpIHtcbiAgICAgIG9wdGlvbi5zZXR0aW5ncy5tYXhJdGVtcyA9IHBhcnNlSW50KGl0ZW0uZGF0YXNldC5tYXhpdGVtcyk7XG4gICAgfVxuICAgIGlmIChpdGVtLmRhdGFzZXQuYWRkb3B0aW9uKSB7XG4gICAgICBvcHRpb24uc2V0dGluZ3MuYWRkb3B0aW9uID0gaXRlbS5kYXRhc2V0LmFkZG9wdGlvbi5zcGxpdCgnLCcpO1xuICAgIH1cbiAgICAvKixcbiAgICAgICAgICBvbl9jbGVhciA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICBpZiAoaXRlbS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdzZWxlY3QnKVxuICAgICAgICAgICAgICBpdGVtLnF1ZXJ5U2VsZWN0b3JBbGwoJ29wdGlvbjpjaGVja2VkJykuZm9yRWFjaChvcHRpb24gPT4ge1xuICAgICAgICAgICAgICAgIG9wdGlvbi5yZW1vdmVBdHRyaWJ1dGUoJ3NlbGVjdGVkJyk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaXRlbS5zZWxlY3RlZEluZGV4ID0gLTE7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9Ki9cbiAgICA7XG5cbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgbW9kZWxzLnByb2plY3Q6XG4gICAgICAgIC8vIGZvciB0b3AgbmF2aWdhdGlvbiBzZWFyY2ggYW5kIGNvbGxlY3Rpb25zXG4gICAgICAgIGNvbnN0IG1heGl0ZW1zID0gKG11bHRpcGxlKSA/IG51bGwgOiAxO1xuICAgICAgICBvcHRpb24udXJsID0gXCIvZ3VpL3Byamxpc3QvXCI7XG4gICAgICAgIG9wdGlvbi5zZXR0aW5ncyA9IHsgLi4ub3B0aW9uLnNldHRpbmdzLFxuICAgICAgICAgIC4uLntcbiAgICAgICAgICAgIHZhbHVlRmllbGQ6ICdpZCcsXG4gICAgICAgICAgICBzZWFyY2hGaWVsZDogJ3RleHQnLFxuICAgICAgICAgICAgbGFiZWxGaWVsZDogJ3RleHQnLFxuICAgICAgICAgICAgb3Blbk9uRm9jdXM6IGZhbHNlLFxuICAgICAgICAgICAgbWF4SXRlbXM6IG1heGl0ZW1zLFxuICAgICAgICAgICAgYWxsb3dFbXB0eU9wdGlvbjogZmFsc2UsXG4gICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBtb2RlbHMudXNlcjpcbiAgICAgICAgb3B0aW9uLnVybCA9IFwiL2FwaS91c2Vycy9zZWFyY2g/YnlfbmFtZT1cIjtcbiAgICAgICAgb3B0aW9uLnNldHRpbmdzID0geyAuLi5vcHRpb24uc2V0dGluZ3MsXG4gICAgICAgICAgLi4ue1xuICAgICAgICAgICAgdmFsdWVGaWVsZDogJ2lkJyxcbiAgICAgICAgICAgIHNlYXJjaEZpZWxkOiAnbmFtZScsXG4gICAgICAgICAgICBsYWJlbEZpZWxkOiAnbmFtZStlbWFpbCcsXG4gICAgICAgICAgICBvbkluaXRpYWxpemU6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICBpZiAoaXRlbS5jdXJyZW50bGlzdCkgdXNlcnNfbGlzdCA9IGl0ZW0uY3VycmVudGxpc3Q7XG4gICAgICAgICAgICAgIGVsc2UgaXRlbS50b21zZWxlY3QuaXRlbXMuZm9yRWFjaChlID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZSAhPT0gJycgJiYgcGFyc2VJbnQoZSkgPiAwKSB1c2Vyc19saXN0W2VdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25JdGVtQWRkOiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICAgIGlmIChlID09PSBcIlwiKSByZXR1cm47XG4gICAgICAgICAgICAgIGlmICh1c2Vyc19saXN0W2VdKSB7XG4gICAgICAgICAgICAgICAgLy8gIGlmIChtdWx0aXBsZSB8fCAhdGhpcy5yZXZlcnRTZXR0aW5ncyB8fCB0aGlzLnJldmVydFNldHRpbmdzLnRhYkluZGV4IDwgMCB8fCAhaXRlbS5vcHRpb25zLmxlbmd0aCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuYWxlcnRib3gpIHtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdpdGVtdG9tcycsIGl0ZW0pXG4gICAgICAgICAgICAgICAgICB3aW5kb3cuYWxlcnRib3guYWRkSXRlbU1lc3NhZ2Uoe1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiB3aW5kb3cuYWxlcnRib3guYWxlcnRjb25maWcudHlwZXMuZGFuZ2VyLFxuICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IGl0ZW0sXG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHdpbmRvdy5hbGVydGJveC5pMThubWVzc2FnZXMuZXhpc3RzXG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgaXRlbS5kYXRhc2V0LmludmFsaWQgPSB3aW5kb3cuYWxlcnRib3guaTE4bm1lc3NhZ2VzLmV4aXN0cztcbiAgICAgICAgICAgICAgICAgIGl0ZW0uZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoJ2ludmFsaWQnKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVPcHRpb24oZSk7XG4gICAgICAgICAgICAgICAgICBpZiAodGhpcy5yZXZlcnRTZXR0aW5ncy50YWJJbmRleCA8IDAgfHwgIWl0ZW0ub3B0aW9ucy5sZW5ndGggfHwgIXRoaXMucmV2ZXJ0U2V0dGluZ3MpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVJdGVtKGUpO1xuICAgICAgICAgICAgICAgICAgICB1c2Vyc19saXN0W2VdID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJldmVydCA9IGl0ZW0ub3B0aW9uc1t0aGlzLnJldmVydFNldHRpbmdzLnRhYkluZGV4XS52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRJdGVtKHJldmVydCk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICBpZiAod2luZG93LmFsZXJ0Ym94KSB7XG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5hbGVydGJveC5yZW1vdmVJdGVtTWVzc2FnZSh7XG4gICAgICAgICAgICAgICAgICAgICAgdHlwZTogd2luZG93LmFsZXJ0Ym94LmFsZXJ0Y29uZmlnLnR5cGVzLmRhbmdlcixcbiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQ6IGl0ZW0sXG4gICAgICAgICAgICAgICAgICAgICAgY29udGVudDogd2luZG93LmFsZXJ0Ym94LmkxOG5tZXNzYWdlcy5leGlzdHNcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgaXRlbS5kYXRhc2V0LmludmFsaWQ7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0uZGlzcGF0Y2hFdmVudChuZXcgRXZlbnQoJ3VuZGV0ZXJtaW5hdGUnKSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgMjAwMCk7XG4gICAgICAgICAgICAgIH0gZWxzZSB1c2Vyc19saXN0W2VdID0gdHJ1ZTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvbkl0ZW1SZW1vdmU6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgaWYgKHVzZXJzX2xpc3RbZV0pIGRlbGV0ZSB1c2Vyc19saXN0W2VdO1xuICAgICAgICAgICAgICBpZiAobXVsdGlwbGUgfHwgIXRoaXMucmV2ZXJ0U2V0dGluZ3MgfHwgKHRoaXMucmV2ZXJ0U2V0dGluZ3MuaW5uZXJIVE1MID09PSAnJyAmJiB0aGlzLnJldmVydFNldHRpbmdzLnRhYkluZGV4ID09PSAwKSB8fCB0aGlzLnJldmVydFNldHRpbmdzLnRhYkluZGV4IDwgMCkgcmV0dXJuO1xuICAgICAgICAgICAgICBjb25zdCByZXZlcnQgPSBpdGVtLm9wdGlvbnNbdGhpcy5yZXZlcnRTZXR0aW5ncy50YWJJbmRleF0udmFsdWU7XG4gICAgICAgICAgICAgIGlmICh1c2Vyc19saXN0W3JldmVydF0gIT09IHVuZGVmaW5lZCkgZGVsZXRlIHVzZXJzX2xpc3RbcmV2ZXJ0XTtcblxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIG1vZGVscy5pbnN0cjpcbiAgICAgICAgb3B0aW9uLnVybCA9IFwiL3NlYXJjaC9pbnN0cnVtZW50c1wiO1xuICAgICAgICBvcHRpb24uc2V0dGluZ3MgPSB7XG4gICAgICAgICAgdmFsdWVGaWVsZDogJ2lkJyxcbiAgICAgICAgICBsYWJlbEZpZWxkOiAndGV4dCcsXG4gICAgICAgICAgc2VhcmNoRmllbGQ6ICdpZCcsXG4gICAgICAgICAgbWF4SXRlbXM6IDEsXG4gICAgICAgICAgcHJlbG9hZDogdHJ1ZVxuICAgICAgICB9O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgbW9kZWxzLnRheG86XG4gICAgICAgIFRvbVNlbGVjdC5kZWZpbmUoJ25vX2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgIHRoaXMuY2xvc2UgPSAoKSA9PiB7fTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgb3B0aW9uLnVybCA9IFwiL3NlYXJjaC90YXhvXCI7XG4gICAgICAgIG9wdGlvbi5zZXR0aW5ncyA9IHsgLi4ub3B0aW9uLnNldHRpbmdzLFxuICAgICAgICAgIC4uLntcbiAgICAgICAgICAgIHZhbHVlRmllbGQ6ICdpZCcsXG4gICAgICAgICAgICBsYWJlbEZpZWxkOiAndGV4dCcsXG4gICAgICAgICAgICBzZWFyY2hGaWVsZDogJ3RleHQnLFxuICAgICAgICAgICAgY2xvc2VBZnRlclNlbGVjdDogdHJ1ZSxcbiAgICAgICAgICAgIG9uSW5pdGlhbGl6ZTogKCkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCB3cmFwcGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpLm5leHRFbGVtZW50U2libGluZztcbiAgICAgICAgICAgICAgaWYgKCF3cmFwcGVyLmNsYXNzTGlzdC5jb250YWlucygndHMtd3JhcHBlcicpKSByZXR1cm47XG4gICAgICAgICAgICAgIGNvbnN0IHRhZ3MgPSB3cmFwcGVyLnF1ZXJ5U2VsZWN0b3JBbGwoZG9tc2VsZWN0b3JzLmNvbXBvbmVudC50b21zZWxlY3QudHNkZWxldCk7XG4gICAgICAgICAgICAgIHRhZ3MuZm9yRWFjaCh0YWcgPT4ge1xuICAgICAgICAgICAgICAgIGluaXRfY2FuY2VsdGFnKHRhZyk7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBicmVhaztcbiAgICB9XG4gICAgY29uc3QgZGVmYXVsdF9zZXR0aW5ncyA9IHtcbiAgICAgIGNyZWF0ZTogZmFsc2UsXG4gICAgICBtaW5PcHRpb25zOiAwLFxuICAgICAgbWF4T3B0aW9uczogbnVsbCxcbiAgICAgIHByZWxvYWQ6IGZhbHNlLFxuICAgICAgaGlkZVNlbGVjdGVkOiB0cnVlLFxuICAgICAgZHVwbGljYXRlczogZmFsc2UsXG4gICAgICBhbGxvd0VtcHR5T3B0aW9uOiB0cnVlLFxuICAgICAgY2xvc2VBZnRlclNlbGVjdDogdHJ1ZSxcbiAgICAgIHBsYWNlaG9sZGVyOiAoaXRlbS5wbGFjZWhvbGRlcikgPyBpdGVtLnBsYWNlaG9sZGVyIDogKChpdGVtLmRhdGFzZXQucGxhY2Vob2xkZXIpID8gaXRlbS5kYXRhc2V0LnBsYWNlaG9sZGVyIDogJycpLFxuICAgICAgb25Ecm9wZG93bkNsb3NlOiBmdW5jdGlvbigpIHtcblxuICAgICAgfSxcbiAgICAgIHNob3VsZExvYWQ6IGZ1bmN0aW9uKHF1ZXJ5KSB7XG4gICAgICAgIHJldHVybiBxdWVyeS5sZW5ndGggPiAyXG4gICAgICB9LFxuICAgICAgb25JdGVtUmVtb3ZlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9LFxuICAgICAgbG9hZDogZnVuY3Rpb24ocXVlcnksIGNhbGxiYWNrKSB7XG4gICAgICAgIHF1ZXJ5ID0gRE9NUHVyaWZ5LnNhbml0aXplKHF1ZXJ5KTtcblxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICAgICAgaWYgKHNlbGYubG9hZGluZyA+IDEwKSB7XG5cbiAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBsZXQgdXJsID0gJyc7XG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgIGNhc2UgbW9kZWxzLnVzZXI6XG4gICAgICAgICAgICB1cmwgPSBvcHRpb24udXJsICsgZW5jb2RlVVJJQ29tcG9uZW50KCclJyArIHF1ZXJ5ICsgJyUnKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgbW9kZWxzLmluc3RyOlxuICAgICAgICAgIGNhc2UgbW9kZWxzLnRheG86XG4gICAgICAgICAgICB1cmwgPSBvcHRpb24udXJsO1xuICAgICAgICAgICAgLy9cblxuICAgICAgICAgICAgaWYgKHF1ZXJ5LmluZGV4T2YoJ18nKSA9PSAwICYmIG9wdGlvbi5zZXR0aW5ncy5hZGRvcHRpb24gJiYgcXVlcnkgPT0gb3B0aW9uLnNldHRpbmdzLmFkZG9wdGlvblswXSkge1xuICAgICAgICAgICAgICB1cmwgPSBudWxsO1xuICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2soT2JqZWN0LmVudHJpZXMoW3tcbiAgICAgICAgICAgICAgICB0ZXh0OiBvcHRpb24uc2V0dGluZ3MuYWRkb3B0aW9uWzBdLFxuICAgICAgICAgICAgICAgIGlkOiBvcHRpb24uc2V0dGluZ3MuYWRkb3B0aW9uWzFdXG4gICAgICAgICAgICAgIH1dKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgaWYgKHF1ZXJ5KSB1cmwgKz0gJz9xPScgKyBlbmNvZGVVUklDb21wb25lbnQocXVlcnkpO1xuXG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIG1vZGVscy5wcm9qZWN0OlxuICAgICAgICAgICAgdXJsID0gb3B0aW9uLnVybDtcblxuICAgICAgICAgICAgaWYgKHF1ZXJ5KSB1cmwgKz0gJz9maWx0X3RpdGxlPScgKyBlbmNvZGVVUklDb21wb25lbnQocXVlcnkpOyAvLysgJyZmaWx0X2luc3RydW09JyArIGVuY29kZVVSSUNvbXBvbmVudChxdWVyeSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBpZiAodXJsICE9PSBudWxsKSBmZXRjaCh1cmwsIGZldGNoU2V0dGluZ3MoKSkudGhlbihyZXNwb25zZSA9PiByZXNwb25zZS5qc29uKCkpLnRoZW4oanNvbiA9PiB7XG4gICAgICAgICAgaWYgKHR5cGUgPT09IG1vZGVscy5wcm9qZWN0KSB7XG5cbiAgICAgICAgICAgIGlmIChqc29uLmRhdGEgJiYganNvbi5kYXRhLmxlbmd0aCkganNvbiA9IGpzb24uZGF0YS5tYXAocm93ID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBpZDogcm93WzFdLFxuICAgICAgICAgICAgICAgIHRleHQ6IHJvd1szXVswXSxcbiAgICAgICAgICAgICAgICByaWdodHM6IHJvd1swXVxuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodHlwZSA9PT0gbW9kZWxzLmluc3RyICYmIGpzb24ubGVuZ3RoKSBqc29uID0ganNvbi5yZWR1Y2UoKHJlc3VsdCwgYSwgdikgPT4ge1xuICAgICAgICAgICAgYSA9IERPTVB1cmlmeS5zYW5pdGl6ZShhKTtcbiAgICAgICAgICAgIGxldCBvYmogPSB7XG4gICAgICAgICAgICAgIGlkOiBhLFxuICAgICAgICAgICAgICB0ZXh0OiBhXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQucHVzaChvYmopO1xuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgIH0sIFtdKTtcblxuICAgICAgICAgIGlmIChqc29uLmxlbmd0aCAmJiB0eXBlb2YganNvbiA9PSAnb2JqZWN0JykganNvbiA9IE9iamVjdC5lbnRyaWVzKGpzb24pO1xuICAgICAgICAgIHJldHVybiBjYWxsYmFjayhqc29uKTtcblxuICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCd0b21zZWxlY3QtZXJyJywgZXJyKTtcbiAgICAgICAgfSk7XG4gICAgICB9LFxuXG4gICAgICByZW5kZXI6IHtcbiAgICAgICAgb3B0aW9uOiBmdW5jdGlvbihlbCwgZXNjYXBlKSB7XG4gICAgICAgICAgaWYgKGVsID09PSB1bmRlZmluZWQgfHwgZWwgPT09IG51bGwpIHJldHVybiBgYDtcbiAgICAgICAgICAvLyBhZGQgb3B0Z3JvdXBcbiAgICAgICAgICBjb25zdCBvcHRncm91cCA9IChlbC5oYXNPd25Qcm9wZXJ0eSgnb3B0Z3JvdXAnKSkgPyBgZGF0YS1vcHRncm91cD0ke2VsLm9wdGdyb3VwfWAgOiBgYDtcbiAgICAgICAgICBjb25zdCBsYWJlbCA9IF9nZXRfbGFiZWwoZWwsIG9wdGlvbi5zZXR0aW5ncy5sYWJlbEZpZWxkKTtcbiAgICAgICAgICByZXR1cm4gYDxkaXYgY2xhc3M9XCJweS0yIGZsZXggICR7ICgobXVsdGlwbGUpPydpbmxpbmUtZmxleCc6JycpIH0gXCIgJHtvcHRncm91cH0gZGF0YS12YWx1ZT1cIiR7ZWxbb3B0aW9uLnNldHRpbmdzLnZhbHVlRmllbGRdfVwiPiR7IGVzY2FwZShsYWJlbCkgfTwvZGl2PmA7XG4gICAgICAgIH0sXG4gICAgICAgIGl0ZW06IGZ1bmN0aW9uKGVsLCBlc2NhcGUpIHtcbiAgICAgICAgICBpZiAoZWwgPT09IHVuZGVmaW5lZCB8fCBlbCA9PT0gbnVsbCkgcmV0dXJuIGBgOyAvLyBhZGQgb3B0Z3JvdXBcbiAgICAgICAgICBjb25zdCBvcHRncm91cCA9IChlbC5vcHRncm91cCkgPyBgaXRlbS0ke2VsLm9wdGdyb3VwfWAgOiBgYDtcbiAgICAgICAgICBjb25zdCBpbmxpc3QgPSAodXNlcnNfbGlzdFtlbFt0aGlzLnNldHRpbmdzLnZhbHVlRmllbGRdXSkgPyBgZGF0YS1pbmxpc3RgIDogYGA7XG4gICAgICAgICAgLy8gYWRkIGNhbmNlbCBpY29uIGZvciBtdWx0aXBsZSBzZWxlY3Rpb25zXG4gICAgICAgICAgLy8gIGNvbnN0IGNhbmNlbCA9ICgobXVsdGlwbGUpID8gYDxpIGNsYXNzPVwiJHtkb21zZWxlY3RvcnMuY29tcG9uZW50LnRvbXNlbGVjdC50c2RlbGV0LnN1YnN0cigxKX1cIj48L2k+YCA6IGBgKTtcbiAgICAgICAgICAvLyB1c2UgdHMgcGx1Z2luIHJlbW92ZV9idXR0b25cbiAgICAgICAgICBjb25zdCBjYW5jZWwgPSBgYDtcbiAgICAgICAgICBjb25zdCBsYWJlbCA9IF9nZXRfbGFiZWwoZWwsIG9wdGlvbi5zZXR0aW5ncy5sYWJlbEZpZWxkLCB0cnVlKTtcbiAgICAgICAgICByZXR1cm4gRE9NUHVyaWZ5LnNhbml0aXplKGA8ZGl2IGNsYXNzPVwiJHsoKG11bHRpcGxlKSA/IGBmbGV4IGlubGluZS1mbGV4IGAgOiBgYCkgfSAke29wdGdyb3VwfVwiICBkYXRhLXZhbHVlPVwiJHtlbFt0aGlzLnNldHRpbmdzLnZhbHVlRmllbGRdfVwiICAke2lubGlzdH0+JHsgZXNjYXBlKGxhYmVsKSB9ICR7IGNhbmNlbCB9PC9kaXY+YCk7XG4gICAgICAgIH0sXG4gICAgICAgIG5vX3Jlc3VsdHM6IGZ1bmN0aW9uKGRhdGEsIGVzY2FwZSkge1xuICAgICAgICAgIHJldHVybiBET01QdXJpZnkuc2FuaXRpemUoJzxkaXYgY2xhc3M9XCJuby1yZXN1bHRzXCI+JyArICgoaXRlbS5kYXRhc2V0Lm5vcmVzdWx0cykgPyBpdGVtLmRhdGFzZXQubm9yZXN1bHRzIDogJ05vIHJlc3VsdCBmb3VuZCBmb3IgJykgKyBlc2NhcGUoZGF0YS5pbnB1dCkgKyAnPC9kaXY+Jyk7XG4gICAgICAgIH0sXG5cbiAgICAgIH1cbiAgICB9XG5cbiAgICBvcHRpb24uc2V0dGluZ3MucGx1Z2lucyA9IHtcbiAgICAgICdjbGVhcl9idXR0b24nOiB7XG4gICAgICAgIHRpdGxlOiAoaXRlbS5kYXRhc2V0LmNsZWFyKSA/IGl0ZW0uZGF0YXNldC5jbGVhciA6ICdDbGVhciBhbGwnLFxuICAgICAgICBodG1sOiAoZGF0YSkgPT4ge1xuICAgICAgICAgIHJldHVybiBgPGRpdiBjbGFzcz1cIiR7ZGF0YS5jbGFzc05hbWV9XCIgaWQ9XCJjbGVhci0ke2lkfVwiIHRpdGxlPVwiJHtkYXRhLnRpdGxlfVwiPjxpIGNsYXNzPVwiaWNvbiAkeyhtdWx0aXBsZSk/YGA6J3AtWzAuMTI1cmVtXSd9IGljb24teC1jaXJjbGUtc20gJHsobXVsdGlwbGUpP2BgOmAgb3BhY2l0eS01MGB9XCI+PC9pPjwvZGl2PmA7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgb3B0aW9uLnNldHRpbmdzLm9uQ2xlYXIgPSBmdW5jdGlvbigpIHtcbiAgICAgIGl0ZW0udG9tc2VsZWN0LmNsZWFyKCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKG11bHRpcGxlKSB7XG4gICAgICBvcHRpb24uc2V0dGluZ3MucGx1Z2lucyA9IHsgLi4ub3B0aW9uLnNldHRpbmdzLnBsdWdpbnMsXG4gICAgICAgIC4uLntcbiAgICAgICAgICAncmVtb3ZlX2J1dHRvbic6IHt9XG4gICAgICAgIH1cblxuICAgICAgfTtcbiAgICAgIG9wdGlvbi5zZXR0aW5ncy5wbHVnaW5zID0geyAuLi5vcHRpb24uc2V0dGluZ3MucGx1Z2lucyxcbiAgICAgICAgLi4ue1xuICAgICAgICAgICdjYXJldF9wb3NpdGlvbic6IHt9XG4gICAgICAgIH1cblxuICAgICAgfTtcbiAgICB9XG4gICAgb3B0aW9uLnNldHRpbmdzID0gT2JqZWN0LmFzc2lnbihkZWZhdWx0X3NldHRpbmdzLCBvcHRpb24uc2V0dGluZ3MpXG4gICAgaWYgKGlkICE9PSBudWxsKSB7XG4gICAgICBjb25zdCB0cyA9IG5ldyBUb21TZWxlY3QoJyMnICsgaWQsIG9wdGlvbi5zZXR0aW5ncyk7XG4gICAgICB0cy53cmFwcGVyLmNsYXNzTGlzdC5yZW1vdmUoZG9tc2VsZWN0b3JzLmNvbXBvbmVudC50b21zZWxlY3QuaWRlbnQpO1xuICAgICAgdHMud3JhcHBlci5jbGFzc0xpc3QucmVtb3ZlKCdqcycpO1xuICAgICAgLy8gYWRkXG4gICAgICB0cy53cmFwcGVyLnNldEF0dHJpYnV0ZSgnZGF0YS1jb21wb25lbnQnLCAndG9tLXNlbGVjdCcpO1xuICAgICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICAgIGNhc2UgbW9kZWxzLnRheG86XG4gICAgICAgICAgdHMub24oJ2l0ZW1fYWRkJywgKHYsIGVsKSA9PiB7XG4gICAgICAgICAgICBpZiAoZWwgIT09IG51bGwpIGVsLmNsYXNzTGlzdC5hZGQoJ25ldycpO1xuICAgICAgICAgICAgLy8gIGVsID0gZWwucXVlcnlTZWxlY3RvcignLnRzLWRlbGV0Jyk7XG4gICAgICAgICAgICAvLyAgaWYgKGVsICE9PSBudWxsKSBpbml0X2NhbmNlbHRhZyhlbCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgLy9cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBtb2RlbHMucHJvamVjdDpcbiAgICAgICAgICAvLyBhZGQgZGF0YS1ub2FjdGlvbiBqdXN0IHRvIHNlbGVjdCBhIHByb2plY3RcbiAgICAgICAgICBpZiAoaXRlbS5kYXRhc2V0LmRlc3QpIHtcblxuICAgICAgICAgICAgdHMub24oJ2l0ZW1fYWRkJywgKHYsIGVsKSA9PiB7XG4gICAgICAgICAgICAgIGlmICh2ICE9IGl0ZW0uZGF0YXNldC52YWx1ZSAmJiB0cy5vcHRpb25zW3ZdICYmICFlbC5xdWVyeVNlbGVjdG9yKCdhJykpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBsaW5rcyA9IHtcbiAgICAgICAgICAgICAgICAgIFwiQVwiOiBcIi9wcmovXCIsXG4gICAgICAgICAgICAgICAgICBcIlZcIjogXCIvcHJqL1wiLFxuICAgICAgICAgICAgICAgICAgXCJNXCI6IFwiL2d1aS9wcmovZWRpdC9cIlxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgY29uc3QgcmlnaHRzID0gdHMub3B0aW9uc1t2XS5yaWdodHM7XG4gICAgICAgICAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHJpZ2h0cyk7XG4gICAgICAgICAgICAgICAgaWYgKGtleXMpIHtcbiAgICAgICAgICAgICAgICAgIGlmIChrZXlzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMocmlnaHRzKS5mb3JFYWNoKChbaywgcl0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICBlbC5pbnNlcnRBZGphY2VudEhUTUwoJ2JlZm9yZWVuZCcsIGAgPGEgZGF0YS1rPVwiJHtrfVwiIGNsYXNzPVwic21hbGwtY2FwcyBmb250LW5vcm1hbCBtbC0yXCI+JHtyfTwvYT5gKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGVsLnF1ZXJ5U2VsZWN0b3JBbGwoJ2EnKS5mb3JFYWNoKGxrID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICBsay5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm9wZW4obGlua3NbZS50YXJnZXQuZGF0YXNldC5rXSArIHYsIGBfcHJvaiR7dn1gKS5mb2N1cygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdHMucmVtb3ZlSXRlbSh2KTtcbiAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5vcGVuKGxpbmtzW2tleXNbMF1dICsgdiwgYF9wcm9qJHt2fWApLmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgICAgIHRzLnJlbW92ZUl0ZW0odik7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgLyogIGNhc2UgJ3VzZXInOlxuICAgICAgICAgICAgICBpZiAoaXRlbS5kYXRhc2V0LnByaXYpIHRzLm9uKFwiaXRlbV9hZGRcIiwgZnVuY3Rpb24odiwgZWwpIHtcbiAgICAgICAgICAgICAgICBlbCA9IGVsLnF1ZXJ5U2VsZWN0b3IoZG9tc2VsZWN0b3JzLmNvbXBvbmVudC50b21zZWxlY3QudHNkZWxldCk7XG4gICAgICAgICAgICAgICAgaWYgKGVsICE9PSBudWxsKSBpbml0X2NhbmNlbHRhZyhlbCk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBicmVhazsqL1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRzO1xuICAgIH0gZWxzZSBjb25zb2xlLmxvZygnbm9pZCcpO1xuXG4gIH1cblxuICBmdW5jdGlvbiBnZXRVc2VyTGlzdCgpIHtcbiAgICByZXR1cm4gdXNlcnNfbGlzdDtcbiAgfVxuICByZXR1cm4ge1xuICAgIGFwcGx5VG9cbiAgfVxufSJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///./src/modules/module-tom-select.js\n")}}]);