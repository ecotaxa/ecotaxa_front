/*! For license information please see src_modules_data-import_js.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["src_modules_data-import_js"],{"./src/modules/data-import.js":(module,__webpack_exports__,__webpack_require__)=>{eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   DataImport: () => (/* binding */ DataImport)\n/* harmony export */ });\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! dompurify */ \"./node_modules/dompurify/dist/purify.es.mjs\");\n/* harmony import */ var _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../modules/js-tom-select.js */ \"./src/modules/js-tom-select.js\");\n/* harmony import */ var _modules_project_privileges_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../modules/project-privileges.js */ \"./src/modules/project-privileges.js\");\n/* harmony import */ var _modules_utils_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../modules/utils.js */ \"./src/modules/utils.js\");\n/* harmony import */ var _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../modules/modules-config.js */ \"./src/modules/modules-config.js\");\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([_modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__, _modules_project_privileges_js__WEBPACK_IMPORTED_MODULE_2__]);\n([_modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__, _modules_project_privileges_js__WEBPACK_IMPORTED_MODULE_2__] = __webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__);\n\n\n\n\n\n\nconst key_privileges = Object.keys(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.defined_privileges).reduce(function(result, key) {\n  result[key] = key;\n  return result;\n}, {});\nlet instance;\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported = 'imported';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.tomselected = 'tomselected';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hiddenaccessible = 'ts-hidden-accessible';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowout = 'icon-arrow-pointing-out';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowin = 'icon-arrow-pointing-in';\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton = '.import-list-reset';\nclass DataImport {\n  content_selector = '.modal-content';\n  imports = [];\n  taxos = [\"preset\", \"extra\"];\n  importcontainer;\n  importzoneid; // target element to add/replace datasto import\n  importid = 'importzone'; // importzone built to display data to import\n  importzone = null;\n  selectors;\n  button;\n  clearbutton;\n  replacebutton;\n  tabbutton;\n  dom;\n  tbl = null;\n  thcells = [];\n  trs = [];\n  datas;\n  constructor(tbl, what = null, selector = null) {\n    if (!tbl) return;\n    // tbl is a TableComponent  ?\n    this.tbl = (typeof(tbl) === 'object') ? tbl : null;\n    selector = (selector === null) ? ((this.tbl.cellidname) ? \"data-\" + this.tbl.cellidname : \"data-id\") : selector;\n    // get the table from table component or html table element id\n    this.dom = (this.tbl) ? this.tbl.dom : document.getElementById(tbl);\n    if (!this.dom) return;\n    this.thcells = Array.from(this.dom.querySelectorAll('thead th'));\n    this.trs = Array.from(this.dom.querySelectorAll('tbody tr'));\n    const grid = (this.tbl) ? this.tbl.grid : null;\n    this.datas = (grid) ? grid.data : this.trs.map(tr => {\n      return Array.from(tr.childNodes).forEach(cell => {\n        return cell.innerText;\n      });\n    });\n    what = (what) ? dompurify__WEBPACK_IMPORTED_MODULE_0__[\"default\"].sanitize(what) : (tbl && tbl.params && tbl.params.import) ? tbl.params.import : (this.dom.dataset.import) ? dompurify__WEBPACK_IMPORTED_MODULE_0__[\"default\"].sanitize(this.dom.dataset.import) : null;\n    if (!instance || instance.doc !== this.dom) {\n      // defaultoptions - keep like that\n\n      const options = {\n        importcontainer: '#data-import-' + what,\n        btns: '.btns-imports',\n        button: '#add-import-' + what,\n        replacebutton: '#replace-import-' + what,\n        tabbutton: '#tab-import-' + what,\n      };\n      this.selector = selector;\n\n      this.importcontainer = options.importcontainer instanceof HTMLElement ? options.importcontainer : document.querySelector(options.importcontainer);\n      this.form = (options.form) ? ((options.form) instanceof HTMLElement ? options.form : document.querySelector(options.form)) : this.dom.closest('form');\n      this.button = options.button instanceof HTMLElement ? options.button : document.querySelector(options.button);\n      this.replacebutton = options.replacebutton instanceof HTMLElement ? options.replacebutton : document.querySelector(options.replacebutton);\n      this.tabbutton = options.tabbutton instanceof HTMLElement ? options.tabbutton : document.querySelector(options.tabbutton);\n      this.importid = this.importid + '_' + what;\n      this.targetimport = (this.form.querySelector('[name=\"' + what + '\"]')) ? this.form.querySelector('[name=\"' + what + '\"]') : this.form.querySelector('[data-type=\"' + what + '\"]');\n      this.init(options);\n      instance = this;\n    }\n    return instance;\n  }\n\n  init(options) {\n    // hide importzone\n    this.showImport(false);\n    // remove line of target proj\n    let projid = this.form.querySelector('#' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.projid);\n    if (projid && projid.value) {\n      projid = this.dom.querySelector('[' + this.selector + '=\"' + projid.value + '\"]');\n      if (projid) projid.hidden = true;\n    }\n    const indextocheck = this.indexToCheck();\n    this.selectors = this.dom.querySelectorAll('[' + this.selector + '] button, [' + this.selector + '] input');\n    this.selectors.forEach(selector => {\n      // checkbox possible\n      const index = Array.from(selector.parentElement.children).indexOf((selector));\n      if (indextocheck && selector.closest('tr').children[indextocheck[index]].innerHTML === '') this.disableSelector(selector, false);\n      else {\n        const evt = (selector.tagName.toLowerCase() === 'input') ? 'change' : 'click';\n        const apply_selection = (e) => {\n          e.preventDefault();\n          e.stopImmediatePropagation();\n          const target = e.currentTarget;\n          const add = (evt === 'click' || target.checked === true);\n          this.disableSelector(target, add);\n          this.toImport(target.parentElement, index, add);\n        };\n        selector.removeEventListener(evt, apply_selection, false);\n        selector.addEventListener(evt, apply_selection, false);\n      };\n    });\n    if (this.tabbutton) {\n      this.tabbutton.addEventListener('click', (e) => {\n        e.stopImmediatePropagation();\n        e.preventDefault();\n        this.resizeZone(e);\n      });\n    }\n\n  }\n\n  columnProperty(name, index) {\n    const th = this.thcells[index];\n    if (this.tbl) return (this.tbl.grid.columns[index].hasOwnProperty(name)) ? this.tbl.grid.columns[index][name] : null;\n    else return (th.dataset[name]) ? th.dataset.name : null;\n  }\n  columnIndex(prop, value) {\n    return Array.from(this.dom.querySelectorAll('thead th')).findIndex(th => (th.dataset[prop] && th.dataset[prop] === value));\n  }\n  gridColumnIndex(prop, value) {\n    if (this.tbl) return this.tbl.grid.columns.findIndex(column => (column.hasOwnProperty(prop) && column[prop] === value));\n    else return this.columnIndex(prop, value);\n  }\n  rowIndex(td) {\n    const ref = (td.parentElement) ? td.parentElement : null;\n    if (!ref) return null;\n    return this.trs.findIndex(tr => (tr === ref));\n  }\n  disableSelector(selector, disable = true) {\n    const type = selector.tagName.toLowerCase();\n    if (type === \"input\") {\n      if (selector.checked !== disable) selector.checked = disable;\n    } // disable button but toggle checkbox\n    else selector.disabled = disable;\n  }\n\n  getDataToImport(cell, celldata) {\n    let toimport = celldata;\n    if (cell !== null) {\n      if (cell.dataset.autocomplete) {\n        // select elements where key / value in different columns\n        toimport = {\n          value: celldata,\n          key: null\n        };\n        let el = null;\n        this.thcells.every((t, idx) => {\n          if (t.dataset.name == thcell.dataset.autocomplete) {\n            el = idx;\n            return false;\n          }\n          return true;\n        });\n        if (el !== null) {\n          el = this.datas[rowindex][el];\n\n          toimport.key = el;\n        }\n      } else if (cell.dataset.value) toimport = cell.dataset.value;\n\n    }\n    return toimport;\n  }\n  getSelectCells(cellindex, whatpart) {\n    const parts = this.columnProperty('parts', cellindex);\n    let selectcells = this.columnProperty('selectcells', cellindex);\n    selectcells = (selectcells) ? ((parts) ? [parts[whatpart]] : selectcells) : null;\n    return selectcells;\n  }\n\n  populateImportZone(add, items) {\n    if (!this.importzone) return;\n    const ts = this.importzone.tomselect;\n    if (ts) {\n      Object.values(ts.options).forEach((opt) => {\n        let obj = {};\n        obj[opt[ts.settings.valueField]] = opt[ts.settings.labelField];\n        if (!items[opt[ts.settings.valueField]]) items = Object.assign(items, obj);\n      });\n      items = Object.entries(items);\n      // sort items\n      items.sort((a, b) => {\n        let x = a[1];\n        let y = b[1];\n        return +(x > y) || -(y > x);\n      });\n      //  ts.clear();\n      //ts.clearOptions();\n      // add ts items\n      if (add) items.forEach(([key, text]) => {\n        if (ts.getItem(key) === null) {\n          if (ts.getOption(key) === null) {\n            let obj = {};\n            obj[ts.settings.valueField] = key;\n            obj[ts.settings.labelField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(text.trim());\n            ts.addOption(obj);\n          }\n          ts.addItem(key);\n        }\n      });\n      else items.forEach(([key, text]) => {\n        ts.removeItem(key);\n      });\n    } else {\n      Object.values(this.importzone.options).forEach(opt => {\n        let obj = {};\n        obj[opt.value] = opt.text;\n        if (!items[opt.value]) items = Object.assign(items, obj);\n      });\n      items = Object.entries(items);\n      items.sort((a, b) => {\n        let x = a[1];\n        let y = b[1];\n        return +(x > y) || -(y > x);\n      });\n      this.importzone.innerHTML = ``;\n      if (add) items.forEach(([key, text]) => {\n        const opt = this.importzone.querySelector('option[value=\"' + key + '\"]');\n        if (!opt) {\n          const o = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', {\n            value: key,\n            selected: 'selected',\n            text: text\n          }, this.importzone);\n        } else opt.selected = true;\n      });\n      else items.forEach(([key, text]) => {\n        const opt = this.importzone.querySelector('option[value=\"' + key + '\"]');\n        if (opt) opt.remove(); // or opt.selected=false;\n      });\n    }\n  }\n\n  toImport(td, whatpart = 0, add = true) {\n    // cell values in json  - no parse\n    if (td.tagName.toLowerCase() !== 'td') td = td.closest('td');\n    const rowindex = this.rowIndex(td);\n    if (rowindex === null) return;\n    let showbtns = true;\n    let contact = null;\n    const cellindex = td.cellIndex;\n    const what = this.columnProperty('what', cellindex);\n    if (!what) return;\n    const parts = this.columnProperty('parts', cellindex);\n    const selectcells = this.getSelectCells(cellindex, whatpart);\n    if (!selectcells) return;\n    if ([_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.settings, _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges].indexOf(what) >= 0) this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact] = this.findContact(this.datas[rowindex]);\n    if ([_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.project, _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo, _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges].indexOf(what) >= 0) this.createImportzone(what);\n    this.addResetButton();\n    let ts = null;\n    selectcells.forEach((name, index) => {\n      index = this.gridColumnIndex('name', name);\n      if (index >= 0) {\n        const tdindex = this.columnIndex('name', name);\n        // show import buttons if importzone\n        const cell = (tdindex >= 0) ? this.trs[rowindex].cells[tdindex] : null;\n        if (cell) cell.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n        const rowdata = this.datas[rowindex];\n        const celldata = rowdata[index];\n        const thcell = (tdindex >= 0) ? this.thcells[tdindex] : null;\n        switch (what) {\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo:\n            if (!this.importzone) return;\n            // accumulate and show in import win - move the form field in modal win to view the changes and benefit of tom-select component functs...\n            ts = this.importzone.tomselect;\n            let taxons = celldata;\n            if (taxons) {\n              this.populateImportZone(add, taxons);\n              showbtns = (Object.keys(taxons).length > 0);\n              taxons = null;\n            }\n            break;\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges:\n            const privs = celldata;\n            // set everybody to 'view' if more than one project imported\n            const resetpriv = ((ts && ts.items.length > 0) || (this.importzone.selectedIndex > 0));\n            if (!this.importzone.tomselect) {\n              this.importzone.currentlist = {};\n              _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__.JsTomSelect.applyTo(this.importzone);\n            }\n            ts = this.importzone.tomselect;\n            Object.entries(privs).forEach(([priv, members]) => {\n              members.sort((a, b) => {\n                return (b.name > a.name);\n              });\n              members.forEach(member => {\n                const newpriv = (resetpriv) ? key_privileges.viewers : priv; // viewer if more than one project imported\n                let opt;\n                if (!this.importzone.currentlist || !this.importzone.currentlist[member.id]) {\n                  if (ts) {\n                    opt = ts.items.indexOf(member.id);\n                    //TODO - test - opt should always be 0\n                    if (opt >= 0) {\n                      ts.removeItem(member.id);\n                      ts.removeOption(member.id);\n                    }\n                    // addoption && addItem\n                    opt = {\n                      optgroup: newpriv\n                    }\n                    opt[ts.settings.valueField] = member.id;\n                    opt[ts.settings.searchField] = member.name;\n                    opt[ts.settings.labelField] = member.name;\n                    ts.addOption(opt);\n                    ts.addItem(member.id);\n                  } else {\n                    opt = this.importzone.querySelector('option[value=\"' + member.id + '\"]');\n                    if (opt === null) {\n                      opt = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', {\n                        value: member.id,\n                        dataset: {\n                          optgroup: newpriv\n                        },\n                        selected: true,\n                        defaultSelected: true,\n                        text: member.name\n                      })\n                      this.importzone.add(opt);\n                    } else opt.dataset.optgroup = newpriv;\n                  }\n                }\n              });\n              if (ts) ts.refreshOptions(true);\n            });\n            showbtns = (((ts) ? ts.items.length : this.importzone.selectedIndex + 1) > 0);\n            break;\n          case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.project:\n            const ln = Object.keys(this.imports).length;\n\n            if (!this.imports[name]) this.imports[name] = [];\n            const data = this.getDataToImport(cell, celldata);\n            if (add) this.imports[name].push(data);\n            else {\n              const idx = this.imports[name].indexOf(data);\n              if (idx > -1) this.imports[name].splice(idx, 1);\n            }\n            if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.projid) {\n              const idx = this.columnIndex('name', 'title');\n              // show import buttons if importzone\n              const celllabel = (idx >= 0) ? this.trs[rowindex].cells[idx] : null;\n              const datalabel = rowdata[idx];\n              const label = (celllabel) ? this.getDataToImport(celllabel, datalabel) : data;\n              const items = {};\n              items[rowdata[this.tbl.getCellId(this.tbl.cellidname)]] = label;\n              this.populateImportZone(add, items);\n            }\n            if (ln === 0) {\n              if (add) this.filterByRecord(rowdata, rowindex);\n              else this.resetFilter();\n            }\n            break;\n          default:\n            if (add) this.imports[name] = this.getDataToImport(cell, celldata);\n            else {\n              const idx = this.imports.indexOf(name);\n              if (idx > -1) this.imports.splice(idx, 1);\n            }\n            break;\n        }\n      };\n    });\n    if (this.thcells.length) {\n      if (this.button) {\n        const activate = (!this.button.dataset.activated && ([_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo, _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges, _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.project].indexOf(what) >= 0));\n        this.showImport(showbtns);\n        if (activate) this.activateButtons(what, selectcells);\n      } else this.makeImport(null, selectcells, what, true);\n    }\n  }\n  messageZone(item) {\n    console.log('itemmessage', item);\n  }\n  activateButtons(what, selectcells) {\n    this.button.addEventListener('click', async (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      await this.makeImport(e.currentTarget, selectcells, what, true);\n    });\n    this.replacebutton.addEventListener('click', async (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      await this.makeImport(e.currentTarget, selectcells, what, true);\n    });\n    this.button.dataset.activated = true;\n    this.replacebutton.dataset.activated = true;\n  }\n\n  findContact(tds, name = 'contact') {\n    const index = this.gridColumnIndex('name', name);\n    if (index >= 0) return tds[index] ? tds[index] : null;\n\n    return null;\n  }\n\n  renderPrivileges(replace = false) {\n    let privileges = {};\n    const tzone = this.importzone.tomselect;\n    const pushpriv = (member, priv) => {\n      const obj = {\n        id: member.id,\n        name: member.name,\n        priv: priv\n      }\n      if (privileges[priv]) privileges[priv].push(obj);\n      else privileges[priv] = [obj];\n    }\n\n    if (tzone) {\n      const members = [...tzone.items];\n      const options = Object.assign({}, tzone.options);\n      members.forEach(member => {\n        member = options[member];\n        if (member) pushpriv(member, member.optgroup);\n\n      })\n    } else {\n      this.importzone.options.forEach(member => {\n        if (member.selected) pushpriv(member, member.dataset.optgroup);\n      })\n    }\n\n    if (this.importPrivileges(privileges, replace)) {\n      if (tzone) {\n        tzone.clear();\n        tzone.clearOptions();\n      } else this.importzone.innerHTML = ``;\n\n    }\n\n  }\n\n  importPrivileges(privileges, clear = false) {\n    const projectPrivileges = this.form.querySelector('.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.privileges.ident);\n    if (projectPrivileges === null || !projectPrivileges.jsprivileges) return;\n    const importedtag = (input) => {\n      this.setImportedTag(input, null);\n    }\n    const dismiss = () => {\n      this.dismiss();\n    }\n    const contact = (clear === true && this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact]) ? this.imports[_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.contact] : null;\n    return (projectPrivileges.jsprivileges.importPrivileges(privileges, clear, contact, importedtag, dismiss));\n  }\n\n  resetSelector(tr) {\n    const resets = {};\n    const append_resets = (name, td, i) => {\n      const rowindex = this.rowIndex(td);\n      const celldata = this.datas[rowindex][i];\n      const cell = this.trs[rowindex].cells[i];\n      const data = this.getDataToImport(cell, celldata);\n      if (!resets[name]) resets[name] = [data];\n      else if (resets[name].indexOf(data) < 0) resets[name].push(data);\n    }\n    const selectors = tr.querySelectorAll('[' + this.selector + '] button, [' + this.selector + '] input');\n    selectors.forEach((selector, i) => {\n      if (selector.disabled) this.disableSelector(selector, false);\n      const name = (selector.parentElement.dataset.name) ? selector.parentElement.dataset.name : null;\n      append_resets(name, selector.parentElement, i);\n    });\n    tr.querySelectorAll('td.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected).forEach((td, i) => {\n      td.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n      append_resets(name, td, i);\n    });\n    return resets;\n  }\n\n  resetSelectors() {\n    this.selectors.forEach((selector, i) => {\n      if (selector.disabled) this.disableSelector(selector, false);\n    });\n    this.dom.querySelectorAll('td.' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected).forEach(td => {\n      td.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.selected);\n    });\n  }\n  resetImports() {\n    this.imports = [];\n    if (this.importzone) {\n      if (this.importzone.currentlist) this.importzone.currentlist = {};\n      if (this.importzone.tomselect) this.importzone.tomselect.clear();\n      else switch (this.importzone.tagName.toLowerCase()) {\n        case 'input':\n          this.importzone.value = '';\n          break;\n        case 'select':\n          this.importzone.selectedIndex = -1;\n          break;\n      }\n    }\n  }\n\n  activateClear() {\n    const clearbutton = document.getElementById('clear-' + this.importid);\n    if (!clearbutton) return;\n    clearbutton.addEventListener('click', (e) => {\n      e.stopImmediatePropagation();\n      e.preventDefault();\n      if (!this.importcontainer) return;\n      this.resetSelectors();\n      this.resetImports();\n      this.button.disabled = false;\n      this.replacebutton.disabled = false;\n      this.showImport(false);\n    });\n  }\n\n  createImportzone(name) {\n    this.showImport(true);\n    let ts = false;\n    if (!this.importzone) {\n      if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) {\n        this.importzone = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('select', {\n          id: this.importid,\n          dataset: {\n            type: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.user,\n            priv: true,\n          },\n          multiple: true\n        }, this.importcontainer);\n        ts = true;\n      } else {\n\n        if (!this.targetimport) return;\n        this.importzoneid = this.targetimport.id;\n        ts = this.targetimport.tomselect;\n        // tomselect ?\n        const importzone = this.targetimport.cloneNode();\n        importzone.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.tomselected);\n        importzone.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hiddenaccessible);\n        // keep original id to replace data on apply import\n        importzone.dataset.origin = importzone.id;\n        importzone.id = this.importid;\n        importzone.name = this.importid + '_' + importzone.name;\n        this.importcontainer.prepend(importzone);\n        this.importzone = importzone;\n        if (ts) {\n          _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_1__.JsTomSelect.applyTo(this.importzone);\n          ts = this.importzone.tomselect;\n        }\n        if (ts) {\n          ts.on(\"item_remove\", (value, item) => {\n            this.itemRemove(value, item);\n          });\n        }\n        this.activateClear();\n      }\n\n    }\n\n  }\n  cloneImport(btn) {\n    const import_target = this.form.querySelector('#' + this.importzone.dataset.origin);\n    if (!import_target) return false;\n    const ts = import_target.tomselect;\n    if (ts) {\n\n      // only if replace specified\n      if (btn.dataset.replace && btn.dataset.replace === 'replace') {\n        ts.clear();\n        ts.clearOptions();\n      }\n      const tzone = this.importzone.tomselect;\n      const items = [...tzone.items];\n      const options = Object.assign({}, tzone.options);\n      items.forEach((e) => {\n        let el = {};\n        el[ts.settings.valueField] = e;\n        el[ts.settings.labelField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(options[e][ts.settings.labelField]);\n        el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(options[e][ts.settings.labelField]);\n        if (ts.getOption(el[ts.settings.valueField]) === null) ts.addOption(el);\n        if (ts.getItem(el[ts.settings.valueField]) === null) ts.addItem(el[ts.settings.valueField]);\n      });\n      //  tzone.clearOptions();\n    } else {\n      if (btn.dataset.replace && btn.dataset.replace === 'replace') import_target.innerHTML = ``;\n      import_target.innerHTML = dompurify__WEBPACK_IMPORTED_MODULE_0__[\"default\"].sanitize(this.importzone.innerHTML);\n      this.importzone.innerHTML = ``;\n    }\n    return true;\n  }\n\n  async makeImport(btn, selectcells, what, close = false) {\n    let done = true,\n      ts = null;\n\n    switch (what) {\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo:\n        if (!this.importzone) return false;\n        done = this.cloneImport(btn);\n        break;\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges:\n        if (!this.importzone) return false;\n        done = this.renderPrivileges((btn.dataset.replace && btn.dataset.replace === 'replace'));\n        if (this.importzone.currentlist) this.importzone.currentlist = {};\n        break;\n      case _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.project:\n        if (!this.importzone) return false;\n        const newone = (this.form.dataset.id) ? parseInt(this.form.dataset.id) : 0;\n        const results = await this.compileProjectRecords(newone);\n        done = this.cloneImport(btn);\n        const idx = selectcells.indexOf(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.models.projid);\n        if (idx >= 0) selectcells.splice(idx, 1);\n        [\"creator_users\", \"creator_organisations\", \"classiffieldlist\", \"privileges\", \"access\", \"status\", \"cnn_network_id\"].forEach(result => {\n          this.imports[result] = results[result];\n        });\n        this.imports[\"init_classif_list\"] = results.initclassiflist;\n      default:\n        const ts_add_select_item = function(ts, data) {\n          const el = {};\n          if (typeof(data) == 'string') {\n            el[ts.settings.labelField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data);\n            el[ts.settings.valueField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data);\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data);\n          } else {\n            el[ts.settings.labelField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data.value);\n            el[ts.settings.valueField] = data.key;\n            el[ts.settings.searchField] = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.unescape_html)(data.value);\n          }\n          if (ts.getOption(el[ts.settings.valueField]) === null) ts.addOption(el);\n          if (ts.getItem(el[ts.settings.valueField]) === null) ts.addItem(el[ts.settings.valueField]);\n        }\n        const add_select_option = function(input, data) {\n          let attr = {\n            selected: true\n          };\n          if (typeof(data) === 'string') attr.value = attr.text = data;\n          else {\n            attr.value = data.key;\n            attr.text = data.value;\n          }\n          const option = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('option', attr, input);\n        }\n        const add_input_option = function(input, data) {\n          if (input.multiple) {\n            let values = input.value.split(',');\n            values.push(data.key);\n            input.value = values.join(',');\n          } else input.value = data;\n\n        }\n        selectcells.forEach((name, index) => {\n          let input = ((this.form.querySelector('[data-importfield=\"' + name + '\"]')) ? this.form.querySelector('[data-importfield=\"' + name + '\"]') : this.form.querySelector('[name=\"' + name + '\"]'));\n          if (input && input.dataset.noimport) return;\n          if (input && this.imports[name] !== undefined) {\n            const type = (input.type) ? input.type : input.tagName.toLowerCase();\n            ts = input.tomselect;\n            if (['init_classif_list'].indexOf(name) >= 0) {\n              let ids = this.imports[name];\n              if (Array.isArray(ids)) ids = ids.join(',');\n              else ids = ids.replace('[', '').replace(']', '').replaceAll(' ', '');\n              if (ids !== '') {\n                if (ts) ts.wrapper.classList.add('wait-for-results');\n                let opts = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.fetchSettings)(),\n                  url = '';\n                const formData = new FormData();\n                formData.append('idlist', ids);\n                url = '/search/taxoresolve' //+ new URLSearchParams({'idlist': ids});\n                opts = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.fetchSettings)({\n                  'method': 'POST',\n                  'body': formData\n                });\n                fetch(url, opts).then(response =>\n                  response.json()\n                ).then(results => {\n                  const ts = input.tomselect;\n                  if (ts) {\n                    results = Object.entries(results);\n                    results.forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0__[\"default\"].sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0__[\"default\"].sanitize(text)\n                      }\n                      ts_add_select_item(ts, el);\n                    });\n                    ts.wrapper.classList.remove('wait-for-results');\n                  } else if (type.indexOf('select') === 0) {\n                    input.querySelectorAll('option').forEach(option => {\n                      option.remove();\n                    });\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0__[\"default\"].sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0__[\"default\"].sanitize(text)\n                      }\n                      add_input_option(input, el);\n                    });\n\n                  } else {\n                    Object.entries(results).forEach(([key, text]) => {\n                      const el = {\n                        key: dompurify__WEBPACK_IMPORTED_MODULE_0__[\"default\"].sanitize(key),\n                        value: dompurify__WEBPACK_IMPORTED_MODULE_0__[\"default\"].sanitize(text)\n                      }\n                      add_select_option(input, el);\n                    });\n                  }\n                  results = null;\n                  this.setImportedTag(input);\n                });\n              }\n            } else if (ts) {\n              if (input.multiple) this.imports[name].forEach(data => {\n                ts_add_select_item(ts, data)\n              });\n              else ts_add_select_item(ts, this.imports[name]);\n              this.setImportedTag(input);\n            } else {\n              switch (type) {\n                case 'radio':\n                case 'checkbox':\n                  const tocheck = this.form.querySelector('[name=\"' + name + '\"][value=\"' + this.imports[name] + '\"]');\n                  if (tocheck) tocheck.checked = true;\n                  break;\n                case 'select-multiple':\n                case 'select':\n                  if (input.multiple) this.imports[name].forEach(data => {\n                    add_select_option(input, data);\n                  });\n                  else add_select_option(input, this.imports[name]);\n                  break;\n                default:\n                  input.value = this.imports[name];\n                  break;\n              }\n              this.setImportedTag(input);\n            }\n            if (what !== _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.settings) input.focus();\n            done = done && true;\n\n\n          } else if (name === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.privileges) {\n            //const clearprivileges = (what === typeimport.settings);\n            const clearprivileges = false;\n            done = done && this.importPrivileges(this.imports[name], clearprivileges);\n          }\n        });\n        break;\n    }\n    if (done === true && close == true) {\n      this.dismiss();\n      if (this.form) this.form.dispatchEvent(new CustomEvent('validate'));\n    }\n  }\n\n  setImportedTag(input, selector = _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.form.formbox) {\n    if (input === null) return;\n    let el = (selector === null) ? input : ((input.closest(selector)) ? input.closest(selector) : input.closest('fieldset'));\n    if (!el) return;\n    const removetag = (e) => {\n      delete el.dataset.isimported;\n      el.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported);\n      input.removeEventListener('change', removetag);\n    }\n    el.dataset.isimported = this.form.dataset.isimported;\n    el.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.imported);\n    if (input.dataset.unique !== undefined) {\n      input.dataset.unique = input.value;\n    }\n    setTimeout(function() {\n      input.addEventListener('change', removetag);\n    }, 500);\n  }\n\n  dismiss(clear = false) {\n    if (this.button) this.showImport(false);\n    const container = this.dom.closest('details');\n    if (container) {\n      container.open = false;\n      if (clear === true) container.querySelector(this.content_selector).innerHTML = ``;\n    }\n\n  }\n  indexToCheck() {\n    // index of cells to check if empty and disable row  import btn\n    const grid = (this.tbl) ? this.tbl.grid : null;\n    if (!grid) return [0];\n    let index = grid.columns.findIndex(column => (column.what && column.what === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.typeimport.taxo));\n    if (index === -1) return [0];\n    const parts = (grid.columns[index].parts) ? grid.columns[index].parts : null;\n    if (parts) {\n      const indextocheck = grid.columns.filter((column, i) => {\n        if (parts.indexOf(column.name) >= 0) return i;\n      }).map(v => {\n        return v.index;\n      });\n      return indextocheck;\n    }\n\n  }\n  addResetButton() {\n    if (!this.tbl || !this.tbl.params.hasOwnProperty(\"reset\")) return;\n    let resetbtn = this.dom.parentElement.querySelector(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton);\n    if (resetbtn === null) {\n      resetbtn = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_3__.create_box)('a', {\n        class: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.resetbutton.substr(1),\n        text: this.tbl.params.reset\n      }, this.dom.parentElement.firstChild);\n    }\n    resetbtn.addEventListener('click', (e) => {\n      e.preventDefault();\n      e.stopImmediatePropagation();\n      this.resetSelectors();\n      this.resetImports();\n    });\n\n  }\n  // show / hide importzone and buttons\n  showImport(show) {\n    if (!this.button) return;\n    if (show === false) {\n      this.button.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.replacebutton.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      this.importcontainer.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n      if (this.tabbutton) this.tabbutton.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n    } else {\n      if (this.importzone) {\n        this.button.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.replacebutton.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.importcontainer.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n        this.button.disabled = false;\n        if (this.tabbutton) {\n          this.tabbutton.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.hide);\n          if (this.importzone.tomselect) {\n            this.tabbutton.disabled = false;\n          } else this.tabbutton.disabled = true;\n        }\n      }\n    }\n\n  }\n  // resize importzone\n  resizeZone(e) {\n    const div = this.importcontainer.closest(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.domselectors.component.import.zoneimport);\n    if (!div) return;\n    div.parentElement.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.showfull);\n    const icon = e.currentTarget.querySelector('i');\n    if (icon) {\n      icon.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowout);\n      icon.classList.toggle(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.arrowin);\n    }\n  }\n}\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LHVEQUF1RCwyREFBRztBQUMxRCxNQUFNO0FBQ047QUFDQSxxQ0FBcUMsMkRBQUc7QUFDeEMsNENBQTRDLDJEQUFHO0FBQy9DLDhDQUE4QywyREFBRztBQUNqRDtBQUNBO0FBQ0EsMENBQTBDLDJEQUFHO0FBQzdDO0FBQ0E7QUFDQSxZQUFZO0FBQ1o7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QyxvRUFBWTtBQUN6RDtBQUNBLHVDQUF1QywyREFBRztBQUMxQztBQUNBO0FBQ0EsNEJBQTRCLDJEQUFHO0FBQy9CLDRCQUE0QiwyREFBRztBQUMvQjtBQUNBO0FBQ0EsQyIsInNvdXJjZXMiOlsid2VicGFjazovLy8uL3NyYy9tb2R1bGVzL2RhdGEtaW1wb3J0LmpzPzgwYTIiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IERPTVB1cmlmeSBmcm9tICdkb21wdXJpZnknO1xuaW1wb3J0IHtcbiAgSnNUb21TZWxlY3Rcbn0gZnJvbSBcIi4uL21vZHVsZXMvanMtdG9tLXNlbGVjdC5qc1wiO1xuaW1wb3J0IHtcbiAgUHJvamVjdFByaXZpbGVnZXNcbn0gZnJvbSAnLi4vbW9kdWxlcy9wcm9qZWN0LXByaXZpbGVnZXMuanMnO1xuaW1wb3J0IHtcbiAgZmV0Y2hTZXR0aW5ncyxcbiAgdW5lc2NhcGVfaHRtbCxcbiAgY3JlYXRlX2JveFxufSBmcm9tICcuLi9tb2R1bGVzL3V0aWxzLmpzJztcblxuaW1wb3J0IHtcbiAgbW9kZWxzLFxuICB0eXBlaW1wb3J0LFxuICBjc3MsXG4gIGRlZmluZWRfcHJpdmlsZWdlcyxcbiAgZG9tc2VsZWN0b3JzXG59IGZyb20gJy4uL21vZHVsZXMvbW9kdWxlcy1jb25maWcuanMnO1xuY29uc3Qga2V5X3ByaXZpbGVnZXMgPSBPYmplY3Qua2V5cyhkZWZpbmVkX3ByaXZpbGVnZXMpLnJlZHVjZShmdW5jdGlvbihyZXN1bHQsIGtleSkge1xuICByZXN1bHRba2V5XSA9IGtleTtcbiAgcmV0dXJuIHJlc3VsdDtcbn0sIHt9KTtcbmxldCBpbnN0YW5jZTtcbmNzcy5pbXBvcnRlZCA9ICdpbXBvcnRlZCc7XG5jc3MudG9tc2VsZWN0ZWQgPSAndG9tc2VsZWN0ZWQnO1xuY3NzLmhpZGRlbmFjY2Vzc2libGUgPSAndHMtaGlkZGVuLWFjY2Vzc2libGUnO1xuY3NzLmFycm93b3V0ID0gJ2ljb24tYXJyb3ctcG9pbnRpbmctb3V0JztcbmNzcy5hcnJvd2luID0gJ2ljb24tYXJyb3ctcG9pbnRpbmctaW4nO1xuZG9tc2VsZWN0b3JzLnJlc2V0YnV0dG9uID0gJy5pbXBvcnQtbGlzdC1yZXNldCc7XG5leHBvcnQgY2xhc3MgRGF0YUltcG9ydCB7XG4gIGNvbnRlbnRfc2VsZWN0b3IgPSAnLm1vZGFsLWNvbnRlbnQnO1xuICBpbXBvcnRzID0gW107XG4gIHRheG9zID0gW1wicHJlc2V0XCIsIFwiZXh0cmFcIl07XG4gIGltcG9ydGNvbnRhaW5lcjtcbiAgaW1wb3J0em9uZWlkOyAvLyB0YXJnZXQgZWxlbWVudCB0byBhZGQvcmVwbGFjZSBkYXRhc3RvIGltcG9ydFxuICBpbXBvcnRpZCA9ICdpbXBvcnR6b25lJzsgLy8gaW1wb3J0em9uZSBidWlsdCB0byBkaXNwbGF5IGRhdGEgdG8gaW1wb3J0XG4gIGltcG9ydHpvbmUgPSBudWxsO1xuICBzZWxlY3RvcnM7XG4gIGJ1dHRvbjtcbiAgY2xlYXJidXR0b247XG4gIHJlcGxhY2VidXR0b247XG4gIHRhYmJ1dHRvbjtcbiAgZG9tO1xuICB0YmwgPSBudWxsO1xuICB0aGNlbGxzID0gW107XG4gIHRycyA9IFtdO1xuICBkYXRhcztcbiAgY29uc3RydWN0b3IodGJsLCB3aGF0ID0gbnVsbCwgc2VsZWN0b3IgPSBudWxsKSB7XG4gICAgaWYgKCF0YmwpIHJldHVybjtcbiAgICAvLyB0YmwgaXMgYSBUYWJsZUNvbXBvbmVudCAgP1xuICAgIHRoaXMudGJsID0gKHR5cGVvZih0YmwpID09PSAnb2JqZWN0JykgPyB0YmwgOiBudWxsO1xuICAgIHNlbGVjdG9yID0gKHNlbGVjdG9yID09PSBudWxsKSA/ICgodGhpcy50YmwuY2VsbGlkbmFtZSkgPyBcImRhdGEtXCIgKyB0aGlzLnRibC5jZWxsaWRuYW1lIDogXCJkYXRhLWlkXCIpIDogc2VsZWN0b3I7XG4gICAgLy8gZ2V0IHRoZSB0YWJsZSBmcm9tIHRhYmxlIGNvbXBvbmVudCBvciBodG1sIHRhYmxlIGVsZW1lbnQgaWRcbiAgICB0aGlzLmRvbSA9ICh0aGlzLnRibCkgPyB0aGlzLnRibC5kb20gOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0YmwpO1xuICAgIGlmICghdGhpcy5kb20pIHJldHVybjtcbiAgICB0aGlzLnRoY2VsbHMgPSBBcnJheS5mcm9tKHRoaXMuZG9tLnF1ZXJ5U2VsZWN0b3JBbGwoJ3RoZWFkIHRoJykpO1xuICAgIHRoaXMudHJzID0gQXJyYXkuZnJvbSh0aGlzLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCd0Ym9keSB0cicpKTtcbiAgICBjb25zdCBncmlkID0gKHRoaXMudGJsKSA/IHRoaXMudGJsLmdyaWQgOiBudWxsO1xuICAgIHRoaXMuZGF0YXMgPSAoZ3JpZCkgPyBncmlkLmRhdGEgOiB0aGlzLnRycy5tYXAodHIgPT4ge1xuICAgICAgcmV0dXJuIEFycmF5LmZyb20odHIuY2hpbGROb2RlcykuZm9yRWFjaChjZWxsID0+IHtcbiAgICAgICAgcmV0dXJuIGNlbGwuaW5uZXJUZXh0O1xuICAgICAgfSk7XG4gICAgfSk7XG4gICAgd2hhdCA9ICh3aGF0KSA/IERPTVB1cmlmeS5zYW5pdGl6ZSh3aGF0KSA6ICh0YmwgJiYgdGJsLnBhcmFtcyAmJiB0YmwucGFyYW1zLmltcG9ydCkgPyB0YmwucGFyYW1zLmltcG9ydCA6ICh0aGlzLmRvbS5kYXRhc2V0LmltcG9ydCkgPyBET01QdXJpZnkuc2FuaXRpemUodGhpcy5kb20uZGF0YXNldC5pbXBvcnQpIDogbnVsbDtcbiAgICBpZiAoIWluc3RhbmNlIHx8IGluc3RhbmNlLmRvYyAhPT0gdGhpcy5kb20pIHtcbiAgICAgIC8vIGRlZmF1bHRvcHRpb25zIC0ga2VlcCBsaWtlIHRoYXRcblxuICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgaW1wb3J0Y29udGFpbmVyOiAnI2RhdGEtaW1wb3J0LScgKyB3aGF0LFxuICAgICAgICBidG5zOiAnLmJ0bnMtaW1wb3J0cycsXG4gICAgICAgIGJ1dHRvbjogJyNhZGQtaW1wb3J0LScgKyB3aGF0LFxuICAgICAgICByZXBsYWNlYnV0dG9uOiAnI3JlcGxhY2UtaW1wb3J0LScgKyB3aGF0LFxuICAgICAgICB0YWJidXR0b246ICcjdGFiLWltcG9ydC0nICsgd2hhdCxcbiAgICAgIH07XG4gICAgICB0aGlzLnNlbGVjdG9yID0gc2VsZWN0b3I7XG5cbiAgICAgIHRoaXMuaW1wb3J0Y29udGFpbmVyID0gb3B0aW9ucy5pbXBvcnRjb250YWluZXIgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMuaW1wb3J0Y29udGFpbmVyIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLmltcG9ydGNvbnRhaW5lcik7XG4gICAgICB0aGlzLmZvcm0gPSAob3B0aW9ucy5mb3JtKSA/ICgob3B0aW9ucy5mb3JtKSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ID8gb3B0aW9ucy5mb3JtIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLmZvcm0pKSA6IHRoaXMuZG9tLmNsb3Nlc3QoJ2Zvcm0nKTtcbiAgICAgIHRoaXMuYnV0dG9uID0gb3B0aW9ucy5idXR0b24gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMuYnV0dG9uIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLmJ1dHRvbik7XG4gICAgICB0aGlzLnJlcGxhY2VidXR0b24gPSBvcHRpb25zLnJlcGxhY2VidXR0b24gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMucmVwbGFjZWJ1dHRvbiA6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iob3B0aW9ucy5yZXBsYWNlYnV0dG9uKTtcbiAgICAgIHRoaXMudGFiYnV0dG9uID0gb3B0aW9ucy50YWJidXR0b24gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IG9wdGlvbnMudGFiYnV0dG9uIDogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihvcHRpb25zLnRhYmJ1dHRvbik7XG4gICAgICB0aGlzLmltcG9ydGlkID0gdGhpcy5pbXBvcnRpZCArICdfJyArIHdoYXQ7XG4gICAgICB0aGlzLnRhcmdldGltcG9ydCA9ICh0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9XCInICsgd2hhdCArICdcIl0nKSkgPyB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9XCInICsgd2hhdCArICdcIl0nKSA6IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbZGF0YS10eXBlPVwiJyArIHdoYXQgKyAnXCJdJyk7XG4gICAgICB0aGlzLmluaXQob3B0aW9ucyk7XG4gICAgICBpbnN0YW5jZSA9IHRoaXM7XG4gICAgfVxuICAgIHJldHVybiBpbnN0YW5jZTtcbiAgfVxuXG4gIGluaXQob3B0aW9ucykge1xuICAgIC8vIGhpZGUgaW1wb3J0em9uZVxuICAgIHRoaXMuc2hvd0ltcG9ydChmYWxzZSk7XG4gICAgLy8gcmVtb3ZlIGxpbmUgb2YgdGFyZ2V0IHByb2pcbiAgICBsZXQgcHJvamlkID0gdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJyMnICsgZG9tc2VsZWN0b3JzLnByb2ppZCk7XG4gICAgaWYgKHByb2ppZCAmJiBwcm9qaWQudmFsdWUpIHtcbiAgICAgIHByb2ppZCA9IHRoaXMuZG9tLnF1ZXJ5U2VsZWN0b3IoJ1snICsgdGhpcy5zZWxlY3RvciArICc9XCInICsgcHJvamlkLnZhbHVlICsgJ1wiXScpO1xuICAgICAgaWYgKHByb2ppZCkgcHJvamlkLmhpZGRlbiA9IHRydWU7XG4gICAgfVxuICAgIGNvbnN0IGluZGV4dG9jaGVjayA9IHRoaXMuaW5kZXhUb0NoZWNrKCk7XG4gICAgdGhpcy5zZWxlY3RvcnMgPSB0aGlzLmRvbS5xdWVyeVNlbGVjdG9yQWxsKCdbJyArIHRoaXMuc2VsZWN0b3IgKyAnXSBidXR0b24sIFsnICsgdGhpcy5zZWxlY3RvciArICddIGlucHV0Jyk7XG4gICAgdGhpcy5zZWxlY3RvcnMuZm9yRWFjaChzZWxlY3RvciA9PiB7XG4gICAgICAvLyBjaGVja2JveCBwb3NzaWJsZVxuICAgICAgY29uc3QgaW5kZXggPSBBcnJheS5mcm9tKHNlbGVjdG9yLnBhcmVudEVsZW1lbnQuY2hpbGRyZW4pLmluZGV4T2YoKHNlbGVjdG9yKSk7XG4gICAgICBpZiAoaW5kZXh0b2NoZWNrICYmIHNlbGVjdG9yLmNsb3Nlc3QoJ3RyJykuY2hpbGRyZW5baW5kZXh0b2NoZWNrW2luZGV4XV0uaW5uZXJIVE1MID09PSAnJykgdGhpcy5kaXNhYmxlU2VsZWN0b3Ioc2VsZWN0b3IsIGZhbHNlKTtcbiAgICAgIGVsc2Uge1xuICAgICAgICBjb25zdCBldnQgPSAoc2VsZWN0b3IudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnaW5wdXQnKSA/ICdjaGFuZ2UnIDogJ2NsaWNrJztcbiAgICAgICAgY29uc3QgYXBwbHlfc2VsZWN0aW9uID0gKGUpID0+IHtcbiAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICBjb25zdCB0YXJnZXQgPSBlLmN1cnJlbnRUYXJnZXQ7XG4gICAgICAgICAgY29uc3QgYWRkID0gKGV2dCA9PT0gJ2NsaWNrJyB8fCB0YXJnZXQuY2hlY2tlZCA9PT0gdHJ1ZSk7XG4gICAgICAgICAgdGhpcy5kaXNhYmxlU2VsZWN0b3IodGFyZ2V0LCBhZGQpO1xuICAgICAgICAgIHRoaXMudG9JbXBvcnQodGFyZ2V0LnBhcmVudEVsZW1lbnQsIGluZGV4LCBhZGQpO1xuICAgICAgICB9O1xuICAgICAgICBzZWxlY3Rvci5yZW1vdmVFdmVudExpc3RlbmVyKGV2dCwgYXBwbHlfc2VsZWN0aW9uLCBmYWxzZSk7XG4gICAgICAgIHNlbGVjdG9yLmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCBhcHBseV9zZWxlY3Rpb24sIGZhbHNlKTtcbiAgICAgIH07XG4gICAgfSk7XG4gICAgaWYgKHRoaXMudGFiYnV0dG9uKSB7XG4gICAgICB0aGlzLnRhYmJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5yZXNpemVab25lKGUpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gIH1cblxuICBjb2x1bW5Qcm9wZXJ0eShuYW1lLCBpbmRleCkge1xuICAgIGNvbnN0IHRoID0gdGhpcy50aGNlbGxzW2luZGV4XTtcbiAgICBpZiAodGhpcy50YmwpIHJldHVybiAodGhpcy50YmwuZ3JpZC5jb2x1bW5zW2luZGV4XS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgPyB0aGlzLnRibC5ncmlkLmNvbHVtbnNbaW5kZXhdW25hbWVdIDogbnVsbDtcbiAgICBlbHNlIHJldHVybiAodGguZGF0YXNldFtuYW1lXSkgPyB0aC5kYXRhc2V0Lm5hbWUgOiBudWxsO1xuICB9XG4gIGNvbHVtbkluZGV4KHByb3AsIHZhbHVlKSB7XG4gICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5kb20ucXVlcnlTZWxlY3RvckFsbCgndGhlYWQgdGgnKSkuZmluZEluZGV4KHRoID0+ICh0aC5kYXRhc2V0W3Byb3BdICYmIHRoLmRhdGFzZXRbcHJvcF0gPT09IHZhbHVlKSk7XG4gIH1cbiAgZ3JpZENvbHVtbkluZGV4KHByb3AsIHZhbHVlKSB7XG4gICAgaWYgKHRoaXMudGJsKSByZXR1cm4gdGhpcy50YmwuZ3JpZC5jb2x1bW5zLmZpbmRJbmRleChjb2x1bW4gPT4gKGNvbHVtbi5oYXNPd25Qcm9wZXJ0eShwcm9wKSAmJiBjb2x1bW5bcHJvcF0gPT09IHZhbHVlKSk7XG4gICAgZWxzZSByZXR1cm4gdGhpcy5jb2x1bW5JbmRleChwcm9wLCB2YWx1ZSk7XG4gIH1cbiAgcm93SW5kZXgodGQpIHtcbiAgICBjb25zdCByZWYgPSAodGQucGFyZW50RWxlbWVudCkgPyB0ZC5wYXJlbnRFbGVtZW50IDogbnVsbDtcbiAgICBpZiAoIXJlZikgcmV0dXJuIG51bGw7XG4gICAgcmV0dXJuIHRoaXMudHJzLmZpbmRJbmRleCh0ciA9PiAodHIgPT09IHJlZikpO1xuICB9XG4gIGRpc2FibGVTZWxlY3RvcihzZWxlY3RvciwgZGlzYWJsZSA9IHRydWUpIHtcbiAgICBjb25zdCB0eXBlID0gc2VsZWN0b3IudGFnTmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgIGlmICh0eXBlID09PSBcImlucHV0XCIpIHtcbiAgICAgIGlmIChzZWxlY3Rvci5jaGVja2VkICE9PSBkaXNhYmxlKSBzZWxlY3Rvci5jaGVja2VkID0gZGlzYWJsZTtcbiAgICB9IC8vIGRpc2FibGUgYnV0dG9uIGJ1dCB0b2dnbGUgY2hlY2tib3hcbiAgICBlbHNlIHNlbGVjdG9yLmRpc2FibGVkID0gZGlzYWJsZTtcbiAgfVxuXG4gIGdldERhdGFUb0ltcG9ydChjZWxsLCBjZWxsZGF0YSkge1xuICAgIGxldCB0b2ltcG9ydCA9IGNlbGxkYXRhO1xuICAgIGlmIChjZWxsICE9PSBudWxsKSB7XG4gICAgICBpZiAoY2VsbC5kYXRhc2V0LmF1dG9jb21wbGV0ZSkge1xuICAgICAgICAvLyBzZWxlY3QgZWxlbWVudHMgd2hlcmUga2V5IC8gdmFsdWUgaW4gZGlmZmVyZW50IGNvbHVtbnNcbiAgICAgICAgdG9pbXBvcnQgPSB7XG4gICAgICAgICAgdmFsdWU6IGNlbGxkYXRhLFxuICAgICAgICAgIGtleTogbnVsbFxuICAgICAgICB9O1xuICAgICAgICBsZXQgZWwgPSBudWxsO1xuICAgICAgICB0aGlzLnRoY2VsbHMuZXZlcnkoKHQsIGlkeCkgPT4ge1xuICAgICAgICAgIGlmICh0LmRhdGFzZXQubmFtZSA9PSB0aGNlbGwuZGF0YXNldC5hdXRvY29tcGxldGUpIHtcbiAgICAgICAgICAgIGVsID0gaWR4O1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChlbCAhPT0gbnVsbCkge1xuICAgICAgICAgIGVsID0gdGhpcy5kYXRhc1tyb3dpbmRleF1bZWxdO1xuXG4gICAgICAgICAgdG9pbXBvcnQua2V5ID0gZWw7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoY2VsbC5kYXRhc2V0LnZhbHVlKSB0b2ltcG9ydCA9IGNlbGwuZGF0YXNldC52YWx1ZTtcblxuICAgIH1cbiAgICByZXR1cm4gdG9pbXBvcnQ7XG4gIH1cbiAgZ2V0U2VsZWN0Q2VsbHMoY2VsbGluZGV4LCB3aGF0cGFydCkge1xuICAgIGNvbnN0IHBhcnRzID0gdGhpcy5jb2x1bW5Qcm9wZXJ0eSgncGFydHMnLCBjZWxsaW5kZXgpO1xuICAgIGxldCBzZWxlY3RjZWxscyA9IHRoaXMuY29sdW1uUHJvcGVydHkoJ3NlbGVjdGNlbGxzJywgY2VsbGluZGV4KTtcbiAgICBzZWxlY3RjZWxscyA9IChzZWxlY3RjZWxscykgPyAoKHBhcnRzKSA/IFtwYXJ0c1t3aGF0cGFydF1dIDogc2VsZWN0Y2VsbHMpIDogbnVsbDtcbiAgICByZXR1cm4gc2VsZWN0Y2VsbHM7XG4gIH1cblxuICBwb3B1bGF0ZUltcG9ydFpvbmUoYWRkLCBpdGVtcykge1xuICAgIGlmICghdGhpcy5pbXBvcnR6b25lKSByZXR1cm47XG4gICAgY29uc3QgdHMgPSB0aGlzLmltcG9ydHpvbmUudG9tc2VsZWN0O1xuICAgIGlmICh0cykge1xuICAgICAgT2JqZWN0LnZhbHVlcyh0cy5vcHRpb25zKS5mb3JFYWNoKChvcHQpID0+IHtcbiAgICAgICAgbGV0IG9iaiA9IHt9O1xuICAgICAgICBvYmpbb3B0W3RzLnNldHRpbmdzLnZhbHVlRmllbGRdXSA9IG9wdFt0cy5zZXR0aW5ncy5sYWJlbEZpZWxkXTtcbiAgICAgICAgaWYgKCFpdGVtc1tvcHRbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF1dKSBpdGVtcyA9IE9iamVjdC5hc3NpZ24oaXRlbXMsIG9iaik7XG4gICAgICB9KTtcbiAgICAgIGl0ZW1zID0gT2JqZWN0LmVudHJpZXMoaXRlbXMpO1xuICAgICAgLy8gc29ydCBpdGVtc1xuICAgICAgaXRlbXMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICBsZXQgeCA9IGFbMV07XG4gICAgICAgIGxldCB5ID0gYlsxXTtcbiAgICAgICAgcmV0dXJuICsoeCA+IHkpIHx8IC0oeSA+IHgpO1xuICAgICAgfSk7XG4gICAgICAvLyAgdHMuY2xlYXIoKTtcbiAgICAgIC8vdHMuY2xlYXJPcHRpb25zKCk7XG4gICAgICAvLyBhZGQgdHMgaXRlbXNcbiAgICAgIGlmIChhZGQpIGl0ZW1zLmZvckVhY2goKFtrZXksIHRleHRdKSA9PiB7XG4gICAgICAgIGlmICh0cy5nZXRJdGVtKGtleSkgPT09IG51bGwpIHtcbiAgICAgICAgICBpZiAodHMuZ2V0T3B0aW9uKGtleSkgPT09IG51bGwpIHtcbiAgICAgICAgICAgIGxldCBvYmogPSB7fTtcbiAgICAgICAgICAgIG9ialt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSA9IGtleTtcbiAgICAgICAgICAgIG9ialt0cy5zZXR0aW5ncy5sYWJlbEZpZWxkXSA9IHVuZXNjYXBlX2h0bWwodGV4dC50cmltKCkpO1xuICAgICAgICAgICAgdHMuYWRkT3B0aW9uKG9iaik7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRzLmFkZEl0ZW0oa2V5KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBlbHNlIGl0ZW1zLmZvckVhY2goKFtrZXksIHRleHRdKSA9PiB7XG4gICAgICAgIHRzLnJlbW92ZUl0ZW0oa2V5KTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBPYmplY3QudmFsdWVzKHRoaXMuaW1wb3J0em9uZS5vcHRpb25zKS5mb3JFYWNoKG9wdCA9PiB7XG4gICAgICAgIGxldCBvYmogPSB7fTtcbiAgICAgICAgb2JqW29wdC52YWx1ZV0gPSBvcHQudGV4dDtcbiAgICAgICAgaWYgKCFpdGVtc1tvcHQudmFsdWVdKSBpdGVtcyA9IE9iamVjdC5hc3NpZ24oaXRlbXMsIG9iaik7XG4gICAgICB9KTtcbiAgICAgIGl0ZW1zID0gT2JqZWN0LmVudHJpZXMoaXRlbXMpO1xuICAgICAgaXRlbXMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICBsZXQgeCA9IGFbMV07XG4gICAgICAgIGxldCB5ID0gYlsxXTtcbiAgICAgICAgcmV0dXJuICsoeCA+IHkpIHx8IC0oeSA+IHgpO1xuICAgICAgfSk7XG4gICAgICB0aGlzLmltcG9ydHpvbmUuaW5uZXJIVE1MID0gYGA7XG4gICAgICBpZiAoYWRkKSBpdGVtcy5mb3JFYWNoKChba2V5LCB0ZXh0XSkgPT4ge1xuICAgICAgICBjb25zdCBvcHQgPSB0aGlzLmltcG9ydHpvbmUucXVlcnlTZWxlY3Rvcignb3B0aW9uW3ZhbHVlPVwiJyArIGtleSArICdcIl0nKTtcbiAgICAgICAgaWYgKCFvcHQpIHtcbiAgICAgICAgICBjb25zdCBvID0gY3JlYXRlX2JveCgnb3B0aW9uJywge1xuICAgICAgICAgICAgdmFsdWU6IGtleSxcbiAgICAgICAgICAgIHNlbGVjdGVkOiAnc2VsZWN0ZWQnLFxuICAgICAgICAgICAgdGV4dDogdGV4dFxuICAgICAgICAgIH0sIHRoaXMuaW1wb3J0em9uZSk7XG4gICAgICAgIH0gZWxzZSBvcHQuc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgfSk7XG4gICAgICBlbHNlIGl0ZW1zLmZvckVhY2goKFtrZXksIHRleHRdKSA9PiB7XG4gICAgICAgIGNvbnN0IG9wdCA9IHRoaXMuaW1wb3J0em9uZS5xdWVyeVNlbGVjdG9yKCdvcHRpb25bdmFsdWU9XCInICsga2V5ICsgJ1wiXScpO1xuICAgICAgICBpZiAob3B0KSBvcHQucmVtb3ZlKCk7IC8vIG9yIG9wdC5zZWxlY3RlZD1mYWxzZTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHRvSW1wb3J0KHRkLCB3aGF0cGFydCA9IDAsIGFkZCA9IHRydWUpIHtcbiAgICAvLyBjZWxsIHZhbHVlcyBpbiBqc29uICAtIG5vIHBhcnNlXG4gICAgaWYgKHRkLnRhZ05hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ3RkJykgdGQgPSB0ZC5jbG9zZXN0KCd0ZCcpO1xuICAgIGNvbnN0IHJvd2luZGV4ID0gdGhpcy5yb3dJbmRleCh0ZCk7XG4gICAgaWYgKHJvd2luZGV4ID09PSBudWxsKSByZXR1cm47XG4gICAgbGV0IHNob3didG5zID0gdHJ1ZTtcbiAgICBsZXQgY29udGFjdCA9IG51bGw7XG4gICAgY29uc3QgY2VsbGluZGV4ID0gdGQuY2VsbEluZGV4O1xuICAgIGNvbnN0IHdoYXQgPSB0aGlzLmNvbHVtblByb3BlcnR5KCd3aGF0JywgY2VsbGluZGV4KTtcbiAgICBpZiAoIXdoYXQpIHJldHVybjtcbiAgICBjb25zdCBwYXJ0cyA9IHRoaXMuY29sdW1uUHJvcGVydHkoJ3BhcnRzJywgY2VsbGluZGV4KTtcbiAgICBjb25zdCBzZWxlY3RjZWxscyA9IHRoaXMuZ2V0U2VsZWN0Q2VsbHMoY2VsbGluZGV4LCB3aGF0cGFydCk7XG4gICAgaWYgKCFzZWxlY3RjZWxscykgcmV0dXJuO1xuICAgIGlmIChbdHlwZWltcG9ydC5zZXR0aW5ncywgdHlwZWltcG9ydC5wcml2aWxlZ2VzXS5pbmRleE9mKHdoYXQpID49IDApIHRoaXMuaW1wb3J0c1ttb2RlbHMuY29udGFjdF0gPSB0aGlzLmZpbmRDb250YWN0KHRoaXMuZGF0YXNbcm93aW5kZXhdKTtcbiAgICBpZiAoW3R5cGVpbXBvcnQucHJvamVjdCwgdHlwZWltcG9ydC50YXhvLCB0eXBlaW1wb3J0LnByaXZpbGVnZXNdLmluZGV4T2Yod2hhdCkgPj0gMCkgdGhpcy5jcmVhdGVJbXBvcnR6b25lKHdoYXQpO1xuICAgIHRoaXMuYWRkUmVzZXRCdXR0b24oKTtcbiAgICBsZXQgdHMgPSBudWxsO1xuICAgIHNlbGVjdGNlbGxzLmZvckVhY2goKG5hbWUsIGluZGV4KSA9PiB7XG4gICAgICBpbmRleCA9IHRoaXMuZ3JpZENvbHVtbkluZGV4KCduYW1lJywgbmFtZSk7XG4gICAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgICBjb25zdCB0ZGluZGV4ID0gdGhpcy5jb2x1bW5JbmRleCgnbmFtZScsIG5hbWUpO1xuICAgICAgICAvLyBzaG93IGltcG9ydCBidXR0b25zIGlmIGltcG9ydHpvbmVcbiAgICAgICAgY29uc3QgY2VsbCA9ICh0ZGluZGV4ID49IDApID8gdGhpcy50cnNbcm93aW5kZXhdLmNlbGxzW3RkaW5kZXhdIDogbnVsbDtcbiAgICAgICAgaWYgKGNlbGwpIGNlbGwuY2xhc3NMaXN0LmFkZChjc3Muc2VsZWN0ZWQpO1xuICAgICAgICBjb25zdCByb3dkYXRhID0gdGhpcy5kYXRhc1tyb3dpbmRleF07XG4gICAgICAgIGNvbnN0IGNlbGxkYXRhID0gcm93ZGF0YVtpbmRleF07XG4gICAgICAgIGNvbnN0IHRoY2VsbCA9ICh0ZGluZGV4ID49IDApID8gdGhpcy50aGNlbGxzW3RkaW5kZXhdIDogbnVsbDtcbiAgICAgICAgc3dpdGNoICh3aGF0KSB7XG4gICAgICAgICAgY2FzZSB0eXBlaW1wb3J0LnRheG86XG4gICAgICAgICAgICBpZiAoIXRoaXMuaW1wb3J0em9uZSkgcmV0dXJuO1xuICAgICAgICAgICAgLy8gYWNjdW11bGF0ZSBhbmQgc2hvdyBpbiBpbXBvcnQgd2luIC0gbW92ZSB0aGUgZm9ybSBmaWVsZCBpbiBtb2RhbCB3aW4gdG8gdmlldyB0aGUgY2hhbmdlcyBhbmQgYmVuZWZpdCBvZiB0b20tc2VsZWN0IGNvbXBvbmVudCBmdW5jdHMuLi5cbiAgICAgICAgICAgIHRzID0gdGhpcy5pbXBvcnR6b25lLnRvbXNlbGVjdDtcbiAgICAgICAgICAgIGxldCB0YXhvbnMgPSBjZWxsZGF0YTtcbiAgICAgICAgICAgIGlmICh0YXhvbnMpIHtcbiAgICAgICAgICAgICAgdGhpcy5wb3B1bGF0ZUltcG9ydFpvbmUoYWRkLCB0YXhvbnMpO1xuICAgICAgICAgICAgICBzaG93YnRucyA9IChPYmplY3Qua2V5cyh0YXhvbnMpLmxlbmd0aCA+IDApO1xuICAgICAgICAgICAgICB0YXhvbnMgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSB0eXBlaW1wb3J0LnByaXZpbGVnZXM6XG4gICAgICAgICAgICBjb25zdCBwcml2cyA9IGNlbGxkYXRhO1xuICAgICAgICAgICAgLy8gc2V0IGV2ZXJ5Ym9keSB0byAndmlldycgaWYgbW9yZSB0aGFuIG9uZSBwcm9qZWN0IGltcG9ydGVkXG4gICAgICAgICAgICBjb25zdCByZXNldHByaXYgPSAoKHRzICYmIHRzLml0ZW1zLmxlbmd0aCA+IDApIHx8ICh0aGlzLmltcG9ydHpvbmUuc2VsZWN0ZWRJbmRleCA+IDApKTtcbiAgICAgICAgICAgIGlmICghdGhpcy5pbXBvcnR6b25lLnRvbXNlbGVjdCkge1xuICAgICAgICAgICAgICB0aGlzLmltcG9ydHpvbmUuY3VycmVudGxpc3QgPSB7fTtcbiAgICAgICAgICAgICAgSnNUb21TZWxlY3QuYXBwbHlUbyh0aGlzLmltcG9ydHpvbmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdHMgPSB0aGlzLmltcG9ydHpvbmUudG9tc2VsZWN0O1xuICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMocHJpdnMpLmZvckVhY2goKFtwcml2LCBtZW1iZXJzXSkgPT4ge1xuICAgICAgICAgICAgICBtZW1iZXJzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gKGIubmFtZSA+IGEubmFtZSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBtZW1iZXJzLmZvckVhY2gobWVtYmVyID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdwcml2ID0gKHJlc2V0cHJpdikgPyBrZXlfcHJpdmlsZWdlcy52aWV3ZXJzIDogcHJpdjsgLy8gdmlld2VyIGlmIG1vcmUgdGhhbiBvbmUgcHJvamVjdCBpbXBvcnRlZFxuICAgICAgICAgICAgICAgIGxldCBvcHQ7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmltcG9ydHpvbmUuY3VycmVudGxpc3QgfHwgIXRoaXMuaW1wb3J0em9uZS5jdXJyZW50bGlzdFttZW1iZXIuaWRdKSB7XG4gICAgICAgICAgICAgICAgICBpZiAodHMpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0ID0gdHMuaXRlbXMuaW5kZXhPZihtZW1iZXIuaWQpO1xuICAgICAgICAgICAgICAgICAgICAvL1RPRE8gLSB0ZXN0IC0gb3B0IHNob3VsZCBhbHdheXMgYmUgMFxuICAgICAgICAgICAgICAgICAgICBpZiAob3B0ID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICB0cy5yZW1vdmVJdGVtKG1lbWJlci5pZCk7XG4gICAgICAgICAgICAgICAgICAgICAgdHMucmVtb3ZlT3B0aW9uKG1lbWJlci5pZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gYWRkb3B0aW9uICYmIGFkZEl0ZW1cbiAgICAgICAgICAgICAgICAgICAgb3B0ID0ge1xuICAgICAgICAgICAgICAgICAgICAgIG9wdGdyb3VwOiBuZXdwcml2XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgb3B0W3RzLnNldHRpbmdzLnZhbHVlRmllbGRdID0gbWVtYmVyLmlkO1xuICAgICAgICAgICAgICAgICAgICBvcHRbdHMuc2V0dGluZ3Muc2VhcmNoRmllbGRdID0gbWVtYmVyLm5hbWU7XG4gICAgICAgICAgICAgICAgICAgIG9wdFt0cy5zZXR0aW5ncy5sYWJlbEZpZWxkXSA9IG1lbWJlci5uYW1lO1xuICAgICAgICAgICAgICAgICAgICB0cy5hZGRPcHRpb24ob3B0KTtcbiAgICAgICAgICAgICAgICAgICAgdHMuYWRkSXRlbShtZW1iZXIuaWQpO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0ID0gdGhpcy5pbXBvcnR6b25lLnF1ZXJ5U2VsZWN0b3IoJ29wdGlvblt2YWx1ZT1cIicgKyBtZW1iZXIuaWQgKyAnXCJdJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHQgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICBvcHQgPSBjcmVhdGVfYm94KCdvcHRpb24nLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbWVtYmVyLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YXNldDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRncm91cDogbmV3cHJpdlxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFNlbGVjdGVkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogbWVtYmVyLm5hbWVcbiAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW1wb3J0em9uZS5hZGQob3B0KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIG9wdC5kYXRhc2V0Lm9wdGdyb3VwID0gbmV3cHJpdjtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBpZiAodHMpIHRzLnJlZnJlc2hPcHRpb25zKHRydWUpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBzaG93YnRucyA9ICgoKHRzKSA/IHRzLml0ZW1zLmxlbmd0aCA6IHRoaXMuaW1wb3J0em9uZS5zZWxlY3RlZEluZGV4ICsgMSkgPiAwKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgdHlwZWltcG9ydC5wcm9qZWN0OlxuICAgICAgICAgICAgY29uc3QgbG4gPSBPYmplY3Qua2V5cyh0aGlzLmltcG9ydHMpLmxlbmd0aDtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLmltcG9ydHNbbmFtZV0pIHRoaXMuaW1wb3J0c1tuYW1lXSA9IFtdO1xuICAgICAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZ2V0RGF0YVRvSW1wb3J0KGNlbGwsIGNlbGxkYXRhKTtcbiAgICAgICAgICAgIGlmIChhZGQpIHRoaXMuaW1wb3J0c1tuYW1lXS5wdXNoKGRhdGEpO1xuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnN0IGlkeCA9IHRoaXMuaW1wb3J0c1tuYW1lXS5pbmRleE9mKGRhdGEpO1xuICAgICAgICAgICAgICBpZiAoaWR4ID4gLTEpIHRoaXMuaW1wb3J0c1tuYW1lXS5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChuYW1lID09PSBtb2RlbHMucHJvamlkKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGlkeCA9IHRoaXMuY29sdW1uSW5kZXgoJ25hbWUnLCAndGl0bGUnKTtcbiAgICAgICAgICAgICAgLy8gc2hvdyBpbXBvcnQgYnV0dG9ucyBpZiBpbXBvcnR6b25lXG4gICAgICAgICAgICAgIGNvbnN0IGNlbGxsYWJlbCA9IChpZHggPj0gMCkgPyB0aGlzLnRyc1tyb3dpbmRleF0uY2VsbHNbaWR4XSA6IG51bGw7XG4gICAgICAgICAgICAgIGNvbnN0IGRhdGFsYWJlbCA9IHJvd2RhdGFbaWR4XTtcbiAgICAgICAgICAgICAgY29uc3QgbGFiZWwgPSAoY2VsbGxhYmVsKSA/IHRoaXMuZ2V0RGF0YVRvSW1wb3J0KGNlbGxsYWJlbCwgZGF0YWxhYmVsKSA6IGRhdGE7XG4gICAgICAgICAgICAgIGNvbnN0IGl0ZW1zID0ge307XG4gICAgICAgICAgICAgIGl0ZW1zW3Jvd2RhdGFbdGhpcy50YmwuZ2V0Q2VsbElkKHRoaXMudGJsLmNlbGxpZG5hbWUpXV0gPSBsYWJlbDtcbiAgICAgICAgICAgICAgdGhpcy5wb3B1bGF0ZUltcG9ydFpvbmUoYWRkLCBpdGVtcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobG4gPT09IDApIHtcbiAgICAgICAgICAgICAgaWYgKGFkZCkgdGhpcy5maWx0ZXJCeVJlY29yZChyb3dkYXRhLCByb3dpbmRleCk7XG4gICAgICAgICAgICAgIGVsc2UgdGhpcy5yZXNldEZpbHRlcigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIGlmIChhZGQpIHRoaXMuaW1wb3J0c1tuYW1lXSA9IHRoaXMuZ2V0RGF0YVRvSW1wb3J0KGNlbGwsIGNlbGxkYXRhKTtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICBjb25zdCBpZHggPSB0aGlzLmltcG9ydHMuaW5kZXhPZihuYW1lKTtcbiAgICAgICAgICAgICAgaWYgKGlkeCA+IC0xKSB0aGlzLmltcG9ydHMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9KTtcbiAgICBpZiAodGhpcy50aGNlbGxzLmxlbmd0aCkge1xuICAgICAgaWYgKHRoaXMuYnV0dG9uKSB7XG4gICAgICAgIGNvbnN0IGFjdGl2YXRlID0gKCF0aGlzLmJ1dHRvbi5kYXRhc2V0LmFjdGl2YXRlZCAmJiAoW3R5cGVpbXBvcnQudGF4bywgdHlwZWltcG9ydC5wcml2aWxlZ2VzLCB0eXBlaW1wb3J0LnByb2plY3RdLmluZGV4T2Yod2hhdCkgPj0gMCkpO1xuICAgICAgICB0aGlzLnNob3dJbXBvcnQoc2hvd2J0bnMpO1xuICAgICAgICBpZiAoYWN0aXZhdGUpIHRoaXMuYWN0aXZhdGVCdXR0b25zKHdoYXQsIHNlbGVjdGNlbGxzKTtcbiAgICAgIH0gZWxzZSB0aGlzLm1ha2VJbXBvcnQobnVsbCwgc2VsZWN0Y2VsbHMsIHdoYXQsIHRydWUpO1xuICAgIH1cbiAgfVxuICBtZXNzYWdlWm9uZShpdGVtKSB7XG4gICAgY29uc29sZS5sb2coJ2l0ZW1tZXNzYWdlJywgaXRlbSk7XG4gIH1cbiAgYWN0aXZhdGVCdXR0b25zKHdoYXQsIHNlbGVjdGNlbGxzKSB7XG4gICAgdGhpcy5idXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoZSkgPT4ge1xuICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGF3YWl0IHRoaXMubWFrZUltcG9ydChlLmN1cnJlbnRUYXJnZXQsIHNlbGVjdGNlbGxzLCB3aGF0LCB0cnVlKTtcbiAgICB9KTtcbiAgICB0aGlzLnJlcGxhY2VidXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoZSkgPT4ge1xuICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGF3YWl0IHRoaXMubWFrZUltcG9ydChlLmN1cnJlbnRUYXJnZXQsIHNlbGVjdGNlbGxzLCB3aGF0LCB0cnVlKTtcbiAgICB9KTtcbiAgICB0aGlzLmJ1dHRvbi5kYXRhc2V0LmFjdGl2YXRlZCA9IHRydWU7XG4gICAgdGhpcy5yZXBsYWNlYnV0dG9uLmRhdGFzZXQuYWN0aXZhdGVkID0gdHJ1ZTtcbiAgfVxuXG4gIGZpbmRDb250YWN0KHRkcywgbmFtZSA9ICdjb250YWN0Jykge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5ncmlkQ29sdW1uSW5kZXgoJ25hbWUnLCBuYW1lKTtcbiAgICBpZiAoaW5kZXggPj0gMCkgcmV0dXJuIHRkc1tpbmRleF0gPyB0ZHNbaW5kZXhdIDogbnVsbDtcblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcmVuZGVyUHJpdmlsZWdlcyhyZXBsYWNlID0gZmFsc2UpIHtcbiAgICBsZXQgcHJpdmlsZWdlcyA9IHt9O1xuICAgIGNvbnN0IHR6b25lID0gdGhpcy5pbXBvcnR6b25lLnRvbXNlbGVjdDtcbiAgICBjb25zdCBwdXNocHJpdiA9IChtZW1iZXIsIHByaXYpID0+IHtcbiAgICAgIGNvbnN0IG9iaiA9IHtcbiAgICAgICAgaWQ6IG1lbWJlci5pZCxcbiAgICAgICAgbmFtZTogbWVtYmVyLm5hbWUsXG4gICAgICAgIHByaXY6IHByaXZcbiAgICAgIH1cbiAgICAgIGlmIChwcml2aWxlZ2VzW3ByaXZdKSBwcml2aWxlZ2VzW3ByaXZdLnB1c2gob2JqKTtcbiAgICAgIGVsc2UgcHJpdmlsZWdlc1twcml2XSA9IFtvYmpdO1xuICAgIH1cblxuICAgIGlmICh0em9uZSkge1xuICAgICAgY29uc3QgbWVtYmVycyA9IFsuLi50em9uZS5pdGVtc107XG4gICAgICBjb25zdCBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgdHpvbmUub3B0aW9ucyk7XG4gICAgICBtZW1iZXJzLmZvckVhY2gobWVtYmVyID0+IHtcbiAgICAgICAgbWVtYmVyID0gb3B0aW9uc1ttZW1iZXJdO1xuICAgICAgICBpZiAobWVtYmVyKSBwdXNocHJpdihtZW1iZXIsIG1lbWJlci5vcHRncm91cCk7XG5cbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaW1wb3J0em9uZS5vcHRpb25zLmZvckVhY2gobWVtYmVyID0+IHtcbiAgICAgICAgaWYgKG1lbWJlci5zZWxlY3RlZCkgcHVzaHByaXYobWVtYmVyLCBtZW1iZXIuZGF0YXNldC5vcHRncm91cCk7XG4gICAgICB9KVxuICAgIH1cblxuICAgIGlmICh0aGlzLmltcG9ydFByaXZpbGVnZXMocHJpdmlsZWdlcywgcmVwbGFjZSkpIHtcbiAgICAgIGlmICh0em9uZSkge1xuICAgICAgICB0em9uZS5jbGVhcigpO1xuICAgICAgICB0em9uZS5jbGVhck9wdGlvbnMoKTtcbiAgICAgIH0gZWxzZSB0aGlzLmltcG9ydHpvbmUuaW5uZXJIVE1MID0gYGA7XG5cbiAgICB9XG5cbiAgfVxuXG4gIGltcG9ydFByaXZpbGVnZXMocHJpdmlsZWdlcywgY2xlYXIgPSBmYWxzZSkge1xuICAgIGNvbnN0IHByb2plY3RQcml2aWxlZ2VzID0gdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJy4nICsgZG9tc2VsZWN0b3JzLmNvbXBvbmVudC5wcml2aWxlZ2VzLmlkZW50KTtcbiAgICBpZiAocHJvamVjdFByaXZpbGVnZXMgPT09IG51bGwgfHwgIXByb2plY3RQcml2aWxlZ2VzLmpzcHJpdmlsZWdlcykgcmV0dXJuO1xuICAgIGNvbnN0IGltcG9ydGVkdGFnID0gKGlucHV0KSA9PiB7XG4gICAgICB0aGlzLnNldEltcG9ydGVkVGFnKGlucHV0LCBudWxsKTtcbiAgICB9XG4gICAgY29uc3QgZGlzbWlzcyA9ICgpID0+IHtcbiAgICAgIHRoaXMuZGlzbWlzcygpO1xuICAgIH1cbiAgICBjb25zdCBjb250YWN0ID0gKGNsZWFyID09PSB0cnVlICYmIHRoaXMuaW1wb3J0c1ttb2RlbHMuY29udGFjdF0pID8gdGhpcy5pbXBvcnRzW21vZGVscy5jb250YWN0XSA6IG51bGw7XG4gICAgcmV0dXJuIChwcm9qZWN0UHJpdmlsZWdlcy5qc3ByaXZpbGVnZXMuaW1wb3J0UHJpdmlsZWdlcyhwcml2aWxlZ2VzLCBjbGVhciwgY29udGFjdCwgaW1wb3J0ZWR0YWcsIGRpc21pc3MpKTtcbiAgfVxuXG4gIHJlc2V0U2VsZWN0b3IodHIpIHtcbiAgICBjb25zdCByZXNldHMgPSB7fTtcbiAgICBjb25zdCBhcHBlbmRfcmVzZXRzID0gKG5hbWUsIHRkLCBpKSA9PiB7XG4gICAgICBjb25zdCByb3dpbmRleCA9IHRoaXMucm93SW5kZXgodGQpO1xuICAgICAgY29uc3QgY2VsbGRhdGEgPSB0aGlzLmRhdGFzW3Jvd2luZGV4XVtpXTtcbiAgICAgIGNvbnN0IGNlbGwgPSB0aGlzLnRyc1tyb3dpbmRleF0uY2VsbHNbaV07XG4gICAgICBjb25zdCBkYXRhID0gdGhpcy5nZXREYXRhVG9JbXBvcnQoY2VsbCwgY2VsbGRhdGEpO1xuICAgICAgaWYgKCFyZXNldHNbbmFtZV0pIHJlc2V0c1tuYW1lXSA9IFtkYXRhXTtcbiAgICAgIGVsc2UgaWYgKHJlc2V0c1tuYW1lXS5pbmRleE9mKGRhdGEpIDwgMCkgcmVzZXRzW25hbWVdLnB1c2goZGF0YSk7XG4gICAgfVxuICAgIGNvbnN0IHNlbGVjdG9ycyA9IHRyLnF1ZXJ5U2VsZWN0b3JBbGwoJ1snICsgdGhpcy5zZWxlY3RvciArICddIGJ1dHRvbiwgWycgKyB0aGlzLnNlbGVjdG9yICsgJ10gaW5wdXQnKTtcbiAgICBzZWxlY3RvcnMuZm9yRWFjaCgoc2VsZWN0b3IsIGkpID0+IHtcbiAgICAgIGlmIChzZWxlY3Rvci5kaXNhYmxlZCkgdGhpcy5kaXNhYmxlU2VsZWN0b3Ioc2VsZWN0b3IsIGZhbHNlKTtcbiAgICAgIGNvbnN0IG5hbWUgPSAoc2VsZWN0b3IucGFyZW50RWxlbWVudC5kYXRhc2V0Lm5hbWUpID8gc2VsZWN0b3IucGFyZW50RWxlbWVudC5kYXRhc2V0Lm5hbWUgOiBudWxsO1xuICAgICAgYXBwZW5kX3Jlc2V0cyhuYW1lLCBzZWxlY3Rvci5wYXJlbnRFbGVtZW50LCBpKTtcbiAgICB9KTtcbiAgICB0ci5xdWVyeVNlbGVjdG9yQWxsKCd0ZC4nICsgY3NzLnNlbGVjdGVkKS5mb3JFYWNoKCh0ZCwgaSkgPT4ge1xuICAgICAgdGQuY2xhc3NMaXN0LnJlbW92ZShjc3Muc2VsZWN0ZWQpO1xuICAgICAgYXBwZW5kX3Jlc2V0cyhuYW1lLCB0ZCwgaSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc2V0cztcbiAgfVxuXG4gIHJlc2V0U2VsZWN0b3JzKCkge1xuICAgIHRoaXMuc2VsZWN0b3JzLmZvckVhY2goKHNlbGVjdG9yLCBpKSA9PiB7XG4gICAgICBpZiAoc2VsZWN0b3IuZGlzYWJsZWQpIHRoaXMuZGlzYWJsZVNlbGVjdG9yKHNlbGVjdG9yLCBmYWxzZSk7XG4gICAgfSk7XG4gICAgdGhpcy5kb20ucXVlcnlTZWxlY3RvckFsbCgndGQuJyArIGNzcy5zZWxlY3RlZCkuZm9yRWFjaCh0ZCA9PiB7XG4gICAgICB0ZC5jbGFzc0xpc3QucmVtb3ZlKGNzcy5zZWxlY3RlZCk7XG4gICAgfSk7XG4gIH1cbiAgcmVzZXRJbXBvcnRzKCkge1xuICAgIHRoaXMuaW1wb3J0cyA9IFtdO1xuICAgIGlmICh0aGlzLmltcG9ydHpvbmUpIHtcbiAgICAgIGlmICh0aGlzLmltcG9ydHpvbmUuY3VycmVudGxpc3QpIHRoaXMuaW1wb3J0em9uZS5jdXJyZW50bGlzdCA9IHt9O1xuICAgICAgaWYgKHRoaXMuaW1wb3J0em9uZS50b21zZWxlY3QpIHRoaXMuaW1wb3J0em9uZS50b21zZWxlY3QuY2xlYXIoKTtcbiAgICAgIGVsc2Ugc3dpdGNoICh0aGlzLmltcG9ydHpvbmUudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgIGNhc2UgJ2lucHV0JzpcbiAgICAgICAgICB0aGlzLmltcG9ydHpvbmUudmFsdWUgPSAnJztcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnc2VsZWN0JzpcbiAgICAgICAgICB0aGlzLmltcG9ydHpvbmUuc2VsZWN0ZWRJbmRleCA9IC0xO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFjdGl2YXRlQ2xlYXIoKSB7XG4gICAgY29uc3QgY2xlYXJidXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2xlYXItJyArIHRoaXMuaW1wb3J0aWQpO1xuICAgIGlmICghY2xlYXJidXR0b24pIHJldHVybjtcbiAgICBjbGVhcmJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgaWYgKCF0aGlzLmltcG9ydGNvbnRhaW5lcikgcmV0dXJuO1xuICAgICAgdGhpcy5yZXNldFNlbGVjdG9ycygpO1xuICAgICAgdGhpcy5yZXNldEltcG9ydHMoKTtcbiAgICAgIHRoaXMuYnV0dG9uLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICB0aGlzLnJlcGxhY2VidXR0b24uZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuc2hvd0ltcG9ydChmYWxzZSk7XG4gICAgfSk7XG4gIH1cblxuICBjcmVhdGVJbXBvcnR6b25lKG5hbWUpIHtcbiAgICB0aGlzLnNob3dJbXBvcnQodHJ1ZSk7XG4gICAgbGV0IHRzID0gZmFsc2U7XG4gICAgaWYgKCF0aGlzLmltcG9ydHpvbmUpIHtcbiAgICAgIGlmIChuYW1lID09PSB0eXBlaW1wb3J0LnByaXZpbGVnZXMpIHtcbiAgICAgICAgdGhpcy5pbXBvcnR6b25lID0gY3JlYXRlX2JveCgnc2VsZWN0Jywge1xuICAgICAgICAgIGlkOiB0aGlzLmltcG9ydGlkLFxuICAgICAgICAgIGRhdGFzZXQ6IHtcbiAgICAgICAgICAgIHR5cGU6IG1vZGVscy51c2VyLFxuICAgICAgICAgICAgcHJpdjogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG11bHRpcGxlOiB0cnVlXG4gICAgICAgIH0sIHRoaXMuaW1wb3J0Y29udGFpbmVyKTtcbiAgICAgICAgdHMgPSB0cnVlO1xuICAgICAgfSBlbHNlIHtcblxuICAgICAgICBpZiAoIXRoaXMudGFyZ2V0aW1wb3J0KSByZXR1cm47XG4gICAgICAgIHRoaXMuaW1wb3J0em9uZWlkID0gdGhpcy50YXJnZXRpbXBvcnQuaWQ7XG4gICAgICAgIHRzID0gdGhpcy50YXJnZXRpbXBvcnQudG9tc2VsZWN0O1xuICAgICAgICAvLyB0b21zZWxlY3QgP1xuICAgICAgICBjb25zdCBpbXBvcnR6b25lID0gdGhpcy50YXJnZXRpbXBvcnQuY2xvbmVOb2RlKCk7XG4gICAgICAgIGltcG9ydHpvbmUuY2xhc3NMaXN0LnJlbW92ZShjc3MudG9tc2VsZWN0ZWQpO1xuICAgICAgICBpbXBvcnR6b25lLmNsYXNzTGlzdC5yZW1vdmUoY3NzLmhpZGRlbmFjY2Vzc2libGUpO1xuICAgICAgICAvLyBrZWVwIG9yaWdpbmFsIGlkIHRvIHJlcGxhY2UgZGF0YSBvbiBhcHBseSBpbXBvcnRcbiAgICAgICAgaW1wb3J0em9uZS5kYXRhc2V0Lm9yaWdpbiA9IGltcG9ydHpvbmUuaWQ7XG4gICAgICAgIGltcG9ydHpvbmUuaWQgPSB0aGlzLmltcG9ydGlkO1xuICAgICAgICBpbXBvcnR6b25lLm5hbWUgPSB0aGlzLmltcG9ydGlkICsgJ18nICsgaW1wb3J0em9uZS5uYW1lO1xuICAgICAgICB0aGlzLmltcG9ydGNvbnRhaW5lci5wcmVwZW5kKGltcG9ydHpvbmUpO1xuICAgICAgICB0aGlzLmltcG9ydHpvbmUgPSBpbXBvcnR6b25lO1xuICAgICAgICBpZiAodHMpIHtcbiAgICAgICAgICBKc1RvbVNlbGVjdC5hcHBseVRvKHRoaXMuaW1wb3J0em9uZSk7XG4gICAgICAgICAgdHMgPSB0aGlzLmltcG9ydHpvbmUudG9tc2VsZWN0O1xuICAgICAgICB9XG4gICAgICAgIGlmICh0cykge1xuICAgICAgICAgIHRzLm9uKFwiaXRlbV9yZW1vdmVcIiwgKHZhbHVlLCBpdGVtKSA9PiB7XG4gICAgICAgICAgICB0aGlzLml0ZW1SZW1vdmUodmFsdWUsIGl0ZW0pO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuYWN0aXZhdGVDbGVhcigpO1xuICAgICAgfVxuXG4gICAgfVxuXG4gIH1cbiAgY2xvbmVJbXBvcnQoYnRuKSB7XG4gICAgY29uc3QgaW1wb3J0X3RhcmdldCA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCcjJyArIHRoaXMuaW1wb3J0em9uZS5kYXRhc2V0Lm9yaWdpbik7XG4gICAgaWYgKCFpbXBvcnRfdGFyZ2V0KSByZXR1cm4gZmFsc2U7XG4gICAgY29uc3QgdHMgPSBpbXBvcnRfdGFyZ2V0LnRvbXNlbGVjdDtcbiAgICBpZiAodHMpIHtcblxuICAgICAgLy8gb25seSBpZiByZXBsYWNlIHNwZWNpZmllZFxuICAgICAgaWYgKGJ0bi5kYXRhc2V0LnJlcGxhY2UgJiYgYnRuLmRhdGFzZXQucmVwbGFjZSA9PT0gJ3JlcGxhY2UnKSB7XG4gICAgICAgIHRzLmNsZWFyKCk7XG4gICAgICAgIHRzLmNsZWFyT3B0aW9ucygpO1xuICAgICAgfVxuICAgICAgY29uc3QgdHpvbmUgPSB0aGlzLmltcG9ydHpvbmUudG9tc2VsZWN0O1xuICAgICAgY29uc3QgaXRlbXMgPSBbLi4udHpvbmUuaXRlbXNdO1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIHR6b25lLm9wdGlvbnMpO1xuICAgICAgaXRlbXMuZm9yRWFjaCgoZSkgPT4ge1xuICAgICAgICBsZXQgZWwgPSB7fTtcbiAgICAgICAgZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0gPSBlO1xuICAgICAgICBlbFt0cy5zZXR0aW5ncy5sYWJlbEZpZWxkXSA9IHVuZXNjYXBlX2h0bWwob3B0aW9uc1tlXVt0cy5zZXR0aW5ncy5sYWJlbEZpZWxkXSk7XG4gICAgICAgIGVsW3RzLnNldHRpbmdzLnNlYXJjaEZpZWxkXSA9IHVuZXNjYXBlX2h0bWwob3B0aW9uc1tlXVt0cy5zZXR0aW5ncy5sYWJlbEZpZWxkXSk7XG4gICAgICAgIGlmICh0cy5nZXRPcHRpb24oZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0pID09PSBudWxsKSB0cy5hZGRPcHRpb24oZWwpO1xuICAgICAgICBpZiAodHMuZ2V0SXRlbShlbFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSkgPT09IG51bGwpIHRzLmFkZEl0ZW0oZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0pO1xuICAgICAgfSk7XG4gICAgICAvLyAgdHpvbmUuY2xlYXJPcHRpb25zKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChidG4uZGF0YXNldC5yZXBsYWNlICYmIGJ0bi5kYXRhc2V0LnJlcGxhY2UgPT09ICdyZXBsYWNlJykgaW1wb3J0X3RhcmdldC5pbm5lckhUTUwgPSBgYDtcbiAgICAgIGltcG9ydF90YXJnZXQuaW5uZXJIVE1MID0gRE9NUHVyaWZ5LnNhbml0aXplKHRoaXMuaW1wb3J0em9uZS5pbm5lckhUTUwpO1xuICAgICAgdGhpcy5pbXBvcnR6b25lLmlubmVySFRNTCA9IGBgO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGFzeW5jIG1ha2VJbXBvcnQoYnRuLCBzZWxlY3RjZWxscywgd2hhdCwgY2xvc2UgPSBmYWxzZSkge1xuICAgIGxldCBkb25lID0gdHJ1ZSxcbiAgICAgIHRzID0gbnVsbDtcblxuICAgIHN3aXRjaCAod2hhdCkge1xuICAgICAgY2FzZSB0eXBlaW1wb3J0LnRheG86XG4gICAgICAgIGlmICghdGhpcy5pbXBvcnR6b25lKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGRvbmUgPSB0aGlzLmNsb25lSW1wb3J0KGJ0bik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSB0eXBlaW1wb3J0LnByaXZpbGVnZXM6XG4gICAgICAgIGlmICghdGhpcy5pbXBvcnR6b25lKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGRvbmUgPSB0aGlzLnJlbmRlclByaXZpbGVnZXMoKGJ0bi5kYXRhc2V0LnJlcGxhY2UgJiYgYnRuLmRhdGFzZXQucmVwbGFjZSA9PT0gJ3JlcGxhY2UnKSk7XG4gICAgICAgIGlmICh0aGlzLmltcG9ydHpvbmUuY3VycmVudGxpc3QpIHRoaXMuaW1wb3J0em9uZS5jdXJyZW50bGlzdCA9IHt9O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgdHlwZWltcG9ydC5wcm9qZWN0OlxuICAgICAgICBpZiAoIXRoaXMuaW1wb3J0em9uZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBjb25zdCBuZXdvbmUgPSAodGhpcy5mb3JtLmRhdGFzZXQuaWQpID8gcGFyc2VJbnQodGhpcy5mb3JtLmRhdGFzZXQuaWQpIDogMDtcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IHRoaXMuY29tcGlsZVByb2plY3RSZWNvcmRzKG5ld29uZSk7XG4gICAgICAgIGRvbmUgPSB0aGlzLmNsb25lSW1wb3J0KGJ0bik7XG4gICAgICAgIGNvbnN0IGlkeCA9IHNlbGVjdGNlbGxzLmluZGV4T2YobW9kZWxzLnByb2ppZCk7XG4gICAgICAgIGlmIChpZHggPj0gMCkgc2VsZWN0Y2VsbHMuc3BsaWNlKGlkeCwgMSk7XG4gICAgICAgIFtcImNyZWF0b3JfdXNlcnNcIiwgXCJjcmVhdG9yX29yZ2FuaXNhdGlvbnNcIiwgXCJjbGFzc2lmZmllbGRsaXN0XCIsIFwicHJpdmlsZWdlc1wiLCBcImFjY2Vzc1wiLCBcInN0YXR1c1wiLCBcImNubl9uZXR3b3JrX2lkXCJdLmZvckVhY2gocmVzdWx0ID0+IHtcbiAgICAgICAgICB0aGlzLmltcG9ydHNbcmVzdWx0XSA9IHJlc3VsdHNbcmVzdWx0XTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuaW1wb3J0c1tcImluaXRfY2xhc3NpZl9saXN0XCJdID0gcmVzdWx0cy5pbml0Y2xhc3NpZmxpc3Q7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb25zdCB0c19hZGRfc2VsZWN0X2l0ZW0gPSBmdW5jdGlvbih0cywgZGF0YSkge1xuICAgICAgICAgIGNvbnN0IGVsID0ge307XG4gICAgICAgICAgaWYgKHR5cGVvZihkYXRhKSA9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSB1bmVzY2FwZV9odG1sKGRhdGEpO1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0gPSB1bmVzY2FwZV9odG1sKGRhdGEpO1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3Muc2VhcmNoRmllbGRdID0gdW5lc2NhcGVfaHRtbChkYXRhKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MubGFiZWxGaWVsZF0gPSB1bmVzY2FwZV9odG1sKGRhdGEudmFsdWUpO1xuICAgICAgICAgICAgZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0gPSBkYXRhLmtleTtcbiAgICAgICAgICAgIGVsW3RzLnNldHRpbmdzLnNlYXJjaEZpZWxkXSA9IHVuZXNjYXBlX2h0bWwoZGF0YS52YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh0cy5nZXRPcHRpb24oZWxbdHMuc2V0dGluZ3MudmFsdWVGaWVsZF0pID09PSBudWxsKSB0cy5hZGRPcHRpb24oZWwpO1xuICAgICAgICAgIGlmICh0cy5nZXRJdGVtKGVsW3RzLnNldHRpbmdzLnZhbHVlRmllbGRdKSA9PT0gbnVsbCkgdHMuYWRkSXRlbShlbFt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYWRkX3NlbGVjdF9vcHRpb24gPSBmdW5jdGlvbihpbnB1dCwgZGF0YSkge1xuICAgICAgICAgIGxldCBhdHRyID0ge1xuICAgICAgICAgICAgc2VsZWN0ZWQ6IHRydWVcbiAgICAgICAgICB9O1xuICAgICAgICAgIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSBhdHRyLnZhbHVlID0gYXR0ci50ZXh0ID0gZGF0YTtcbiAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGF0dHIudmFsdWUgPSBkYXRhLmtleTtcbiAgICAgICAgICAgIGF0dHIudGV4dCA9IGRhdGEudmFsdWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IGNyZWF0ZV9ib3goJ29wdGlvbicsIGF0dHIsIGlucHV0KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBhZGRfaW5wdXRfb3B0aW9uID0gZnVuY3Rpb24oaW5wdXQsIGRhdGEpIHtcbiAgICAgICAgICBpZiAoaW5wdXQubXVsdGlwbGUpIHtcbiAgICAgICAgICAgIGxldCB2YWx1ZXMgPSBpbnB1dC52YWx1ZS5zcGxpdCgnLCcpO1xuICAgICAgICAgICAgdmFsdWVzLnB1c2goZGF0YS5rZXkpO1xuICAgICAgICAgICAgaW5wdXQudmFsdWUgPSB2YWx1ZXMuam9pbignLCcpO1xuICAgICAgICAgIH0gZWxzZSBpbnB1dC52YWx1ZSA9IGRhdGE7XG5cbiAgICAgICAgfVxuICAgICAgICBzZWxlY3RjZWxscy5mb3JFYWNoKChuYW1lLCBpbmRleCkgPT4ge1xuICAgICAgICAgIGxldCBpbnB1dCA9ICgodGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWltcG9ydGZpZWxkPVwiJyArIG5hbWUgKyAnXCJdJykpID8gdGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoJ1tkYXRhLWltcG9ydGZpZWxkPVwiJyArIG5hbWUgKyAnXCJdJykgOiB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvcignW25hbWU9XCInICsgbmFtZSArICdcIl0nKSk7XG4gICAgICAgICAgaWYgKGlucHV0ICYmIGlucHV0LmRhdGFzZXQubm9pbXBvcnQpIHJldHVybjtcbiAgICAgICAgICBpZiAoaW5wdXQgJiYgdGhpcy5pbXBvcnRzW25hbWVdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSAoaW5wdXQudHlwZSkgPyBpbnB1dC50eXBlIDogaW5wdXQudGFnTmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgdHMgPSBpbnB1dC50b21zZWxlY3Q7XG4gICAgICAgICAgICBpZiAoWydpbml0X2NsYXNzaWZfbGlzdCddLmluZGV4T2YobmFtZSkgPj0gMCkge1xuICAgICAgICAgICAgICBsZXQgaWRzID0gdGhpcy5pbXBvcnRzW25hbWVdO1xuICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShpZHMpKSBpZHMgPSBpZHMuam9pbignLCcpO1xuICAgICAgICAgICAgICBlbHNlIGlkcyA9IGlkcy5yZXBsYWNlKCdbJywgJycpLnJlcGxhY2UoJ10nLCAnJykucmVwbGFjZUFsbCgnICcsICcnKTtcbiAgICAgICAgICAgICAgaWYgKGlkcyAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICBpZiAodHMpIHRzLndyYXBwZXIuY2xhc3NMaXN0LmFkZCgnd2FpdC1mb3ItcmVzdWx0cycpO1xuICAgICAgICAgICAgICAgIGxldCBvcHRzID0gZmV0Y2hTZXR0aW5ncygpLFxuICAgICAgICAgICAgICAgICAgdXJsID0gJyc7XG4gICAgICAgICAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2lkbGlzdCcsIGlkcyk7XG4gICAgICAgICAgICAgICAgdXJsID0gJy9zZWFyY2gvdGF4b3Jlc29sdmUnIC8vKyBuZXcgVVJMU2VhcmNoUGFyYW1zKHsnaWRsaXN0JzogaWRzfSk7XG4gICAgICAgICAgICAgICAgb3B0cyA9IGZldGNoU2V0dGluZ3Moe1xuICAgICAgICAgICAgICAgICAgJ21ldGhvZCc6ICdQT1NUJyxcbiAgICAgICAgICAgICAgICAgICdib2R5JzogZm9ybURhdGFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBmZXRjaCh1cmwsIG9wdHMpLnRoZW4ocmVzcG9uc2UgPT5cbiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmpzb24oKVxuICAgICAgICAgICAgICAgICkudGhlbihyZXN1bHRzID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHRzID0gaW5wdXQudG9tc2VsZWN0O1xuICAgICAgICAgICAgICAgICAgaWYgKHRzKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdHMgPSBPYmplY3QuZW50cmllcyhyZXN1bHRzKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5mb3JFYWNoKChba2V5LCB0ZXh0XSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBET01QdXJpZnkuc2FuaXRpemUoa2V5KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBET01QdXJpZnkuc2FuaXRpemUodGV4dClcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgdHNfYWRkX3NlbGVjdF9pdGVtKHRzLCBlbCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB0cy53cmFwcGVyLmNsYXNzTGlzdC5yZW1vdmUoJ3dhaXQtZm9yLXJlc3VsdHMnKTtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS5pbmRleE9mKCdzZWxlY3QnKSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBpbnB1dC5xdWVyeVNlbGVjdG9yQWxsKCdvcHRpb24nKS5mb3JFYWNoKG9wdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgb3B0aW9uLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmVudHJpZXMocmVzdWx0cykuZm9yRWFjaCgoW2tleSwgdGV4dF0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleTogRE9NUHVyaWZ5LnNhbml0aXplKGtleSksXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogRE9NUHVyaWZ5LnNhbml0aXplKHRleHQpXG4gICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIGFkZF9pbnB1dF9vcHRpb24oaW5wdXQsIGVsKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIE9iamVjdC5lbnRyaWVzKHJlc3VsdHMpLmZvckVhY2goKFtrZXksIHRleHRdKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWwgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBrZXk6IERPTVB1cmlmeS5zYW5pdGl6ZShrZXkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IERPTVB1cmlmeS5zYW5pdGl6ZSh0ZXh0KVxuICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICBhZGRfc2VsZWN0X29wdGlvbihpbnB1dCwgZWwpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHJlc3VsdHMgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgdGhpcy5zZXRJbXBvcnRlZFRhZyhpbnB1dCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHMpIHtcbiAgICAgICAgICAgICAgaWYgKGlucHV0Lm11bHRpcGxlKSB0aGlzLmltcG9ydHNbbmFtZV0uZm9yRWFjaChkYXRhID0+IHtcbiAgICAgICAgICAgICAgICB0c19hZGRfc2VsZWN0X2l0ZW0odHMsIGRhdGEpXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBlbHNlIHRzX2FkZF9zZWxlY3RfaXRlbSh0cywgdGhpcy5pbXBvcnRzW25hbWVdKTtcbiAgICAgICAgICAgICAgdGhpcy5zZXRJbXBvcnRlZFRhZyhpbnB1dCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdyYWRpbyc6XG4gICAgICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnOlxuICAgICAgICAgICAgICAgICAgY29uc3QgdG9jaGVjayA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yKCdbbmFtZT1cIicgKyBuYW1lICsgJ1wiXVt2YWx1ZT1cIicgKyB0aGlzLmltcG9ydHNbbmFtZV0gKyAnXCJdJyk7XG4gICAgICAgICAgICAgICAgICBpZiAodG9jaGVjaykgdG9jaGVjay5jaGVja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ3NlbGVjdC1tdWx0aXBsZSc6XG4gICAgICAgICAgICAgICAgY2FzZSAnc2VsZWN0JzpcbiAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC5tdWx0aXBsZSkgdGhpcy5pbXBvcnRzW25hbWVdLmZvckVhY2goZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGFkZF9zZWxlY3Rfb3B0aW9uKGlucHV0LCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgZWxzZSBhZGRfc2VsZWN0X29wdGlvbihpbnB1dCwgdGhpcy5pbXBvcnRzW25hbWVdKTtcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IHRoaXMuaW1wb3J0c1tuYW1lXTtcbiAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHRoaXMuc2V0SW1wb3J0ZWRUYWcoaW5wdXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHdoYXQgIT09IHR5cGVpbXBvcnQuc2V0dGluZ3MpIGlucHV0LmZvY3VzKCk7XG4gICAgICAgICAgICBkb25lID0gZG9uZSAmJiB0cnVlO1xuXG5cbiAgICAgICAgICB9IGVsc2UgaWYgKG5hbWUgPT09IHR5cGVpbXBvcnQucHJpdmlsZWdlcykge1xuICAgICAgICAgICAgLy9jb25zdCBjbGVhcnByaXZpbGVnZXMgPSAod2hhdCA9PT0gdHlwZWltcG9ydC5zZXR0aW5ncyk7XG4gICAgICAgICAgICBjb25zdCBjbGVhcnByaXZpbGVnZXMgPSBmYWxzZTtcbiAgICAgICAgICAgIGRvbmUgPSBkb25lICYmIHRoaXMuaW1wb3J0UHJpdmlsZWdlcyh0aGlzLmltcG9ydHNbbmFtZV0sIGNsZWFycHJpdmlsZWdlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGlmIChkb25lID09PSB0cnVlICYmIGNsb3NlID09IHRydWUpIHtcbiAgICAgIHRoaXMuZGlzbWlzcygpO1xuICAgICAgaWYgKHRoaXMuZm9ybSkgdGhpcy5mb3JtLmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCd2YWxpZGF0ZScpKTtcbiAgICB9XG4gIH1cblxuICBzZXRJbXBvcnRlZFRhZyhpbnB1dCwgc2VsZWN0b3IgPSBkb21zZWxlY3RvcnMuY29tcG9uZW50LmZvcm0uZm9ybWJveCkge1xuICAgIGlmIChpbnB1dCA9PT0gbnVsbCkgcmV0dXJuO1xuICAgIGxldCBlbCA9IChzZWxlY3RvciA9PT0gbnVsbCkgPyBpbnB1dCA6ICgoaW5wdXQuY2xvc2VzdChzZWxlY3RvcikpID8gaW5wdXQuY2xvc2VzdChzZWxlY3RvcikgOiBpbnB1dC5jbG9zZXN0KCdmaWVsZHNldCcpKTtcbiAgICBpZiAoIWVsKSByZXR1cm47XG4gICAgY29uc3QgcmVtb3ZldGFnID0gKGUpID0+IHtcbiAgICAgIGRlbGV0ZSBlbC5kYXRhc2V0LmlzaW1wb3J0ZWQ7XG4gICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKGNzcy5pbXBvcnRlZCk7XG4gICAgICBpbnB1dC5yZW1vdmVFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCByZW1vdmV0YWcpO1xuICAgIH1cbiAgICBlbC5kYXRhc2V0LmlzaW1wb3J0ZWQgPSB0aGlzLmZvcm0uZGF0YXNldC5pc2ltcG9ydGVkO1xuICAgIGVsLmNsYXNzTGlzdC5hZGQoY3NzLmltcG9ydGVkKTtcbiAgICBpZiAoaW5wdXQuZGF0YXNldC51bmlxdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaW5wdXQuZGF0YXNldC51bmlxdWUgPSBpbnB1dC52YWx1ZTtcbiAgICB9XG4gICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHJlbW92ZXRhZyk7XG4gICAgfSwgNTAwKTtcbiAgfVxuXG4gIGRpc21pc3MoY2xlYXIgPSBmYWxzZSkge1xuICAgIGlmICh0aGlzLmJ1dHRvbikgdGhpcy5zaG93SW1wb3J0KGZhbHNlKTtcbiAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLmRvbS5jbG9zZXN0KCdkZXRhaWxzJyk7XG4gICAgaWYgKGNvbnRhaW5lcikge1xuICAgICAgY29udGFpbmVyLm9wZW4gPSBmYWxzZTtcbiAgICAgIGlmIChjbGVhciA9PT0gdHJ1ZSkgY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IodGhpcy5jb250ZW50X3NlbGVjdG9yKS5pbm5lckhUTUwgPSBgYDtcbiAgICB9XG5cbiAgfVxuICBpbmRleFRvQ2hlY2soKSB7XG4gICAgLy8gaW5kZXggb2YgY2VsbHMgdG8gY2hlY2sgaWYgZW1wdHkgYW5kIGRpc2FibGUgcm93ICBpbXBvcnQgYnRuXG4gICAgY29uc3QgZ3JpZCA9ICh0aGlzLnRibCkgPyB0aGlzLnRibC5ncmlkIDogbnVsbDtcbiAgICBpZiAoIWdyaWQpIHJldHVybiBbMF07XG4gICAgbGV0IGluZGV4ID0gZ3JpZC5jb2x1bW5zLmZpbmRJbmRleChjb2x1bW4gPT4gKGNvbHVtbi53aGF0ICYmIGNvbHVtbi53aGF0ID09PSB0eXBlaW1wb3J0LnRheG8pKTtcbiAgICBpZiAoaW5kZXggPT09IC0xKSByZXR1cm4gWzBdO1xuICAgIGNvbnN0IHBhcnRzID0gKGdyaWQuY29sdW1uc1tpbmRleF0ucGFydHMpID8gZ3JpZC5jb2x1bW5zW2luZGV4XS5wYXJ0cyA6IG51bGw7XG4gICAgaWYgKHBhcnRzKSB7XG4gICAgICBjb25zdCBpbmRleHRvY2hlY2sgPSBncmlkLmNvbHVtbnMuZmlsdGVyKChjb2x1bW4sIGkpID0+IHtcbiAgICAgICAgaWYgKHBhcnRzLmluZGV4T2YoY29sdW1uLm5hbWUpID49IDApIHJldHVybiBpO1xuICAgICAgfSkubWFwKHYgPT4ge1xuICAgICAgICByZXR1cm4gdi5pbmRleDtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGluZGV4dG9jaGVjaztcbiAgICB9XG5cbiAgfVxuICBhZGRSZXNldEJ1dHRvbigpIHtcbiAgICBpZiAoIXRoaXMudGJsIHx8ICF0aGlzLnRibC5wYXJhbXMuaGFzT3duUHJvcGVydHkoXCJyZXNldFwiKSkgcmV0dXJuO1xuICAgIGxldCByZXNldGJ0biA9IHRoaXMuZG9tLnBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3Rvcihkb21zZWxlY3RvcnMucmVzZXRidXR0b24pO1xuICAgIGlmIChyZXNldGJ0biA9PT0gbnVsbCkge1xuICAgICAgcmVzZXRidG4gPSBjcmVhdGVfYm94KCdhJywge1xuICAgICAgICBjbGFzczogZG9tc2VsZWN0b3JzLnJlc2V0YnV0dG9uLnN1YnN0cigxKSxcbiAgICAgICAgdGV4dDogdGhpcy50YmwucGFyYW1zLnJlc2V0XG4gICAgICB9LCB0aGlzLmRvbS5wYXJlbnRFbGVtZW50LmZpcnN0Q2hpbGQpO1xuICAgIH1cbiAgICByZXNldGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgICAgdGhpcy5yZXNldFNlbGVjdG9ycygpO1xuICAgICAgdGhpcy5yZXNldEltcG9ydHMoKTtcbiAgICB9KTtcblxuICB9XG4gIC8vIHNob3cgLyBoaWRlIGltcG9ydHpvbmUgYW5kIGJ1dHRvbnNcbiAgc2hvd0ltcG9ydChzaG93KSB7XG4gICAgaWYgKCF0aGlzLmJ1dHRvbikgcmV0dXJuO1xuICAgIGlmIChzaG93ID09PSBmYWxzZSkge1xuICAgICAgdGhpcy5idXR0b24uY2xhc3NMaXN0LmFkZChjc3MuaGlkZSk7XG4gICAgICB0aGlzLnJlcGxhY2VidXR0b24uY2xhc3NMaXN0LmFkZChjc3MuaGlkZSk7XG4gICAgICB0aGlzLmltcG9ydGNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKGNzcy5oaWRlKTtcbiAgICAgIGlmICh0aGlzLnRhYmJ1dHRvbikgdGhpcy50YWJidXR0b24uY2xhc3NMaXN0LmFkZChjc3MuaGlkZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLmltcG9ydHpvbmUpIHtcbiAgICAgICAgdGhpcy5idXR0b24uY2xhc3NMaXN0LnJlbW92ZShjc3MuaGlkZSk7XG4gICAgICAgIHRoaXMucmVwbGFjZWJ1dHRvbi5jbGFzc0xpc3QucmVtb3ZlKGNzcy5oaWRlKTtcbiAgICAgICAgdGhpcy5pbXBvcnRjb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZShjc3MuaGlkZSk7XG4gICAgICAgIHRoaXMuYnV0dG9uLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgIGlmICh0aGlzLnRhYmJ1dHRvbikge1xuICAgICAgICAgIHRoaXMudGFiYnV0dG9uLmNsYXNzTGlzdC5yZW1vdmUoY3NzLmhpZGUpO1xuICAgICAgICAgIGlmICh0aGlzLmltcG9ydHpvbmUudG9tc2VsZWN0KSB7XG4gICAgICAgICAgICB0aGlzLnRhYmJ1dHRvbi5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICAgIH0gZWxzZSB0aGlzLnRhYmJ1dHRvbi5kaXNhYmxlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgfVxuICAvLyByZXNpemUgaW1wb3J0em9uZVxuICByZXNpemVab25lKGUpIHtcbiAgICBjb25zdCBkaXYgPSB0aGlzLmltcG9ydGNvbnRhaW5lci5jbG9zZXN0KGRvbXNlbGVjdG9ycy5jb21wb25lbnQuaW1wb3J0LnpvbmVpbXBvcnQpO1xuICAgIGlmICghZGl2KSByZXR1cm47XG4gICAgZGl2LnBhcmVudEVsZW1lbnQuY2xhc3NMaXN0LnRvZ2dsZShjc3Muc2hvd2Z1bGwpO1xuICAgIGNvbnN0IGljb24gPSBlLmN1cnJlbnRUYXJnZXQucXVlcnlTZWxlY3RvcignaScpO1xuICAgIGlmIChpY29uKSB7XG4gICAgICBpY29uLmNsYXNzTGlzdC50b2dnbGUoY3NzLmFycm93b3V0KTtcbiAgICAgIGljb24uY2xhc3NMaXN0LnRvZ2dsZShjc3MuYXJyb3dpbik7XG4gICAgfVxuICB9XG59Il0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///./src/modules/data-import.js\n")}}]);