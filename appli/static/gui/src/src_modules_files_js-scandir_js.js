/*! For license information please see src_modules_files_js-scandir_js.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["src_modules_files_js-scandir_js"],{"./src/modules/files/js-scandir.js":(module,__webpack_exports__,__webpack_require__)=>{eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   JsScanDir: () => (/* binding */ JsScanDir)\n/* harmony export */ });\n/* harmony import */ var _modules_module_event_emitter_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../modules/module-event-emitter.js */ \"./src/modules/module-event-emitter.js\");\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([_modules_module_event_emitter_js__WEBPACK_IMPORTED_MODULE_0__]);\n_modules_module_event_emitter_js__WEBPACK_IMPORTED_MODULE_0__ = (__webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__)[0];\n\nlet instance = null;\n\nfunction JsScanDir(process_file = null) {\n  const eventnames = {\n    complete: 'scan.complete',\n    processed: 'scan.processed',\n    error: 'scan.error',\n  }\n  let nextaction;\n  _modules_module_event_emitter_js__WEBPACK_IMPORTED_MODULE_0__.ModuleEventEmitter.on(eventnames.error, (e) => {\n    console.log('scandir receive error message', e)\n  });\n  _modules_module_event_emitter_js__WEBPACK_IMPORTED_MODULE_0__.ModuleEventEmitter.on(eventnames.processed, async (e) => {\n    console.log('e', e)\n  });\n\n  async function processFile(entry, callback = null) {\n    if (process_file) process_file(entry, callback);\n    else if (callback) await callback();\n  }\n\n  function stopOnError(err) {\n    console.log('err', err);\n  }\n\n  function fileType(data) {\n    const mime_type = (signature) => {\n      switch (signature) {\n        case '89504E47':\n          return 'image/png';\n        case '47494638':\n          return 'image/gif';\n        case '25504446':\n          return 'application/pdf';\n        case 'FFD8FFDB':\n        case 'FFD8FFE0':\n        case 'FFD8FFE1':\n          return 'image/jpeg';\n        case '504B0304':\n          return 'application/zip';\n        case 'EFBBBF22':\n          return 'text/tsv'; //'text/tab-separated-values';\n        default:\n          console.log('unknownsign', signature)\n          return 'unknown';\n      }\n    }\n    const uint = new Uint8Array(data);\n    let bytes = []\n    for (let i = 0; i < 4; i++) {\n      bytes.push(uint[i].toString(16))\n    }\n    data = bytes.join('').toUpperCase();\n    return {\n      input: uint,\n      mimetype: mime_type(data)\n    };\n  }\n\n\n  async function readDirectory(dir, oncomplete) {\n    let errored = false;\n    let direntries = [];\n    const on_error = onerror ? onerror : (err) => {\n      console.log('on_error', err)\n      if (!errored) {\n        errored = true;\n      }\n    };\n    const reader = dir.createReader();\n    const on_read = async function(ents) {\n      if (ents.length && !errored) {\n        direntries = [...direntries, ...ents];\n        await reader.readEntries(on_read, on_error);\n      } else if (!errored) {\n        const complete = async function() {\n          if (oncomplete && direntries.length === 0) {\n            oncomplete();\n          } else {\n            const entry = direntries.shift();\n            if (entry.isDirectory) await readDirectory(entry, complete);\n            else await processFile(entry, complete);\n          }\n        }\n        await complete();\n      } else {\n        console.log('treat error readdir');\n      }\n    }\n    await reader.readEntries(on_read, on_error);\n  }\n\n  async function processEntries(entries, path, oncomplete) {\n    // showDirectoryPicker\n    const complete = async () => {\n      if (entries.length) {\n        const entry = await entries.shift();\n        const nestedpath = `${path}/${entry.name}`;\n        const kind = (entry.kind) ? entry.kind : (entry instanceof File) ? \"file\" : \"directory\";\n        if (kind === \"file\") {\n          if (!entry.webkitRelativePath) Object.defineProperty(entry, \"webkitRelativePath\", {\n            configurable: true,\n            enumerable: true,\n            get: () => nestedpath,\n          });\n          if (entry instanceof File) entry.file = async (func) => {\n            await func(entry, nestedpath);\n          }\n          else entry.file = async (func) => {\n            entry.getFile().then(async file => {\n              await func(file, nestedpath);\n            });\n          }\n          await processFile(entry, complete);\n        } else if (kind === \"directory\") {\n          const direntries = await Array.fromAsync(entry.values());\n          await processEntries(direntries, nestedpath, complete);\n        }\n      } else if (oncomplete) oncomplete();\n    }\n    await complete();\n  }\n  return {\n    eventnames,\n    processFile,\n    processEntries,\n    readDirectory\n  }\n}\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiLi9zcmMvbW9kdWxlcy9maWxlcy9qcy1zY2FuZGlyLmpzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBRStDO0FBQy9DOztBQUVPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsRUFBRSxnRkFBa0I7QUFDcEI7QUFDQSxHQUFHO0FBQ0gsRUFBRSxnRkFBa0I7QUFDcEI7QUFDQSxHQUFHOztBQUVIO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDZCQUE2QjtBQUM3QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG9CQUFvQixPQUFPO0FBQzNCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQUdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxRQUFRO0FBQ1I7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQVE7QUFDUjtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4QkFBOEIsS0FBSyxHQUFHLFdBQVc7QUFDakQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsV0FBVztBQUNYO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBLFFBQVE7QUFDUjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxDIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vLy4vc3JjL21vZHVsZXMvZmlsZXMvanMtc2NhbmRpci5qcz85MjI2Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIE1vZHVsZUV2ZW50RW1pdHRlclxufSBmcm9tICcuLi8uLi9tb2R1bGVzL21vZHVsZS1ldmVudC1lbWl0dGVyLmpzJztcbmxldCBpbnN0YW5jZSA9IG51bGw7XG5cbmV4cG9ydCBmdW5jdGlvbiBKc1NjYW5EaXIocHJvY2Vzc19maWxlID0gbnVsbCkge1xuICBjb25zdCBldmVudG5hbWVzID0ge1xuICAgIGNvbXBsZXRlOiAnc2Nhbi5jb21wbGV0ZScsXG4gICAgcHJvY2Vzc2VkOiAnc2Nhbi5wcm9jZXNzZWQnLFxuICAgIGVycm9yOiAnc2Nhbi5lcnJvcicsXG4gIH1cbiAgbGV0IG5leHRhY3Rpb247XG4gIE1vZHVsZUV2ZW50RW1pdHRlci5vbihldmVudG5hbWVzLmVycm9yLCAoZSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdzY2FuZGlyIHJlY2VpdmUgZXJyb3IgbWVzc2FnZScsIGUpXG4gIH0pO1xuICBNb2R1bGVFdmVudEVtaXR0ZXIub24oZXZlbnRuYW1lcy5wcm9jZXNzZWQsIGFzeW5jIChlKSA9PiB7XG4gICAgY29uc29sZS5sb2coJ2UnLCBlKVxuICB9KTtcblxuICBhc3luYyBmdW5jdGlvbiBwcm9jZXNzRmlsZShlbnRyeSwgY2FsbGJhY2sgPSBudWxsKSB7XG4gICAgaWYgKHByb2Nlc3NfZmlsZSkgcHJvY2Vzc19maWxlKGVudHJ5LCBjYWxsYmFjayk7XG4gICAgZWxzZSBpZiAoY2FsbGJhY2spIGF3YWl0IGNhbGxiYWNrKCk7XG4gIH1cblxuICBmdW5jdGlvbiBzdG9wT25FcnJvcihlcnIpIHtcbiAgICBjb25zb2xlLmxvZygnZXJyJywgZXJyKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGZpbGVUeXBlKGRhdGEpIHtcbiAgICBjb25zdCBtaW1lX3R5cGUgPSAoc2lnbmF0dXJlKSA9PiB7XG4gICAgICBzd2l0Y2ggKHNpZ25hdHVyZSkge1xuICAgICAgICBjYXNlICc4OTUwNEU0Nyc6XG4gICAgICAgICAgcmV0dXJuICdpbWFnZS9wbmcnO1xuICAgICAgICBjYXNlICc0NzQ5NDYzOCc6XG4gICAgICAgICAgcmV0dXJuICdpbWFnZS9naWYnO1xuICAgICAgICBjYXNlICcyNTUwNDQ0Nic6XG4gICAgICAgICAgcmV0dXJuICdhcHBsaWNhdGlvbi9wZGYnO1xuICAgICAgICBjYXNlICdGRkQ4RkZEQic6XG4gICAgICAgIGNhc2UgJ0ZGRDhGRkUwJzpcbiAgICAgICAgY2FzZSAnRkZEOEZGRTEnOlxuICAgICAgICAgIHJldHVybiAnaW1hZ2UvanBlZyc7XG4gICAgICAgIGNhc2UgJzUwNEIwMzA0JzpcbiAgICAgICAgICByZXR1cm4gJ2FwcGxpY2F0aW9uL3ppcCc7XG4gICAgICAgIGNhc2UgJ0VGQkJCRjIyJzpcbiAgICAgICAgICByZXR1cm4gJ3RleHQvdHN2JzsgLy8ndGV4dC90YWItc2VwYXJhdGVkLXZhbHVlcyc7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgY29uc29sZS5sb2coJ3Vua25vd25zaWduJywgc2lnbmF0dXJlKVxuICAgICAgICAgIHJldHVybiAndW5rbm93bic7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHVpbnQgPSBuZXcgVWludDhBcnJheShkYXRhKTtcbiAgICBsZXQgYnl0ZXMgPSBbXVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgICBieXRlcy5wdXNoKHVpbnRbaV0udG9TdHJpbmcoMTYpKVxuICAgIH1cbiAgICBkYXRhID0gYnl0ZXMuam9pbignJykudG9VcHBlckNhc2UoKTtcbiAgICByZXR1cm4ge1xuICAgICAgaW5wdXQ6IHVpbnQsXG4gICAgICBtaW1ldHlwZTogbWltZV90eXBlKGRhdGEpXG4gICAgfTtcbiAgfVxuXG5cbiAgYXN5bmMgZnVuY3Rpb24gcmVhZERpcmVjdG9yeShkaXIsIG9uY29tcGxldGUpIHtcbiAgICBsZXQgZXJyb3JlZCA9IGZhbHNlO1xuICAgIGxldCBkaXJlbnRyaWVzID0gW107XG4gICAgY29uc3Qgb25fZXJyb3IgPSBvbmVycm9yID8gb25lcnJvciA6IChlcnIpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdvbl9lcnJvcicsIGVycilcbiAgICAgIGlmICghZXJyb3JlZCkge1xuICAgICAgICBlcnJvcmVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IHJlYWRlciA9IGRpci5jcmVhdGVSZWFkZXIoKTtcbiAgICBjb25zdCBvbl9yZWFkID0gYXN5bmMgZnVuY3Rpb24oZW50cykge1xuICAgICAgaWYgKGVudHMubGVuZ3RoICYmICFlcnJvcmVkKSB7XG4gICAgICAgIGRpcmVudHJpZXMgPSBbLi4uZGlyZW50cmllcywgLi4uZW50c107XG4gICAgICAgIGF3YWl0IHJlYWRlci5yZWFkRW50cmllcyhvbl9yZWFkLCBvbl9lcnJvcik7XG4gICAgICB9IGVsc2UgaWYgKCFlcnJvcmVkKSB7XG4gICAgICAgIGNvbnN0IGNvbXBsZXRlID0gYXN5bmMgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgaWYgKG9uY29tcGxldGUgJiYgZGlyZW50cmllcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIG9uY29tcGxldGUoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgZW50cnkgPSBkaXJlbnRyaWVzLnNoaWZ0KCk7XG4gICAgICAgICAgICBpZiAoZW50cnkuaXNEaXJlY3RvcnkpIGF3YWl0IHJlYWREaXJlY3RvcnkoZW50cnksIGNvbXBsZXRlKTtcbiAgICAgICAgICAgIGVsc2UgYXdhaXQgcHJvY2Vzc0ZpbGUoZW50cnksIGNvbXBsZXRlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgY29tcGxldGUoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCd0cmVhdCBlcnJvciByZWFkZGlyJyk7XG4gICAgICB9XG4gICAgfVxuICAgIGF3YWl0IHJlYWRlci5yZWFkRW50cmllcyhvbl9yZWFkLCBvbl9lcnJvcik7XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBwcm9jZXNzRW50cmllcyhlbnRyaWVzLCBwYXRoLCBvbmNvbXBsZXRlKSB7XG4gICAgLy8gc2hvd0RpcmVjdG9yeVBpY2tlclxuICAgIGNvbnN0IGNvbXBsZXRlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgaWYgKGVudHJpZXMubGVuZ3RoKSB7XG4gICAgICAgIGNvbnN0IGVudHJ5ID0gYXdhaXQgZW50cmllcy5zaGlmdCgpO1xuICAgICAgICBjb25zdCBuZXN0ZWRwYXRoID0gYCR7cGF0aH0vJHtlbnRyeS5uYW1lfWA7XG4gICAgICAgIGNvbnN0IGtpbmQgPSAoZW50cnkua2luZCkgPyBlbnRyeS5raW5kIDogKGVudHJ5IGluc3RhbmNlb2YgRmlsZSkgPyBcImZpbGVcIiA6IFwiZGlyZWN0b3J5XCI7XG4gICAgICAgIGlmIChraW5kID09PSBcImZpbGVcIikge1xuICAgICAgICAgIGlmICghZW50cnkud2Via2l0UmVsYXRpdmVQYXRoKSBPYmplY3QuZGVmaW5lUHJvcGVydHkoZW50cnksIFwid2Via2l0UmVsYXRpdmVQYXRoXCIsIHtcbiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgICAgICAgICBnZXQ6ICgpID0+IG5lc3RlZHBhdGgsXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgaWYgKGVudHJ5IGluc3RhbmNlb2YgRmlsZSkgZW50cnkuZmlsZSA9IGFzeW5jIChmdW5jKSA9PiB7XG4gICAgICAgICAgICBhd2FpdCBmdW5jKGVudHJ5LCBuZXN0ZWRwYXRoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgZWxzZSBlbnRyeS5maWxlID0gYXN5bmMgKGZ1bmMpID0+IHtcbiAgICAgICAgICAgIGVudHJ5LmdldEZpbGUoKS50aGVuKGFzeW5jIGZpbGUgPT4ge1xuICAgICAgICAgICAgICBhd2FpdCBmdW5jKGZpbGUsIG5lc3RlZHBhdGgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGF3YWl0IHByb2Nlc3NGaWxlKGVudHJ5LCBjb21wbGV0ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAoa2luZCA9PT0gXCJkaXJlY3RvcnlcIikge1xuICAgICAgICAgIGNvbnN0IGRpcmVudHJpZXMgPSBhd2FpdCBBcnJheS5mcm9tQXN5bmMoZW50cnkudmFsdWVzKCkpO1xuICAgICAgICAgIGF3YWl0IHByb2Nlc3NFbnRyaWVzKGRpcmVudHJpZXMsIG5lc3RlZHBhdGgsIGNvbXBsZXRlKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChvbmNvbXBsZXRlKSBvbmNvbXBsZXRlKCk7XG4gICAgfVxuICAgIGF3YWl0IGNvbXBsZXRlKCk7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBldmVudG5hbWVzLFxuICAgIHByb2Nlc3NGaWxlLFxuICAgIHByb2Nlc3NFbnRyaWVzLFxuICAgIHJlYWREaXJlY3RvcnlcbiAgfVxufSJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///./src/modules/files/js-scandir.js\n")}}]);