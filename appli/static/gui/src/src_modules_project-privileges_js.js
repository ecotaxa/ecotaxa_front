/*! For license information please see src_modules_project-privileges_js.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["src_modules_project-privileges_js"],{"./src/modules/form-submit.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   FormSubmit: () => (/* binding */ FormSubmit)\n/* harmony export */ });\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! dompurify */ \"./node_modules/dompurify/dist/purify.js\");\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(dompurify__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../modules/modules-config.js */ \"./src/modules/modules-config.js\");\n/* harmony import */ var _modules_utils_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../modules/utils.js */ \"./src/modules/utils.js\");\n\n\nconst formcss = {\n  invalid: 'input-invalid',\n  inputvalidate: 'input-valid',\n}\n;\n\n_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_1__.domselectors[\"captcha\"] = '.js-captcha';\n\nclass FormSubmit {\n  handlers = [];\n  form = null;\n  listener = null;\n  constructor(form, options = {}) {\n    if (!form) return;\n    if (!form.formsubmit) {\n      this.form = form instanceof HTMLElement ? form : document.querySelector(form);\n      const defaultOptions = {\n        fetch: null,\n      };\n      options = Object.assign(options, this.form.dataset);\n      this.options = Object.assign(defaultOptions, options);\n      if (!this.form) return;\n      this.tabs = this.form.querySelectorAll(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_1__.domselectors.component.tabs.tab);\n      this.validateFields(true);\n      this.init();\n\n      form.formsubmit = this;\n    }\n    return form.formsubmit;\n  }\n  init() {\n    // init the form ( options like beforeunload etc...)\n\n    this.form.addEventListener('submit', async (e) => {\n      e.preventDefault();\n      const res = await this.submitForm();\n      return res;\n    });\n    this.specialFields();\n  }\n  specialFields() {\n    // check if there is a password confirm input\n    // add show text for password fields\n\n    this.form.querySelectorAll('input[data-match]').forEach(input => {\n      //\n      const match = input.dataset.match;\n      if (!match) return;\n      const target = document.getElementById(match);\n      if (!target) return;\n      const invalid = (input.dataset.matchinvalid) ? input.dataset.matchinvalid : \"no match\";\n      const check_match = (item, itemtarget) => {\n        const label = (input.previousElementSibling && input.previousElementSibling.tagName.toLowerCase() == 'label') ? input.previousElementSibling : null;\n        const labeltarget = (target.previousElementSibling && target.previousElementSibling.tagName.toLowerCase() == 'label') ? target.previousElementSibling : null;\n        const {\n          patternMismatch = false\n        } = item.validity;\n        const customvalidity = (patternMismatch) ?\n          this.get_message(item, 'invalid') : '';\n        if (item.checkValidity() === true) {\n          item.dataset.invalid = '';\n          item.setCustomValidity(\"\");\n          if (item == input && label !== null) label.classList.remove(formcss.invalid);\n          else if (labeltarget !== null) labeltarget.classList.remove(formcss.invalid);\n          item.classList.remove(formcss.inputvalidate);\n          if (item.value !== itemtarget.value) {\n            input.setCustomValidity(invalid);\n            if (label) {\n              label.dataset.invalid = (label.dataset.invalid) ? label.dataset.invalid : invalid;\n              label.classList.add(formcss.invalid);\n            }\n            input.classList.add(formcss.inputvalidate);\n          } else {\n            input.setCustomValidity(\"\");\n            if (label) label.classList.remove(formcss.invalid);\n            input.classList.remove(formcss.inputvalidate);\n          }\n        } else {\n          item.setCustomValidity(customvalidity);\n          item.dataset.invalid = customvalidity;\n          if (label) label.classList.add(formcss.invalid);\n          item.classList.add(formcss.inputvalidate);\n        }\n        item.focus();\n      };\n      [input, target].forEach(item => {\n        item.addEventListener('keyup', (e) => {\n          const itemtarget = (item === input) ? target : input;\n          check_match(item, itemtarget);\n        });\n      });\n\n    });\n  }\n  get_message(field, type = 'invalid') {\n    if (field.checkValidity() == false) {\n      const {\n        valueMissing = true\n      } = field.validity;\n      if (valueMissing) return (field.dataset.required) ? field.dataset.required : ((this.form.dataset.required) ? this.form.dataset.required : 'required');\n      else return (field.dataset[type]) ? field.dataset[type] : 'input invalid';\n    } else return '';\n  }\n\n  validateField(field, init = false) {\n\n\n\n    if (['textarea', 'input'].indexOf(field.tagName.toLowerCase()) >= 0) {\n\n    }\n\n    if (['select', 'input[type=\"checkbox\"]'].indexOf(field.tagName.toLowerCase()) >= 0) {\n      field.querySelectorAll('option:checked').forEach(option => {\n        option.value = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_2__.decode_HTMLEntities)(dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(option.value));\n      });\n\n    } else field.value = (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_2__.decode_HTMLEntities)(dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(field.value));\n\n    const rep = field.checkValidity();\n\n    /*  if (field.classList.contains('select-one')) {\n\n    }*/\n    const label = field.closest('.form-box') ? field.closest('.form-box').querySelector('label') : null;\n\n    if (rep && label) {\n      label.classList.remove(formcss.invalid);\n    } else if (!rep) {\n      if (label) {\n        label.dataset.invalid = this.get_message(field);\n        label.classList.add(formcss.invalid);\n        window.scrollTo({\n          top: parseInt(label.offsetTop),\n          left: parseInt(label.offsetLeft),\n          behavior: 'smooth'\n        });\n      }\n    }\n    return rep;\n  }\n\n  validateFields(init = false) {\n    //todo: complete validation foreach field type\n    let resp = true;\n    // .required input for tom-select component\n\n    [...this.form.elements].forEach(field => {\n      if (field.name) {\n        if (init === true) {\n          if (!field.dataset.listen) {\n            if (field.hasAttribute('required') && field.required) {\n              const label = field.closest('.form-box') ? field.closest('.form-box').querySelector('label') : field.parentElement.querySelector('label');\n              if (label) label.classList.add('required');\n            }\n\n            ['change', 'blur'].forEach(evt => {\n              field.addEventListener(evt, (e) => {\n                this.validateField(e.currentTarget, init);\n              });\n            });\n            field.dataset.listen = true;\n          }\n        } else resp = (resp && this.validateField(field, init));\n\n      }\n    });\n    // add/remove error class on tabs tab-control elements\n\n    this.tabs.forEach(tab => {\n      if (tab.querySelectorAll(':invalid').length) tab.classList.add(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_1__.css.error);\n      else tab.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_1__.css.error);\n    });\n    return resp;\n  }\n\n  addHandler(handler) {\n    this.handlers.push(handler);\n  }\n  fieldEnable(enable = true) {\n    this.form.querySelectorAll('input[data-sub=\"enable\"]').forEach(input => {\n      if (enable === true) {\n        input.removeAttribute(\"disabled\");\n      } else input.disabled = true;\n    });\n  }\n\n  async submitHandler() {\n    if (!this.validateFields()) return false;\n\n    if (this.handlers.length === 0) return true;\n    let resp = true;\n    // series\n    /*  for (const handler of this.handlers) {\n          const rep = await handler()\n          resp = (resp && rep)\n      }*/\n    // concurrent\n    await Promise.all(this.handlers.map(async handler => {\n      const rep = await handler();\n      resp = (resp && rep);\n    }));\n    if (resp === true) this.handlers = [];\n    return resp;\n  }\n  // no redirection when using data-fetch\n  formFetch(format = null) {\n    const formdata = new FormData(this.form);\n    formdata[\"fetch\"] = true;\n    fetch(this.form.action, (0,_modules_utils_js__WEBPACK_IMPORTED_MODULE_2__.fetchSettings)({\n        method: 'POST',\n        body: formdata,\n      }))\n      .then(response => {\n        switch (format) {\n          case \"text\":\n          case \"html\":\n            return response.text();\n            break;\n          default:\n            return response.json();\n        }\n      })\n      .then(response => {\n        this.displayResponse(response);\n      })\n      .catch(err => {\n        this.displayResponse(err, true)\n      }).finally(response => {\n        this.form.disabled = true;\n      });\n    return false;\n  }\n\n  async submitForm() {\n    this.fieldEnable();\n    if (this.validateFields(false)) {\n      const isbot = (this.form.querySelector(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_1__.domselectors.captcha)) ? (this.form.dataset.isbot ? (this.form.dataset.isbot === true) : true) : false;\n      if (isbot === true) return false;\n      const yessubmit = await this.submitHandler();\n      if (yessubmit) {\n        if (this.options.fetch) this.formFetch(this.options.fetch);\n        else this.form.submit();\n        this.form.disabled = true;\n        return true;\n      } else return false;\n    } else return false;\n  }\n\n  displayResponse(response, error = false) {\n    const el = document.createElement('div');\n    el.insertAdjacentHTML('afterbegin', response);\n    if (error !== false) el.classList.add('is-error');\n    this.form.parentElement.insertBefore(el, this.form);\n    this.form.remove();\n  }\n}//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiLi9zcmMvbW9kdWxlcy9mb3JtLXN1Ym1pdC5qcyIsIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFrQztBQUNBO0FBQ2xDO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsQ0FHc0M7QUFJVDtBQUM3QixvRUFBWTs7QUFFTDtBQUNQO0FBQ0E7QUFDQTtBQUNBLGdDQUFnQztBQUNoQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw2Q0FBNkMsb0VBQVk7QUFDekQ7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsWUFBWTtBQUNaO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsVUFBVTtBQUNWO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1QsT0FBTzs7QUFFUCxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQVE7QUFDUjtBQUNBO0FBQ0EsTUFBTTtBQUNOOztBQUVBOzs7O0FBSUE7O0FBRUE7O0FBRUE7QUFDQTtBQUNBLHVCQUF1QixzRUFBbUIsQ0FBQyx5REFBa0I7QUFDN0QsT0FBTzs7QUFFUCxNQUFNLG1CQUFtQixzRUFBbUIsQ0FBQyx5REFBa0I7O0FBRS9EOztBQUVBOztBQUVBLEtBQUs7QUFDTDs7QUFFQTtBQUNBO0FBQ0EsTUFBTTtBQUNOO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0EsZUFBZTtBQUNmLGFBQWE7QUFDYjtBQUNBO0FBQ0EsVUFBVTs7QUFFVjtBQUNBLEtBQUs7QUFDTDs7QUFFQTtBQUNBLHFFQUFxRSwyREFBRztBQUN4RSxnQ0FBZ0MsMkRBQUc7QUFDbkMsS0FBSztBQUNMO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxRQUFRO0FBQ1IsS0FBSztBQUNMOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsNEJBQTRCLGdFQUFhO0FBQ3pDO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQO0FBQ0E7QUFDQSxPQUFPO0FBQ1A7QUFDQTtBQUNBLE9BQU87QUFDUDtBQUNBLE9BQU87QUFDUDtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBLDZDQUE2QyxvRUFBWTtBQUN6RDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQVE7QUFDUixNQUFNO0FBQ047O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsInNvdXJjZXMiOlsid2VicGFjazovLy8uL3NyYy9tb2R1bGVzL2Zvcm0tc3VibWl0LmpzP2M2YjciXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHZhbGlkYXRvciBmcm9tICd2YWxpZGF0b3InO1xuaW1wb3J0IERPTVB1cmlmeSBmcm9tICdkb21wdXJpZnknO1xuY29uc3QgZm9ybWNzcyA9IHtcbiAgaW52YWxpZDogJ2lucHV0LWludmFsaWQnLFxuICBpbnB1dHZhbGlkYXRlOiAnaW5wdXQtdmFsaWQnLFxufVxuaW1wb3J0IHtcbiAgZG9tc2VsZWN0b3JzLFxuICBjc3Ncbn0gZnJvbSAnLi4vbW9kdWxlcy9tb2R1bGVzLWNvbmZpZy5qcyc7XG5pbXBvcnQge1xuICBmZXRjaFNldHRpbmdzLFxuICBkZWNvZGVfSFRNTEVudGl0aWVzXG59IGZyb20gJy4uL21vZHVsZXMvdXRpbHMuanMnO1xuZG9tc2VsZWN0b3JzW1wiY2FwdGNoYVwiXSA9ICcuanMtY2FwdGNoYSc7XG5cbmV4cG9ydCBjbGFzcyBGb3JtU3VibWl0IHtcbiAgaGFuZGxlcnMgPSBbXTtcbiAgZm9ybSA9IG51bGw7XG4gIGxpc3RlbmVyID0gbnVsbDtcbiAgY29uc3RydWN0b3IoZm9ybSwgb3B0aW9ucyA9IHt9KSB7XG4gICAgaWYgKCFmb3JtKSByZXR1cm47XG4gICAgaWYgKCFmb3JtLmZvcm1zdWJtaXQpIHtcbiAgICAgIHRoaXMuZm9ybSA9IGZvcm0gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IGZvcm0gOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGZvcm0pO1xuICAgICAgY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gICAgICAgIGZldGNoOiBudWxsLFxuICAgICAgfTtcbiAgICAgIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKG9wdGlvbnMsIHRoaXMuZm9ybS5kYXRhc2V0KTtcbiAgICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpO1xuICAgICAgaWYgKCF0aGlzLmZvcm0pIHJldHVybjtcbiAgICAgIHRoaXMudGFicyA9IHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yQWxsKGRvbXNlbGVjdG9ycy5jb21wb25lbnQudGFicy50YWIpO1xuICAgICAgdGhpcy52YWxpZGF0ZUZpZWxkcyh0cnVlKTtcbiAgICAgIHRoaXMuaW5pdCgpO1xuXG4gICAgICBmb3JtLmZvcm1zdWJtaXQgPSB0aGlzO1xuICAgIH1cbiAgICByZXR1cm4gZm9ybS5mb3Jtc3VibWl0O1xuICB9XG4gIGluaXQoKSB7XG4gICAgLy8gaW5pdCB0aGUgZm9ybSAoIG9wdGlvbnMgbGlrZSBiZWZvcmV1bmxvYWQgZXRjLi4uKVxuXG4gICAgdGhpcy5mb3JtLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIGFzeW5jIChlKSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLnN1Ym1pdEZvcm0oKTtcbiAgICAgIHJldHVybiByZXM7XG4gICAgfSk7XG4gICAgdGhpcy5zcGVjaWFsRmllbGRzKCk7XG4gIH1cbiAgc3BlY2lhbEZpZWxkcygpIHtcbiAgICAvLyBjaGVjayBpZiB0aGVyZSBpcyBhIHBhc3N3b3JkIGNvbmZpcm0gaW5wdXRcbiAgICAvLyBhZGQgc2hvdyB0ZXh0IGZvciBwYXNzd29yZCBmaWVsZHNcblxuICAgIHRoaXMuZm9ybS5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dFtkYXRhLW1hdGNoXScpLmZvckVhY2goaW5wdXQgPT4ge1xuICAgICAgLy9cbiAgICAgIGNvbnN0IG1hdGNoID0gaW5wdXQuZGF0YXNldC5tYXRjaDtcbiAgICAgIGlmICghbWF0Y2gpIHJldHVybjtcbiAgICAgIGNvbnN0IHRhcmdldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG1hdGNoKTtcbiAgICAgIGlmICghdGFyZ2V0KSByZXR1cm47XG4gICAgICBjb25zdCBpbnZhbGlkID0gKGlucHV0LmRhdGFzZXQubWF0Y2hpbnZhbGlkKSA/IGlucHV0LmRhdGFzZXQubWF0Y2hpbnZhbGlkIDogXCJubyBtYXRjaFwiO1xuICAgICAgY29uc3QgY2hlY2tfbWF0Y2ggPSAoaXRlbSwgaXRlbXRhcmdldCkgPT4ge1xuICAgICAgICBjb25zdCBsYWJlbCA9IChpbnB1dC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nICYmIGlucHV0LnByZXZpb3VzRWxlbWVudFNpYmxpbmcudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09ICdsYWJlbCcpID8gaW5wdXQucHJldmlvdXNFbGVtZW50U2libGluZyA6IG51bGw7XG4gICAgICAgIGNvbnN0IGxhYmVsdGFyZ2V0ID0gKHRhcmdldC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nICYmIHRhcmdldC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PSAnbGFiZWwnKSA/IHRhcmdldC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nIDogbnVsbDtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIHBhdHRlcm5NaXNtYXRjaCA9IGZhbHNlXG4gICAgICAgIH0gPSBpdGVtLnZhbGlkaXR5O1xuICAgICAgICBjb25zdCBjdXN0b212YWxpZGl0eSA9IChwYXR0ZXJuTWlzbWF0Y2gpID9cbiAgICAgICAgICB0aGlzLmdldF9tZXNzYWdlKGl0ZW0sICdpbnZhbGlkJykgOiAnJztcbiAgICAgICAgaWYgKGl0ZW0uY2hlY2tWYWxpZGl0eSgpID09PSB0cnVlKSB7XG4gICAgICAgICAgaXRlbS5kYXRhc2V0LmludmFsaWQgPSAnJztcbiAgICAgICAgICBpdGVtLnNldEN1c3RvbVZhbGlkaXR5KFwiXCIpO1xuICAgICAgICAgIGlmIChpdGVtID09IGlucHV0ICYmIGxhYmVsICE9PSBudWxsKSBsYWJlbC5jbGFzc0xpc3QucmVtb3ZlKGZvcm1jc3MuaW52YWxpZCk7XG4gICAgICAgICAgZWxzZSBpZiAobGFiZWx0YXJnZXQgIT09IG51bGwpIGxhYmVsdGFyZ2V0LmNsYXNzTGlzdC5yZW1vdmUoZm9ybWNzcy5pbnZhbGlkKTtcbiAgICAgICAgICBpdGVtLmNsYXNzTGlzdC5yZW1vdmUoZm9ybWNzcy5pbnB1dHZhbGlkYXRlKTtcbiAgICAgICAgICBpZiAoaXRlbS52YWx1ZSAhPT0gaXRlbXRhcmdldC52YWx1ZSkge1xuICAgICAgICAgICAgaW5wdXQuc2V0Q3VzdG9tVmFsaWRpdHkoaW52YWxpZCk7XG4gICAgICAgICAgICBpZiAobGFiZWwpIHtcbiAgICAgICAgICAgICAgbGFiZWwuZGF0YXNldC5pbnZhbGlkID0gKGxhYmVsLmRhdGFzZXQuaW52YWxpZCkgPyBsYWJlbC5kYXRhc2V0LmludmFsaWQgOiBpbnZhbGlkO1xuICAgICAgICAgICAgICBsYWJlbC5jbGFzc0xpc3QuYWRkKGZvcm1jc3MuaW52YWxpZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpbnB1dC5jbGFzc0xpc3QuYWRkKGZvcm1jc3MuaW5wdXR2YWxpZGF0ZSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlucHV0LnNldEN1c3RvbVZhbGlkaXR5KFwiXCIpO1xuICAgICAgICAgICAgaWYgKGxhYmVsKSBsYWJlbC5jbGFzc0xpc3QucmVtb3ZlKGZvcm1jc3MuaW52YWxpZCk7XG4gICAgICAgICAgICBpbnB1dC5jbGFzc0xpc3QucmVtb3ZlKGZvcm1jc3MuaW5wdXR2YWxpZGF0ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGl0ZW0uc2V0Q3VzdG9tVmFsaWRpdHkoY3VzdG9tdmFsaWRpdHkpO1xuICAgICAgICAgIGl0ZW0uZGF0YXNldC5pbnZhbGlkID0gY3VzdG9tdmFsaWRpdHk7XG4gICAgICAgICAgaWYgKGxhYmVsKSBsYWJlbC5jbGFzc0xpc3QuYWRkKGZvcm1jc3MuaW52YWxpZCk7XG4gICAgICAgICAgaXRlbS5jbGFzc0xpc3QuYWRkKGZvcm1jc3MuaW5wdXR2YWxpZGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICAgaXRlbS5mb2N1cygpO1xuICAgICAgfTtcbiAgICAgIFtpbnB1dCwgdGFyZ2V0XS5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICBpdGVtLmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgKGUpID0+IHtcbiAgICAgICAgICBjb25zdCBpdGVtdGFyZ2V0ID0gKGl0ZW0gPT09IGlucHV0KSA/IHRhcmdldCA6IGlucHV0O1xuICAgICAgICAgIGNoZWNrX21hdGNoKGl0ZW0sIGl0ZW10YXJnZXQpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgfSk7XG4gIH1cbiAgZ2V0X21lc3NhZ2UoZmllbGQsIHR5cGUgPSAnaW52YWxpZCcpIHtcbiAgICBpZiAoZmllbGQuY2hlY2tWYWxpZGl0eSgpID09IGZhbHNlKSB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIHZhbHVlTWlzc2luZyA9IHRydWVcbiAgICAgIH0gPSBmaWVsZC52YWxpZGl0eTtcbiAgICAgIGlmICh2YWx1ZU1pc3NpbmcpIHJldHVybiAoZmllbGQuZGF0YXNldC5yZXF1aXJlZCkgPyBmaWVsZC5kYXRhc2V0LnJlcXVpcmVkIDogKCh0aGlzLmZvcm0uZGF0YXNldC5yZXF1aXJlZCkgPyB0aGlzLmZvcm0uZGF0YXNldC5yZXF1aXJlZCA6ICdyZXF1aXJlZCcpO1xuICAgICAgZWxzZSByZXR1cm4gKGZpZWxkLmRhdGFzZXRbdHlwZV0pID8gZmllbGQuZGF0YXNldFt0eXBlXSA6ICdpbnB1dCBpbnZhbGlkJztcbiAgICB9IGVsc2UgcmV0dXJuICcnO1xuICB9XG5cbiAgdmFsaWRhdGVGaWVsZChmaWVsZCwgaW5pdCA9IGZhbHNlKSB7XG5cblxuXG4gICAgaWYgKFsndGV4dGFyZWEnLCAnaW5wdXQnXS5pbmRleE9mKGZpZWxkLnRhZ05hbWUudG9Mb3dlckNhc2UoKSkgPj0gMCkge1xuXG4gICAgfVxuXG4gICAgaWYgKFsnc2VsZWN0JywgJ2lucHV0W3R5cGU9XCJjaGVja2JveFwiXSddLmluZGV4T2YoZmllbGQudGFnTmFtZS50b0xvd2VyQ2FzZSgpKSA+PSAwKSB7XG4gICAgICBmaWVsZC5xdWVyeVNlbGVjdG9yQWxsKCdvcHRpb246Y2hlY2tlZCcpLmZvckVhY2gob3B0aW9uID0+IHtcbiAgICAgICAgb3B0aW9uLnZhbHVlID0gZGVjb2RlX0hUTUxFbnRpdGllcyhET01QdXJpZnkuc2FuaXRpemUob3B0aW9uLnZhbHVlKSk7XG4gICAgICB9KTtcblxuICAgIH0gZWxzZSBmaWVsZC52YWx1ZSA9IGRlY29kZV9IVE1MRW50aXRpZXMoRE9NUHVyaWZ5LnNhbml0aXplKGZpZWxkLnZhbHVlKSk7XG5cbiAgICBjb25zdCByZXAgPSBmaWVsZC5jaGVja1ZhbGlkaXR5KCk7XG5cbiAgICAvKiAgaWYgKGZpZWxkLmNsYXNzTGlzdC5jb250YWlucygnc2VsZWN0LW9uZScpKSB7XG5cbiAgICB9Ki9cbiAgICBjb25zdCBsYWJlbCA9IGZpZWxkLmNsb3Nlc3QoJy5mb3JtLWJveCcpID8gZmllbGQuY2xvc2VzdCgnLmZvcm0tYm94JykucXVlcnlTZWxlY3RvcignbGFiZWwnKSA6IG51bGw7XG5cbiAgICBpZiAocmVwICYmIGxhYmVsKSB7XG4gICAgICBsYWJlbC5jbGFzc0xpc3QucmVtb3ZlKGZvcm1jc3MuaW52YWxpZCk7XG4gICAgfSBlbHNlIGlmICghcmVwKSB7XG4gICAgICBpZiAobGFiZWwpIHtcbiAgICAgICAgbGFiZWwuZGF0YXNldC5pbnZhbGlkID0gdGhpcy5nZXRfbWVzc2FnZShmaWVsZCk7XG4gICAgICAgIGxhYmVsLmNsYXNzTGlzdC5hZGQoZm9ybWNzcy5pbnZhbGlkKTtcbiAgICAgICAgd2luZG93LnNjcm9sbFRvKHtcbiAgICAgICAgICB0b3A6IHBhcnNlSW50KGxhYmVsLm9mZnNldFRvcCksXG4gICAgICAgICAgbGVmdDogcGFyc2VJbnQobGFiZWwub2Zmc2V0TGVmdCksXG4gICAgICAgICAgYmVoYXZpb3I6ICdzbW9vdGgnXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVwO1xuICB9XG5cbiAgdmFsaWRhdGVGaWVsZHMoaW5pdCA9IGZhbHNlKSB7XG4gICAgLy90b2RvOiBjb21wbGV0ZSB2YWxpZGF0aW9uIGZvcmVhY2ggZmllbGQgdHlwZVxuICAgIGxldCByZXNwID0gdHJ1ZTtcbiAgICAvLyAucmVxdWlyZWQgaW5wdXQgZm9yIHRvbS1zZWxlY3QgY29tcG9uZW50XG5cbiAgICBbLi4udGhpcy5mb3JtLmVsZW1lbnRzXS5mb3JFYWNoKGZpZWxkID0+IHtcbiAgICAgIGlmIChmaWVsZC5uYW1lKSB7XG4gICAgICAgIGlmIChpbml0ID09PSB0cnVlKSB7XG4gICAgICAgICAgaWYgKCFmaWVsZC5kYXRhc2V0Lmxpc3Rlbikge1xuICAgICAgICAgICAgaWYgKGZpZWxkLmhhc0F0dHJpYnV0ZSgncmVxdWlyZWQnKSAmJiBmaWVsZC5yZXF1aXJlZCkge1xuICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGZpZWxkLmNsb3Nlc3QoJy5mb3JtLWJveCcpID8gZmllbGQuY2xvc2VzdCgnLmZvcm0tYm94JykucXVlcnlTZWxlY3RvcignbGFiZWwnKSA6IGZpZWxkLnBhcmVudEVsZW1lbnQucXVlcnlTZWxlY3RvcignbGFiZWwnKTtcbiAgICAgICAgICAgICAgaWYgKGxhYmVsKSBsYWJlbC5jbGFzc0xpc3QuYWRkKCdyZXF1aXJlZCcpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBbJ2NoYW5nZScsICdibHVyJ10uZm9yRWFjaChldnQgPT4ge1xuICAgICAgICAgICAgICBmaWVsZC5hZGRFdmVudExpc3RlbmVyKGV2dCwgKGUpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRlRmllbGQoZS5jdXJyZW50VGFyZ2V0LCBpbml0KTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGZpZWxkLmRhdGFzZXQubGlzdGVuID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSByZXNwID0gKHJlc3AgJiYgdGhpcy52YWxpZGF0ZUZpZWxkKGZpZWxkLCBpbml0KSk7XG5cbiAgICAgIH1cbiAgICB9KTtcbiAgICAvLyBhZGQvcmVtb3ZlIGVycm9yIGNsYXNzIG9uIHRhYnMgdGFiLWNvbnRyb2wgZWxlbWVudHNcblxuICAgIHRoaXMudGFicy5mb3JFYWNoKHRhYiA9PiB7XG4gICAgICBpZiAodGFiLnF1ZXJ5U2VsZWN0b3JBbGwoJzppbnZhbGlkJykubGVuZ3RoKSB0YWIuY2xhc3NMaXN0LmFkZChjc3MuZXJyb3IpO1xuICAgICAgZWxzZSB0YWIuY2xhc3NMaXN0LnJlbW92ZShjc3MuZXJyb3IpO1xuICAgIH0pO1xuICAgIHJldHVybiByZXNwO1xuICB9XG5cbiAgYWRkSGFuZGxlcihoYW5kbGVyKSB7XG4gICAgdGhpcy5oYW5kbGVycy5wdXNoKGhhbmRsZXIpO1xuICB9XG4gIGZpZWxkRW5hYmxlKGVuYWJsZSA9IHRydWUpIHtcbiAgICB0aGlzLmZvcm0ucXVlcnlTZWxlY3RvckFsbCgnaW5wdXRbZGF0YS1zdWI9XCJlbmFibGVcIl0nKS5mb3JFYWNoKGlucHV0ID0+IHtcbiAgICAgIGlmIChlbmFibGUgPT09IHRydWUpIHtcbiAgICAgICAgaW5wdXQucmVtb3ZlQXR0cmlidXRlKFwiZGlzYWJsZWRcIik7XG4gICAgICB9IGVsc2UgaW5wdXQuZGlzYWJsZWQgPSB0cnVlO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc3VibWl0SGFuZGxlcigpIHtcbiAgICBpZiAoIXRoaXMudmFsaWRhdGVGaWVsZHMoKSkgcmV0dXJuIGZhbHNlO1xuXG4gICAgaWYgKHRoaXMuaGFuZGxlcnMubGVuZ3RoID09PSAwKSByZXR1cm4gdHJ1ZTtcbiAgICBsZXQgcmVzcCA9IHRydWU7XG4gICAgLy8gc2VyaWVzXG4gICAgLyogIGZvciAoY29uc3QgaGFuZGxlciBvZiB0aGlzLmhhbmRsZXJzKSB7XG4gICAgICAgICAgY29uc3QgcmVwID0gYXdhaXQgaGFuZGxlcigpXG4gICAgICAgICAgcmVzcCA9IChyZXNwICYmIHJlcClcbiAgICAgIH0qL1xuICAgIC8vIGNvbmN1cnJlbnRcbiAgICBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLmhhbmRsZXJzLm1hcChhc3luYyBoYW5kbGVyID0+IHtcbiAgICAgIGNvbnN0IHJlcCA9IGF3YWl0IGhhbmRsZXIoKTtcbiAgICAgIHJlc3AgPSAocmVzcCAmJiByZXApO1xuICAgIH0pKTtcbiAgICBpZiAocmVzcCA9PT0gdHJ1ZSkgdGhpcy5oYW5kbGVycyA9IFtdO1xuICAgIHJldHVybiByZXNwO1xuICB9XG4gIC8vIG5vIHJlZGlyZWN0aW9uIHdoZW4gdXNpbmcgZGF0YS1mZXRjaFxuICBmb3JtRmV0Y2goZm9ybWF0ID0gbnVsbCkge1xuICAgIGNvbnN0IGZvcm1kYXRhID0gbmV3IEZvcm1EYXRhKHRoaXMuZm9ybSk7XG4gICAgZm9ybWRhdGFbXCJmZXRjaFwiXSA9IHRydWU7XG4gICAgZmV0Y2godGhpcy5mb3JtLmFjdGlvbiwgZmV0Y2hTZXR0aW5ncyh7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBib2R5OiBmb3JtZGF0YSxcbiAgICAgIH0pKVxuICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICBzd2l0Y2ggKGZvcm1hdCkge1xuICAgICAgICAgIGNhc2UgXCJ0ZXh0XCI6XG4gICAgICAgICAgY2FzZSBcImh0bWxcIjpcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS50ZXh0KCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgdGhpcy5kaXNwbGF5UmVzcG9uc2UocmVzcG9uc2UpO1xuICAgICAgfSlcbiAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICB0aGlzLmRpc3BsYXlSZXNwb25zZShlcnIsIHRydWUpXG4gICAgICB9KS5maW5hbGx5KHJlc3BvbnNlID0+IHtcbiAgICAgICAgdGhpcy5mb3JtLmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgIH0pO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIHN1Ym1pdEZvcm0oKSB7XG4gICAgdGhpcy5maWVsZEVuYWJsZSgpO1xuICAgIGlmICh0aGlzLnZhbGlkYXRlRmllbGRzKGZhbHNlKSkge1xuICAgICAgY29uc3QgaXNib3QgPSAodGhpcy5mb3JtLnF1ZXJ5U2VsZWN0b3IoZG9tc2VsZWN0b3JzLmNhcHRjaGEpKSA/ICh0aGlzLmZvcm0uZGF0YXNldC5pc2JvdCA/ICh0aGlzLmZvcm0uZGF0YXNldC5pc2JvdCA9PT0gdHJ1ZSkgOiB0cnVlKSA6IGZhbHNlO1xuICAgICAgaWYgKGlzYm90ID09PSB0cnVlKSByZXR1cm4gZmFsc2U7XG4gICAgICBjb25zdCB5ZXNzdWJtaXQgPSBhd2FpdCB0aGlzLnN1Ym1pdEhhbmRsZXIoKTtcbiAgICAgIGlmICh5ZXNzdWJtaXQpIHtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5mZXRjaCkgdGhpcy5mb3JtRmV0Y2godGhpcy5vcHRpb25zLmZldGNoKTtcbiAgICAgICAgZWxzZSB0aGlzLmZvcm0uc3VibWl0KCk7XG4gICAgICAgIHRoaXMuZm9ybS5kaXNhYmxlZCA9IHRydWU7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBlbHNlIHJldHVybiBmYWxzZTtcbiAgICB9IGVsc2UgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgZGlzcGxheVJlc3BvbnNlKHJlc3BvbnNlLCBlcnJvciA9IGZhbHNlKSB7XG4gICAgY29uc3QgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBlbC5pbnNlcnRBZGphY2VudEhUTUwoJ2FmdGVyYmVnaW4nLCByZXNwb25zZSk7XG4gICAgaWYgKGVycm9yICE9PSBmYWxzZSkgZWwuY2xhc3NMaXN0LmFkZCgnaXMtZXJyb3InKTtcbiAgICB0aGlzLmZvcm0ucGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUoZWwsIHRoaXMuZm9ybSk7XG4gICAgdGhpcy5mb3JtLnJlbW92ZSgpO1xuICB9XG59Il0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///./src/modules/form-submit.js\n")},"./src/modules/project-privileges.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   ProjectPrivileges: () => (/* binding */ ProjectPrivileges)\n/* harmony export */ });\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! dompurify */ \"./node_modules/dompurify/dist/purify.js\");\n/* harmony import */ var dompurify__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(dompurify__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var _modules_form_submit_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../modules/form-submit.js */ \"./src/modules/form-submit.js\");\n/* harmony import */ var _modules_alert_boxes_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ../modules/alert-boxes.js */ \"./src/modules/alert-boxes.js\");\n/* harmony import */ var _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ../modules/js-tom-select.js */ \"./src/modules/js-tom-select.js\");\n/* harmony import */ var _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! ../modules/modules-config.js */ \"./src/modules/modules-config.js\");\n// privileges of a project\n// line with member name , priviliege , is contact , and delete functionality\n\n\n\n\n\n\nconst codemessages = {\n  oneatleast: 'oneatleast',\n  nomanager: 'nomanager',\n  nocontact: 'nocontact',\n  uhasnopriv: 'uhasnopriv',\n  importpriverror: 'importpriverror',\n  emptyname: 'emptyname'\n}\nlet instance = null;\nclass ProjectPrivileges {\n  //TODO: rewrite to not depend on DOM select\n  options;\n  alertBox;\n  // current user id;\n  current_uid;\n  fieldset;\n  fieldset_alert_zone;\n  // unique users\n  constructor(options = {}) {\n    if (!instance) {\n      const defaultOptions = {\n        groupid: \"#section-privileges\",\n        separ: '.new-privilege',\n        addbtn: '[data-add=\"block\"]',\n        target: 'member',\n        ident: 'member',\n        privilege: 'privilege',\n        delet: 'delet',\n        contact: 'contact',\n        contactfieldname: 'contact_user_id',\n        domselectors: {\n          tabcontent: '.tab-content'\n        }\n      };\n      this.options = Object.assign({}, defaultOptions, options);\n      this.fieldset = document.querySelector(this.options.groupid);\n      if (!this.fieldset) return;\n      this.fieldset_alert_zone = this.fieldset.querySelector(this.options.domselectors.tabcontent) ? this.fieldset.querySelector(this.options.domselectors.tabcontent) : this.fieldset;\n      this.options.separ = this.options.separ instanceof HTMLElement ? this.options.separ : (document.querySelector(this.options.separ) ? document.querySelector(this.options.separ) : null);\n      this.options.addbtn = this.options.addbtn instanceof HTMLElement ? this.options.addbtn : document.querySelector(this.options.addbtn);\n      if (this.options.addbtn) this.addListener();\n      const lines = this.fieldset.querySelectorAll('[data-block=\"' + this.options.target + '\"]');\n      this.current_uid = this.fieldset.dataset.u;\n      this.alertBox = new _modules_alert_boxes_js__WEBPACK_IMPORTED_MODULE_2__.AlertBox();\n      lines.forEach((line) => {\n        this.activateEvents(line);\n      });\n\n      //remove deleted , clean && validate datas , format names before sending the form\n      const form = this.fieldset.closest('form');\n      const formSubmit = new _modules_form_submit_js__WEBPACK_IMPORTED_MODULE_1__.FormSubmit(form);\n      // handler - verify privileges before settings form submit\n      const submit_privileges = async () => {\n        const resp = await this.cleanPrivileges();\n        return resp;\n      }\n      formSubmit.addHandler(submit_privileges);\n      instance = this;\n    }\n    return instance;\n  }\n\n  newLine(ret = false, check = 0) {\n    let line;\n    if (check > 0) {\n      line = this.getLinePrivilege(check);\n      if (line) return line;\n    }\n    const lines = this.fieldset.querySelectorAll('[data-block=\"' + this.options.target + '\"]');\n\n    if (lines.length === 0) return;\n    const n = lines.length - 1;\n    line = lines[n];\n    if (line !== null) {\n      line = this.clearLine(line.cloneNode(true), n, (this.options.separ ? this.options.separ : line));\n\n      this.activateEvents(line);\n\n    }\n    if (ret === true) return line;\n  }\n\n  addListener() {\n    this.options.target = (this.options.addbtn.dataset.target) ? this.options.addbtn.dataset.target : this.options.target;\n    this.options.addbtn.addEventListener('click', async (e) => {\n      e.preventDefault();\n      this.newLine();\n    })\n  }\n\n  clearLine(line, n, separ = null) {\n    /*clean line element */\n\n    let has_autocomplete = null;\n    line.dataset.mod = '';\n    line.disabled = false;\n    const elems = line.querySelectorAll('[data-elem]');\n    elems.forEach((elem) => {\n      // change loop index - necessary for tailwindcss peerchecked to work otherwise not if name ends with []\n      //remove components\n      const rms = elem.querySelectorAll('[data-component]')\n      rms.forEach((rm) => {\n        switch (rm.dataset.component) {\n          case 'tom-select':\n            rm.remove();\n            break;\n        }\n      })\n      // clean and reset events\n      const els = elem.querySelectorAll('input, select, label');\n      els.forEach((el) => {\n\n        el.disabled = false;\n        if (separ) { // change names and id when adding a new row - not if clear only\n          const keys = ['id', 'for', 'aria-controls', 'name'];\n          keys.forEach((key) => {\n            let val = el.getAttribute(key);\n            if (val !== null) {\n              if (key === 'name') val = val.replace('[' + n + ']', '[' + (n + 1) + ']');\n              else val = val.replace('_' + n, '_' + (n + 1));\n              el.setAttribute(key, val);\n            }\n          });\n        }\n        switch (el.tagName.toLowerCase()) {\n          case 'input':\n            //el.indeterminate = true;\n            el.checked = false;\n            // disable contact as privilege is empty\n            if (el.name == this.options.contactfieldname) {\n              el.value = \"0\";\n              el.disabled = true;\n            }\n            break;\n          case 'select':\n            el.selectedIndex = -1;\n            break;\n          case 'label':\n            el.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.peerchecked);\n            break;\n        }\n        if (el.tomselect) {\n          has_autocomplete = el;\n          el.tomselect.clear();\n          el.tomselect.destroy();\n\n        }\n        if (el.classList.contains(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.component.autocomplete.tomselected)) {\n          has_autocomplete = el;\n          el.classList.forEach(cl => {\n            if (cl.indexOf('ts-') == 0) el.classList.remove(cl);\n          })\n          el.classList.remove(_modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.css.component.autocomplete.tomselected);\n          if (el.type == \"select-one\") delete el.type;\n\n        }\n\n      })\n\n    })\n    /* add functionnalities */\n    if (separ) {\n      line.classList.add('new');\n      separ.after(line);\n    }\n    /* clear and add tom-select functionalities - only after adding line to the dom*/\n    if (has_autocomplete !== null) {\n      const jsTomSelect = new _modules_js_tom_select_js__WEBPACK_IMPORTED_MODULE_3__.JsTomSelect();\n      jsTomSelect.applyTo(has_autocomplete);\n      has_autocomplete.tomselect.clearOptions();\n      let options = this.fieldset.dataset.options;\n      options = (options) ? options : [];\n      has_autocomplete.tomselect.addOptions(options);\n    };\n\n\n    return line;\n  }\n\n  setLine(line, mb = {\n    key: '',\n    value: ''\n  }, priv, ct) {\n\n    priv = _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.defined_privileges[priv] ? _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.defined_privileges[priv] : _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.defined_privileges.viewers;\n    if (!priv) return;\n    const {\n      member,\n      privs,\n      contact,\n      delet\n    } = this.getInputs(line, priv);\n    if (!member || !privs || !contact || !delet) return;\n\n    // sanitize\n    mb.key = dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(mb.key);\n    mb.value = dompurify__WEBPACK_IMPORTED_MODULE_0___default().sanitize(mb.value);\n    const ts = member.tomselect;\n    if (ts) {\n      ts.clear();\n      const addmb = {}\n      addmb[ts.settings.valueField] = mb.key;\n      addmb[ts.settings.labelField] = addmb[ts.settings.searchField] = mb.value;\n      ts.addOption(addmb);\n      ts.setValue([mb.key]);\n    } else {\n      const selected = member.querySelector('select option[value=\"' + mb.key + '\"]');\n      if (selected) selected.selected = true;\n      else member.insertAdjacentHTML('beforeend', '<option value=\"' + mb.key + '\" selected>' + mb.value + '</option>');\n\n    }\n    privs.checked = true;\n    contact.value = mb.key;\n    if (priv === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.rights.manage) {\n      contact.disabled = false;\n      if (ct === true) contact.checked = true;\n    }\n\n  }\n  getInputs(line, priv = false) {\n    const member = line.querySelector(\"[name*='[\" + this.options.ident + \"]']\");\n    let privs;\n    if (priv) {\n      privs = line.querySelector('input[name*=\"[' + this.options.privilege + ']\"][value=\"' + priv + '\"]');\n    } else privs = line.querySelectorAll('input[name*=\"[' + this.options.privilege + ']\"]');\n    const contact = line.querySelector('input[name=\"' + this.options.contactfieldname + '\"]');\n    const delet = line.querySelector(\"input[name*='[\" + this.options.delet + \"]']\");\n\n    return {\n      member: member,\n      privs: privs,\n      contact: contact,\n      delet: delet\n    };\n  }\n  async importPrivileges(privileges, replace = false, contact = null, importedtag = null, dismiss = null) {\n    let lastline = !replace;\n\n    try {\n      Object.entries(privileges).forEach(([priv, members]) => {\n        members.forEach((member) => {\n          if (!lastline) lastline = this.clearAll(true);\n          else lastline = this.newLine(true, member.id);\n          if (lastline) {\n            this.setLine(lastline, {\n              key: member.id,\n              value: member.name,\n            }, priv, (contact && (parseInt(contact.id) === parseInt(member.id))));\n            if (importedtag) importedtag(lastline);\n\n          }\n\n        });\n\n      });\n      if (dismiss) dismiss();\n      this.alertBox.dismissAlert(codemessages.importpriverror);\n      return true;\n    } catch (err) {\n      await this.alertBox.build({\n        dismissible: true,\n        message: codemessages.importpriverror,\n        codeid: true,\n        parent: this.fieldset_alert_zone,\n        type: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.alertconfig.danger,\n      });\n      console.log('err', err);\n      return false;\n    }\n  }\n  activateEvents(line) {\n    if (!line) return;\n    const {\n      member,\n      privs,\n      contact,\n      delet\n    } = this.getInputs(line);\n    if (!member || !privs || !contact || !delet) {\n      return;\n    }\n    const siblings = s => [...s.parentElement.children].filter(c => c.nodeType == 1 && c != s && c.classList.contains('row') && c.dataset.block !== null && c.dataset.block === this.options.target);\n\n    // enable/disable contact when privilege changes\n    const lineSettings = (pr, ct, dl, synchro = false) => {\n\n      if (pr && pr.value === _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.rights.manage) {\n        // manager - can't delete line - can choose as contact\n        dl.disabled = true;\n        ct.disabled = false;\n        // dismiss related alert\n        this.alertBox.dismissAlert(codemessages.nomanager);\n        if (ct.checked) {\n          this.alertBox.dismissAlert(codemessages.nocontact);\n        }\n      } else {\n        // not manager - can delet line - cannot chose as contact\n        //  if (ct.checked === true) ct.dispatchEvent(new Event('click'));\n        ct.checked = false;\n        dl.disabled = false;\n        ct.disabled = true;\n      }\n\n      if (synchro === true) {\n        synchroSiblings(line);\n      }\n      // dismiss alerts\n      if (!dl.ckecked) {\n        this.alertBox.dismissAlert(codemessages.nobody);\n        this.alertBox.dismissAlert(codemessages.oneatleast);\n      }\n    }\n    const synchroSiblings = (line) => {\n      const lns = siblings(line);\n      lns.forEach((ln) => {\n        const dl = ln.querySelector(\"input[name*='[\" + this.options.delet + \"]']\");\n        const ct = ln.querySelector('input[name=\"' + this.options.contactfieldname + '\"]');\n        const pr = ln.querySelector('input[name*=\"[' + this.options.privilege + ']\"]:checked');\n        lineSettings(pr, ct, dl, false);\n\n      })\n    }\n\n    member.addEventListener('change', (e) => {\n      contact.value = member.value;\n      // dismiss alert\n      if (member.value) {\n        this.alertBox.dismissAlert(codemessages.emptyname);\n        this.alertBox.dismissAlert(codemessages.oneatleast);\n        this.alertBox.dismissAlert(codemessages.nobody);\n      }\n    })\n\n    privs.forEach((priv) => {\n      priv.addEventListener('change', (e) => {\n        if (priv.checked) lineSettings(priv, contact, delet, false);\n      });\n\n      if (priv.checked) lineSettings(priv, contact, delet, false);\n    })\n\n    contact.addEventListener('change', (e) => {\n      if (e.target.checked) delet.disabled = true;\n      else delet.disabled = false;\n      const priv = line.querySelector('input[name*=\"[' + this.options.privilege + ']\"]:checked');\n      lineSettings(priv, contact, delet, true);\n      // enable otherwise\n\n    })\n\n    // delet ok for all when new line\n    //\n    delet.addEventListener('click', (e) => {\n      // at least one priv line\n      const deletlabel = delet.closest('label');\n      const lines = this.fieldset.querySelectorAll('[data-block=\"' + this.options.target + '\"]:not([data-mod=\"remove\"])');\n      if (lines.length <= 1 && e.target.checked) {\n        delet.disabled = true;\n        delet.checked = false;\n        this.alertBox.build({\n          dismissible: true,\n          message: codemessages.oneatleast,\n          codemessage: codemessages.oneatleast,\n          type: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.alertconfig.warning,\n          parent: (e.currentTarget.id || null)\n        });\n        return;\n      } else if (e.target.checked) {\n        this.alertBox.dismissAlert(codemessages.oneatleast);\n        if (line.classList.contains('new')) {\n          line.remove();\n        } else {\n          if (deletlabel && deletlabel.dataset.restore) deletlabel.setAttribute('title', deletlabel.dataset.restore);\n          line.setAttribute('data-mod', 'remove');\n          privs.forEach(priv => {\n            priv.disabled = true;\n            priv.checked = false;\n          })\n          contact.checked = false;\n          contact.disabled = true;\n          member.disabled = true;\n        }\n      } else {\n        if (deletlabel && deletlabel.dataset.remove) deletlabel.setAttribute('title', deletlabel.dataset.remove);\n        line.removeAttribute('data-mod');\n        privs.forEach(priv => priv.disabled = false);\n        contact.disabled = false;\n        member.disabled = false;\n      }\n    });\n    // delet mouseover - explain why it is disabled when manage is checked\n    delet.addEventListener('mouseover', (e) => {\n      if (e.target.disabled) {\n        let pr = line.querySelector('input[name*=\"[' + this.options.privilege + ']\"]:checked');\n        if (!pr) return;\n        pr = pr.value.toLowerCase()\n        e.target.title = (e.target.dataset[pr]) ? e.target.dataset[pr] : e.target.title\n      }\n    })\n    // disable delet if user is the only manager\n    if (this.current_uid === member.value) delet.disabled = true;\n\n\n  }\n\n  // send clean data on submit\n  async cleanPrivileges() {\n    // check managers and contact_user_id on submit\n\n    const checkContact = async () => {\n      // check if one manager at least\n      const managers = this.fieldset.querySelectorAll('[name*=\"[' + this.options.privilege + ']\"][value=\"' + _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.rights.manage + '\"]:checked');\n      let n = managers.length;\n\n      if (n === 0) {\n        await this.alertBox.build({\n          dismissible: true,\n          message: codemessages.nomanager,\n          codeid: true,\n          type: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.alertconfig.danger,\n          parent: this.fieldset_alert_zone,\n        });\n        return false;\n      } else this.alertBox.dismissAlert(codemessages.nomanager);\n      // check contact\n      const contact = this.fieldset.querySelector('[name=\"' + this.options.contactfieldname + '\"]:checked');\n\n      if (contact === null) {\n        await this.alertBox.build({\n          dismissible: true,\n          codeid: true,\n          message: codemessages.nocontact,\n          type: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.alertconfig.danger,\n          parent: this.fieldset_alert_zone\n        });\n        return false;\n      }\n      this.alertBox.dismissAlert(codemessages.nocontact);\n      return true;\n    }\n    const hasMember = (line) => {\n      const member = line.querySelector('[name*=\"[' + this.options.ident + ']\"]');\n      return (member.value);\n    }\n    const hasPriv = (line) => {\n      const priv = line.querySelector('[name*=\"[' + this.options.privilege + ']\"]:checked');\n      if (priv && priv.value) return true;\n      return false;\n    }\n    const formatPrivilege = (line) => {\n\n      const els = line.querySelectorAll('[name*=\"members[\"');\n      els.forEach((el) => {\n        let name = el.name;\n        name = name.split('[');\n        name.pop();\n        el.name = name.join('[');\n        if (el.name.indexOf('[' + this.options.privilege + ']') > 0) {\n          el.type = 'checkbox';\n          el.classList.add('hidden');\n        }\n\n      })\n    }\n    const hascontact = await checkContact();\n    if (hascontact === true) {\n      const lines = this.fieldset.querySelectorAll('[data-block=\"' + this.options.target + '\"]');\n      let n = lines.length;\n      let verif = true;\n      for (const line of lines) {\n        if (line.dataset.mod && line.dataset.mod === 'remove') {\n          if (n > 1) {\n            line.remove();\n            n--;\n          } else return false;\n        } else if (!hasMember(line)) {\n          const lineno = line.querySelector('[name*=\"[' + this.options.ident + ']\"]');\n          lineno.focus();\n          if (lineno.tomselect) lineno.tomselect.focus();\n          await this.alertBox.build({\n            dismissible: true,\n            insertafter: true,\n            message: codemessages.emptyname,\n            codeid: true,\n            type: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.alertconfig.warning,\n            parent: line\n          });\n          const resp = false; // no confimbox just wait for user action\n          // callback when confirmbox response is chosen if 'confirm'\n          if (resp === true) {\n            if (n > 1) {\n              line.remove();\n              n--;\n            } else return false;\n\n          } else return false;\n        } else if (!hasPriv(line)) {\n          this.alertBox.dismissAlert(codemessages.emptyname);\n          await this.alertBox.build({\n            dismissible: true,\n            insertafter: true,\n            codeid: true,\n            message: codemessages.uhasnopriv,\n            type: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.alertconfig.warning,\n            parent: line\n          });\n          verif = false;\n        } else this.alertBox.dismissAlert(codemessages.uhasnopriv);\n      }\n      if (!verif) return verif;\n      for (const line of lines) {\n        formatPrivilege(line);\n      }\n\n      if (n === 0) {\n        await this.alertBox.build({\n          dismissible: true,\n          codeid: true,\n          message: codemessages.nobody,\n          type: _modules_modules_config_js__WEBPACK_IMPORTED_MODULE_4__.alertconfig.warning,\n          parent: this.fieldset_alert_zone\n        });\n        return false;\n      } else this.alertBox.dismissAlert(codemessages.nobody);\n      return true;\n    } else return false;\n  }\n  getLinePrivilege(id) {\n    let privilege = null;\n    const lines = this.fieldset.querySelectorAll('[data-block=\"' + this.options.target + '\"]')\n    for (const line of lines) {\n      if (parseInt(line.querySelector('[name*=\"[' + this.options.ident + ']\"]').value) === parseInt(id)) {\n        privilege = line;\n        break;\n      }\n    }\n\n    return privilege;\n  }\n\n  clearAll(ret = false) {\n    const lines = this.fieldset.querySelectorAll('[data-block=\"' + this.options.target + '\"]');\n    let keepindex = -1;\n    lines.forEach((line, index) => {\n      const {\n        member,\n        privs,\n        contact,\n        delet\n      } = this.getInputs(line);\n      if (this.current_uid === member.value) keepindex = index;\n      if (index > 0 || (keepindex > 0 && keepindex !== index)) line.remove();\n    });\n    //\n    console.log('keepindex', keepindex)\n    const line = this.newLine(true);\n    if (keepindex !== 0) {\n      lines[0].remove();\n      console.log('rem line0', lines)\n    }\n    if (ret === true) return line;\n  }\n\n\n}//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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Q1A7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFlBQVk7QUFDWixVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtCQUFrQixtRUFBVztBQUM3QjtBQUNBLFdBQVc7QUFDWCw4QkFBOEI7QUFDOUI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7O0FBRWQsWUFBWTtBQUNaLFVBQVU7QUFDVjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrQkFBa0IsbUVBQVc7QUFDN0I7QUFDQSxXQUFXO0FBQ1g7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsZ0JBQWdCLG1FQUFXO0FBQzNCO0FBQ0EsU0FBUztBQUNUO0FBQ0EsUUFBUTtBQUNSO0FBQ0EsTUFBTTtBQUNOO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsUUFBUTtBQUNSO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFHQSIsInNvdXJjZXMiOlsid2VicGFjazovLy8uL3NyYy9tb2R1bGVzL3Byb2plY3QtcHJpdmlsZWdlcy5qcz9kZDIzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHByaXZpbGVnZXMgb2YgYSBwcm9qZWN0XG4vLyBsaW5lIHdpdGggbWVtYmVyIG5hbWUgLCBwcml2aWxpZWdlICwgaXMgY29udGFjdCAsIGFuZCBkZWxldGUgZnVuY3Rpb25hbGl0eVxuaW1wb3J0IERPTVB1cmlmeSBmcm9tICdkb21wdXJpZnknO1xuaW1wb3J0IHtcbiAgRm9ybVN1Ym1pdCxcbn0gZnJvbSBcIi4uL21vZHVsZXMvZm9ybS1zdWJtaXQuanNcIjtcbmltcG9ydCB7XG4gIEFsZXJ0Qm94XG59IGZyb20gXCIuLi9tb2R1bGVzL2FsZXJ0LWJveGVzLmpzXCI7XG5pbXBvcnQge1xuICBKc1RvbVNlbGVjdFxufSBmcm9tIFwiLi4vbW9kdWxlcy9qcy10b20tc2VsZWN0LmpzXCI7XG5cbmltcG9ydCB7XG4gIHJpZ2h0cyxcbiAgZGVmaW5lZF9wcml2aWxlZ2VzLFxuICBhbGVydGNvbmZpZyxcbiAgY3NzXG59IGZyb20gJy4uL21vZHVsZXMvbW9kdWxlcy1jb25maWcuanMnO1xuY29uc3QgY29kZW1lc3NhZ2VzID0ge1xuICBvbmVhdGxlYXN0OiAnb25lYXRsZWFzdCcsXG4gIG5vbWFuYWdlcjogJ25vbWFuYWdlcicsXG4gIG5vY29udGFjdDogJ25vY29udGFjdCcsXG4gIHVoYXNub3ByaXY6ICd1aGFzbm9wcml2JyxcbiAgaW1wb3J0cHJpdmVycm9yOiAnaW1wb3J0cHJpdmVycm9yJyxcbiAgZW1wdHluYW1lOiAnZW1wdHluYW1lJ1xufVxubGV0IGluc3RhbmNlID0gbnVsbDtcbmV4cG9ydCBjbGFzcyBQcm9qZWN0UHJpdmlsZWdlcyB7XG4gIC8vVE9ETzogcmV3cml0ZSB0byBub3QgZGVwZW5kIG9uIERPTSBzZWxlY3RcbiAgb3B0aW9ucztcbiAgYWxlcnRCb3g7XG4gIC8vIGN1cnJlbnQgdXNlciBpZDtcbiAgY3VycmVudF91aWQ7XG4gIGZpZWxkc2V0O1xuICBmaWVsZHNldF9hbGVydF96b25lO1xuICAvLyB1bmlxdWUgdXNlcnNcbiAgY29uc3RydWN0b3Iob3B0aW9ucyA9IHt9KSB7XG4gICAgaWYgKCFpbnN0YW5jZSkge1xuICAgICAgY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gICAgICAgIGdyb3VwaWQ6IFwiI3NlY3Rpb24tcHJpdmlsZWdlc1wiLFxuICAgICAgICBzZXBhcjogJy5uZXctcHJpdmlsZWdlJyxcbiAgICAgICAgYWRkYnRuOiAnW2RhdGEtYWRkPVwiYmxvY2tcIl0nLFxuICAgICAgICB0YXJnZXQ6ICdtZW1iZXInLFxuICAgICAgICBpZGVudDogJ21lbWJlcicsXG4gICAgICAgIHByaXZpbGVnZTogJ3ByaXZpbGVnZScsXG4gICAgICAgIGRlbGV0OiAnZGVsZXQnLFxuICAgICAgICBjb250YWN0OiAnY29udGFjdCcsXG4gICAgICAgIGNvbnRhY3RmaWVsZG5hbWU6ICdjb250YWN0X3VzZXJfaWQnLFxuICAgICAgICBkb21zZWxlY3RvcnM6IHtcbiAgICAgICAgICB0YWJjb250ZW50OiAnLnRhYi1jb250ZW50J1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgdGhpcy5vcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpO1xuICAgICAgdGhpcy5maWVsZHNldCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGhpcy5vcHRpb25zLmdyb3VwaWQpO1xuICAgICAgaWYgKCF0aGlzLmZpZWxkc2V0KSByZXR1cm47XG4gICAgICB0aGlzLmZpZWxkc2V0X2FsZXJ0X3pvbmUgPSB0aGlzLmZpZWxkc2V0LnF1ZXJ5U2VsZWN0b3IodGhpcy5vcHRpb25zLmRvbXNlbGVjdG9ycy50YWJjb250ZW50KSA/IHRoaXMuZmllbGRzZXQucXVlcnlTZWxlY3Rvcih0aGlzLm9wdGlvbnMuZG9tc2VsZWN0b3JzLnRhYmNvbnRlbnQpIDogdGhpcy5maWVsZHNldDtcbiAgICAgIHRoaXMub3B0aW9ucy5zZXBhciA9IHRoaXMub3B0aW9ucy5zZXBhciBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ID8gdGhpcy5vcHRpb25zLnNlcGFyIDogKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGhpcy5vcHRpb25zLnNlcGFyKSA/IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodGhpcy5vcHRpb25zLnNlcGFyKSA6IG51bGwpO1xuICAgICAgdGhpcy5vcHRpb25zLmFkZGJ0biA9IHRoaXMub3B0aW9ucy5hZGRidG4gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IHRoaXMub3B0aW9ucy5hZGRidG4gOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHRoaXMub3B0aW9ucy5hZGRidG4pO1xuICAgICAgaWYgKHRoaXMub3B0aW9ucy5hZGRidG4pIHRoaXMuYWRkTGlzdGVuZXIoKTtcbiAgICAgIGNvbnN0IGxpbmVzID0gdGhpcy5maWVsZHNldC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1ibG9jaz1cIicgKyB0aGlzLm9wdGlvbnMudGFyZ2V0ICsgJ1wiXScpO1xuICAgICAgdGhpcy5jdXJyZW50X3VpZCA9IHRoaXMuZmllbGRzZXQuZGF0YXNldC51O1xuICAgICAgdGhpcy5hbGVydEJveCA9IG5ldyBBbGVydEJveCgpO1xuICAgICAgbGluZXMuZm9yRWFjaCgobGluZSkgPT4ge1xuICAgICAgICB0aGlzLmFjdGl2YXRlRXZlbnRzKGxpbmUpO1xuICAgICAgfSk7XG5cbiAgICAgIC8vcmVtb3ZlIGRlbGV0ZWQgLCBjbGVhbiAmJiB2YWxpZGF0ZSBkYXRhcyAsIGZvcm1hdCBuYW1lcyBiZWZvcmUgc2VuZGluZyB0aGUgZm9ybVxuICAgICAgY29uc3QgZm9ybSA9IHRoaXMuZmllbGRzZXQuY2xvc2VzdCgnZm9ybScpO1xuICAgICAgY29uc3QgZm9ybVN1Ym1pdCA9IG5ldyBGb3JtU3VibWl0KGZvcm0pO1xuICAgICAgLy8gaGFuZGxlciAtIHZlcmlmeSBwcml2aWxlZ2VzIGJlZm9yZSBzZXR0aW5ncyBmb3JtIHN1Ym1pdFxuICAgICAgY29uc3Qgc3VibWl0X3ByaXZpbGVnZXMgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3AgPSBhd2FpdCB0aGlzLmNsZWFuUHJpdmlsZWdlcygpO1xuICAgICAgICByZXR1cm4gcmVzcDtcbiAgICAgIH1cbiAgICAgIGZvcm1TdWJtaXQuYWRkSGFuZGxlcihzdWJtaXRfcHJpdmlsZWdlcyk7XG4gICAgICBpbnN0YW5jZSA9IHRoaXM7XG4gICAgfVxuICAgIHJldHVybiBpbnN0YW5jZTtcbiAgfVxuXG4gIG5ld0xpbmUocmV0ID0gZmFsc2UsIGNoZWNrID0gMCkge1xuICAgIGxldCBsaW5lO1xuICAgIGlmIChjaGVjayA+IDApIHtcbiAgICAgIGxpbmUgPSB0aGlzLmdldExpbmVQcml2aWxlZ2UoY2hlY2spO1xuICAgICAgaWYgKGxpbmUpIHJldHVybiBsaW5lO1xuICAgIH1cbiAgICBjb25zdCBsaW5lcyA9IHRoaXMuZmllbGRzZXQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtYmxvY2s9XCInICsgdGhpcy5vcHRpb25zLnRhcmdldCArICdcIl0nKTtcblxuICAgIGlmIChsaW5lcy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICBjb25zdCBuID0gbGluZXMubGVuZ3RoIC0gMTtcbiAgICBsaW5lID0gbGluZXNbbl07XG4gICAgaWYgKGxpbmUgIT09IG51bGwpIHtcbiAgICAgIGxpbmUgPSB0aGlzLmNsZWFyTGluZShsaW5lLmNsb25lTm9kZSh0cnVlKSwgbiwgKHRoaXMub3B0aW9ucy5zZXBhciA/IHRoaXMub3B0aW9ucy5zZXBhciA6IGxpbmUpKTtcblxuICAgICAgdGhpcy5hY3RpdmF0ZUV2ZW50cyhsaW5lKTtcblxuICAgIH1cbiAgICBpZiAocmV0ID09PSB0cnVlKSByZXR1cm4gbGluZTtcbiAgfVxuXG4gIGFkZExpc3RlbmVyKCkge1xuICAgIHRoaXMub3B0aW9ucy50YXJnZXQgPSAodGhpcy5vcHRpb25zLmFkZGJ0bi5kYXRhc2V0LnRhcmdldCkgPyB0aGlzLm9wdGlvbnMuYWRkYnRuLmRhdGFzZXQudGFyZ2V0IDogdGhpcy5vcHRpb25zLnRhcmdldDtcbiAgICB0aGlzLm9wdGlvbnMuYWRkYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKGUpID0+IHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIHRoaXMubmV3TGluZSgpO1xuICAgIH0pXG4gIH1cblxuICBjbGVhckxpbmUobGluZSwgbiwgc2VwYXIgPSBudWxsKSB7XG4gICAgLypjbGVhbiBsaW5lIGVsZW1lbnQgKi9cblxuICAgIGxldCBoYXNfYXV0b2NvbXBsZXRlID0gbnVsbDtcbiAgICBsaW5lLmRhdGFzZXQubW9kID0gJyc7XG4gICAgbGluZS5kaXNhYmxlZCA9IGZhbHNlO1xuICAgIGNvbnN0IGVsZW1zID0gbGluZS5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1lbGVtXScpO1xuICAgIGVsZW1zLmZvckVhY2goKGVsZW0pID0+IHtcbiAgICAgIC8vIGNoYW5nZSBsb29wIGluZGV4IC0gbmVjZXNzYXJ5IGZvciB0YWlsd2luZGNzcyBwZWVyY2hlY2tlZCB0byB3b3JrIG90aGVyd2lzZSBub3QgaWYgbmFtZSBlbmRzIHdpdGggW11cbiAgICAgIC8vcmVtb3ZlIGNvbXBvbmVudHNcbiAgICAgIGNvbnN0IHJtcyA9IGVsZW0ucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtY29tcG9uZW50XScpXG4gICAgICBybXMuZm9yRWFjaCgocm0pID0+IHtcbiAgICAgICAgc3dpdGNoIChybS5kYXRhc2V0LmNvbXBvbmVudCkge1xuICAgICAgICAgIGNhc2UgJ3RvbS1zZWxlY3QnOlxuICAgICAgICAgICAgcm0ucmVtb3ZlKCk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC8vIGNsZWFuIGFuZCByZXNldCBldmVudHNcbiAgICAgIGNvbnN0IGVscyA9IGVsZW0ucXVlcnlTZWxlY3RvckFsbCgnaW5wdXQsIHNlbGVjdCwgbGFiZWwnKTtcbiAgICAgIGVscy5mb3JFYWNoKChlbCkgPT4ge1xuXG4gICAgICAgIGVsLmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgIGlmIChzZXBhcikgeyAvLyBjaGFuZ2UgbmFtZXMgYW5kIGlkIHdoZW4gYWRkaW5nIGEgbmV3IHJvdyAtIG5vdCBpZiBjbGVhciBvbmx5XG4gICAgICAgICAgY29uc3Qga2V5cyA9IFsnaWQnLCAnZm9yJywgJ2FyaWEtY29udHJvbHMnLCAnbmFtZSddO1xuICAgICAgICAgIGtleXMuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICBsZXQgdmFsID0gZWwuZ2V0QXR0cmlidXRlKGtleSk7XG4gICAgICAgICAgICBpZiAodmFsICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIGlmIChrZXkgPT09ICduYW1lJykgdmFsID0gdmFsLnJlcGxhY2UoJ1snICsgbiArICddJywgJ1snICsgKG4gKyAxKSArICddJyk7XG4gICAgICAgICAgICAgIGVsc2UgdmFsID0gdmFsLnJlcGxhY2UoJ18nICsgbiwgJ18nICsgKG4gKyAxKSk7XG4gICAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIHZhbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgc3dpdGNoIChlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgICBjYXNlICdpbnB1dCc6XG4gICAgICAgICAgICAvL2VsLmluZGV0ZXJtaW5hdGUgPSB0cnVlO1xuICAgICAgICAgICAgZWwuY2hlY2tlZCA9IGZhbHNlO1xuICAgICAgICAgICAgLy8gZGlzYWJsZSBjb250YWN0IGFzIHByaXZpbGVnZSBpcyBlbXB0eVxuICAgICAgICAgICAgaWYgKGVsLm5hbWUgPT0gdGhpcy5vcHRpb25zLmNvbnRhY3RmaWVsZG5hbWUpIHtcbiAgICAgICAgICAgICAgZWwudmFsdWUgPSBcIjBcIjtcbiAgICAgICAgICAgICAgZWwuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnc2VsZWN0JzpcbiAgICAgICAgICAgIGVsLnNlbGVjdGVkSW5kZXggPSAtMTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ2xhYmVsJzpcbiAgICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoY3NzLnBlZXJjaGVja2VkKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGlmIChlbC50b21zZWxlY3QpIHtcbiAgICAgICAgICBoYXNfYXV0b2NvbXBsZXRlID0gZWw7XG4gICAgICAgICAgZWwudG9tc2VsZWN0LmNsZWFyKCk7XG4gICAgICAgICAgZWwudG9tc2VsZWN0LmRlc3Ryb3koKTtcblxuICAgICAgICB9XG4gICAgICAgIGlmIChlbC5jbGFzc0xpc3QuY29udGFpbnMoY3NzLmNvbXBvbmVudC5hdXRvY29tcGxldGUudG9tc2VsZWN0ZWQpKSB7XG4gICAgICAgICAgaGFzX2F1dG9jb21wbGV0ZSA9IGVsO1xuICAgICAgICAgIGVsLmNsYXNzTGlzdC5mb3JFYWNoKGNsID0+IHtcbiAgICAgICAgICAgIGlmIChjbC5pbmRleE9mKCd0cy0nKSA9PSAwKSBlbC5jbGFzc0xpc3QucmVtb3ZlKGNsKTtcbiAgICAgICAgICB9KVxuICAgICAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoY3NzLmNvbXBvbmVudC5hdXRvY29tcGxldGUudG9tc2VsZWN0ZWQpO1xuICAgICAgICAgIGlmIChlbC50eXBlID09IFwic2VsZWN0LW9uZVwiKSBkZWxldGUgZWwudHlwZTtcblxuICAgICAgICB9XG5cbiAgICAgIH0pXG5cbiAgICB9KVxuICAgIC8qIGFkZCBmdW5jdGlvbm5hbGl0aWVzICovXG4gICAgaWYgKHNlcGFyKSB7XG4gICAgICBsaW5lLmNsYXNzTGlzdC5hZGQoJ25ldycpO1xuICAgICAgc2VwYXIuYWZ0ZXIobGluZSk7XG4gICAgfVxuICAgIC8qIGNsZWFyIGFuZCBhZGQgdG9tLXNlbGVjdCBmdW5jdGlvbmFsaXRpZXMgLSBvbmx5IGFmdGVyIGFkZGluZyBsaW5lIHRvIHRoZSBkb20qL1xuICAgIGlmIChoYXNfYXV0b2NvbXBsZXRlICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBqc1RvbVNlbGVjdCA9IG5ldyBKc1RvbVNlbGVjdCgpO1xuICAgICAganNUb21TZWxlY3QuYXBwbHlUbyhoYXNfYXV0b2NvbXBsZXRlKTtcbiAgICAgIGhhc19hdXRvY29tcGxldGUudG9tc2VsZWN0LmNsZWFyT3B0aW9ucygpO1xuICAgICAgbGV0IG9wdGlvbnMgPSB0aGlzLmZpZWxkc2V0LmRhdGFzZXQub3B0aW9ucztcbiAgICAgIG9wdGlvbnMgPSAob3B0aW9ucykgPyBvcHRpb25zIDogW107XG4gICAgICBoYXNfYXV0b2NvbXBsZXRlLnRvbXNlbGVjdC5hZGRPcHRpb25zKG9wdGlvbnMpO1xuICAgIH07XG5cblxuICAgIHJldHVybiBsaW5lO1xuICB9XG5cbiAgc2V0TGluZShsaW5lLCBtYiA9IHtcbiAgICBrZXk6ICcnLFxuICAgIHZhbHVlOiAnJ1xuICB9LCBwcml2LCBjdCkge1xuXG4gICAgcHJpdiA9IGRlZmluZWRfcHJpdmlsZWdlc1twcml2XSA/IGRlZmluZWRfcHJpdmlsZWdlc1twcml2XSA6IGRlZmluZWRfcHJpdmlsZWdlcy52aWV3ZXJzO1xuICAgIGlmICghcHJpdikgcmV0dXJuO1xuICAgIGNvbnN0IHtcbiAgICAgIG1lbWJlcixcbiAgICAgIHByaXZzLFxuICAgICAgY29udGFjdCxcbiAgICAgIGRlbGV0XG4gICAgfSA9IHRoaXMuZ2V0SW5wdXRzKGxpbmUsIHByaXYpO1xuICAgIGlmICghbWVtYmVyIHx8ICFwcml2cyB8fCAhY29udGFjdCB8fCAhZGVsZXQpIHJldHVybjtcblxuICAgIC8vIHNhbml0aXplXG4gICAgbWIua2V5ID0gRE9NUHVyaWZ5LnNhbml0aXplKG1iLmtleSk7XG4gICAgbWIudmFsdWUgPSBET01QdXJpZnkuc2FuaXRpemUobWIudmFsdWUpO1xuICAgIGNvbnN0IHRzID0gbWVtYmVyLnRvbXNlbGVjdDtcbiAgICBpZiAodHMpIHtcbiAgICAgIHRzLmNsZWFyKCk7XG4gICAgICBjb25zdCBhZGRtYiA9IHt9XG4gICAgICBhZGRtYlt0cy5zZXR0aW5ncy52YWx1ZUZpZWxkXSA9IG1iLmtleTtcbiAgICAgIGFkZG1iW3RzLnNldHRpbmdzLmxhYmVsRmllbGRdID0gYWRkbWJbdHMuc2V0dGluZ3Muc2VhcmNoRmllbGRdID0gbWIudmFsdWU7XG4gICAgICB0cy5hZGRPcHRpb24oYWRkbWIpO1xuICAgICAgdHMuc2V0VmFsdWUoW21iLmtleV0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBzZWxlY3RlZCA9IG1lbWJlci5xdWVyeVNlbGVjdG9yKCdzZWxlY3Qgb3B0aW9uW3ZhbHVlPVwiJyArIG1iLmtleSArICdcIl0nKTtcbiAgICAgIGlmIChzZWxlY3RlZCkgc2VsZWN0ZWQuc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgZWxzZSBtZW1iZXIuaW5zZXJ0QWRqYWNlbnRIVE1MKCdiZWZvcmVlbmQnLCAnPG9wdGlvbiB2YWx1ZT1cIicgKyBtYi5rZXkgKyAnXCIgc2VsZWN0ZWQ+JyArIG1iLnZhbHVlICsgJzwvb3B0aW9uPicpO1xuXG4gICAgfVxuICAgIHByaXZzLmNoZWNrZWQgPSB0cnVlO1xuICAgIGNvbnRhY3QudmFsdWUgPSBtYi5rZXk7XG4gICAgaWYgKHByaXYgPT09IHJpZ2h0cy5tYW5hZ2UpIHtcbiAgICAgIGNvbnRhY3QuZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgIGlmIChjdCA9PT0gdHJ1ZSkgY29udGFjdC5jaGVja2VkID0gdHJ1ZTtcbiAgICB9XG5cbiAgfVxuICBnZXRJbnB1dHMobGluZSwgcHJpdiA9IGZhbHNlKSB7XG4gICAgY29uc3QgbWVtYmVyID0gbGluZS5xdWVyeVNlbGVjdG9yKFwiW25hbWUqPSdbXCIgKyB0aGlzLm9wdGlvbnMuaWRlbnQgKyBcIl0nXVwiKTtcbiAgICBsZXQgcHJpdnM7XG4gICAgaWYgKHByaXYpIHtcbiAgICAgIHByaXZzID0gbGluZS5xdWVyeVNlbGVjdG9yKCdpbnB1dFtuYW1lKj1cIlsnICsgdGhpcy5vcHRpb25zLnByaXZpbGVnZSArICddXCJdW3ZhbHVlPVwiJyArIHByaXYgKyAnXCJdJyk7XG4gICAgfSBlbHNlIHByaXZzID0gbGluZS5xdWVyeVNlbGVjdG9yQWxsKCdpbnB1dFtuYW1lKj1cIlsnICsgdGhpcy5vcHRpb25zLnByaXZpbGVnZSArICddXCJdJyk7XG4gICAgY29uc3QgY29udGFjdCA9IGxpbmUucXVlcnlTZWxlY3RvcignaW5wdXRbbmFtZT1cIicgKyB0aGlzLm9wdGlvbnMuY29udGFjdGZpZWxkbmFtZSArICdcIl0nKTtcbiAgICBjb25zdCBkZWxldCA9IGxpbmUucXVlcnlTZWxlY3RvcihcImlucHV0W25hbWUqPSdbXCIgKyB0aGlzLm9wdGlvbnMuZGVsZXQgKyBcIl0nXVwiKTtcblxuICAgIHJldHVybiB7XG4gICAgICBtZW1iZXI6IG1lbWJlcixcbiAgICAgIHByaXZzOiBwcml2cyxcbiAgICAgIGNvbnRhY3Q6IGNvbnRhY3QsXG4gICAgICBkZWxldDogZGVsZXRcbiAgICB9O1xuICB9XG4gIGFzeW5jIGltcG9ydFByaXZpbGVnZXMocHJpdmlsZWdlcywgcmVwbGFjZSA9IGZhbHNlLCBjb250YWN0ID0gbnVsbCwgaW1wb3J0ZWR0YWcgPSBudWxsLCBkaXNtaXNzID0gbnVsbCkge1xuICAgIGxldCBsYXN0bGluZSA9ICFyZXBsYWNlO1xuXG4gICAgdHJ5IHtcbiAgICAgIE9iamVjdC5lbnRyaWVzKHByaXZpbGVnZXMpLmZvckVhY2goKFtwcml2LCBtZW1iZXJzXSkgPT4ge1xuICAgICAgICBtZW1iZXJzLmZvckVhY2goKG1lbWJlcikgPT4ge1xuICAgICAgICAgIGlmICghbGFzdGxpbmUpIGxhc3RsaW5lID0gdGhpcy5jbGVhckFsbCh0cnVlKTtcbiAgICAgICAgICBlbHNlIGxhc3RsaW5lID0gdGhpcy5uZXdMaW5lKHRydWUsIG1lbWJlci5pZCk7XG4gICAgICAgICAgaWYgKGxhc3RsaW5lKSB7XG4gICAgICAgICAgICB0aGlzLnNldExpbmUobGFzdGxpbmUsIHtcbiAgICAgICAgICAgICAga2V5OiBtZW1iZXIuaWQsXG4gICAgICAgICAgICAgIHZhbHVlOiBtZW1iZXIubmFtZSxcbiAgICAgICAgICAgIH0sIHByaXYsIChjb250YWN0ICYmIChwYXJzZUludChjb250YWN0LmlkKSA9PT0gcGFyc2VJbnQobWVtYmVyLmlkKSkpKTtcbiAgICAgICAgICAgIGlmIChpbXBvcnRlZHRhZykgaW1wb3J0ZWR0YWcobGFzdGxpbmUpO1xuXG4gICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuXG4gICAgICB9KTtcbiAgICAgIGlmIChkaXNtaXNzKSBkaXNtaXNzKCk7XG4gICAgICB0aGlzLmFsZXJ0Qm94LmRpc21pc3NBbGVydChjb2RlbWVzc2FnZXMuaW1wb3J0cHJpdmVycm9yKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgYXdhaXQgdGhpcy5hbGVydEJveC5idWlsZCh7XG4gICAgICAgIGRpc21pc3NpYmxlOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiBjb2RlbWVzc2FnZXMuaW1wb3J0cHJpdmVycm9yLFxuICAgICAgICBjb2RlaWQ6IHRydWUsXG4gICAgICAgIHBhcmVudDogdGhpcy5maWVsZHNldF9hbGVydF96b25lLFxuICAgICAgICB0eXBlOiBhbGVydGNvbmZpZy5kYW5nZXIsXG4gICAgICB9KTtcbiAgICAgIGNvbnNvbGUubG9nKCdlcnInLCBlcnIpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuICBhY3RpdmF0ZUV2ZW50cyhsaW5lKSB7XG4gICAgaWYgKCFsaW5lKSByZXR1cm47XG4gICAgY29uc3Qge1xuICAgICAgbWVtYmVyLFxuICAgICAgcHJpdnMsXG4gICAgICBjb250YWN0LFxuICAgICAgZGVsZXRcbiAgICB9ID0gdGhpcy5nZXRJbnB1dHMobGluZSk7XG4gICAgaWYgKCFtZW1iZXIgfHwgIXByaXZzIHx8ICFjb250YWN0IHx8ICFkZWxldCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBzaWJsaW5ncyA9IHMgPT4gWy4uLnMucGFyZW50RWxlbWVudC5jaGlsZHJlbl0uZmlsdGVyKGMgPT4gYy5ub2RlVHlwZSA9PSAxICYmIGMgIT0gcyAmJiBjLmNsYXNzTGlzdC5jb250YWlucygncm93JykgJiYgYy5kYXRhc2V0LmJsb2NrICE9PSBudWxsICYmIGMuZGF0YXNldC5ibG9jayA9PT0gdGhpcy5vcHRpb25zLnRhcmdldCk7XG5cbiAgICAvLyBlbmFibGUvZGlzYWJsZSBjb250YWN0IHdoZW4gcHJpdmlsZWdlIGNoYW5nZXNcbiAgICBjb25zdCBsaW5lU2V0dGluZ3MgPSAocHIsIGN0LCBkbCwgc3luY2hybyA9IGZhbHNlKSA9PiB7XG5cbiAgICAgIGlmIChwciAmJiBwci52YWx1ZSA9PT0gcmlnaHRzLm1hbmFnZSkge1xuICAgICAgICAvLyBtYW5hZ2VyIC0gY2FuJ3QgZGVsZXRlIGxpbmUgLSBjYW4gY2hvb3NlIGFzIGNvbnRhY3RcbiAgICAgICAgZGwuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICBjdC5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICAvLyBkaXNtaXNzIHJlbGF0ZWQgYWxlcnRcbiAgICAgICAgdGhpcy5hbGVydEJveC5kaXNtaXNzQWxlcnQoY29kZW1lc3NhZ2VzLm5vbWFuYWdlcik7XG4gICAgICAgIGlmIChjdC5jaGVja2VkKSB7XG4gICAgICAgICAgdGhpcy5hbGVydEJveC5kaXNtaXNzQWxlcnQoY29kZW1lc3NhZ2VzLm5vY29udGFjdCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIG5vdCBtYW5hZ2VyIC0gY2FuIGRlbGV0IGxpbmUgLSBjYW5ub3QgY2hvc2UgYXMgY29udGFjdFxuICAgICAgICAvLyAgaWYgKGN0LmNoZWNrZWQgPT09IHRydWUpIGN0LmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCdjbGljaycpKTtcbiAgICAgICAgY3QuY2hlY2tlZCA9IGZhbHNlO1xuICAgICAgICBkbC5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICBjdC5kaXNhYmxlZCA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChzeW5jaHJvID09PSB0cnVlKSB7XG4gICAgICAgIHN5bmNocm9TaWJsaW5ncyhsaW5lKTtcbiAgICAgIH1cbiAgICAgIC8vIGRpc21pc3MgYWxlcnRzXG4gICAgICBpZiAoIWRsLmNrZWNrZWQpIHtcbiAgICAgICAgdGhpcy5hbGVydEJveC5kaXNtaXNzQWxlcnQoY29kZW1lc3NhZ2VzLm5vYm9keSk7XG4gICAgICAgIHRoaXMuYWxlcnRCb3guZGlzbWlzc0FsZXJ0KGNvZGVtZXNzYWdlcy5vbmVhdGxlYXN0KTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3Qgc3luY2hyb1NpYmxpbmdzID0gKGxpbmUpID0+IHtcbiAgICAgIGNvbnN0IGxucyA9IHNpYmxpbmdzKGxpbmUpO1xuICAgICAgbG5zLmZvckVhY2goKGxuKSA9PiB7XG4gICAgICAgIGNvbnN0IGRsID0gbG4ucXVlcnlTZWxlY3RvcihcImlucHV0W25hbWUqPSdbXCIgKyB0aGlzLm9wdGlvbnMuZGVsZXQgKyBcIl0nXVwiKTtcbiAgICAgICAgY29uc3QgY3QgPSBsbi5xdWVyeVNlbGVjdG9yKCdpbnB1dFtuYW1lPVwiJyArIHRoaXMub3B0aW9ucy5jb250YWN0ZmllbGRuYW1lICsgJ1wiXScpO1xuICAgICAgICBjb25zdCBwciA9IGxuLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W25hbWUqPVwiWycgKyB0aGlzLm9wdGlvbnMucHJpdmlsZWdlICsgJ11cIl06Y2hlY2tlZCcpO1xuICAgICAgICBsaW5lU2V0dGluZ3MocHIsIGN0LCBkbCwgZmFsc2UpO1xuXG4gICAgICB9KVxuICAgIH1cblxuICAgIG1lbWJlci5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4ge1xuICAgICAgY29udGFjdC52YWx1ZSA9IG1lbWJlci52YWx1ZTtcbiAgICAgIC8vIGRpc21pc3MgYWxlcnRcbiAgICAgIGlmIChtZW1iZXIudmFsdWUpIHtcbiAgICAgICAgdGhpcy5hbGVydEJveC5kaXNtaXNzQWxlcnQoY29kZW1lc3NhZ2VzLmVtcHR5bmFtZSk7XG4gICAgICAgIHRoaXMuYWxlcnRCb3guZGlzbWlzc0FsZXJ0KGNvZGVtZXNzYWdlcy5vbmVhdGxlYXN0KTtcbiAgICAgICAgdGhpcy5hbGVydEJveC5kaXNtaXNzQWxlcnQoY29kZW1lc3NhZ2VzLm5vYm9keSk7XG4gICAgICB9XG4gICAgfSlcblxuICAgIHByaXZzLmZvckVhY2goKHByaXYpID0+IHtcbiAgICAgIHByaXYuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGUpID0+IHtcbiAgICAgICAgaWYgKHByaXYuY2hlY2tlZCkgbGluZVNldHRpbmdzKHByaXYsIGNvbnRhY3QsIGRlbGV0LCBmYWxzZSk7XG4gICAgICB9KTtcblxuICAgICAgaWYgKHByaXYuY2hlY2tlZCkgbGluZVNldHRpbmdzKHByaXYsIGNvbnRhY3QsIGRlbGV0LCBmYWxzZSk7XG4gICAgfSlcblxuICAgIGNvbnRhY3QuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgKGUpID0+IHtcbiAgICAgIGlmIChlLnRhcmdldC5jaGVja2VkKSBkZWxldC5kaXNhYmxlZCA9IHRydWU7XG4gICAgICBlbHNlIGRlbGV0LmRpc2FibGVkID0gZmFsc2U7XG4gICAgICBjb25zdCBwcml2ID0gbGluZS5xdWVyeVNlbGVjdG9yKCdpbnB1dFtuYW1lKj1cIlsnICsgdGhpcy5vcHRpb25zLnByaXZpbGVnZSArICddXCJdOmNoZWNrZWQnKTtcbiAgICAgIGxpbmVTZXR0aW5ncyhwcml2LCBjb250YWN0LCBkZWxldCwgdHJ1ZSk7XG4gICAgICAvLyBlbmFibGUgb3RoZXJ3aXNlXG5cbiAgICB9KVxuXG4gICAgLy8gZGVsZXQgb2sgZm9yIGFsbCB3aGVuIG5ldyBsaW5lXG4gICAgLy9cbiAgICBkZWxldC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XG4gICAgICAvLyBhdCBsZWFzdCBvbmUgcHJpdiBsaW5lXG4gICAgICBjb25zdCBkZWxldGxhYmVsID0gZGVsZXQuY2xvc2VzdCgnbGFiZWwnKTtcbiAgICAgIGNvbnN0IGxpbmVzID0gdGhpcy5maWVsZHNldC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1ibG9jaz1cIicgKyB0aGlzLm9wdGlvbnMudGFyZ2V0ICsgJ1wiXTpub3QoW2RhdGEtbW9kPVwicmVtb3ZlXCJdKScpO1xuICAgICAgaWYgKGxpbmVzLmxlbmd0aCA8PSAxICYmIGUudGFyZ2V0LmNoZWNrZWQpIHtcbiAgICAgICAgZGVsZXQuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICBkZWxldC5jaGVja2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuYWxlcnRCb3guYnVpbGQoe1xuICAgICAgICAgIGRpc21pc3NpYmxlOiB0cnVlLFxuICAgICAgICAgIG1lc3NhZ2U6IGNvZGVtZXNzYWdlcy5vbmVhdGxlYXN0LFxuICAgICAgICAgIGNvZGVtZXNzYWdlOiBjb2RlbWVzc2FnZXMub25lYXRsZWFzdCxcbiAgICAgICAgICB0eXBlOiBhbGVydGNvbmZpZy53YXJuaW5nLFxuICAgICAgICAgIHBhcmVudDogKGUuY3VycmVudFRhcmdldC5pZCB8fCBudWxsKVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfSBlbHNlIGlmIChlLnRhcmdldC5jaGVja2VkKSB7XG4gICAgICAgIHRoaXMuYWxlcnRCb3guZGlzbWlzc0FsZXJ0KGNvZGVtZXNzYWdlcy5vbmVhdGxlYXN0KTtcbiAgICAgICAgaWYgKGxpbmUuY2xhc3NMaXN0LmNvbnRhaW5zKCduZXcnKSkge1xuICAgICAgICAgIGxpbmUucmVtb3ZlKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKGRlbGV0bGFiZWwgJiYgZGVsZXRsYWJlbC5kYXRhc2V0LnJlc3RvcmUpIGRlbGV0bGFiZWwuc2V0QXR0cmlidXRlKCd0aXRsZScsIGRlbGV0bGFiZWwuZGF0YXNldC5yZXN0b3JlKTtcbiAgICAgICAgICBsaW5lLnNldEF0dHJpYnV0ZSgnZGF0YS1tb2QnLCAncmVtb3ZlJyk7XG4gICAgICAgICAgcHJpdnMuZm9yRWFjaChwcml2ID0+IHtcbiAgICAgICAgICAgIHByaXYuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgcHJpdi5jaGVja2VkID0gZmFsc2U7XG4gICAgICAgICAgfSlcbiAgICAgICAgICBjb250YWN0LmNoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgICBjb250YWN0LmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgICBtZW1iZXIuZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoZGVsZXRsYWJlbCAmJiBkZWxldGxhYmVsLmRhdGFzZXQucmVtb3ZlKSBkZWxldGxhYmVsLnNldEF0dHJpYnV0ZSgndGl0bGUnLCBkZWxldGxhYmVsLmRhdGFzZXQucmVtb3ZlKTtcbiAgICAgICAgbGluZS5yZW1vdmVBdHRyaWJ1dGUoJ2RhdGEtbW9kJyk7XG4gICAgICAgIHByaXZzLmZvckVhY2gocHJpdiA9PiBwcml2LmRpc2FibGVkID0gZmFsc2UpO1xuICAgICAgICBjb250YWN0LmRpc2FibGVkID0gZmFsc2U7XG4gICAgICAgIG1lbWJlci5kaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIC8vIGRlbGV0IG1vdXNlb3ZlciAtIGV4cGxhaW4gd2h5IGl0IGlzIGRpc2FibGVkIHdoZW4gbWFuYWdlIGlzIGNoZWNrZWRcbiAgICBkZWxldC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW92ZXInLCAoZSkgPT4ge1xuICAgICAgaWYgKGUudGFyZ2V0LmRpc2FibGVkKSB7XG4gICAgICAgIGxldCBwciA9IGxpbmUucXVlcnlTZWxlY3RvcignaW5wdXRbbmFtZSo9XCJbJyArIHRoaXMub3B0aW9ucy5wcml2aWxlZ2UgKyAnXVwiXTpjaGVja2VkJyk7XG4gICAgICAgIGlmICghcHIpIHJldHVybjtcbiAgICAgICAgcHIgPSBwci52YWx1ZS50b0xvd2VyQ2FzZSgpXG4gICAgICAgIGUudGFyZ2V0LnRpdGxlID0gKGUudGFyZ2V0LmRhdGFzZXRbcHJdKSA/IGUudGFyZ2V0LmRhdGFzZXRbcHJdIDogZS50YXJnZXQudGl0bGVcbiAgICAgIH1cbiAgICB9KVxuICAgIC8vIGRpc2FibGUgZGVsZXQgaWYgdXNlciBpcyB0aGUgb25seSBtYW5hZ2VyXG4gICAgaWYgKHRoaXMuY3VycmVudF91aWQgPT09IG1lbWJlci52YWx1ZSkgZGVsZXQuZGlzYWJsZWQgPSB0cnVlO1xuXG5cbiAgfVxuXG4gIC8vIHNlbmQgY2xlYW4gZGF0YSBvbiBzdWJtaXRcbiAgYXN5bmMgY2xlYW5Qcml2aWxlZ2VzKCkge1xuICAgIC8vIGNoZWNrIG1hbmFnZXJzIGFuZCBjb250YWN0X3VzZXJfaWQgb24gc3VibWl0XG5cbiAgICBjb25zdCBjaGVja0NvbnRhY3QgPSBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBjaGVjayBpZiBvbmUgbWFuYWdlciBhdCBsZWFzdFxuICAgICAgY29uc3QgbWFuYWdlcnMgPSB0aGlzLmZpZWxkc2V0LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tuYW1lKj1cIlsnICsgdGhpcy5vcHRpb25zLnByaXZpbGVnZSArICddXCJdW3ZhbHVlPVwiJyArIHJpZ2h0cy5tYW5hZ2UgKyAnXCJdOmNoZWNrZWQnKTtcbiAgICAgIGxldCBuID0gbWFuYWdlcnMubGVuZ3RoO1xuXG4gICAgICBpZiAobiA9PT0gMCkge1xuICAgICAgICBhd2FpdCB0aGlzLmFsZXJ0Qm94LmJ1aWxkKHtcbiAgICAgICAgICBkaXNtaXNzaWJsZTogdHJ1ZSxcbiAgICAgICAgICBtZXNzYWdlOiBjb2RlbWVzc2FnZXMubm9tYW5hZ2VyLFxuICAgICAgICAgIGNvZGVpZDogdHJ1ZSxcbiAgICAgICAgICB0eXBlOiBhbGVydGNvbmZpZy5kYW5nZXIsXG4gICAgICAgICAgcGFyZW50OiB0aGlzLmZpZWxkc2V0X2FsZXJ0X3pvbmUsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9IGVsc2UgdGhpcy5hbGVydEJveC5kaXNtaXNzQWxlcnQoY29kZW1lc3NhZ2VzLm5vbWFuYWdlcik7XG4gICAgICAvLyBjaGVjayBjb250YWN0XG4gICAgICBjb25zdCBjb250YWN0ID0gdGhpcy5maWVsZHNldC5xdWVyeVNlbGVjdG9yKCdbbmFtZT1cIicgKyB0aGlzLm9wdGlvbnMuY29udGFjdGZpZWxkbmFtZSArICdcIl06Y2hlY2tlZCcpO1xuXG4gICAgICBpZiAoY29udGFjdCA9PT0gbnVsbCkge1xuICAgICAgICBhd2FpdCB0aGlzLmFsZXJ0Qm94LmJ1aWxkKHtcbiAgICAgICAgICBkaXNtaXNzaWJsZTogdHJ1ZSxcbiAgICAgICAgICBjb2RlaWQ6IHRydWUsXG4gICAgICAgICAgbWVzc2FnZTogY29kZW1lc3NhZ2VzLm5vY29udGFjdCxcbiAgICAgICAgICB0eXBlOiBhbGVydGNvbmZpZy5kYW5nZXIsXG4gICAgICAgICAgcGFyZW50OiB0aGlzLmZpZWxkc2V0X2FsZXJ0X3pvbmVcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYWxlcnRCb3guZGlzbWlzc0FsZXJ0KGNvZGVtZXNzYWdlcy5ub2NvbnRhY3QpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGNvbnN0IGhhc01lbWJlciA9IChsaW5lKSA9PiB7XG4gICAgICBjb25zdCBtZW1iZXIgPSBsaW5lLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lKj1cIlsnICsgdGhpcy5vcHRpb25zLmlkZW50ICsgJ11cIl0nKTtcbiAgICAgIHJldHVybiAobWVtYmVyLnZhbHVlKTtcbiAgICB9XG4gICAgY29uc3QgaGFzUHJpdiA9IChsaW5lKSA9PiB7XG4gICAgICBjb25zdCBwcml2ID0gbGluZS5xdWVyeVNlbGVjdG9yKCdbbmFtZSo9XCJbJyArIHRoaXMub3B0aW9ucy5wcml2aWxlZ2UgKyAnXVwiXTpjaGVja2VkJyk7XG4gICAgICBpZiAocHJpdiAmJiBwcml2LnZhbHVlKSByZXR1cm4gdHJ1ZTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgZm9ybWF0UHJpdmlsZWdlID0gKGxpbmUpID0+IHtcblxuICAgICAgY29uc3QgZWxzID0gbGluZS5xdWVyeVNlbGVjdG9yQWxsKCdbbmFtZSo9XCJtZW1iZXJzW1wiJyk7XG4gICAgICBlbHMuZm9yRWFjaCgoZWwpID0+IHtcbiAgICAgICAgbGV0IG5hbWUgPSBlbC5uYW1lO1xuICAgICAgICBuYW1lID0gbmFtZS5zcGxpdCgnWycpO1xuICAgICAgICBuYW1lLnBvcCgpO1xuICAgICAgICBlbC5uYW1lID0gbmFtZS5qb2luKCdbJyk7XG4gICAgICAgIGlmIChlbC5uYW1lLmluZGV4T2YoJ1snICsgdGhpcy5vcHRpb25zLnByaXZpbGVnZSArICddJykgPiAwKSB7XG4gICAgICAgICAgZWwudHlwZSA9ICdjaGVja2JveCc7XG4gICAgICAgICAgZWwuY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyk7XG4gICAgICAgIH1cblxuICAgICAgfSlcbiAgICB9XG4gICAgY29uc3QgaGFzY29udGFjdCA9IGF3YWl0IGNoZWNrQ29udGFjdCgpO1xuICAgIGlmIChoYXNjb250YWN0ID09PSB0cnVlKSB7XG4gICAgICBjb25zdCBsaW5lcyA9IHRoaXMuZmllbGRzZXQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtYmxvY2s9XCInICsgdGhpcy5vcHRpb25zLnRhcmdldCArICdcIl0nKTtcbiAgICAgIGxldCBuID0gbGluZXMubGVuZ3RoO1xuICAgICAgbGV0IHZlcmlmID0gdHJ1ZTtcbiAgICAgIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuICAgICAgICBpZiAobGluZS5kYXRhc2V0Lm1vZCAmJiBsaW5lLmRhdGFzZXQubW9kID09PSAncmVtb3ZlJykge1xuICAgICAgICAgIGlmIChuID4gMSkge1xuICAgICAgICAgICAgbGluZS5yZW1vdmUoKTtcbiAgICAgICAgICAgIG4tLTtcbiAgICAgICAgICB9IGVsc2UgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9IGVsc2UgaWYgKCFoYXNNZW1iZXIobGluZSkpIHtcbiAgICAgICAgICBjb25zdCBsaW5lbm8gPSBsaW5lLnF1ZXJ5U2VsZWN0b3IoJ1tuYW1lKj1cIlsnICsgdGhpcy5vcHRpb25zLmlkZW50ICsgJ11cIl0nKTtcbiAgICAgICAgICBsaW5lbm8uZm9jdXMoKTtcbiAgICAgICAgICBpZiAobGluZW5vLnRvbXNlbGVjdCkgbGluZW5vLnRvbXNlbGVjdC5mb2N1cygpO1xuICAgICAgICAgIGF3YWl0IHRoaXMuYWxlcnRCb3guYnVpbGQoe1xuICAgICAgICAgICAgZGlzbWlzc2libGU6IHRydWUsXG4gICAgICAgICAgICBpbnNlcnRhZnRlcjogdHJ1ZSxcbiAgICAgICAgICAgIG1lc3NhZ2U6IGNvZGVtZXNzYWdlcy5lbXB0eW5hbWUsXG4gICAgICAgICAgICBjb2RlaWQ6IHRydWUsXG4gICAgICAgICAgICB0eXBlOiBhbGVydGNvbmZpZy53YXJuaW5nLFxuICAgICAgICAgICAgcGFyZW50OiBsaW5lXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgY29uc3QgcmVzcCA9IGZhbHNlOyAvLyBubyBjb25maW1ib3gganVzdCB3YWl0IGZvciB1c2VyIGFjdGlvblxuICAgICAgICAgIC8vIGNhbGxiYWNrIHdoZW4gY29uZmlybWJveCByZXNwb25zZSBpcyBjaG9zZW4gaWYgJ2NvbmZpcm0nXG4gICAgICAgICAgaWYgKHJlc3AgPT09IHRydWUpIHtcbiAgICAgICAgICAgIGlmIChuID4gMSkge1xuICAgICAgICAgICAgICBsaW5lLnJlbW92ZSgpO1xuICAgICAgICAgICAgICBuLS07XG4gICAgICAgICAgICB9IGVsc2UgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgfSBlbHNlIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBlbHNlIGlmICghaGFzUHJpdihsaW5lKSkge1xuICAgICAgICAgIHRoaXMuYWxlcnRCb3guZGlzbWlzc0FsZXJ0KGNvZGVtZXNzYWdlcy5lbXB0eW5hbWUpO1xuICAgICAgICAgIGF3YWl0IHRoaXMuYWxlcnRCb3guYnVpbGQoe1xuICAgICAgICAgICAgZGlzbWlzc2libGU6IHRydWUsXG4gICAgICAgICAgICBpbnNlcnRhZnRlcjogdHJ1ZSxcbiAgICAgICAgICAgIGNvZGVpZDogdHJ1ZSxcbiAgICAgICAgICAgIG1lc3NhZ2U6IGNvZGVtZXNzYWdlcy51aGFzbm9wcml2LFxuICAgICAgICAgICAgdHlwZTogYWxlcnRjb25maWcud2FybmluZyxcbiAgICAgICAgICAgIHBhcmVudDogbGluZVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHZlcmlmID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB0aGlzLmFsZXJ0Qm94LmRpc21pc3NBbGVydChjb2RlbWVzc2FnZXMudWhhc25vcHJpdik7XG4gICAgICB9XG4gICAgICBpZiAoIXZlcmlmKSByZXR1cm4gdmVyaWY7XG4gICAgICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcbiAgICAgICAgZm9ybWF0UHJpdmlsZWdlKGxpbmUpO1xuICAgICAgfVxuXG4gICAgICBpZiAobiA9PT0gMCkge1xuICAgICAgICBhd2FpdCB0aGlzLmFsZXJ0Qm94LmJ1aWxkKHtcbiAgICAgICAgICBkaXNtaXNzaWJsZTogdHJ1ZSxcbiAgICAgICAgICBjb2RlaWQ6IHRydWUsXG4gICAgICAgICAgbWVzc2FnZTogY29kZW1lc3NhZ2VzLm5vYm9keSxcbiAgICAgICAgICB0eXBlOiBhbGVydGNvbmZpZy53YXJuaW5nLFxuICAgICAgICAgIHBhcmVudDogdGhpcy5maWVsZHNldF9hbGVydF96b25lXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9IGVsc2UgdGhpcy5hbGVydEJveC5kaXNtaXNzQWxlcnQoY29kZW1lc3NhZ2VzLm5vYm9keSk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2UgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGdldExpbmVQcml2aWxlZ2UoaWQpIHtcbiAgICBsZXQgcHJpdmlsZWdlID0gbnVsbDtcbiAgICBjb25zdCBsaW5lcyA9IHRoaXMuZmllbGRzZXQucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtYmxvY2s9XCInICsgdGhpcy5vcHRpb25zLnRhcmdldCArICdcIl0nKVxuICAgIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuICAgICAgaWYgKHBhcnNlSW50KGxpbmUucXVlcnlTZWxlY3RvcignW25hbWUqPVwiWycgKyB0aGlzLm9wdGlvbnMuaWRlbnQgKyAnXVwiXScpLnZhbHVlKSA9PT0gcGFyc2VJbnQoaWQpKSB7XG4gICAgICAgIHByaXZpbGVnZSA9IGxpbmU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBwcml2aWxlZ2U7XG4gIH1cblxuICBjbGVhckFsbChyZXQgPSBmYWxzZSkge1xuICAgIGNvbnN0IGxpbmVzID0gdGhpcy5maWVsZHNldC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1ibG9jaz1cIicgKyB0aGlzLm9wdGlvbnMudGFyZ2V0ICsgJ1wiXScpO1xuICAgIGxldCBrZWVwaW5kZXggPSAtMTtcbiAgICBsaW5lcy5mb3JFYWNoKChsaW5lLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3Qge1xuICAgICAgICBtZW1iZXIsXG4gICAgICAgIHByaXZzLFxuICAgICAgICBjb250YWN0LFxuICAgICAgICBkZWxldFxuICAgICAgfSA9IHRoaXMuZ2V0SW5wdXRzKGxpbmUpO1xuICAgICAgaWYgKHRoaXMuY3VycmVudF91aWQgPT09IG1lbWJlci52YWx1ZSkga2VlcGluZGV4ID0gaW5kZXg7XG4gICAgICBpZiAoaW5kZXggPiAwIHx8IChrZWVwaW5kZXggPiAwICYmIGtlZXBpbmRleCAhPT0gaW5kZXgpKSBsaW5lLnJlbW92ZSgpO1xuICAgIH0pO1xuICAgIC8vXG4gICAgY29uc29sZS5sb2coJ2tlZXBpbmRleCcsIGtlZXBpbmRleClcbiAgICBjb25zdCBsaW5lID0gdGhpcy5uZXdMaW5lKHRydWUpO1xuICAgIGlmIChrZWVwaW5kZXggIT09IDApIHtcbiAgICAgIGxpbmVzWzBdLnJlbW92ZSgpO1xuICAgICAgY29uc29sZS5sb2coJ3JlbSBsaW5lMCcsIGxpbmVzKVxuICAgIH1cbiAgICBpZiAocmV0ID09PSB0cnVlKSByZXR1cm4gbGluZTtcbiAgfVxuXG5cbn0iXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///./src/modules/project-privileges.js\n")}}]);