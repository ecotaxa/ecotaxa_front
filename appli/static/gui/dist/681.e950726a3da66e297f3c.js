/*! For license information please see 681.e950726a3da66e297f3c.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[681],{681:(e,a,n)=>{n.a(e,(async(e,t)=>{try{n.d(a,{JsDirToZip:()=>m});var i=n(4860),r=n(9861),o=n(2438),s=n(8468),l=n(7104),c=e([o,l]);[o,l]=c.then?(await c)():c;const p=new Set(["zip","gz","png","jpg","jpeg","pdf","doc","docx","ppt","pptx","xls","xlsx","heic","heif","7z","bz2","rar","gif","webp","webm","mp4","mov","mp3","aifc"]),u=new Set(["tsv","txt","log","csv"]),d=".tsv,.png,.jpg, .jpeg,.zip,.gz,.7z,.bz2";function m(e={}){const a=document.querySelector("[data-max_upload_size]")?parseInt(document.querySelector("[data-max_upload_size]").dataset.max_upload_size):1073741824,t=!!document.querySelector("[data-uploadinparts]"),c={ready:"ready",follow:"follow",complete:"complete",endreaddir:"endreaddir",gzip:"gzip",endzip:"endzip",sendfile:"sendfile",bigfile:"bigfile",terminate:"terminate",pending:"pending",errorfile:"errorfile",counter:"counter",reject:"reject",message:"message",error:"error",init:"init",setuploadpath:"setuploadpath"};let m,f,h;const w={uploadurl:"/gui/files/upload",largefile:a,accept:d.split(",")},g=(e={...w,...e}).listener?e.listener:y;Object.freeze(e);const y=(0,i.UP)();async function z(){f={zip:null,zipname:null,filestream:null,streamhandle:null,gzipped:null,sizetozip:0,part:0,follow:null,endcounter:!1,endreaddir:!1,callback:null,pos:0,counter:{scan:0,zip:0,reject:0,error:0},handlers:[],hashandlers:!1},await k()}async function j(){f.pos=0,f.sizetozip=0,f.zip=new r.qQ(((e,a,n)=>{if(e)return S(c.errorfile,{message:e}),!1;f.streamhandle.write(a,{at:self.pos}),f.pos+=a.length,n&&f.streamhandle.close()})),function(e=null){const a=(e=null===e?f.zip:e).ondata;e.ondata=(n,t,i)=>{a(n,t,i),i&&(e.d=null,e.u&&e.u.at(-1)&&(e.u.at(-1).d=null))}}(),f.follow&&await f.follow()}function b(e){if(!0===f.endreaddir)if(!0===f.endcounter){const a=v(e,{name:c.endzip});o.j.emit(c.complete,a,g)}else f.counter.error>0&&L()}function v(e,a={}){return e.hasOwnProperty("part")?a.part=e.part:f.part=0,e.hasOwnProperty("bigfile")&&(a.bigfile=e.bigfile),e.hasOwnProperty("path")&&(a.path=e.path),a}async function x(){navigator&&navigator.storage&&navigator.storage.estimate&&navigator.storage.estimate().then((e=>{const a=(e.usage/e.quota*100).toFixed(2),n=(0,i.Y2)(e.quota-e.usage);o.j.emit(c.message,{id:"quota",name:"console",message:"you've used "+a+"% of the available browser storage necessary to locally compress files ("+n+")."},g)}))}async function k(){navigator&&navigator.storage&&navigator.storage.estimate?(await async function(e=null){e=e||await navigator.storage.getDirectory();for await(const[a,n]of e.entries())try{await e.removeEntry(a),console.log(" Success remove storage ",a)}catch(e){console.log(" error remove storage "+a,e)}}(),x()):o.j.emit(c.message,{name:"error",message:"no navigator storage"},y)}async function O(e,a={"application/zip":[".zip"]}){const n=await navigator.storage.getDirectory(),t={types:[{description:"Temp file",accept:a}],create:!0},i=await n.getFileHandle(e,t),r=await i.createWritable({mode:"exclusive"});return{filestream:i,streamhandle:r}}async function P(e,s={}){if(f.endreaddir=!1,null===f.zip){e=""===(e=e.split(i.hx)[0]).trim()?"temp":e;const w=s&&s.type?s.type:".zip";f.zipname=(s.zipname?s.zipname:e)+w;await async function(e){const a=await navigator.storage.getDirectory();for await(const[n,t]of a.entries())if(e===n)return!0;return!1}(f.zipname)&&(f.zipname="1_"+f.zipname);const{filestream:z,streamhandle:b}=await O(f.zipname);f.filestream=z,f.streamhandle=b;if(f.part=0,await j(),!m){const{JsScanDir:e}=await n.e(162).then(n.bind(n,4162)),s=async(e,n)=>{!function(e){const a=e.name,n=a.slice(a.lastIndexOf(".")+1);return d.includes(n)}(e)?function(e,a=null){const n=e.fullPath?e.fullPath:e.webkitRelativePath;f.counter.reject+=1,o.j.emit(c.reject,{name:c.reject,path:n},g),null!==a&&a()}(e,n):(f.callback=n,await async function(e){const n=e.fullPath?e.fullPath:e.webkitRelativePath;e.file((async e=>{await async function(e,n,s=!0){!0===s&&o.j.emit(c.counter,{name:"scan",path:n,size:e.size},y);f.follow=null;const d=function(e){const a=e.name.slice(e.name.lastIndexOf(".")+1);return u.has(a)?Math.floor(e.size/2):e.size}(e);d>=a?(f.counter.error+=1,t?async function(e,n){Date.now();n=0===n.indexOf(i.hx)?n.substr(1):n;const t=n.split(i.hx);t.pop();const s=h+i.hx+t.join(i.hx),u=e.name.slice(e.name.lastIndexOf(".")+1);if(p.has(u))o.j.emit(c.counter,{name:"zip",path:n,bigfile:e.name,size:e.size},y),D((async()=>{await _(s,e)}));else{let t=e.name+".gz";const{filestream:i,streamhandle:p}=await O(t,{"application/gzip":[".gz"]});let u=0;const d=new r.JZ({level:6,filename:n});d.ondata=(t,r,m)=>{if(u>a)return f.counter.error+=1,S(l.y.alertconfig.types.error,{name:l.y.alertconfig.types.error,bigfile:e.name,path:n,message:"File "+e.name+" size exceeds maxsize. Cannot be sent in chunks for the moment."}),p.close(),d.ondata=(e,a,n)=>{},L();t?(f.counter.error+=1,S(l.y.alertconfig.types.error,{name:l.y.alertconfig.types.error,bigfile:e.name,path:n,size:e.size,message:"Error compressing file "+e.name+" "+t})):(p.write(r,{at:u}),u+=r.length,m&&(p.close(),n+=".gz",o.j.emit(c.counter,{name:"zip",path:n,size:e.size,bigfile:e.name},y),D((async()=>{await _(s,i)}))))};const m=!1;await q(e,n,d,m)}}(e,n):L()):(f.sizetozip+=d,f.sizetozip>a?t?(f.follow=async()=>{await I(e,n)},async function(){f.part+=1,o.j.emit(c.complete,{name:c.endzip,part:f.part},g)}()):L():await I(e,n))}(e,n)}))}(e))};m=e(s)}}}function F(){o.j.emit(c.endreaddir,{name:c.endreaddir},y)}function D(e){f.handlers.push(e),f.hashandlers=f.handlers.length>0}async function q(e,a,n,t=!0){const i=e.stream().getReader();for(;;){const{done:r,value:s}=await i.read();if(r){n.push(new Uint8Array(0),!0),!0===t&&o.j.emit(c.counter,{name:"zip",path:a,size:n.size?n.size:e.size},y);break}n.push(s)}}async function I(a,n){const t=n.slice(n.lastIndexOf(".")+1),i=p.has(t)?new r.uZ(n):a.size>e.largefile?new r.hw(n,{level:6}):new r.D8(n,{level:6});f.zip.add(i),await q(a,n,i)}function S(e,a=null){switch(a=a||{},e){case c.init:case c.errorfile:a.name=e}o.j.emit(c.message,a,g)}async function A(e,a=!1){if(f.follow)return f.streamhandle=await f.filestream.createWritable({mode:"exclusive"}),e.name=c.follow,o.j.emit(c.follow,e,g),void await j();f.zip=null,f.hashandlers||(e.name=c.terminate,o.j.emit(c.complete,e,g))}async function _(e,n,t=0,r=0,o=a){const s=n.name.slice(n.name.lastIndexOf(".")+1),l=p.has(s)?n:await n.getFile(),u=Math.min(t+o,l.size);return u!==l.size?(f.counter.error+=1,S(c.errorfile,{name:c.error,message:"File "+e+i.hx+l.name+" size exceeds capacity. Chunk functionality not supported for the moment."}),L()):(e=e.replace(l.name,""),C(l,e,null,!0),r)}async function C(a,n,t=null,r=!1){if(f.counter.error>0)return L();const s={name:c.pending,bigfile:r,path:n},l=new FormData;n=n+(n.slice(-1)===i.hx?"":i.hx)+a.name,l.append("path",n),l.append("file",a,a.name),f.part?l.append("part",f.part):null!==t&&l.append("ischunk",!0),s.path=n;const p=await fetch(e.uploadurl,{method:"POST",credentials:"include",body:l});await p.text();p.ok?t?await t():(r&&f.hashandlers||await A(s),r&&(s.name=c.follow,o.j.emit(c.follow,s,g))):(f.follow=null,await A(s),f.counter.error+=1,S(c.errorfile,s),(r||f.hashandlers)&&L())}function L(){return f.follow=null,S(c.errorfile,{name:l.y.alertconfig.types.error,message:"Upload not done. one or more files exceeds max upload size",path:h}),z().then((()=>{o.j.emit(c.complete,{name:c.ready},g),f.endreaddir=!1})),!1}return k(),f={zip:null,zipname:null,filestream:null,streamhandle:null,gzipped:null,sizetozip:0,part:0,follow:null,endcounter:!1,endreaddir:!1,callback:null,pos:0,counter:{scan:0,zip:0,reject:0,error:0},handlers:[],hashandlers:!1},o.j.on(c.setuploadpath,(async e=>{h=e.path}),y),o.j.on(c.init,(async e=>{null!==f.zip||null!==f.follow||f.hashandlers||!0!==f.endreaddir?console.log("partly finished "+f.hashandlers+"follow="+f.follow,e):(await z(),o.j.emit(c.complete,{name:c.ready},g),o.j.emit(c.message,{name:l.y.alertconfig.types.success,message:"Upload of "+e.path+" is done"},g),f.endreaddir=!1)}),y),o.j.on(c.endzip,(async e=>{!e.bigfile&&f.zip&&f.zip.end();const a=async function(){if(!0===await async function(e=null,a=null){e=e||await navigator.storage.getDirectory();let n=!0;for await(const[t,i]of e.entries())if(null!==a){const e=t.split(".");if("crswap"===e.pop()&&e.join(".")===a){n=!1;break}}return n}(null,f.zipname)){const a=v(e,{name:c.sendfile});o.j.emit(c.complete,a,g)}else setTimeout((async function(){await a()}),2e3)};a()}),y),o.j.on(c.sendfile,(async e=>{if(f.hashandlers){const a=v(e,{name:c.follow});o.j.emit(c.follow,a,g),await async function(){if(f.hashandlers){const e=f.handlers.shift();await e(),f.hashandlers=f.handlers.length>0}}()}else{const a=v(e,{name:c.pending});o.j.emit(c.complete,a,g)}C(await async function(e=null){e=null===e?f.filestream:e;const a=await e.getFile();return a}(),e.path?e.path:h,null)}),y),o.j.on(c.endreaddir,(e=>{f.endreaddir=!0,b(e)}),y),o.j.on(c.counter,(async e=>{f.endcounter=!1,f.counter[e.name]+=1,o.j.emit(c.counter,e,g),"zip"===e.name&&f.counter.scan===f.counter.zip&&(f.endcounter=!0,b(e)),"zip"===e.name&&f.callback&&await f.callback()}),y),o.j.on(c.error,(e=>{})),{uuid:y,eventnames:c,scanBrowse:async function(e,a={}){const n=e instanceof FileList?Array.from(e):"directory"===e.kind?await Array.fromAsync(e.values()):Array.isArray(e)?e:[e];n[0].name;let t=e instanceof FileList?n[0].webkitRelativePath:null;t=t?t.split(i.hx):[""],t.length&&t.pop(),t=t.join(i.hx);const r=e instanceof FileList?t:"directory"===e.kind?e.name:"";await P(r,a),await m.processEntries(n,r,(()=>{F()}))},scanHandle:async function(e,a={}){await P(e.name,a),!0===e.isDirectory?await m.readDirectory(e,(()=>{F()})):!0===e.isFile&&await m.processFile(e,(()=>{F()}))},quotaEstimate:x,browserRequired:function(){const e=(0,s.o0)(),a={android:{chrome:109,opera:74,firefox:111,samsungbrowser:21,webview:109},ios:!1,other:{chrome:86,edge:86,opera:72,firefox:111}};let n=e.os.toLowerCase();n=n in["android","ios"]?n:"other";const t=e.name.toLowerCase(),i=parseInt(e.version.split(".")[0]);(Object.keys(a).indexOf(n)<0||Object.keys(a[n]).indexOf(t)<0||parseInt(a[n][t])>parseInt(i))&&o.j.emit(c.message,{id:"browser",name:"browser",message:"your browser does not have a required functionnality. Please upgrade or use a valid browser and version :"+JSON.stringify(a).replaceAll('"',"")},g)}}}t()}catch(f){t(f)}}))}}]);