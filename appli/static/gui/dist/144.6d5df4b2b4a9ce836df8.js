/*! For license information please see 144.6d5df4b2b4a9ce836df8.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[144],{144:(t,e,s)=>{s.d(e,{JsMyFiles:()=>m});var i=s(7737),n=s(2817);const o={images:"png,jpeg,jpg,gif",tsv:"txt,tsv,zip, gzip,gz"},r=new CustomEvent("eventEntry",{detail:()=>{console.log("customevent",(void 0).entry)}}),a={api_parameters:{entry:"entry",dest:"dest"},url:"/gui/files",controls:{scan:{display:{counter:"counter",size:"size"}},zip:{btn:{zip:"makezip",zipped:"makezipped"},display:{size:"sizezipped",counter:"counterzipped"}}},upload:{label:"upload"},btnprefix:"btn",btnfilelist:null,entry:{selector:"[data-name]",tags:{tag:"ul",subtag:"li",label:"span"},selectors:{entries:".entries"},draggable:!0,prefix:"entry",type:{root:"R",trash:"T",directory:"D",file:"F",trashed:"X"},specialdirs:["R","T"],trash_dir_name:"trash.",css:{on:"on",entryF:"entryF",entryD:"entryD",entryR:"entryR",entryT:"entryT",editable:"editable",dragging:"dragging",dragover:"dragover",dragitem:"dragitem"},icons:{image:"img",document:"doc"}},entrycontrols:{selectors:{typentries:"[data-typentries]",hascontrols:".has-controls"},controls:{list:{action:"list",typentries:["D","R","T"]},create:{action:"create",text:"new folder",icon:"icon-folder-plus-sm",typentries:["D","R"]},remove:{action:"remove",text:"delete",icon:"icon-trash-sm",typentries:["D","F","X"]},move:{action:"move",typentries:["D","F"]},rename:{action:"rename",trigger:"dblclick",typentries:["D","F"]}},css:{entrycontrols:"entrycontrols",entries:".entries"}},selectors:{doupload:".target-upload",droptarget:".droptarget",dirlist:".dirlist",uploadfile:"uploadfile",displayresult:"results",trigger:".trigger"}};class l{_events;eventnames;name;type;label;entries=[];options={selector:"[data-name]",tags:{tag:"ul",subtag:"li",label:"span"},selectors:{entries:".entries"},css:{on:"on"},draggable:!0,prefix:"entry"};constructor(t,e={}){return this.name=t.name,this.type=t.type,this.root=e.root,this.parent=e.parent?e.parent:null,this.options=Object.assign(this.options,a),this.options=Object.assign(this.options,e),this.label=e.label?e.label:null,this.init(t),this}init(t){(0,i.TG)(this);const e={name:this.name,type:this.type};null!==this.label&&(e.label=this.label);const s=(0,i.Bh)(this.options.tags.subtag,{draggable:this.options.draggable,dataset:e}),n=this.options.class?this.options.class:[];n.unshift(`${this.options.prefix}${this.type}`),this.label=(0,i.Bh)(this.options.tags.label,{class:n,text:t.label?t.label:t.name},s),this.container=s,this.initEvents()}initEvents(){Object.entries(this.options.actions).forEach((([t,e])=>{this.on(e,(e=>{this[t](e)}))}))}getParent(){return this.parent}getLabelElement(){return this.label}getParentElement(){return this.container.parentElement.closest(this.options.selector)}getEntries(){return this.entries()}getEntriesElement(t=!1){let e=this.container.querySelector(this.options.selectors.entries);return t&&null===e?(0,i.Bh)(this.options.tags.tag,{class:this.options.selectors.entries.substr(1)},this.container):e}appendEntry(t){if(t.parent){console.log("this",t);const e=t.parent.entries.indexOf(t);delete t.parent.entries[e]}t.parent=this,this.entries.push(t);return this.getEntriesElement(!0).append(t.container),t}createEntry(t){const e=new l(t);this.appendEntry(e)}createListEntries(t){this.getEntriesElement(!0);t.forEach((t=>{t.forEach((t=>{this.createEntry(t)}))}))}isOn(){return this.active}toggleOn(){this.active=!this.active,this.container.classList.toggle(this.options.css.on)}setOff(){this.active=!1,this.container.classList.remove(this.options.css.on)}emitEvent(t=null,e=null){const s={entry:this};t&&(s.action=t),e&&(s.event=e),r.initCustomEvent("eventEntry",!0,!0,s),window.dispatchEvent(r)}moveHandlers(){return[{name:"dragover",func:t=>{this.handleDragOver(t)}},{name:"drop",func:t=>{this.handleDrop(t)}}]}dropHandlers(){return[{name:"dragover",func:t=>{this.handleDragOver(t)}},{name:"drop",func:t=>{this.handleDrop(t)}}]}handleDrop(t){}addListeners(){let t=t=>{t.stopImmediatePropagation(),this.dirControls((()=>{this.emitEvent(this.eventnames.attach)}))},e=[];[this.options.type.root,this.options.type.trash].indexOf(this.type)<0&&(this.isInTrash()&&console.log(" isintrash "+this.name,this.isInTrash()),e=this.moveHandlers(),this.type===this.options.type.file?t=t=>{t.stopImmediatePropagation(),this.toggleOn(),this.emitEvent()}:this.isInTrash()?this.type=this.options.type.trashed:e=e.concat(this.dropHandlers()),this.listenRename()),e.unshift({name:"click",target:"label",func:t});for(const t of e){("label"===t.target?this.getLabelElement():this.container).addEventListener(t.name,t.func)}}removeListeners(t){for(const e in t){("label"===e.target?this.getLabelElement():this.container).removeEventListener(e.label,e.func)}}destroy(){this.container.remove()}handleDragStart(t){this.container.classList.add(this.options.css.dragging),t.dataTransfer.effectAllowed="move",this.emitEvent("dragstart")}handleDragOver(t){t.stopPropagation(),t.preventDefault(),this.emitEvent("dragover")}handleDragEnd(t){t.stopPropagation(),t.preventDefault(),this.container.classList.contains(this.options.css.dragging)&&this.container.classList.remove(this.options.css.dragging),this.emitEvent("dragend")}resetDragOver(){document.querySelectorAll("."+this.options.css.dragover).forEach((t=>{t.classList.remove(this.options.css.dragover)}))}handleDrop(t){this.emitEvent("drop",t)}unMove(){this.from&&(this.move(this.from),this.from.container.append(this),this.from=null)}}class h extends l{eventnames={attach:"attach",detach:"detach",istrashdir:"istrashdir",trashed:"trashed"};isTrashDir(t=null){return 0===(null===t?this.name:t).indexOf(this.options.trash_dir_name)}isInTrash(t=null){return null===(t=null===t?this.getCurrentDirPath():t)&&(0,i.jg)("path_not_found"),0===((t=t.split(i.QX)).length>1&&t[0].indexOf(this.options.trash_dir_name))}setWait(){this.loaded=this.container.dataset.loaded=!1,this.container.classList.add("wait")}setLoaded(){this.container.classList.remove("wait"),this.loaded=this.container.dataset.loaded=!0}dirControls(t=null){"create"!==this.container.dataset.action&&(this.toggleOn(),this.isOn()&&this.dirActivate(t).then((()=>{this.emitEvent()})))}async dirActivate(t=null){this.loaded?t&&t(this):this.list().then((()=>{t&&t(this)}))}getCurrentDirPath(){const t=(e,s=[])=>e.name&&(s.push(e.name),null!==(e=e.getParent()))?t(e,s):s;let e=t(this);return e.length>1&&(e=e.reverse()),e.join(i.QX)}async fetchAction(t,e=null,s=null){const n=this.options.api_parameters,o=this.getLabelElement();let r=this.getCurrentDirPath();if(""===r)return;const a=new FormData;switch(a.append(n.entry,r),t){case this.options.actions.create:if(null===o)return;r=r+i.QX+o.textContent,""!==r.trim()&&a.append(n.entry,r);break;case this.options.actions.move:if(null===e)return;{let t=e();if(e=null,t===r)return void console.log("dest = entry",t);a.append(n.dest,t),console.log(r+" destmove ",t)}break;case this.options.actions.rename:const t=r.split(i.QX);if(t[t.length-1]=o.textContent,t.join(i.QX)===r)return;a.append(n.dest,t.join(i.QX))}const l=await fetch(this.options.url+i.gA+t,(0,i.wv)({method:"POST",body:a})),h=await l.json();if(console.log("responsejson",h),200===h.status)return e&&e(h.message),!0;s?s(h):(0,i.jg)(h)}listenRename(t="dblclick"){const e=this,s=e.getLabelElement();s.addEventListener(t,(t=>{const n=async t=>{if("Enter"===t.key){t.preventDefault(),s.contentEditable=!1,e.container.draggable=this.options.specialdirs.indexOf(e.type)<0;const o=t=>{s.classList.remove(e.options.css.editable),""===t?window.alertbox.addItemMessage(s,{type:"error",content:window.alertbox.i18nmessages.exists,duration:2e3}):t=t.split(i.QX).pop(),s.removeEventListener("keydown",n),s.textContent=t,e.type===e.options.type.directory&&e.dirControls(),delete e.container.dataset.action},r=e.container.dataset.action?e.container.dataset.action:e.options.actions.rename;console.log("action entry_rename "+r,e.container),await e.fetchAction(r,o)}};s.contentEditable=!0,e.container.draggable=!1,s.classList.add(e.options.css.editable),s.addEventListener("keydown",n)}))}createEntry(t){const e=t.name.split(".").pop(),s=this.options;s.draggable=s.specialdirs.indexOf(t.type)<0,s.class=[],this.isTrashDir(t.name)&&(t.type=this.options.type.trash);const i=t.type===s.type.file?o.images.split(",").indexOf(e)>=0?s.icons.image:s.icons.document:null;null!==i&&s.class.push(i);const n=new h(t,s);return t.type===this.options.type.trash&&n.emitEvent(this.eventnames.istrashdir),this.appendEntry(n),n.addListeners(),n}async list(){if(this.type===this.options.type.file)return;this.options.tags.tag,this.options.tags.subtag;const t=this.name?this.getCurrentDirPath():null;this.setWait();const e=this.getEntriesElement();e&&e.remove(),fetch(this.options.url+i.gA+this.options.actions.list+(t?i.QX+t:""),(0,i.wv)()).then((t=>t.json())).then((async t=>{if(t.entries&&t.entries.length){let e=[],s=[],i=t.entries;for(;i.length>0;){const t=i.shift();t.type===this.options.type.file?e.push(t):s.push(t)}e.sort(((t,e)=>t.name<e.name)),s.sort(((t,e)=>t.name<e.name)),this.createListEntries([s,e])}this.setLoaded()}))}remove(){if(this.isTrashDir())return;const t=this.getCurrentDirPath();this.fetchAction(this.options.actions.remove).then((e=>{console.log("remove ",this),this.from=t,this.removeListeners(this.dropHandlers()),this.setOff(),this.container.animate({transform:"translateX(-100%) scale(0)"},{duration:1e3}),setTimeout((()=>{this.isInTrash(this.from)?this.destroy():this.emitEvent(this.eventnames.trashed)}),1e3)}))}create(){const t=this.createEntry({type:"D",name:"NewFolder"});t.container.dataset.action=this.options.actions.create,t.label.dispatchEvent(new Event("dblclick"))}rename(){this.isTrashDir()||this.fetchAction(this.options.actions.rename).then((()=>{console.log("renamed",this)}))}move(t){if(this.isTrashDir())return;const e=this.getCurrentDirPath();this.fetchAction(this.options.actions.move,(()=>t.getCurrentDirPath())).then((()=>{this.from=e;t.getEntriesElement(!0).append(this.container)})).catch((t=>{}))}}class c{_events={};eventnames={control:"control",error:"error"};options=a.entrycontrols;box;container;entry=null;constructor(t=document,e={}){return t.jsentrycontrols||(this.options=Object.assign(this.options,e),this.container=t,this.entry=null,this.init(),t.jsentrycontrols=this),t.jsentrycontrols}init(){(0,i.TG)(this),this.box=this.createControls(),this.initEvents()}createControls(){const t=(0,i.Bh)("div",{class:[this.options.css.entrycontrols,n.iv.hide]});return Object.values(this.options.controls).filter((t=>t.icon||t.text)).forEach((e=>{const s=(0,i.Bh)("span",{},t);if(e.typentries&&(s.dataset.typentries=e.typentries),e.icon){(0,i.Bh)("i",{class:["icon",e.icon]},s);s.dataset.title=e.text}else s.textContent=e.text;const n=e.trigger?e.trigger:"click";s.addEventListener(n,(t=>{if(null===this.entry)return;const s={callback:()=>{console.log("done",e.action)}};this.entry.emit(e.action,s)})),e.ctrl=s})),t}initEvents(){}detachControls(){null!==this.entry&&(this.entry.container.classList.remove(this.options.selectors.hascontrols.substr(1)),this.box.classList.add(n.iv.hide),this.box.disabled=!0,this.container.append(this.box),this.entry=null)}attachControls(t){this.detachControls(),this.entry=t,this.entry.container.prepend(this.box),this.entry.container.classList.add(this.options.selectors.hascontrols.substr(1)),this.activateControls(),this.box.classList.remove(n.iv.hide),delete this.box.disabled}activateControls(){if(null===this.entry)return;const t=this.entry.isInTrash();Object.values(this.options.controls).filter((t=>t.icon||t.text)).forEach((e=>{const s=e.ctrl,i=s.dataset.typentries?s.dataset.typentries.split(","):[],o=t?this.entry.options.type.trashed:this.entry.container.dataset.type;i.indexOf(o)>=0?s.classList.remove(n.iv.hide):s.classList.add(n.iv.hide)}))}}class d{_events={};eventnames={attach:"attach",detach:"detach",action:"action",complete:"complete",error:"error"};options=a;constructor(t,e={}){if(!t.jsdirlist){if(!(t=t instanceof HTMLElement?t:document.querySelector(t)))return;this.options=Object.assign(this.options,e),this.options.entry.url=this.options.url,this.container=(0,i.Bh)(this.options.entry.tags.tag,{class:this.options.selectors.dirlist.substr(1)},t),this.init(),this.container.append(this.root.container),t.jsdirlist=this}return t.jsdirlist}init(){(0,i.TG)(this);const t=this.options.entry.type.root,e={};this.entrycontrols=this.options.controls?new c(this.container,this.options.entrycontrols):null,Object.entries(this.options.entrycontrols.controls).forEach((([t,s])=>{e[t]=s.action})),this.options.entry.actions=e,this.initEvents();const s=this.options.entry;s.draggable=!1,this.root=new h({type:t,name:"",label:"..",root:this},s),this.root.addListeners()}initEvents(){console.log(" init events%%%%%%%%%%%%%%%%%%%%%%%ù)",this.entrycontrols);this.on(this.eventnames.error,(t=>{console.log("dirlist receive error message",t),window.alertbox&&window.alertbox.renderAlert({type:window.alertbox.alertconfig.types.error,content:t,inverse:!0,dismissible:!0})})),window.addEventListener("eventEntry",(t=>{const e=t.detail.entry.eventnames;switch(t.detail.action){case e.istrashdir:this.trashdir=t.detail.entry;break;case e.trashed:console.log(" trashed from---------",t.detail.entry.from),t.detail.entry.isInTrash(t.detail.entry.from)?this.detachControls():(this.trashdir.appendEntry(t.detail.entry,this.trashdir),t.detail.entry.from=t.detail.entry.getCurrentDirPath(),console.log(" new path after trashed from---------",t.detail.entry.from),this.attachControls(t.detail.entry),t.detail.entry.container.classList.add("bg-danger-100")),this.emit(this.eventnames.detach,t.detail);break;case e.detach:this.detachControls();case e.attach:const s=t.detail.entry.isInTrash()?t.detail.entry.options.type.trashed:t.detail.entry.container.dataset.type;if(s===t.detail.entry.options.type.trash)return;if(t.detail.action===e.attach&&s===t.detail.entry.options.type.trashed)return;this.emit(this.eventnames[t.detail.action],t.detail);break;case"dragstart":this.detachControls(),this.dragentry=this.activentry=t.detail.entry,t.detail.entry.container.classList.add(t.detail.entry.options.css.dragging);break;case"dragover":if(!this.dragentry)return;this.overitem!==t.detail.entry.container&&(this.overitem&&this.overitem.classList.remove(t.detail.entry.options.css.dragover),t.detail.entry.container.classList.add(t.detail.entry.options.css.dragover),this.overitem=t.detail.entry.container);break;case"dragend":this.dragentry=null,this.overitem&&this.overitem.classList.remove(t.detail.entry.options.css.dragover),this.overitem=null;break;case"drop":if(!this.dragentry)return console.log(" drop upload ",t),this.emit(this.eventnames.action,t),!0;console.log(" dragentry drop",t),t.stopPropagation();const i=this.dragentry.container,n=t.detail.entry;if(n.resetDragOver(),null!==this.dragentry)if(console.log("move file or dir",this.dragendentry),this.dragentry.options.actions.move)try{this.dragentry.move(n),parent.append(i)}catch(t){this.dragentry.unMove()}else console.log("noactionon drop");else console.log(" parent===null or dragitem===null or dragitem===parent",this.dragentry);return;default:t.detail.entry.active?this.attachControls(t.detail.entry):this.attachControls(this.root)}}))}attachControls(t){this.detachControls(),this.entrycontrols?this.entrycontrols.attachControls(t):this.detachControls(),this.activentry=t}detachControls(){this.entrycontrols&&this.entrycontrols.attachControls(this.root),this.activentry=this.root}}const p={"image/*":[".png",".jpeg",".jpg"],"text/tab-separated-values":[".tsv"],"application/zip":[".zip"],"application/gzip":[".gz"],"application/x-bzip":[".bz"],"application/x-bzip2":[".bz2"]},g=Object.values(p).reduce(((t,e)=>t.concat(e)));n.iv.mright="mr-4";class m{done=!0;jsDirToZip=null;jsDirList=null;trash_dir_name="trash.";counters={};_events={};eventnames={complete:"complete",error:"error"};constructor(t,e={}){if(!t.jsmyfiles){if(!(t=t instanceof HTMLElement?t:document.querySelector(t)))return;(0,i.KZ)(t,"dataset"),this.container=t,console.log("/gui/files/list");const s={controls:{scan:{display:{counter:"counter",size:"size"}},zip:{btn:{zip:"makezip",zipped:"makezipped"},display:{size:"sizezipped",counter:"counterzipped"}}},upload:{label:"upload"},btnprefix:"btn",btnfilelist:null,selectors:{droptarget:".droptarget",trigger:".trigger",uploadfile:"uploadfile"},display:{progression:"display-progression",dropzone:"dropzone",boxtitle:"boxtitle",counters:"counters",sizes:"sizes",timers:"timers"},css:{dragover:"dragover"}};this.options=Object.assign(s,e),this.options.browse=t.dataset.browse?t.dataset.browse.split(","):["directory","file"],this.haspicker=window.showDirectoryPicker,this.options.browse=t.dataset.browse?t.dataset.browse.split(","):["directory","file"],this.init(),t.jsmyfiles=this}return t.jsmyfiles}init(){(0,i.TG)(this),this.addDisplayProgression(),this.addDirList(),this.addDropzone(),this.initControls(),this.initEvents().then((()=>{this.resetCounters()}))}initTimer(){this.timer=new Date}async initEvents(){(0,i.TG)(this),console.log(" init events%%%%%%%%%%%%%%%%%%%%%%%ù)"),this.on(this.eventnames.processed,(async t=>{this.nextaction&&await this.nextaction()})),this.on(this.eventnames.error,(t=>{console.log("scandir receive error message",t),window.alertbox&&window.alertbox.renderAlert({type:window.alertbox.alertconfig.types.error,content:t,inverse:!0,dismissible:!0})}));const t=this;if(this.options.controls.zip){const{JsDirToZip:e}=await Promise.all([s.e(778),s.e(249)]).then(s.bind(s,6249));this.jsDirToZip=new e,Object.keys(this.jsDirToZip.eventnames).forEach((e=>{this.eventnames[e]=this.jsDirToZip.eventnames[e],this.jsDirToZip.on(e,(s=>{switch(e){case"counter":t.fileCounter(s);break;case"complete":if(!s||!s.name)return void console.log("no emit complete name");t.showControl(s.name,s);case"message":switch(s.name){case"console":this.addConsoleMessage({id:s.id?s.id:null,content:s.message,parent:this.container});break;case window.alertbox.alertconfig.types.error:case window.alertbox.alertconfig.types.success:case window.alertbox.alertconfig.types.danger:case window.alertbox.alertconfig.types.info:window.alertbox.renderAlert({type:s.name,content:s.message,dismissible:!0,inverse:!1}),console.log("error",s);break;default:console.log("message",s)}break;case"terminate":console.log("terminate",s);default:t.showControl(e,s)}}))}))}window.addEventListener("beforeunload",(t=>{this.done||(t.preventDefault(),t.returnValue=this.options.preventclose?this.options.preventclose:"Some work is in progress in this window.\nAre you sure you want to leave?")}))}emitToZip(t){const e=t.dataset.message?JSON.parse(t.dataset.message):null;if(e||t.classList.add(n.iv.hide),e&&e.name){const t=e.name;delete e.name,console.log("emit ----"+t,e),this.jsDirToZip.emit(t,e)}name===this.eventnames.sendfile&&(t.disabled=!0)}quotaEstimate(t){return this.jsDirToZip.quotaEstimate()}scanBrowse(t,e){return this.jsDirToZip.scanBrowse(t,e)}scanHandle(t,e){return this.jsDirToZip.scanHandle(t,e)}async handleBrowse(t){this.initTimer(),this.toggleCounters(!0),this.haspicker||(t=t.target.files),await this.scanBrowse(t,{accept:g})}addDropzone(){this.dropzone=(0,i.Bh)("div",{id:this.options.display.dropzone});const t=this.haspicker?null:(0,i.Bh)("input",{type:"file",name:this.options.selectors.uploadfile,id:this.options.selectors.uploadfile,multiple:!0,allowdirs:!0,accept:g,class:"hidden"},this.dropzone);t&&t.addEventListener("change",(t=>{this.handleBrowse(t)}));const e=(0,i.Bh)("div",{},this.dropzone);this.options.browse.forEach((s=>{const n=this.container.dataset[`textbrowse${s}`]?this.container.dataset[`textbrowse${s}`]:`browse${s}`;(0,i.Bh)("span",{class:this.options.selectors.trigger.slice(1),dataset:{type:s},text:n},e).addEventListener("click",(async e=>{this.haspicker?this.openDirDialog(s,(t=>{this.handleBrowse(t)})):("directory"===s?(t.directory=!0,t.webkitdirectory=!0):(t.directory=!1,t.webkitdirectory=!1),t.dispatchEvent(new MouseEvent("click")))}))}));(0,i.Bh)("span",{text:this.container.dataset.textdrop},e)}toggleDropTarget(t=!0){const e=this,s=this.activentry?this.activentry.container:null;if(null===s)return;const i=this.jsDirList?this.jsDirList.options.entry.css.dragover:this.options.css.dragover,n=t=>{!this.dragover&&this.activentry&&this.activentry.container===t.currentTarget&&s.classList.add(i)},o=async t=>{s.classList.remove(i),e.handleDrop(t)};!1===t?(s.removeEventListener("dragover",n),s.removeEventListener("drop",o),s.classList.remove(this.options.selectors.droptarget.substr(1))):(s.addEventListener("dragover",n),s.addEventListener("drop",o),s.classList.add(this.options.selectors.droptarget.substr(1)))}async addDirList(){console.log("dirlist add addDILRLLLL",this.container),this.jsDirList=new d(this.container),this.activentry=this.jsDirList.root,this.rootitem=this.targetitem=this.activentry.container,this.jsDirList.on(this.jsDirList.eventnames.attach,(t=>{t.entry&&(this.detachDropzone(),this.activentry=t.entry,this.targetitem=this.activentry.container,this.addUploadDialog())})),this.jsDirList.on(this.jsDirList.eventnames.detach,(t=>{console.log("myfiles dirlist event",t),this.enableDropzone(),this.detachDropzone(),this.activentry=null,this.targetitem=null})),this.jsDirList.on(this.jsDirList.eventnames.action,(t=>{if(console.log("action not managed",t),"drop"===t.action)t.target=t.entry.container,this.handleDrop(t.event)})),this.activentry.label.dispatchEvent(new Event("click"))}addDisplayProgression(){if(this.displayprogression)return;let t=document.getElementById(this.options.display.progression);t||(t=(0,i.Bh)("div",{id:this.options.display.progression},this.container),t.innerHTML=`<div class="flex sm:flex-row"><div class="${this.options.display.counters}"></div><div class="${this.options.display.sizes}"></div><div class="${n.iv.progress}"></div><div class="${this.options.display.timers}"></div></div>`,this.displayprogression=t)}enableDropzone(t=!0,e=!1){e&&this.dropzone.classList.add(n.iv.hide),t?this.dropzone.dataset.enabled=!0:delete this.dropzone.dataset.enabled}attachDropzone(){this.dropzone.dataset.enabled&&(this.targetitem.insertBefore(this.dropzone,this.activentry.label.nextSibling),this.toggleDropTarget(!0))}detachDropzone(){this.dropzone.dataset.enabled&&(this.targetitem=null,this.rootitem!==this.targetitem?this.rootitem.append(this.dropzone):(this.container.append(this.dropzone),this.toggleDropTarget(!1)))}openDirDialog(t,e){("directory"===t?window.showDirectoryPicker:window.showOpenFilePicker)("directory"===t?{mode:"read",multiple:!0}:{types:[{description:"Images,.tsv, zip, gzip, tar files",accept:p}],excludeAcceptAllOption:!0,multiple:!0}).then((t=>{e(t)}))}async handleDrop(t){let e;t.dataTransfer?(t.preventDefault(),e=t.dataTransfer):e=t,this.done=!1,this.initTimer();const s=[...e.items?e.items:e.files];s.length&&(this.enableDropzone(!1),await s.forEach((async t=>{"file"===t.kind&&(t=await t.webkitGetAsEntry(),this.toggleCounters(!0),await this.scanHandle(t))})))}handleDragOver(t){t.preventDefault(),t.dataTransfer.dropEffect="move"}showComplete(){this.timer=(new Date-this.timer)/1e3,console.log("item-------------------------------------"+parseInt(this.timer/60)+" --- "+(this.timer-60*parseInt(this.timer/60))),this.enableDropzone()}stopOnError(t){console.log("err",t)}enableDropzone(t=!0,e=!1){console.log("thisdropzone",this.dropzone),e&&this.dropzone.classList.add(n.iv.hide),t?this.dropzone.dataset.enabled=!0:delete this.dropzone.dataset.enabled}addConsoleMessage(t){t.parent=t.parent?t.parent:this.container,window.alertbox.addConsoleMessage(t)}addUploadDialog(){this.options.controls.scan&&(this.enableDropzone(!0),this.attachDropzone())}async addFilesStore(t,e){if(t=t||this.options.dbname,!this.jsFilesStore){const{JsFilesStore:t}=await s.e(988).then(s.bind(s,5988));this.jsFilesStore=new t(null,e),this.displayFiles()}e&&await e()}displayFiles(){this.jsFilesStore.getItems("local")}fileCounter(t){const e=this.counters[t.name];e.counter+=1,null!==t.size&&(e.size+=parseInt(t.size)),e.display.counter.textContent=e.counter,e.display.size&&(e.display.size.textContent=(0,i.VB)(e.size)),this.quotaEstimate()}resetCounter(t){const e=this.counters[t];["counter","size"].forEach((s=>{this.counters[t][s]=0,e.display[s].textContent=0})),this.toggleCounters(!1)}resetCounters(){Object.keys(this.options.controls).forEach((t=>{this.resetCounter(t)}))}toggleCounters(t=!0){const e=document.getElementById(this.options.display.progression);e&&(t?e.classList.remove(n.iv.hide):e.classList.add(n.iv.hide))}initFileCounter(t,e,s){let n=document.getElementById(this.options.display.progression);const o={display:{}};Object.entries(e).forEach((([e,s])=>{const r=e+"s",a={counter:" read",size:" read",counterzipped:" compressed",sizezipped:" compressed"};let l=n.querySelector("."+r);l||(l=(0,i.Bh)("div",{class:r},n,""));let h=l.querySelector("."+s);h?this.resetCounter(t):(h=(0,i.Bh)("span",{class:s},l," / "),a.hasOwnProperty(s)&&l.append(document.createTextNode(a[s]))),o.display[e]=h,o[e]=0})),this.counters={...this.counters,[t]:o}}showControl(t,e){console.log("opts",e);const s=e.hasOwnProperty("bigfile")&&e.bigfile?"zipped":"zip";let i,o=null;const r=this[this.options.btnprefix+"zip"+s];if(!r)return;r.removeAttribute("disabled");const a=!(!e||!e.part)&&e.part,l=!(!e||!e.bigfile)&&e.bigfile,h=e&&e.path?e.path:this.activentry.getCurrentDirPath();switch(console.log("filepath",h),t){case this.eventnames.ready:this.resetCounters(),this.activentry.list(),r.dataset.message&&delete r.dataset.message,r.classList.add(n.iv.hide);break;case this.eventnames.follow:r.dataset.message&&delete r.dataset.message,r.classList.add(n.iv.hide);break;case this.eventnames.endzip:a||this.showComplete(),r.textContent="Close zip file"+(a||""),r.title=a?"Your file is too big - you have to send this part before continuing to process the directory":"Click to end zip file",i={name:this.eventnames.endzip,part:a,path:h,bigfile:"zip"!==s&&l},r.dataset.message=JSON.stringify(i);break;case this.eventnames.bigfile:r.textContent="Upload big File separately",i={name:this.eventnames.bigfile,path:h,part:a,bigfile:l},r.dataset.message=JSON.stringify(i),console.log("bigfile",i);break;case this.eventnames.sendfile:console.log("opts sendfile",e),i={name:this.eventnames.sendfile,path:h,part:a,bigfile:l},r.textContent="Upload zip file",console.log("message -sendfile- Upload zip file",i),i.bigfile&&""!==i.bigfile&&(r.textContent+=" "+e),r.dataset.message=JSON.stringify(i),console.log("messageup",i);break;case this.eventnames.pending:r.textContent=" Pending "+("zip"!==s?" big file":""),r.dataset.message="",r.setAttribute("disabled",!0);break;case this.eventnames.gzip:o=`compressing separately big file :${e&&e.bigfile?e.bigfile:""} ${e&&e.size?e.size:""}`,r.textContent=o,r.setAttribute("disabled",!0),console.log("optsbigfl",e),r.dataset.message=JSON.stringify({name:this.eventnames.endzip,path:h,part:a,bigfile:l});break;case this.eventnames.terminate:console.log("terminate "+("zip"!==s?"bigfile":"")),r.dataset.message=JSON.stringify({name:"ready",bigfile:"zip"!==s}),r.click()}r.dataset.message&&r.classList.remove(n.iv.hide)}getBtn(t,e){const s=this.options.btnprefix+t+e;if(this[s])return this[s];const i=this.options.controls[t].btn[e],o=document.getElementById(i),r=this.displayprogression;return o?r.append(o):(r.insertAdjacentHTML("beforeend",`<button id="${i}" class="button ${i} ${n.iv.mright} ${n.iv.hide}"></button>`),this[s]=document.getElementById(i),this[s].addEventListener("click",(async t=>{t.stopImmediatePropagation(),this.emitToZip(t.currentTarget)}))),this[s]}initControls(){Object.entries(this.options.controls).forEach((([t,e],s)=>{this.initFileCounter(t,e.display,s),e.btn&&this.activateControls(t,e.btn)}))}activateControls(t,e){Object.keys(e).forEach((e=>{this[this.options.btnprefix+t+e]=this.getBtn(t,e)}))}}}}]);