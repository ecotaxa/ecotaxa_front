/*! For license information please see 388.4f4c41c9cb22eee6203e.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[7,388],{501:(t,e,s)=>{s.d(e,{w:()=>r});s(9418);var i=s(7114),n=s(4860);function r(){const t=(0,n.UP)(),e=(0,n.xJ)("div",{id:t,text:"",class:i.AH.tooltip},document.body);return{applyTo:function(t,s,n=null){t.addEventListener("mouseenter",(()=>{(null===n||n())&&(!function(t,e,s={placement:"bottom-start",offset:{x:2,y:2}}){const i=t.getBoundingClientRect(),n=s.placement.split("-");let r=parseInt(i.top);switch(n[0]){case"bottom":r+=parseInt(i.height);break;case"center":r+=Math.round(parseInt(i.height)/2)}let a=parseInt(i.left);switch(n[1]){case"center":a+=Math.round(parseInt(i.width)/2);break;case"end":a+=parseInt(i.width)}Object.assign(e.style,{left:`${a}px`,top:`${r}px`})}(t,e,{placement:"top-center"}),setTimeout((function(){e.classList.remove(i.AH.hide),e.textContent=s}),100))})),t.addEventListener("mouseout",(()=>{(null===n||n())&&setTimeout((function(){e.classList.add(i.AH.hide),e.textContent=""}),600)}))}}}},3438:(t,e,s)=>{s.a(t,(async(t,i)=>{try{s.d(e,{HK:()=>u,Pc:()=>p,gt:()=>h,v3:()=>g});var n=s(4860),r=s(7114),a=s(7104),o=s(2438),c=s(501),l=t([a,o]);[a,o]=l.then?(await l)():l;const d=(0,c.w)(),h=Object.freeze({node:"N",branch:"B",root:"R",discard:"D",discarded:"X"}),p={selector:"[data-name]",tags:{tag:"ul",subtag:"li",label:"span"},selectors:{entries:".entries"},draggables:[],prefix:"entry",css:{on:"on",entryN:"entryN",entryB:"entryB",entryR:"entryR",entryD:"entryD",editable:"editable",dragging:"dragging",dragover:"dragover",dragitem:"dragitem",selected:"selected"},event:{name:"eventEntry"}};class u{eventnames={attach:"attach",control:"control"};name;type;label;entries=[];event={listener:window,name:p.event.name,init:{bubbles:!1,cancelable:!0}};constructor(t,e={}){return this.name=t.name,this.type=t.type,this.id=t.id,this.parent=t.parent,this.options={...p,...e},this.uuid=(0,n.UP)(),this.eventnames={...this.eventnames,...this.options.eventnames},this.label=e.label?e.label:null,this.event={name:p.event.name,listener:e.listener?e.listener:this.uuid},this.init(t),this}init(t){const e={name:this.name,type:this.type};null!==this.label&&(e.label=this.label);const s=(0,n.xJ)(this.options.tags.subtag,{draggable:this.isDraggable(),dataset:e}),i=`${this.options.prefix}${this.type}`;[h.branch,h.root,h.discard].indexOf(this.type)>=0&&(this.icon=(0,n.xJ)("span",{class:"ico-"+i},s)),this.label=(0,n.xJ)(this.options.tags.label,{class:i,text:t.label?t.label:t.name},s),this.container=s,this.loaded=this.container.dataset.loaded=!1,this.initEvents()}initEvents(){this.addListeners()}getParent(){return this.parent}getLabelElement(){return this.label}getParentElement(){return this.container.parentElement.closest(this.options.selector)}getEntries(){return this.entries}getEntriesElement(t=!1){let e=this.container.querySelector(this.options.selectors.entries);return t&&null===e?(0,n.xJ)(this.options.tags.tag,{class:this.options.selectors.entries.substr(1)},this.container):e}appendEntry(t){if(t.parent&&t.parent.entries){const e=t.parent.entries.indexOf(t);delete t.parent.entries[e]}t.parent=this,this.entries.push(t);return this.getEntriesElement(!0).append(t.container),t}newEntry(t){return new u(t,this.options)}setAttributes(t){return t}extraStyles(t){}setDiscard(){}createEntry(t){this.options.css.icons=[],t=this.setAttributes(t),this.extraStyles(t);const e=this.newEntry(t,this.options);return this.appendEntry(e),e.addListeners(),e.setDiscard(),e}findEntry(t){const e=this.getEntries();for(const s of e)if(s.name===t)return s;return null}createListEntries(t){this.getEntriesElement(!0);t.forEach((t=>{t.forEach((t=>{this.createEntry(t)}))}))}removeEntries(){this.entries=[];const t=this.getEntriesElement();t&&t.remove()}isActive(){return this.active}toggleActive(){this.setOn(!this.active)}toggleOpen(){this.setOpen(!this.open)}setSelected(t=!0){const e=this.options.css.selected;!0===t?this.container.classList.add(e):this.container.classList.remove(e),this.setOn(t)}setOn(t=!0){this.active=t}setOpen(t=!0){const e=()=>{this.open=t,!0===t?this.container.classList.add(this.options.css.on):this.container.classList.remove(this.options.css.on)};!this.loaded&&t?this.list().then((()=>{e()})):e()}setOff(){this.setSelected(!1)}getListeners(){let t=[];let e;return e=this.type===h.node?t=>{t.stopImmediatePropagation(),this.toggleActive(),this.emitEvent()}:t=>{t.stopImmediatePropagation(),this.branchListener((()=>{this.emitEvent(this.eventnames.attach)}))},t.unshift({name:"click",target:"label",func:e}),[h.root,h.branch,h.discard].indexOf(this.type)>=0&&(e=t=>{t.stopImmediatePropagation(),this.toggleOpen()},t.unshift({name:"click",target:"icon",func:e}),d.applyTo(this.icon,"click to display children of this entry")),d.applyTo(this.label,"click to activate tools on this entry",(()=>!0!==this.active)),t}isBranch(t=!0){const e=[h.branch];return t&&e.indexOf(h.root)<0&&e.push(h.root),e.indexOf(this.type)>=0}isDiscarded(){return[h.discarded].indexOf(this.type)>=0}emitEvent(t=null,e=null){const s={entry:this};t&&(s.action=t),e?s.event=e:e=this.eventnames.control,o.j.emit(this.event.name,s,this.event.listener)}moveHandlers(){return[{name:"dragstart",func:t=>{this.handleDragStart(t)}},{name:"dragend",func:t=>{this.handleDragEnd(t)}}]}dropHandlers(){return[{name:"dragover",func:t=>{this.handleDragOver(t)}},{name:"drop",func:t=>{this.handleDrop(t)}}]}branchListener(t=null){this.toggleActive(),this.isActive()&&this.branchActivate(t).then((()=>{this.emitEvent()}))}addListeners(){const t=this.getListeners();for(const e of t){("label"===e.target?this.getLabelElement():"icon"==e.target?this.icon:this.container).addEventListener(e.name,e.func)}}removeListeners(t){for(const e in t){("label"===e.target?this.getLabelElement():this.container).removeEventListener(e.label,e.func)}}destroy(){this.container.remove()}handleDragStart(t){t.stopImmediatePropagation(),this.container.classList.add(this.options.css.dragging),t.dataTransfer.effectAllowed="move",this.emitEvent("dragstart",t)}handleDragOver(t){t.stopPropagation(),t.preventDefault(),this.emitEvent("dragover",t)}handleDragEnd(t){t.stopPropagation(),t.preventDefault(),this.container.classList.remove(this.options.css.dragging),this.emitEvent("dragend",t)}resetDragOver(){document.querySelectorAll("."+this.options.css.dragover).forEach((t=>{t.classList.remove(this.options.css.dragover)}))}handleDrop(t){t.stopImmediatePropagation(),this.emitEvent("drop",t)}setWait(){this.loaded=this.container.dataset.loaded=!1,this.container.classList.add(r.AH.wait)}setLoaded(){this.container.classList.remove(r.AH.wait),this.loaded=this.container.dataset.loaded=!0}findEntry(t,e){const s=this.getEntries();for(const i of s)if(i.name===t&&i.type===e)return i;return null}async branchActivate(t=null){t&&t(this)}getCurrentPath(){const t=(e,s=[])=>e.name&&(s.push(e.name),null!==(e=e.getParent()))?t(e,s):s;let e=t(this);return e.length>1&&(e=e.reverse()),e}async jsonEntries(t){return await t.json()}isDraggable(){return this.options.draggables&&this.options.draggables.indexOf(this.type)>=0}async list(){if(this.type===h.node)return;const t=this.getUrl?this.getUrl():null;if(null===t)return;this.options.tags.tag,this.options.tags.subtag;this.setWait(),this.removeEntries();const e={headers:new Headers({"content-type":"application/json"})},s=await fetch(t,(0,n.Uc)(e));if(s.ok){const t=await this.jsonEntries(s);if(t.length){let e=[],s=[];for(;t.length>0;){const i=t.shift();!1===i.children?e.push(i):s.push(i)}e.sort(((t,e)=>t.name<e.name)),s.sort(((t,e)=>t.name<e.name)),this.createListEntries([s,e])}this.setLoaded()}else a.y.addMessage({parent:this.container,type:"error",content:s.error+" "+s.text})}moveTo(t){const e=t.getCurrentPath(),s=t.type===h.discard?h.discarded:t.type;e.pop(),e.forEach(((e,i)=>{let n=t.findEntry(e,s);null===n&&(n=t.createEntry({type:s,name:e})),t=n})),null===t.findEntry(this.name,this.type)&&(this.from=this.parent,t.appendEntry(this))}unMove(){this.from&&(this.moveTo(this.from),this.from=null)}}function g(t=document,e={}){let s,i=null;function a(t,e=null,r=null){const a=(0,n.xJ)("span",t.class?{class:t.class}:{}),o=s.children.length;if(null===e||o<e+1?s.append(a):0===e||0===o?s.prepend(a):s.inserBefore(crtl,s.children[e]),t.typentries&&(a.dataset.typentries=t.typentries),t.icon){(0,n.xJ)("i",{class:["icon",t.icon]},a);d.applyTo(a,t.text)}else a.textContent=t.text;const c=t.trigger?t.trigger:"click";a.addEventListener(c,(e=>{if(null===i)return;const s={callback:()=>{console.log("done",t.action)}};i[t.action]||null===r?i[t.action]&&i[t.action](s):r(i),t.callback&&t.callback(e)})),t.ctrl=a}function o(){null!==i&&(i.container.classList.remove(e.selectors.hascontrols.substr(1)),s.classList.add(r.AH.hide),s.disabled=!0,t.append(s),i=null)}function c(t,e=!1){const s=t.ctrl;if(t.exclude&&null!==i&&t.exclude.indexOf(i.name)>=0)return void s.classList.add(r.AH.hide);const n=s.dataset.typentries?s.dataset.typentries.split(","):[],a=e?h.discarded:i?i.container.dataset.type:null;n.indexOf(a)>=0?s.classList.remove(r.AH.hide):s.classList.add(r.AH.hide)}function l(){if(null===i)return;const t=i.isDiscarded();Object.values(e.controls).filter((t=>t.icon||t.text)).forEach((e=>{c(e,t)}))}return e=Object.assign({selectors:{typentries:"[data-typentries]",hascontrols:".has-controls"},controls:{list:{action:"list",typentries:["B","T"]}},css:{entrycontrols:"entrycontrols",entries:".entries"}},e),s=(0,n.xJ)("div",{class:[e.css.entrycontrols,r.AH.hide]}),Object.values(e.controls).filter((t=>t.icon||t.text)).forEach((t=>{a(t)})),{options:e,addControl:a,attachControls:function(t){o(),i=t,i.container.prepend(s),i.container.classList.add(e.selectors.hascontrols.substr(1)),l(),s.classList.remove(r.AH.hide),delete s.disabled},detachControls:o,showControls:function(t=!0){!0===t?s.classList.remove(r.AH.hide):s.classList.add(r.AH.hide),s.disabled=!t},activateControls:l,activateControl:c}}i()}catch(m){i(m)}}))},4945:(t,e,s)=>{s.a(t,(async(t,i)=>{try{s.d(e,{N:()=>m});var n=s(4860),r=s(7114),a=s(7104),o=s(2438),c=s(3438),l=t([a,o,c]);[a,o,c]=l.then?(await l)():l;const d={images:"png,jpeg,jpg,gif",tsv:"txt,tsv,zip, gzip,gz"};r.AH.intrash="intrash";const h={directory:"D",file:"F"},p="trash.",u={api_parameters:{entry:"entry",dest:"dest",rootname:"My Files"},url:"/gui/files",controls:{scan:{display:{counter:"counter",size:"size"}},zip:{btn:{zip:"makezip",zipped:"makezipped"},display:{size:"sizezipped",counter:"counterzipped"}}},upload:{label:"upload"},btnprefix:"btn",btnfilelist:null,entry:{draggables:[c.gt.branch,c.gt.node],icons:{image:"img",document:"doc"}},entrycontrols:{selectors:{typentries:"[data-typentries]",hascontrols:".has-controls"},controls:{list:{action:"list",typentries:[c.gt.branch,c.gt.root,c.gt.discard]},create:{action:"create",text:"new folder",icon:"icon-folder-plus",typentries:[c.gt.branch,c.gt.root]},remove:{action:"remove",text:"delete",icon:"icon-trash",typentries:[c.gt.branch,c.gt.node,c.gt.discarded]},move:{action:"move",typentries:[c.gt.branch,c.gt.node]},rename:{action:"rename",trigger:"dblclick",typentries:[c.gt.branch,c.gt.node]}},css:{entrycontrols:"entrycontrols",entries:".entries"}},selectors:{doupload:".target-upload",droptarget:".droptarget",dirlist:".dirlist",uploadfile:"uploadfile",displayimport:"displayimport",trigger:".trigger"}};function g(t,e){const s=new c.HK(t,e);return s.eventnames={attach:"attach",detach:"detach",isdiscard:"isdiscard",discarded:"discarded",editable:"editable"},s.newEntry=function(t){return g(t,this.options)},s.isTrashDir=function(t=null){return 0===(null===t?this.name:t).indexOf(p)},s.isInTrash=function(t=null){return null===(t=null===t?this.getCurrentDirPath():t)&&(0,n.WF)("path_not_found"),0===((t=t.split(n.hx)).length>1&&t[0].indexOf(p))},s.branchListener=function(t=null){"create"!==this.container.dataset.action&&(this.toggleActive(),this.isActive()&&this.branchActivate(t).then((()=>{this.emitEvent()})))},s.getCurrentDirPath=function(){return this.getCurrentPath().join(n.hx)},s.fetchAction=async function(t,e=null,s=null){const i=this.options.api_parameters,r=this.getLabelElement();let o=this.getCurrentDirPath();if(""===o)return;const c=new FormData;switch(c.append(i.entry,o),t){case this.options.actions.create:if(null===r)return;o=o.split(n.hx),o[o.length-1]=r.textContent,""!==o&&c.set(i.entry,o.join(n.hx));break;case this.options.actions.move:if(null===e)return;{let t=e();if(e=null,t===o)return;c.append(i.dest,t)}break;case this.options.actions.rename:const t=o.split(n.hx);if(t[t.length-1]=r.textContent,t.join(n.hx)===o)return;c.append(i.dest,t.join(n.hx))}const l=await fetch(this.options.url+n.bJ+t,(0,n.Uc)({method:"POST",body:c})),d=await l.json();if(200===l.status)return e&&e(d.message),!0;if(s)s(d);else{"string"==typeof d.body&&(d.body=JSON.parse(d.body));const t=d.body.detail?d.body.detail:d.body;a.y.addAlert({type:"error",content:l.status+" "+d.text+" "+t,dismiss:!0})}return!1},s.listenRename=function(t="dblclick"){const e=this,s=e.getLabelElement();s.addEventListener(t,(t=>{s.dataset.oldname=s.textContent,this.type!==c.gt.discard?(e.setEditable(),(0,n.Xu)(e.label)):t.preventDefault()})),e.container.addEventListener("click",(t=>{t.preventDefault(),t.stopImmediatePropagation(),e.setEditable(!1),e.container.dataset.action===e.options.actions.create&&e.container.remove()}))},s.setEditable=function(t=!0){const e=this,s=e.getLabelElement(),i=async t=>{if("Enter"===t.key){if(t.preventDefault(),s.dataset.oldname&&s.dataset.oldname!==s.textContent){const t=t=>{""===t?a.y.addMessage(s,{type:"error",content:a.y.i18nmessages.exists,duration:2e3,dismiss:!0}):t=t.split(n.hx).pop(),s.textContent=t,e.type===c.gt.branch&&e.branchListener(),delete e.container.dataset.action},i=e.container.dataset.action?e.container.dataset.action:e.options.actions.rename;await e.fetchAction(i,t)}e.setEditable(!1)}};!0===t?(s.contentEditable=!0,e.container.draggable=!1,s.classList.add(e.options.css.editable),s.addEventListener("keydown",i)):(s.contentEditable=!1,s.classList.remove(e.options.css.editable),s.removeEventListener("keydown",i),e.container.draggable=e.isDraggable())},s.getListeners=function(){let t=[],e=t=>{t.stopImmediatePropagation(),this.branchListener((()=>{this.emitEvent(this.eventnames.attach)}))};return[c.gt.root,c.gt.discard].indexOf(this.type)<0?(t=this.moveHandlers(),this.type===c.gt.node?e=t=>{t.stopImmediatePropagation(),this.toggleActive(),this.emitEvent()}:this.isInTrash()?this.type=c.gt.discarded:t=t.concat(this.dropHandlers()),this.listenRename()):t=t.concat(this.dropHandlers()),t.unshift({name:"click",target:"label",func:e}),t},s.setAttributes=function(t){return t.type=t.type===h.directory?c.gt.branch:c.gt.node,this.isTrashDir(t.name)&&(t.type=c.gt.discard),t.parent=this,t},s.extraStyles=function(t){const e=t.name.split(".").pop();t.type===c.gt.node&&(d.images.split(",").indexOf(e)>=0?this.options.icons.image:this.options.icons.document)},s.setDiscard=function(){this.type===c.gt.discard&&this.emitEvent(this.eventnames.isdiscard)},s.getUrl=function(){const t=this.name?this.getCurrentDirPath():null;return this.options.url+n.bJ+this.options.actions.list+(t?n.hx+t:"")},s.jsonEntries=async function(t){const e=await t.json();return e.entries?e.entries:void 0},s.remove=function(){this.isTrashDir()||this.fetchAction(this.options.actions.remove).then((t=>{!0===t&&(this.setParent(null),this.removeListeners(this.dropHandlers()),this.setOff(),this.container.animate({transform:"translateX(-100%) scale(0)"},{duration:1e3}),setTimeout((()=>{this.from&&this.from.isInTrash()?this.destroy():this.emitEvent(this.eventnames.discarded)}),1e3))})).catch((t=>{a.y.addMessage({parent:this.container,type:"error",content:t.message?t.message:t.error+" "+t.text,dismiss:!0})}))},s.create=function(){const t=this.createEntry({type:h.directory,name:"NewFolder"}),e=()=>{this.getEntriesElement().prepend(t.container),t.container.dataset.action=this.options.actions.create,t.label.dispatchEvent(new Event("dblclick"))};this.loaded?e():this.list().then((()=>{this.setOpen(!0),e()}))},s.rename=function(){this.isTrashDir()||this.fetchAction(this.options.actions.rename).then((()=>{console.log("renamed",this)}))},s.move=function(t,e=null){if(!this.isTrashDir())return this.isDiscarded()?this.remove():void this.fetchAction(this.options.actions.move,(()=>t.getCurrentDirPath()+n.hx+this.name)).then((()=>{this.setParent(t),null!==e&&e()})).catch((t=>{a.y.addMessage({parent:this.container,type:"error",content:t.message?t.message:t.error+" "+t.text,dismiss:!0})}))},s.setParent=function(t){if(this.from=this.parent,null!==t){t.entries.push(this),this.parent=t;t.getEntriesElement(!0).append(this.container)}const e=this.parent.entries.indexOf(this);e>=0?delete this.parent.entries[e]:console.log("entry not found in parent entries",this.parent)},s}class m{eventnames={attach:"attach",detach:"detach",action:"action",complete:"complete",error:"error"};options;uuid;detachcallback=null;constructor(t,e={}){if(!t.jsdirlist){if(!(t=t instanceof HTMLElement?t:document.querySelector(t)))return;this.options={...u,...e},this.options.entry={...c.Pc,...this.options.entry},this.options.entry.url=this.options.url,this.container=(0,n.xJ)(this.options.entry.tags.tag,{class:this.options.selectors.dirlist.substr(1)},t),this.uuid=(0,n.UP)(),this.init(),this.container.append(this.root.container),t.jsdirlist=this}return t.jsdirlist}init(){const t=c.gt.root,e={};this.entrycontrols=void 0===this.entrycontrols?(0,c.v3)(this.container,this.options.entrycontrols):null,Object.entries(this.options.entrycontrols.controls).forEach((([t,s])=>{e[t]=s.action})),this.options.entry.actions=e;const s={...this.options.entry,api_parameters:this.options.api_parameters};s.listener=this.uuid,this.root=g({type:t,name:"",label:this.options.api_parameters.rootname,class:this.options.api_parameters.rootclass},s),this.initEvents(),this.root.addListeners()}initEvents(t){o.j.on(this.options.entry.event.name,(t=>{const e=t.entry.eventnames;switch(t.action){case e.isdiscard:this.trashdir&&this.trashdir.container.remove(),this.trashdir=t.entry,this.root.container.parentElement.insertBefore(t.entry.container,this.root.container),this.root.container.append(t.entry.container);break;case e.discarded:let s=t.entry.parent;t.entry.isInTrash()?(t.entry.container.remove(),s=this.root):(t.entry.moveTo(this.trashdir),t.entry.container.classList.add(r.AH.intrash)),this.attachControls(s);break;case e.attach:this.detachcallback&&this.detachcallback();const i=t.entry.isInTrash()?c.gt.discarded:t.entry.container.dataset.type;if(i===c.gt.discard)return;if(t.action===e.attach&&i===c.gt.discarded)return;this.attachControls(t.entry);break;case"dragstart":this.dragentry=this.activentry=t.entry,t.entry.container.classList.add(t.entry.options.css.dragging),this.detachControls();break;case"dragover":if(!this.dragentry)return;this.overitem!==t.entry.container&&(this.overitem&&this.overitem.classList.remove(t.entry.options.css.dragover),t.entry.container.classList.add(t.entry.options.css.dragover),this.overitem=t.entry.container);break;case"dragend":this.dragentry=null,this.overitem&&this.overitem.classList.remove(t.entry.options.css.dragover),this.overitem=null;break;case"drop":this.dragentry||o.j.emit(this.eventnames.action,t,this.uuid);const n=t.entry;if(n.resetDragOver(),this.dragentry)if(this.dragentry.options.actions.move)try{this.dragentry.move(n),[c.gt.discarded].indexOf(n.type)>=0&&this.attachControls(n)}catch(t){console.log("error drop ",t),this.dragentry.unMove()}else console.log("no action on drop");break;case e.editable:this.editable&&this.editable.setEditable(!1);break;default:t.entry.active?this.attachControls(t.entry):this.attachControls(this.root)}}),this.uuid)}getActiventry(){return this.activentry}setActiventry(t=null){this.activentry=t}attachControls(t){this.entrycontrols&&this.entrycontrols.attachControls(t),this.activentry=t,o.j.emit(this.eventnames.attach,{entry:this.activentry},this.uuid)}detachControls(){const t=this.activentry&&this.activentry.parent?this.activentry.parent:this.root;this.entrycontrols&&this.entrycontrols.attachControls(t),this.activentry=t,o.j.emit(this.eventnames.attach,{entry:t},this.uuid)}}i()}catch(y){i(y)}}))},8388:(t,e,s)=>{s.a(t,(async(t,i)=>{try{s.d(e,{JsMyFiles:()=>p});var n=s(4860),r=s(7114),a=s(7104),o=s(4945),c=s(2438),l=t([a,o,c]);[a,o,c]=l.then?(await l)():l;const d={"image/*":[".png",".jpeg",".jpg"],"text/tab-separated-values":[".tsv"],"application/zip":[".zip"],"application/gzip":[".gz"],"application/x-bzip":[".bz"],"application/x-bzip2":[".bz2"]},h=Object.values(d).reduce(((t,e)=>t.concat(e)));r.AH.button="button p-1 mx-auto sm:mr-4 mb-4";class p{done=!0;jsDirToZip=null;jsDirList=null;trash_dir_name="trash.";counters={};_events={};eventnames={complete:"complete",error:"error"};rejected=[];errorfile=[];listener;constructor(t,e={}){if(!t.jsmyfiles){if(!(t=t instanceof HTMLElement?t:document.querySelector(t)))return;(0,n.vg)(t,"dataset"),this.container=t;const s={controls:{scan:{display:{counter:"counter",size:"size"}},zip:{btn:{zip:"makezip",zipped:"makezipped"},display:{size:"sizezipped",counter:"counterzipped"}},reject:{display:{counter:"counterrejected"}},errorfile:{display:{counter:"countererrorfile"}}},upload:{label:"upload"},btnprefix:"btn",btnfilelist:null,selectors:{droptarget:".droptarget",trigger:".trigger",uploadfile:"uploadfile"},display:{progression:"display-progression",dropzone:"dropzone",boxtitle:"boxtitle",counters:"counters",sizes:"sizes",timers:"timers"},css:{dragover:"dragover"}};this.options=Object.assign(s,e),this.options.browse=t.dataset.browse?t.dataset.browse.split(","):["directory","file"],this.haspicker=window.showDirectoryPicker,this.uuid=(0,n.UP)(),this.init(),t.jsmyfiles=this}return t.jsmyfiles}init(){this.addDisplayProgression(),this.addDropzone(),this.addDirList(),this.initControls(),this.initEvents().then((()=>{this.resetCounters()}))}initTimer(){this.timer=new Date}async initEvents(){c.j.on(this.eventnames.processed,(async t=>{this.nextaction&&await this.nextaction()}),this.uuid);const t=this;if(this.options.controls.zip){const{JsDirToZip:e}=await Promise.all([s.e(982),s.e(681)]).then(s.bind(s,681));this.jsDirToZip=e({listener:this.uuid}),Object.keys(this.jsDirToZip.eventnames).forEach((e=>{this.eventnames[e]=this.jsDirToZip.eventnames[e],c.j.on(e,(s=>{switch(e){case this.eventnames.counter:this.fileCounter(s);break;case this.eventnames.reject:this.rejected.push(s.path),this.fileCounter({name:"reject",path:s.path});break;case this.eventnames.follow:case this.eventnames.complete:if(!s||!s.hasOwnProperty("name")||""===s.name)return void console.log("no emit complete name"+e,s);t.showControl(s.name,s);break;case this.eventnames.message:switch(s.name){case"console":this.addConsoleMessage({id:s.id?s.id:null,content:s.message,parent:this.container});break;case"browser":a.y.addAlert({type:a.y.alertconfig.types.danger,content:s.message,dismissible:!1,inverse:!1});break;case a.y.alertconfig.types.error:case a.y.alertconfig.types.success:case a.y.alertconfig.types.danger:case a.y.alertconfig.types.info:a.y.addAlert({type:s.name,content:s.message,dismissible:!0,inverse:!1}),console.log("error",s);break;default:console.log("message",s)}}}),this.uuid)})),this.jsDirToZip.browserRequired()}window.addEventListener("beforeunload",(t=>{this.done||(t.preventDefault(),t.returnValue=this.options.preventclose?this.options.preventclose:"Some work is in progress in this window.\nAre you sure you want to leave?")}))}emitToZip(t){const e=t.dataset.message?JSON.parse(t.dataset.message):null;if(e||t.classList.add(r.AH.hide),e&&e.name){const t=e.name;delete e.name,c.j.emit(t,e,this.jsDirToZip.uuid)}name===this.eventnames.sendfile&&(t.disabled=!0)}quotaEstimate(t){return this.jsDirToZip.quotaEstimate()}scanBrowse(t,e){return this.jsDirToZip.scanBrowse(t,e)}scanHandle(t,e){return this.jsDirToZip.scanHandle(t,e)}async handleBrowse(t){this.setUploadEntry()&&(this.initTimer(),this.toggleCounters(!0),this.haspicker||(t=t.target.files),await this.scanBrowse(t,{accept:h}))}addDropzone(){this.dropzone=(0,n.xJ)("div",{id:this.options.display.dropzone});const t=this.haspicker?null:(0,n.xJ)("input",{type:"file",name:this.options.selectors.uploadfile,id:this.options.selectors.uploadfile,multiple:!0,allowdirs:!0,accept:h,class:"hidden"},this.dropzone);t&&t.addEventListener("change",(t=>{this.handleBrowse(t)}));const e=(0,n.xJ)("div",{},this.dropzone);this.options.browse.forEach((s=>{const i=this.container.dataset[`textbrowse${s}`]?this.container.dataset[`textbrowse${s}`]:`browse${s}`;(0,n.xJ)("span",{class:this.options.selectors.trigger.slice(1),dataset:{type:s},text:i},e).addEventListener("click",(async e=>{this.haspicker?this.openDirDialog(s,(t=>{this.handleBrowse(t)})):("directory"===s?(t.directory=!0,t.webkitdirectory=!0):(t.directory=!1,t.webkitdirectory=!1),t.dispatchEvent(new MouseEvent("click"))),this.eventnames.clearother&&c.j.emit(this.eventnames.clearother,{},this.uuid)}))}));(0,n.xJ)("span",{text:this.container.dataset.textdrop},e)}toggleDropTarget(t=!0){const e=this,s=this.activentry?this.activentry.container:null;if(null===s)return;function i(t){s.classList.add(r)}function n(t){s.classList.remove(r)}const r=this.jsDirList&&this.jsDirList.options.entry?this.jsDirList.options.entry.css.dragover:this.options.css.dragover,a=async t=>{await e.handleDrop(t)};!1===t?(["dragenter","dragover"].forEach((t=>{s.removeEventListener(t,i,!1)})),["dragleave","drop"].forEach((t=>{s.removeEventListener(t,n,!1)})),s.removeEventListener("drop",a),s.classList.remove(this.options.selectors.droptarget.substr(1))):(["dragenter","dragover"].forEach((t=>{s.addEventListener(t,i,!1)})),["dragleave","drop"].forEach((t=>{s.addEventListener(t,n,!1)})),s.addEventListener("drop",a),s.classList.add(this.options.selectors.droptarget.substr(1)))}async addDirList(){this.jsDirList=new o.N(this.container),this.activentry=this.jsDirList.root,this.rootitem=this.targetitem=this.activentry.container,c.j.on(this.jsDirList.eventnames.attach,(t=>{t.entry&&(t.entry!==this.activentry&&this.activentry.isBranch(!0)&&this.detachDropzone(),this.activentry=t.entry,this.targetitem=this.activentry.container,this.activentry.isBranch(!0)&&this.addUploadDialog())}),this.jsDirList.uuid),c.j.on(this.jsDirList.eventnames.detach,(t=>{this.detachDropzone(),this.activentry=null,this.uploadentry=null,this.targetitem=null}),this.jsDirList.uuid),c.j.on(this.jsDirList.eventnames.action,(t=>{if("drop"===t.action)this.handleDrop(t.event);else console.log("action not managed "+t.action,t)}),this.jsDirList.uuid),this.activentry.label.dispatchEvent(new Event("click"))}addDisplayProgression(){if(this.displayprogression)return;let t=document.getElementById(this.options.display.progression);t||(t=(0,n.xJ)("div",{id:this.options.display.progression},this.container),t.insertAdjacentHTML("afterbegin",`<div class="${this.options.display.progression}"><div class="${this.options.display.counters}"></div><div class="${this.options.display.sizes}"></div><div class="${r.AH.progress}"></div><div class="${this.options.display.timers}"></div></div>`),this.displayprogression=t)}enableDropzone(t=!0,e=!1){(e||!1===t)&&this.dropzone.classList.add(r.AH.hide),t?(this.dropzone.dataset.active=!0,this.dropzone.classList.remove(r.AH.hide)):delete this.dropzone.dataset.active}attachDropzone(){this.dropzone.dataset.active&&(this.targetitem.insertBefore(this.dropzone,this.activentry.label.nextElementSibling),this.toggleDropTarget(!0)),["dragover","dragenter"].forEach((t=>{window.addEventListener(t,(function(t){t.preventDefault()}),!1)}))}detachDropzone(){this.enableDropzone(!1),this.toggleDropTarget(!1)}openDirDialog(t,e){("directory"===t?window.showDirectoryPicker:window.showOpenFilePicker)("directory"===t?{mode:"read",multiple:!0}:{types:[{description:"Images,.tsv, zip, gzip, tar files",accept:d}],excludeAcceptAllOption:!0,multiple:!0}).then((t=>{e(t)}))}setUploadEntry(){return this.uploadentry&&this.uploadentry!==this.activentry?(a.y.addAlert({type:"error",content:"Only one upload destination authorized. Close and upload the current zipfile.",dismissible:!0,inverse:!0}),!1):(this.uploadentry=this.activentry,!0)}async handleDrop(t){if(t.preventDefault(),t.stopPropagation(),!this.setUploadEntry())return;let e;e=t.dataTransfer?t.dataTransfer:t,this.done=!1,this.initTimer();const s=[...e.items?e.items:e.files];s.length&&(this.enableDropzone(!1),await s.forEach((async t=>{"file"===t.kind&&(t=await t.webkitGetAsEntry(),this.toggleCounters(!0),await this.scanHandle(t))})))}showComplete(){this.timer=(new Date-this.timer)/1e3,this.enableDropzone(!0)}stopOnError(t){console.log("err",t)}addConsoleMessage(t){t.parent=t.parent?t.parent:this.container,a.y.addConsole(t)}addUploadDialog(){this.options.controls.scan&&(this.enableDropzone(!0),this.attachDropzone())}async addFilesStore(t,e){if(t=t||this.options.dbname,!this.jsFilesStore){const{JsFilesStore:t}=await s.e(179).then(s.bind(s,6179));this.jsFilesStore=new t(null,e),this.displayFiles()}e&&await e()}displayFiles(){this.jsFilesStore.getItems("local")}fileCounter(t){const e=this.counters[t.name];e.counter+=1,null!==t.size&&(e.size+=parseInt(t.size)),e.display.counter.textContent=e.counter,e.display.size&&(e.display.size.textContent=(0,n.Y2)(e.size)),this.quotaEstimate()}resetCounter(t){const e=this.counters[t];["counter","size"].forEach((t=>{e.display[t]&&(e[t]=0,e.display[t].textContent=0)}))}resetCounters(){Object.keys(this.options.controls).forEach((t=>{this.resetCounter(t)})),this.toggleCounters(!1)}toggleCounters(t=!0){const e=document.getElementById(this.options.display.progression);e&&(t?e.classList.remove(r.AH.hide):e.classList.add(r.AH.hide))}initFileCounter(t,e,s){let i=document.getElementById(this.options.display.progression);const r={display:{}};Object.entries(e).forEach((([e,s])=>{const a=e+"s",o={counter:" read",size:" read",counterzipped:" compressed",sizezipped:" compressed",counterrejected:" rejected",countererrorfile:" error"},c=["counterrejected","countererrorfile"];let l=i.querySelector("."+a);l||(l=(0,n.xJ)("div",{class:a},i,""));let d=l.querySelector("."+s);if(d)this.resetCounter(t);else if(d=(0,n.xJ)("span",{class:s},l," / "),o.hasOwnProperty(s))if(c.indexOf(s)>=0){const t=(0,n.xJ)("a",{text:o[s],class:"text-error",title:`Click to display the list of ${o[s]} files`},l);t.addEventListener("click",(e=>{e.preventDefault(),this.displayExcept(t,s)}))}else l.append(document.createTextNode(o[s]));r.display[e]=d,r[e]=0})),this.counters={...this.counters,[t]:r}}displayExcept(t,e){e=e.replace("counter","");const s={rejected:" type rejected",errorfile:" in error"};if(Object.keys(s).indexOf(e)<0)return;const i={type:a.y.alertconfig.types.warning,parent:t,content:`Files ${this.rejected.join("<br>")} ${s[e]}`};t.dataset.hasmessage?(a.y.removeMessage(i),delete t.dataset.hasmessage):(t.dataset.hasmessage=!0,a.y.addMessage(i))}showControl(t,e){const s=!(!e||!e.part)&&e.part,i=!(!e||!e.bigfile)&&e.bigfile,a=e&&e.path?e.path:this.uploadentry.getCurrentDirPath(),o=e.hasOwnProperty("bigfile")&&!1!==i?"zipped":"zip";let c,l=null;const d=this[this.options.btnprefix+"zip"+o];if(!d)return;d.disabled=!1;switch(t){case this.eventnames.ready:this.resetCounters(),this.uploadentry&&this.uploadentry.list().then((()=>{this.uploadentry.setOpen(!0),this.uploadentry=null})),c=null;break;case this.eventnames.follow:i?(console.log(" follow",e),c={},d.textContent="Wait for next operation",d.disabled=!0):c=null;break;case this.eventnames.bigfile:i&&""!==i&&(d.textContent="Upload big File separately",c={name:this.eventnames.bigfile,path:a,part:s,bigfile:i});break;case this.eventnames.endzip:s||this.showComplete(),d.textContent="Upload zip file"+(s?" "+s:""),d.title=s?"Your file is too big - you have to send this part before continuing to process the directory":"Click to send zip file",c={name:this.eventnames.endzip,part:s,filepath:a,path:a,bigfile:i};break;case this.eventnames.sendfile:return d.dataset.message=JSON.stringify({name:this.eventnames.sendfile,path:a,part:s,bigfile:i}),void setTimeout((()=>{this.emitToZip(d)}),1e3);case this.eventnames.pending:d.textContent=" Pending "+("zip"!==o?" big file":""),d.disabled=!0,c={};break;case this.eventnames.gzip:l=`compressing big file :${e&&e.bigfile?a:""} ${e&&e.size?(0,n.Y2)(e.size):""}`,d.textContent=l,d.disabled=!0,c={};break;case this.eventnames.terminate:return d.dataset.message=JSON.stringify({name:this.eventnames.init,bigfile:i,part:s,path:a}),d.classList.add(r.AH.hide),void d.click();case this.eventnames.errorfile:this.errorfile.push(a);case this.eventnames.error:d.textContent=e.text?e.text:"Error",c={name:e.name,path:a,part:s,bigfile:i},console.log("error control"+t,c);break;default:return void console.log("default control"+t,e)}null===c?(delete d.dataset.message,d.classList.add(r.AH.hide)):(d.dataset.message=JSON.stringify(c),d.classList.remove(r.AH.hide),d.disabled?(d.classList.add(r.AH.console),d.insertAdjacentHTML("afterbegin",(0,n.QW)("text-stone-200 ml-1 mr-2 align-text-bottom inline-block"))):d.classList.remove(r.AH.console))}getBtn(t,e){const s=this.options.btnprefix+t+e;if(this[s])return this[s];const i=this.options.controls[t].btn[e],a=document.getElementById(i),o=this.displayprogression;return a?o.append(a):(this[s]=(0,n.xJ)("button",{id:i,class:[i,r.AH.hide].concat(r.AH.button.split(" "))},o),this[s].addEventListener("click",(async t=>{t.stopImmediatePropagation(),t.preventDefault(),this.emitToZip(t.currentTarget)}))),this[s]}initControls(){Object.entries(this.options.controls).forEach((([t,e],s)=>{this.initFileCounter(t,e.display,s),e.btn&&this.activateControls(t,e.btn)}))}activateControls(t,e){Object.keys(e).forEach((e=>{this[this.options.btnprefix+t+e]=this.getBtn(t,e)}))}}i()}catch(t){i(t)}}))}}]);