/*! For license information please see 681.1400e5088f8c82f299d0.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[681],{681:(e,n,a)=>{a.a(e,(async(e,t)=>{try{a.d(n,{JsDirToZip:()=>d});var i=a(4860),o=a(9861),l=a(2438),r=a(8468),s=e([l]);l=(s.then?(await s)():s)[0];const c=new Set(["zip","gz","png","jpg","jpeg","pdf","doc","docx","ppt","pptx","xls","xlsx","heic","heif","7z","bz2","rar","gif","webp","webm","mp4","mov","mp3","aifc"]),p=".tsv,.png,.jpg, .jpeg,.zip,.gz,.7z,.bz2",u=1073741824;function d(e={}){const n={ready:"ready",follow:"follow",complete:"complete",endreaddir:"endreaddir",gzip:"gzip",endzip:"endzip",sendfile:"sendfile",bigfile:"bigfile",terminate:"terminate",pending:"pending",errorfile:"errorfile",counter:"counter",reject:"reject",message:"message",error:"error",init:"init"};let t,s;const d={uploadurl:"/gui/files/upload",largefile:u,accept:p.split(",")},f=(e={...d,...e}).listener?e.listener:m;Object.freeze(e);const m=(0,i.UP)();async function g(){s.pos=0,s.sizetozip=0,console.log("==================newzip"),s.zip=new o.qQ(((e,n,a)=>{if(e)return console.log("error",e),!1;s.streamhandle.write(n,{at:self.pos}),s.pos+=n.length,a&&(s.streamhandle.close(),console.log("final-----------------------------*******************************-",s.pos))})),function(e=null){const n=(e=null===e?s.zip:e).ondata;e.ondata=(a,t,i)=>{n(a,t,i),i&&(e.d=null,e.u.at(-1).d=null)}}(),s.follow&&await s.follow()}function w(e){if(!0===s.endreaddir&&!0===s.endcounter){const a=z(e,{name:n.endzip});l.j.emit(n.complete,a,f)}}function z(e,n={}){return e.hasOwnProperty("part")?n.part=e.part:s.part=0,e.hasOwnProperty("bigfile")&&(n.bigfile=e.bigfile),e.hasOwnProperty("path")&&(n.path=e.path),n}async function h(){navigator&&navigator.storage&&navigator.storage.estimate&&navigator.storage.estimate().then((e=>{const a=(e.usage/e.quota*100).toFixed(2),t=(0,i.Y2)(e.quota-e.usage);l.j.emit(n.message,{id:"quota",name:"console",message:"you've used "+a+"% of the available browser storage necessary to locally compress files ("+t+")."},f)}))}async function y(){navigator&&navigator.storage&&navigator.storage.estimate?(await async function(e=null){e=e||await navigator.storage.getDirectory();for await(const[n,a]of e.entries())try{await e.removeEntry(n),console.log(" Success remove storage ",n)}catch(e){console.log(" error remove storage "+n,e)}}(),h()):l.j.emit(n.message,{name:"error",message:"no navigator storage"},m)}async function b(e,n={"application/zip":[".zip"]}){const a=await navigator.storage.getDirectory(),t={types:[{description:"Temp file",accept:n}],create:!0},i=await a.getFileHandle(e,t),o=await i.createWritable({mode:"exclusive"});return{filestream:i,streamhandle:o}}async function v(e,o={}){if(s.endreaddir=!1,null===s.zip){e=""===(e=e.split(i.hx)[0]).trim()?"temp":e;const r=o&&o.type?o.type:".zip";s.zipname=(o.zipname?o.zipname:e)+r;await async function(e){const n=await navigator.storage.getDirectory();for await(const[a,t]of n.entries())if(e===a)return!0;return!1}(s.zipname)&&(s.zipname="1_"+s.zipname);const{filestream:c,streamhandle:d}=await b(s.zipname);s.filestream=c,s.streamhandle=d;if(s.part=0,await g(),!t){const{JsScanDir:e}=await a.e(162).then(a.bind(a,4162));t=e((async(e,a)=>{!function(e){const n=e.name,a=n.slice(n.lastIndexOf(".")+1);return p.includes(a)}(e)?function(e,a=null){const t=e.fullPath?e.fullPath:e.webkitRelativePath;s.counter.reject+=1,l.j.emit(n.reject,{name:n.reject,path:t},f),null!==a&&a()}(e,a):(s.callback=a,await async function(e){const a=e.fullPath?e.fullPath:e.webkitRelativePath;e.file((async e=>{await async function(e,a,t=!0){!0===t&&l.j.emit(n.counter,{name:"scan",path:a,size:e.size},m);s.follow=null,e.size>=u?k(e,a):(s.sizetozip+=e.size,s.sizetozip>=u?(s.follow=async()=>{await P(e,a)},async function(){s.part+=1,l.j.emit(n.complete,{name:n.endzip,part:s.part},f)}()):await P(e,a))}(e,a)}))}(e))}))}}}function j(){l.j.emit(n.endreaddir,{name:n.endreaddir},m)}async function k(e,a){if(null!==s.gzipped)return void await(t=async()=>{await k(e,a)},void s.handlers.push(t));var t;let r=Date.now();a=0===a.indexOf(i.hx)?a.substr(1):a;const p=e.name.slice(e.name.lastIndexOf(".")+1);if(c.has(p))s.gzipped=e,l.j.emit(n.counter,{name:"zip",path:a,size:e.size},m),l.j.emit(n.complete,{name:n.bigfile,bigfile:e.name,path:a},f);else{let t=e.name+".gz";l.j.emit(n.complete,{name:n.gzip,bigfile:e.name,path:a,size:e.size},f);const{filestream:i,streamhandle:c}=await b(t,{"application/gzip":[".gz"]});let p=0;const u=new o.JZ({level:6,filename:a});u.ondata=(t,o,u)=>{t?(console.log("gzip err",t),D(n.errorfile,{bigfile:e.name,path:a,size:e.size})):(c.write(o,{at:p}),p+=o.length,u&&(console.log("final BIGFILE%%%%%%%%%%%%%%%%%%%%"+n.bigfile,a),console.log("timetogzzip",(Date.now()-r)/1e3),c.close(),s.gzipped=i,l.j.emit(n.counter,{name:"zip",path:a,size:e.size},m),l.j.emit(n.complete,{name:n.bigfile,bigfile:e.name,path:a},f)))};const d=!1;await x(e,a,u,d)}}async function x(e,a,t,i=!0){const o=e.stream().getReader();for(;;){const{done:r,value:s}=await o.read();if(r){t.push(new Uint8Array(0),!0),!0===i&&l.j.emit(n.counter,{name:"zip",path:a,size:t.size?t.size:e.size},m);break}t.push(s)}}async function P(n,a){const t=a.slice(a.lastIndexOf(".")+1),i=c.has(t)?new o.uZ(a):n.size>e.largefile?new o.hw(a,{level:6}):new o.D8(a,{level:6});s.zip.add(i),await x(n,a,i)}function D(e,a=null){switch(a=a||{},e){case n.init:a.name=n.init;break;case n.errorfile:console.log("errorfile",a);default:a.name=n.follow}l.j.emit(n.error,a,f)}async function F(e,a=!1){if(e.name=n.terminate,s.follow)return s.streamhandle=await s.filestream.createWritable({mode:"exclusive"}),e.name=n.follow,l.j.emit(n.follow,e,f),void await g();if(e.hasOwnProperty("bigfile")&&!1!==e.bigfile){if(s.gzipped=null,s.handlers.length>0)return e.name=n.follow,l.j.emit(n.follow,e,f),console.log(" handlers to do",e),void(s.handlers.length>0&&await async function(){if(s.handlers.length>0){const e=s.handlers.shift();await e()}}())}else s.zip=null;l.j.emit(n.complete,e,f)}async function O(e,n=0,a=0,t=u){console.log("send chunk ",s.gzipped);const i=await s.gzipped.getFile(),o=Math.min(n+t,i.size);if(o===i.size)await q(i,e,null,!0);else{const l=i.slice(n,o);l.name=a+"_"+i.name,await sendZipfile(l,e,(async()=>{a++,(n+=o)<=i.size&&await O(e,n,a,t)}),!0)}return a}async function q(a,t,o=null,r=!1){const c={name:n.pending,path:t};r&&(c.bigfile=a.name),l.j.emit(n.complete,c,f);const p=new FormData;t=t+(t.slice(-1)===i.hx?"":i.hx)+a.name,p.append("path",t),p.append("file",a,a.name),s.part?p.append("part",s.part):null!==o&&p.append("ischunk",!0),fetch(e.uploadurl,{method:"POST",credentials:"include",body:p}).then((async e=>{console.log("response----------------------",e),console.log("callbackchunk-------------------------------",o),c.path=t,200===e.status?null!==o?(console.log("callbackchunk not null"),await o()):await F(c):D(n.error,c)}))}return y(),s={zip:null,zipname:null,filestream:null,streamhandle:null,gzipped:null,sizetozip:0,part:0,follow:null,endcounter:!1,endreaddir:!1,callback:null,pos:0,counter:{scan:0,zip:0,reject:0},handlers:[]},l.j.on(n.init,(async e=>{console.log("event init",e),0==(null!==s.zip||null!==s.follow||null!==s.gzipped||!0!==s.endreaddir)?(await async function(){s={zip:null,zipname:null,filestream:null,streamhandle:null,gzipped:null,sizetozip:0,part:0,follow:null,endcounter:!1,endreaddir:!1,callback:null,pos:0,counter:{scan:0,zip:0,reject:0},handlers:[]},await y()}(),l.j.emit(n.complete,{name:n.ready},f),s.endreaddir=!1):console.log("partly finshed ",e)}),m),l.j.on(n.endzip,(async e=>{!e.bigfile&&s.zip?s.zip.end():e.bigfile&&s.gzipped&&console.log("--gzipped end",s.gzipped),console.log("endzip%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%");const a=async function(){if(!0===await async function(e=null,n=null){e=e||await navigator.storage.getDirectory();let a=!0;for await(const[t,i]of e.entries())if(null!==n){const e=t.split(".");if("crswap"===e.pop()&&e.join(".")===n){a=!1;break}}return a}(null,s.zipname)){const a=z(e,{name:n.sendfile});l.j.emit(n.complete,a,f)}else setTimeout((async function(){await a()}),2e3)};a()}),m),l.j.on(n.sendfile,(async e=>{const n=e.bigfile?await s.gzipped.getFile():await async function(e=null){e=null===e?s.filestream:e;const n=await e.getFile();return n}();e.bigfile?O((e.path?e.path:"").replace(e.bigfile,"")):q(n,e.path?e.path:"",null)}),m),l.j.on(n.endreaddir,(e=>{s.endreaddir=!0,w(e)}),m),l.j.on(n.counter,(async e=>{s.endcounter=!1,s.counter[e.name]+=1,l.j.emit(n.counter,e,f),"zip"===e.name&&s.counter.scan===s.counter.zip&&(s.endcounter=!0,w(e)),"zip"===e.name&&s.callback&&await s.callback()}),m),{uuid:m,eventnames:n,scanBrowse:async function(e,n={}){const a=e instanceof FileList?Array.from(e):"directory"===e.kind?await Array.fromAsync(e.values()):Array.isArray(e)?e:[e];a[0].name;let o=e instanceof FileList?a[0].webkitRelativePath:null;o=o?o.split(i.hx):[""],o.length&&o.pop(),o=o.join(i.hx);const l=e instanceof FileList?o:"directory"===e.kind?e.name:"";await v(l,n),await t.processEntries(a,l,(()=>{j()}))},scanHandle:async function(e,n={}){await v(e.name,n),!0===e.isDirectory?await t.readDirectory(e,(()=>{j()})):!0===e.isFile&&await t.processFile(e,(()=>{j()}))},quotaEstimate:h,browserRequired:function(){const e=(0,r.o0)(),a={android:{chrome:109,opera:74,firefox:111,samsungbrowser:21,webview:109},ios:!1,other:{chrome:86,edge:86,opera:72,firefox:111}};let t=e.os.toLowerCase();t=t in["android","ios"]?t:"other";const i=e.name.toLowerCase(),o=parseInt(e.version.split(".")[0]);!1===(a[t]&&a[t][i]&&a[t][i]<=o)&&l.j.emit(n.message,{id:"browser",name:"browser",message:"your browser does not have a required functionnality. Please upgrade or use a valid browser and version :"+JSON.stringify(a).replaceAll('"',"")},f)}}}t()}catch(f){t(f)}}))}}]);