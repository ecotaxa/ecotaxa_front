/*! For license information please see 681.504d1cda49a867a77d7c.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[681],{681:(e,a,n)=>{n.a(e,(async(e,t)=>{try{n.d(a,{JsDirToZip:()=>d});var i=n(4860),o=n(9861),l=n(2438),r=n(8468),s=e([l]);l=(s.then?(await s)():s)[0];const c=new Set(["zip","gz","png","jpg","jpeg","pdf","doc","docx","ppt","pptx","xls","xlsx","heic","heif","7z","bz2","rar","gif","webp","webm","mp4","mov","mp3","aifc"]),p=".tsv,.png,.jpg, .jpeg,.zip,.gz,.7z,.bz2";function d(e={}){const a=document.querySelector("[data-max_upload_size]")?parseInt(document.querySelector("[data-max_upload_size]").dataset.max_upload_size):1073741824,t={ready:"ready",follow:"follow",complete:"complete",endreaddir:"endreaddir",gzip:"gzip",endzip:"endzip",sendfile:"sendfile",bigfile:"bigfile",terminate:"terminate",pending:"pending",errorfile:"errorfile",counter:"counter",reject:"reject",message:"message",error:"error",init:"init"};let s,d;const u={uploadurl:"/gui/files/upload",largefile:a,accept:p.split(",")},f=(e={...u,...e}).listener?e.listener:m;Object.freeze(e);const m=(0,i.UP)();async function g(){d.pos=0,d.sizetozip=0,console.log("==================newzip"),d.zip=new o.qQ(((e,a,n)=>{if(e)return console.log("error",e),!1;d.streamhandle.write(a,{at:self.pos}),d.pos+=a.length,n&&(d.streamhandle.close(),console.log("final-----------------------------*******************************-",d.pos))})),function(e=null){const a=(e=null===e?d.zip:e).ondata;e.ondata=(n,t,i)=>{a(n,t,i),i&&(e.d=null,e.u.at(-1).d=null)}}(),d.follow&&await d.follow()}function w(e){if(!0===d.endreaddir&&!0===d.endcounter){const a=z(e,{name:t.endzip});l.j.emit(t.complete,a,f)}}function z(e,a={}){return e.hasOwnProperty("part")?a.part=e.part:d.part=0,e.hasOwnProperty("bigfile")&&(a.bigfile=e.bigfile),e.hasOwnProperty("path")&&(a.path=e.path),a}async function h(){navigator&&navigator.storage&&navigator.storage.estimate&&navigator.storage.estimate().then((e=>{const a=(e.usage/e.quota*100).toFixed(2),n=(0,i.Y2)(e.quota-e.usage);l.j.emit(t.message,{id:"quota",name:"console",message:"you've used "+a+"% of the available browser storage necessary to locally compress files ("+n+")."},f)}))}async function y(){navigator&&navigator.storage&&navigator.storage.estimate?(await async function(e=null){e=e||await navigator.storage.getDirectory();for await(const[a,n]of e.entries())try{await e.removeEntry(a),console.log(" Success remove storage ",a)}catch(e){console.log(" error remove storage "+a,e)}}(),h()):l.j.emit(t.message,{name:"error",message:"no navigator storage"},m)}async function b(e,a={"application/zip":[".zip"]}){const n=await navigator.storage.getDirectory(),t={types:[{description:"Temp file",accept:a}],create:!0},i=await n.getFileHandle(e,t),o=await i.createWritable({mode:"exclusive"});return{filestream:i,streamhandle:o}}async function j(e,o={}){if(d.endreaddir=!1,null===d.zip){e=""===(e=e.split(i.hx)[0]).trim()?"temp":e;const r=o&&o.type?o.type:".zip";d.zipname=(o.zipname?o.zipname:e)+r;await async function(e){const a=await navigator.storage.getDirectory();for await(const[n,t]of a.entries())if(e===n)return!0;return!1}(d.zipname)&&(d.zipname="1_"+d.zipname);const{filestream:c,streamhandle:u}=await b(d.zipname);d.filestream=c,d.streamhandle=u;if(d.part=0,await g(),!s){const{JsScanDir:e}=await n.e(162).then(n.bind(n,4162));s=e((async(e,n)=>{!function(e){const a=e.name,n=a.slice(a.lastIndexOf(".")+1);return p.includes(n)}(e)?function(e,a=null){const n=e.fullPath?e.fullPath:e.webkitRelativePath;d.counter.reject+=1,l.j.emit(t.reject,{name:t.reject,path:n},f),null!==a&&a()}(e,n):(d.callback=n,await async function(e){const n=e.fullPath?e.fullPath:e.webkitRelativePath;e.file((async e=>{await async function(e,n,i=!0){!0===i&&l.j.emit(t.counter,{name:"scan",path:n,size:e.size},m);d.follow=null,e.size>=a?x(e,n):(d.sizetozip+=e.size,d.sizetozip>=a?(d.follow=async()=>{await P(e,n)},async function(){d.part+=1,l.j.emit(t.complete,{name:t.endzip,part:d.part},f)}()):await P(e,n))}(e,n)}))}(e))}))}}}function v(){l.j.emit(t.endreaddir,{name:t.endreaddir},m)}async function x(e,a){if(null!==d.gzipped)return void await(n=async()=>{await x(e,a)},void d.handlers.push(n));var n;let r=Date.now();a=0===a.indexOf(i.hx)?a.substr(1):a;const s=e.name.slice(e.name.lastIndexOf(".")+1);if(c.has(s))d.gzipped=e,l.j.emit(t.counter,{name:"zip",path:a,size:e.size},m),l.j.emit(t.complete,{name:t.bigfile,bigfile:e.name,path:a},f);else{let n=e.name+".gz";l.j.emit(t.complete,{name:t.gzip,bigfile:e.name,path:a,size:e.size},f);const{filestream:i,streamhandle:s}=await b(n,{"application/gzip":[".gz"]});let c=0;const p=new o.JZ({level:6,filename:a});p.ondata=(n,o,p)=>{n?(console.log("gzip err",n),D(t.errorfile,{bigfile:e.name,path:a,size:e.size})):(s.write(o,{at:c}),c+=o.length,p&&(console.log("final BIGFILE%%%%%%%%%%%%%%%%%%%%"+t.bigfile,a),console.log("timetogzzip",(Date.now()-r)/1e3),s.close(),d.gzipped=i,l.j.emit(t.counter,{name:"zip",path:a,size:e.size},m),l.j.emit(t.complete,{name:t.bigfile,bigfile:e.name,path:a},f)))};const u=!1;await k(e,a,p,u)}}async function k(e,a,n,i=!0){const o=e.stream().getReader();for(;;){const{done:r,value:s}=await o.read();if(r){n.push(new Uint8Array(0),!0),!0===i&&l.j.emit(t.counter,{name:"zip",path:a,size:n.size?n.size:e.size},m);break}n.push(s)}}async function P(a,n){const t=n.slice(n.lastIndexOf(".")+1),i=c.has(t)?new o.uZ(n):a.size>e.largefile?new o.hw(n,{level:6}):new o.D8(n,{level:6});d.zip.add(i),await k(a,n,i)}function D(e,a=null){switch(a=a||{},e){case t.init:case t.errorfile:a.name=e;break;default:a.name=t.follow}l.j.emit(t.message,a,f)}async function F(e,a=!1){if(e.name=t.terminate,d.follow)return d.streamhandle=await d.filestream.createWritable({mode:"exclusive"}),e.name=t.follow,l.j.emit(t.follow,e,f),void await g();if(e.hasOwnProperty("bigfile")&&!1!==e.bigfile){if(d.gzipped=null,d.handlers.length>0)return e.name=t.follow,l.j.emit(t.follow,e,f),console.log(" handlers to do",e),void(d.handlers.length>0&&await async function(){if(d.handlers.length>0){const e=d.handlers.shift();await e()}}())}else d.zip=null;l.j.emit(t.complete,e,f)}async function O(e,n=0,t=0,i=a){console.log("send chunk ",d.gzipped);const o=await d.gzipped.getFile(),l=Math.min(n+i,o.size);if(l===o.size)await q(o,e,null,!0);else{const a=o.slice(n,l);a.name=t+"_"+o.name,await sendZipfile(a,e,(async()=>{t++,(n+=l)<=o.size&&await O(e,n,t,i)}),!0)}return t}async function q(a,n,o=null,r=!1){const s={name:t.pending,path:n};r&&(s.bigfile=a.name),l.j.emit(t.complete,s,f);const c=new FormData;n=n+(n.slice(-1)===i.hx?"":i.hx)+a.name,c.append("path",n),c.append("file",a,a.name),d.part?c.append("part",d.part):null!==o&&c.append("ischunk",!0),s.path=n;const p=await fetch(e.uploadurl,{method:"POST",credentials:"include",body:c}),u=await p.text();console.log("response",u),p.ok?o?await o():await F(s):(d.follow=null,await F(s),D(t.errorfile,s))}return y(),d={zip:null,zipname:null,filestream:null,streamhandle:null,gzipped:null,sizetozip:0,part:0,follow:null,endcounter:!1,endreaddir:!1,callback:null,pos:0,counter:{scan:0,zip:0,reject:0},handlers:[]},l.j.on(t.init,(async e=>{0==(null!==d.zip||null!==d.follow||null!==d.gzipped||!0!==d.endreaddir)?(await async function(){d={zip:null,zipname:null,filestream:null,streamhandle:null,gzipped:null,sizetozip:0,part:0,follow:null,endcounter:!1,endreaddir:!1,callback:null,pos:0,counter:{scan:0,zip:0,reject:0},handlers:[]},await y()}(),l.j.emit(t.complete,{name:t.ready},f),d.endreaddir=!1):console.log("partly finshed ",e)}),m),l.j.on(t.endzip,(async e=>{!e.bigfile&&d.zip?d.zip.end():e.bigfile&&d.gzipped&&console.log("--gzipped end",d.gzipped),console.log("endzip%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%");const a=async function(){if(!0===await async function(e=null,a=null){e=e||await navigator.storage.getDirectory();let n=!0;for await(const[t,i]of e.entries())if(null!==a){const e=t.split(".");if("crswap"===e.pop()&&e.join(".")===a){n=!1;break}}return n}(null,d.zipname)){const a=z(e,{name:t.sendfile});l.j.emit(t.complete,a,f)}else setTimeout((async function(){await a()}),2e3)};a()}),m),l.j.on(t.sendfile,(async e=>{const a=e.bigfile?await d.gzipped.getFile():await async function(e=null){e=null===e?d.filestream:e;const a=await e.getFile();return a}();e.bigfile?O((e.path?e.path:"").replace(e.bigfile,"")):q(a,e.path?e.path:"",null)}),m),l.j.on(t.endreaddir,(e=>{d.endreaddir=!0,w(e)}),m),l.j.on(t.counter,(async e=>{d.endcounter=!1,d.counter[e.name]+=1,l.j.emit(t.counter,e,f),"zip"===e.name&&d.counter.scan===d.counter.zip&&(d.endcounter=!0,w(e)),"zip"===e.name&&d.callback&&await d.callback()}),m),l.j.on(t.error,(e=>{})),{uuid:m,eventnames:t,scanBrowse:async function(e,a={}){const n=e instanceof FileList?Array.from(e):"directory"===e.kind?await Array.fromAsync(e.values()):Array.isArray(e)?e:[e];n[0].name;let t=e instanceof FileList?n[0].webkitRelativePath:null;t=t?t.split(i.hx):[""],t.length&&t.pop(),t=t.join(i.hx);const o=e instanceof FileList?t:"directory"===e.kind?e.name:"";await j(o,a),await s.processEntries(n,o,(()=>{v()}))},scanHandle:async function(e,a={}){await j(e.name,a),!0===e.isDirectory?await s.readDirectory(e,(()=>{v()})):!0===e.isFile&&await s.processFile(e,(()=>{v()}))},quotaEstimate:h,browserRequired:function(){const e=(0,r.o0)(),a={android:{chrome:109,opera:74,firefox:111,samsungbrowser:21,webview:109},ios:!1,other:{chrome:86,edge:86,opera:72,firefox:111}};let n=e.os.toLowerCase();n=n in["android","ios"]?n:"other";const i=e.name.toLowerCase(),o=parseInt(e.version.split(".")[0]);!1===(a[n]&&a[n][i]&&a[n][i]<=o)&&l.j.emit(t.message,{id:"browser",name:"browser",message:"your browser does not have a required functionnality. Please upgrade or use a valid browser and version :"+JSON.stringify(a).replaceAll('"',"")},f)}}}t()}catch(u){t(u)}}))}}]);