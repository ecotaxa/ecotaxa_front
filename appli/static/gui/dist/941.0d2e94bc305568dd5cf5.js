/*! For license information please see 941.0d2e94bc305568dd5cf5.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[941],{5941:(t,e,s)=>{s.d(e,{DataImport:()=>d});var i=s(7856),o=s.n(i),r=s(2057),n=(s(5690),s(7737)),l=s(2817);const a=Object.keys(l.HN).reduce((function(t,e){return t[e]=e,t}),{});let c;l.iv.imported="imported",l.EY.resetbutton=".import-list-reset";class d{content_selector=".modal-content";imports=[];taxos=["preset","extra"];importcontainer;importzoneid;importid="importzone";selectors;button;clearbutton;replacebutton;tabbutton;tbl=null;constructor(t,e=null,s=null){if(t&&(this.tbl="object"==typeof t?t:null,s=null===s?this.tbl.cellidname?"data-"+this.tbl.cellidname:"data-id":s,this.dom=this.tbl?this.tbl.dom:document.getElementById(t),this.dom)){if(e=e?o().sanitize(e):t&&t.params&&t.params.import?t.params.import:this.dom.dataset.import?o().sanitize(this.dom.dataset.import):null,!c||c.doc!==this.dom){const t={importcontainer:"#data-import-"+e,btns:".btns-imports",button:"#add-import-"+e,replacebutton:"#replace-import-"+e,tabbutton:"#tab-import-"+e};this.selector=s,this.importcontainer=t.importcontainer instanceof HTMLElement?t.importcontainer:document.querySelector(t.importcontainer),this.form=t.form?t.form instanceof HTMLElement?t.form:document.querySelector(t.form):this.dom.closest("form"),this.button=t.button instanceof HTMLElement?t.button:document.querySelector(t.button),this.replacebutton=t.replacebutton instanceof HTMLElement?t.replacebutton:document.querySelector(t.replacebutton),this.tabbutton=t.tabbutton instanceof HTMLElement?t.tabbutton:document.querySelector(t.tabbutton),this.init(t),c=this}return c}}init(t){this.showImport(!1);let e=this.form.querySelector("#"+l.EY.projid);e&&e.value&&(e=this.dom.querySelector("["+this.selector+'="'+e.value+'"]'),e&&e.classList.add(l.iv.hide));const s=this.indexToCheck();this.selectors=this.dom.querySelectorAll("["+this.selector+"] button, ["+this.selector+"] input"),this.selectors.forEach((t=>{const e=Array.from(t.parentElement.children).indexOf(t);if(s&&""===t.closest("tr").children[s[e]].innerHTML)t.disabled=!0;else{const s="input"===t.tagName.toLowerCase()?"change":"click",i=t=>{t.stopImmediatePropagation();const s=t.currentTarget;s.disabled=!0,this.toImport(s.parentElement,e)};t.removeEventListener(s,i,!1),t.addEventListener(s,i,!1)}})),this.button&&(this.tabbutton.addEventListener("click",(t=>{t.stopImmediatePropagation(),this.resizeZone(t)})),this.showImport(!1))}columnProperty(t,e,s){return this.tbl?this.tbl.grid.columns[e].hasOwnProperty(t)?this.tbl.grid.columns[e][t]:null:s.dataset[t]?s.dataset.name:null}columnIndex(t,e){return Array.from(this.dom.querySelectorAll("thead th")).findIndex((s=>s.dataset[t]&&s.dataset[t]===e))}gridColumnIndex(t,e){return this.tbl?this.tbl.grid.columns.findIndex((s=>s.hasOwnProperty(t)&&s[t]===e)):this.columnIndex(t,e)}rowIndex(t,e){const s=t.parentElement?t.parentElement:null;return s?e.findIndex((t=>t===s)):null}toImport(t,e=0){const s=this.tbl?this.tbl.grid:null,i=Array.from(this.dom.querySelectorAll("thead th")),o=Array.from(this.dom.querySelectorAll("tbody tr")),c=s?s.data:o.map((t=>Array.from(t.childNodes).forEach((t=>t.innerText))));"td"!==t.tagName.toLowerCase()&&(t=t.closest("td"));const d=this.rowIndex(t,o);if(null===d)return;let m=!0;const u=t.cellIndex,p=i[u],h=(o[d],this.columnProperty("what",u,p));if(!h)return;const f=this.columnProperty("parts",u,p);let b=this.columnProperty("selectcells",u,p);if(b=b?f?[f[e]]:b:null,!b)return;h!==l.oL.settings&&h!==l.oL.privileges||(this.imports[l.Cq.contact]=this.findContact(c[d]));const v=h===l.oL.taxo||h===l.oL.privileges?this.createImportzone(h):null;this.addResetButton();let g=null;b.forEach(((t,e)=>{if((e=this.gridColumnIndex("name",t))>=0){const s=this.columnIndex("name",t),u=s>=0?o[d].cells[s]:null;u&&u.classList.add(l.iv.selected);const p=c[d][e],f=s>=0?i[s]:null;switch(h){case l.oL.taxo:g=v.tomselect;let e=p;e&&(g?(Object.values(g.options).forEach((t=>{let s={};s[t[g.settings.valueField]]=t[g.settings.labelField],e[t[g.settings.valueField]]||(e=Object.assign(e,s))})),e=Object.entries(e),e.sort(((t,e)=>{let s=t[1],i=e[1];return+(s>i)||-(i>s)})),g.clear(),g.clearOptions(),e.forEach((([t,e])=>{if(!g.getItem(t)){if(!g.getOption(t)){let s={};s[g.settings.valueField]=t,s[g.settings.labelField]=(0,n.l1)(e.trim()),g.addOption(s)}g.addItem(t)}}))):(Object.values(v.options).forEach((t=>{let s={};s[t.value]=t.text,e[t.value]||(e=Object.assign(e,s))})),e=Object.entries(e),e.sort(((t,e)=>{let s=t[1],i=e[1];return+(s>i)||-(i>s)})),v.innerHTML="",e.forEach((([t,e])=>{v.querySelector('option[value="'+t+'"]')||v.insertAdjacentHTML("beforeend",'<option value="'+t+'" selected>'+e+"</option>")}))),m=e.length>0,e=null);break;case l.oL.privileges:const s=p,o=g&&g.items.length>0||v.selectedIndex>0;if(!v.tomselect){v.currentlist={};(new r.JsTomSelect).applyTo(v)}g=v.tomselect,Object.entries(s).forEach((([t,e])=>{e.sort(((t,e)=>e.name>t.name)),e.forEach((e=>{const s=o?a.viewers:t;let i;v.currentlist&&v.currentlist[e.id]||(g?(i=g.items.indexOf(e.id),i>=0&&(g.removeItem(e.id),g.removeOption(e.id)),i={optgroup:s},i[g.settings.valueField]=e.id,i[g.settings.searchField]=e.name,i[g.settings.labelField]=e.name,g.addOption(i),g.addItem(e.id)):(i=v.querySelector('option[value="'+e.id+'"]'),null===i?(i=document.createElement("option"),i.value=e.id,i.dataset.optgroup=s,i.selected=i.defaultSelected=!0,i.text=e.name,v.add(i)):i.dataset.optgroup=s))})),v.tomselect.refreshOptions(!0)})),m=(g?g.items.length:v.selectedIndex+1)>0;break;default:if(this.imports[t]=p,null!==u)if(u.dataset.autocomplete){this.imports[t]={value:p,key:null};let e=null;i.every(((t,s)=>t.dataset.name!=f.dataset.autocomplete||(e=s,!1))),null!==e&&(e=c[d][e],this.imports[t].key=e)}else u.dataset.value&&(this.imports[t]=u.dataset.value)}}})),i.length&&(this.button?(this.showImport(m),this.button.dataset.activated||h!==l.oL.taxo&&h!==l.oL.privileges||this.activateButtons(h,b)):this.makeImport(null,b,h,!0))}messageZone(t){console.log("itemmessage",t)}activateButtons(t,e){this.button.addEventListener("click",(s=>{s.stopImmediatePropagation(),s.preventDefault(),this.makeImport(s.currentTarget,e,t,!0)})),this.replacebutton.addEventListener("click",(s=>{s.stopImmediatePropagation(),s.preventDefault(),this.makeImport(s.currentTarget,e,t,!0)})),this.button.dataset.activated=!0,this.replacebutton.dataset.activated=!0}findContact(t,e="contact"){const s=this.gridColumnIndex("name",e);return s>=0&&t[s]?t[s]:null}renderPrivileges(t,e=!1){let s={};const i=t.tomselect,o=(t,e)=>{const i={id:t.id,name:t.name,priv:e};s[e]?s[e].push(i):s[e]=[i]};if(i){const t=[...i.items],e=Object.assign({},i.options);t.forEach((t=>{(t=e[t])&&o(t,t.optgroup)}))}else t.options.forEach((t=>{t.selected&&o(t,t.dataset.optgroup)}));this.importPrivileges(s,e)&&(i?(i.clear(),i.clearOptions()):t.innerHTML="")}importPrivileges(t,e=!1){const s=this.form.querySelector("."+l.EY.component.privileges.ident);if(null===s||!s.jsprivileges)return;const i=!0===e&&this.imports[l.Cq.contact]?this.imports[l.Cq.contact]:null;return s.jsprivileges.importPrivileges(t,e,i,(t=>{this.setImportedTag(t,null)}),(()=>{this.dismiss()}))}resetSelectors(){this.selectors.forEach(((t,e)=>{t.disabled&&(t.disabled=!1)})),this.dom.querySelectorAll("td."+l.iv.selected).forEach((t=>{t.classList.remove(l.iv.selected)}))}activateClear(){const t=document.getElementById("clear-"+this.importid);t&&t.addEventListener("click",(t=>{t.stopImmediatePropagation(),this.importcontainer&&(this.resetSelectors(),this.button.disabled=!1,this.replacebutton.disabled=!1,this.showImport(!1))}))}createImportzone(t){this.showImport(!0);let e=this.importcontainer.querySelector("#"+this.importid);if(t===l.oL.privileges)e||(e=document.createElement("select"),this.importid=e.id=this.importid+"-"+t,e.dataset.type=l.Cq.user,e.multiple=!0,e.dataset.priv=!0,this.importcontainer.append(e));else{const s=this.form.querySelector('[name="'+t+'"]')?this.form.querySelector('[name="'+t+'"]'):this.form.querySelector('[data-importfield="'+t+'"]'),i=s.tomselect;if(!e){if(!s)return;if(this.importzoneid=s.id,e=s.cloneNode(),e.classList.remove("tomselected"),e.classList.remove("ts-hidden-accessible"),e.dataset.origin=e.id,e.id=this.importid,e.name=this.importid+"_"+e.name,this.importcontainer.insertAdjacentHTML("afterbegin",e.outerHTML),i){e=this.importcontainer.querySelector("#"+this.importid);(new r.JsTomSelect).applyTo(e)}this.activateClear()}}return e}makeImport(t,e,s,i=!1){let r=!0,a=null;const c=this.importcontainer?this.importcontainer.querySelector("#"+this.importid):null;switch(s){case l.oL.taxo:if(!c)return!1;const i=this.form.querySelector("#"+c.dataset.origin);if(!i)return!1;if(a=i.tomselect,a){t.dataset.replace&&"replace"===t.dataset.replace&&(a.clear(),a.clearOptions());const e=c.tomselect,s=[...e.items],i=Object.assign({},e.options);s.forEach(((t,e)=>{let s={};s[a.settings.valueField]=t,s[a.settings.searchField]=(0,n.l1)(i[t][a.settings.searchField]),a.getOption(t)||a.addOption(s),a.addItem(t)})),e.clear(),e.clearOptions()}else t.dataset.replace&&"replace"===t.dataset.replace&&(i.innerHTML=""),i.innerHTML=o().sanitize(c.innerHTML),c.innerHTML="";r=!0;break;case l.oL.privileges:if(!c)return!1;r=this.renderPrivileges(c,t.dataset.replace&&"replace"===t.dataset.replace),c.currentlist&&(c.currentlist={});break;default:const d=function(t,e){const s={};"string"==typeof e?(s[t.settings.labelField]=e,s[t.settings.valueField]=e,s[t.settings.searchField]=(0,n.l1)(e)):(s[t.settings.labelField]=e.key,s[t.settings.valueField]=e.key,s[t.settings.searchField]=(0,n.l1)(e.value)),t.getOption(s[t.settings.valueField])||t.addOption(s),t.getItem(s[t.settings.valueField])||t.addItem(s[t.settings.valueField])},m=function(t,e){const s=document.createElement("option");"string"==typeof e?s.value=s.text=e:(s.value=e.key,s.text=e.value),s.selected=!0,t.append(s)},u=function(t,e){if(t.multiple){let s=t.value.split(",");s.push(e.key),t.value=s.join(",")}else t.value=e};e.forEach(((t,e)=>{let i=this.form.querySelector('[data-importfield="'+t+'"]')?this.form.querySelector('[data-importfield="'+t+'"]'):this.form.querySelector('[name="'+t+'"]');if(!i||!i.dataset.noimport)if(i&&void 0!==this.imports[t]){const e=i.type?i.type:i.tagName.toLowerCase();if(a=i.tomselect,"init_classif_list"===t){let s=this.imports[t];if(s=Array.isArray(s)?s.join(","):s.replace("[","").replace("]","").replaceAll(" ",""),a&&(a.wrapper.classList.add("wait-for-results"),a.clear(!1),a.clearOptions()),""!==s){a&&a.wrapper.classList.add("wait-for-results");const t=new FormData;t.append("idlist",s);fetch("/search/taxoresolve",(0,n.wv)({method:"POST",body:t})).then((t=>t.json())).then((t=>{const s=i.tomselect;s?(Object.entries(t).forEach((([t,e])=>{const i={key:o().sanitize(t),value:o().sanitize(e)};d(s,i)})),s.wrapper.classList.remove("wait-for-results")):0===e.indexOf("select")?(i.querySelectorAll("option").forEach((t=>{t.remove()})),Object.entries(t).forEach((([t,e])=>{const s={key:o().sanitize(t),value:o().sanitize(e)};u(i,s)}))):Object.entries(t).forEach((([t,e])=>{const s={key:o().sanitize(t),value:o().sanitize(e)};m(i,s)})),t=null,this.setImportedTag(i)}))}}else if(a)d(a,this.imports[t]),this.setImportedTag(i);else{switch(e){case"radio":case"checkbox":i=this.form.querySelector('[name="'+t+'"][value="'+this.imports[t]+'"]'),i&&(i.checked=!0);break;case"select":i.multiple?this.imports[t].forEach((t=>{m(i,t)})):m(i,this.imports[t]);break;default:i.value=this.imports[t]}this.setImportedTag(i)}s!==l.oL.settings&&i.focus(),r=r&&!0}else if(t===l.oL.privileges){const e=!1;r=r&&this.importPrivileges(this.imports[t],e)}}))}!0===r&&1==i&&(this.dismiss(),this.form&&this.form.dispatchEvent(new CustomEvent("validate")))}setImportedTag(t,e=l.EY.component.form.formbox){let s=null===e?t:t.closest(e)?t.closest(e):t.closest("fieldset");if(!s)return;const i=e=>{delete s.dataset.isimported,s.classList.remove(l.iv.imported),t.removeEventListener("change",i)};s.dataset.isimported=this.form.dataset.isimported,s.classList.add(l.iv.imported),void 0!==t.dataset.unique&&(t.dataset.unique=t.value),setTimeout((function(){t.addEventListener("change",i)}),500)}dismiss(t=!1){this.button&&this.showImport(!1);const e=this.dom.closest("details");e&&(e.open=!1,!0===t&&(e.querySelector(this.content_selector).innerHTML=""))}indexToCheck(){const t=this.tbl?this.tbl.grid:null;if(!t)return[0];let e=t.columns.findIndex((t=>t.what&&t.what===l.oL.taxo));if(-1===e)return[0];const s=t.columns[e].parts?t.columns[e].parts:null;if(s){return t.columns.filter(((t,e)=>{if(s.indexOf(t.name)>=0)return e})).map((t=>t.index))}}addResetButton(){if(!this.tbl||!this.tbl.params.hasOwnProperty("reset"))return;let t=this.dom.parentElement.querySelector(l.EY.resetbutton);null===t&&(t=document.createElement("a"),t.classList.add(l.EY.resetbutton.substr(1)),t.textContent=this.tbl.params.reset,this.dom.parentElement.firstChild.prepend(t)),t.addEventListener("click",(t=>{t.preventDefault(),t.stopImmediatePropagation();(this.selectors=this.dom.querySelectorAll("["+this.selector+"] button:disabled, ["+this.selector+"] input:disabled")).forEach((t=>{t.disabled=!1;const e=t.closest("tr").querySelector("."+l.iv.selected);e&&e.classList.remove(l.iv.selected)}))}))}showImport(t){if(this.button)if(!1===t)this.button.classList.add(l.iv.hide),this.replacebutton.classList.add(l.iv.hide),this.importcontainer.classList.add(l.iv.hide),this.tabbutton.classList.add(l.iv.hide);else{this.button.classList.remove(l.iv.hide),this.replacebutton.classList.remove(l.iv.hide),this.importcontainer.classList.remove(l.iv.hide),this.button.disabled=!1;const t=this.importcontainer.querySelector("#"+this.importid);t&&(this.tabbutton.classList.remove(l.iv.hide),t.tomselect&&t.tomselect.control.offsetHeight<t.tomselect.control.scrollHeight?this.tabbutton.disabled=!1:this.tabbutton.disabled=!0)}}resizeZone(t){const e=this.importcontainer.closest(l.EY.component.import.zoneimport);if(!e)return;e.parentElement.classList.toggle(l.iv.showfull);const s=t.currentTarget.querySelector("i");s&&(s.classList.toggle("icon-arrow-pointing-out"),s.classList.toggle("icon-arrow-pointing-in"))}}}}]);