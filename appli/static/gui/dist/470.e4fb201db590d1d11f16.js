/*! For license information please see 470.e4fb201db590d1d11f16.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[470],{3470:(t,e,s)=>{s.d(e,{JsMyFiles:()=>y});var i=s(4860),n=s(7114);const r={images:"png,jpeg,jpg,gif",tsv:"txt,tsv,zip, gzip,gz"};n.AH.intrash="intrash";const o=new CustomEvent("eventEntry",{detail:()=>{console.log("customevent",(void 0).entry)}}),a={api_parameters:{entry:"entry",dest:"dest",rootname:"My Files"},url:"/gui/files",controls:{scan:{display:{counter:"counter",size:"size"}},zip:{btn:{zip:"makezip",zipped:"makezipped"},display:{size:"sizezipped",counter:"counterzipped"}}},upload:{label:"upload"},btnprefix:"btn",btnfilelist:null,entry:{selector:"[data-name]",tags:{tag:"ul",subtag:"li",label:"span"},selectors:{entries:".entries"},draggable:!0,prefix:"entry",type:{root:"R",trash:"T",directory:"D",file:"F",trashed:"X"},specialdirs:["R","T"],trash_dir_name:"trash.",css:{on:"on",entryF:"entryF",entryD:"entryD",entryR:"entryR",entryT:"entryT",editable:"editable",dragging:"dragging",dragover:"dragover",dragitem:"dragitem"},icons:{image:"img",document:"doc"}},entrycontrols:{selectors:{typentries:"[data-typentries]",hascontrols:".has-controls"},controls:{list:{action:"list",typentries:["D","R","T"]},create:{action:"create",text:"new folder",icon:"icon-folder-plus",typentries:["D","R"]},remove:{action:"remove",text:"delete",icon:"icon-trash",typentries:["D","F","X"]},move:{action:"move",typentries:["D","F"]},rename:{action:"rename",trigger:"dblclick",typentries:["D","F"]}},css:{entrycontrols:"entrycontrols",entries:".entries"}},selectors:{doupload:".target-upload",droptarget:".droptarget",dirlist:".dirlist",uploadfile:"uploadfile",displayimport:"displayimport",trigger:".trigger"}};class l{_events;eventnames;name;type;label;entries=[];options={selector:"[data-name]",tags:{tag:"ul",subtag:"li",label:"span"},selectors:{entries:".entries"},css:{on:"on"},draggable:!0,prefix:"entry"};constructor(t,e={}){return this.name=t.name,this.type=t.type,this.root=e.root,this.parent=e.parent?e.parent:null,this.options=Object.assign(this.options,a),this.options=Object.assign(this.options,e),this.label=e.label?e.label:null,this.init(t),this}init(t){(0,i.UO)(this);const e={name:this.name,type:this.type};null!==this.label&&(e.label=this.label);const s=(0,i.xJ)(this.options.tags.subtag,{draggable:this.options.draggable,dataset:e}),n=this.options.class?this.options.class:[];n.unshift(`${this.options.prefix}${this.type}`),this.label=(0,i.xJ)(this.options.tags.label,{class:n,text:t.label?t.label:t.name},s),this.container=s,this.initEvents()}initEvents(){Object.entries(this.options.actions).forEach((([t,e])=>{this.on(e,(e=>{this[t](e)}))}))}getParent(){return this.parent}getLabelElement(){return this.label}getParentElement(){return this.container.parentElement.closest(this.options.selector)}getEntries(){return this.entries}getEntriesElement(t=!1){let e=this.container.querySelector(this.options.selectors.entries);return t&&null===e?(0,i.xJ)(this.options.tags.tag,{class:this.options.selectors.entries.substr(1)},this.container):e}appendEntry(t){if(t.parent){const e=t.parent.entries.indexOf(t);delete t.parent.entries[e]}t.parent=this,this.entries.push(t);return this.getEntriesElement(!0).append(t.container),t}createEntry(t){const e=new l(t);this.appendEntry(e)}findEntry(t){const e=this.getEntries();for(const s of e)if(s.name===t)return s;return null}createListEntries(t){this.getEntriesElement(!0);t.forEach((t=>{t.forEach((t=>{this.createEntry(t)}))}))}removeEntries(){this.entries=[];const t=this.getEntriesElement();t&&t.remove()}isOn(){return this.active}toggleOn(){this.active=!this.active,this.container.classList.toggle(this.options.css.on)}setOff(){this.active=!1,this.container.classList.remove(this.options.css.on)}emitEvent(t=null,e=null){const s={entry:this};t&&(s.action=t),e&&(s.event=e),o.initCustomEvent("eventEntry",!0,!0,s),window.dispatchEvent(o)}moveHandlers(){return[{name:"dragstart",func:t=>{this.handleDragStart(t)}},{name:"dragend",func:t=>{this.handleDragEnd(t)}}]}dropHandlers(){return[{name:"dragover",func:t=>{this.handleDragOver(t)}},{name:"drop",func:t=>{this.handleDrop(t)}}]}handleDrop(t){t.stopPropagation()}addListeners(){let t=t=>{t.stopImmediatePropagation(),this.dirControls((()=>{this.emitEvent(this.eventnames.attach)}))},e=[];[this.options.type.root,this.options.type.trash].indexOf(this.type)<0?(e=this.moveHandlers(),this.type===this.options.type.file?t=t=>{t.stopImmediatePropagation(),this.toggleOn(),this.emitEvent()}:this.isInTrash()?this.type=this.options.type.trashed:e=e.concat(this.dropHandlers()),this.listenRename()):e=e.concat(this.dropHandlers()),e.unshift({name:"click",target:"label",func:t});for(const t of e){("label"===t.target?this.getLabelElement():this.container).addEventListener(t.name,t.func)}}removeListeners(t){for(const e in t){("label"===e.target?this.getLabelElement():this.container).removeEventListener(e.label,e.func)}}destroy(){this.container.remove()}handleDragStart(t){t.stopImmediatePropagation(),this.container.classList.add(this.options.css.dragging),t.dataTransfer.effectAllowed="move",this.emitEvent("dragstart",t)}handleDragOver(t){t.stopPropagation(),t.preventDefault(),this.emitEvent("dragover",t)}handleDragEnd(t){t.stopPropagation(),t.preventDefault(),this.container.classList.contains(this.options.css.dragging)&&this.container.classList.remove(this.options.css.dragging),this.emitEvent("dragend",t)}resetDragOver(){document.querySelectorAll("."+this.options.css.dragover).forEach((t=>{t.classList.remove(this.options.css.dragover)}))}handleDrop(t){t.stopImmediatePropagation(),this.emitEvent("drop",t)}unMove(){this.from&&(this.move(this.from),this.from.container.append(this),this.from=null)}}class c extends l{eventnames={attach:"attach",detach:"detach",istrashdir:"istrashdir",trashed:"trashed",editable:"editable"};isTrashDir(t=null){return 0===(null===t?this.name:t).indexOf(this.options.trash_dir_name)}isInTrash(t=null){return null===(t=null===t?this.getCurrentDirPath():t)&&(0,i.WF)("path_not_found"),0===((t=t.split(i.hx)).length>1&&t[0].indexOf(this.options.trash_dir_name))}setWait(){this.loaded=this.container.dataset.loaded=!1,this.container.classList.add("wait")}setLoaded(){this.container.classList.remove("wait"),this.loaded=this.container.dataset.loaded=!0}dirControls(t=null){"create"!==this.container.dataset.action&&(this.toggleOn(),this.isOn()&&this.dirActivate(t).then((()=>{this.emitEvent()})))}async dirActivate(t=null){this.loaded?t&&t(this):this.list().then((()=>{t&&t(this)}))}getCurrentDirPath(){const t=(e,s=[])=>e.name&&(s.push(e.name),null!==(e=e.getParent()))?t(e,s):s;let e=t(this);return e.length>1&&(e=e.reverse()),e.join(i.hx)}async fetchAction(t,e=null,s=null){const n=this.options.api_parameters,r=this.getLabelElement();let o=this.getCurrentDirPath();if(""===o)return;const a=new FormData;switch(a.append(n.entry,o),t){case this.options.actions.create:if(null===r)return;o=o.split(i.hx),o[o.length-1]=r.textContent,""!==o&&a.set(n.entry,o.join(i.hx));break;case this.options.actions.move:if(null===e)return;{let t=e();if(e=null,t===o)return void console.log("dest = entry",t);a.append(n.dest,t)}break;case this.options.actions.rename:const s=o.split(i.hx);if(s[s.length-1]=r.textContent,s.join(i.hx)===o)return;a.append(n.dest,s.join(i.hx));break;default:this.emit("EventEntry",{entry:this,detail:{action:t}})}const l=await fetch(this.options.url+i.bJ+t,(0,i.Uc)({method:"POST",body:a})),c=await l.json();if(200===c.status)return e&&e(c.message),!0;s?s(c):(0,i.WF)(c)}listenRename(t="dblclick"){const e=this,s=e.getLabelElement();s.addEventListener(t,(t=>{s.dataset.oldname=s.textContent,this.type!==this.options.type.trash?e.setEditable():t.preventDefault()})),e.container.addEventListener("click",(t=>{t.preventDefault(),t.stopImmediatePropagation(),e.setEditable(!1),e.container.dataset.action===e.options.actions.create&&e.container.remove()}))}setEditable(t=!0){const e=this,s=e.getLabelElement(),n=async t=>{if("Enter"===t.key){if(t.preventDefault(),s.dataset.oldname&&s.dataset.oldname!==s.textContent){const t=t=>{""===t?window.alertbox.addItemMessage(s,{type:"error",content:window.alertbox.i18nmessages.exists,duration:2e3}):t=t.split(i.hx).pop(),s.textContent=t,e.type===e.options.type.directory&&e.dirControls(),delete e.container.dataset.action},n=e.container.dataset.action?e.container.dataset.action:e.options.actions.rename;await e.fetchAction(n,t)}e.setEditable(!1)}};!0===t?(s.contentEditable=!0,e.container.draggable=!1,s.classList.add(e.options.css.editable),s.addEventListener("keydown",n)):(s.contentEditable=!1,s.classList.remove(e.options.css.editable),s.removeEventListener("keydown",n),e.container.draggable=e.options.specialdirs.indexOf(e.type)<0)}createEntry(t){const e=t.name.split(".").pop(),s=this.options;s.draggable=s.specialdirs.indexOf(t.type)<0,s.class=[],this.isTrashDir(t.name)&&(t.type=this.options.type.trash);const i=t.type===s.type.file?r.images.split(",").indexOf(e)>=0?s.icons.image:s.icons.document:null;null!==i&&s.class.push(i);const n=new c(t,s);return this.appendEntry(n),n.addListeners(),t.type===this.options.type.trash&&n.emitEvent(this.eventnames.istrashdir),n}findEntry(t,e){const s=this.getEntries();for(const i of s)if(i.name===t&&i.type===e)return i;return null}async list(){if(this.type===this.options.type.file)return;this.options.tags.tag,this.options.tags.subtag;const t=this.name?this.getCurrentDirPath():null;this.setWait(),this.removeEntries();const e={headers:new Headers({"content-type":"application/json"})},s=await fetch(this.options.url+i.bJ+this.options.actions.list+(t?i.hx+t:""),(0,i.Uc)(e)),n=await s.json();if(s.ok){if(n.entries&&n.entries.length){let t=[],e=[],s=n.entries;for(;s.length>0;){const i=s.shift();i.type===this.options.type.file?t.push(i):e.push(i)}t.sort(((t,e)=>t.name<e.name)),e.sort(((t,e)=>t.name<e.name)),this.createListEntries([e,t])}this.setLoaded()}else window.alertbox.addItemMessage({parent:this.container,type:"error",content:n.error+" "+n.text})}remove(){this.isTrashDir()||this.fetchAction(this.options.actions.remove).then((t=>{this.setParent(null),this.removeListeners(this.dropHandlers()),this.setOff(),this.container.animate({transform:"translateX(-100%) scale(0)"},{duration:1e3}),setTimeout((()=>{this.isInTrash(this.from)?this.destroy():this.emitEvent(this.eventnames.trashed)}),1e3)}))}create(){const t=this.createEntry({type:"D",name:"NewFolder"});this.getEntriesElement().prepend(t.container),t.container.dataset.action=this.options.actions.create,t.label.dispatchEvent(new Event("dblclick"))}rename(){this.isTrashDir()||this.fetchAction(this.options.actions.rename).then((()=>{console.log("renamed",this)}))}move(t,e=null){if(!this.isTrashDir())return[this.options.type.trash,this.options.type.trashed].indexOf(t.type)>=0?this.remove():void this.fetchAction(this.options.actions.move,(()=>t.getCurrentDirPath()+i.hx+this.name)).then((()=>{this.setParent(t),null!==e&&e()})).catch((t=>{console.log("errmove",t)}))}setParent(t){if(this.from=this.getCurrentDirPath(),null!==t){t.entries.push(this),this.parent=t;t.getEntriesElement(!0).append(this.container)}const e=this.parent.entries.indexOf(this);e>=0?delete this.parent.entries[e]:console.log("entry not found in parent entries",this.parent)}}class h{_events={};eventnames={control:"control",error:"error"};options=a.entrycontrols;box;container;entry=null;constructor(t=document,e={}){return t.jsentrycontrols||(this.options=Object.assign(this.options,e),this.container=t,this.entry=null,this.init(),t.jsentrycontrols=this),t.jsentrycontrols}init(){(0,i.UO)(this),this.createControls(),this.initEvents()}addControl(t,e=null){const s=(0,i.xJ)("span",{}),n=this.box.children.length;if(null===e||n<e+1?this.box.append(s):0===e||0===n?this.box.prepend(s):this.box.inserBefore(crtl,this.box.children[e]),t.typentries&&(s.dataset.typentries=t.typentries),t.icon){(0,i.xJ)("i",{class:["icon",t.icon]},s);s.dataset.title=t.text}else s.textContent=t.text;const r=t.trigger?t.trigger:"click";s.addEventListener(r,(e=>{if(null===this.entry)return;const s={callback:()=>{console.log("done",t.action)}};this.entry.emit(t.action,s)})),t.ctrl=s}createControls(){this.box=(0,i.xJ)("div",{class:[this.options.css.entrycontrols,n.AH.hide]}),Object.values(this.options.controls).filter((t=>t.icon||t.text)).forEach((t=>{this.addControl(t)}))}initEvents(){}detachControls(){null!==this.entry&&(this.entry.container.classList.remove(this.options.selectors.hascontrols.substr(1)),this.box.classList.add(n.AH.hide),this.box.disabled=!0,this.container.append(this.box),this.entry=null)}attachControls(t){this.detachControls(),this.entry=t,this.entry.container.prepend(this.box),this.entry.container.classList.add(this.options.selectors.hascontrols.substr(1)),this.activateControls(),this.box.classList.remove(n.AH.hide),delete this.box.disabled}activateControl(t,e){const s=t.ctrl,i=s.dataset.typentries?s.dataset.typentries.split(","):[],r=e?this.entry.options.type.trashed:this.entry.container.dataset.type;i.indexOf(r)>=0?s.classList.remove(n.AH.hide):s.classList.add(n.AH.hide)}activateControls(){if(null===this.entry)return;const t=this.entry.isInTrash();Object.values(this.options.controls).filter((t=>t.icon||t.text)).forEach((e=>{this.activateControl(e,t)}))}}class d{_events={};eventnames={attach:"attach",detach:"detach",action:"action",complete:"complete",error:"error"};options=a;constructor(t,e={}){if(!t.jsdirlist){if(!(t=t instanceof HTMLElement?t:document.querySelector(t)))return;this.options=Object.assign(this.options,e),this.options.entry.url=this.options.url,this.container=(0,i.xJ)(this.options.entry.tags.tag,{class:this.options.selectors.dirlist.substr(1)},t),this.init(),this.container.append(this.root.container),t.jsdirlist=this}return t.jsdirlist}init(){(0,i.UO)(this);const t=this.options.entry.type.root,e={};this.entrycontrols=this.options.controls?new h(this.container,this.options.entrycontrols):null,Object.entries(this.options.entrycontrols.controls).forEach((([t,s])=>{e[t]=s.action})),this.options.entry.actions=e,this.initEvents();const s=this.options.entry;s.draggable=!1,this.root=new c({type:t,name:"",label:this.options.api_parameters.rootname,root:this},s),this.root.addListeners()}initEvents(){this.on(this.eventnames.error,(t=>{console.log("dirlist receive error message",t),window.alertbox&&window.alertbox.renderAlert({type:window.alertbox.alertconfig.types.error,content:t,inverse:!0,dismissible:!0})})),window.addEventListener("eventEntry",(t=>{const e=t.detail.entry.eventnames;switch(t.detail.action){case e.istrashdir:this.trashdir&&this.trashdir.container.remove(),this.trashdir=t.detail.entry,this.root.container.parentElement.insertBefore(t.detail.entry.container,this.root.container),this.root.container.append(t.detail.entry.container);break;case e.trashed:let s=t.detail.entry.parent;t.detail.entry.isInTrash(t.detail.entry.from)?s=this.root:(this.moveEntry(t.detail.entry,this.trashdir),t.detail.entry.container.classList.add(n.AH.intrash)),this.attachControls(s);break;case e.attach:const i=t.detail.entry.isInTrash()?t.detail.entry.options.type.trashed:t.detail.entry.container.dataset.type;if(i===t.detail.entry.options.type.trash)return;if(t.detail.action===e.attach&&i===t.detail.entry.options.type.trashed)return;this.attachControls(t.detail.entry);break;case"dragstart":this.dragentry=this.activentry=t.detail.entry,t.detail.entry.container.classList.add(t.detail.entry.options.css.dragging),this.detachControls();break;case"dragover":if(!this.dragentry)return;this.overitem!==t.detail.entry.container&&(this.overitem&&this.overitem.classList.remove(t.detail.entry.options.css.dragover),t.detail.entry.container.classList.add(t.detail.entry.options.css.dragover),this.overitem=t.detail.entry.container);break;case"dragend":this.dragentry=null,this.overitem&&this.overitem.classList.remove(t.detail.entry.options.css.dragover),this.overitem=null;break;case"drop":if(!this.dragentry)return this.emit(this.eventnames.action,t),!0;console.log(" dragentry drop",t.detail.entry.name);this.dragentry.container;const r=t.detail.entry;if(r.resetDragOver(),null!==this.dragentry)if(this.dragentry.options.actions.move)try{this.dragentry.move(r),[this.dragentry.options.type.trashed].indexOf(r.type)>=0&&this.attachControls(r)}catch(t){console.log("errordrop ",t),this.dragentry.unMove()}else console.log("noactionon drop");else console.log(" parent===null or dragitem===null or dragitem===parent",this.dragentry);break;case e.editable:this.editable&&this.editable.setEditable(!1);break;default:if(t.detail.action&&this[t.detail.action])return console.log("edtailaction",t.detail.action),void console.log(" function exists",this[t.detail.action]);t.detail.entry.active?this.attachControls(t.detail.entry):this.attachControls(this.root)}}))}moveEntry(t,e){t.from=t.getCurrentDirPath();const s=t.from.split(i.hx);s.pop(),s.forEach(((s,i)=>{const n=e.type===e.options.type.trash?e.options.type.trashed:e.type;let r=e.findEntry(s,n);null===r&&(r=e.createEntry({type:t.options.type.directory,name:s})),e=r})),null===e.findEntry(t.name,t.type)&&e.appendEntry(t)}attachControls(t){this.entrycontrols&&this.entrycontrols.attachControls(t),this.activentry=t,this.emit(this.eventnames.attach,{entry:this.activentry})}detachControls(){const t=this.activentry&&this.activentry.parent?this.activentry.parent:this.root;this.entrycontrols&&this.entrycontrols.attachControls(t),this.activentry=t,this.emit(this.eventnames.attach,{entry:t})}}const p={"image/*":[".png",".jpeg",".jpg"],"text/tab-separated-values":[".tsv"],"application/zip":[".zip"],"application/gzip":[".gz"],"application/x-bzip":[".bz"],"application/x-bzip2":[".bz2"]},m=Object.values(p).reduce(((t,e)=>t.concat(e)));n.AH.button="button p-1 mx-auto sm:mr-4 mb-4";class y{done=!0;jsDirToZip=null;jsDirList=null;trash_dir_name="trash.";counters={};_events={};eventnames={complete:"complete",error:"error"};rejected=[];errorfile=[];constructor(t,e={}){if(!t.jsmyfiles){if(!(t=t instanceof HTMLElement?t:document.querySelector(t)))return;(0,i.vg)(t,"dataset"),this.container=t;const s={controls:{scan:{display:{counter:"counter",size:"size"}},zip:{btn:{zip:"makezip",zipped:"makezipped"},display:{size:"sizezipped",counter:"counterzipped"}},reject:{display:{counter:"counterrejected"}},errorfile:{display:{counter:"countererrorfile"}}},upload:{label:"upload"},btnprefix:"btn",btnfilelist:null,selectors:{droptarget:".droptarget",trigger:".trigger",uploadfile:"uploadfile"},display:{progression:"display-progression",dropzone:"dropzone",boxtitle:"boxtitle",counters:"counters",sizes:"sizes",timers:"timers"},css:{dragover:"dragover"}};this.options=Object.assign(s,e),this.options.browse=t.dataset.browse?t.dataset.browse.split(","):["directory","file"],this.haspicker=window.showDirectoryPicker,this.options.browse=t.dataset.browse?t.dataset.browse.split(","):["directory","file"],this.init(),t.jsmyfiles=this}return t.jsmyfiles}init(){(0,i.UO)(this),this.addDisplayProgression(),this.addDirList(),this.addDropzone(),this.initControls(),this.initEvents().then((()=>{this.resetCounters()}))}initTimer(){this.timer=new Date}async initEvents(){(0,i.UO)(this),this.on(this.eventnames.processed,(async t=>{this.nextaction&&await this.nextaction()})),this.on(this.eventnames.error,(t=>{console.log("scandir receive error message",t),window.alertbox&&window.alertbox.renderAlert({type:window.alertbox.alertconfig.types.error,content:t,inverse:!0,dismissible:!0})}));const t=this;if(this.options.controls.zip){const{JsDirToZip:e}=await Promise.all([s.e(861),s.e(681)]).then(s.bind(s,681));this.jsDirToZip=new e,Object.keys(this.jsDirToZip.eventnames).forEach((e=>{this.eventnames[e]=this.jsDirToZip.eventnames[e],this.jsDirToZip.on(e,(s=>{switch(e){case this.eventnames.clientcounter:this.fileCounter(s);break;case this.eventnames.reject:this.rejected.push(s.path),this.fileCounter({name:"reject",path:s.path});break;case this.eventnames.follow:case this.eventnames.complete:if(!s||!s.hasOwnProperty("name")||""===s.name)return void console.log("no emit complete name"+e,s);t.showControl(s.name,s);break;case this.eventnames.message:switch(s.name){case"console":this.addConsoleMessage({id:s.id?s.id:null,content:s.message,parent:this.container});break;case window.alertbox.alertconfig.types.error:case window.alertbox.alertconfig.types.success:case window.alertbox.alertconfig.types.danger:case window.alertbox.alertconfig.types.info:window.alertbox.renderAlert({type:s.name,content:s.message,dismissible:!0,inverse:!1}),console.log("error",s);break;default:console.log("message",s)}}}))}))}window.addEventListener("beforeunload",(t=>{this.done||(t.preventDefault(),t.returnValue=this.options.preventclose?this.options.preventclose:"Some work is in progress in this window.\nAre you sure you want to leave?")}))}emitToZip(t){const e=t.dataset.message?JSON.parse(t.dataset.message):null;if(e||t.classList.add(n.AH.hide),e&&e.name){const t=e.name;delete e.name,this.jsDirToZip.emit(t,e)}name===this.eventnames.sendfile&&(t.disabled=!0)}quotaEstimate(t){return this.jsDirToZip.quotaEstimate()}scanBrowse(t,e){return this.jsDirToZip.scanBrowse(t,e)}scanHandle(t,e){return this.jsDirToZip.scanHandle(t,e)}async handleBrowse(t){this.setUploadEntry()&&(this.initTimer(),this.toggleCounters(!0),this.haspicker||(t=t.target.files),await this.scanBrowse(t,{accept:m}))}addDropzone(){this.dropzone=(0,i.xJ)("div",{id:this.options.display.dropzone});const t=this.haspicker?null:(0,i.xJ)("input",{type:"file",name:this.options.selectors.uploadfile,id:this.options.selectors.uploadfile,multiple:!0,allowdirs:!0,accept:m,class:"hidden"},this.dropzone);t&&t.addEventListener("change",(t=>{this.handleBrowse(t)}));const e=(0,i.xJ)("div",{},this.dropzone);this.options.browse.forEach((s=>{const n=this.container.dataset[`textbrowse${s}`]?this.container.dataset[`textbrowse${s}`]:`browse${s}`;(0,i.xJ)("span",{class:this.options.selectors.trigger.slice(1),dataset:{type:s},text:n},e).addEventListener("click",(async e=>{this.haspicker?this.openDirDialog(s,(t=>{this.handleBrowse(t)})):("directory"===s?(t.directory=!0,t.webkitdirectory=!0):(t.directory=!1,t.webkitdirectory=!1),t.dispatchEvent(new MouseEvent("click")))}))}));(0,i.xJ)("span",{text:this.container.dataset.textdrop},e)}toggleDropTarget(t=!0){const e=this,s=this.activentry?this.activentry.container:null;if(null===s)return;const i=this.jsDirList?this.jsDirList.options.entry.css.dragover:this.options.css.dragover,n=t=>{!this.dragover&&this.activentry&&this.activentry.container===t.currentTarget&&s.classList.add(i),e.handleDragOver(t)},r=async t=>{s.classList.remove(i),e.handleDrop(t)};!1===t?(s.removeEventListener("dragover",n),s.removeEventListener("drop",r),s.classList.remove(this.options.selectors.droptarget.substr(1))):(s.addEventListener("dragover",n),s.addEventListener("drop",r),s.classList.add(this.options.selectors.droptarget.substr(1)))}async addDirList(){this.jsDirList=new d(this.container),this.activentry=this.jsDirList.root,this.rootitem=this.targetitem=this.activentry.container,this.jsDirList.on(this.jsDirList.eventnames.attach,(t=>{t.entry&&(this.detachDropzone(),this.activentry=t.entry,this.targetitem=this.activentry.container,[this.activentry.options.type.directory,this.activentry.options.type.root].indexOf(this.activentry.type)>=0&&this.addUploadDialog())})),this.jsDirList.on(this.jsDirList.eventnames.detach,(t=>{this.detachDropzone(),this.activentry=null,this.targetitem=null})),this.jsDirList.on(this.jsDirList.eventnames.action,(t=>{"drop"===t.detail.action?this.handleDrop(t.detail.event):console.log("action not managed "+t.detail.action,t.detail)})),this.activentry.label.dispatchEvent(new Event("click"))}addDisplayProgression(){if(this.displayprogression)return;let t=document.getElementById(this.options.display.progression);t||(t=(0,i.xJ)("div",{id:this.options.display.progression},this.container),t.innerHTML=`<div class="${this.options.display.progression}"><div class="${this.options.display.counters}"></div><div class="${this.options.display.sizes}"></div><div class="${n.AH.progress}"></div><div class="${this.options.display.timers}"></div></div>`,this.displayprogression=t)}enableDropzone(t=!0,e=!1){(e||!1===t)&&this.dropzone.classList.add(n.AH.hide),t?(this.dropzone.dataset.enabled=!0,this.dropzone.classList.remove(n.AH.hide)):delete this.dropzone.dataset.enabled}attachDropzone(){this.dropzone.dataset.enabled&&(this.targetitem.insertBefore(this.dropzone,this.activentry.label.nextElementSibling),this.toggleDropTarget(!0))}detachDropzone(){this.enableDropzone(!1),this.toggleDropTarget(!1)}openDirDialog(t,e){("directory"===t?window.showDirectoryPicker:window.showOpenFilePicker)("directory"===t?{mode:"read",multiple:!0}:{types:[{description:"Images,.tsv, zip, gzip, tar files",accept:p}],excludeAcceptAllOption:!0,multiple:!0}).then((t=>{e(t)}))}setUploadEntry(){return!this.uploadentry&&(this.uploadentry=this.activentry,!0)}async handleDrop(t){if(!this.setUploadEntry())return;let e;t.dataTransfer?(t.preventDefault(),e=t.dataTransfer):e=t,this.done=!1,this.initTimer();const s=[...e.items?e.items:e.files];s.length&&(this.enableDropzone(!1),await s.forEach((async t=>{"file"===t.kind&&(t=await t.webkitGetAsEntry(),this.toggleCounters(!0),await this.scanHandle(t))})))}handleDragOver(t){t.preventDefault(),t.dataTransfer.dropEffect="move"}showComplete(){this.timer=(new Date-this.timer)/1e3,console.log("item-------------------------------------"+parseInt(this.timer/60)+" --- "+(this.timer-60*parseInt(this.timer/60))),this.enableDropzone()}stopOnError(t){console.log("err",t)}addConsoleMessage(t){t.parent=t.parent?t.parent:this.container,window.alertbox.addConsoleMessage(t)}addUploadDialog(){this.options.controls.scan&&(this.enableDropzone(!0),this.attachDropzone())}async addFilesStore(t,e){if(t=t||this.options.dbname,!this.jsFilesStore){const{JsFilesStore:t}=await s.e(179).then(s.bind(s,6179));this.jsFilesStore=new t(null,e),this.displayFiles()}e&&await e()}displayFiles(){this.jsFilesStore.getItems("local")}fileCounter(t){const e=this.counters[t.name];e.counter+=1,null!==t.size&&(e.size+=parseInt(t.size)),e.display.counter.textContent=e.counter,e.display.size&&(e.display.size.textContent=(0,i.Y2)(e.size)),this.quotaEstimate()}resetCounter(t){const e=this.counters[t];["counter","size"].forEach((t=>{e.display[t]&&(e[t]=0,e.display[t].textContent=0)}))}resetCounters(){Object.keys(this.options.controls).forEach((t=>{this.resetCounter(t)})),this.toggleCounters(!1)}toggleCounters(t=!0){const e=document.getElementById(this.options.display.progression);e&&(t?e.classList.remove(n.AH.hide):e.classList.add(n.AH.hide))}initFileCounter(t,e,s){let n=document.getElementById(this.options.display.progression);const r={display:{}};Object.entries(e).forEach((([e,s])=>{const o=e+"s",a={counter:" read",size:" read",counterzipped:" compressed",sizezipped:" compressed",counterrejected:" rejected",countererrorfile:" error"},l=["counterrejected","countererrorfile"];let c=n.querySelector("."+o);c||(c=(0,i.xJ)("div",{class:o},n,""));let h=c.querySelector("."+s);if(h)this.resetCounter(t);else if(h=(0,i.xJ)("span",{class:s},c," / "),a.hasOwnProperty(s))if(l.indexOf(s)>=0){const t=(0,i.xJ)("a",{text:a[s],class:"text-error",title:`Click to display the list of ${a[s]} files`},c);t.addEventListener("click",(e=>{e.preventDefault(),this.displayExcept(t,s)}))}else c.append(document.createTextNode(a[s]));r.display[e]=h,r[e]=0})),this.counters={...this.counters,[t]:r}}displayExcept(t,e){e=e.replace("counter","");const s={rejected:" type rejected",errorfile:" in error"};if(Object.keys(s).indexOf(e)<0)return;const i={type:window.alertbox.alertconfig.types.warning,parent:t,content:`Files ${this.rejected.join("<br>")} ${s[e]}`};t.dataset.hasmessage?(window.alertbox.removeItemMessage(i),delete t.dataset.hasmessage):(t.dataset.hasmessage=!0,window.alertbox.addItemMessage(i))}showControl(t,e){const s=!(!e||!e.part)&&e.part,r=!(!e||!e.bigfile)&&e.bigfile,o=e&&e.path?e.path:this.uploadentry.getCurrentDirPath(),a=e.hasOwnProperty("bigfile")&&!1!==r?"zipped":"zip";let l,c=null;const h=this[this.options.btnprefix+"zip"+a];if(h){switch(h.disabled=!1,t){case this.eventnames.ready:this.resetCounters(),this.uploadentry&&(this.uploadentry.list(),this.uploadentry=null),l=null;break;case this.eventnames.follow:r?(console.log(" follow",e),l={},h.textContent="Wait for next operation",h.disabled=!0):l=null;break;case this.eventnames.endzip:s||this.showComplete(),h.textContent="Close zip file"+(s?" "+s:""),h.title=s?"Your file is too big - you have to send this part before continuing to process the directory":"Click to end zip file",l={name:this.eventnames.endzip,part:s,filepath:o,bigfile:r};break;case this.eventnames.bigfile:r&&""!==r&&(h.textContent="Upload big File separately",l={name:this.eventnames.bigfile,path:o,part:s,bigfile:r});break;case this.eventnames.sendfile:l={name:this.eventnames.sendfile,path:o,part:s,bigfile:r},h.textContent="Upload zip file",l.bigfile&&""!==l.bigfile&&(h.textContent+=" "+e),h.dataset.message=JSON.stringify(l);break;case this.eventnames.pending:h.textContent=" Pending "+("zip"!==a?" big file":""),h.disabled=!0,l={};break;case this.eventnames.gzip:c=`compressing big file :${e&&e.bigfile?o:""} ${e&&e.size?(0,i.Y2)(e.size):""}`,h.textContent=c,h.disabled=!0,l={};break;case this.eventnames.terminate:return h.dataset.message=JSON.stringify({name:this.eventnames.init,bigfile:r,part:s,path:o}),h.classList.add(n.AH.hide),void h.click();case this.eventnames.errorfile:this.errorfile.push(o);case this.eventnames.error:h.textContent=e.text?e.text:"Error",l={name:e.name,path:o,part:s,bigfile:r},console.log("????????ERROR??????????????????????????????????????--- errorcontrol"+t,l);break;default:return void console.log("??????????????????????????????????????????????----default control "+t,e)}null===l?(delete h.dataset.message,h.classList.add(n.AH.hide)):(h.dataset.message=JSON.stringify(l),h.classList.remove(n.AH.hide),h.disabled?(h.classList.add(n.AH.console),h.insertAdjacentHTML("afterbegin",(0,i.QW)("text-stone-200 ml-1 mr-2 align-text-bottom inline-block"))):h.classList.remove(n.AH.console))}}getBtn(t,e){const s=this.options.btnprefix+t+e;if(this[s])return this[s];const i=this.options.controls[t].btn[e],r=document.getElementById(i),o=this.displayprogression;return r?o.append(r):(o.insertAdjacentHTML("beforeend",`<button id="${i}" class="${i} ${n.AH.button} ${n.AH.hide}"></button>`),this[s]=document.getElementById(i),this[s].addEventListener("click",(async t=>{t.stopImmediatePropagation(),t.preventDefault(),this.emitToZip(t.currentTarget)}))),this[s]}initControls(){Object.entries(this.options.controls).forEach((([t,e],s)=>{this.initFileCounter(t,e.display,s),e.btn&&this.activateControls(t,e.btn)}))}activateControls(t,e){Object.keys(e).forEach((e=>{this[this.options.btnprefix+t+e]=this.getBtn(t,e)}))}}}}]);