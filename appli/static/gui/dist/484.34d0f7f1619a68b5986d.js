/*! For license information please see 484.34d0f7f1619a68b5986d.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[484],{2484:(t,e,s)=>{s.a(t,(async(t,i)=>{try{s.d(e,{DataImport:()=>h});var o=s(9418),r=s(5455),n=s(5004),l=s(4860),a=s(7114),c=t([r,n]);[r,n]=c.then?(await c)():c;const m=Object.keys(a.tt).reduce((function(t,e){return t[e]=e,t}),{});let d;a.AH.imported="imported",a.AH.tomselected="tomselected",a.AH.hiddenaccessible="ts-hidden-accessible",a.AH.arrowout="icon-arrow-pointing-out",a.AH.arrowin="icon-arrow-pointing-in",a.Do.resetbutton=".import-list-reset";class h{content_selector=".modal-content";imports=[];taxos=["preset","extra"];importcontainer;importzoneid;importid="importzone";importzone=null;selectors;button;clearbutton;replacebutton;tabbutton;dom;tbl=null;thcells=[];trs=[];datas;constructor(t,e=null,s=null){if(!t)return;if(this.tbl="object"==typeof t?t:null,s=null===s?this.tbl.cellidname?"data-"+this.tbl.cellidname:"data-id":s,this.dom=this.tbl?this.tbl.dom:document.getElementById(t),!this.dom)return;this.thcells=Array.from(this.dom.querySelectorAll("thead th")),this.trs=Array.from(this.dom.querySelectorAll("tbody tr"));const i=this.tbl?this.tbl.grid:null;if(this.datas=i?i.data:this.trs.map((t=>Array.from(t.childNodes).forEach((t=>t.innerText)))),e=e?o.A.sanitize(e):t&&t.params&&t.params.import?t.params.import:this.dom.dataset.import?o.A.sanitize(this.dom.dataset.import):null,!d||d.doc!==this.dom){const t={importcontainer:"#data-import-"+e,btns:".btns-imports",button:"#add-import-"+e,replacebutton:"#replace-import-"+e,tabbutton:"#tab-import-"+e};this.selector=s,this.importcontainer=t.importcontainer instanceof HTMLElement?t.importcontainer:document.querySelector(t.importcontainer),this.form=t.form?t.form instanceof HTMLElement?t.form:document.querySelector(t.form):this.dom.closest("form"),this.button=t.button instanceof HTMLElement?t.button:document.querySelector(t.button),this.replacebutton=t.replacebutton instanceof HTMLElement?t.replacebutton:document.querySelector(t.replacebutton),this.tabbutton=t.tabbutton instanceof HTMLElement?t.tabbutton:document.querySelector(t.tabbutton),this.importid=this.importid+"_"+e,this.targetimport=this.form.querySelector('[name="'+e+'"]')?this.form.querySelector('[name="'+e+'"]'):this.form.querySelector('[data-type="'+e+'"]'),this.init(t),d=this}return d}init(t){this.showImport(!1);let e=this.form.querySelector("#"+a.Do.projid);e&&e.value&&(e=this.dom.querySelector("["+this.selector+'="'+e.value+'"]'),e&&(e.hidden=!0));const s=this.indexToCheck();this.selectors=this.dom.querySelectorAll("["+this.selector+"] button, ["+this.selector+"] input"),this.selectors.forEach((t=>{const e=Array.from(t.parentElement.children).indexOf(t);if(s&&""===t.closest("tr").children[s[e]].innerHTML)this.disableSelector(t,!1);else{const s="input"===t.tagName.toLowerCase()?"change":"click",i=t=>{t.preventDefault(),t.stopImmediatePropagation();const i=t.currentTarget,o="click"===s||!0===i.checked;this.disableSelector(i,o),this.toImport(i.parentElement,e,o)};t.removeEventListener(s,i,!1),t.addEventListener(s,i,!1)}})),this.tabbutton&&this.tabbutton.addEventListener("click",(t=>{t.stopImmediatePropagation(),t.preventDefault(),this.resizeZone(t)}))}columnProperty(t,e){if(this.tbl)return this.tbl.grid.columns[e].hasOwnProperty(t)?this.tbl.grid.columns[e][t]:null;{const s=this.thcells[e];return s.dataset.hasOwnProperty(t)?s.dataset.name:null}}columnIndex(t,e){return Array.from(this.dom.querySelectorAll("thead th")).findIndex((s=>s.dataset[t]&&s.dataset[t]===e))}gridColumnIndex(t,e){return this.tbl?this.tbl.grid.columns.findIndex((s=>s.hasOwnProperty(t)&&s[t]===e)):this.columnIndex(t,e)}rowIndex(t){const e=t.parentElement?t.parentElement:null;return e?this.trs.findIndex((t=>t===e)):null}disableSelector(t,e=!0){"input"===t.tagName.toLowerCase()?t.checked!==e&&(t.checked=e):t.disabled=e}getDataToImport(t,e){let s=e;if(null!==t)if(t.dataset.autocomplete){s={value:e,key:null};let t=null;this.thcells.every(((e,s)=>e.dataset.name!=thcell.dataset.autocomplete||(t=s,!1))),null!==t&&(t=this.datas[rowindex][t],s.key=t)}else t.dataset.value&&(s=t.dataset.value);return s}getSelectCells(t,e){const s=this.columnProperty("parts",t);let i=this.columnProperty("selectcells",t);return i=i?s?[s[e]]:i:null,i}populateImportZone(t,e){if(!this.importzone)return;const s=this.importzone.tomselect;s?(Object.values(s.options).forEach((t=>{let i={};i[t[s.settings.valueField]]=t[s.settings.labelField],e[t[s.settings.valueField]]||(e=Object.assign(e,i))})),(e=Object.entries(e)).sort(((t,e)=>{let s=t[1],i=e[1];return+(s>i)||-(i>s)})),t?e.forEach((([t,e])=>{if(null===s.getItem(t)){if(null===s.getOption(t)){let i={};i[s.settings.valueField]=t,i[s.settings.labelField]=(0,l.BP)(e.trim()),s.addOption(i)}s.addItem(t)}})):e.forEach((([t,e])=>{s.removeItem(t)}))):(Object.values(this.importzone.options).forEach((t=>{let s={};s[t.value]=t.text,e[t.value]||(e=Object.assign(e,s))})),(e=Object.entries(e)).sort(((t,e)=>{let s=t[1],i=e[1];return+(s>i)||-(i>s)})),this.importzone.innerHTML="",t?e.forEach((([t,e])=>{const s=this.importzone.querySelector('option[value="'+t+'"]');if(s)s.selected=!0;else{(0,l.xJ)("option",{value:t,selected:"selected",text:e},this.importzone)}})):e.forEach((([t,e])=>{const s=this.importzone.querySelector('option[value="'+t+'"]');s&&s.remove()})))}toImport(t,e=0,s=!0){"td"!==t.tagName.toLowerCase()&&(t=t.closest("td"));const i=this.rowIndex(t);if(null===i)return;let o=!0;const n=t.cellIndex,c=this.columnProperty("what",n);if(!c)return;this.columnProperty("parts",n);const d=this.getSelectCells(n,e);if(!d)return;[a.IB.settings,a.IB.privileges].indexOf(c)>=0&&(this.imports[a.Jn.contact]=this.findContact(this.datas[i])),[a.IB.project,a.IB.taxo,a.IB.privileges].indexOf(c)>=0&&this.createImportzone(c),this.addResetButton();let h=null;if(d.forEach(((t,e)=>{if((e=this.gridColumnIndex("name",t))>=0){const n=this.columnIndex("name",t),d=n>=0?this.trs[i].cells[n]:null;d&&d.classList.add(a.AH.selected);const p=this.datas[i],u=p[e];n>=0&&this.thcells[n];switch(c){case a.IB.taxo:if(!this.importzone)return;h=this.importzone.tomselect;let e=u;e&&(this.populateImportZone(s,e),o=Object.keys(e).length>0,e=null);break;case a.IB.privileges:const n=u,c=h&&h.items.length>0||this.importzone.selectedIndex>0;this.importzone.tomselect||(this.importzone.currentlist={},r.JsTomSelect.applyTo(this.importzone)),h=this.importzone.tomselect,Object.entries(n).forEach((([t,e])=>{e.sort(((t,e)=>e.name>t.name)),e.forEach((e=>{const s=c?m.viewers:t;let i;this.importzone.currentlist&&this.importzone.currentlist[e.id]||(h?(i=h.items.indexOf(e.id),i>=0&&(h.removeItem(e.id),h.removeOption(e.id)),i={optgroup:s},i[h.settings.valueField]=e.id,i[h.settings.searchField]=e.name,i[h.settings.labelField]=e.name,h.addOption(i),h.addItem(e.id)):(i=this.importzone.querySelector('option[value="'+e.id+'"]'),null===i?(i=(0,l.xJ)("option",{value:e.id,dataset:{optgroup:s},selected:!0,defaultSelected:!0,text:e.name}),this.importzone.add(i)):i.dataset.optgroup=s))})),h&&h.refreshOptions(!0)})),o=(h?h.items.length:this.importzone.selectedIndex+1)>0;break;case a.IB.project:const f=Object.keys(this.imports).length;this.imports[t]||(this.imports[t]=[]);const b=this.getDataToImport(d,u);if(s)this.imports[t].push(b);else{const e=this.imports[t].indexOf(b);e>-1&&this.imports[t].splice(e,1)}if(t===a.Jn.projid){const t=this.columnIndex("name","title"),e=t>=0?this.trs[i].cells[t]:null,o=p[t],r=e?this.getDataToImport(e,o):b,n={};n[p[this.tbl.getCellId(this.tbl.cellidname)]]=r,this.populateImportZone(s,n)}0===f&&(s?this.filterByRecord(p,i):this.resetFilter());break;default:if(s)this.imports[t]=this.getDataToImport(d,u);else{const e=this.imports.indexOf(t);e>-1&&this.imports.splice(e,1)}}}})),this.thcells.length)if(this.button){const t=!this.button.dataset.activated&&[a.IB.taxo,a.IB.privileges,a.IB.project].indexOf(c)>=0;this.showImport(o),t&&this.activateButtons(c,d)}else this.makeImport(null,d,c,!0)}messageZone(t){console.log("itemmessage",t)}activateButtons(t,e){this.button.addEventListener("click",(async s=>{s.stopImmediatePropagation(),s.preventDefault(),await this.makeImport(s.currentTarget,e,t,!0)})),this.replacebutton.addEventListener("click",(async s=>{s.stopImmediatePropagation(),s.preventDefault(),await this.makeImport(s.currentTarget,e,t,!0)})),this.button.dataset.activated=!0,this.replacebutton.dataset.activated=!0}findContact(t,e="contact"){const s=this.gridColumnIndex("name",e);return s>=0&&t[s]?t[s]:null}renderPrivileges(t=!1){let e={};const s=this.importzone.tomselect,i=(t,s)=>{const i={id:t.id,name:t.name,priv:s};e[s]?e[s].push(i):e[s]=[i]};if(s){const t=[...s.items],e=Object.assign({},s.options);t.forEach((t=>{(t=e[t])&&i(t,t.optgroup)}))}else this.importzone.options.forEach((t=>{t.selected&&i(t,t.dataset.optgroup)}));this.importPrivileges(e,t)&&(s?(s.clear(),s.clearOptions()):this.importzone.innerHTML="")}importPrivileges(t,e=!1){const s=this.form.querySelector("."+a.Do.component.privileges.ident);if(null===s||!s.jsprivileges)return;const i=!0===e&&this.imports[a.Jn.contact]?this.imports[a.Jn.contact]:null;return s.jsprivileges.importPrivileges(t,e,i,(t=>{this.setImportedTag(t,null)}),(()=>{this.dismiss()}))}resetSelector(t){const e={},s=(t,s,i)=>{const o=this.rowIndex(s),r=this.datas[o][i],n=this.trs[o].cells[i],l=this.getDataToImport(n,r);e[t]?e[t].indexOf(l)<0&&e[t].push(l):e[t]=[l]};return t.querySelectorAll("["+this.selector+"] button, ["+this.selector+"] input").forEach(((t,e)=>{t.disabled&&this.disableSelector(t,!1);const i=t.parentElement.dataset.name?t.parentElement.dataset.name:null;s(i,t.parentElement,e)})),t.querySelectorAll("td."+a.AH.selected).forEach(((t,e)=>{t.classList.remove(a.AH.selected),s(name,t,e)})),e}resetSelectors(){this.selectors.forEach(((t,e)=>{t.disabled&&this.disableSelector(t,!1)})),this.dom.querySelectorAll("td."+a.AH.selected).forEach((t=>{t.classList.remove(a.AH.selected)}))}resetImports(){if(this.imports=[],this.importzone)if(this.importzone.currentlist&&(this.importzone.currentlist={}),this.importzone.tomselect)this.importzone.tomselect.clear();else switch(this.importzone.tagName.toLowerCase()){case"input":this.importzone.value="";break;case"select":this.importzone.selectedIndex=-1}}activateClear(){const t=document.getElementById("clear-"+this.importid);t&&t.addEventListener("click",(t=>{t.stopImmediatePropagation(),t.preventDefault(),this.importcontainer&&(this.resetSelectors(),this.resetImports(),this.button.disabled=!1,this.replacebutton.disabled=!1,this.showImport(!1))}))}createImportzone(t){this.showImport(!0);let e=!1;if(!this.importzone)if(t===a.IB.privileges)this.importzone=(0,l.xJ)("select",{id:this.importid,dataset:{type:a.Jn.user,priv:!0},multiple:!0},this.importcontainer),e=!0;else{if(!this.targetimport)return;this.importzoneid=this.targetimport.id,e=this.targetimport.tomselect;const t=this.targetimport.cloneNode();t.classList.remove(a.AH.tomselected),t.classList.remove(a.AH.hiddenaccessible),t.dataset.origin=t.id,t.id=this.importid,t.name=this.importid+"_"+t.name,this.importcontainer.prepend(t),this.importzone=t,e&&(r.JsTomSelect.applyTo(this.importzone),e=this.importzone.tomselect),e&&e.on("item_remove",((t,e)=>{this.itemRemove(t,e)})),this.activateClear()}}cloneImport(t){const e=this.form.querySelector("#"+this.importzone.dataset.origin);if(!e)return!1;const s=e.tomselect;if(s){t.dataset.replace&&"replace"===t.dataset.replace&&(s.clear(),s.clearOptions());const e=this.importzone.tomselect,i=[...e.items],o=Object.assign({},e.options);i.forEach((t=>{let e={};e[s.settings.valueField]=t,e[s.settings.labelField]=(0,l.BP)(o[t][s.settings.labelField]),e[s.settings.searchField]=(0,l.BP)(o[t][s.settings.labelField]),null===s.getOption(e[s.settings.valueField])&&s.addOption(e),null===s.getItem(e[s.settings.valueField])&&s.addItem(e[s.settings.valueField])}))}else t.dataset.replace&&"replace"===t.dataset.replace&&(e.innerHTML=""),e.innerHTML=o.A.sanitize(this.importzone.innerHTML),this.importzone.innerHTML="";return!0}async makeImport(t,e,s,i=!1){let r=!0,n=null;switch(s){case a.IB.taxo:if(!this.importzone)return!1;r=this.cloneImport(t);break;case a.IB.privileges:if(!this.importzone)return!1;r=this.renderPrivileges(t.dataset.replace&&"replace"===t.dataset.replace),this.importzone.currentlist&&(this.importzone.currentlist={});break;case a.IB.project:if(!this.importzone)return!1;r=this.cloneImport(t);e.indexOf(a.Jn.projid);const i=this.form.dataset.id?parseInt(this.form.dataset.id):0;if(0==i){e.indexOf("creator_users")<0&&e.concat(["creator_users","creator_organisations"]);const t=await this.compileProjectRecords(i,e);e.forEach((e=>{this.imports[e]=t[e]}))}default:const c=function(t,e){const s={};"string"==typeof e?(s[t.settings.labelField]=(0,l.BP)(e),s[t.settings.valueField]=(0,l.BP)(e),s[t.settings.searchField]=(0,l.BP)(e)):(s[t.settings.labelField]=(0,l.BP)(e.value),s[t.settings.valueField]=e.key,s[t.settings.searchField]=(0,l.BP)(e.value)),null===t.getOption(s[t.settings.valueField])&&t.addOption(s),null===t.getItem(s[t.settings.valueField])&&t.addItem(s[t.settings.valueField])},m=function(t,e){let s={selected:!0};"string"==typeof e?s.value=s.text=e:(s.value=e.key,s.text=e.value);(0,l.xJ)("option",s,t)},d=function(t,e){if(t.multiple){let s=t.value.split(",");s.push(e.key),t.value=s.join(",")}else t.value=e};e.forEach(((t,e)=>{let i=this.form.querySelector('[data-importfield="'+t+'"]')?this.form.querySelector('[data-importfield="'+t+'"]'):this.form.querySelector('[name="'+t+'"]');if(!i||!i.dataset.noimport)if(i&&void 0!==this.imports[t]){const e=i.type?i.type:i.tagName.toLowerCase();if(n=i.tomselect,["init_classif_list"].indexOf(t)>=0){let s=this.imports[t];if(s=Array.isArray(s)?s.join(","):s.replace("[","").replace("]","").replaceAll(" ",""),""!==s){n&&n.wrapper.classList.add("wait-for-results");let t=(0,l.Uc)(),r="";const a=new FormData;a.append("idlist",s),r="/search/taxoresolve",t=(0,l.Uc)({method:"POST",body:a}),fetch(r,t).then((t=>t.json())).then((t=>{const s=i.tomselect;s?((t=Object.entries(t)).forEach((([t,e])=>{const i={key:o.A.sanitize(t),value:o.A.sanitize(e)};c(s,i)})),s.wrapper.classList.remove("wait-for-results")):0===e.indexOf("select")?(i.querySelectorAll("option").forEach((t=>{t.remove()})),Object.entries(t).forEach((([t,e])=>{const s={key:o.A.sanitize(t),value:o.A.sanitize(e)};d(i,s)}))):Object.entries(t).forEach((([t,e])=>{const s={key:o.A.sanitize(t),value:o.A.sanitize(e)};m(i,s)})),t=null,this.setImportedTag(i)}))}}else if(n)i.multiple?this.imports[t].forEach((t=>{c(n,t)})):c(n,this.imports[t]),this.setImportedTag(i);else{switch(e){case"radio":case"checkbox":const e=this.form.querySelector('[name="'+t+'"][value="'+this.imports[t]+'"]');e&&(e.checked=!0);break;case"select-multiple":case"select":i.multiple?this.imports[t].forEach((t=>{m(i,t)})):m(i,this.imports[t]);break;default:i.value=this.imports[t]}this.setImportedTag(i)}s!==a.IB.settings&&i.focus(),r=r&&!0}else if(t===a.IB.privileges){const e=!1;r=r&&this.importPrivileges(this.imports[t],e)}}))}!0===r&&1==i&&(this.dismiss(),this.form&&this.form.dispatchEvent(new CustomEvent("validate")))}setImportedTag(t,e=a.Do.component.form.formbox){if(null===t)return;let s=null===e?t:t.closest(e)?t.closest(e):t.closest("fieldset");if(!s)return;const i=e=>{delete s.dataset.isimported,s.classList.remove(a.AH.imported),t.removeEventListener("change",i)};s.dataset.isimported=this.form.dataset.isimported,s.classList.add(a.AH.imported),void 0!==t.dataset.unique&&(t.dataset.unique=t.value),setTimeout((function(){t.addEventListener("change",i)}),500)}dismiss(t=!1){this.button&&this.showImport(!1);const e=this.dom.closest("details");e&&(e.open=!1,!0===t&&(e.querySelector(this.content_selector).innerHTML=""))}indexToCheck(){const t=this.tbl?this.tbl.grid:null;if(!t)return[0];let e=t.columns.findIndex((t=>t.what&&t.what===a.IB.taxo));if(-1===e)return[0];const s=t.columns[e].parts?t.columns[e].parts:null;if(s){return t.columns.filter(((t,e)=>{if(s.indexOf(t.name)>=0)return e})).map((t=>t.index))}}addResetButton(){if(!this.tbl||!this.tbl.params.hasOwnProperty("reset"))return;let t=this.dom.parentElement.querySelector(a.Do.resetbutton);null===t&&(t=(0,l.xJ)("a",{class:a.Do.resetbutton.substr(1),text:this.tbl.params.reset},this.dom.parentElement.firstChild)),t.addEventListener("click",(t=>{t.preventDefault(),t.stopImmediatePropagation(),this.resetSelectors(),this.resetImports()}))}showImport(t){this.button&&(!1===t?(this.button.classList.add(a.AH.hide),this.replacebutton.classList.add(a.AH.hide),this.importcontainer.classList.add(a.AH.hide),this.tabbutton&&this.tabbutton.classList.add(a.AH.hide)):this.importzone&&(this.button.classList.remove(a.AH.hide),this.replacebutton.classList.remove(a.AH.hide),this.importcontainer.classList.remove(a.AH.hide),this.button.disabled=!1,this.tabbutton&&(this.tabbutton.classList.remove(a.AH.hide),this.importzone.tomselect?this.tabbutton.disabled=!1:this.tabbutton.disabled=!0)))}resizeZone(t){const e=this.importcontainer.closest(a.Do.component.import.zoneimport);if(!e)return;e.parentElement.classList.toggle(a.AH.showfull);const s=t.currentTarget.querySelector("i");s&&(s.classList.toggle(a.AH.arrowout),s.classList.toggle(a.AH.arrowin))}}i()}catch(t){i(t)}}))}}]);