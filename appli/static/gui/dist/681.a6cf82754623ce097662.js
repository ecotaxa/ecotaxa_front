/*! For license information please see 681.a6cf82754623ce097662.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[681],{681:(e,a,n)=>{n.a(e,(async(e,t)=>{try{n.d(a,{JsDirToZip:()=>d});var i=n(4860),s=n(9861),r=n(2438),o=n(8468),l=n(7104),c=e([r,l]);[r,l]=c.then?(await c)():c;const p=new Set(["zip","gz","png","jpg","jpeg","pdf","doc","docx","ppt","pptx","xls","xlsx","heic","heif","7z","bz2","rar","gif","webp","webm","mp4","mov","mp3","aifc"]),u=".tsv,.png,.jpg, .jpeg,.zip,.gz,.7z,.bz2";function d(e={}){const a=document.querySelector("[data-max_upload_size]")?parseInt(document.querySelector("[data-max_upload_size]").dataset.max_upload_size):1073741824,t={ready:"ready",follow:"follow",complete:"complete",endreaddir:"endreaddir",gzip:"gzip",endzip:"endzip",sendfile:"sendfile",bigfile:"bigfile",terminate:"terminate",pending:"pending",errorfile:"errorfile",counter:"counter",reject:"reject",message:"message",error:"error",init:"init",setuploadpath:"setuploadpath"};let c,d,m;const f={uploadurl:"/gui/files/upload",largefile:a,accept:u.split(",")},h=(e={...f,...e}).listener?e.listener:w;Object.freeze(e);const w=(0,i.UP)();async function g(){d.pos=0,d.sizetozip=0,d.zip=new s.qQ(((e,a,n)=>{if(e)return D(t.errorfile,{name:t.error,message:e}),!1;d.streamhandle.write(a,{at:self.pos}),d.pos+=a.length,n&&d.streamhandle.close()})),function(e=null){const a=(e=null===e?d.zip:e).ondata;e.ondata=(n,t,i)=>{a(n,t,i),i&&(e.d=null,e.u&&e.u.at(-1)&&(e.u.at(-1).d=null))}}(),d.follow&&await d.follow()}function z(e){if(!0===d.endreaddir&&!0===d.endcounter){const a=y(e,{name:t.endzip});r.j.emit(t.complete,a,h)}}function y(e,a={}){return e.hasOwnProperty("part")?a.part=e.part:d.part=0,e.hasOwnProperty("bigfile")&&(a.bigfile=e.bigfile),e.hasOwnProperty("path")&&(a.path=e.path),a}async function b(){navigator&&navigator.storage&&navigator.storage.estimate&&navigator.storage.estimate().then((e=>{const a=(e.usage/e.quota*100).toFixed(2),n=(0,i.Y2)(e.quota-e.usage);r.j.emit(t.message,{id:"quota",name:"console",message:"you've used "+a+"% of the available browser storage necessary to locally compress files ("+n+")."},h)}))}async function j(){navigator&&navigator.storage&&navigator.storage.estimate?(await async function(e=null){e=e||await navigator.storage.getDirectory();for await(const[a,n]of e.entries())try{await e.removeEntry(a),console.log(" Success remove storage ",a)}catch(e){console.log(" error remove storage "+a,e)}}(),b()):r.j.emit(t.message,{name:"error",message:"no navigator storage"},w)}async function v(e,a={"application/zip":[".zip"]}){const n=await navigator.storage.getDirectory(),t={types:[{description:"Temp file",accept:a}],create:!0},i=await n.getFileHandle(e,t),s=await i.createWritable({mode:"exclusive"});return{filestream:i,streamhandle:s}}async function x(e,o={}){if(d.endreaddir=!1,null===d.zip){e=""===(e=e.split(i.hx)[0]).trim()?"temp":e;const l=o&&o.type?o.type:".zip";d.zipname=(o.zipname?o.zipname:e)+l;await async function(e){const a=await navigator.storage.getDirectory();for await(const[n,t]of a.entries())if(e===n)return!0;return!1}(d.zipname)&&(d.zipname="1_"+d.zipname);const{filestream:f,streamhandle:z}=await v(d.zipname);d.filestream=f,d.streamhandle=z;if(d.part=0,await g(),!c){const{JsScanDir:e}=await n.e(162).then(n.bind(n,4162)),o=async(e,n)=>{!function(e){const a=e.name,n=a.slice(a.lastIndexOf(".")+1);return u.includes(n)}(e)?function(e,a=null){const n=e.fullPath?e.fullPath:e.webkitRelativePath;d.counter.reject+=1,r.j.emit(t.reject,{name:t.reject,path:n},h),null!==a&&a()}(e,n):(d.callback=n,await async function(e){const n=e.fullPath?e.fullPath:e.webkitRelativePath;e.file((async e=>{await async function(e,n,o=!0){!0===o&&r.j.emit(t.counter,{name:"scan",path:n,size:e.size},w);d.follow=null,e.size>=a?async function(e,n){Date.now();n=0===n.indexOf(i.hx)?n.substr(1):n;const o=n.split(i.hx);o.pop();const l=m+i.hx+o.join(i.hx),c=e.name.slice(e.name.lastIndexOf(".")+1);if(p.has(c))r.j.emit(t.counter,{name:"zip",path:n,bigfile:e.name,size:e.size},w),O((async()=>{await I(l,e)}));else{let i=e.name+".gz";const{filestream:o,streamhandle:c}=await v(i,{"application/gzip":[".gz"]});let p=0;const u=new s.JZ({level:6,filename:n});u.ondata=(i,s,d)=>{if(p>a)return D(t.errorfile,{name:t.error,bigfile:e.name,path:n,message:"File "+e.name+" size exceeds maxsize. Cannot be sent in chunks for the moment."}),c.close(),u.ondata=(e,a,n)=>{},!1;i?D(t.errorfile,{name:t.error,bigfile:e.name,path:n,size:e.size,message:"Error compressing file "+e.name+" "+i}):(c.write(s,{at:p}),p+=s.length,d&&(c.close(),r.j.emit(t.counter,{name:"zip",path:n,size:e.size,bigfile:e.name},w),n+=".gz",O((async()=>{await I(l,o)}))))};const d=!1;await P(e,n,u,d)}}(e,n):(d.sizetozip+=e.size,d.sizetozip>a?(d.follow=async()=>{await F(e,n)},async function(){d.part+=1,r.j.emit(t.complete,{name:t.endzip,part:d.part},h)}()):await F(e,n))}(e,n)}))}(e))};c=e(o)}}}function k(){r.j.emit(t.endreaddir,{name:t.endreaddir},w)}function O(e){d.handlers.push(e),d.hashandlers=d.handlers.length>0}async function P(e,a,n,i=!0){const s=e.stream().getReader();for(;;){const{done:o,value:l}=await s.read();if(o){n.push(new Uint8Array(0),!0),!0===i&&r.j.emit(t.counter,{name:"zip",path:a,size:n.size?n.size:e.size},w);break}n.push(l)}}async function F(a,n){const t=n.slice(n.lastIndexOf(".")+1),i=p.has(t)?new s.uZ(n):a.size>e.largefile?new s.hw(n,{level:6}):new s.D8(n,{level:6});d.zip.add(i),await P(a,n,i)}function D(e,a=null){switch(a=a||{},e){case t.init:case t.errorfile:a.name=e;break;default:a.name=t.follow}r.j.emit(t.message,a,h)}async function q(e,a=!1){if(d.follow)return d.streamhandle=await d.filestream.createWritable({mode:"exclusive"}),e.name=t.follow,r.j.emit(t.follow,e,h),void await g();d.zip=null,d.hashandlers||(e.name=t.terminate,r.j.emit(t.complete,e,h))}async function I(e,n,i=0,s=0,o=a){const l=n.name.slice(n.name.lastIndexOf(".")+1),c=p.has(l)?n:await n.getFile(),u=Math.min(i+o,c.size);if(u===c.size)return e=e.replace(c.name,""),await A(c,e,null,!0),s;r.j.emit(t.error,{name:t.errorfile,message:"File size exceeds capacity. Chunk functionality not supported for the moment."},h)}async function A(a,n,s=null,o=!1){const l={name:t.pending,bigfile:o,path:n},c=new FormData;n=n+(n.slice(-1)===i.hx?"":i.hx)+a.name,c.append("path",n),c.append("file",a,a.name),d.part?c.append("part",d.part):null!==s&&c.append("ischunk",!0),l.path=n;const p=await fetch(e.uploadurl,{method:"POST",credentials:"include",body:c});await p.text();p.ok?s?await s():(o&&d.hashandlers||await q(l),o&&(l.name=t.follow,r.j.emit(t.follow,l,h))):(d.follow=null,await q(l),D(t.errorfile,l))}return j(),d={zip:null,zipname:null,filestream:null,streamhandle:null,gzipped:null,sizetozip:0,part:0,follow:null,endcounter:!1,endreaddir:!1,callback:null,pos:0,counter:{scan:0,zip:0,reject:0},handlers:[],hashandlers:!1},r.j.on(t.setuploadpath,(async e=>{m=e.path}),w),r.j.on(t.init,(async e=>{null!==d.zip||null!==d.follow||d.hashandlers||!0!==d.endreaddir?console.log("partly finished "+d.hashandlers+"follow="+d.follow,e):(await async function(){d={zip:null,zipname:null,filestream:null,streamhandle:null,gzipped:null,sizetozip:0,part:0,follow:null,endcounter:!1,endreaddir:!1,callback:null,pos:0,counter:{scan:0,zip:0,reject:0},handlers:[],hashandlers:!1},await j()}(),r.j.emit(t.complete,{name:t.ready},h),r.j.emit(t.message,{name:l.y.alertconfig.types.success,message:"Upload of "+e.path+" is done"},h),d.endreaddir=!1)}),w),r.j.on(t.endzip,(async e=>{!e.bigfile&&d.zip&&d.zip.end();const a=async function(){if(!0===await async function(e=null,a=null){e=e||await navigator.storage.getDirectory();let n=!0;for await(const[t,i]of e.entries())if(null!==a){const e=t.split(".");if("crswap"===e.pop()&&e.join(".")===a){n=!1;break}}return n}(null,d.zipname)){const a=y(e,{name:t.sendfile});r.j.emit(t.complete,a,h)}else setTimeout((async function(){await a()}),2e3)};a()}),w),r.j.on(t.sendfile,(async e=>{if(d.hashandlers){const a=y(e,{name:t.follow});r.j.emit(t.follow,a,h),await async function(){if(d.hashandlers){const e=d.handlers.shift();await e(),d.hashandlers=d.handlers.length>0}}()}else{const a=y(e,{name:t.pending});r.j.emit(t.complete,a,h)}A(await async function(e=null){e=null===e?d.filestream:e;const a=await e.getFile();return a}(),e.path?e.path:m,null)}),w),r.j.on(t.endreaddir,(e=>{d.endreaddir=!0,z(e)}),w),r.j.on(t.counter,(async e=>{d.endcounter=!1,d.counter[e.name]+=1,r.j.emit(t.counter,e,h),"zip"===e.name&&d.counter.scan===d.counter.zip&&(d.endcounter=!0,z(e)),"zip"===e.name&&d.callback&&await d.callback()}),w),r.j.on(t.error,(e=>{})),{uuid:w,eventnames:t,scanBrowse:async function(e,a={}){const n=e instanceof FileList?Array.from(e):"directory"===e.kind?await Array.fromAsync(e.values()):Array.isArray(e)?e:[e];n[0].name;let t=e instanceof FileList?n[0].webkitRelativePath:null;t=t?t.split(i.hx):[""],t.length&&t.pop(),t=t.join(i.hx);const s=e instanceof FileList?t:"directory"===e.kind?e.name:"";await x(s,a),await c.processEntries(n,s,(()=>{k()}))},scanHandle:async function(e,a={}){await x(e.name,a),!0===e.isDirectory?await c.readDirectory(e,(()=>{k()})):!0===e.isFile&&await c.processFile(e,(()=>{k()}))},quotaEstimate:b,browserRequired:function(){const e=(0,o.o0)(),a={android:{chrome:109,opera:74,firefox:111,samsungbrowser:21,webview:109},ios:!1,other:{chrome:86,edge:86,opera:72,firefox:111}};let n=e.os.toLowerCase();n=n in["android","ios"]?n:"other";const i=e.name.toLowerCase(),s=parseInt(e.version.split(".")[0]);(Object.keys(a).indexOf(n)<0||Object.keys(a[n]).indexOf(i)<0||parseInt(a[n][i])>parseInt(s))&&r.j.emit(t.message,{id:"browser",name:"browser",message:"your browser does not have a required functionnality. Please upgrade or use a valid browser and version :"+JSON.stringify(a).replaceAll('"',"")},h)}}}t()}catch(m){t(m)}}))}}]);