/*! For license information please see 4.04fcc3eee610cbe01beb.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[4],{5004(e,t,s){s.a(e,async(e,a)=>{try{s.d(t,{ProjectPrivileges:()=>h});var i=s(9418),n=s(7104),r=s(8555),o=s(5455),l=s(7114),d=s(4860),c=e([n,r,o]);[n,r,o]=c.then?(await c)():c;l.Do.memberline='[data-block="member"]';class h{options;keymessages={oneatleast:"oneatleast",nomanager:"nomanager",nocontact:"nocontact",uhasnopriv:"uhasnopriv",importpriverror:"importpriverror",emptyname:"emptyname"};current_uid;fieldset;fieldset_alert_zone;linemodel;currentlist={};constructor(e,t={}){if(null!==e&&e instanceof HTMLElement!=!1){if(!e.jsprivileges){const s={separ:".new-privilege",addbtn:'[data-add="block"]',target:"member",ident:"member",privilege:"privilege",delet:"delet",contact:"contact",contactfieldname:"contact_user_id",domselectors:{tabcontent:".tab-content"}};if(this.options=Object.assign({},s,t),this.fieldset=e,!this.fieldset)return n.y.error();this.fieldset_alert_zone=e.querySelector(this.options.domselectors.tabcontent)?e.querySelector(this.options.domselectors.tabcontent):e,this.options.separ=this.options.separ instanceof HTMLElement?this.options.separ:document.querySelector(this.options.separ)?document.querySelector(this.options.separ):null,this.options.addbtn=this.options.addbtn instanceof HTMLElement?this.options.addbtn:document.querySelector(this.options.addbtn),this.options.addbtn&&this.addListener();const a=this.fieldset.querySelectorAll('[data-block="'+this.options.target+'"]');if(0===a.length)return n.y.error();if(this.linemodel=a[0],this.linecontainer=a[0].parentElement,null===this.linecontainer)return n.y.error();this.current_uid=this.fieldset.dataset.u,a.forEach((e,t)=>{e.dataset.n=t,this.activateEvents(e)});const i=this.fieldset.closest("form");i&&(i.formsubmit?(i.formsubmit.addHandler("validate",()=>!!this.fieldset.dataset.hasOwnProperty("readonly")||this.validateFields()),i.formsubmit.addHandler("submit",()=>!!this.fieldset.hasOwnProperty("readonly")||this.formatPrivileges())):i.addEventListener("submit",async e=>{if(!1!==this.validateFields())return this.formatPrivileges();e.preventDefault()})),this.orderRows(),e.jsprivileges=this}return e.jsprivileges}}newLine(e=!1,t=0,s=!1){const a=this.linecontainer.querySelectorAll(l.Do.memberline);let i;if(a.length&&t>0&&(i=this.getLinePrivilege(t)),i)return!0===s?i:null;const n=this.linemodel.cloneNode(!0);if(n.dataset.hasOwnProperty("model")&&delete n.dataset.model,i=this.clearLine(n,0,-1),i.classList.remove(l.AH.hide),i){const s=this.fieldset.dataset.n?parseInt(this.fieldset.dataset.n)+1:a.length;if(this.linecontainer.append(i),i=this.clearLine(i,-1,s,this.options.separ?this.options.separ:null),i.dataset.n=s,this.fieldset.dataset.n=s,this.activateEvents(i,0===t),!0===e)return i}return null}addListener(){this.options.target=this.options.addbtn.dataset.target?this.options.addbtn.dataset.target:this.options.target,this.options.addbtn.addEventListener("click",async e=>{e.preventDefault(),this.newLine()})}indexElement(e,t,s){return["id","name","for","aria-controls"].forEach(a=>{let i=e.getAttribute(a);null!==i&&(i="name"===a?i.replace("["+t+"]","["+s+"]"):i.replace("_"+t,"_"+s),e.setAttribute(a,i))}),e}indexLine(e,t,s=null){s=null===s?t+1:s;return e.querySelectorAll("[data-elem]").forEach(e=>{e.querySelectorAll("input, select, label, div").forEach(e=>{null!==t&&(e=this.indexElement(e,t,s))})}),e.dataset.n=parseInt(s),this.fieldset.dataset.n=this.fieldset.dataset.n&&this.fieldset.dataset.n>=s?this.fieldset.dataset.n:s,e}clearLine(e,t=null,s=null,a=null){e.dataset.mod="",e.disabled=!1;return e.querySelectorAll("[data-elem]").forEach(e=>{e.querySelectorAll("input, select, label, div").forEach(e=>{switch(e.dataset.hasOwnProperty("readnly")||(e.disabled=!1),null!==t&&(s=null===s?t+1:s,e=this.indexElement(e,t,s)),e.tagName.toLowerCase()){case"input":e.checked=!1,e.name==this.options.contactfieldname&&(e.value="0",e.disabled=!0);break;case"select":Array.from(e.options).forEach(e=>{parseInt(e.value)>0&&e.remove()}),e.selectedIndex=0,e.tomselect?e.tomselect.destroy():["tom-select","tomselected","ts-hidden-accessible"].forEach(t=>{e.classList.remove(t)});break;case"div":null!==t&&e.dataset.component&&e.remove()}})}),a&&(e.classList.add("new"),a.after(e)),e}setLine(e,t={key:"",value:""},s,a){if(!(s=l.tt[s]?l.tt[s]:l.tt.viewers))return;const{member:n,privs:r,contact:d,delet:c}=this.getInputs(e,s);if(!(n&&r&&d&&c))return;t.key=i.A.sanitize(t.key),t.value=i.A.sanitize(t.value);let h=n.querySelector('option[value="'+t.key+'"]');null===h&&(h=document.createElement("option"),h.value=t.key,h.text=t.value,n.append(h)),h.selected=!0,n.tomselect||o.JsTomSelect.applyTo(n),r.checked=!0,d.value=t.key,s===l.uZ.manage?(d.disabled=!1,!0!==a||d.checked||(d.checked=!0)):(d.disabled=!0,d.checked=!1)}getInputs(e,t=!1){const s=e.querySelector("[name*='["+this.options.ident+"]']");let a;a=t?e.querySelector('input[name*="['+this.options.privilege+']"][value="'+t+'"]'):e.querySelectorAll('input[name*="['+this.options.privilege+']"]');return{member:s,privs:a,contact:e.querySelector('input[name="'+this.options.contactfieldname+'"]'),delet:e.querySelector("input[name*='["+this.options.delet+"]']")}}async importPrivileges(e,t=!1,s=null,a=null,i=null){!0===t&&this.clearAll();try{return Object.entries(e).forEach(([e,i])=>{i.forEach(i=>{const n=this.newLine(!0,i.id);n&&(this.setLine(n,{key:i.id,value:i.name},e,null!==s&&s.id===i.id),a&&a(n)),t=!1})}),i&&i(),n.y.dismissAlert(this.keymessages.importpriverror),this.orderRows(),!0}catch(e){return n.y.addAlert({type:n.y.alertconfig.types.error,content:this.keymessages.importpriverror,dismissible:!0,inverse:!0}),console.log("err",e),!1}}activateEvents(e,t=!1){if(!e)return;const{member:s,privs:a,contact:i,delet:r}=this.getInputs(e);if(!(s&&a&&i&&r))return;const c=e=>[...e.parentElement.children].filter(t=>1==t.nodeType&&t!=e&&t.classList.contains("row")&&null!==t.dataset.block&&t.dataset.block===this.options.target);s.currentlist||(s.currentlist=this.currentlist),s.value&&!this.currentlist[s.value]&&(this.currentlist[s.value]=!0),!0!==t||s.tomselect||o.JsTomSelect.applyTo(s);const h=(t,s,a,i=!1)=>{t&&t.checked&&(t.checked=!0,n.y.hasMessage(e)&&n.y.removeMessage({type:n.y.alertconfig.types.danger,parent:e,content:this.keymessages.uhasnopriv})),t&&t.value===l.uZ.manage?(a.disabled=!0,s.disabled=!1,n.y.dismissAlert(this.keymessages.nomanager),s.checked&&(n.y.dismissAlert(this.keymessages.nocontact),s.dispatchEvent(new Event("valid")))):(s.checked=!1,a.disabled=!1,s.disabled=!0),!0===i&&p(e),a.ckecked||(n.y.dismissAlert(this.keymessages.nobody),n.y.hasMessage(e)&&n.y.removeMessage({type:n.y.alertconfig.types.danger,parent:e,content:this.keymessages.oneatleast}))},p=e=>{c(e).forEach(e=>{const t=e.querySelector("input[name*='["+this.options.delet+"]']"),s=e.querySelector('input[name="'+this.options.contactfieldname+'"]'),a=e.querySelector('input[name*="['+this.options.privilege+']"]:checked');h(a,s,t,!1)})};s.addEventListener("change",e=>{i.value=s.value,parseInt(s.value)>0&&n.y.hasMessage(s)&&n.y.removeMessage({type:n.y.alertconfig.types.danger,parent:s,content:this.keymessages.emptyname})}),a.forEach(e=>{e.dataset.hasOwnProperty("readonly")&&(0,d.DG)(e),e.addEventListener("change",t=>{e.checked&&h(e,i,r,!1)}),e.checked&&h(e,i,r,!1)}),i.dataset.hasOwnProperty("readonly")&&(0,d.DG)(i),i.addEventListener("change",t=>{i.checked?r.disabled=!0:r.disabled=!1;const s=e.querySelector('input[name*="['+this.options.privilege+']"]:checked');h(s,i,r,!0)}),r.addEventListener("click",t=>{const o=r.closest("label");if(this.fieldset.querySelectorAll('[data-block="'+this.options.target+'"]:not([data-mod="remove"])').length<=1&&t.target.checked)return t.preventDefault(),e.removeAttribute("data-mod"),s.disabled=!1,t.target.disabled=!0,void n.y.addMessage({type:n.y.alertconfig.types.danger,parent:e,content:this.keymessages.oneatleast,duration:3e3});t.target.checked?(n.y.hasMessage(s)&&n.y.removeMessage({type:n.y.alertconfig.types.danger,parent:s}),e.classList.contains("new")?e.remove():(o&&o.dataset.restore&&(o.dataset.title=o.dataset.restore),e.setAttribute("data-mod","remove"),a.forEach(e=>{e.dataset.checked=e.checked,e.checked=!1,e.disabled=!0}),i.checked=!1,i.disabled=!0,s.disabled=!0)):(o&&o.dataset.remove&&(o.dataset.title=o.dataset.remove),e.removeAttribute("data-mod"),a.forEach(e=>{e.disabled=!1,"true"===e.dataset.checked?e.checked=!0:e.checked=!1}),s.disabled=!1)}),r.addEventListener("mouseover",t=>{if(t.target.disabled){let s=e.querySelector('input[name*="['+this.options.privilege+']"]:checked');if(!s)return;s=s.value.toLowerCase(),t.target.dataset.title=t.target.dataset[s]?t.target.dataset[s]:t.target.dataset.title}}),this.current_uid===s.value&&(r.disabled=!0)}validateFields(e=!1){const t=e=>e.value&&parseInt(e.value)>0,s=e=>{const t=e.querySelector('[name*="['+this.options.privilege+']"]:checked');return!(!t||!t.value)},a=this.fieldset.querySelectorAll('[data-block="'+this.options.target+'"]');let i=a.length,r=!0;for(const e of a){const a=e.querySelector('[name*="['+this.options.ident+']"]');if(e.dataset.hasOwnProperty("model")||e.dataset.mod&&"remove"===e.dataset.mod){if(!(i>1))return!1;e.remove(),i--}else{if(!t(a)){n.y.addMessage({type:n.y.alertconfig.types.danger,parent:a,content:this.keymessages.emptyname}),a.focus();if(!0!==!1)return!1;if(!(i>1))return!1;e.remove(),i--}s(e)?n.y.hasMessage(e)&&n.y.removeMessage({type:n.y.alertconfig.types.danger,parent:e,content:this.keymessages.uhasnopriv}):(n.y.addMessage({type:n.y.alertconfig.types.danger,parent:e,content:this.keymessages.uhasnopriv}),r=!1)}}if(0===i)return n.y.addAlert({type:n.y.alertconfig.types.danger,content:this.keymessages.nobody,dismissible:!0,inverse:!0}),!1;n.y.dismissAlert(this.keymessages.nobody);return(this.fieldset.dataset.hasOwnProperty("readonly")||(()=>{if(0===this.fieldset.querySelectorAll('[name*="['+this.options.privilege+']"][value="'+l.uZ.manage+'"]:checked').length)return n.y.addAlert({type:n.y.alertconfig.types.danger,content:this.keymessages.nomanager,dismissible:!0,inverse:!0}),this.tabError(!0),!1;n.y.dismissAlert(this.keymessages.nomanager),this.tabError(!1);return null===this.fieldset.querySelector('[name="'+this.options.contactfieldname+'"]:checked')?(n.y.addAlert({type:n.y.alertconfig.types.danger,content:this.keymessages.nocontact,dismissible:!0,inverse:!0}),this.tabError(!0),!1):(n.y.dismissAlert(this.keymessages.nocontact),this.tabError(!1),!0)})())&&r}formatPrivileges(){const e=this.fieldset.querySelectorAll('[data-block="'+this.options.target+'"]'),t=e=>{e.querySelectorAll('[name*="members["').forEach(e=>{let t=e.name;t=t.split("["),t.pop(),e.name=t.join("["),e.name.indexOf("["+this.options.privilege+"]")>0&&(e.type="checkbox",e.classList.add("hidden"))})};return e.forEach(e=>{t(e)}),!0}getLinePrivilege(e){let t=null;const s=this.fieldset.querySelectorAll('[data-block="'+this.options.target+'"]');for(const a of s)if(parseInt(a.querySelector('[name*="['+this.options.ident+']"]').value)===parseInt(e)){t=a;break}return t}clearAll(){this.fieldset.querySelectorAll('[data-block="'+this.options.target+'"]').forEach((e,t)=>{e.remove()})}orderRows(){const e=Array.from(this.fieldset.querySelectorAll('[data-block="'+this.options.target+'"]'));if(e.length>2)try{const t=Object.values(l.uZ);e.sort((e,s)=>{const a=this.getInputs(e),i=this.getInputs(s),n=new String(i.member.options[i.member.selectedIndex].text).toLowerCase().split(" "),r=new String(a.member.options[a.member.selectedIndex].text).toLowerCase().split(" "),o=Array.from(a.privs).filter(e=>e.checked),l=Array.from(i.privs).filter(e=>e.checked),d=+!a.contact.checked+" "+t.indexOf(o.length?o[0].value:null)+" "+(r.length>1?r.pop()+" "+r[0]:r[0]),c=+!i.contact.checked+" "+t.indexOf(l.length?l[0].value:null)+" "+(n.length>1?n.pop()+" "+n[0]:n[0]);return c>d?-1:d>c?1:0});const s=this.linecontainer;e.forEach((e,t)=>{s.appendChild(e)})}catch(e){console.log("err not sorted",e)}}tabError(e){const t=this.fieldset.classList.contains(l.Do.component.tabs.tab.substr(1))?this.fieldset:this.fieldset.parentElement.classList.contains(l.Do.component.tabs.tab.substr(1))?this.fieldset.parentElement:null;null!==t&&(!0===e?t.classList.add(l.AH.error):t.classList.remove(l.AH.error))}}a()}catch(e){a(e)}})}}]);