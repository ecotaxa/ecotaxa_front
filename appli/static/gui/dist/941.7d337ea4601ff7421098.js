/*! For license information please see 941.7d337ea4601ff7421098.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[941],{5941:(t,e,i)=>{i.d(e,{DataImport:()=>d});var s=i(7856),o=i.n(s),r=i(2057),n=(i(5690),i(7737)),a=i(2817);const l=Object.keys(a.HN).reduce((function(t,e){return t[e]=e,t}),{});let c;a.iv.imported="imported";class d{content_selector=".modal-content";imports=[];taxos=["preset","extra"];importcontainer;importzoneid;importid="importzone";selectors;button;clearbutton;replacebutton;tabbutton;tbl=null;constructor(t,e=null,i=null){if(t&&(this.tbl="object"==typeof t?t:null,this.dom=this.tbl?this.tbl.dom:document.getElementById(t),this.dom)){if(e=e?o().sanitize(e):t&&t.params&&t.params.import?t.params.import:this.dom.dataset.import?o().sanitize(this.dom.dataset.import):null,!c||c.doc!==this.dom){const t={importcontainer:"#data-import-"+e,btns:".btns-imports",button:"#add-import-"+e,replacebutton:"#replace-import-"+e,tabbutton:"#tab-import-"+e,selector:"data-id"};this.selector=i||t.selector,this.importcontainer=t.importcontainer instanceof HTMLElement?t.importcontainer:document.querySelector(t.importcontainer),this.form=t.form?t.form instanceof HTMLElement?t.form:document.querySelector(t.form):this.dom.closest("form"),this.button=t.button instanceof HTMLElement?t.button:document.querySelector(t.button),this.replacebutton=t.replacebutton instanceof HTMLElement?t.replacebutton:document.querySelector(t.replacebutton),this.tabbutton=t.tabbutton instanceof HTMLElement?t.tabbutton:document.querySelector(t.tabbutton),this.init(t),c=this}return c}}init(t){this.showImport(!1);let e=this.form.querySelector("#"+a.EY.projid);e&&e.value&&(e=this.dom.querySelector("["+this.selector+'="'+e.value+'"]'),e&&e.classList.add(a.iv.hide));const i=this.indexToCheck();this.selectors=this.dom.querySelectorAll("["+this.selector+"] button, ["+this.selector+"] input"),this.selectors.forEach((t=>{const e=Array.from(t.parentElement.children).indexOf(t);if(i&&""===t.closest("tr").children[i[e]].innerHTML)t.disabled=!0;else{const i="input"===t.tagName.toLowerCase()?"change":"click",s=t=>{t.stopImmediatePropagation();const i=t.currentTarget;i.disabled=!0,this.toImport(i.parentElement,e)};t.removeEventListener(i,s,!1),t.addEventListener(i,s,!1)}})),this.button&&(this.tabbutton.addEventListener("click",(t=>{t.stopImmediatePropagation(),this.resizeZone(t)})),this.showImport(!1))}columnProperty(t,e,i){return this.tbl?this.tbl.grid.columns[e].hasOwnProperty(t)?this.tbl.grid.columns[e][t]:null:i.dataset[t]?i.dataset.name:null}columnIndex(t,e){return Array.from(this.dom.querySelectorAll("thead th")).findIndex((i=>i.dataset[t]&&i.dataset[t]===e))}gridColumnIndex(t,e){return this.tbl?this.tbl.grid.columns.findIndex((i=>i.hasOwnProperty(t)&&i[t]===e)):this.columnIndex(t,e)}rowIndex(t,e){const i=t.parentElement?t.parentElement:null;return i?e.findIndex((t=>t===i)):null}toImport(t,e=0){const i=this.tbl?this.tbl.grid:null,s=Array.from(this.dom.querySelectorAll("thead th")),o=Array.from(this.dom.querySelectorAll("tbody tr")),c=i?i.data:o.map((t=>Array.from(t.childNodes).forEach((t=>t.innerText))));"td"!==t.tagName.toLowerCase()&&(t=t.closest("td"));const d=this.rowIndex(t,o);if(null===d)return;let m=!0;const u=t.cellIndex,p=s[u],h=(o[d],this.columnProperty("what",u,p));if(!h)return;const f=this.columnProperty("parts",u,p);let b=this.columnProperty("selectcells",u,p);if(b=b?f?[f[e]]:b:null,!b)return;h!==a.oL.settings&&h!==a.oL.privileges||(this.imports[a.Cq.contact]=this.findContact(c[d]));const v=h===a.oL.taxo||h===a.oL.privileges?this.createImportzone(h):null;let g=null;b.forEach(((t,e)=>{if((e=this.gridColumnIndex("name",t))>=0){const i=this.columnIndex("name",t),u=i>=0?o[d].cells[i]:null;u&&u.classList.add(a.iv.selected);const p=c[d][e],f=i>=0?s[i]:null;switch(h){case a.oL.taxo:g=v.tomselect;let e=p;e&&(g?(Object.values(g.options).forEach((t=>{let i={};i[t[g.settings.valueField]]=t[g.settings.labelField],e[t[g.settings.valueField]]||(e=Object.assign(e,i))})),e=Object.entries(e),e.sort(((t,e)=>{let i=t[1],s=e[1];return+(i>s)||-(s>i)})),g.clear(),g.clearOptions(),e.forEach((([t,e])=>{if(!g.getItem(t)){if(!g.getOption(t)){let i={};i[g.settings.valueField]=t,i[g.settings.labelField]=(0,n.l1)(e.trim()),g.addOption(i)}g.addItem(t)}}))):(Object.values(v.options).forEach((t=>{let i={};i[t.value]=t.text,e[t.value]||(e=Object.assign(e,i))})),e=Object.entries(e),e.sort(((t,e)=>{let i=t[1],s=e[1];return+(i>s)||-(s>i)})),v.innerHTML="",e.forEach((([t,e])=>{v.querySelector('option[value="'+t+'"]')||v.insertAdjacentHTML("beforeend",'<option value="'+t+'" selected>'+e+"</option>")}))),m=e.length>0,e=null);break;case a.oL.privileges:const i=p,o=g&&g.items.length>0||v.selectedIndex>0;if(!v.dataset.init){(new r.JsTomSelect).applyTo(v),v.dataset.init=!0}g=v.tomselect,Object.entries(i).forEach((([t,e])=>{e.sort(((t,e)=>e.name>t.name)),e.forEach((e=>{const i=o?l.viewers:t;let s;g?(s=g.items.indexOf(e.id),s>=0&&(g.removeItem(e.id),g.removeOption(e.id)),s={optgroup:i},s[g.settings.valueField]=e.id,s[g.settings.searchField]=e.name,s[g.settings.labelField]=e.name,g.addOption(s),g.addItem(e.id)):(s=v.querySelector('option[value="'+e.id+'"]'),null===s?(s=document.createElement("option"),s.value=e.id,s.dataset.optgroup=i,s.selected=s.defaultSelected=!0,s.text=e.name,v.add(s)):s.dataset.optgroup=i)})),v.tomselect.refreshOptions(!0)})),m=(g?g.items.length:v.selectedIndex+1)>0;break;default:if(this.imports[t]=p,null!==u)if(u.dataset.autocomplete){this.imports[t]={value:p,key:null};let e=null;s.every(((t,i)=>t.dataset.name!=f.dataset.autocomplete||(e=i,!1))),null!==e&&(e=c[d][e],this.imports[t].key=e)}else u.dataset.value&&(this.imports[t]=u.dataset.value)}}})),s.length&&(this.button?(this.showImport(m),this.button.dataset.activated||h!==a.oL.taxo&&h!==a.oL.privileges||this.activateButtons(h,b)):this.makeImport(null,b,h,!0))}messageZone(t){console.log("itemmessage",t)}activateButtons(t,e){this.button.addEventListener("click",(i=>{i.stopImmediatePropagation(),i.preventDefault(),this.makeImport(i.currentTarget,e,t,!0)})),this.replacebutton.addEventListener("click",(i=>{i.stopImmediatePropagation(),i.preventDefault(),this.makeImport(i.currentTarget,e,t,!0)})),this.button.dataset.activated=!0,this.replacebutton.dataset.activated=!0}findContact(t,e="contact"){const i=this.gridColumnIndex("name",e);return i>=0&&t[i]?t[i]:null}renderPrivileges(t,e=!1){let i={};const s=t.tomselect,o=(t,e)=>{const s={id:t.id,name:t.name,priv:e};i[e]?i[e].push(s):i[e]=[s]};if(s){const t=[...s.items],e=Object.assign({},s.options);t.forEach((t=>{(t=e[t])&&o(t,t.optgroup)}))}else t.options.forEach((t=>{t.selected&&o(t,t.dataset.optgroup)}));this.importPrivileges(i,e)&&(s?(s.clear(),s.clearOptions()):t.innerHTML="")}importPrivileges(t,e=!1){const i=this.form.querySelector("."+a.EY.component.privileges.ident);if(null===i||!i.jsprivileges)return;const s=!0===e&&this.imports[a.Cq.contact]?this.imports[a.Cq.contact]:null;return i.jsprivileges.importPrivileges(t,e,s,(t=>{this.setImportedTag(t,null)}),(()=>{this.dismiss()}))}resetSelectors(){this.selectors.forEach(((t,e)=>{t.disabled&&(t.disabled=!1)})),this.dom.querySelectorAll("td."+a.iv.selected).forEach((t=>{t.classList.remove(a.iv.selected)}))}activateClear(){const t=document.getElementById("clear-"+this.importid);t&&t.addEventListener("click",(t=>{t.stopImmediatePropagation(),this.importcontainer&&(this.resetSelectors(),this.button.disabled=!1,this.replacebutton.disabled=!1,this.showImport(!1))}))}createImportzone(t){this.showImport(!0);let e=this.importcontainer.querySelector("#"+this.importid);if(t===a.oL.privileges)e||(e=document.createElement("select"),this.importid=e.id=this.importid+"-"+t,e.dataset.type=a.Cq.user,e.multiple=!0,e.dataset.priv=!0,this.importcontainer.append(e));else{const i=this.form.querySelector('[name="'+t+'"]')?this.form.querySelector('[name="'+t+'"]'):this.form.querySelector('[data-importfield="'+t+'"]'),s=i.tomselect;if(!e){if(!i)return;if(this.importzoneid=i.id,e=i.cloneNode(),e.classList.remove("tomselected"),e.classList.remove("ts-hidden-accessible"),e.dataset.origin=e.id,e.id=this.importid,e.name=this.importid+"_"+e.name,this.importcontainer.insertAdjacentHTML("afterbegin",e.outerHTML),s){e=this.importcontainer.querySelector("#"+this.importid);(new r.JsTomSelect).applyTo(e)}this.activateClear()}}return e}makeImport(t,e,i,s=!1){let r=!0,l=null;const c=this.importcontainer?this.importcontainer.querySelector("#"+this.importid):null;switch(i){case a.oL.taxo:if(!c)return!1;const s=this.form.querySelector("#"+c.dataset.origin);if(!s)return!1;if(l=s.tomselect,l){t.dataset.replace&&"replace"===t.dataset.replace&&(l.clear(),l.clearOptions());const e=c.tomselect,i=[...e.items],s=Object.assign({},e.options);i.forEach(((t,e)=>{let i={};i[l.settings.valueField]=t,i[l.settings.searchField]=(0,n.l1)(s[t][l.settings.searchField]),l.getOption(t)||l.addOption(i),l.addItem(t)})),e.clear(),e.clearOptions()}else t.dataset.replace&&"replace"===t.dataset.replace&&(s.innerHTML=""),s.innerHTML=o().sanitize(c.innerHTML),c.innerHTML="";r=!0;break;case a.oL.privileges:if(!c)return!1;r=this.renderPrivileges(c,t.dataset.replace&&"replace"===t.dataset.replace);break;default:const d=function(t,e){const i={};"string"==typeof e?(i[t.settings.labelField]=e,i[t.settings.valueField]=e,i[t.settings.searchField]=(0,n.l1)(e)):(i[t.settings.labelField]=e.key,i[t.settings.valueField]=e.key,i[t.settings.searchField]=(0,n.l1)(e.value)),t.getOption(i[t.settings.valueField])||t.addOption(i),t.getItem(i[t.settings.valueField])||t.addItem(i[t.settings.valueField])},m=function(t,e){const i=document.createElement("option");"string"==typeof e?i.value=i.text=e:(i.value=e.key,i.text=e.value),i.selected=!0,t.append(i)},u=function(t,e){if(t.multiple){let i=t.value.split(",");i.push(e.key),t.value=i.join(",")}else t.value=e};e.forEach(((t,e)=>{let s=this.form.querySelector('[data-importfield="'+t+'"]')?this.form.querySelector('[data-importfield="'+t+'"]'):this.form.querySelector('[name="'+t+'"]');if(!s||!s.dataset.noimport)if(s&&void 0!==this.imports[t]){const e=s.type?s.type:s.tagName.toLowerCase();if(l=s.tomselect,"init_classif_list"===t){let i=this.imports[t];if(i=Array.isArray(i)?i.join(","):i.replace("[","").replace("]","").replaceAll(" ",""),l&&(l.wrapper.classList.add("wait-for-results"),l.clear(!1),l.clearOptions()),""!==i){l&&l.wrapper.classList.add("wait-for-results");const t=new FormData;t.append("idlist",i);fetch("/search/taxoresolve",(0,n.wv)({method:"POST",body:t})).then((t=>t.json())).then((t=>{const i=s.tomselect;i?(Object.entries(t).forEach((([t,e])=>{const s={key:o().sanitize(t),value:o().sanitize(e)};d(i,s)})),i.wrapper.classList.remove("wait-for-results")):0===e.indexOf("select")?(s.querySelectorAll("option").forEach((t=>{t.remove()})),Object.entries(t).forEach((([t,e])=>{const i={key:o().sanitize(t),value:o().sanitize(e)};u(s,i)}))):Object.entries(t).forEach((([t,e])=>{const i={key:o().sanitize(t),value:o().sanitize(e)};m(s,i)})),t=null,this.setImportedTag(s)}))}}else if(l)d(l,this.imports[t]),this.setImportedTag(s);else{switch(e){case"radio":case"checkbox":s=this.form.querySelector('[name="'+t+'"][value="'+this.imports[t]+'"]'),s&&(s.checked=!0);break;case"select":s.multiple?this.imports[t].forEach((t=>{m(s,t)})):m(s,this.imports[t]);break;default:s.value=this.imports[t]}this.setImportedTag(s)}i!==a.oL.settings&&s.focus(),r=r&&!0}else if(t===a.oL.privileges){const e=!1;r=r&&this.importPrivileges(this.imports[t],e)}}))}!0===r&&1==s&&(this.dismiss(),this.form&&this.form.dispatchEvent(new CustomEvent("validate")))}setImportedTag(t,e=a.EY.component.form.formbox){let i=null===e?t:t.closest(e)?t.closest(e):t.closest("fieldset");if(!i)return;const s=e=>{delete i.dataset.isimported,i.classList.remove(a.iv.imported),t.removeEventListener("change",s)};i.dataset.isimported=this.form.dataset.isimported,i.classList.add(a.iv.imported),void 0!==t.dataset.unique&&(t.dataset.unique=t.value),setTimeout((function(){t.addEventListener("change",s)}),500)}dismiss(t=!1){this.button&&this.showImport(!1);const e=this.dom.closest("details");e&&(e.open=!1,!0===t&&(e.querySelector(this.content_selector).innerHTML=""))}indexToCheck(){const t=this.tbl?this.tbl.grid:null;if(!t)return[0];let e=t.columns.findIndex((t=>t.what&&t.what===a.oL.taxo));if(-1===e)return[0];const i=t.columns[e].parts?t.columns[e].parts:null;if(i){return t.columns.filter(((t,e)=>{if(i.indexOf(t.name)>=0)return e})).map((t=>t.index))}}showImport(t){if(this.button)if(!1===t)this.button.classList.add(a.iv.hide),this.replacebutton.classList.add(a.iv.hide),this.importcontainer.classList.add(a.iv.hide),this.tabbutton.classList.add(a.iv.hide);else{this.button.classList.remove(a.iv.hide),this.replacebutton.classList.remove(a.iv.hide),this.importcontainer.classList.remove(a.iv.hide),this.button.disabled=!1;const t=this.importcontainer.querySelector("#"+this.importid);t&&(this.tabbutton.classList.remove(a.iv.hide),t.tomselect&&t.tomselect.control.offsetHeight<t.tomselect.control.scrollHeight?this.tabbutton.disabled=!1:this.tabbutton.disabled=!0)}}resizeZone(t){const e=this.importcontainer.closest(a.EY.component.import.zoneimport);if(!e)return;e.parentElement.classList.toggle(a.iv.showfull);const i=t.currentTarget.querySelector("i");i&&(i.classList.toggle("icon-arrow-pointing-out"),i.classList.toggle("icon-arrow-pointing-in"))}}}}]);