/*! For license information please see 681.a8322913115975bb58a9.js.LICENSE.txt */
"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[681],{681:(e,n,a)=>{a.a(e,(async(e,t)=>{try{a.d(n,{JsDirToZip:()=>d});var i=a(4860),l=a(9861),o=a(2438),r=e([o]);o=(r.then?(await r)():r)[0];const s=new Set(["zip","gz","png","jpg","jpeg","pdf","doc","docx","ppt","pptx","xls","xlsx","heic","heif","7z","bz2","rar","gif","webp","webm","mp4","mov","mp3","aifc"]),c=".tsv,.png,.jpg, .jpeg,.zip,.gz,.7z,.bz2",p=1073741824;function d(e={}){const n={ready:"ready",follow:"follow",endzip:"endzip",complete:"complete",endreaddir:"endreaddir",gzip:"gzip",sendfile:"sendfile",bigfile:"bigfile",terminate:"terminate",pending:"pending",errorfile:"errorfile",counter:"counter",reject:"reject",message:"message",error:"error",init:"init"};let t,r;const d={uploadurl:"/gui/files/upload",largefile:p,accept:c.split(",")},u=(e={...d,...e}).listener?e.listener:f;Object.freeze(e);const f=(0,i.UP)();async function m(){r.pos=0,r.sizetozip=0,console.log("==================newzip"),r.zip=new l.qQ(((e,n,a)=>{if(e)return console.log("error",e),!1;r.streamhandle.write(n,{at:self.pos}),r.pos+=n.length,a&&(r.streamhandle.close(),console.log("final-----------------------------*******************************-",r.pos))})),function(e=null){const n=(e=null===e?r.zip:e).ondata;e.ondata=(a,t,i)=>{n(a,t,i),i&&(e.d=null,e.u.at(-1).d=null)}}(),r.follow&&await r.follow()}function g(e){if(!0===r.endreaddir&&!0===r.endcounter){const a=z(e,{name:n.endzip});o.j.emit(n.complete,a,u)}}function z(e,n={}){return e.hasOwnProperty("part")?n.part=e.part:r.part=0,e.hasOwnProperty("bigfile")&&(n.bigfile=e.bigfile),e.hasOwnProperty("path")&&(n.path=e.path),n}async function h(){navigator&&navigator.storage&&navigator.storage.estimate&&navigator.storage.estimate().then((e=>{const a=(e.usage/e.quota*100).toFixed(2),t=(0,i.Y2)(e.quota-e.usage);o.j.emit(n.message,{id:"quota",name:"console",message:"you've used "+a+"% of the available storage ("+t+")."},u)}))}async function w(e,n={"application/zip":[".zip"]}){const a=await navigator.storage.getDirectory(),t={types:[{description:"Temp file",accept:n}],create:!0},i=await a.getFileHandle(e,t),l=await i.createWritable();return{filestream:i,streamhandle:l}}async function y(e,l={}){if(r.endreaddir=!1,null===r.zip){e=""===(e=e.split(i.hx)[0]).trim()?"temp":e;const s=l&&l.type?l.type:".zip";r.zipname=(l.zipname?l.zipname:e)+s;await async function(e){const n=await navigator.storage.getDirectory();for await(const[a,t]of n.entries())if(e===a)return!0;return!1}(r.zipname)&&(r.zipname="1_"+r.zipname);const{filestream:d,streamhandle:g}=await w(r.zipname);r.filestream=d,r.streamhandle=g;if(r.part=0,await m(),!t){const{JsScanDir:e}=await a.e(162).then(a.bind(a,4162));t=e((async(e,a)=>{!function(e){const n=e.name,a=n.slice(n.lastIndexOf(".")+1);return c.includes(a)}(e)?function(e,a=null){const t=e.fullPath?e.fullPath:e.webkitRelativePath;r.counter.reject+=1,o.j.emit(n.reject,{name:n.reject,path:t},u),null!==a&&a()}(e,a):(r.callback=a,await async function(e){const a=e.fullPath?e.fullPath:e.webkitRelativePath;e.file((async e=>{await async function(e,a,t=!0){!0===t&&o.j.emit(n.counter,{name:"scan",path:a,size:e.size},f);r.follow=null,e.size>=p?j(e,a):(r.sizetozip+=e.size,r.sizetozip>=p?(r.follow=async()=>{await k(e,a)},async function(){r.part+=1,o.j.emit(n.complete,{name:n.endzip,part:r.part},u)}()):await k(e,a))}(e,a)}))}(e))}))}}}function b(){o.j.emit(n.endreaddir,{name:n.endreaddir},f)}async function j(e,a){if(null!==r.gzipped)return void await(t=async()=>{await j(e,a)},void r.handlers.push(t));var t;let c=Date.now();a=0===a.indexOf(i.hx)?a.substr(1):a;const p=e.name.slice(e.name.lastIndexOf(".")+1);if(s.has(p))r.gzipped=e,o.j.emit(n.counter,{name:"zip",path:a,size:e.size},f),o.j.emit(n.complete,{name:n.bigfile,bigfile:e.name,path:a},u);else{let t=e.name+".gz";o.j.emit(n.complete,{name:n.gzip,bigfile:e.name,path:a,size:e.size},u);const{filestream:i,streamhandle:s}=await w(t,{"application/gzip":[".gz"]});let p=0;const d=new l.JZ({level:6,filename:a});d.ondata=(t,l,d)=>{t?(console.log("gzip err",t),x(n.errorfile,{bigfile:e.name,path:a,size:e.size})):(s.write(l,{at:p}),p+=l.length,d&&(console.log("final BIGFILE%%%%%%%%%%%%%%%%%%%%"+n.bigfile,a),console.log("timetogzzip",(Date.now()-c)/1e3),s.close(),r.gzipped=i,o.j.emit(n.counter,{name:"zip",path:a,size:e.size},f),o.j.emit(n.complete,{name:n.bigfile,bigfile:e.name,path:a},u)))};const m=!1;await v(e,a,d,m)}}async function v(e,a,t,i=!0){const l=e.stream().getReader();for(;;){const{done:r,value:s}=await l.read();if(r){t.push(new Uint8Array(0),!0),!0===i&&o.j.emit(n.counter,{name:"zip",path:a,size:t.size?t.size:e.size},f);break}t.push(s)}}async function k(n,a){const t=a.slice(a.lastIndexOf(".")+1),i=s.has(t)?new l.uZ(a):n.size>e.largefile?new l.hw(a,{level:6}):new l.D8(a,{level:6});r.zip.add(i),await v(n,a,i)}function x(e,a=null){switch(a=a||{},e){case n.init:a.name=n.init;break;case n.errorfile:console.log("errorfile",a);default:a.name=n.follow}o.j.emit(n.error,a,u)}async function P(e,a=!1){if(e.name=n.terminate,r.follow)return r.streamhandle=await r.filestream.createWritable(),e.name=n.follow,o.j.emit(n.follow,e,u),void await m();if(e.hasOwnProperty("bigfile")&&!1!==e.bigfile){if(r.gzipped=null,r.handlers.length>0)return e.name=n.follow,o.j.emit(n.follow,e,u),console.log(" handlers to do",e),void(r.handlers.length>0&&await async function(){if(r.handlers.length>0){const e=r.handlers.shift();await e()}}())}else r.zip=null;o.j.emit(n.complete,e,u)}async function F(e,n=0,a=0,t=p){console.log("send chunk ",r.gzipped);const i=await r.gzipped.getFile(),l=Math.min(n+t,i.size);if(l===i.size)D(i,e,null,!0);else{const o=i.slice(n,l);o.name=a+"_"+i.name,sendZipfile(o,e,(()=>{a++,(n+=l)<=i.size&&F(e,n,a,t)}),!0)}return a}async function D(a,t,l=null,s=!1){const c={name:n.pending,path:t};s&&(c.bigfile=a.name),o.j.emit(n.complete,c,u);const p=new FormData;t=t+(t.slice(-1)===i.hx?"":i.hx)+a.name,p.append("path",t),p.append("file",a,a.name),r.part?p.append("part",r.part):null!==l&&p.append("ischunk",!0),fetch(e.uploadurl,{method:"POST",credentials:"include",body:p}).then((async e=>{console.log("response----------------------",e),console.log("callbackchunk-------------------------------",l),c.path=t,200===e.status?null!==l?await l():await P(c):x(n.error,c)}))}return r={zip:null,zipname:null,filestream:null,streamhandle:null,gzipped:null,sizetozip:0,part:0,follow:null,endcounter:!1,endreaddir:!1,callback:null,pos:0,counter:{scan:0,zip:0,reject:0},handlers:[]},o.j.on(n.init,(async e=>{0==(null!==r.zip||null!==r.follow||null!==r.gzipped||!0!==r.endreaddir)?(console.log("reset terminate event end"),await async function(){r={zip:null,zipname:null,filestream:null,streamhandle:null,gzipped:null,sizetozip:0,part:0,follow:null,endcounter:!1,endreaddir:!1,callback:null,pos:0,counter:{scan:0,zip:0,reject:0},handlers:[]},await async function(){navigator&&navigator.storage&&navigator.storage.estimate?(await async function(e=null){e=e||await navigator.storage.getDirectory();for await(const[n,a]of e.entries())try{await e.removeEntry(n),console.log(" Success remove storage ",n)}catch(e){console.log(" error remove storage "+n,e)}}(),h()):o.j.emit(n.message,{name:"error",message:"no navigator storage"},f)}()}(),o.j.emit(n.complete,{name:n.ready},u),r.endreaddir=!1):console.log(" partly finshed ",e)}),f),o.j.on(n.endzip,(e=>{!e.bigfile&&r.zip?r.zip.end():e.bigfile&&r.gzipped&&console.log("-------------------------gzipped end",r.gzipped);const a=z(e,{name:n.sendfile});console.log("endzip%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%",a),o.j.emit(n.complete,a,u)}),f),o.j.on(n.sendfile,(async e=>{const n=e.bigfile?await r.gzipped.getFile():await async function(e=null){e=null===e?r.filestream:e;const n=await e.getFile();return n}();e.bigfile?F((e.path?e.path:"").replace(e.bigfile,"")):D(n,e.path?e.path:"",null)}),f),o.j.on(n.bigfile,(e=>{console.log("onsendchunk",e),F((e.path?e.path:"").replace(e.bigfile,""))}),f),o.j.on(n.endreaddir,(e=>{r.endreaddir=!0,g(e)}),f),o.j.on(n.counter,(async e=>{r.endcounter=!1,r.counter[e.name]+=1,o.j.emit(n.counter,e,u),"zip"===e.name&&r.counter.scan===r.counter.zip&&(r.endcounter=!0,g(e)),"zip"===e.name&&r.callback&&await r.callback()}),f),{uuid:f,eventnames:n,scanBrowse:async function(e,n={}){const a=e instanceof FileList?Array.from(e):"directory"===e.kind?await Array.fromAsync(e.values()):Array.isArray(e)?e:[e];a[0].name;let l=e instanceof FileList?a[0].webkitRelativePath:null;l=l?l.split(i.hx):[""],l.length&&l.pop(),l=l.join(i.hx);const o=e instanceof FileList?l:"directory"===e.kind?e.name:"";await y(o,n),await t.processEntries(a,o,(()=>{b()}))},scanHandle:async function(e,n={}){await y(e.name,n),!0===e.isDirectory?await t.readDirectory(e,(()=>{b()})):!0===e.isFile&&await t.processFile(e,(()=>{b()}))},quotaEstimate:h}}t()}catch(u){t(u)}}))}}]);