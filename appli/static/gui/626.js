"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[626,200],{5941:(t,e,s)=>{s.d(e,{DataImport:()=>m});var i=s(7856),o=s.n(i),r=s(2627),n=s(5690),l=s(9162),a=s(2817);const c=Object.keys(a.HN).reduce((function(t,e){return t[e]=e,t}),{});let d;class m{content_selector=".modal-content";imports=[];taxos=["preset","extra"];importcontainer;importzoneid;importid="importzone";selectors;button;clearbutton;replacebutton;tabbutton;tbl=null;constructor(t,e=null,s=null){if(t&&(this.tbl="object"==typeof t?t:null,this.dom=this.tbl?this.tbl.dom:document.getElementById(t),this.dom)){if(e=e?o().sanitize(e):t&&t.params&&t.params.import?t.params.import:this.dom.dataset.import?o().sanitize(this.dom.dataset.import):null,!d||d.doc!==this.dom){const t={importcontainer:"#data-import-"+e,btns:".btns-imports",button:"#add-import-"+e,replacebutton:"#replace-import-"+e,clearbutton:"#clear-import-"+e,tabbutton:"#tab-import-"+e,selector:"data-id"};this.selector=s||t.selector,this.importcontainer=t.importcontainer instanceof HTMLElement?t.importcontainer:document.querySelector(t.importcontainer),this.form=t.form?t.form instanceof HTMLElement?t.form:document.querySelector(t.form):this.dom.closest("form"),this.button=t.button instanceof HTMLElement?t.button:document.querySelector(t.button),this.replacebutton=t.replacebutton instanceof HTMLElement?t.replacebutton:document.querySelector(t.replacebutton),this.clearbutton=t.clearbutton instanceof HTMLElement?t.clearbutton:document.querySelector(t.clearbutton),this.tabbutton=t.tabbutton instanceof HTMLElement?t.tabbutton:document.querySelector(t.tabbutton),this.init(t),d=this}return d}}init(t){this.showImport(!1);let e=this.form.querySelector("#"+a.EY.projid);e&&e.value&&(e=this.dom.querySelector("["+this.selector+'="'+e.value+'"]'),e&&e.classList.add(a.iv.hide));const s=this.indexToCheck();this.selectors=this.dom.querySelectorAll("["+this.selector+"] button, ["+this.selector+"] input"),this.selectors.forEach((t=>{const e=Array.from(t.parentElement.children).indexOf(t);if(s&&""===t.closest("tr").children[s[e]].innerHTML)t.disabled=!0;else{const s="input"===t.tagName.toLowerCase()?"change":"click",i=t=>{const s=t.currentTarget;s.disabled=!0,this.toImport(s.parentElement,e)};t.removeEventListener(s,i,!1),t.addEventListener(s,i,!1)}})),this.button&&(this.tabbutton.addEventListener("click",(t=>{this.resizeZone(t)})),this.showImport(!1))}columnProperty(t,e,s){return this.tbl?this.tbl.grid.columns[e].hasOwnProperty(t)?this.tbl.grid.columns[e][t]:null:s.dataset[t]?s.dataset.name:null}columnIndex(t,e){return this.tbl?this.tbl.grid.columns.findIndex((s=>s.hasOwnProperty(t)&&s[t]===e)):Array.from(this.dom.querySelectorAll("thead th")).findIndex((s=>s.dataset[t]&&s.dataset[t]===e))}rowIndex(t,e){const s=t.parentElement?t.parentElement:null;return s?e.findIndex((t=>t===s)):null}toImport(t,e=0){const s=this.tbl?this.tbl.grid:null,i=Array.from(this.dom.querySelectorAll("thead th")),o=Array.from(this.dom.querySelectorAll("tbody tr")),n=s?s.data:o.map((t=>Array.from(t.childNodes).forEach((t=>t.innerText))));"td"!==t.tagName.toLowerCase()&&(t=t.closest("td"));const d=this.rowIndex(t,o);if(null===d)return;let m=!0;const u=t.cellIndex,h=i[u],p=(o[d],this.columnProperty("what",u,h));if(!p)return;const b=this.columnProperty("parts",u,h);let f=this.columnProperty("selectcells",u,h);if(f=f?b?[b[e]]:f:null,!f)return;p===a.oL.settings&&(this.imports[a.Cq.contact]=this.findContact(i,n[d]));const v=p===a.oL.taxo||p===a.oL.privileges?this.createImportzone(p):null;let g=null;f.forEach(((t,e)=>{if((e=this.columnIndex("name",t))>=0){const s=o[d].cells[e],u=n[d][e];s.classList.add(a.iv.selected);const h=i[e];switch(p){case a.oL.taxo:g=v.tomselect;let e=u;e&&(g?(Object.values(g.options).forEach((t=>{let s={};s[t[g.settings.valueField]]=t[g.settings.labelField],e[t[g.settings.valueField]]||(e=Object.assign(e,s))})),e=Object.entries(e),e.sort(((t,e)=>{let s=t[1],i=e[1];return+(s>i)||-(i>s)})),g.clear(),g.clearOptions(),e.forEach((([t,e])=>{if(!g.getItem(t)){if(!g.getOption(t)){let s={};s[g.settings.valueField]=t,s[g.settings.labelField]=(0,l.l1)(e.trim()),g.addOption(s)}g.addItem(t)}}))):(Object.values(v.options).forEach((t=>{let s={};s[t.value]=t.text,e[t.value]||(e=Object.assign(e,s))})),e=Object.entries(e),e.sort(((t,e)=>{let s=t[1],i=e[1];return+(s>i)||-(i>s)})),v.innerHTML="",e.forEach((([t,e])=>{v.querySelector('option[value="'+t+'"]')||v.insertAdjacentHTML("beforeend",'<option value="'+t+'" selected>'+e+"</option>")}))),m=e.length>0,e=null);break;case a.oL.privileges:const s=u,o=g&&g.items.length>0||v.selectedIndex>0;v.dataset.init||((new r.JsTomSelect).applyTo(v),v.dataset.init=!0),g=v.tomselect,Object.entries(s).forEach((([t,e])=>{e.sort(((t,e)=>e.name>t.name)),e.forEach((e=>{const s=o?c.viewers:t;let i;g?(i=g.items.indexOf(e.id),i>=0&&(g.removeItem(e.id),g.removeOption(e.id)),i={optgroup:s},i[g.settings.valueField]=e.id,i[g.settings.searchField]=e.name,i[g.settings.labelField]=e.name,g.addOption(i),g.addItem(e.id)):(i=v.querySelector('option[value="'+e.id+'"]'),null===i?(i=document.createElement("option"),i.value=e.id,i.dataset.optgroup=s,i.selected=i.defaultSelected=!0,i.text=e.name,v.add(i)):i.dataset.optgroup=s)})),v.tomselect.refreshOptions()})),console.log("privs",s),console.log("importzone",v),console.log("ts",g),m=(g?g.items.length:v.selectedIndex+1)>0;break;default:if(h.dataset.autocomplete){this.imports[t]={value:u,key:null};let e=null;i.every(((t,s)=>t.dataset.name!=h.dataset.autocomplete||(e=s,!1))),null!==e&&(e=n[d][e],this.imports[t].key=e)}else h.dataset.value?this.imports[t]=h.dataset.value:this.imports[t]=u}}})),i.length&&(this.button?(this.showImport(m),this.button.dataset.activated||p!==a.oL.taxo&&p!==a.oL.privileges||this.activateButtons(p,f)):this.makeImport(null,f,p,!0))}messageZone(t){console.log("itemmessage",t)}activateButtons(t,e){this.button.addEventListener("click",(s=>{s.preventDefault(),this.makeImport(s.currentTarget,e,t,!0)})),this.replacebutton.addEventListener("click",(s=>{s.preventDefault(),this.makeImport(s.currentTarget,e,t,!0)})),this.clearbutton.addEventListener("click",(t=>{if(t.preventDefault(),!this.importcontainer)return;const e=this.importcontainer.querySelector("#"+this.importid);e&&(e.tomselect?(e.tomselect.clear(),e.tomselect.refreshOptions()):e.value=""),this.selectors.forEach((t=>{t.disabled&&(t.disabled=!1,t.closest("tr").querySelectorAll(".selected").forEach((t=>{t.classList.remove(a.iv.selected)})))})),this.button.disabled=!1,this.replacebutton.disabled=!1})),this.button.dataset.activated=!0,this.replacebutton.dataset.activated=!0}findContact(t,e){let s=null;return t.every(((t,e)=>!t.dataset.name||t.dataset.name!==a.Cq.contact||(s=e,!1))),s&&(s=e[s]?e[s]:0),s}renderPrivileges(t,e=!1){let s={};const i=t.tomselect,o=(t,e)=>{const i={id:t.id,name:t.name,priv:e};s[e]?s[e].push(i):s[e]=[i]};if(i){const t=[...i.items],e=Object.assign({},i.options);t.forEach((t=>{(t=e[t])&&o(t,t.optgroup)}))}else t.options.forEach((t=>{t.selected&&o(t,t.dataset.optgroup)}));this.importPrivileges(s,e)&&(i?(i.clear(),i.clearOptions()):t.innerHTML="")}importPrivileges(t,e=!1){const s=new n.ProjectPrivileges,i=this.imports[a.Cq.contact]?this.imports[a.Cq.contact]:null;return s.importPrivileges(t,e,i,(t=>{this.setImportedTag(t,null)}),(()=>{this.dismiss()}))}createImportzone(t){this.showImport(!0);let e=this.importcontainer.querySelector("#"+this.importid);if(t===a.oL.privileges)e||(e=document.createElement("select"),this.importid=e.id=this.importid+"-"+t,e.dataset.type=a.Cq.user,e.multiple=!0,e.dataset.priv=!0,this.importcontainer.append(e));else{const s=this.form.querySelector('[name="'+t+'"]')?this.form.querySelector('[name="'+t+'"]'):this.form.querySelector('[data-importfield="'+t+'"]'),i=s.tomselect;if(!e){if(!s)return;this.importzoneid=s.id,e=s.cloneNode(),e.classList.remove("tomselected"),e.classList.remove("ts-hidden-accessible"),e.dataset.origin=e.id,e.id=this.importid,e.name=this.importid+"_"+e.name,this.importcontainer.insertAdjacentHTML("afterbegin",e.outerHTML),i&&(e=this.importcontainer.querySelector("#"+this.importid),(new r.JsTomSelect).applyTo(e))}}return e}makeImport(t,e,s,i=!1){let r=!1,n=null;const c=this.importcontainer?this.importcontainer.querySelector("#"+this.importid):null;switch(s){case a.oL.taxo:if(!c)return!1;const i=this.form.querySelector("#"+c.dataset.origin);if(!i)return!1;if(n=i.tomselect,n){t.dataset.replace&&"replace"===t.dataset.replace&&(n.clear(),n.clearOptions());const e=c.tomselect,s=[...e.items],i=Object.assign({},e.options);s.forEach(((t,e)=>{let s={};s[n.settings.valueField]=t,s[n.settings.searchField]=(0,l.l1)(i[t][n.settings.searchField]),n.getOption(t)||n.addOption(s),n.addItem(t)})),e.clear(),e.clearOptions()}else t.dataset.replace&&"replace"===t.dataset.replace&&(i.innerHTML=""),i.innerHTML=o().sanitize(c.innerHTML),c.innerHTML="";r=!0;break;case a.oL.privileges:if(!c)return!1;r=this.renderPrivileges(c,t.dataset.replace&&"replace"===t.dataset.replace);break;default:e.forEach(((t,e)=>{let i=this.form.querySelector('[data-importfield="'+t+'"]')?this.form.querySelector('[data-importfield="'+t+'"]'):this.form.querySelector('[name="'+t+'"]');if(i&&void 0!==this.imports[t]){if(n=i.tomselect,"init_classif_list"===t){let e=this.imports[t];if(e=Array.isArray(e)?e.join(","):e.replace("[","").replace("]","").replaceAll(" ",""),""!==e){n&&n.wrapper.classList.add("wait-for-results");const t=new FormData;t.append("idlist",e),fetch("/search/taxoresolve",(0,l.wv)({method:"POST",body:t})).then((t=>t.json())).then((t=>{if(n)Object.entries(t).forEach((([t,e])=>{let s={};t=o().sanitize(t),e=o().sanitize(e),s[n.settings.valueField]=t,s[n.settings.searchField]=(0,l.l1)(e),n.addOption(s),n.addItem(s[n.settings.valueField])}));else{let e="";Object.entries(t).forEach((([t,s])=>{t=o().sanitize(t),s=o().sanitize(s),e+='<option value ="'+t+'" selected>'+s+"</option>"})),i.innerHTML=e,e=""}t=null,n&&n.wrapper.classList.remove("wait-for-results")}))}}else if(n){let e={};e[n.settings.valueField]=this.imports[t].key,e[n.settings.searchField]=(0,l.l1)(this.imports[t].value),n.addOption(e),n.addItem(e[i.tomselect.settings.valueField]),n.refreshOptions()}else switch(i.type?i.type:i.tagName.toLowerCase(),i.type){case"radio":case"checkbox":i=this.form.querySelector('[name="'+t+'"][value="'+this.imports[t]+'"]'),i&&(i.checked=!0);break;case"select":let e;e=this.imports[t].key?'<option value="'+this.imports[t].key+'" selected >'+this.imports[t].value+"</option>":'<option value="'+this.imports[t]+'" selected >'+this.imports[t]+"</option>",i.insertAdjacentHTML("beforeend",e);break;default:i.value=this.imports[t]}s!==a.oL.settings&&i.focus(),r=!0,this.setImportedTag(i)}else"privileges"===t&&(r=this.importPrivileges(this.imports[t],!1))}))}!0===r&&1==i&&this.dismiss()}setImportedTag(t,e=".form-box"){let s=null===e?t:t.closest(e)?t.closest(e):t.closest("fieldset");if(!s)return;s.dataset.isimported=this.form.dataset.isimported,s.classList.add("imported");const i=e=>{s.removeAttribute("data-isimported"),s.classList.remove("imported"),t.removeEventListener("change keydown",i)};t.addEventListener("change keydown",i)}dismiss(t=!1){this.button&&this.showImport(!1);const e=this.dom.closest("details");e&&(e.open=!1,!0===t&&(e.querySelector(this.content_selector).innerHTML=""))}indexToCheck(){const t=this.tbl?this.tbl.grid:null;if(!t)return[0];let e=t.columns.findIndex((t=>t.what&&t.what===a.oL.taxo));if(-1===e)return[0];const s=t.columns[e].parts?t.columns[e].parts:null;return s?t.columns.filter(((t,e)=>{if(s.indexOf(t.name)>=0)return e})).map((t=>t.index)):void 0}showImport(t){if(this.button)if(!1===t)this.button.classList.add(a.iv.hide),this.replacebutton.classList.add(a.iv.hide),this.clearbutton.classList.add(a.iv.hide),this.importcontainer.classList.add(a.iv.hide),this.tabbutton.classList.add(a.iv.hide);else{this.button.classList.remove(a.iv.hide),this.replacebutton.classList.remove(a.iv.hide),this.clearbutton.classList.remove(a.iv.hide),this.importcontainer.classList.remove(a.iv.hide),this.button.disabled=this.clearbutton.disabled=!1;const t=this.importcontainer.querySelector("#"+this.importid);t&&(this.tabbutton.classList.remove(a.iv.hide),t.tomselect&&t.tomselect.control.offsetHeight<t.tomselect.control.scrollHeight?this.tabbutton.disabled=!1:this.tabbutton.disabled=!0)}}resizeZone(t){const e=this.importcontainer.closest(a.EY.component.import.zoneimport);if(!e)return;e.parentElement.classList.toggle(a.iv.showfull);const s=t.currentTarget.querySelector("i");s&&(s.classList.toggle("icon-arrow-pointing-out"),s.classList.toggle("icon-arrow-pointing-in"))}}}}]);