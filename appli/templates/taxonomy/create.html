{% import 'ht_macros.html' as ht %}
              <style>
                  #At2PopupWindow{{windex if windex else 20}} .At2PopupWindow {
                      width: 1000px
                             }
              </style>
<form id="formcreatetaxon" method="post" action="?"><div class="panel panel-default text-warning" style="padding: 5px; font-size:large">
      Once created, a category can never be deleted. <br>
      If you really want to create a new taxon, please carefully review the information below.<br>
    </div>
    <div><span>Create a WoRMS taxon
        <i class="fas fa-info-circle" data-content="{{_('Type a taxon name, the name will be searched into the WoRMS database.')}}"></i>
      </span>{{ ht.InputText('taxosearchname', searchname ,
                extrataginfo=("class=form-control maxlength=100  "
                )|safe) }} <button type="button" onclick="const searchurl='{{url_for('routetaxosearchworms')}}?q='+$('#taxosearchname').val();loadUrl(searchurl,'GET',null,null,{},'... requesting Worms API ...')" class="btn btn-blue"><i class="fa fa-search"></i> Search
        </button>  </button></div>
    <div><div id="resulttaxocentral"></div></div>
    <div>{%-if taxons-%}
    <p style="padding-bottom:8px">{{_("Click a taxon name in the list to add it to EcoTaxa's taxonomy.")}} <em>({{_("non-clickable entries are already in EcoTaxa's taxonomy and displayed here for information.")}})</em></p>
        <ul>{%- for taxon in taxons -%}
    <li>{%-if "id" in taxon -%}{{taxon["name"]}} (id:{{taxon["id"]}}) {%-else-%}<a onclick="createWoRMSTaxon({{taxon['aphia_id']}})">{{taxon["name"]}} </a>{%-endif-%}
    {%-for parent in taxon["lineage"].values()-%}&nbsp;&lt;&nbsp;{{parent["scientificname"]}}{%-endfor-%}  &nbsp;&lt;status: {{taxon["status"]}}&gt;</li>
    {%-endfor-%}</ul>{%-else-%}{{_('No result')}}{%-endif-%}
    <p><button  type="button" class="btn btn-info" onclick="loadUrl('{{url_for('route_add_taxon')}}')">{{_('Or create a non WoRMS category')}}</button></p>
</div>
   </form>
    <script>
        const windex={{windex if windex else 20}}
        const restaxocentral= $('#resulttaxocentral');
        const searchurl="{{url_for('routetaxosearch',name=searchname)}}";
        if (restaxocentral) {
        loadUrl("{{url_for('routetaxodosync')}}","POST",restaxocentral,function() {  //do not load existing taxons - add datediff to limit the list - loadUrl(searchurl,"GET",restaxocentral,displaytaxons);
        });
        }
        $('#taxosearchname').on('input', function(e) {
        var val =$(this).val();
        if (val.length) return;
        val=encodeURIComponent(val).replaceAll('%20','+');
        const searchurl="{{url_for('routetaxosearchworms',q=val)}}";
        loadUrl(searchurl,'GET',null,null,{},'... requesting Worms API ...');});
         function createWoRMSTaxon(aphia_id) {
            const formu = $("#formcreatetaxon");
            formu.attr("action","{{url_for('addtaxoworms')}}");
            const data= {aphia_id:aphia_id};
            $.post("{{url_for('addtaxoworms')}}",data).done(function(data) {
                const response = $.parseJSON(data);
                $('<h4>').attr('class','text-success').html(response.success).insertBefore(formu);
                formu.remove();
            }).fail(function(err) {
                if (err.status !==422) $('<h4>').attr('class','text-danger').html('error '+ err.status +' - ' +err.statusText).insertBefore(formu);
                else { const response = $.parseJSON(err.responseJSON.body);
                $('<h4>').attr('class','text-danger').html(response.error).insertBefore(formu);}
                });
        }

        function addtoselect2(id,name) {
        sel2=$("#taxolbanno");
        if (sel2) {
                if (sel2.find("option[value='" + id + "']").length) {
                    sel2.val(id).trigger('change');
                } else {
                    // Create a DOM Option and pre-select by default
                    const newOption = new Option(name, id, true, true);
                    // Append it to the select
                    sel2.append(newOption).trigger('change');
                }
                // Select event in the dropdown
                  AssignTaxoLbToSelection(id, name);
                  // Keep memory of current val & text, as they will be erased at next opening, just above.
                  sel2.data('saved_val', id);
                  sel2.data('saved_text',name);
                }
        At2PopupClose(windex);
        }

        function displaytaxons(data,element) {
            data=JSON.parse(data);
            if(data.length) $("<p>").append(document.createTextNode("{{_('Taxons in EcoTaxoServer')}}")).appendTo(element);
            const items = [];
            $.each( data, function( i,item ) {
            if (item.aphia_id!==null) aphiaid=" ("+item.aphia_id+")";
            else aphiaid='';
            items.push( "<li onclick=\"addtoselect2("+item.id+",'"+item.name+"')\">" + item.name.replace('+','&lt;') + aphiaid + "</li>" );
            });
            $( "<ul/>", {
            "class": "taxon-list",
            html: items.join( "" )
            }).appendTo( element );
        }

        function loadUrl(url,method='GET',element=null,callback=null,data={},wait="...") {
            if (element===null) element = $('#At2PopupWindow'+windex+' .At2PopupContent');
            $.ajax(url, {
            data: data,
            type: method,
            beforeSend: function() {
            if(element) element.html(wait);
            },
            error: function(err) {
                if (element) element.html('');
                if(element) element.append($('h4').addClass("text-danger").html('error '+ err.status +' - ' +err.statusText));
            },
            success: function(data) {
                if (element) element.html('');
                if(callback!==null) callback(data,element);
                else if(element) element.html(data);
            }
            });
        }
          $('#formcreatetaxon .fa-info-circle').popover({trigger: 'hover', container: "body", placement: "top"})
    </script>
