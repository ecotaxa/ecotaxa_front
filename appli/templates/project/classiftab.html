<div style="width: 230px;    margin-top: 5px; margin-bottom: 5px;">
  <div class="input-group">
    <select id="taxolbanno" name="taxolbanno" style="width: 185px" class='taxolb' autocomplete="off"> </select>
    <span class="input-group-btn">
        <button class="btn btn-default btn-sm" type="button"
                data-toggle="modal" data-target="#TaxoModal" data-mytargetid="taxolbanno"
                title="Search on Taxonomy Tree">
            <span id=OpenTaxoLB class="glyphicon glyphicon-th-list" aria-hidden="true"/></button>
        </span>
    <span class="input-group-btn">
        <button class="btn btn-default btn-sm" type="button"
                title="Ctrl+D shortcut can also be utilized to assign category name to one or more vignettes"
                onclick="AssignCurrentTaxoToSelection();">
            <span id=AssignTaxo class="glyphicon glyphicon-tags" aria-hidden="true"/></button>
        </span>

    {# <div style="line-height: 1.1;position: relative; top: -5px; height: 18px;cursor: pointer;">#}
    {#<span class="label label-info" style="padding: 0px 3px 0px 3px; ; margin-left: 2px;" title="Update Counter" onclick="RefreshClassifTab();">UC</span><br>#}
    {#        <span class="label label-info" style="padding: 0px 3px 0px 3px; ; margin-left: 2px;" title="Hide Empty Category" onclick="ToggleZeroCount();">HC</span></div>#}

  </div><!-- /input-group -->

</div>

<div id='divclassiftab' style="width: 255px;overflow-y:auto;">
  <table class="classiftab" width="98%">
    {% for v in res %}
      <tr>
        <td data-taxoid="{{ v['id'] }}" data-dispname="{{ v['display_name'] }}"
            class="{{ v['parentclasses'] }} {{ 'zerocount' if v['nbr']==0 }}">
          {% if v['haschild'] %}
            <small><span style="width: 1em;" class="glyphicon glyphicon-triangle-bottom categexpander"></span></small>
          {% endif %}
          <span class="{% if v['deprecated'] %}deprecated{% endif %} taxodrop {% if v['haschild'] %}haschild{% endif %}"
                style="margin-left: {{ (0 if v['haschild'] else 1)+ v['dist']*0.9 }}em">
    {{ v['htmldisplayname'] }}
</span>
          <span class="taxoparent">{{ v['taxoparent']|safe }}</span>

          <div class="counterarea">
            <span class="counter label label-success">{{ v['nbr_v'] }}</span>
            {% if v['nbr_p']>0 %}
              <span class="counternotv label label-info">{{ v['nbr_p'] }}</span>
            {% endif %}
            {% if v['nbr_d']>0 %}
              <span class="counternotv label label-warning">{{ v['nbr_d'] }}</span>
            {% endif %}
          </div>
        </td>
      </tr>
    {% endfor %}
  </table>

  <div style="margin-top: 3px;">
    <a href="javascript:RefreshClassifTab('Y');" class="btn btn-primary btn-xs" style="width: 45%;"
       title="It may slow the application. Please use the UC (update count) button instead">Recalc. counts <span
        class="glyphicon glyphicon-repeat"></span></a>
    <button type="button" class="btn btn-xs btn-primary" id="zeroshowhide" onclick="ToggleZeroCount()" data-show="0">
      Hide empty categories
    </button>

  </div>

</div>

<script>
    function SetTaxoFilter(taxofiltervalue, taxofilterlabel, withchild) {
        //debugger;
        var WithChild = 'N';
        if (withchild == true) {
            taxofilterlabel += " (with child)";
            WithChild = 'Y';
        }
        if (taxofiltervalue == false) {
            $("#taxofilter").val("");
            $("#taxofilterlabel").val("");
            if (taxofilterlabel == -1) LoadRightPane();
            return;
        }
        $("#taxofilter").val(taxofiltervalue);
        $("#taxofilterlabel").val(taxofilterlabel);
        $("#taxofilterchild").val(WithChild);


    }

    function CategExpanderClick(e) {
        e.stopPropagation();
        e.preventDefault();
        if ($(this).hasClass("glyphicon-triangle-bottom")) {
            $(this).removeClass("glyphicon-triangle-bottom").addClass("glyphicon-triangle-right");
            $('#divclassiftab .visib' + $(this).closest("td").data("taxoid")).hide();
        } else {
            $(this).removeClass("glyphicon-triangle-right").addClass("glyphicon-triangle-bottom");
            $('#divclassiftab .visib' + $(this).closest("td").data("taxoid")).show();

        }

    }

    {% if g.PrjAnnotate or g.PrjManager %}
        var last_deselected = null;
        {# Traitement de la Liste des objets TD à traiter. #}
        function ProcessList(LstTd, droptaxoid, droptaxoname) {
            var TrSet = new Set(), i;
            PendingChangesTaxoName[droptaxoid] = droptaxoname;
            var taxopart = droptaxoname.split('<');
            var HtmlTaxo = "<span class='cat_name'>" + taxopart[0] + "</span>";
            if (taxopart.length > 1) {
                HtmlTaxo += "<span class='cat_ancestor'>";
                for (i = 1; i < taxopart.length; i++)
                    HtmlTaxo += " &lt;&nbsp;" + taxopart[i];
                HtmlTaxo += "</span>";
            }

            // Traitement des cellules
            for (i = 0; i < LstTd.length; i++) {
                var td = LstTd[i];
                last_deselected = td
                td.removeClass("ui-selected");
                td.addClass("ToBeSaved");
                var id = td.find('img').attr('id');
                td.find('.taxo').html(HtmlTaxo);
                td.find('.subimg').css("height", '').css("width", '').css("left", '').css("top", '').css("right", '').css("bottom", '');
                td.find('.subimg').attr('class', 'subimg status-validated');
                TrSet.add(td.closest('tr').attr('id'));
                PendingChanges[id.substr(1)] = droptaxoid;
                //td.css('background-color', '#80FF80')
                //console.log(o, id ,droptaxoid,droptaxoname);
            }
            UpdateSelectedCounter();
            NbrChanged = LstTd.length;
            // Ces resizes ralentissent mais permettent de recaller les zoom tracker suite au changement de taille des taille de taxo
            // sur table 1000 image à 10% ligne 42 ca Freeze 4s
            // sur table 200 images à 10% ca Freeze 1s
            // Sur 50&100 ca ne se voit pas
            //for ( trid of TrSet) Marche pas sous IE
            TRArray = Array.from(TrSet);
            for (i = 0; i < TRArray.length; i++) {
                var trid = TRArray[i];
                $('#' + trid).find('td img').resize();
                //console.log("resize #"+trid);
            }
            var calctotaux = {};
            for (var k in PendingChanges) {
                v = 0;
                if (PendingChanges[k] in calctotaux) v = calctotaux[PendingChanges[k]];
                calctotaux[PendingChanges[k]] = v + 1;
            }
            var Msg = "Pending Changes : ";
            PendingChangesTaxoName[-1] = "Unchanged";
            for (k in calctotaux)
                Msg = Msg + calctotaux[k] + " " + PendingChangesTaxoName[k] + ", ";
            $('.PendingChangesClass').text(Msg);
            document.getElementById("BtnSave").disabled = false;
            $("#TxtBtnValidateAll").text("Save changes, validate rest and move to next page");
        }
        function SavePendingChanges(NextPage, forcedqual) {
            {#  console.log("prev",PendingChanges); #}
            req = {changes: PendingChanges, qual: ((forcedqual === undefined) ? 'V' : forcedqual)}
            $(".PendingChangesClass").html('<span class="label label-info">Server update in progress...</span>');
            $("#PendingChanges2").html($("#PendingChanges").html());
            $("#PendingChanges").load("/prj/ManualClassif/" + $("#projid").val(), req, function () {
                $("#PendingChanges2").html($("#PendingChanges").html());
                if ($("#PendingChanges").html().indexOf("Successful") > 0) {
                    PendingChanges = {}; // After successful update no pending changes.
                    if (NextPage == 1)
                        $("#pageoffset").val(parseInt($("#pageoffset").val()) + 1);
                    else {# Si on ne change pas de page on garde l'offset de la scrollbar vertical à sa position courante #}
                    if (NextPage === 0) {
                    } {# Distinction entre save et save go to next page qui en fait reste sur la page. #}
                    else
                        RightPanelScrollPosAfterLoad = $(document).scrollTop();
                    LoadRightPane();
                    RefreshClassifTab();
                }
            });
        }
        function ValidateAll(NextPage) {
            {# On valide tout ce qui est predicted ou validated et qui n'est pas déjà en attente de save #}
            $(".status-validated,.status-predicted").parents('td').find('img.lazy').each(function (e, o) {
                //console.log($(o).attr("id").substr(1));
                if (PendingChanges[$(o).attr("id").substr(1)] === undefined)
                    PendingChanges[$(o).attr("id").substr(1)] = -1;
                {# Set unchanged but validate #}
            });
            SavePendingChanges(NextPage);
        }
        function ValidateSelection(qual) {
            {# On valide tout ce qui est selectionné et qui n'est pas déjà en attente de save #}
            $(".ui-selected").find('img.lazy').each(function (e, o) {
                if (PendingChanges[$(o).attr("id").substr(1)] === undefined)
                    PendingChanges[$(o).attr("id").substr(1)] = -1;
                {# Set unchanged but validate #}
            });
            SavePendingChanges(0, qual);
        }
        // Magic 125 is height of #divheadinfo + height of #topbar + a margin somewhere...
        var y_offset_before_objects = 125;
        function CheckIfInView(elem) {
            const win_scroll_top = $(window).scrollTop();
            const win_height = $(window).innerHeight();
            const elem_top = elem.offset().top;
            const elem_bottom = elem.offset().top + elem.height() + 5;
            let warp = null;
            // Both sides must be visible
            if (elem_bottom > win_scroll_top + win_height) {
                warp = elem_bottom - win_height;
            } else if (elem_top < win_scroll_top + y_offset_before_objects) {
                warp = elem_top - y_offset_before_objects;
            } else {
                return;
            }
            $('html,body').animate({scrollTop: warp}, 100);
        }

        function NearestY(from, where) {
            // Get nearest TD from 'from' in elem tree 'where'
            let from_pos = from.offset();
            var from_width = from.width();
            var from_height = from.height()
            let ret = $.nearest({x: from_pos.left + from_width / 2, y: from_pos.top + from_height / 2},
                'td', {container: where, sort: true});
            // Sometimes it's deuce, the middle of current row falls right in the middle of 2 others
            if (ret.length > 1) ret = ret.slice(0, 1);
            return ret;
        }

        function KeyboardMoveSelection(way) {
            // Get current selected cell
            let col_right = $("#column-right");
            let present_sel = col_right.find(".ui-selected").first();
            if (!present_sel[0]) {
                // If no selection, fallback to last de_deselected, e.g. when 'CTRL-D' was used
                present_sel = last_deselected;
            }
            let next_sel;
            if (present_sel) {
                let parent;
                switch (way) {
                    case 'UP':
                        parent = present_sel.parent().parent().parent();
                        const line_above = parent.prev();
                        if (!line_above.hasClass('imgtab')) return; // Not a line
                        next_sel = NearestY(present_sel, line_above);
                        break;
                    case 'DOWN':
                        parent = present_sel.parent().parent().parent();
                        const line_below = parent.next();
                        if (!line_below.hasClass('imgtab')) return; // Not a line
                        next_sel = NearestY(present_sel, line_below);
                        break;
                    case 'LEFT':
                        next_sel = present_sel.prev();
                        if (!next_sel[0] || next_sel.hasClass("linestart")) return;  // Previous is beginning of line
                        break;
                    case 'RIGHT':
                        next_sel = present_sel.next();
                        if (!next_sel[0]) return;  // No element on the right, i.e. end of line
                        break;
                }
                present_sel.removeClass('ui-selected');
            } else {
                // Upper-left object of the visible section
                next_sel = $.nearest({x: 0, y: $(window).scrollTop() + y_offset_before_objects},
                    '.ui-draggable', {container: col_right, sort: true});
                // solve deuce and skip column header
                next_sel = next_sel.slice(0, 1).next();
            }
            next_sel.addClass('ui-selected');
            setTimeout(CheckIfInView, 5, next_sel);
        }
    {% endif %}
    $(function () {
        $(".classiftab td"
            {% if g.PrjAnnotate or g.PrjManager %}
                ).droppable({
                tolerance: "pointer",
                {#      classes:{"ui-droppable-hover":"taxodrop_hover"}, Utile pour JQuery UI >=1.12 car hoverClass deprecated#}
                hoverClass: "taxodrop_hover",
                drop: function (event, ui) {
                    var droptaxoid = $(this).data('taxoid');
                    var droptaxoname = $(this).data('dispname');
                    // Not nice, but the whole TD is droppable so we cannot prevent the drop
                    // DEPENDS ON LABEL, BAD AND FRAGILE
                    if (droptaxoname.indexOf('(D') !== -1) {
                        alert("Cannot assign to a deprecated category");
                        return;
                    }
                    var jtaxolbanno = $('#taxolbanno');
                    jtaxolbanno.append($('<option>', {value: droptaxoid, text: droptaxoname}));
                    var sel = [];
                    sel.push(droptaxoid);
                    jtaxolbanno.val(sel);
                    jtaxolbanno.change();
                    var NbrChanged = 0;
                    var LstTd = [];
                    ui.draggable.each(function (e, o) {
                        NbrChanged++;
                        if ($(o).hasClass("zoomtracker")) {
                            LstTd.push($($(o).data("specs").origImg.closest('td')));
                            {#              } else if( $(o).hasClass( "taxo" )) {  // Sinon c'est le taxo du div subimg#}
                        } else if ($(o).is("td")) {  // Sinon c'est le taxo du div subimg
                            LstTd.push($(o));
                        } else if ($(o).hasClass("lazy")) {  // Sinon c'est l'image
                            LstTd.push($(o).closest('td'));
                        }
                        //Si c'est un item selected, on le supprime car va être ajouté par
                        if (LstTd.length > 0)
                            if (LstTd[0].hasClass("ui-selected"))
                                LstTd.pop();
                        // On ajoute tout ceux qui sont selectionnés.
                        $(".ui-selected").each(function () {
                            LstTd.push($(this));
                            NbrChanged++;
                        });
                    });
                    ProcessList(LstTd, droptaxoid, droptaxoname);
                    // Highlight only the last
                    $("#TabA .ui-state-highlight").removeClass("ui-state-highlight");
                    var n = parseInt($(this).find(".counter").text()) || 0;
                    $(this).addClass("ui-state-highlight").find(".counter").html(n + NbrChanged);
                }
            }
            {% endif %}
        ).click(function () {
            $(".ui-state-highlight").removeClass("ui-state-highlight");
            if ($(this).hasClass('activeTaxo'))
                SetTaxoFilter(false, -1);
            else {
                SetTaxoFilter($(this).data('taxoid'), $(this).find('.taxodrop').text());
                LoadRightPane();
            }
        });

        $("#divclassiftab").outerHeight($("#column-left").innerHeight() - $("#divclassiftab").position().top);
        $("#divclassiftab .categexpander").click(CategExpanderClick).hover(function (e) {
            if ((DragInProgress) && ($(this).hasClass("glyphicon-triangle-right"))) {
                {# Quand on passe sur un triange fermé sur un Drag&Drop on simule un clic sur le triangle pour l'ouvrir #}
                $(this).click();
            }
        });
    });
    {# Ready #}

    {% if g.PrjAnnotate or g.PrjManager %}
        function AssignCurrentTaxoToSelection() {
            // Assign current val, wherever it is
            const sel2 = $('#taxolbanno');
            let taxoid = sel2.val();
            let taxoname;
            if (taxoid) {
                taxoname = $('#taxolbanno  option:selected').text();
            } else {
                taxoid = sel2.data('saved_val');
                taxoname = sel2.data('saved_text');
            }
            if (taxoid)
                AssignTaxoLbToSelection(taxoid, taxoname);
        }
        function AssignTaxoLbToSelection(taxoid, taxoname) {
            $(".ui-state-highlight").removeClass("ui-state-highlight");
            $("td[data-taxoid='" + taxoid + "']").addClass("ui-state-highlight");
            var LstTd = [];
            $(".ui-selected").each(function () {
                LstTd.push($(this));
            });
            ProcessList(LstTd, taxoid, taxoname);
        }

        $(document).ready(function () {
            EnableSelect2Taxolb('#taxolbanno');

            if ((typeof (Restoretaxolbid) !== 'undefined') && (typeof (Restoretaxolbid) !== '')) {
                // Add the selected option during restore
                var NewOption = $('<option></option').val(Restoretaxolbid).text(Restoretaxolbtxt);
                NewOption.appendTo('#taxolbanno');
                Restoretaxolbid = undefined;
            }

            {#    Restore le surlignage jaune dans l'arbre #}
            if (typeof (RestoreHighLigthID) !== 'undefined') {
                $('td[data-taxoid=' + RestoreHighLigthID + ']').addClass('ui-state-highlight');
                RestoreHighLigthID = undefined;
            }
            {#    Restore le surlignage Gris dans l'arbre/activeTaxo pour filtrage #}
            if (typeof (RestoreActiveTaxoID) !== 'undefined') {
                $('td[data-taxoid=' + RestoreActiveTaxoID + ']').addClass('activeTaxo');
                RestoreActiveTaxoID = undefined;
            }

            {#    Le fait de choisir un item fait l'assignation/CTRL+A #}
            const sel2 = $('#taxolbanno');
            sel2.on("select2:opening", function () {
                const selection = sel2.data('saved_text');
                if (!selection) return;
                // Clear the value. We clear because otherwise:
                //    - Re-picking the same value would _not_ trigger the event select2:select below.
                //    - Current value might appear in the middle of the list, if similar text is entered.
                sel2.val(null).trigger("change");
                // The "selection rendered" element (where selection is seen) has been emptied, fill it back.
                const rdr = $('.select2-selection__rendered');
                rdr.text(" " + selection);
                rdr.title = selection;
            });
            sel2.on("select2:select", function (e) {
                // Chosen line
                const choice = e.params.data;
                // Select event in the dropdown
                AssignTaxoLbToSelection(choice.id, choice.text);
                // Keep memory of current val & text, as they will be erased at next opening, just below.
                sel2.data('saved_val', choice.id);
                sel2.data('saved_text', choice.text);
            });
            sel2.on("select2:closing", function () {
                // Remove all options so they don't appear (with default focus!) next time the box opens.
                const opts = $('.select2-results__options li');
                opts.detach();
            });


            {# Gestion de la scrollbar de la liste taxo quand la souris est en bas ou en haut de la zone#}
            $(window).mousemove(function (e) {
                var divclassiftab = $('#divclassiftab');
                var pagebottom = $(this).scrollTop() + $(this).innerHeight() - 50;
                if (e.pageX < 235) {
                    if (e.pageY > pagebottom)
                        divclassiftab.scrollTop(divclassiftab.scrollTop() + 10);
                    if ((e.pageY > divclassiftab.offset().top) && (e.pageY < divclassiftab.offset().top + 25) && (e.pageX > 180))
                        divclassiftab.scrollTop(divclassiftab.scrollTop() - 10);
                }
            });

        }); // Ready

    {% endif %} {# if g.PrjAnnotate or g.PrjManage #}

    // a dict with key=taxon id, value=a list containing [t.id, t.name, t.parent_id]
    var taxotree ={{ taxotree|safe }};

    $(document).ready(function () {
        {#  Initialisation Context Menu  #}
        $.contextMenu({
            // define which elements trigger this menu
            selector: ".classiftab td",
            appendTo: "#empty_fixed",
            position: function (opt, x, y) {
                win_scroll = $(window).scrollTop();
                win_height = $(window).height();
                menu_height = opt.$menu[0].clientHeight;
                new_y = y - win_scroll;
                if (new_y + menu_height > win_height) {
                    new_y -= (new_y + menu_height) - win_height;
                }
                // console.log(opt, x, y, win_scroll, menu_height);
                opt.$menu.css({left: x, top: new_y});
            },
            // define the elements of the menu
            build: function ($trigger, e) {
                res = {
                    callback: function (key, options) {
                        var prefix = key.substr(0, 1);
                        if (prefix === 'X') return;
                        {# Menu informatifs #}
                        var taxoid = parseInt(key.substr(1));
                        var taxoname = taxotree[taxoid][1];
                        if (prefix === 'f') {
                            {#          console.log("filter by ",taxoid,taxoname);#}
                            SetTaxoFilter(taxoid, taxoname, true);
                            LoadRightPane();
                        }
                        if (prefix === 'o') {
                            // right-click menu, "-- CLASSIFY TO --"
                            $('#taxolbanno').append($('<option>', {value: taxoid, text: taxoname}));
                            var sel = [];
                            sel.push(taxoid);
                            $('#taxolbanno').val(sel).change();
                            AssignTaxoLbToSelection(taxoid, taxoname);
                        }
                    },
                    items: {}
                };
                var Arr = [];
                var taxoid = $(e.currentTarget).data('taxoid');
                var taxoname = taxotree[taxoid][1];
                Arr.unshift({key: "f" + taxoid, name: taxoname});
                {#     On insere d'abord en bas le filtrage #}
                for (var i = 0; i < 50; i++) {
                    taxoid = taxotree[taxoid][2]; // Go to parent
                    if (taxoid == null) break;
                    taxoname = taxotree[taxoid][1];
                    Arr.unshift({key: "f" + taxoid, name: taxoname})
                }
                Arr.unshift({key: "X2", name: "-- FILTER WITH CHILD -- "});
                Arr.unshift({key: "X1", name: "_____________________"});

                taxoid = $(e.currentTarget).data('taxoid');
                taxoname = $(e.currentTarget).find(".taxodrop").text();
                Arr.unshift({key: "o" + taxoid, name: taxoname})
                for (i = 0; i < 50; i++) {
                    taxoid = taxotree[taxoid][2]; // Go to parent
                    if (taxoid == null) break;
                    taxoname = taxotree[taxoid][1];
                    Arr.unshift({key: "o" + taxoid, name: taxoname})
                }
                Arr.unshift({key: "X3", name: "-- CLASSIFY TO -- "});

                for (index = 0; index < Arr.length; index++)
                    res["items"][Arr[index]["key"]] = {name: Arr[index]["name"]}
                return res;
            }
        });
        {#  Initialisation Context Menu  #}
    });
    {#  Ready  #}

    function ToggleZeroCount() {
        if ($('#zeroshowhide').data("show") == "0") {
            $(".zerocount").hide();
            $('#zeroshowhide').data("show", "1").text("Show empty categories");
        } else {
            $('#zeroshowhide').data("show", "0").text("Hide empty categories");
            $(".zerocount").show();
        }
    }


</script>
