{% extends "layout.html" %}
{% import "js_macros.html" as js %}
{% import "ht_macros.html" as ht %}

{% block headcenter %}
  <!--suppress HtmlFormInputWithoutLabel, HtmlUnknownTarget -->
  <script src="/static/jquerycontextmenu/jquery.ui.position.min.js" type="text/javascript"></script>
  <script src="/static/jquerycontextmenu/jquery.contextMenu.min.js" type="text/javascript"></script>
  <link href="/static/jquerycontextmenu/jquery.contextMenu.css" rel="stylesheet" type="text/css"/>
  <script src="/static/jquery.datetimepicker.full.min.js" type="text/javascript"></script>
  <link href="/static/jquery.datetimepicker.min.css" rel="stylesheet" type="text/css"/>
  <script src="/static/jquery.nearest.min.js" type="text/javascript"></script>

  {% if g.headmenu %}
    <table width="100%">
      <tr>
        <td style="white-space: nowrap;width: 170px;">
          <div class="btn-group" style="margin-right: 5px">
            <button type="button" class="btn btn-default" data-toggle="dropdown"
                    style="padding: 6px;">Project
            </button>
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                    aria-expanded="false" style="padding: 6px;">
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-left" role="menu">
              {% for m in g.headmenu %}
                {% if m[1]=="SEP" %}
                  <li class="divider"></li>
                {% else %}
                  <li><a href="{{ m[0] }}">{{ m[1] }}</a></li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>
          <div class="btn-group" style="margin-right: 5px">
            <button type="button" class="btn btn-default" data-toggle="dropdown"
                    style="padding: 6px;">Filtered
            </button>
            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                    aria-expanded="false" style="padding: 6px;">
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-left" role="menu">
              {% for m in g.headmenuF %}
                {% if m[1]=="SEP" %}
                  <li class="divider"></li>
                {% else %}
                  <li><a href="{{ m[0] }}">{{ m[1] }}</a></li>
                {% endif %}
              {% endfor %}
            </ul>
          </div>

        </td>
        <td>
          <div id="titlediv">
            <div id=titledivtitle
                 style="font-size: 18px;max-width: 300px;white-space: nowrap; text-overflow: ellipsis; overflow: hidden; vertical-align: bottom;display: inline-block;">
              {{ g.ProjectTitle }}</div>
            <div style="font-size: 12px;vertical-align: bottom;display: inline-block;"> (<span id=objcount></span>)
            </div>
          </div>
          <div id="projectProgress" class="progress"
               style="    height: 6px;    margin-bottom: 0;    margin-top: 1px;">
            <div id="progress-bar-validated" class="progress-bar" style="width: 0;background-color: #5CB85C;"></div>
            <div id="progress-bar-predicted" class="progress-bar" style="width: 0;background-color: #5bc0de;"></div>
            <div id="progress-bar-dubious" class="progress-bar" style="width: 0;background-color: #F0AD4E;"></div>
          </div>
          <div id="headersubtitle" style="color:#FF6600;overflow-y: auto;height: 42px;"></div>

        </td>
      </tr>
    </table>
  {% else %}
    <table width="100%">
      <tr>
        <td width="14%"></td>
        <td>
          <div id="titlediv">
            <div id=titledivtitle
                 style="font-size: 18px;max-width: 300px;white-space: nowrap; text-overflow: ellipsis; overflow: hidden; vertical-align: bottom;display: inline-block;">
              {{ g.ProjectTitle }}
            </div>
          </div>
        </td>
      </tr>
    </table>
  {% endif %} {# If headmenu #}

{% endblock %}

{% block body %}
  <div id="topbar">
    <input type="hidden" id="projid" value="{{ g.Projid }}">
    <input type="hidden" id="taxofilter" value="" autocomplete="off">
    <input type="hidden" id="taxofilterlabel" value="" autocomplete="off">
    <input type="hidden" id="taxofilterchild" value="" autocomplete="off">
    <input type="hidden" id="pageoffset" value="{{ data.pageoffset }}" autocomplete="off">
    <table>
      <tr>
        <td>
          <button type="button" class="btn btn-xs btn-primary" onclick="LoadRightPane();" style="width: 260px;">
            <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> Update view &amp; apply
            filter
          </button>
          {{ top|safe }}
        </td>
        <td>
          &nbsp;
          <span class="btn btn-xs SpanSelectAll rm5"
                title="Ctrl+A shortcut to select all. Hold shift key to unselect all">Select all</span>

          <span class="glyphicon glyphicon-sort rm5"></span>
        </td>
        <td>
          <select name="sortby" id="sortby" style="width: 100px" class="form-control rm5">

            {% for key, value in data.sortlist.items() %}
              <option value="{{ key|e }}" {{ 'selected' if key==data.sortby }}> {{ value|e }}</option>
            {% endfor %}
          </select>
        </td>
        <td>
          <button type="button" class="btn btn-default btn-xs rm5" onclick="SortToggle();"
                  title="Current Sort : Ascending">
                    <span id="sortorder" class="glyphicon glyphicon-sort-by-attributes"
                          aria-hidden="true"></span></button>

          <div class="btn-group rm5">
            <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
              Display &nbsp;<span class="caret"></span>
              <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul id="dispfieldlist" class="dropdown-menu">
              {% for key, value in data.fieldlist.items() %}
                <li id="dispfield_{{ key }}"><a href="javascript:ToggleDispField('dispfield_{{ key }}');">
                  {{ value|e }} <span
                    class="glyphicon {{ 'glyphicon-ok' if key in data.dispfield }}"></span></a></li>
              {% endfor %}
            </ul>
          </div>
        </td> {% if not g.PublicViewMode %}
        <td>
          <label for="statusfilter" data-container="body" data-toggle="tooltip" data-placement="bottom" data-html="true" class="rm5"
                 style="margin-bottom: 0;" title="
        <p style='text-align: left'>
        <b>All</b>: all images</br>
        <b>Unvalidated</b>: all images to validate (unclassified, predicted only and dubious)</br>
        <b>Predicted</b>: predicted by automatic classification</br>
        <b>Unclassified</b>: unpredicted and unvalidated</br>
        <b>Validated</b>: images with a human-made identification</br>
        <b>Valid. by others</b>: identification done by other users</br>
        <b>Valid. by me</b>: identification done by me</br>
        <b>Dubious</b>: dubious identification</div>">
            Status </label></td>
        <td style="padding-right: 5px;" class="rm5">
          <select name="statusfilter" id="statusfilter" class="form-control" data-original-title="" title=""
                  style="width: 100px">
            {% for key, value in data.statuslist.items() %}
              <option value="{{ key|e }}" {{ 'selected' if key==data.statusfilter }}> {{ value|e }}</option>
            {% endfor %}
          </select></td>
      {% else %}
        <td>
          <input type="hidden" name="statusfilter" id="statusfilter" value="">
          Status : Validated Only&nbsp;
        </td>
      {% endif %}
        <td style="padding-right: 5px;">
          <label for="ipp" style="margin-bottom: 0;"><span class="glyphicon glyphicon-th"></span></label>
        </td>
        <td style="padding-right: 5px;">
          {{ ht.selectinputtuple("ipp",[('0','Fit'),('1','1'),('5','5'),('10','10'),('20','20'),
          ('50','50'),('100','100'),('200','200'),('500','500'),('1000','1000')],data.ipp) }}
        </td>
        <td style="padding-right: 5px;"><label for="zoom" style="margin-bottom: 0;"><span
            class="glyphicon glyphicon-zoom-in"></span>%</label>
        </td>
        <td style="padding-right: 5px;">
          {{ ht.selectinput_form_control("zoom",['10','20','30','40','50','60','70','80','90','100','150','200'],data.zoom) }}</td>
        <td>
        </td>
        <td>
          <label for="magenabled" style="margin-bottom: 0;">
            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
          </label>
          {{ ht.checkboxinput("magenabled","1",data.magenabled,"style='margin:0px;'") }}
        </td>
        <td>
          <label for="popupenabled" style="margin-bottom: 0;padding-left: 8px;">
            <span class="glyphicon glyphicon-comment" aria-hidden="true"></span>
          </label>
          {{ ht.checkboxinput("popupenabled","1",data.popupenabled,"style='margin:0px;'") }}
        </td>
        <td>&nbsp;
          <button type=button class="btn btn-primary btn-xs" onclick="LoadRightPane();">
            <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
          </button>
          <span id='PendingChanges2' class='text-danger'></span>
        </td>
        <td><span id="nbrselected" style="margin-left: 10px;"></span>&nbsp;
        </td>
      </tr>
    </table>
  </div>
  {% include "common/taxopopup.html" %}
  {% include "taxo_modal_div.html" %}
  {% include "taxo_modal_div_js.html" %}

  <div id="bodycontainer">
    <div id="column-left" class="panelzzz " style="position: fixed;	top: 120px;	bottom: 0;	width: 260px;
	                overflow-y: hidden; overflow-x: hidden;margin-bottom: 0;">
      <div class="bodyleft" style="margin-left: 2px; width: 257px;">
        <div id="myTabs">
          <!-- Nav tabs -->
          <ul class="nav nav-tabs nav-justified" role="tablist">
            <li role="presentation" class="active">
              <a href="#TabA" aria-controls="home" role="tab" data-toggle="tab">Taxonomy filter
                <span title="Taxo filter help" class="glyphicon glyphicon-info-sign" style="color: black"
                      onclick="DispClassificationHelp()"></span>
              </a>

            </li>
            <li role="presentation">
              <a href="#TabB" aria-controls="profile" role="tab" data-toggle="tab">Other filters</a>
            </li>
            <li role="presentation">
              <a href="#TabC" aria-controls="profile" role="tab" data-toggle="tab">SS filters
                <span title="Taxo filter help" class="glyphicon glyphicon-info-sign" style="color: black"
                      onclick="DispUnsupervisedSearchHelp()"></span>
              </a>
            </li>
          </ul>
          <div class="tab-content">
            <!-- Tab panes -->
            {# Classification #}
            <div role="tabpanel" class="tab-pane active" id="TabA">
              <!--suppress CheckEmptyScriptTag -->
              <div style="width: 230px; margin-top: 5px; margin-bottom: 5px;">
                <div class="input-group">
                  <!--suppress HtmlFormInputWithoutLabel -->
                  <select id="taxolbanno" name="taxolbanno" style="width: 185px" class='taxolb'
                          autocomplete="off"> </select>
                  <span class="input-group-btn">
                  <button class="btn btn-default btn-sm" type="button"
                          data-toggle="modal" data-target="#TaxoModal" data-mytargetid="taxolbanno"
                          title="Search on Taxonomy Tree">
                      <span id=OpenTaxoLB class="glyphicon glyphicon-th-list" aria-hidden="true"></span></button>
                  </span>
                  <span class="input-group-btn">
                  <button class="btn btn-default btn-sm" type="button"
                          title="Ctrl+D shortcut can also be utilized to assign category name to one or more vignettes"
                          onclick="AssignCurrentTaxoToSelection();">
                      <span id=AssignTaxo class="glyphicon glyphicon-tags" aria-hidden="true"></span></button>
                  </span>
                </div><!-- /input-group -->
              </div>
              <div id='divclassiftab' style="width: 255px;overflow-y:auto;">
                <div id="categtree">
                  <!-- content from XHR call, same as refresh -->
                  Loading...
                </div>
                <div style="margin-top: 3px;">
                  <a href="javascript:RefreshClassifTab();" class="btn btn-primary btn-xs" style="width: 45%;"
                     title="It may slow the application.">Recalc. counts <span
                      class="glyphicon glyphicon-repeat"></span></a>
                  <button type="button" class="btn btn-xs btn-primary" id="zeroshowhide" onclick="ToggleZeroCount()"
                          data-show="0">
                    Hide empty categories
                  </button>
                </div>
              </div>
            </div>
            {# Filters #}
            <div role="tabpanel" class="tab-pane" id="TabB" style="overflow-y: auto;overflow-x: hidden;">
              <div id="TabBInner" style="width: 240px;">
                <button class="btn btn-info" style="width: 49%" id=SharePageBtn
                        title="Email a link to this page, including the current filters. Press CTRL to open it on another tab (usefull if you use GMail)"><span
                    class="glyphicon glyphicon-link"></span> Share page
                </button>
                <button onclick='ClearAllFilterCriteria();LoadRightPane();return false;' class="btn btn-info"
                        style="width: 49%" title="Remove all selection criteria"><span
                    class="glyphicon glyphicon-remove"></span> Clear all filters
                </button>
                <br>
                {{ leftb|safe }}
                <div class="row">
                  <div class="col-sm-12">
                    <button type="button" class="btn btn-xs btn-primary  btn-block"
                            onclick="LoadRightPane();">
                      <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> Update view
                      &amp; apply filter
                    </button>
                    <button class="btn btn-xs btn-info btn-block" onclick="LoadRightPane(false,true);"
                            title="Save current settings for the filters, in this project">Save
                      filters
                    </button>
                    <a href='?' type="button" class="btn btn-xs btn-info btn-block"
                       title="Load saved filter criteria and reload the page">Apply saved filters and
                      update view</a>
                  </div>
                </div>
              </div>
            </div>
            {# SimSearch and associated Filters #}
            <div role="tabpanel" class="tab-pane" id="TabC">
              <div id="TabCInner" style="width: 240px;">
                {{ leftc|safe }}
                <div id='divssclassiftab' style="width: 255px;overflow-y:auto;">
                <div id="listunsupervisedsearch"> <!-- categtree -->
                  <!-- content from XHR call, same as refresh -->
                  Start searching by clicking on the loop on photos.
                </div>
                <div style="margin-top: 3px;">
                  <!-- copied from RefreshClassifTab -->
                  <a href="javascript:DeleteUnsupervisedSearch();" class="btn btn-primary btn-xs" style="width: 45%;"
                     >Del Unsupervised Search<span
                      class="glyphicon glyphicon-repeat"></span></a>
                </div>
              </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {#          <div id="column-right" style="position: absolute;top: 150px;left: 270px;bottom: 0px;right: 1px;overflow: auto;"> #}
    <style>
        .lazy {
            margin: 15px 5px 0 5px;
            cursor: -webkit-grab;
            cursor: grab;
        }

        .ddet {
            text-align: left;
            font-size: 10px;
            margin-top: -3px;
            margin-bottom: -1px;
            text-decoration: underline;
            color: #00c;
        }
        .ddsim {
            text-align: left;
            font-size: 10px;
            margin-top: -3px;
            margin-bottom: -1px;
            text-decoration: underline;
            color: #00c;
        }

        .ddets .ddsims {
            cursor: pointer;
        }


        .categexpander {
            cursor: pointer;
        }

        .taxo {
            cursor: -webkit-grab;
            cursor: grab;
        }

        #dispfieldlist li a {
            padding-top: 0;
        }

        .ui-selected {
            background-color: #E9D6D7;
        }

        #column-right {
            margin-left: 260px;
        }

        #divheadinfo {
            position: fixed;
            top: 0;
            left: 1px;
            width: 100%;
            height: 80px;
            z-index: 12;
            background-color: #fff;
            min-width: 1024px;
        }

        #topbar {
            position: fixed;
            top: 80px;
            left: 1px;
            width: 100%;
            height: 40px;
            z-index: 10;
            background-color: #fff;
        }

        body {
            margin-top: 125px;
        }

        {# Permet de fixer la largeur de la dropdown Taxo Annotation #}

        .width240 {
            width: 240px !important;
        }

        {# Permet de fixer la largeur de la dropdown Sample #}

        .width400 {
            width: 400px !important;
        }

        {# Permet de reduire la taille et l'espace du texte du dropdown Taxo Annotation #}
        #select2-taxolbanno-results li {
            font-size: 12px;
            padding: 3px;
        }

        .popover {
            max-width: 500px;
        }

        #headersubtitle .btn-gris {
            padding-top: 0;
            padding-bottom: 0;
            border: 0;
        }

        #headersubtitle .btn-gris div:nth-child(1) {
            max-width: 500px;
            text-overflow: ellipsis;
            overflow: hidden;
            display: inline-block;
            vertical-align: bottom;
        }
    </style>
    <div id="column-right">
      RIGHT
    </div>
  </div> {# Container #}

  <div id="PopupDetails" class="modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        ...
      </div>
    </div>
  </div>

  <script>
      var PendingChanges = {}; // key=object id, value=taxo id, 'V' is implied
      var PendingChangesTaxoName = {};  // key=taxo id, value=taxo name
      var PrevTxtFilter = "INITIAL";
      var RightPanelScrollPosAfterLoad = 0;
      DragInProgress = false;
      drag_start_time = null;

      function InGreyButton(s, eraser) {
          // small reminder of a filter, clicking on it erases it with given function
          return " <button type=button class='btn btn-gris btn-xs' onclick='" + eraser + ";LoadRightPane();'><div>"
              + s + "</div> <span class='glyphicon glyphicon-remove'></span></button>";
      }

      $('#SharePageBtn').click(function (e) {
          if (e.ctrlKey)
              LoadRightPane('mailN');
          else
              LoadRightPane('mail');
      });

      function LoadRightPane(NoAjax, SaveInProfile, seed_object_id) {
          document.activeElement.blur();
          if (Object.keys(PendingChanges).length > 0)
              if (confirm("Some changes are pending, if you continue they will be discarded !\n\nWould you still like to continue ?") == false)
                  return;

          var TxtFilter = "", jqtaxofilter = $("#taxofilter"), jqtaxofilterlbl = $("#taxofilterlabel"),
              jqcolumnright = $("#column-right");
          var req = {taxo: jqtaxofilter.val(), resultwidth: jqcolumnright.width(), windowheight: $(window).height()};
          if (jqtaxofilterlbl.val() != "")
              TxtFilter += InGreyButton("Taxo=" + jqtaxofilterlbl.val(), "SetTaxoFilter(false)");
          $(".activeTaxo").removeClass("activeTaxo");
          if (jqtaxofilter.val() != "")
              $("#TabA").find("[data-taxoid=" + jqtaxofilter.val() + "]").addClass("activeTaxo");

          req['taxochild'] = $("#taxofilterchild").val();
          req['ipp'] = $("#ipp").val();
          req['zoom'] = $("#zoom").val();
          req['sortby'] = $("#sortby").val();
          req['magenabled'] = $("#magenabled").prop("checked") ? "1" : "0";
          req['popupenabled'] = $("#popupenabled").prop("checked") ? "1" : "0";
          var jqstatusfilter = $("#statusfilter");
          req['statusfilter'] = jqstatusfilter.val();
          if (jqstatusfilter.val() != "")
              TxtFilter += InGreyButton("Status=" + jqstatusfilter.find("option:selected").text(), "$(\"#statusfilter\").val(null)");

          // enrich req with filters
          var labels = {};
          var clearers = {};
          GetFiltersFromTab(req, labels, clearers);
          if ('MapN' in req)
              TxtFilter += InGreyButton(" Position=(" + req['MapN'] + "," + req['MapW'] + "," +
                  req['MapE'] + "," + req['MapS'] + ")", "ClearCoord()");
          if ('depthmin' in req)
              TxtFilter += InGreyButton(" Depth in(" + req['depthmin'] + "-" + req['depthmax'] + ")", "ClearDepths()");
          if ('freenum' in req)
              TxtFilter += InGreyButton(labels.freenum, clearers.freenum);
          if ('freetxt' in req)
              TxtFilter += InGreyButton(labels.freetxt, clearers.freetxt);
          if ('samples' in req)
              TxtFilter += InGreyButton("Samples=" + labels.samples, "ClearSamples()");
          if ('month' in req)
              TxtFilter += InGreyButton("Month=" + labels.month, "ClearDates()");
          if ('filt_annot' in req)
              TxtFilter += InGreyButton("Annotator=" + labels.filt_annot, clearers.filt_annot);
          if ('fromdate' in req)
              TxtFilter += InGreyButton("Date &ge; " + req['fromdate'], "ClearDates()");
          if ('todate' in req)
              TxtFilter += InGreyButton("Date &le; " + req['todate'], "ClearDates()");
          if ('fromtime' in req && 'totime' in req)
              TxtFilter += InGreyButton("Time &ge; " + req['fromtime'] + ",&le;" + req['totime'], "ClearTimes()");
          else {
              if ('fromtime' in req)
                  TxtFilter += InGreyButton("Time &ge; " + req['fromtime'], "ClearTimes()");
              if ('totime' in req)
                  TxtFilter += InGreyButton("Time &le; " + req['totime'], "ClearTimes()");
          }
          if ('inverttime' in req)
              TxtFilter += InGreyButton("Time Invert", clearers.inverttime);
          if ('daytime' in req)
              TxtFilter += InGreyButton("DayTime=" + labels.daytime, "ClearTimes()");
          if ('validfromdate' in req)
              TxtFilter += InGreyButton("Valid date &ge; " + req['validfromdate'], clearers.validfromdate);
          if ('validtodate' in req)
              TxtFilter += InGreyButton("Valid date &le; " + req['validtodate'], clearers.validtodate);

          // enrich req with chosen sort and display fields
          req['sortorder'] = $('#sortorder').hasClass("glyphicon-sort-by-attributes-alt") ? "desc" : 'asc';
          req['dispfield'] = "";
          $("#dispfieldlist").find(".glyphicon-ok").closest("li").each(function () {
              req['dispfield'] += " " + $(this).prop("id");
          });
          req['projid'] = $("#projid").val();
          $(".zoomtracker,.zoomstatus,.magnifyarea,.cursorshade").remove();
          PendingChanges = {};
          {# After load there's no pending changes #}
          PendingChangesTaxoName = {};
          if (TxtFilter != "")
              TxtFilter = "Filter: " + TxtFilter;
          var jqpageoffset = $("#pageoffset");
          if (TxtFilter != PrevTxtFilter) {
              {# Si une condition change on revient page 1 #}
              if (PrevTxtFilter != "INITIAL") // Mais pas sur le premier load de page qui peut être avec une URL qui met un filtre
                  jqpageoffset.val(0);
              PrevTxtFilter = TxtFilter;
          }
          req['pageoffset'] = jqpageoffset.val();
          if (seed_object_id != undefined)
          {
              req['seed_object_id'] = seed_object_id
              req['seed_object_ids'] = seed_object_id
          }
          var urlparam = {}, url, k;
          if ((NoAjax === 'mail') || (NoAjax === 'mailN')) {
              delete req["resultwidth"];
              delete req["windowheight"];
              for (k in req)
                  urlparam[k] = req[k];
              url = window.location.protocol + "//" + window.location.host + window.location.pathname + "?" + $.param(urlparam);
              url = "mailto:?subject=Ecotaxa%20page%20share&body=" + encodeURIComponent("Hello,\n\nAn Ecotaxa user want share this page with you \n" + url);
              if (NoAjax === 'mail')
                  window.location = url;
              else
                  window.open(url, '_blank');
              return;
          }
          if (typeof (NoAjax) === 'string') {
              {# Une URL #}
              delete req["resultwidth"];
              delete req["windowheight"];
              for (k in req)
                  if (req[k] !== "")
                      urlparam[k] = req[k];
              url = NoAjax;
              if (url.indexOf('?') > 0) url += "&";
              else url += "?";
              url += $.param(urlparam);
              window.location = url;
              return;
          }
          if (SaveInProfile == true)
              req["saveinprofile"] = 'Y';
          // Show spinning wheel
          jqcolumnright.html("<img src='/static/spinningred.gif'> Loading <span id='load_progress'></span>");
          // Launch progress indicator
          UpdateRightPaneProgress(req);
          // Launch real load
          AsyncSingleLoadRightPane(jqcolumnright, req);
          $('#headersubtitle').html(TxtFilter);
      }

      function UpdateRightPaneProgress(req) {
          // Show a series of dots while the user is waiting for query to return
          var proj_id = req['projid'];
          var req_clone = $.extend({}, req); // A shallow copy is good enough
          $.ajax({
              type: "GET",
              url: "/api/samples/search?project_ids=" + proj_id + "&id_pattern=",
              success: function (rsp) {
                  if (rsp.length == 0) {
                      return;
                  }
                  var first_sample_id = rsp[0].sampleid;
                  var nb_samples = rsp.length;
                  req_clone['samples'] = first_sample_id;
                  var req_start = new Date();
                  $.ajax({
                      type: "POST",
                      // Don't bother replicating the full query, anyway it's just for heating up caches
                      url: "/api/object_set/" + proj_id + "/query?window_size=10000",
                      data: JSON.stringify(req_clone),
                      contentType: "application/json; charset=utf-8",
                      dataType: "json",
                      success: function (rsp) {
                          var req_end = new Date();
                          // We now have an estimate of time for the first sample
                          var elapsed = req_end.getTime() - req_start.getTime();
                          // Let's say 32 dots...
                          elapsed = elapsed * nb_samples / 32;
                          if (elapsed < 500) {
                              elapsed = 500;
                          } // Useless to show too quick animation
                          var dots = "🔎";
                          $('#load_progress').html(dots);
                          var interv = setInterval(function () {
                              dots = dots + "🔎";
                              if ($('#load_progress').length) {
                                  $('#load_progress').html(dots);
                              } else {
                                  clearInterval(interv);
                              }
                          }, elapsed);
                      },
                      error: function (jqXHR, textStatus, errorThrown) {
                          $('#load_progress').html(textStatus + ":" + errorThrown);
                      }
                  });
                  $('#load_progress').html("⌚");
              },
              error: function (jqXHR, textStatus, errorThrown) {
                  $('#load_progress').html(textStatus + ":" + errorThrown);
              }
          });
      }

      var theOnlyLazyLoader = null;

      var theOnlyRightPaneXHR = null;

      function AsyncSingleLoadRightPane(elem, req) {
          // Load right pane, but cancel a previous load if in progress. github #281.
          // Below is a copy/paste/simplify of JQuery load(), as this primitive does
          // not return the generated XHR object.
          if (theOnlyRightPaneXHR && theOnlyRightPaneXHR.readyState != 4) {
              // abort request in progress, we want new request results and only them
              theOnlyRightPaneXHR.abort();
          }
          if (theOnlyLazyLoader !== null) {
              // Lazy loader does the loading for detached DOM elements as well -> Gh #402 for big page size
              theOnlyLazyLoader.destroy();
              theOnlyLazyLoader = null;
          }
          theOnlyRightPaneXHR = jQuery.ajax({
              url: "/prj/LoadRightPane",
              type: "POST",
              dataType: "html",
              data: req
          }).done(function (responseText) {
              // Detach present DOM and inject the new one
              elem.html(responseText);
          }).error(function (jqXHR, opts, error) {
              if (error !== "abort") {
                  msg = "Request problem " + JSON.stringify(jqXHR);
                  msg += "<br>Refreshing the page could cure this problem.";
                  elem.html(msg);
              }
          });
      }

      function RefreshClassifTab() {
          // Refresh (or load from 0) the category tree
          RestoreHighLigthID = $('#categtree .ui-state-highlight').data('taxoid');
          // Load present state of the tab's active category
          RestoreActiveTaxoID = $('#categtree .activeTaxo').data('taxoid');
          if (!RestoreActiveTaxoID) {
              // During initial load, the state might be in hidden param.
              RestoreActiveTaxoID = $('#taxofilter').val();
          }
          var HiddenItems = $('#categtree td').filter(function () {
              return $(this).css('display') === 'none';
          }).map(function () {
              return $(this).data('taxoid');
          }).get();
          var HorizArrow = $('#categtree td span.glyphicon-triangle-right').closest('td').map(function () {
              return $(this).data('taxoid');
          }).get();
          var PosScrollBar = $('#divclassiftab').scrollTop();
          // Launch a request to get table content
          $("#categtree").load("/prjGetClassifTab/" + $("#projid").val(), {}, function () {
              MakeCateTreeClickableDroppable();
              {#    Restore le surlignage jaune dans l'arbre #}
              if (RestoreHighLigthID) {
                  $('td[data-taxoid=' + RestoreHighLigthID + ']').addClass('ui-state-highlight');
              }
              {#    Restore le surlignage Gris dans l'arbre/activeTaxo pour filtrage #}
              if (RestoreActiveTaxoID) {
                  $('td[data-taxoid=' + RestoreActiveTaxoID + ']').addClass('activeTaxo');
              }
              $.each(HiddenItems, function (k, v) {
                  {# Masque ceux qui etaient déjà cachés #}
                  $('.classiftab td[data-taxoid=' + v + ']').css('display', 'none');
              });
              $.each(HorizArrow, function (k, v) {
                  {# Masque ceux qui etaient déjà cachés #}
                  $('.classiftab td[data-taxoid=' + v + '] span.glyphicon-triangle-bottom').removeClass("glyphicon-triangle-bottom").addClass("glyphicon-triangle-right");
              });
              $('#divclassiftab').scrollTop(PosScrollBar);
          });

      }

      function SortToggle(NoRefresh) {
          if ($('#sortorder').hasClass("glyphicon-sort-by-attributes"))
              $('#sortorder').removeClass("glyphicon-sort-by-attributes").addClass("glyphicon-sort-by-attributes-alt").closest('button').prop("title", "Current Sort : Descending");
          else $('#sortorder').removeClass("glyphicon-sort-by-attributes-alt").addClass("glyphicon-sort-by-attributes").closest('button').prop("title", "Current Sort : Ascending");
          if (NoRefresh !== 'NoRefresh') {
              $("#pageoffset").val(0);
              {# Force le retour à la premiere page #}
              LoadRightPane();
              {# 20181024 Autorefresh #}
          }
      }

      function ToggleDispField(caller) {
          $('#' + caller).find('span').toggleClass("glyphicon-ok");
          $('#' + caller).find('span').removeClass("ManualAdd");
          $('#' + caller).find('span.glyphicon-ok').addClass("ManualAdd");
          LoadRightPane();
          {# 20181024 Autorefresh #}
          //return false;
      }

      function DeleteUnsupervisedSearch(){
          $('#listunsupervisedsearch').html("Start searching by clicking on the loop on photos");
      }

      function removeOneSimSearch(elem){
          $(elem).closest('tr').remove();
      }

      function addClickBehaviorOnSimSearch(){
          $('#listunsupervisedsearch').on('click', 'tr', function(){
              var seed_object_id = $(this).find('td').data('seed');
              LoadRightPane(false, false, seed_object_id);
          });
      }

      function CreateSimilaritySearch(seed_object_id, datatooltipimage, cat_name){
            // Add an entry in listunsupervisedsearch like a category in categtree with name SS and seed_object_id
            // Create a table if it doesn't exists
            if ($("#listunsupervisedsearch table").length == 0){
                $('#listunsupervisedsearch').html('<table width="98%" ></table>');
            }
            // Add a row with seed_object_id
         var newSS = $('<tr><td id="ss-' + seed_object_id + '"  data-seed="' + seed_object_id + '" \
                class="ui-droppable taxodrop unsupervisedsearch-info" style="margin-left: 1.0em"\
                data-tooltipimage="'+ datatooltipimage + '" width="240px" >\n\
                <img src="'+ datatooltipimage + '" alt="Useless if image present."/>\n\
                <span>\n\
                SS ' + seed_object_id + ' ' + cat_name + '\n\
                 </span>\n\
                <div class="counterarea">\n\
                <span class="counter label label-success">1</span>\n\
                <span class="counternotv label" style="background-color:purple">99</span>\n\
                </div>\n\
                <span class="glyphicon glyphicon-remove" onclick="removeOneSimSearch(this)">\n\
                </td></tr>');
//                newSS.attr('data-tooltipimage', datatooltipimage);
// tooltipimage est inutile !
            $('#listunsupervisedsearch').append(newSS);
            addClickBehaviorOnSimSearch();
      }



      function gotopage(nopage) {
          $("#pageoffset").val(nopage);
          LoadRightPane();
      }

      $(document).ready(function () {
          if ("{{data.sortorder}}" == "desc") {   //TOCHECK LN
              SortToggle('NoRefresh');
          }
          $('[data-toggle="tooltip"]').tooltip();
          $("#titledivtitle").css("max-width", $("#titlediv").parent().width() - 150);
          {% if g.taxofilter %}
              SetTaxoFilter({{ g.taxofilter }}, "{{ g.taxofilterlabel }}"{{ ",true" if g.taxochild == 'Y' }});
          {% endif %}

          LoadRightPane();

          var PreviousSort = $('#sortby').val();
          {# Si on choisit un champ pour le tri, ca l'ajoute automatiquement dans les displayed fields #}
          $('#sortby').change(function () {
              $("#dispfield_" + PreviousSort + "  .glyphicon:not(.ManualAdd)").removeClass('glyphicon-ok');
              $("#dispfield_" + $(this).val() + " .glyphicon").addClass('glyphicon-ok');
              PreviousSort = $(this).val();
              $("#pageoffset").val(0);
              {# Changement d'ordre on revient à la première page #}
              LoadRightPane();
              {# 20181024 Autorefresh #}
          });
          $('#statusfilter,#ipp,#zoom,#magenabled,#popupenabled').change(function () {
              LoadRightPane();
          });

          $(document).bind('keydown', 'Test1', function (e) {
              if ((e.ctrlKey || e.metaKey) && !e.shiftKey) {
                  // CTRL but no SHIFT
                  switch (e.keyCode) {
                      case 65:
                      {# CTRL + A #}
                          SelectAll(e);
                          e.preventDefault();
                          break;
                      case 68:
                      {# CTRL + D #}
                          AssignCurrentTaxoToSelection();
                          e.preventDefault();
                          break;
                      case 76:
                      {# CTRL + L #}
                          ValidateSelection('V');
                          e.preventDefault();
                          break;
                      case 85:
                      {# CTRL + U #}
                          ValidateSelection('D');
                          e.preventDefault();
                          break;
                      case 83:
                      {# CTRL + S #}
                          SavePendingChanges();
                          e.preventDefault();
                          break;
                      case 37:
                          KeyboardMoveSelection("LEFT");
                          e.preventDefault();
                          break;
                      case 38:
                          KeyboardMoveSelection("UP");
                          e.preventDefault();
                          break;
                      case 39:
                          KeyboardMoveSelection("RIGHT");
                          e.preventDefault();
                          break;
                      case 40:
                          KeyboardMoveSelection("DOWN");
                          e.preventDefault();
                          break;
                  }
              }
              if ((e.ctrlKey || e.metaKey) && e.shiftKey) {
                  switch (e.keyCode) {
                      case 37:
                          var curr_page = +$("#pageoffset").val();
                          if (curr_page > 0) gotopage(curr_page - 1);
                          e.preventDefault();
                          break;
                      case 39:
                          var curr_page = +$("#pageoffset").val();
                          gotopage(curr_page + 1);
                          e.preventDefault();
                          break;
                  }
              }
          });

          {#  Si pression sur une touche alors que le focus n'est sur aucun input (donc dans body), on ouvre la popup #}
          $(document).bind('keydown', function (e) {
              const node_name = document.activeElement.nodeName;
              if (node_name !== 'BODY' && node_name !== 'SPAN') {
                  if (e.keyCode === 13 && e.target.className === "select2-search__field") {
                      // A RETURN was typed in the select2, which could not handle it, because not done yet,
                      // e.g. due to a network query in progress. Try to replay it.
                      const sel2 = $('#taxolbanno');
                      const todo = function () {
                          const possible = $('.select2-results__option--highlighted');
                          if (possible.length !== 1) return;
                          const the_one = possible.get(0);
                          const sel_data = $(the_one).data('data');
                          // Close the dropdown
                          sel2.select2("close") // select2.full.js l:5516
                          // Show the wanted option
                          var newOption = new Option(sel_data.text, sel_data.id, false, false);
                          sel2.append(newOption);
                          sel2.val([sel_data.id]).change();
                          // Assign as if the choice was made
                          AssignTaxoLbToSelection(sel_data.id, sel_data.text)
                      };
                      // @see taxopopup.html for the call
                      sel2.data('todo_after_ajax', todo);
                  }
                  return;
              }
              // Need a plain unmodified letter to start...
              if (e.keyCode < 65 || e.keyCode > 90 || e.ctrlKey || e.metaKey)
                  return;
              // ...and a selection
              if ($(".ui-selected").length === 0)
                  return;
              const sel2 = $('#taxolbanno');
              const typedKey = String.fromCharCode(e.keyCode).toLocaleLowerCase();
              // When the select2 "open" executes, it will trigger a query to the server
              // with what's inside, i.e. nothing. The line below will add present key
              // into the query params. Search for 'first_keys' magic value in 'taxopopup.html' code.
              const first_keys = sel2.data('first_keys');
              const next_first_keys = (first_keys ? first_keys : '') + typedKey;
              sel2.data('first_keys', next_first_keys);
              // Open the select2, it will trigger the amended query...
              sel2.select2("open");
              // ...and switch on the visibility of the beginning filter.

              const search = $('.taxopopup .select2-search__field');
              // Add current key into search box as well
              search.val(next_first_keys);
              e.preventDefault();
          });
      }); // document.ready

      function UpdateSelectedCounter() {
          // Asynchronously update the selected counter, as it takes some time for jQuery to find selected nodes
          // especially on 1000 images setting
          setTimeout(function () {
              var nbr = $("#column-right").find("td.ui-selected").size();
              if (nbr > 0) nbr = nbr + " Selected";
              else nbr = "";
              $('#nbrselected').text(nbr);
          }, 0);
      }

      function find_first_parent_dragable(elem)
{
    console.log(elem)
    while (elem.className != "ui-draggable ui-draggable-handle")
    {
        elem = elem.parentElement
    }
    return elem
}

      function find_object(elem)
{
      elem_td_object = find_first_parent_dragable(elem)
      return elem_td_object
}

      function PostAddImages() {
          $(document).scrollTop(0);
          // Required to  have Select2 component working on Bootstrap Popup
          $.fn.modal.Constructor.prototype.enforceFocus = function () {
          };
          // Add Zoom & lazy loading of images
          theOnlyLazyLoader = jQuery('div#column-right img.lazy').Lazy({
              bind: 'event',
              afterLoad: function (element) {
                  if ($('#magenabled').prop("checked") == false)
                      return; // Si il y a une checkbox magenabled et qu'elle est decochée on ne met pas le zoom
                  AddZoom(element);
              },
              chainable: false // return the instance i.e. loader itself
          });
          // Make sub image draggable
          jQuery('.imgtab td').draggable({
              revert: true, revertDuration: 0, cursor: "move", refreshPositions: true,
              cursorAt: {top: 0, left: 0},
              start: function (event, ui) {
                  DragInProgress = true;
                  drag_start_time = event.timeStamp;
              },
              stop: function (event, ui) {
                  DragInProgress = false;
                  if (event.timeStamp - drag_start_time < 150) {
                      // Less than 150ms, so not at drag, rather a click while moving mouse
                      event.target.click();
                  }
                  drag_start_time = null;
              },
              helper: function (ev) {
                  return $("<img src='/static/drag_cursor.png'>");
              }
          });
          {#        jQuery('.imgtab td img').draggable({ revert: true, revertDuration: 0 });#}
          // Make the cell clickable for selection
          jQuery('.imgtab td').click(function (e) {
              if ($(e.target).hasClass('linestart')) {
                  var nbrselectedinline = $(e.target).closest('tr').find('td.ui-selected').size();
                  if ((e.shiftKey) || (nbrselectedinline > 0)) { // Unselect line
                      $(e.target).closest('tr').find('td').removeClass('ui-selected');
                      if (window.getSelection) {
                          if (window.getSelection().empty) {  // Chrome
                              window.getSelection().empty();
                          } else if (window.getSelection().removeAllRanges) {  // Firefox
                              window.getSelection().removeAllRanges();
                          }
                      } else if (document.selection) {  // IE?
                          document.selection.empty();
                      }
                      UpdateSelectedCounter();
                      return;
                  }
              }
              if ((e.ctrlKey) || (e.metaKey))
                  {#  20161018 on inverse la logique CTRL permet de ne PAS faire de selection multiple #}
                  $('.ui-selected').removeClass('ui-selected');
              if ($(e.target).hasClass('linestart')) // select line (except this first column)
                  $(e.target).closest('tr').find('td:nth-child(1n+2)').addClass('ui-selected');
              else
                  $(e.target).closest('td').toggleClass('ui-selected');
              UpdateSelectedCounter()
          });
          // Make ZoomTracker Clickable for selection
          jQuery('body').delegate('.zoomtracker', 'click', function (e) {
              {# if ((!e.ctrlKey) && (!e.metaKey)) 20161018 on inverse la logique CTRL permet de ne PAS faire de selection multiple#}
              if ((e.ctrlKey) || (e.metaKey))
                  $('.ui-selected').toggleClass('ui-selected');
              $($(e.target).data("specs").origImg.parents("td")[0]).toggleClass('ui-selected');
              UpdateSelectedCounter();
          });
          // setup zoomtracker creation tracking to make them draggable
          var target = $("body")[0];
          var observer = new MutationObserver(function (mutations) {
              mutations.forEach(function (mutation) {
                  var newNodes = mutation.addedNodes; // DOM NodeList
                  if (newNodes !== null) { // If there are new nodes added
                      var $nodes = $(newNodes); // jQuery set
                      $nodes.each(function () {
                          var $node = $(this);
                          if ($node.hasClass("zoomtracker")) {
                              //console.log("zoomtracker");
                              jQuery($node).draggable({
                                  revert: true, revertDuration: 0, cursor: "move", refreshPositions: true,
                                  cursorAt: {top: 0, left: 0},
                                  helper: function (ev) {
                                      return $("<img src='/static/drag_cursor.png'>");
                                  }
                              });
                          }
                      });
                  }
              });
          });
          var config = {attributes: true, childList: true, characterData: true};
          observer.observe(target, config);
          // Enable the popover
          var option = {'trigger': 'hover', 'html': true};
          $('div.subimg').popover(option);
          $('.ddets').click(function (e) {
              e.stopPropagation();
              //            var url="/objectdetails/"+$(e.target).closest('td').find('img').prop('id').substr(1);
              //            var win = window.open(url, '_blank');
              var url = "/objectdetails/" + $(e.target).closest('td').find('img').prop('id').substr(1) + "?w=" + ($(window).width() - 400) + "&h=" + ($(window).height() - 40) + "&ajax=1";
              var options = {};
              $("#PopupDetails .modal-content").html("Loading...");

              $('#PopupDetails .modal-lg').css('width', $(window).width() - 40);
              $('#PopupDetails').modal(options);
              $("#PopupDetails .modal-content").load(url);
          });

          $('.ddsim').click(function (e) {
              console.log("Please do a similiraty search from this photo")
              obj = find_object(e.target)
      seed_object_id = $(obj).find("img").attr("id")
      cat_name = $(obj).find("span.cat_name").text()
              datatooltipimage = $("img#"+seed_object_id).attr("src")
              LoadRightPane(false, false, seed_object_id)
              CreateSimilaritySearch(seed_object_id, datatooltipimage, cat_name)
          })
          $('#PopupDetails').on('hidden.bs.modal', function (e) {
              $("#PopupDetails .modal-content").html("CLEAN");
              $(".zoomContainer").remove();
          });

          jQuery('.SpanSelectAll').click(SelectAll);
          $(document).scrollTop(RightPanelScrollPosAfterLoad);
          RightPanelScrollPosAfterLoad = 0;
      }  //PostAddImages

      function SelectAll(e) {
          if (!e.shiftKey)
              jQuery('.imgtab td:not(.linestart)').addClass('ui-selected');
          else
              jQuery('.imgtab td:not(.linestart)').removeClass('ui-selected');
          UpdateSelectedCounter();
      }

      jQuery(window).bind('beforeunload', function () {
          if (Object.keys(PendingChanges).length > 0)
              return "Some changes are pending, if you continue they will be discarded !\n\nWould you still like to continue ?"
      });

      function GotoWithFilter(Target) {
          LoadRightPane(Target);
      }

      function SetTaxoFilter(taxofiltervalue, taxofilterlabel, withchild) {
          // memorize taxo filter in global hidden params
          // TODO: Why?
          var WithChild = 'N';
          if (withchild == true) {
              taxofilterlabel += " (with child)";
              WithChild = 'Y';
          }
          if (taxofiltervalue == false) {
              $("#taxofilter").val("");
              $("#taxofilterlabel").val("");
              if (taxofilterlabel == -1) LoadRightPane();
              return;
          }
          $("#taxofilter").val(taxofiltervalue);
          $("#taxofilterlabel").val(taxofilterlabel);
          $("#taxofilterchild").val(WithChild);
      }

      function CategExpanderClick(e) {
          e.stopPropagation();
          e.preventDefault();
          if ($(this).hasClass("glyphicon-triangle-bottom")) {
              $(this).removeClass("glyphicon-triangle-bottom").addClass("glyphicon-triangle-right");
              $('#divclassiftab .visib' + $(this).closest("td").data("taxoid")).hide();
          } else {
              $(this).removeClass("glyphicon-triangle-right").addClass("glyphicon-triangle-bottom");
              $('#divclassiftab .visib' + $(this).closest("td").data("taxoid")).show();
          }
      }

      {% if g.PrjAnnotate or g.PrjManager %}
          var last_deselected = null;
          {# Traitement de la Liste des objets TD à traiter. #}
          function ProcessList(LstTd, droptaxoid, droptaxoname) {
              var TrSet = new Set(), i;
              PendingChangesTaxoName[droptaxoid] = droptaxoname;
              var taxopart = droptaxoname.split('<');
              var HtmlTaxo = "<span class='cat_name'>" + taxopart[0] + "</span>";
              if (taxopart.length > 1) {
                  HtmlTaxo += "<span class='cat_ancestor'>";
                  for (i = 1; i < taxopart.length; i++)
                      HtmlTaxo += " &lt;&nbsp;" + taxopart[i];
                  HtmlTaxo += "</span>";
              }

              // Traitement des cellules
              for (i = 0; i < LstTd.length; i++) {
                  var td = LstTd[i];
                  last_deselected = td
                  td.removeClass("ui-selected");
                  td.addClass("ToBeSaved");
                  var id = td.find('img').attr('id');
                  td.find('.taxo').html(HtmlTaxo);
                  td.find('.subimg').css("height", '').css("width", '').css("left", '').css("top", '').css("right", '').css("bottom", '');
                  td.find('.subimg').attr('class', 'subimg status-validated');
                  TrSet.add(td.closest('tr').attr('id'));
                  // id is, e.g.: id="I925293"
                  PendingChanges[id.substr(1)] = droptaxoid;
                  //td.css('background-color', '#80FF80')
                  //console.log(o, id ,droptaxoid,droptaxoname);
              }
              UpdateSelectedCounter();
              NbrChanged = LstTd.length;
              // Ces resizes ralentissent mais permettent de recaller les zoom tracker suite au changement de taille des taille de taxo
              // sur table 1000 image à 10% ligne 42 ca Freeze 4s
              // sur table 200 images à 10% ca Freeze 1s
              // Sur 50&100 ca ne se voit pas
              //for ( trid of TrSet) Marche pas sous IE
              TRArray = Array.from(TrSet);
              for (i = 0; i < TRArray.length; i++) {
                  var trid = TRArray[i];
                  $('#' + trid).find('td img').resize();
                  //console.log("resize #"+trid);
              }
              var calctotaux = {};
              for (var k in PendingChanges) {
                  v = 0;
                  if (PendingChanges[k] in calctotaux) v = calctotaux[PendingChanges[k]];
                  calctotaux[PendingChanges[k]] = v + 1;
              }
              var Msg = "Pending Changes : ";
              PendingChangesTaxoName[-1] = "Unchanged";
              for (k in calctotaux)
                  Msg = Msg + calctotaux[k] + " " + PendingChangesTaxoName[k] + ", ";
              $('.PendingChangesClass').text(Msg);
              document.getElementById("BtnSave").disabled = false;
              $("#TxtBtnValidateAll").text("Save changes, validate rest and move to next page");
          }
          function SavePendingChanges(NextPage, forcedqual) {
              {#  console.log("prev",PendingChanges); #}
              req = {
                  changes: PendingChanges,
                  qual: ((forcedqual === undefined) ? 'V' : forcedqual)
              }
              $(".PendingChangesClass").html('<span class="label label-info">Server update in progress...</span>');
              $("#PendingChanges2").html($("#PendingChanges").html());
              $("#PendingChanges").load("/prj/ManualClassif/" + $("#projid").val(), req, function () {
                  $("#PendingChanges2").html($("#PendingChanges").html());
                  if ($("#PendingChanges").html().indexOf("Successful") > 0) {
                      PendingChanges = {}; // After successful update no pending changes.
                      if (NextPage == 1)
                          $("#pageoffset").val(parseInt($("#pageoffset").val()) + 1);
                      else {# Si on ne change pas de page on garde l'offset de la scrollbar vertical à sa position courante #}
                      if (NextPage === 0) {
                      } {# Distinction entre save et save go to next page qui en fait reste sur la page. #}
                      else
                          RightPanelScrollPosAfterLoad = $(document).scrollTop();
                      LoadRightPane();
                      RefreshClassifTab();
                      last_deselected = undefined;
                  }
              });
          }
          function ValidateAll(NextPage) {
              {# On valide tout ce qui est predicted ou validated et qui n'est pas déjà en attente de save #}
              $(".status-validated,.status-predicted").parents('td').find('img.lazy').each(function (e, o) {
                  //console.log($(o).attr("id").substr(1));
                  if (PendingChanges[$(o).attr("id").substr(1)] === undefined)
                      PendingChanges[$(o).attr("id").substr(1)] = -1;
                  {# Set unchanged but validate #}
              });
              SavePendingChanges(NextPage);
          }
          function ValidateSelection(qual) {
              {# On valide tout ce qui est selectionné et qui n'est pas déjà en attente de save #}
              $(".ui-selected").find('img.lazy').each(function (e, o) {
                  if (PendingChanges[$(o).attr("id").substr(1)] === undefined)
                      PendingChanges[$(o).attr("id").substr(1)] = -1;
                  {# Set unchanged but validate #}
              });
              SavePendingChanges(0, qual);
          }
          // Magic 125 is height of #divheadinfo + height of #topbar + a margin somewhere...
          var y_offset_before_objects = 125;
          function CheckIfInView(elem) {
              const win_scroll_top = $(window).scrollTop();
              const win_height = $(window).innerHeight();
              const elem_top = elem.offset().top;
              const elem_bottom = elem.offset().top + elem.height() + 5;
              let warp = null;
              // Both sides must be visible
              if (elem_bottom > win_scroll_top + win_height) {
                  warp = elem_bottom - win_height;
              } else if (elem_top < win_scroll_top + y_offset_before_objects) {
                  warp = elem_top - y_offset_before_objects;
              } else {
                  return;
              }
              $('html,body').animate({scrollTop: warp}, 100);
          }

          function NearestY(from, where) {
              // Get nearest TD from 'from' in elem tree 'where'
              let from_pos = from.offset();
              var from_width = from.width();
              var from_height = from.height()
              let ret = $.nearest({x: from_pos.left + from_width / 2, y: from_pos.top + from_height / 2},
                  'td', {container: where, sort: true});
              // Sometimes it's deuce, the middle of current row falls right in the middle of 2 others
              if (ret.length > 1) ret = ret.slice(0, 1);
              return ret;
          }

          function KeyboardMoveSelection(way) {
              // Get current selected cell
              let col_right = $("#column-right");
              let present_sel = col_right.find(".ui-selected").first();
              if (!present_sel[0]) {
                  // If no selection, fallback to last de_deselected, e.g. when 'CTRL-D' was used
                  present_sel = last_deselected;
              }
              let next_sel;
              if (present_sel) {
                  let parent;
                  switch (way) {
                      case 'UP':
                          parent = present_sel.parent().parent().parent();
                          const line_above = parent.prev();
                          if (!line_above.hasClass('imgtab')) return; // Not a line
                          next_sel = NearestY(present_sel, line_above);
                          break;
                      case 'DOWN':
                          parent = present_sel.parent().parent().parent();
                          const line_below = parent.next();
                          if (!line_below.hasClass('imgtab')) return; // Not a line
                          next_sel = NearestY(present_sel, line_below);
                          break;
                      case 'LEFT':
                          next_sel = present_sel.prev();
                          if (!next_sel[0] || next_sel.hasClass("linestart")) { // Previous is beginning of line
                              // Move to line above
                              parent = present_sel.parent().parent().parent();
                              const line_above = parent.prev();
                              if (!line_above.hasClass('imgtab')) return; // Not a line
                              const all_tds = line_above.find("td");
                              if (all_tds.length < 2) return; // Need the linestart + one image
                              next_sel = $(all_tds.get(all_tds.length-1));
                          }
                          break;
                      case 'RIGHT':
                          next_sel = present_sel.next();
                          if (!next_sel[0]) {   // No element on the right, i.e. end of line
                              // Move to line below
                              parent = present_sel.parent().parent().parent();
                              const line_below = parent.next();
                              if (!line_below.hasClass('imgtab')) return; // Not a line
                              const all_tds = line_below.find("td");
                              if (all_tds.length < 2) return; // Need the linestart + one image
                              next_sel = $(all_tds.get(1));
                          }
                          break;
                  }
                  present_sel.removeClass('ui-selected');
              } else {
                  // Upper-left object of the visible section
                  next_sel = $.nearest({x: 0, y: $(window).scrollTop() + y_offset_before_objects},
                      '.ui-draggable', {container: col_right, sort: true});
                  // solve deuce and skip column header
                  next_sel = next_sel.slice(0, 1).next();
              }
              next_sel.addClass('ui-selected');
              setTimeout(CheckIfInView, 5, next_sel);
          }
      {% endif %}

      function MakeCateTreeClickableDroppable() {
          // Category tree was loaded, from XHR. Set event handlers.
          $("#categtree td"
              {% if g.PrjAnnotate or g.PrjManager %}
                  ).droppable({
                  tolerance: "pointer",
                  {#      classes:{"ui-droppable-hover":"taxodrop_hover"}, Utile pour JQuery UI >=1.12 car hoverClass deprecated#}
                  hoverClass: "taxodrop_hover",
                  drop: function (event, ui) {
                      var droptaxoid = $(this).data('taxoid');
                      var droptaxoname = $(this).data('dispname');
                      // Not nice, but the whole TD is droppable so we cannot prevent the drop
                      // DEPENDS ON LABEL, BAD AND FRAGILE
                      if (droptaxoname.indexOf('(D') !== -1) {
                          alert("Cannot assign to a deprecated category");
                          return;
                      }
                      SetTaxolbValue('#taxolbanno', droptaxoid, droptaxoname);
                      var NbrChanged = 0;
                      var LstTd = [];
                      ui.draggable.each(function (e, o) {
                          NbrChanged++;
                          if ($(o).hasClass("zoomtracker")) {
                              LstTd.push($($(o).data("specs").origImg.closest('td')));
                              {#              } else if( $(o).hasClass( "taxo" )) {  // Sinon c'est le taxo du div subimg#}
                          } else if ($(o).is("td")) {  // Sinon c'est le taxo du div subimg
                              LstTd.push($(o));
                          } else if ($(o).hasClass("lazy")) {  // Sinon c'est l'image
                              LstTd.push($(o).closest('td'));
                          }
                          //Si c'est un item selected, on le supprime car va être ajouté par
                          if (LstTd.length > 0)
                              if (LstTd[0].hasClass("ui-selected"))
                                  LstTd.pop();
                          // On ajoute tout ceux qui sont selectionnés.
                          $(".ui-selected").each(function () {
                              LstTd.push($(this));
                              NbrChanged++;
                          });
                      });
                      ProcessList(LstTd, droptaxoid, droptaxoname);
                      // Highlight only the last
                      $("#TabA .ui-state-highlight").removeClass("ui-state-highlight");
                      var n = parseInt($(this).find(".counter").text()) || 0;
                      $(this).addClass("ui-state-highlight").find(".counter").html(n + NbrChanged);
                  }
              }
              {% endif %}
          ).click(function () {
              $(".ui-state-highlight").removeClass("ui-state-highlight");
              if ($(this).hasClass('activeTaxo'))
                  SetTaxoFilter(false, -1);
              else {
                  SetTaxoFilter($(this).data('taxoid'), $(this).find('.taxodrop').text());
                  LoadRightPane();
              }
          });
          $("#categtree .categexpander").click(CategExpanderClick).hover(function (e) {
              if ((DragInProgress) && ($(this).hasClass("glyphicon-triangle-right"))) {
                  {# Quand on passe sur un triange fermé sur un Drag&Drop on simule un clic sur le triangle pour l'ouvrir #}
                  $(this).click();
              }
          });

      }

      $(function () {
          // Narrow the category + select tab height, which makes it scrollable.
          // TODO: Should be solvable with proper CSS
          $("#divclassiftab").outerHeight($("#column-left").innerHeight() - $("#divclassiftab").position().top);
      });
      {# Ready #}

      $(document).ready(function () {
          EnableSelect2Taxolb('#taxolbanno');
      });

      {% if g.PrjAnnotate or g.PrjManager %}
          function AssignCurrentTaxoToSelection() {
              // Assign current val, wherever it is
              const sel2 = $('#taxolbanno');
              let taxoid = sel2.val();
              let taxoname;
              if (taxoid) {
                  taxoname = $('#taxolbanno option:selected').text();
              } else {
                  taxoid = sel2.data('saved_val');
                  taxoname = sel2.data('saved_text');
              }
              if (taxoid)
                  AssignTaxoLbToSelection(taxoid, taxoname);
          }
          function AssignTaxoLbToSelection(taxoid, taxoname) {
              $(".ui-state-highlight").removeClass("ui-state-highlight");
              $("td[data-taxoid='" + taxoid + "']").addClass("ui-state-highlight");
              var LstTd = [];
              $(".ui-selected").each(function () {
                  LstTd.push($(this));
              });
              ProcessList(LstTd, taxoid, taxoname);
          }

          $(document).ready(function () {

              {# Le fait de choisir un item fait l'assignation/CTRL+D #}
              const sel2 = $('#taxolbanno');
              sel2.on("select2:opening", function () {
                  const selection = sel2.data('saved_text');
                  if (!selection) return;
                  // Clear the value. We clear because otherwise:
                  //    - Re-picking the same value would _not_ trigger the event select2:select below.
                  //    - Current value might appear in the middle of the list, if similar text is entered.
                  sel2.val(null).trigger("change");
                  // The "selection rendered" element (where selection is seen) has been emptied, fill it back.
                  const rdr = $('[id*="-'+ sel2.prop('id')+'-"].select2-selection__rendered'); // #808 select on id because .select2-selection__rendered is used on each select2 item
                  rdr.text(" " + selection);
                  rdr.title = selection;
              });
              sel2.on("select2:select", function (e) {
                  // Chosen line
                  const choice = e.params.data;
                  // Select event in the dropdown
                  AssignTaxoLbToSelection(choice.id, choice.text);
                  // Keep memory of current val & text, as they will be erased at next opening, just above.
                  sel2.data('saved_val', choice.id);
                  sel2.data('saved_text', choice.text);
              });
              sel2.on("select2:closing", function () {
                  // Remove all options so they don't appear (with default focus!) next time the box opens.
                  const opts = $('.select2-results__options li');
                  opts.detach();
              });


              {# Gestion de la scrollbar de la liste taxo quand la souris est en bas ou en haut de la zone#}
              $(window).mousemove(function (e) {
                  var divclassiftab = $('#divclassiftab');
                  var pagebottom = $(this).scrollTop() + $(this).innerHeight() - 50;
                  if (e.pageX < 235) {
                      if (e.pageY > pagebottom)
                          divclassiftab.scrollTop(divclassiftab.scrollTop() + 10);
                      if ((e.pageY > divclassiftab.offset().top) && (e.pageY < divclassiftab.offset().top + 25) && (e.pageX > 180))
                          divclassiftab.scrollTop(divclassiftab.scrollTop() - 10);
                  }
              });

          }); // Ready

      {% endif %} {# if g.PrjAnnotate or g.PrjManage #}

      $(document).ready(function () {
          {#  Initialisation Context Menu  #}
          $.contextMenu({
              // define which elements trigger this menu
              selector: ".classiftab td",
              appendTo: "#empty_fixed",
              position: function (opt, x, y) {
                  win_scroll = $(window).scrollTop();
                  win_height = $(window).height();
                  menu_height = opt.$menu[0].clientHeight;
                  new_y = y - win_scroll;
                  if (new_y + menu_height > win_height) {
                      new_y -= (new_y + menu_height) - win_height;
                  }
                  // console.log(opt, x, y, win_scroll, menu_height);
                  opt.$menu.css({left: x, top: new_y});
              },
              // define the elements of the menu
              build: function ($trigger, e) {
                  res = {
                      callback: function (key, options) {
                          var prefix = key.substr(0, 1);
                          if (prefix === 'X') return;
                          {# Menu informatifs #}
                          var taxoid = parseInt(key.substr(1));
                          var taxoname = taxotree[taxoid][1];
                          if (prefix === 'f') {
                              {#          console.log("filter by ",taxoid,taxoname);#}
                              SetTaxoFilter(taxoid, taxoname, true);
                              LoadRightPane();
                          }
                          if (prefix === 'o') {
                              // right-click menu, "-- CLASSIFY TO --"
                              SetTaxolbValue('#taxolbanno', taxoid, taxoname);
                              AssignTaxoLbToSelection(taxoid, taxoname);
                          }
                      },
                      items: {}
                  };
                  var Arr = [];
                  var taxoid = $(e.currentTarget).data('taxoid');
                  var taxoname = taxotree[taxoid][1];
                  Arr.unshift({key: "f" + taxoid, name: taxoname});
                  {#     On insere d'abord en bas le filtrage #}
                  for (var i = 0; i < 50; i++) {
                      taxoid = taxotree[taxoid][2]; // Go to parent
                      if (taxoid == null) break;
                      taxoname = taxotree[taxoid][1];
                      Arr.unshift({key: "f" + taxoid, name: taxoname})
                  }
                  Arr.unshift({key: "X2", name: "-- FILTER WITH CHILD -- "});
                  Arr.unshift({key: "X1", name: "_____________________"});

                  taxoid = $(e.currentTarget).data('taxoid');
                  taxoname = $(e.currentTarget).find(".taxodrop").text();
                  Arr.unshift({key: "o" + taxoid, name: taxoname})
                  for (i = 0; i < 50; i++) {
                      taxoid = taxotree[taxoid][2]; // Go to parent
                      if (taxoid == null) break;
                      taxoname = taxotree[taxoid][1];
                      Arr.unshift({key: "o" + taxoid, name: taxoname})
                  }
                  Arr.unshift({key: "X3", name: "-- CLASSIFY TO -- "});

                  for (index = 0; index < Arr.length; index++)
                      res["items"][Arr[index]["key"]] = {name: Arr[index]["name"]}
                  return res;
              }
          });
          {#  Initialisation Context Menu  #}
      });
      {#  Ready  #}

      function ToggleZeroCount() {
          const zsh = $('#zeroshowhide');
          if (zsh.attr("data-show") === "0") {
              $(".zerocount").hide();
              zsh.attr("data-show", "1").text("Show empty categories");
          } else {
              $(".zerocount").show();
              zsh.attr("data-show", "0").text("Hide empty categories");
          }
      }

      $(document).ready(function () {
          // Switch tab when clicking on header
          $('#myTabs .nav-tabs a').click(function (e) {
              e.preventDefault();
              $(this).tab('show');
          });

          $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
              if ($(e.target).attr('href') == '#TabB') {# Doit être fait dans le changement de tab car au debut l'onglet n'est pas visible et le calcul est faut #}
                  // TODO: Should be solvable with proper CSS
                  $("#TabB").outerHeight($("#column-left").innerHeight() - $("#TabB").position().top);
          });
      });

      function DispClassificationHelp(projid) {
          $("#PopupDetails .modal-content").load("/static/taxofilterhelp_20211001.html");
          $('#PopupDetails').modal({});
      }

      function DispUnsupervisedSearchHelp(projid) {
          $("#PopupDetails .modal-content").load("/static/unsupervisedsearchhelp_20240224.html");
          $('#PopupDetails').modal({});
      }

      $(document).ready(function () {
          RefreshClassifTab();
      });

  </script>

{% endblock %}